const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/Variable.js","assets/CallStack.js","assets/CmnInterface.js","assets/CmnLib.js","web.js","assets/chunk.js","assets/EventListenerCtn.js","assets/pixi2.js","assets/PropParser.js","assets/Reading.js","assets/SoundMng.js","assets/ConfigBase.js","assets/SndBuf.js","assets/ScriptIterator.js","assets/DebugMng.js","assets/Grammar.js","assets/RubySpliter.js","assets/LayerMng.js","assets/Button.js","assets/Layer.js","assets/SpritesMng.js","assets/Config.js","assets/GrpLayer.js","assets/TxtLayer.js","assets/EventMng.js","assets/SysBase.js"])))=>i.map(i=>d[i]);
import{t as e}from"../web.js";import{h as t,s as n,t as r}from"./CmnLib.js";import{_ as i,b as a,n as o}from"./pixi2.js";import"./ConfigBase.js";import{t as s}from"./DebugMng.js";import{t as c}from"./Config.js";import{a as l,r as u}from"./Grammar.js";var d=`skynovel`,f=class f{static async generate(e){a();let t=new f(e);return await t.#a().catch(e=>console.error(`Main.generate err e:%o`,e)),t}cvs;#e=Object.create(null);#t;#n;#r;#i=[];constructor(e){this.sys=e}async#a(){let n=await c.generate(this.sys);this.sys.setMain(this,n);let a={width:n.oCfg.window.width,height:n.oCfg.window.height,backgroundColor:t(String(n.oCfg.init.bg_color)),resolution:globalThis.devicePixelRatio},l=document.getElementById(d);if(l){let e=l.cloneNode(!0);e.id=d,a.view=l;let t=l.parentNode;this.#i.unshift(()=>t.appendChild(e))}else{let e=document.createElement(`canvas`);e.id=d,a.view=e,document.body.appendChild(e),this.#i.unshift(()=>document.body.removeChild(e))}let u=new o(a);this.#i.unshift(()=>{i(),this.sys.destroy(),u.destroy(!1)}),this.cvs=u.view,this.cvs.id=d+`_act`,l||document.body.appendChild(this.cvs);let f=document.createElement(`canvas`).getContext(`2d`);if(!f)throw`#init cc err`;r.cc4ColorName=f;let[{Variable:p},{PropParser:m},{SoundMng:h},{ScriptIterator:g},{LayerMng:_},{EventMng:v},{Button:y}]=await Promise.all([e(()=>import(`./Variable.js`),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9])),e(()=>import(`./PropParser.js`),__vite__mapDeps([8,3,4,5])),e(()=>import(`./SoundMng.js`),__vite__mapDeps([10,3,4,5,11,6,7,9,12])),e(()=>import(`./ScriptIterator.js`),__vite__mapDeps([13,1,2,3,4,5,11,14,6,7,15,9,16,12])),e(()=>import(`./LayerMng.js`),__vite__mapDeps([17,18,3,4,5,11,14,6,7,19,9,20,21,22,16,23])),e(()=>import(`./EventMng.js`),__vite__mapDeps([24,4,18,3,5,11,14,6,7,19,9,20,2,25,23,16])),e(()=>import(`./Button.js`),__vite__mapDeps([18,3,4,5,11,14,6,7,19,9,20]))]);y.init(n);let b=new p(this.sys,n,this.#e),x=new m(b,n.oCfg.init.escape);this.#o=(e,t,n,r)=>b.setVal_Nochk(e,t,n,r),this.#l=e=>x.getValAmpersand(e),this.#u=e=>x.parse(e),await Promise.allSettled(this.sys.init(this.#e,u,b));let S=new h(n,this.#e,b,this,this.sys);this.#i.unshift(()=>S.destroy()),this.#t=new g(n,this.#e,this,b,x,S,this.sys),this.#i.unshift(()=>this.#t.destroy());let C=new s(this.sys,this.#e,this.#t);this.#i.unshift(()=>C.destroy()),this.errScript=(e,t)=>{if(this.stop(),s.myTrace(e),r.debugLog&&console.log(`ðŸœ SKYNovel err!`),t)throw e},this.#n=new _(n,this.#e,u,b,this,this.#t,this.sys,S,x),this.#i.unshift(()=>this.#n.destroy()),this.#r=new v(n,this.#e,u,this,this.#n,b,S,this.#t,this.sys),this.#i.unshift(()=>this.#r.destroy()),this.#i.unshift(()=>{this.stop(),this.#s=!1;let e=()=>!0;for(let t in this.#e)this.#e[t]=e})}destroy(){this.resume=this.destroy=()=>{},this.cvs.parentElement?.removeChild(this.cvs);for(let e of this.#i)e();this.#i=[]}errScript=(e,t=!0)=>{};resumeByJumpOrCall(e){if(e.url){this.#e.navigate_to(e),this.#t.jumpJustBefore();return}if(this.#o(`tmp`,`sn.eventArg`,String(e.arg??``)),this.#o(`tmp`,`sn.eventLabel`,e.label??``),n(e,`call`,!1)){if(this.#t.subIdxToken(),this.#e.call(e))return}else if(this.#e.clear_event({}),this.#e.jump(e))return;this.resume()}#o=(e,t,n,r=!1)=>{};resume(){this.#n.clearBreak(),this.#t.noticeBreak(!1),this.#r.hideHint(),queueMicrotask(()=>{this.#c()})}stop=()=>{this.#t.noticeBreak(!0)};setLoop(e,t=``){(this.#s=e)?this.resume():this.stop(),this.sys.setTitleInfo(t?` -- ${t}ä¸­`:``)}#s=!0;async#c(){let e=``;try{for(;this.#s;){let t=this.#t.nextToken();if(!t)return;let n=t.charCodeAt(0);if(n!==9){if(n===10){this.#t.addLineNum(t.length);continue}if(n===91){if(e=`ã‚¿ã‚°é–‹å§‹`,this.#t.isBreak(t))return;let[n,r]=l(t);e=`[${n}]ä¾‹å¤–`;let i=(t.match(/\n/g)??[]).length;if(i>0&&this.#t.addLineNum(i),await this.#t.ã‚¿ã‚°è§£æž(n,r)){this.stop();return}continue}if(n===38){if(!t.endsWith(`&`)){if(e=`å¤‰æ•°è¨ˆç®—`,this.#t.isBreak(t))return;let n=u(t.slice(1));n.name=this.#l(n.name),n.text=String(this.#u(n.text)),this.#e.let(n);continue}if(e=`å¤‰æ•°æ“ä½œ`,t.charAt(1)===`&`)throw Error(`ã€Œ&è¡¨ç¤º&ã€æ›¸å¼ã§ã¯ã€Œ&ã€æŒ‡å®šãŒä¸è¦ã§ã™`);t=String(this.#u(t.slice(1,-1)))}else if(n===59)continue;else if(n===42&&t.length>1)continue;e=`æ–‡å­—è¡¨ç¤º`,this.#n.setNormalChWait(),this.#n.currentTxtlayForeNeedErr.tagCh(t)}}}catch(t){this.errScript(`${e} ${t instanceof Error?`mes=${t.message}(${t.name})`:String(t)}`,!1)}}#l=e=>``;#u};export{f as Main};