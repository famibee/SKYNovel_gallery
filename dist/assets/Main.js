const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/Variable.js","assets/web.js","web.js","assets/CallStack.js","assets/PropParser.js","assets/Reading.js","assets/SoundMng.js","assets/SndBuf.js","assets/CmnTween.js","assets/ScriptIterator.js","assets/RubySpliter.js","assets/DebugMng.js","assets/LayerMng.js","assets/GrpLayer.js","assets/SpritesMng.js","assets/TxtLayer.js","assets/Button.js","assets/EventMng.js"])))=>i.map(i=>d[i]);
import{_ as p}from"../web.js";import{S as T,a as P,p as S,A as R,b as I,C as _,d as M,e as O,s as B}from"./web.js";import{t as A}from"./DebugMng.js";const V="userdata:/",D="downloads:/";class b extends O{constructor(t){super(t),this.sys=t}static async generate(t){const e=new b(t),s=t.arg.cur+"prj.json",i=await t.fetch(s);if(!i.ok)throw Error(i.statusText);const n=await t.dec(s,await i.text());return await e.load(JSON.parse(n)),e}async load(t){return t.window??={width:300,height:300},_.stageW=t.window.width,_.stageH=t.window.height,_.debugLog=t.debug.debugLog,await _.init(),super.load(t)}searchPath(t,e=T.DEFAULT){return t.startsWith(D)?this.sys.path_downloads+t.slice(11):t.startsWith(V)?this.sys.path_userdata+"storage/"+t.slice(10):super.searchPath(t,e)}}function x(c,t,e=0,s=0,i=0){const n=c.slice(0,t).split(`
`),r=n.length;return{ln:s+r-1,ch:r<2?i+1+e+t:n.at(-1)?.length??0}}class W{#e=/;[^\n]*|(?<key>[^\s="'#|;]+)(?:\s|;[^\n]*\n)*=(?:\s|;[^\n]*\n)*(?:(?<val>[^\s"'#|;]+)|(["'#])(?<val2>.*?)\3)(?:\|(?:(?<def>[^\s"'#;]+)|(["'#])(?<def2>.*?)\6))?|(?<literal>[^\s;]+)/g;parse(t){this.#t={},this.#n=!1;for(const{groups:e}of t.matchAll(this.#e)){const{key:s,val:i,val2:n,def:r,def2:a,literal:o}=e;s?this.#t[s]={val:i??n??"",def:r??a}:o&&(o==="*"?this.#n=!0:this.#t[o]={val:"1"})}}parseinDetail(t,e,s,i){const n={},r=t.slice(1+e,-1);for(const{groups:a,index:o,0:u}of r.matchAll(this.#e)){if(!o)continue;const{key:f,val:m,val2:v="",literal:l}=a;if(l){if(l.endsWith("=")){const d=l.length-1,{ch:y}=x(r,o+d,e,s,i);n[l.slice(0,-1)]={k_ln:s,k_ch:y-d,v_ln:s,v_ch:y+1,v_len:0}}continue}if(!f)continue;const{ln:g,ch:w}=x(r,o,e,s,i),{ln:E,ch:h}=x(r,o+u.lastIndexOf(m??v)-(m?0:1),e,s,i);n[f]={k_ln:g,k_ch:w,v_ln:E,v_ch:h,v_len:m?m.length:v.length+2}}return n}#t={};get hPrm(){return this.#t}#n=!1;get isKomeParam(){return this.#n}}const C=/(?<name>[^\s;\]]+)/;function L(c){const t=C.exec(c.slice(1,-1))?.groups;if(!t)throw`„Çø„Ç∞Ë®òËø∞„Äê${c}„ÄëÁï∞Â∏∏„Åß„Åô(„Çø„Ç∞Ëß£Êûê)`;const e=t.name;return[e,c.slice(1+e.length,-1)]}function K(c){const t=C.exec(c.slice(1))?.groups;if(!t)throw`„Çø„Ç∞Ë®òËø∞„Äê${c}„ÄëÁï∞Â∏∏„Åß„Åô(„Çø„Ç∞Ëß£Êûê)`;return t.name}function j(c){const t=c.replaceAll("==","Ôºù").replaceAll("!=","‚â†").split("="),e=t.length;if(e<2||e>3)throw"„Äå&Ë®àÁÆó„ÄçÊõ∏Âºè„Åß„ÅØ„Äå=„ÄçÊåáÂÆö„Åå‰∏Ä„Å§„Åã‰∫å„Å§ÂøÖË¶Å„Åß„Åô";const[s,i,n]=t;if(i.startsWith("&"))throw"„Äå&Ë®àÁÆó„ÄçÊõ∏Âºè„Åß„ÅØ„Äå&„ÄçÊåáÂÆö„Åå‰∏çË¶Å„Åß„Åô";return{name:s.replaceAll("Ôºù","==").replaceAll("‚â†","!="),text:i.replaceAll("Ôºù","==").replaceAll("‚â†","!="),cast:e===3?n.trim():void 0}}class z{constructor(t){this.cfg=t,this.setEscape("")}#e;setEscape(t){if(this.#s&&t in this.#s)throw"[„Ç®„Çπ„Ç±„Éº„ÉóÊñáÂ≠ó] char„Äê"+t+"„Äë„ÅåÁôªÈå≤Ê∏à„Åø„ÅÆÊã¨Âºß„Éû„ÇØ„É≠„Åæ„Åü„ÅØ‰∏ÄÊñáÂ≠ó„Éû„ÇØ„É≠„Åß„Åô";this.#e=new RegExp((t?`\\${t}\\S|`:"")+`\\n+|\\t+|\\[let_ml\\s+[^\\]]+\\].+?(?=\\[endlet_ml[\\]\\s])|\\[(?:[^"'#;\\]]+|(["'#]).*?\\1|;[^\\n]*)*?]|;[^\\n]*|&[^&\\n]+&|&&?(?:[^"'#;\\n&]+|(["'#]).*?\\2)+|^\\*[^\\s\\[&;\\\\]+|[^\\n\\t\\[;${t?`\\${t}`:""}]+`,"gs"),this.#t=new RegExp(`[\\w\\s;[\\]*=&ÔΩú„Ää„Äã${t?`\\${t}`:""}]`),this.#o=new RegExp(`[\\n\\t;\\[*&${t?`\\${t}`:""}]`)}bracket2macro(t,e,s,i){const{name:n,text:r}=t;if(!n)throw"[bracket2macro] name„ÅØÂøÖÈ†à„Åß„Åô";if(!r)throw"[bracket2macro] text„ÅØÂøÖÈ†à„Åß„Åô";const a=r.at(0);if(!a)throw"[bracket2macro] text„ÅØÂøÖÈ†à„Åß„Åô";if(r.length!==2)throw"[bracket2macro] text„ÅØÊã¨Âºß„ÅÆÂâçÂæå„ÇíÁ§∫„Åô‰∫åÊñáÂ≠ó„ÇíÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ";if(!(n in e))throw`[bracket2macro] Êú™ÂÆöÁæ©„ÅÆ„Çø„Ç∞Âèà„ÅØ„Éû„ÇØ„É≠[${n}]„Åß„Åô`;this.#s??={};const o=r.charAt(1);if(a in this.#s)throw"[bracket2macro] text„Äê"+a+"„Äë„ÅåÁôªÈå≤Ê∏à„Åø„ÅÆÊã¨Âºß„Éû„ÇØ„É≠„Åæ„Åü„ÅØ‰∏ÄÊñáÂ≠ó„Éû„ÇØ„É≠„Åß„Åô";if(o in this.#s)throw"[bracket2macro] text„Äê"+o+"„Äë„ÅåÁôªÈå≤Ê∏à„Åø„ÅÆÊã¨Âºß„Éû„ÇØ„É≠„Åæ„Åü„ÅØ‰∏ÄÊñáÂ≠ó„Éû„ÇØ„É≠„Åß„Åô";if(this.#t.test(a))throw"[bracket2macro] text„Äê"+a+"„Äë„ÅØÊã¨Âºß„Éû„ÇØ„É≠„Å´‰ΩøÁî®„Åß„Åç„Å™„ÅÑÊñáÂ≠ó„Åß„Åô";if(this.#t.test(o))throw"[bracket2macro] text„Äê"+o+"„Äë„ÅØÊã¨Âºß„Éû„ÇØ„É≠„Å´‰ΩøÁî®„Åß„Åç„Å™„ÅÑÊñáÂ≠ó„Åß„Åô";this.#s[o]="0",this.#s[a]=`[${n} text=`,this.addC2M(`\\${a}[^\\${o}]*\\${o}`,`\\${a}\\${o}`),this.#u(s,i)}char2macro(t,e,s,i){const{char:n,name:r}=t;if(!n)throw"[char2macro] char„ÅØÂøÖÈ†à„Åß„Åô";if(this.#s??={},n in this.#s)throw"[char2macro] char„Äê"+n+"„Äë„ÅåÁôªÈå≤Ê∏à„Åø„ÅÆÊã¨Âºß„Éû„ÇØ„É≠„Åæ„Åü„ÅØ‰∏ÄÊñáÂ≠ó„Éû„ÇØ„É≠„Åß„Åô";if(this.#t.test(n))throw"[char2macro] char„Äê"+n+"„Äë„ÅØ‰∏ÄÊñáÂ≠ó„Éû„ÇØ„É≠„Å´‰ΩøÁî®„Åß„Åç„Å™„ÅÑÊñáÂ≠ó„Åß„Åô";if(!r)throw"[char2macro] name„ÅØÂøÖÈ†à„Åß„Åô";if(!(r in e))throw`[char2macro] Êú™ÂÆöÁæ©„ÅÆ„Çø„Ç∞Âèà„ÅØ„Éû„ÇØ„É≠[${r}]„Åß„Åô`;this.#s[n]=`[${r}]`,this.addC2M(`\\${n}`,`\\${n}`),this.#u(s,i)}#t;#n=new RegExp("");#r="";#i="";addC2M(t,e){this.#r+=`${t}|`,this.#i+=e,this.#n=new RegExp(`(${this.#r}[^${this.#i}]+)`,"g")}resolveScript(t){const e=t.replaceAll(/\r\n?/g,`
`).match(this.#e)?.flatMap(i=>{if(!this.testTagLetml(i))return i;const n=/^([^\]]+?])(.*)$/s.exec(i);if(!n)return i;const[,r,a]=n;return[r,a]})??[],s={aToken:e,len:e.length,aLNum:[]};return this.#u(s),this.#h(s),s}#l=/^\[(call|loadplugin)\s/;#a=/\bfn\s*=\s*[^\s\]]+/;#h(t){for(let e=t.len-1;e>=0;--e){const s=t.aToken[e];if(!this.#l.test(s))continue;const[i,n]=L(s);this.#c.parse(n);const r=this.#c.hPrm.fn;if(!r)continue;const{val:a}=r;if(!a.endsWith("*"))continue;t.aToken.splice(e,1,"	","; "+s),t.aLNum.splice(e,1,NaN,NaN);const o=i==="loadplugin"?T.CSS:T.SN,u=this.cfg.matchPath("^"+a.slice(0,-1)+".*",o);for(const f of u){const m=s.replace(this.#a,"fn="+decodeURIComponent(P(f[o])));t.aToken.splice(e,0,m),t.aLNum.splice(e,0,NaN)}}t.len=t.aToken.length}#c=new W;testTagLetml(t){return/^\[let_ml\s/.test(t)}testTagEndLetml(t){return/^\[endlet_ml\s*]/.test(t)}#s=void 0;#o;#u(t,e=0){if(this.#s){for(let s=t.len-1;s>=e;--s){const i=t.aToken[s];if(this.testNoTxt(i.at(0)??`
`))continue;const n=t.aLNum[s],r=i.match(this.#n);if(!r)continue;let a=1;for(let o=r.length-1;o>=0;--o){let u=r[o];const f=this.#s[u.at(0)??" "];f&&(u=f+(f.endsWith("]")?"":`'${u.slice(1,-1)}']`)),t.aToken.splice(s,a,u),t.aLNum.splice(s,a,n),a=0}}t.len=t.aToken.length}}testNoTxt(t){return this.#o.test(t)}}const k="skynovel";class ${constructor(t){this.sys=t}static async generate(t){B();const e=new $(t);return await e.#l().catch(s=>console.error("Main.generate err e:%o",s)),e}cvs;#e=Object.create(null);#t;#n;#r;#i=[];async#l(){const t=await b.generate(this.sys);this.sys.setMain(this,t);const e={width:t.oCfg.window.width,height:t.oCfg.window.height,backgroundColor:S(String(t.oCfg.init.bg_color)),resolution:globalThis.devicePixelRatio},s=document.getElementById(k);if(s){const h=s.cloneNode(!0);h.id=k,e.view=s;const d=s.parentNode;this.#i.unshift(()=>d.appendChild(h))}else{const h=document.createElement("canvas");h.id=k,e.view=h,document.body.appendChild(h),this.#i.unshift(()=>document.body.removeChild(h))}const i=new R(e);this.#i.unshift(()=>{I(),this.sys.destroy(),i.destroy(!1)}),this.cvs=i.view,this.cvs.id=k+"_act",s||document.body.appendChild(this.cvs);const n=document.createElement("canvas").getContext("2d");if(!n)throw"#init cc err";_.cc4ColorName=n;const[{Variable:r},{PropParser:a},{SoundMng:o},{ScriptIterator:u},{LayerMng:f},{EventMng:m},{Button:v}]=await Promise.all([p(()=>import("./Variable.js"),__vite__mapDeps([0,1,2,3,4,5])),p(()=>import("./PropParser.js"),__vite__mapDeps([4,1,2])),p(()=>import("./SoundMng.js"),__vite__mapDeps([6,1,2,7,8,5])),p(()=>import("./ScriptIterator.js"),__vite__mapDeps([9,1,2,3,10,11,8,5,7])),p(()=>import("./LayerMng.js"),__vite__mapDeps([12,1,2,8,5,13,14,11,15,10,16])),p(()=>import("./EventMng.js"),__vite__mapDeps([17,2,1,15,8,5,14,11,10,16])),p(()=>import("./Button.js"),__vite__mapDeps([16,1,2,14,11,5]))]);v.init(t);const l=new r(this.sys,t,this.#e),g=new a(l,t.oCfg.init.escape);this.#a=(h,d,y,N)=>l.setVal_Nochk(h,d,y,N),this.#s=h=>g.getValAmpersand(h),this.#o=h=>g.parse(h),await Promise.allSettled(this.sys.init(this.#e,i,l));const w=new o(t,this.#e,l,this,this.sys);this.#i.unshift(()=>w.destroy()),this.#t=new u(t,this.#e,this,l,g,w,this.sys),this.#i.unshift(()=>this.#t.destroy());const E=new A(this.sys,this.#e,this.#t);this.#i.unshift(()=>E.destroy()),this.errScript=(h,d=!0)=>{if(this.stop(),A.myTrace(h),_.debugLog&&console.log("üçú SKYNovel err!"),d)throw h},this.#n=new f(t,this.#e,i,l,this,this.#t,this.sys,w,g),this.#i.unshift(()=>this.#n.destroy()),this.#r=new m(t,this.#e,i,this,this.#n,l,w,this.#t,this.sys),this.#i.unshift(()=>this.#r.destroy()),this.#i.unshift(()=>{this.stop(),this.#h=!1;const h=()=>!0;for(const d in this.#e)this.#e[d]=h})}destroy(){this.resume=this.destroy=()=>{},this.cvs.parentElement?.removeChild(this.cvs);for(const t of this.#i)t();this.#i=[]}errScript=(t,e=!0)=>{};resumeByJumpOrCall(t){if(t.url){this.#e.navigate_to(t),this.#t.jumpJustBefore();return}if(this.#a("tmp","sn.eventArg",String(t.arg??"")),this.#a("tmp","sn.eventLabel",t.label??""),M(t,"call",!1)){if(this.#t.subIdxToken(),this.#e.call(t))return}else if(this.#e.clear_event({}),this.#e.jump(t))return;this.resume()}#a=(t,e,s,i=!1)=>{};resume(){this.#n.clearBreak(),this.#t.noticeBreak(!1),this.#r.hideHint(),queueMicrotask(()=>{this.#c()})}stop=()=>{this.#t.noticeBreak(!0)};setLoop(t,e=""){(this.#h=t)?this.resume():this.stop(),this.sys.setTitleInfo(e?` -- ${e}‰∏≠`:"")}#h=!0;async#c(){let t="";try{for(;this.#h;){let e=this.#t.nextToken();if(!e)return;const s=e.charCodeAt(0);if(s!==9){if(s===10){this.#t.addLineNum(e.length);continue}if(s===91){if(t="„Çø„Ç∞ÈñãÂßã",this.#t.isBreak(e))return;const[i,n]=L(e);t=`[${i}]‰æãÂ§ñ`;const r=(e.match(/\n/g)??[]).length;if(r>0&&this.#t.addLineNum(r),await this.#t.„Çø„Ç∞Ëß£Êûê(i,n)){this.stop();return}continue}if(s===38){if(!e.endsWith("&")){if(t="Â§âÊï∞Ë®àÁÆó",this.#t.isBreak(e))return;const i=j(e.slice(1));i.name=this.#s(i.name),i.text=String(this.#o(i.text)),this.#e.let(i);continue}if(t="Â§âÊï∞Êìç‰Ωú",e.charAt(1)==="&")throw new Error("„Äå&Ë°®Á§∫&„ÄçÊõ∏Âºè„Åß„ÅØ„Äå&„ÄçÊåáÂÆö„Åå‰∏çË¶Å„Åß„Åô");e=String(this.#o(e.slice(1,-1)))}else if(s===59||s===42&&e.length>1)continue;t="ÊñáÂ≠óË°®Á§∫",this.#n.setNormalChWait(),this.#n.currentTxtlayForeNeedErr.tagCh(e)}}}catch(e){this.errScript(`${t} ${e instanceof Error?`mes=${e.message}(${e.name})`:String(e)}`,!1)}}#s=t=>"";#o}const G=Object.freeze(Object.defineProperty({__proto__:null,Main:$},Symbol.toStringTag,{value:"Module"}));export{W as A,z as G,G as M,V as P,L as a,D as b,K as t};
