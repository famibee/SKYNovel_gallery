import{h as b,i as w,j as l,k as v,l as r,d as _,u as N}from"./web.js";import{c as O}from"./CallStack.js";import{PropParser as x}from"./PropParser.js";import{n as C}from"./Reading.js";import"../web.js";class m{#s={};clear(){this.#s={}}static from(s){const t=new m;return t.#s={...s},t}val(){return{...this.#s}}search(s){return Object.entries(this.#s).some(([t,i])=>s>=parseInt(t)&&s<=i)}record(s){if(!this.search(s)){for(const[t,i]of Object.entries(this.#s))if(i+1===s){String(s+1)in this.#s?(this.#s[t]=this.#s[s+1],delete this.#s[s+1]):this.#s[t]=s;return}if(String(s+1)in this.#s){this.#s[s]=this.#s[s+1],delete this.#s[s+1];return}this.#s[s]=s}}erase(s){if(this.search(s)){if(String(s)in this.#s){this.#s[s]>s&&(this.#s[s+1]=this.#s[s]),delete this.#s[s];return}for(const[t,i]of Object.entries(this.#s))if(!(s<parseInt(t)||i<s)){if(this.#s[t]===s){this.#s[t]=s-1;return}this.#s[s+1]=i,this.#s[t]=s-1;return}}}get count(){return Object.keys(this.#s).length}toString(){let s="";for(const t of Object.keys(this.#s).map(i=>parseInt(i)).sort((i,e)=>i-e))s+=t===this.#s[t]?","+String(t):","+String(t)+"~"+String(this.#s[String(t)]);return s}}class u{constructor(s,t,i){this.sys=s,this.cfg=t,i.let=e=>this.#e(e),i.let_abs=e=>this.#V(e),i.let_char_at=e=>this.#j(e),i.let_index_of=e=>this.#W(e),i.let_length=e=>this.#P(e),i.let_replace=e=>this.#K(e),i.let_round=e=>this.#A(e),i.let_search=e=>this.#L(e),i.let_substr=e=>this.#D(e),i.clearsysvar=()=>this.#b(),i.clearvar=()=>this.#F(),i.dump_val=()=>this.#R(),i.copybookmark=e=>this.#C(e),i.erasebookmark=e=>this.#O(e),this.defTmp("const.sn.bookmark.json",()=>{const e=[];for(const[h,a]of Object.entries(this.#i.mark)){const c={...a.json};c.place=N(h),e.push(c)}return JSON.stringify(e)}),this.#n["const.sn.config.window.width"]=t.oCfg.window.width,this.#n["const.sn.config.window.height"]=t.oCfg.window.height,this.#n["const.sn.config.book.title"]=t.oCfg.book.title,this.#n["const.sn.config.book.version"]=t.oCfg.book.version}#s=b();#n=w();#t={sys:{},save:this.#s,tmp:this.#n,mp:{},mark:{}};#i={sys:{},mark:{},kidoku:{}};#a;#o={};#d;async init(){return this.sys.initVal(this.#n,s=>{this.updateData(s),this.cfg.oCfg.debug.variable?this.#N(this.sys):this.flush=()=>this.sys.flush(),this.flush(),this.#d=(t,i)=>this.sys.callHook(t,i),this.sys.addHook((t,i)=>this.#x[t]?.(t,i)),l(this.getVal("sys:sn.tagCh.msecWait",-1))===-1&&this.#b(!0),this.#f=!!this.getVal("sys:sn.tagCh.doWait"),this.#l=!!this.getVal("sys:sn.tagCh.doWait_Kidoku"),this.#g=l(this.getVal("sys:sn.tagCh.msecWait")),this.#u=l(this.getVal("sys:sn.tagCh.msecWait_Kidoku")),this.#m()})}#N(s){sessionStorage.clear();const t=this.cfg.headNs;this.flush=()=>{const i=v();for(const[o,n]of Object.entries(this.#a))n instanceof Function||(i[o]=n);sessionStorage[t+"sys"]=JSON.stringify(i);const e=b();for(const[o,n]of Object.entries(this.#s))e[o]=n;sessionStorage[t+"save"]=JSON.stringify(e);const h=w();for(const[o,n]of Object.entries(this.#n))h[o]=n instanceof Function?n():n;sessionStorage[t+"tmp"]=JSON.stringify(h);const a=O();for(const[o,n]of Object.entries(this.#t.mp))a[o]=n;sessionStorage[t+"mp"]=JSON.stringify(a);const c={};for(const[o,n]of Object.entries(this.#i.mark))c[l(o)]=n instanceof Function?n():n;sessionStorage[t+"mark"]=JSON.stringify(c),sessionStorage[t+"kidoku"]=structuredClone(this.#i.kidoku),s.flush()}}#m(){C.playbackPage(String(this.getVal("sys:const.sn.aPageLog","[]")),String(this.getVal("save:const.sn.styPaging",C.INI_STYPAGE)))}#x={auth:(s,t)=>this.#p(t.hBreakpoint.aData),var:(s,t)=>this.sys.send2Dbg(t.ri,{v:this.#t[t.scope]??{}}),set_var:(s,t)=>{try{this.#_(t.nm,t.val),this.sys.send2Dbg(t.ri,{})}catch{}},set_data_break:(s,t)=>{this.#p(t.a),this.sys.send2Dbg(t.ri,{})},disconnect:s=>{u.#r={}}};#p(s){u.#r={};for(const t of s)u.#r[t.dataId]=1}updateData(s){this.#i=s,this.#a=this.#t.sys=s.sys,this.#o={};for(const[t,i]of Object.entries(s.kidoku))this.#o[t]=m.from(i)}flush=()=>{};setDoRecProc(s){this.#y=s}#y=s=>{};defTmp(s,t){this.#n[s]=t}cloneMp(){return{...this.#t.mp}}setMp(s){this.#t.mp=s}setMark(s,t){this.#i.mark[s]=t,this.flush()}getMark(s){const t=this.#i.mark[s];if(!t)throw`placeã€${String(s)}ã€‘ã¯å­˜åœ¨ã—ã¾ã›ã‚“`;return t}cloneSave(){return{...this.#t.save}}mark2save(s){this.#s=this.#t.save={...s.hSave},this.#c=this.#s["sn.doRecLog"]}touchAreaKidoku(s){return this.#o[s]||(this.#i.kidoku[s]={},this.#o[s]=new m)}getAreaKidoku(s){const t=this.#o[s];if(!t)throw`hAreaKidoku${s}ã€‘ã¯å­˜åœ¨ã—ã¾ã›ã‚“`;return t}saveKidoku(){for(const[s,t]of Object.entries(this.#o))this.#i.kidoku[s]=t.val();this.flush()}#C(s){const t=r(s,"from",NaN),i=r(s,"to",NaN);if(t===i)return!1;const e=this.#i.mark[t];if(!e)throw`from:${String(t)} ã®ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã¯å­˜åœ¨ã—ã¾ã›ã‚“`;return this.setMark(i,{...e}),this.sys.copyBMFolder(t,i),!1}#O(s){const t=r(s,"place",NaN);return delete this.#i.mark[t],this.flush(),this.sys.eraseBMFolder(t),!1}#e(s){if(!s.name)throw"nameã¯å¿…é ˆã§ã™";let t=!0;if(s.cast)switch(s.cast){case"num":r(s,"text",NaN);break;case"int":s.text=String(l(r(s,"text",NaN)));break;case"uint":s.text=String(N(r(s,"text",NaN)));break;case"bool":_(s,"text",!1);break;case"str":t=!1;break;default:throw"castã€"+s.cast+"ã€‘ã¯æœªå®šç¾©ã§ã™"}return this.#_(s.name,s.text,t),!1}#V(s){const t=r(s,"text",0);return s.text=String(t<0?-t:t),this.#e(s),!1}#j(s){return s.text=(s.text??"").charAt(r(s,"pos",0)),this.#e(s),!1}#W(s){const{val:t}=s;if(!t)throw"valã¯å¿…é ˆã§ã™";const i=r(s,"start",0);return s.text=String((s.text??"").indexOf(t,i)),this.#e(s),!1}#P(s){return s.text=String((s.text??"").length),this.#e(s),!1}#K(s){if(!s.reg)throw"regã¯å¿…é ˆã§ã™";const{flags:t}=s,i=t?new RegExp(s.reg,t):new RegExp(s.reg);return s.text=(s.text??"").replace(i,String(s.val)),this.#e(s),!1}#A(s){const t=r(s,"text",0);return s.text=String(Math.round(t)),this.#e(s),!1}#L(s){if(!s.reg)throw"regã¯å¿…é ˆã§ã™";const{flags:t}=s,i=t?new RegExp(s.reg,t):new RegExp(s.reg);return s.text=String((s.text??"").search(i)),this.#e(s),!1}#D(s){const t=r(s,"pos",0);return s.text=s.len!=="all"?(s.text??"").slice(t,t+l(r(s,"len",1))):(s.text??"").slice(t),this.#e(s),!1}#b(s=!1){const t=this.#a=this.#t.sys=this.#i.sys=v();typeof process<"u"||(this.setVal_Nochk("sys","const.sn.window.x",0),this.setVal_Nochk("sys","const.sn.window.y",0)),this.setVal_Nochk("sys","sn.tagCh.msecWait",this.cfg.oCfg.init.tagch_msecwait),this.setVal_Nochk("sys","sn.tagCh.msecWait_Kidoku",this.cfg.oCfg.init.tagch_msecwait),this.setVal_Nochk("sys","sn.auto.msecPageWait",r(t,"sn.auto.msecPageWait",this.cfg.oCfg.init.auto_msecpagewait)),this.setVal_Nochk("sys","sn.auto.msecPageWait_Kidoku",r(t,"sn.auto.msecPageWait",this.cfg.oCfg.init.auto_msecpagewait));for(const i of Object.values(this.#o))i.clear();return this.#t.mark=this.#i.mark={},s||this.#m(),this.flush(),!1}#F(){const s=this.#s["const.sn.mesLayer"],t=this.#s["sn.doRecLog"],i=this.#s["const.sn.sLog"],e=this.#s["const.sn.styPaging"];return this.#s=this.#t.save=b(),this.setVal_Nochk("save","const.sn.mesLayer",s),this.setVal_Nochk("save","sn.doRecLog",t),this.setVal_Nochk("save","const.sn.sLog",i),this.setVal_Nochk("save","const.sn.styPaging",e),!1}#_(s,t,i=!0){if(!s)throw"[å¤‰æ•°ã«å€¤ã‚»ãƒƒãƒˆ] nameã¯å¿…é ˆã§ã™";if(t===void 0)throw"[å¤‰æ•°ã«å€¤ã‚»ãƒƒãƒˆ] textã¯å¿…é ˆã§ã™ï¼ˆç©ºæ–‡å­—ã¯OKï¼‰";const e=x.getValName(s);if(!e)throw`[å¤‰æ•°å‚ç…§] name(${s})ãŒå¤‰æ•°åã¨ã—ã¦ç•°å¸¸ã§ã™`;const{scope:h,name:a}=e,c=this.#t[h];if(a.startsWith("const.")&&a in c)throw`[å¤‰æ•°ã«å€¤ã‚»ãƒƒãƒˆ] å¤‰æ•°ã€${a}ã€‘ã¯æ›¸ãæ›ãˆä¸å¯ã§ã™`;this.setVal_Nochk(h,a,t,i)}setVal_Nochk(s,t,i,e=!1){const h=this.#t[s],a=e?this.#h(i):i,c=s+":"+t;if(c in u.#r){const o=h[t];o!=a&&this.#d("data_break",{dataId:c,old_v:o,new_v:a})}h[t]=a,this.#S[c]?.(t,a??"")}static#r={};getVal(s,t,i=!1){if(!s)throw"[å¤‰æ•°å‚ç…§] nameã¯å¿…é ˆã§ã™";const e=x.getValName(s);if(!e)throw"[å¤‰æ•°å‚ç…§] name("+s+")ãŒå¤‰æ•°åã¨ã—ã¦ç•°å¸¸ã§ã™";const{scope:h,name:a,at:c}=e,o=this.#t[h];let n=o[a];if(!(a in o)){if(n=t,i)return o[a]=t,c==="@str"?n:this.#h(n);let k="";const p=a.split("."),d=p.length;for(let g=0;g<d;++g,k+="."){if(k+=p[g],!(k in o))continue;let f=JSON.parse(o[k]);if(Object.prototype.toString.call(f)!=="[object Object]"){if(g+1===d){n=f;break}continue}let y=g;for(;++y<d;){const S=p[y];if(!(S in f)){n=t;break}if(f=f[S],Object.prototype.toString.call(f)!=="[object Object]"||y+1===d){n=f;break}}n instanceof Object&&(n=JSON.stringify(n));break}}return n instanceof Function&&(n=n()),c==="@str"?n:this.#h(n)}#h(s){const t=s;if(t==="true")return!0;if(t==="false")return!1;if(t==="null")return null;if(t!=="undefined")return this.#M.test(t)?parseFloat(t):s}#M=/^-?[\d.]+$/;#R(){const s={tmp:{},sys:{},save:{},mp:{}};for(const t in s){const i=this.#t[t],e=s[t];for(const[h,a]of Object.entries(i))a instanceof Function||(e[h]=a)}return console.info("ğŸ¥Ÿ [dump_val]",s),!1}#c=!1;doRecLog(){return this.#c}#f=!1;get tagCh_doWait(){return this.#f}#l=!1;get tagCh_doWait_Kidoku(){return this.#l}#g=0;get tagCh_msecWait(){return this.#g}#u=0;get tagCh_msecWait_Kidoku(){return this.#u}#S={"sys:sn.tagCh.doWait":s=>{this.#f=this.#k(s)},"sys:sn.tagCh.doWait_Kidoku":s=>{this.#l=this.#k(s)},"sys:sn.tagCh.msecWait":s=>{this.#g=this.#T(s)},"sys:sn.tagCh.msecWait_Kidoku":s=>{this.#u=this.#I(s)},"sys:sn.tagCh.canskip":s=>this.#k(s),"sys:sn.auto.msecPageWait":s=>this.#w(s),"sys:sn.auto.msecPageWait_Kidoku":s=>this.#w(s),"sys:sn.auto.msecLineWait":s=>this.#v(s),"sys:sn.auto.msecLineWait_Kidoku":s=>this.#v(s),"save:sn.doRecLog":s=>{this.#y(this.#c=this.#J(s))},"save:sn.userFnTail":(s,t)=>{const i=String(t);if(i.includes("@"))throw"ã“ã®å¤‰æ•°ã§ã¯æ–‡å­—ã€Œ@ã€ã¯ç¦æ­¢ã§ã™";this.cfg.userFnTail=i},"tmp:flash.desktop.NativeApplication.nativeApplication.systemIdleMode":()=>{}};defValTrg(s,t){this.#S[s]=t}#k=s=>_(this.#a,s,!0);#T=s=>r(this.#a,s,10);#I=s=>r(this.#a,s,this.cfg.oCfg.init.tagch_msecwait??10);#w=s=>r(this.#a,s,this.cfg.oCfg.init.auto_msecpagewait??3500);#v=s=>r(this.#a,s,500);#J(s){return _(this.#s,s,!0)}}export{u as Variable};
