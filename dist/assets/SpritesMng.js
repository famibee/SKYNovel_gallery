import{d as e,l as t,p as n,s as r}from"./CmnLib.js";import{c as i,d as a,h as o,l as s,m as c,r as l,s as u,t as d}from"./pixi2.js";import{n as f}from"./ConfigBase.js";import{t as p}from"./Layer.js";import{t as m}from"./DebugMng.js";import{r as h}from"./Reading.js";var g=class g{static#e;static#t;static#n;static#r;static init(e,t,n,r,i){g.#e=e,g.#t=t,g.#n=n,g.#r=r,n.arg.crypto&&(g.#f=(e,t,n)=>g.#m(e,t,n),g.#g=(e,t,n)=>g.#_(e,t,n));let a=()=>{let e=g.#a*g.#i;for(let t of Object.values(g.#y))t.volume=e};i.setNoticeChgVolume(e=>{g.#a=e,a()},e=>{g.#i=e,a()})}static#i=1;static#a=1;static#o;static setEvtMng(e){g.#o=e}constructor(e=``,t,n=()=>{},r=()=>{}){this.csvFn=e,this.ctn=t,this.fncFirstComp=n,this.fncAllComp=r,e&&(this.#s=t?e=>{t.addChild(e),this.#c.push(e)}:()=>{},this.ret=g.#l(e,e=>this.fncFirstComp(e),e=>this.fncAllComp(e),e=>this.#s(e)))}ret=!1;#s;#c=[];destroy(){this.fncFirstComp=()=>{},this.fncAllComp=()=>{},this.#s=e=>e.destroy();for(let e of this.#c)g.stopVideo(e.name),e.parent?.removeChild(e),e.destroy();this.#c=[]}static destroy(){g.#u={},g.#d={},g.#y={}}static#l(e,t,n,r){if(!e)return!1;let s=!1;if(e.startsWith(`data:`)){let i=()=>{let i=a.from(e);r(i),t(i),n(s)};return e in o?i():(s=!0,new u().add(e,e).load(i)),s}let c=[],d=new u;for(let t of e.split(`,`)){if(!t)throw`face属性に空要素が含まれます`;let{dx:e,dy:n,blendmode:r,fn:a}=g.#u[t]??{fn:t,dx:0,dy:0,blendmode:l.NORMAL};if(c.push({fn:a,fnc:t=>{t.transform&&(t.x=e,t.y=n,t.blendMode=r)}}),a in g.#d||a in o||a in u.shared.resources)continue;s=!0;let p=g.#e.searchPath(a,f.SP_GSM),m=this.#n.arg.crypto?{xhrType:p.endsWith(`.json`)?i.XHR_RESPONSE_TYPE.TEXT:i.XHR_RESPONSE_TYPE.BUFFER}:{};d.add({...m,name:a,url:p})}let p=c.at(0);p&&(p.fnc=t);let m=(e,t)=>{for(let{fn:e,fnc:n}of c){let i=g.#v(e,t);i.name=e,r(i),n(i)}n(s)};return s?d.use((e,t)=>{try{if(e.extension===`json`){this.#n.dec(`json`,e.data).then(n=>g.#g(n,e,t));return}this.#n.decAB(e.data).then(n=>g.#f(n,e,t))}catch(t){let n=`画像/動画ロード失敗です fn:${e.name} ${String(t)}`;g.#o.isSkipping?console.warn(n):console.error(`%c`+n,`color:#FF3300;`)}}).load(m):queueMicrotask(()=>m(0,{})),s}static#u={};static#d={};static#f=(e,{type:t,name:n,data:r},a)=>{switch(t){case i.TYPE.VIDEO:{let e=r;e.volume=g.#a,g.#y[n]=g.#h(e)}}a()};static#p(e){let t=/([^\d]+)\d+\.(\w+)/.exec(e[0]??``);if(!t)return[];let[,r=``,i=``]=t,a=r.length,o=-i.length-1;return e.sort((e,t)=>n(e.slice(a,o))>n(t.slice(a,o))?1:-1)}static#m(e,t,n){if(t.data=e,t.extension!==`bin`&&n(),e instanceof HTMLImageElement){c.fromLoader(e,t.url,t.name).then(r=>{t.texture=r,t.type=i.TYPE.IMAGE,n(),URL.revokeObjectURL(e.src)});return}e instanceof HTMLVideoElement&&(e.volume=g.#a,g.#y[t.name]=g.#h(e),t.type=i.TYPE.VIDEO),n()}static#h(e){return g.#t.getVal(`const.sn.needClick2Play`)&&(m.trace_beforeNew(`[lay系] ${m.strPos()}未クリック状態で動画を自動再生します。音声はミュートされます`,`W`),e.muted=!0),e.setAttribute(`playsinline`,``),e}static#g=(e,{type:t,spritesheet:n,name:r,data:a},o)=>{switch(t){case i.TYPE.JSON:{let e=n._frameKeys;g.#p(e),g.#d[r]={aTex:e.map(e=>c.from(e)),meta:a.meta}}}o()};static#_(t,n,r){let{meta:a,frames:o}=n.data=JSON.parse(t);if(n.type=i.TYPE.JSON,!a?.image){r();return}let l=e(a.image),d=g.#e.searchPath(l,f.SP_GSM);new u().use((e,t)=>{this.#n.decAB(e.data).then(n=>{if(e.data=n,n instanceof HTMLImageElement){e.type=i.TYPE.IMAGE,t(),URL.revokeObjectURL(n.src);return}t()}).catch(t=>this.#r.errScript(`画像/動画ロード失敗です dec2res4Cripto fn:${e.name} ${String(t)}`,!1))}).add({name:l,url:d,xhrType:i.XHR_RESPONSE_TYPE.BUFFER}).load((e,t)=>{for(let{data:t}of Object.values(e.resources)){let{baseTexture:e}=c.from(t),r=Object.values(o);g.#d[n.name]={aTex:r.map(({frame:{x:t,y:n,w:r,h:i}})=>new c(e,new s(t,n,r,i))),meta:a}}r()})}static#v(e,t){let n=g.#d[e];if(n){let e=new d(n.aTex);return e.animationSpeed=n.meta.animationSpeed??1,e.play(),e}if(e in o)return a.from(e);let r=g.#y[e];if(r)return a.from(r);let i=t[e];return i?new a(i.texture):new a}static#y={};static getHFn2VElm(e){return g.#y[e]}static wv(e){let{fn:t}=e;if(!t)throw`fnは必須です`;let n=g.#y[t];if(!n||n.loop)return!1;if(g.#o.isSkipping||n.ended)return g.stopVideo(t),!1;let i=`wv fn:`+t,a=r(e,`stop`,!0),o=()=>{a&&g.stopVideo(t)};return h.beginProc(i,o,!0,r(e,`canskip`,!0)?o:void 0),n.addEventListener(`ended`,()=>h.notifyEndProc(i),{once:!0,passive:!0}),!0}static stopVideo(e){let t=g.#y[e];t&&(delete g.#y[e],t.pause(),t.currentTime=t.duration)}static add_face(e){let{name:n}=e;if(!n)throw`nameは必須です`;if(n in g.#u)throw`一つのname（`+n+`）に対して同じ画像を複数割り当てられません`;let{fn:r=n}=e;return g.#u[n]={fn:r,dx:t(e,`dx`,0),dy:t(e,`dy`,0),blendmode:p.getBlendmodeNum(e.blendmode??``)},!1}};export{g as t};