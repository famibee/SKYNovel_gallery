import{Q as w,L as S,U as O,S as P,m as h,j as R,y as g,a as A,N as L,B as N,x as E,d as F,z as M,l as v}from"./web.js";import{t as C}from"./DebugMng.js";import{a as b}from"./Reading.js";class e{constructor(t="",s,a=()=>{},r=()=>{}){this.csvFn=t,this.ctn=s,this.fncFirstComp=a,this.fncAllComp=r,t&&(this.#i=s?n=>{s.addChild(n),this.#c.push(n)}:()=>{},this.ret=e.#p(t,n=>this.fncFirstComp(n),n=>this.fncAllComp(n),n=>this.#i(n)))}static#r;static#d;static#e;static#f;static init(t,s,a,r,n){e.#r=t,e.#d=s,e.#e=a,e.#f=r,a.arg.crypto&&(e.#l=(c,d,u)=>e.#y(c,d,u),e.#h=(c,d,u)=>e.#T(c,d,u));const o=()=>{const c=e.#n*e.#m;for(const d of Object.values(e.#t))d.volume=c};n.setNoticeChgVolume(c=>{e.#n=c,o()},c=>{e.#m=c,o()})}static#m=1;static#n=1;static#o;static setEvtMng(t){e.#o=t}ret=!1;#i;#c=[];destroy(){this.fncFirstComp=()=>{},this.fncAllComp=()=>{},this.#i=t=>t.destroy();for(const t of this.#c)e.stopVideo(t.name),t.parent?.removeChild(t),t.destroy();this.#c=[]}static destroy(){e.#a={},e.#s={},e.#t={}}static#p(t,s,a,r){if(!t)return!1;let n=!1;if(t.startsWith("data:")){const i=()=>{const l=E.from(t);r(l),s(l),a(n)};return t in w?i():(n=!0,new S().add(t,t).load(i)),n}const o=[],c=new S;for(const i of t.split(",")){if(!i)throw"face属性に空要素が含まれます";const{dx:l,dy:f,blendmode:p,fn:m}=e.#a[i]??{fn:i,dx:0,dy:0,blendmode:O.NORMAL};if(o.push({fn:m,fnc:T=>{T.transform&&(T.x=l,T.y=f,T.blendMode=p)}}),m in e.#s||m in w||m in S.shared.resources)continue;n=!0;const y=e.#r.searchPath(m,P.SP_GSM),x=this.#e.arg.crypto?{xhrType:y.endsWith(".json")?h.XHR_RESPONSE_TYPE.TEXT:h.XHR_RESPONSE_TYPE.BUFFER}:{};c.add({...x,name:m,url:y})}const d=o.at(0);d&&(d.fnc=s);const u=(i,l)=>{for(const{fn:f,fnc:p}of o){const m=e.#S(f,l);m.name=f,r(m),p(m)}a(n)};return n?c.use((i,l)=>{try{if(i.extension==="json"){this.#e.dec("json",i.data).then(f=>e.#h(f,i,l));return}this.#e.decAB(i.data).then(f=>e.#l(f,i,l))}catch(f){const p=`画像/動画ロード失敗です fn:${i.name} ${String(f)}`;e.#o.isSkipping?console.warn(p):console.error("%c"+p,"color:#FF3300;")}}).load(u):queueMicrotask(()=>u(0,{})),n}static#a={};static#s={};static#l=(t,{type:s,name:a,data:r},n)=>{switch(s){case h.TYPE.VIDEO:{const o=r;o.volume=e.#n,e.#t[a]=e.#u(o)}}n()};static#E(t){const s=/([^\d]+)\d+\.(\w+)/.exec(t[0]??"");if(!s)return[];const[,a="",r=""]=s,n=a.length,o=-r.length-1;return t.sort((c,d)=>R(c.slice(n,o))>R(d.slice(n,o))?1:-1)}static#y(t,s,a){if(s.data=t,s.extension!=="bin"&&a(),t instanceof HTMLImageElement){g.fromLoader(t,s.url,s.name).then(r=>{s.texture=r,s.type=h.TYPE.IMAGE}),a();return}t instanceof HTMLVideoElement&&(t.volume=e.#n,e.#t[s.name]=e.#u(t),s.type=h.TYPE.VIDEO),a()}static#u(t){return e.#d.getVal("const.sn.needClick2Play")&&(C.trace_beforeNew(`[lay系] ${C.strPos()}未クリック状態で動画を自動再生します。音声はミュートされます`,"W"),t.muted=!0),t.setAttribute("playsinline",""),t}static#h=(t,{type:s,spritesheet:a,name:r,data:n},o)=>{switch(s){case h.TYPE.JSON:{const c=a._frameKeys;e.#E(c),e.#s[r]={aTex:c.map(d=>g.from(d)),meta:n.meta}}}o()};static#T(t,s,a){const{meta:r,frames:n}=s.data=JSON.parse(t);if(s.type=h.TYPE.JSON,!r?.image){a();return}const o=A(r.image),c=e.#r.searchPath(o,P.SP_GSM);new S().use((d,u)=>{this.#e.decAB(d.data).then(i=>{d.data=i,i instanceof HTMLImageElement&&(d.type=h.TYPE.IMAGE,URL.revokeObjectURL(i.src)),u()}).catch(i=>this.#f.errScript(`画像/動画ロード失敗です dec2res4Cripto fn:${d.name} ${String(i)}`,!1))}).add({name:o,url:c,xhrType:h.XHR_RESPONSE_TYPE.BUFFER}).load((d,u)=>{for(const{data:i}of Object.values(d.resources)){const{baseTexture:l}=g.from(i),f=Object.values(n);e.#s[s.name]={aTex:f.map(({frame:{x:p,y:m,w:y,h:x}})=>new g(l,new L(p,m,y,x))),meta:r}}a()})}static#S(t,s){const a=e.#s[t];if(a){const o=new N(a.aTex);return o.animationSpeed=a.meta.animationSpeed??1,o.play(),o}if(t in w)return E.from(t);const r=e.#t[t];if(r)return E.from(r);const n=s[t];return n?new E(n.texture):new E}static#t={};static getHFn2VElm(t){return e.#t[t]}static wv(t){const{fn:s}=t;if(!s)throw"fnは必須です";const a=e.#t[s];if(!a||a.loop)return!1;if(e.#o.isSkipping||a.ended)return e.stopVideo(s),!1;const r="wv fn:"+s,n=F(t,"stop",!0),o=()=>{n&&e.stopVideo(s)};return b.beginProc(r,o,!0,o),a.addEventListener("ended",()=>b.notifyEndProc(r),{once:!0,passive:!0}),!0}static stopVideo(t){const s=e.#t[t];s&&(delete e.#t[t],s.pause(),s.currentTime=s.duration)}static add_face(t){const{name:s}=t;if(!s)throw"nameは必須です";if(s in e.#a)throw"一つのname（"+s+"）に対して同じ画像を複数割り当てられません";const{fn:a=s}=t;return e.#a[s]={fn:a,dx:v(t,"dx",0),dy:v(t,"dy",0),blendmode:M.getBlendmodeNum(t.blendmode??"")},!1}}export{e};
