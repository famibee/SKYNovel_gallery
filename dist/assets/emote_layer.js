import{a as e,i as t,o as n,t as r}from"./pixi.js";import{l as i}from"./CmnLib.js";import"./pixi2.js";import"./EventListenerCtn.js";import"./ConfigBase.js";import{t as a}from"./Layer.js";import"./CmnInterface.js";import"./SysBase.js";import"./web2.js";var o=class o extends a{static#e=0;static#t=0;static#n=0;#r;#i;#a=new r;#o;constructor(t){if(super(),this.pia=t,o.#e++%2!=1){if(o.#e===1){let{window:{width:e,height:n}}=t.getInfo();switch(o.#t=e,o.#n=n,String(this.pia.getVal(`const.sn.platform.os.family`))){case`Android`:case`iOS`:EmotePlayer.maskMode=EmotePlayer.MaskMode.STENCIL;break}EmotePlayer.createRenderCanvas(o.#t,o.#n)}this.#r=e.create({width:o.#t,height:o.#n}),this.ctn.addChild(new r(this.#r)),this.#i=document.createElement(`canvas`),this.#i.id=`emote:${o.#e}`,this.#i.width=o.#t,this.#i.height=o.#n,this.#i.hidden=!0,this.#a.width=o.#t,this.#a.height=o.#n}}lay(e,r){if(!this.#r)return!1;if(!e.layer){if(e[`:タグ名`]===`add_lay`)return!1;throw`layerは必須です`}if(super.lay(e),e.fn){let i=e.fn,a=new EmotePlayer(this.#i);this.#o={fn:i,player:a};let o={...e};return delete o.fn,o[`:タグ名`]=`lay`,a.onUpdate=()=>{a&&(this.#a.texture.destroy(),this.#a.texture=new n(new t(this.#i)),this.pia.render(this.#a,this.#r,!0))},a.promiseLoadDataFromURL(this.pia.searchPath(i,`emtbytes_|emtbytes`)).then(()=>{this.lay(o,r),this.pia.resume(r)}),!0}else if(e[`:タグ名`]===`add_lay`)return!1;if(!this.#o)return!1;a.setXY(this.#a,e,this.ctn,!0);let o=this.#o.player;if(e.label){let t=[...o.mainTimelineLabels,...o.diffTimelineLabels];if(!t.includes(e.label))throw console.error(`エラーが発生しました。参考までに ${this.#o.fn}.emtbytes 内に存在するアニメ名を列挙します`),t.forEach(e=>console.info(`  label=${e}`)),`${this.#o.fn}.emtbytes 内に存在しないアニメ（label=${e.label}）です`;o.mainTimelineLabel=e.label}return`scale`in e&&(o.scale=i(e,`scale`,1)),`grayscale`in e&&(o.grayscale=i(e,`grayscale`,1)),`windSpeed`in e&&(o.windSpeed=i(e,`windSpeed`,0)),`windPowerMin`in e&&(o.windPowerMin=i(e,`windPowerMin`,0)),`windPowerMax`in e&&(o.windPowerMax=i(e,`windPowerMax`,0)),!1}clearLay(e){this.#r&&(super.clearLay(e),this.#o&&(this.#o.player.onUpdate=()=>{},this.#o=null,this.#a.visible=!1,this.pia.render(this.#a,this.#r,!0),this.#a.visible=!0))}record=()=>Object.assign(super.record(),this.#o?{fn:this.#o.fn,label:this.#o.player.mainTimelineLabel,scale:this.#o.player.scale,grayscale:this.#o.player.grayscale,windSpeed:this.#o.player.windSpeed,windPowerMin:this.#o.player.windPowerMin,windPowerMax:this.#o.player.windPowerMax}:{fn:``});playback(e,t){return super.playback(e,t),e.fn?this.lay(e):(this.clearLay(e),!1)}dump(){return this.#r?super.dump()+(this.#o?`, "mdl":{"fn":"${this.#o.fn}","label":"${this.#o.player.mainTimelineLabel}","scale":"${this.#o.player.scale}"}`:`, "mdl":{"fn":""}`):`"is":"nothing"`}destroy(){this.#r&&(this.clearLay({}),this.ctn.removeChildren().forEach(e=>e.destroy()))}};async function s(e){e.addLayCls(`emote`,()=>new o(e))}export{s as init};