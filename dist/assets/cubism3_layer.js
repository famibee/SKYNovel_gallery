import{c as e,n as t,r as n,s as r}from"./pixi.js";import{l as i}from"./CmnLib.js";import"./pixi2.js";import"./EventListenerCtn.js";import"./ConfigBase.js";import{t as a}from"./Layer.js";import"./CmnInterface.js";import"./SysBase.js";import"./web2.js";var o=class extends a{model;ldr=new t;state={fn:``,label:``,scale:1};constructor(e){super(),this.pia=e}lay(o,s){super.lay(o);let c=o.id||`0`,l=o.fn;if(l){let r=o.label;if(!r)throw`label属性でモーションjsonファイル（${l}_(label).json）を指定して下さい`;let i=!1;[`moc`,`tex`,`mot`].map((a,o)=>{let s=`l2d:${l}_${a}`;if(!(s in this.ldr.resources))switch(s in e&&e[s]?.destroy(!0),i=!0,this.ldr.loading&&(this.ldr=new t),o){case 0:this.ldr.add({name:s,url:this.pia.searchPath(l,`moc3_|moc3`),xhrType:n.XHR_RESPONSE_TYPE.BUFFER});break;case 1:this.ldr.add({name:s,url:this.pia.searchPath(l,`png_|png|jpg_|jpg|jpeg_|jpeg`)});break;case 2:this.ldr.add({name:s,url:this.pia.searchPath(l+`_`+r,`json_|json`),xhrType:n.XHR_RESPONSE_TYPE.JSON});break}});let a=t=>{let n=Live2DCubismCore.Moc.fromArrayBuffer(t[`l2d:`+l+`_moc`].data);this.model=new LIVE2DCUBISMPIXI.ModelBuilder().setMoc(n).setTimeScale(1).addTexture(0,(t[`l2d:`+l+`_tex`]||e[`l2d:`+l+`_tex`]).texture).addAnimatorLayer(c,LIVE2DCUBISMFRAMEWORK.BuiltinAnimationBlenders.OVERRIDE,1).build(),this.ctn.addChild(this.model);let i=LIVE2DCUBISMFRAMEWORK.Animation.fromMotion3Json(t[`l2d:`+l+`_mot`].data);this.model.animator.getLayer(c).play(i);let a=()=>{this.hdl_tick=requestAnimationFrame(a),this.model&&this.model.update(1)};this.hdl_tick=requestAnimationFrame(a);let u={...o};delete u.fn,delete u.label,this.state.fn=l,this.state.label=r,this.lay(u,s),this.pia.resume(s)};return i?this.ldr.load((e,t)=>a(t)):a(this.ldr.resources),!0}if(!this.state.fn)return!1;if(`label`in o){let e=o.label||``;if(this.state.label!=e){this.state.label=e;let r=this.state.fn,i=this.pia.searchPath(r+`_`+e,`json_|json`);new t().add({name:`l2d:`+r+`_mot`,url:i,xhrType:n.XHR_RESPONSE_TYPE.JSON}).load((e,t)=>{let n=LIVE2DCUBISMFRAMEWORK.Animation.fromMotion3Json(t[`l2d:`+r+`_mot`].data);this.model.animator.getLayer(c).play(n)})}}return`scale`in o&&(this.state.scale=i(o,`scale`,1),this.model.scale=new r(this.state.scale,this.state.scale),this.model.x=this.model.width/2,this.model.y=this.model.height/2),a.setXY(this.model,o,this.ctn,!0),!1}hdl_tick=0;clearLay(e){super.clearLay(e),this.model&&=(cancelAnimationFrame(this.hdl_tick),this.ctn.removeChild(this.model),null),this.state={fn:``,label:``,scale:1}}record=()=>Object.assign(super.record(),this.state);playback(e,t){return super.playback(e,t),this.lay(e)}destroy(){this.clearLay({})}};async function s(e){e.addLayCls(`cubism3`,()=>new o(e))}export{s as init};