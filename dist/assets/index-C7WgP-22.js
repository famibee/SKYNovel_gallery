import{x as p,b}from"./web-D5cyPUip.js";import{L as m,T as u,a as f,P as y}from"./pixi-BNm1jFGN.js";import"../web.js";class E extends p{constructor(e){super(),this.pia=e}model;ldr=new m;state={fn:"",label:"",scale:1};lay(e,n){super.lay(e);const c=e.id||"0",t=e.fn;if(t){const s=e.label;if(!s)throw`label属性でモーションjsonファイル（${t}_(label).json）を指定して下さい`;let o=!1;["moc","tex","mot"].map((i,l)=>{const a=`l2d:${t}_${i}`;if(!(a in this.ldr.resources))switch(a in u&&u[a]?.destroy(!0),o=!0,this.ldr.loading&&(this.ldr=new m),l){case 0:this.ldr.add({name:a,url:this.pia.searchPath(t,"moc3_|moc3"),xhrType:f.XHR_RESPONSE_TYPE.BUFFER});break;case 1:this.ldr.add({name:a,url:this.pia.searchPath(t,"png_|png|jpg_|jpg|jpeg_|jpeg")});break;case 2:this.ldr.add({name:a,url:this.pia.searchPath(t+"_"+s,"json_|json"),xhrType:f.XHR_RESPONSE_TYPE.JSON});break}});const r=i=>{const l=Live2DCubismCore.Moc.fromArrayBuffer(i["l2d:"+t+"_moc"].data);this.model=new LIVE2DCUBISMPIXI.ModelBuilder().setMoc(l).setTimeScale(1).addTexture(0,(i["l2d:"+t+"_tex"]||u["l2d:"+t+"_tex"]).texture).addAnimatorLayer(c,LIVE2DCUBISMFRAMEWORK.BuiltinAnimationBlenders.OVERRIDE,1).build(),this.ctn.addChild(this.model);const a=LIVE2DCUBISMFRAMEWORK.Animation.fromMotion3Json(i["l2d:"+t+"_mot"].data);this.model.animator.getLayer(c).play(a);const _=()=>{this.hdl_tick=requestAnimationFrame(_),this.model&&this.model.update(1)};this.hdl_tick=requestAnimationFrame(_);const h={...e};delete h.fn,delete h.label,this.state.fn=t,this.state.label=s,this.lay(h,n),this.pia.resume(n)};return o?this.ldr.load((i,l)=>r(l)):r(this.ldr.resources),!0}if(!this.state.fn)return!1;if("label"in e){const s=e.label||"";if(this.state.label!=s){this.state.label=s;const o=this.state.fn,r=this.pia.searchPath(o+"_"+s,"json_|json");new m().add({name:"l2d:"+o+"_mot",url:r,xhrType:f.XHR_RESPONSE_TYPE.JSON}).load((i,l)=>{const a=LIVE2DCUBISMFRAMEWORK.Animation.fromMotion3Json(l["l2d:"+o+"_mot"].data);this.model.animator.getLayer(c).play(a)})}}return"scale"in e&&(this.state.scale=b(e,"scale",1),this.model.scale=new y(this.state.scale,this.state.scale),this.model.x=this.model.width/2,this.model.y=this.model.height/2),p.setXY(this.model,e,this.ctn,!0),!1}hdl_tick=0;clearLay(e){super.clearLay(e),this.model&&(cancelAnimationFrame(this.hdl_tick),this.ctn.removeChild(this.model),this.model=null),this.state={fn:"",label:"",scale:1}}record=()=>Object.assign(super.record(),this.state);playback(e,n){return super.playback(e,n),this.lay(e)}destroy(){this.clearLay({})}}async function P(d){d.addLayCls("cubism3",()=>new E(d))}export{P as init};
