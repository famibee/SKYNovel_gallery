const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/three2.module.js","assets/three.module.js","assets/OrbitControls.js","assets/GLTFLoader.js"])))=>i.map(i=>d[i]);
import{o as e,t}from"./pixi.js";import{t as n}from"../web.js";import{l as r,s as i}from"./CmnLib.js";import"./pixi2.js";import"./EventListenerCtn.js";import"./ConfigBase.js";import{t as a}from"./Layer.js";import"./CmnInterface.js";import"./SysBase.js";import"./web2.js";import{Wr as o}from"./three.module.js";var s=`png_|jpg_|jpeg_|svg_|png|jpg|jpeg|svg`,c=class c extends a{static#e=0;static#t=0;static#n=0;static THREE;static OrbitControls;static GLTFLoader;static async init(){c.THREE??=await n(()=>import(`./three2.module.js`),__vite__mapDeps([0,1]))}#r;#i;#a;#o;constructor(n){if(super(),this.pia=n,c.#e++%2!=1){if(c.#e===1){let{window:{width:e,height:t}}=n.getInfo();c.#t=e,c.#n=t}this.#r=new c.THREE.Scene,this.#i=new c.THREE.WebGLRenderer({antialias:!0,alpha:!0}),this.#i.setSize(c.#t,c.#n),this.#i.setPixelRatio(window.devicePixelRatio),this.#a=new t(e.from(this.#i.domElement)),this.ctn.addChild(this.#a),this.#a.x=(c.#t-this.#a.width)/2,this.#a.y=(c.#n-this.#a.height)/2}}#s=()=>{this.#c&&(this.#i.render(this.#r,this.#o),this.#a.texture.update(),this.#m(),this.#l(),this.#u(),requestAnimationFrame(this.#s))};#c=!1;#l=()=>{};#u=()=>{};#d=new c.THREE.Clock;#f;#p={};#m=()=>{};lay(e){if(!this.#r)return!1;if(`grid`in e){let t=new c.THREE.GridHelper(r(e,`grid_size`,10),r(e,`grid_step`,5));this.#_(e,`grid`,t),t.name=`_grid`,this.#r.add(t)}if(`camera`in e&&(this.#o||=new c.THREE.PerspectiveCamera(r(e,`camera_fov`,50),c.#t/c.#n,r(e,`camera_near`,.1),r(e,`camera_far`,2e3)),this.#_(e,`camera`,this.#o),`camera_target`in e)){let[t,n,r]=String(e.camera_target).split(`,`).map(e=>Number(e));this.#o.lookAt(new c.THREE.Vector3(t,n,r))}if(`directional_light`in e){let t=new c.THREE.DirectionalLight(16777215);t.intensity=r(e,`intensity`,1),this.#_(e,`directional_light`,t),t.name=`_light`,this.#r.add(t)}`controls`in e&&Promise.try(async()=>c.OrbitControls??=(await n(async()=>{let{OrbitControls:e}=await import(`./OrbitControls.js`);return{OrbitControls:e}},__vite__mapDeps([2,1]))).OrbitControls).then(()=>{let e=new c.OrbitControls(this.#o,document.body);e.target.set(this.#o.position.x+.15,this.#o.position.y,this.#o.position.z),e.enableDamping=!0,e.dampingFactor=.2,e.rotateSpeed=.1,e.zoomSpeed=2,this.#l=()=>e.update()});let t=e.type,i=e.name||``,a=new c.THREE.Mesh;if(t){if(i in this.#g)throw`name（=${i}）が重複しています`;if(this.#c||(this.#c=!0,this.#s()),t==`box`){let n=r(e,`size`,100),o=new c.THREE.BoxGeometry(n,n,n),s=new c.THREE.MeshNormalMaterial;a=new c.THREE.Mesh(o,s),a.rotation.z=-45,this.#l=()=>this.#r.children.forEach(e=>{let t=e;t&&(t.rotation.x+=.01,t.rotation.y+=.01,t.rotation.z+=.01)}),this.#g[i]={type:t,fn:``}}else{let o=e.fn;if(!o)throw`fnは必須です`;switch(t){case`eff`:{let n=()=>{this.#p[o]=this.#f.loadEffect(this.pia.searchPath(o,`efk`),r(e,`scale`,1),()=>{let[n=`0`,r=`0`,a=`0`]=String(e.pos||`0,0,0`).split(`,`),s=this.#f.play(this.#p[o],parseInt(n),parseInt(r),parseInt(a));this.#g[i]={type:t,fn:o,effhdl:s}},(e,t)=>console.error(e+` url=`+t))};if(this.#f){n();break}effekseer.initRuntime(`./effekseer.wasm`,()=>{this.#f=effekseer.createContext(),this.#f.init(this.#i.getContext());let e=new c.THREE.Clock;this.#m=()=>{this.#f.update(e.getDelta()*60),this.#f.setProjectionMatrix(Float32Array.from(this.#o.projectionMatrix.elements)),this.#f.setCameraMatrix(Float32Array.from(this.#o.matrixWorldInverse.elements)),this.#f.draw()}},()=>{})}break;case`celestial_sphere`:{let e=new c.THREE.SphereGeometry(5,60,40);e.scale(-1,1,1);let t=new c.THREE.TextureLoader;if(!o)throw`fnがありません`;let n=t.load(this.pia.searchPath(o,s));n.minFilter=c.THREE.LinearFilter;let r=new c.THREE.MeshBasicMaterial({map:n});a=new c.THREE.Mesh(e,r),this.#o.lookAt(a.position),this.#l=()=>{a.rotation.y+=.001}}break;case`gltf`:{let r=`debug`in e?e=>console.log(`${e.loaded/e.total*100}% loaded`):()=>{};Promise.try(async()=>c.GLTFLoader??=(await n(async()=>{let{GLTFLoader:e}=await import(`./GLTFLoader.js`);return{GLTFLoader:e}},__vite__mapDeps([3,1]))).GLTFLoader).then(()=>new c.GLTFLoader().load(this.pia.searchPath(o,`gltf|glb`),n=>{let r=n.scene;r.name=i,this.#r.add(r),this.#g[i]={type:t,fn:o,gltf:n},this.#h(e,r)},r,e=>console.error(`An error happened`,e)))}return!1;default:throw`サポートしない type=${t} です`}this.#g[i]={type:t,fn:o}}a.name=i,this.#r.add(a)}else if(`del`in e){let t=e.del;if(!t)return!1;let n=this.#r.children.find(e=>e.name===t);return n?(this.#b(n),delete this.#g[t],!1):!1}else if(`name`in e){let e=this.#r.children.find(e=>e.name===i);if(!e)throw`３Ｄレイヤに存在しないモデル name=${i} です`;a=e}else return!1;return this.#h(e,a),!1}#h(e,t){this.#_(e,`pos`,t),this.#v(e,`scale`,t);let n=this.#g[t.name];if(n&&`label`in e&&(n.label=e.label,n.gltf)){let a=c.THREE.AnimationClip.findByName(n.gltf.animations,n.label||``);if(!a)throw console.info(`エラーが発生しました。参考までに ${n.fn}(glTF)内に存在するアニメ名を列挙します`),n.gltf.animations.map(e=>console.info(`  label=${e.name}`)),`${n.fn}(glTF)内に存在しないアニメ（label=${n.label}）です`;if(n.mixer){let t=r(e,`time`,1e3)/1e3,i=n.mixer.clipAction(a);i.crossFadeFrom(n.aa,t,!0),n.aa=i}else n.mixer=new c.THREE.AnimationMixer(t),n.aa=n.mixer.clipAction(a),this.#u=()=>{this.#r.children.map(e=>{let t=this.#g[e.name];t&&t.mixer.update(this.#d.getDelta())})};n.aa.enabled=!0,n.aa.clampWhenFinished=!0,n.aa.loop=i(e,`loop`,!0)?c.THREE.LoopRepeat:c.THREE.LoopOnce,n.aa.play()}}#g={};#_(e,t,n){if(!(t in e))return;let[r=0,i=0,a=0]=String(e[t]).split(`,`).map(e=>Number(e));n.position.set(r,i,a)}#v(e,t,n){if(!(t in e))return;let[r=0,i=0,a=0]=String(e[t]).split(`,`).map(e=>Number(e));n.scale.set(r,i,a)}clearLay(e){super.clearLay(e),this.#r&&this.#c&&(this.#c=!1,this.#l=()=>{},this.#u=()=>{},this.#g={},this.#y(this.#r),this.#i.clear(),this.#a.texture.update())}#y(e){e.children.slice().map(e=>this.#b(e))}#b(e){e.parent.remove(e);let t=e;if(t){let e=this.#g[t.name];e&&e.mixer&&e.mixer.stopAllAction(),this.#y(t);return}let n=e;n&&(n.geometry.dispose(),n.material instanceof o?(n.material.dispose(),n.material&&=[]):n.material.map(e=>e.dispose()))}record=()=>Object.assign(super.record(),{hInf:this.#g});playback(e,t){super.playback(e,t),this.#g=e.hInf,this.#r}dump(){if(!this.#r)return`"is":"nothing"`;let e=[];return this.#r.children.map(t=>{let n=`"${t.name}": {"type":"${t.type}"`,r=this.#g[t.name];r&&r.mixer&&(n+=`, "label":"${r.label}"`),e.push(n+`}`)}),super.dump()+`, "mdl":{${e.join(`,`)}}`}};async function l(e){return e.addLayCls(`3d`,()=>new c(e)),c.init()}export{l as init};