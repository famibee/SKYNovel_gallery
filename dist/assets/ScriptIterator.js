import{C as S,S as T,a as w,R as E,d as m,L as P,l as O,h as C}from"./web.js";import{c as A,a as x,r as $}from"./CallStack.js";import{G as M,A as B,t as _,a as L}from"./Main.js";import{o as j}from"./RubySpliter.js";import{t as d}from"./DebugMng.js";import{k as y}from"./CmnTween.js";import{a as b,n as N}from"./Reading.js";import{X as D}from"./SndBuf.js";import"../web.js";class p{constructor(t,s,i,n,h,r,a){this.cfg=t,this.hTag=s,this.main=i,this.val=n,this.prpPrs=h,this.sndMng=r,this.sys=a,s.let_ml=e=>this.#Z(e),s.endlet_ml=()=>!1,s.dump_stack=()=>this.#tt(),s.dump_script=e=>this.#st(e),s.else=s.elsif=s.endif=()=>this.#et(),s.if=e=>this.#nt(e),s.call=e=>this.#ht(e),s.jump=e=>this.#at(e),s.pop_stack=e=>this.#ot(e),s.return=e=>this.#j(e),s.bracket2macro=e=>this.#dt(e),s.char2macro=e=>this.#kt(e),s.endmacro=e=>this.#j(e),s.macro=e=>this.#vt(e),s.load=e=>this.#St(e),s.reload_script=e=>this.#Tt(e),s.record_place=()=>this.#q(),s.save=e=>this.#wt(e),t.oCfg.debug.token&&(this.#F=e=>{e.trim()!==""&&console.log(`ğŸŒ± ãƒˆãƒ¼ã‚¯ãƒ³ ${this.#i}:${String(this.#e)} (i:${String(this.#t)} cs:${String(this.#n.length)}) %cã€${e}ã€‘`,"background-color:#350;")}),t.oCfg.debug.tag&&(this.#C=e=>console.log(`ğŸŒ² ã‚¿ã‚°è§£æ ${this.#i}:${String(this.#e)} (i:${String(this.#t)} cs:${String(this.#n.length)}) %c[${e} %o]`,"background-color:#30B;",this.#r.hPrm)),n.defTmp("const.sn.aIfStk.length",()=>this.#o.length),n.defTmp("const.sn.vctCallStk.length",()=>this.#n.length),this.#l=new M(t);const l=t.oCfg.init.escape;if(this.#l.setEscape(l),j.setEscape(l),S.isDbg){this.#d,a.addHook((c,f)=>this.#d[c]?.(f)),this.isBreak=c=>this.#G(c);const e=()=>this.analyzeInit();this.analyzeInit=()=>{this.analyzeInit=()=>{},this.sys.send2Dbg("hi",{})},this.#d.auth=c=>{const f=c.hBreakpoint.hFn2hLineBP;for(const[o,u]of Object.entries(f))this.#I(o,u);p.#p={};for(const o of c.hBreakpoint.aFunc)p.#p[o.name]=1;if(c.stopOnEntry){let o;for(;o=this.nextToken();){const u=o.charCodeAt(0);if(u===91||u===38||u===42&&o.length===1)break;u===10&&(this.#e+=o.length)}this.sys.callHook("stopOnEntry",{}),this.analyzeInit=e,this.analyzeInit()}else this.noticeWait=()=>{this.noticeWait=()=>{},this.sys.callHook("stopOnEntry",{})},this.analyzeInit=e,this.analyzeInit()}}else this.recodeDesign=()=>{}}#s={aToken:[""],len:1,aLNum:[1]};#i="";get scriptFn(){return this.#i}#t=0;get idxToken(){return this.#t}subIdxToken(){--this.#t}#e=0;get lineNum(){return this.#e}addLineNum=t=>{this.#e+=t};jumpJustBefore(){this.#f(this.#i,"",--this.#t)}#n=[];#l;#r=new B;noticeWait=()=>{};#I(t,s){p.#w[this.#b(t)]=s}destroy(){this.isBreak=this.#q=()=>!1}#d={auth:()=>{},disconnect:()=>{p.#w={},p.#p={},this.isBreak=()=>!1,this.#d.continue({}),this.#h=0},restart:()=>{this.isBreak=()=>!1},add_break:t=>this.#I(t.fn,t.o),data_break:t=>{this.#h===0&&(this.#h=1,this.main.setLoop(!1,`å¤‰æ•° ${String(t.dataId)}ã€${String(t.old_v)}ã€‘â†’ã€${String(t.new_v)}ã€‘ãƒ‡ãƒ¼ã‚¿ãƒ–ãƒ¬ãƒ¼ã‚¯`),this.sys.callHook("stopOnDataBreakpoint",{}),this.sys.send2Dbg("stopOnDataBreakpoint",{}))},set_func_break:t=>{p.#p={};for(const s of t.a)p.#p[s.name]=1;this.sys.send2Dbg(t.ri,{})},stack:t=>this.sys.send2Dbg(t.ri,{a:this.#J()}),eval:t=>{this.sys.send2Dbg(t.ri,{v:this.prpPrs.parse(t.txt)})},continue:()=>{this.#T()||(this.#t-=this.#v,this.#h=3,this.main.setLoop(!0),this.main.resume())},stepover:t=>this.#E(t),stepin:()=>{if(this.#T())return;const t=this.#s.aToken[this.#t-this.#v];this.sys.callHook(`stopOnStep${this.#N.test(t??"")?"In":""}`,{}),this.#t-=this.#v,this.#h=this.#h===1?4:5,this.main.setLoop(!0),this.main.resume()},stepout:t=>{this.#T()||(this.#n.length>0?this.#P(!0):this.#E(t))},pause:()=>{this.#h=4,this.main.setLoop(!1,"ä¸€æ™‚åœæ­¢"),this.sys.send2Dbg("stopOnStep",{})},stopOnEntry:()=>{this.#h=4,this.main.setLoop(!1,"ä¸€æ™‚åœæ­¢"),this.sys.send2Dbg("stopOnEntry",{})}};#k=t=>this.cfg.searchPath(t,T.SCRIPT);#b=t=>this.sys.pathBaseCnvSnPath4Dbg+this.#k(t);#E(t){if(this.#T())return;const s=this.#s.aToken[this.#t-this.#v];this.#N.test(s??"")?this.#P(!1):(this.sys.callHook("stopOnStep",{}),this.#d.stepin(t))}#P(t){this.sys.callHook(`stopOnStep${t?"Out":""}`,{}),this.#O=this.#n.length-(t?1:0),this.#t-=this.#v,this.#h=t?7:6,this.main.setLoop(!0),this.main.resume()}#O=0;get#v(){return this.#h===2||this.#h===4?1:0}#T(){return this.#t<this.#s.len?!1:(this.sys.callHook("stopOnEntry",{}),this.main.setLoop(!1,"ã‚¹ã‚¯ãƒªãƒ—ãƒˆçµ‚ç«¯ã§ã™ isIdxOverLast"),!0)}static#w={};static#p={};#h=0;isBreak=t=>!1;#G(t){switch(this.#h){case 6:this.#_(),this.#h=7;break;case 7:if(this.#n.length!==this.#O)break;return this.#h=4,this.main.setLoop(!1,"ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œ"),this.sys.send2Dbg("stopOnStep",{}),!0;case 5:this.#_(),this.#h=4;break;case 4:return this.#_(),this.main.setLoop(!1,"ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œ"),this.sys.send2Dbg("stopOnStep",{}),!0;case 3:this.#_(),this.#h=0;break;default:if(_(t)in p.#p)return this.#h=2,this.main.setLoop(!1,`é–¢æ•° ${t} ãƒ–ãƒ¬ãƒ¼ã‚¯`),this.sys.callHook("stopOnBreakpoint",{}),this.sys.send2Dbg("stopOnBreakpoint",{}),!0;{const s=p.#w[this.#b(this.#i)];if(!s)break;const i=s[this.#e];if(!i)break;if(i.condition){if(!this.prpPrs.parse(i.condition))break}else if("hitCondition"in i&&--i.hitCondition>0)break;const n=this.#h===0;this.#h=2,this.main.setLoop(!1,n?(i.condition?"æ¡ä»¶":"ãƒ’ãƒƒãƒˆã‚«ã‚¦ãƒ³ãƒˆ")+"ãƒ–ãƒ¬ãƒ¼ã‚¯":"ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œ");const h=n?"stopOnBreakpoint":"stopOnStep";this.sys.callHook(h,{}),this.sys.send2Dbg(h,{})}return!0}return!1}#_(){const t=p.#w[w(this.#i)]?.[this.#e];t?.hitCondition&&--t.hitCondition}#J(){const t=this.#h===3?1:0,s=this.#s.aToken[this.#t-1+t],i=this.#b(this.#i),n=_(s),h=n?`[${n}]`:s,r=String(this.val.getVal("mp:const.sn.macro")??"{}");if(this.#t===0)return[{fn:i,ln:1,col:1,nm:h,ma:r}];const a=this.#c(this.#s,this.#t),l=[{fn:i,ln:a.ln,col:a.col_s+1,nm:h,ma:r}],e=this.#n.length;if(e===0)return l;for(let c=e-1;c>=0;--c){const f=this.#n[c],o=this.#a[f.fn];if(!o)continue;const u=o.aToken[f.idx-1];if(!u)continue;const g=this.#c(o,f.idx),v=_(u);l.push({fn:this.#b(f.fn),ln:g.ln,col:g.col_s+1,nm:v?`[${v}]`:u,ma:f.csArg[":hMp"]["const.sn.macro"]})}return l}#C=t=>{};async ã‚¿ã‚°è§£æ(t,s){const i=this.hTag[t];if(!i)throw`æœªå®šç¾©ã®ã‚¿ã‚°ã€${t}ã€‘ã§ã™`;this.#r.parse(s),this.#C(t);const n=this.#r.hPrm;if(n.cond){const e=n.cond.val;if(!e||e.startsWith("&"))throw"å±æ€§condã¯ã€Œ&ã€ãŒä¸è¦ã§ã™";const c=this.prpPrs.parse(e),f=String(c);if(f==="null"||f==="undefined"||!c)return!1}let h={};const r=this.#n.at(-1)?.csArg??A(),a=this.#n.length;if(this.#r.isKomeParam){if(a===0)throw"å±æ€§ã€Œ*ã€ã¯ãƒã‚¯ãƒ­ã®ã¿æœ‰åŠ¹ã§ã™";h={...r}}h[":ã‚¿ã‚°å"]=t;for(const[e,{val:c,def:f}]of Object.entries(n)){let o=c;if(c.startsWith("%")){if(a===0)throw"å±æ€§ã€Œ%ã€ã¯ãƒã‚¯ãƒ­å®šç¾©å†…ã§ã®ã¿ä½¿ç”¨ã§ãã¾ã™ï¼ˆãã®ãƒã‚¯ãƒ­ã®å¼•æ•°ã‚’ç¤ºã™ç°¡ç•¥æ–‡æ³•ã§ã‚ã‚‹ãŸã‚ï¼‰";const u=r[o.slice(1)];if(u){h[e]=u;continue}if(f===void 0||f==="null")continue;o=f}if(o=this.prpPrs.getValAmpersand(o??""),o!=="undefined"){h[e]=o;continue}f!==void 0&&(o=this.prpPrs.getValAmpersand(f),o!=="undefined"&&(h[e]=o))}if(b.needGoTxt&&this.#X.has(t)){const{promise:e,resolve:c}=Promise.withResolvers();b.beginProc(E,()=>c(0),!1,()=>c(0)),b.goTxt(),this.val.saveKidoku(),await e}this.#U.has(t)&&(this.#L.hideHint(),y.stopEndTrans());const l=this.#Q[t];return l&&m(h,"canskip",this.#Y[t]??!0)&&this.#L.isSkipping?l(h):i(h)}#X=new Set(["trans","wt","wait_tsy","wv","l","p","s","wait","waitclick","wb","wf","wl","ws","quake","wq"]);#U=new Set(["finish_trans","trans","quake","stop_quake","add_filter"]);#Q={wt:()=>(y.stopEndTrans(),!1),wait_tsy:t=>this.hTag.stop_tsy(t),wait:()=>!1,wb:()=>this.hTag.stopfadese({buf:D}),wf:t=>this.hTag.stopfadese(t),wq:()=>this.hTag.stop_quake({}),quake:()=>!1};#Y={wt:!0,wait_tsy:!0,wv:!0,wait:!0,playbgm:!1,playse:!0,wb:!1,wf:!1,ws:!1,wq:!0};#L;#g;setOtherObj(t,s){this.#L=t,this.#g=s}#Z(t){const{name:s}=t;if(!s)throw"nameã¯å¿…é ˆã§ã™";let i="";const n=this.#s.len;for(;this.#t<n&&(i=this.#s.aToken[this.#t],i==="");++this.#t);return t.text=i,t.cast="str",this.hTag.let(t),this.#t+=2,this.#e+=(i.match(/\n/g)??[]).length,!1}#tt(){if(this.#t===0)return console.group(`ğŸ¥Ÿ [dump_stack] ã‚¹ã‚¯ãƒªãƒ—ãƒˆç¾åœ¨åœ° fn:${this.#i} line:1 col:0`),console.groupEnd(),!1;const t=this.#c(this.#s,this.#t),s=`ã‚¹ã‚¯ãƒªãƒ—ãƒˆç¾åœ¨åœ° fn:${this.#i} line:${String(t.ln)} col:${String(t.col_s+1)}`;console.group(`ğŸ¥Ÿ [dump_stack] ${s}`);const i=this.#n.length;if(i>0){console.info(s);for(let n=i-1;n>=0;--n){const h=this.#n[n],r=h.csArg[":hMp"],a=r?r[":ã‚¿ã‚°å"]:void 0,l=h.csArg[":ã‚¿ã‚°å"]??"",e=this.#c(this.#a[h.fn],h.idx);console.info(`${String(i-n)}ã¤å‰ã®ã‚³ãƒ¼ãƒ«å…ƒ fn:${h.fn} line:${String(e.ln)} col:${String(e.col_s+1)}${a?"ï¼ˆ["+a+"]ãƒã‚¯ãƒ­å†…ï¼‰":" "}ã§ [${l} ...]ã‚’ã‚³ãƒ¼ãƒ«`)}}return console.groupEnd(),!1}#c(t,s){const i={ln:1,col_s:0,col_e:0};if(!t)return i;let n=s-1;const h=i.ln=t.aLNum[n];for(;t.aLNum[n]===h;){const r=t.aToken[n];if(!r.startsWith(`
`)){const a=r.length;i.col_e>0&&(i.col_s+=a),i.col_e+=a}if(--n<0)break}return i}#st(t){const{set_fnc:s,break_fnc:i}=t;if(!s)throw"set_fncã¯å¿…é ˆã§ã™";if(this.#y=globalThis[s],!this.#y){if(m(t,"need_err",!0))throw`HTMLå†…ã«é–¢æ•°${s}ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`;return this.#y=()=>{},!1}if(this.noticeBreak=n=>{this.#A!==this.#i&&(this.#A=this.#i,this.#y(this.#it[this.#i]??=this.#s.aToken.join(""))),this.#x(this.#e,n)},this.noticeBreak(!0),!i)return!1;if(this.#x=globalThis[i],!this.#x){if(m(t,"need_err",!0))throw`HTMLå†…ã«é–¢æ•°${i}ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`;this.#x=()=>{}}return!1}#y=()=>{};#x=()=>{};#A="";#it={};noticeBreak=t=>{};#M=5;dumpErrForeLine(){if(this.#t===0){console.group(`ğŸ¥Ÿ Error line (from 0 rows before) fn:${this.#i}`),console.groupEnd();return}let t="";for(let r=this.#t-1;r>=0&&(t=String(this.#s.aToken[r])+t,!((t.match(/\n/g)??[]).length>=this.#M));--r);const s=t.split(`
`).slice(-this.#M),i=s.length;console.group(`ğŸ¥Ÿ Error line (from ${String(i)} rows before) fn:${this.#i}`);const n=String(this.#e).length,h=this.#c(this.#s,this.#t);for(let r=0;r<i;++r){const a=this.#e-i+r+1,l=`${String(a).padStart(n," ")}: %c`,e=s[r],c=e.length>75?e.slice(0,75)+"â€¦":e;r===i-1?console.info(l+c.slice(0,h.col_s)+"%c"+c.slice(h.col_s),"color: black; background-color: skyblue;","color: black; background-color: pink;"):console.info(l+c,"color: black; background-color: skyblue;")}console.groupEnd()}#o=[-1];#et(){const t=this.#o[0];if(!t)throw"this.#aIfStk ãŒç•°å¸¸ã§ã™";if(t===-1)throw"ifãƒ–ãƒ­ãƒƒã‚¯å†…ã§ã¯ã‚ã‚Šã¾ã›ã‚“";return this.#t=t,this.#o.shift(),!1}#nt(t){const{exp:s}=t;if(!s)throw"expã¯å¿…é ˆã§ã™";if(s.startsWith("&"))throw"å±æ€§expã¯ã€Œ&ã€ãŒä¸è¦ã§ã™";let i=0,n=this.prpPrs.parse(s)?this.#t:-1;const h=this.#s.aLNum[this.#t],r=this.#e-((h??0)||0),a=this.#s.len;for(;this.#t<a;++this.#t){const l=this.#s.aLNum[this.#t];this.#s.aLNum[this.#t]=((l??0)||0)+r;const e=this.#s.aToken[this.#t];if(!e)continue;const c=e.charCodeAt(0);if(c===10){this.#e+=e.length;continue}if(c!==91)continue;const[f,o]=L(e);if(!(f in this.hTag))throw`æœªå®šç¾©ã®ã‚¿ã‚°[${f}]ã§ã™`;switch(this.#r.parse(o),f){case"if":++i;break;case"elsif":{if(i>0||n>-1)break;const u=this.#r.hPrm.exp?.val;if(!u)throw"expã¯å¿…é ˆã§ã™";if(u.startsWith("&"))throw"å±æ€§expã¯ã€Œ&ã€ãŒä¸è¦ã§ã™";this.prpPrs.parse(u)&&(n=this.#t+1)}break;case"else":if(i>0)break;n===-1&&(n=this.#t+1);break;case"endif":if(i>0){--i;break}return n===-1?(++this.#t,this.#s.aLNum[this.#t]+=r):(this.#o.unshift(this.#t+1),this.#t=n,this.#e=this.#s.aLNum[this.#t]),!1}}throw"[endif]ãŒãªã„ã¾ã¾ã‚¹ã‚¯ãƒªãƒ—ãƒˆçµ‚ç«¯ã§ã™"}#ht(t){m(t,"count",!1)||this.#K();const{fn:s}=t;return s&&this.#k(s),this.#B({...t},N.popLocalEvts()),m(t,"clear_local_event",!1)&&this.hTag.clear_event({}),this.#f(s,t.label)}#B(t,s){const i={...t,":hEvt1Time":s,":hMp":this.val.cloneMp(),":lenIfStk":this.#o.length};this.#s.aLNum[this.#t]=this.#e,this.#D||(i[":resvToken"]="",this.#$()),this.#n.push(new x(this.#i,this.#t,i)),this.#o.unshift(-1)}#at(t){return m(t,"count",!0)||this.#K(),this.#o[0]=-1,this.#f(t.fn,t.label)}#ot(t){if(m(t,"clear",!1))this.#n=[];else if(!this.#n.pop())throw"ã‚¹ã‚¿ãƒƒã‚¯ãŒç©ºã§ã™";return this.#$(),this.#o=[-1],this.val.setMp($()),!1}#j(t){const s=this.#n.pop();if(!s)throw"ã‚¹ã‚¿ãƒƒã‚¯ãŒç©ºã§ã™";const i=s.csArg;this.#o=this.#o.slice(-i[":lenIfStk"]);const n=i[":hMp"];n&&this.val.setMp(n);const h=i[":resvToken"];h?this.nextToken=()=>(this.#$(),h):this.#$(),i[":hEvt1Time"]&&N.pushLocalEvts(i[":hEvt1Time"]);const{fn:r,label:a}=t;return r||a?this.#f(r,a):s.fn in this.#a?(this.#z(s),!1):this.#f(s.fn,"",s.idx)}#D="";#$(){this.#D="",this.nextToken=()=>this.#W()}#S="";#f(t="",s="",i=0){if(S.debugLog&&console.log(`ğŸ“œ %c1:jumpWork%c fn:${t} lbl:${s} idx:${String(i)}`,"color:#3B0;",""),!t&&!s&&this.main.errScript("[jumpç³»] fnã¾ãŸã¯labelã¯å¿…é ˆã§ã™"),s?(s.startsWith("*")||this.main.errScript("[jumpç³»] labelã¯*ã§å§‹ã¾ã‚Šã¾ã™"),this.#S=s,this.#S.startsWith("**")||(this.#t=i)):(this.#S="",this.#t=i),!t)return this.analyzeInit(),!1;if(t.includes("@"))throw"[jumpç³»] fn ã«ã¯æ–‡å­—ã€Œ@ã€ã¯ç¦æ­¢ã§ã™";const n=this.#k(t);if(t===this.#i)return this.analyzeInit(),!1;this.#i=t;const h=this.#a[t];if(h)return this.#s=h,this.analyzeInit(),!1;const r=`jumpWork fn:${t}`;b.beginProc(r);let a="";const l=new P;try{a=this.#k(t+"@"),l.add({name:t+":base",url:n}),l.add({name:t,url:a})}catch{l.add({name:t,url:n})}return l.use((e,c)=>{this.sys.dec(e.extension,e.data).then(f=>{e.data=f,c()}).catch(f=>{this.main.errScript(`[jumpç³»]snãƒ­ãƒ¼ãƒ‰å¤±æ•—ã§ã™ fn:${e.name} ${String(f)}`,!1),c()})}).load((e,c)=>{if(b.endProc(r),a){const f=c[t+":base"].data,o=c[t].data,u=f.split(`
`),g=o.split(`
`),v=u.length,I=g.length;for(let k=0;k<I&&k<v;++k)g[k]||=u[k]??"";c[t].data=g.join(`
`),delete c[t+":base"]}this.nextToken=this.#W,this.#e=1,this.#ft(c[t].data),this.hTag.record_place({}),this.analyzeInit()}),!0}analyzeInit(){S.debugLog&&console.log(`ğŸ“œ %c9:analyzeInit%c fn:${this.#i} lbl:${this.#S} idx:${String(this.#t)}`,"color:#3B0;","");const t=this.#ct(this.#s,!!this.val.getVal("mp:const.sn.macro.name"),this.#e,this.#S,this.#t);this.#t=t.idx,this.#e=t.ln}nextToken=()=>"";#W(){if(this.#V())return"";this.#mt(),this.#s.aLNum[this.#t]||=this.#e;const t=this.#s.aToken[this.#t];return this.#F(t),++this.#t,t}#F=t=>{};#V(){return this.#t<this.#s.len?!1:(this.main.errScript("ã‚¹ã‚¯ãƒªãƒ—ãƒˆçµ‚ç«¯ã§ã™ errOverScr"),!0)}#rt=/(\*{2,})([^|]*)/;#lt=/^\[macro\s/;#H=/^\[endmacro[\s\]]/;#ct(t,s,i,n,h){const r=t.aToken.length;let a=i,l=n;if(!l){if(this.#V())return{idx:h,ln:a};if(t.aLNum[h])a=t.aLNum[h];else{a=1;for(let o=0;o<h;++o){t.aLNum[o]||=a;const u=t.aToken[o];u.startsWith(`
`)?a+=u.length:a+=(u.match(/\n/g)??[]).length}t.aLNum[h]=a}return{idx:h,ln:a}}t.aLNum[0]=1;const e=l.match(this.#rt);if(e){l=e[1];let o=h;switch(e[2]){case"before":for(;t.aToken[--o]!==l;)o===0&&d.myTrace(`[jumpç³» ç„¡åãƒ©ãƒ™ãƒ«before] 
						${String(a)} è¡Œç›®ä»¥å‰ã§ ${s?"ãƒã‚¯ãƒ­å†…ã«":""} ãƒ©ãƒ™ãƒ«ã€ ${l} ã€‘ãŒã‚ã‚Šã¾ã›ã‚“`,"ET"),s&&t.aToken[o].search(this.#lt)>-1&&d.myTrace("[jumpç³» ç„¡åãƒ©ãƒ™ãƒ«before] ãƒã‚¯ãƒ­å†…ã«ãƒ©ãƒ™ãƒ«ã€"+l+"ã€‘ãŒã‚ã‚Šã¾ã›ã‚“","ET");return{idx:o+1,ln:t.aLNum[o]};case"after":for(;t.aToken[++o]!==l;)o===r&&d.myTrace(`[jumpç³» ç„¡åãƒ©ãƒ™ãƒ«after] ${String(a)} è¡Œç›®ä»¥å¾Œã§ãƒã‚¯ãƒ­å†…ã«ãƒ©ãƒ™ãƒ«ã€${l}ã€‘ãŒã‚ã‚Šã¾ã›ã‚“`,"ET"),t.aToken[o].search(this.#H)>-1&&d.myTrace(`[jumpç³» ç„¡åãƒ©ãƒ™ãƒ«after] ${String(a)} è¡Œç›®ä»¥å¾Œã§ãƒã‚¯ãƒ­å†…ã«ãƒ©ãƒ™ãƒ«ã€ ${l} ã€‘ãŒã‚ã‚Šã¾ã›ã‚“`,"ET");return{idx:o+1,ln:t.aLNum[o]};default:d.myTrace("[jumpç³»] ç„¡åãƒ©ãƒ™ãƒ«æŒ‡å®šã€label="+l+"ã€‘ãŒé–“é•ã£ã¦ã„ã¾ã™","ET")}}a=1;const c=new RegExp("^"+l.replaceAll("*","\\*")+"(?=\\s|;|\\[|\\||$)");let f=!1;for(let o=0;o<r;++o){t.aLNum[o]||=a;const u=t.aToken[o];if(f){this.#l.testTagEndLetml(u)?f=!1:a+=(u.match(/\n/g)??[]).length;continue}const g=u.charCodeAt(0);if(g===10){a+=u.length;continue}if(g===42){if(u.search(c)>-1)return{idx:o+1,ln:a};continue}g===91&&(a+=(u.match(/\n/g)??[]).length,this.#l.testTagLetml(u)&&(f=!0))}throw f?"[let_ml]ã®çµ‚ç«¯ãƒ»[endlet_ml]ãŒã‚ã‚Šã¾ã›ã‚“":(d.myTrace(`[jumpç³»] ãƒ©ãƒ™ãƒ«ã€${l}ã€‘ãŒã‚ã‚Šã¾ã›ã‚“`,"ET"),"Dummy")}#a=Object.create(null);#ft(t){let s="";try{s="ScriptIterator.resolveScript";const i=this.#l.resolveScript(t);s="ScriptIterator.replaceScript_Wildcard",this.#gt(i),this.#a[this.#i]=this.#s=i}catch(i){i instanceof Error?s+=`ä¾‹å¤– mes=${i.message}(${i.name})`:s=String(i),this.main.errScript(s,!1)}this.val.touchAreaKidoku(this.#i)}#z(t){this.#i=t.fn,this.#t=t.idx;const s=this.#a[this.#i];s&&(this.#s=s),this.#e=this.#s.aLNum[t.idx]}#ut=/^\[(call|loadplugin)\s/;#pt=/\bfn\s*=\s*[^\s\]]+/;#gt(t){for(let s=t.len-1;s>=0;--s){const i=t.aToken[s];if(!this.#ut.test(i))continue;const[n,h]=L(i);this.#r.parse(h);const r=this.#r.hPrm.fn;if(!r)continue;const{val:a}=r;if(!a.endsWith("*"))continue;t.aToken.splice(s,1,"	","; "+i),t.aLNum.splice(s,1,NaN,NaN);const l=n==="loadplugin"?T.CSS:T.SN,e=this.cfg.matchPath("^"+a.slice(0,-1)+".*",l);for(const c of e){const f=i.replace(this.#pt,"fn="+decodeURIComponent(w(c[l])));t.aToken.splice(s,0,f),t.aLNum.splice(s,0,NaN)}}t.len=t.aToken.length}#mt(){const t=this.val.touchAreaKidoku(this.#i);if(this.#n.length>0){t.record(this.#t);return}this.#m=t.search(this.#t),this.val.setVal_Nochk("tmp","const.sn.isKidoku",this.#m),!this.#m&&t.record(this.#t)}#m=!1;get isKidoku(){return this.#m}#K(){this.val.getAreaKidoku(this.#i)?.erase(this.#t),this.#m=!1}get isNextKidoku(){let t=this.#i,s=this.#t,i=this.#s.len;if(this.#n.length>0){const n=this.#n[0];t=n.fn,s=n.idx;const h=this.#a[t];h&&(i=h.len)}return s===i?!1:this.val.getAreaKidoku(t)?.search(s)??!1}get normalWait(){return this.#m?this.val.tagCh_doWait_Kidoku?this.val.tagCh_msecWait_Kidoku:0:this.val.tagCh_doWait?this.val.tagCh_msecWait:0}#dt(t){return this.#l.bracket2macro(t,this.hTag,this.#s,this.#t),!1}#kt(t){return this.#l.char2macro(t,this.hTag,this.#s,this.#t),!1}#bt=/["'#;\\]ã€€]+/;#vt(t){const{name:s}=t;if(!s)throw"nameã¯å¿…é ˆã§ã™";if(s in this.hTag)throw`[${s}]ã¯ã‚¿ã‚°ã‹ã™ã§ã«å®šç¾©æ¸ˆã¿ã®ãƒã‚¯ãƒ­ã§ã™`;if(this.#bt.test(s))throw`[${s}]ã¯ãƒã‚¯ãƒ­åã¨ã—ã¦ç•°å¸¸ã§ã™`;const i=this.#e,n=new x(this.#i,this.#t);for(this.#R+="|"+s,this.#N=new RegExp(`\\[(${this.#R})\\b`),this.hTag[s]=h=>(h.design_unit=t.design_unit,this.#B(h),this.val.setMp({...h,"const.sn.macro":JSON.stringify({name:t.name}),"const.sn.me_call_scriptFn":this.#i}),this.val.setVal_Nochk("mp","const.sn.me_call_scriptFn",this.#i),this.#e=i,this.#z(n),!1);this.#t<this.#s.len;++this.#t){this.#s.aLNum[this.#t]||=this.#e;const h=this.#s.aToken[this.#t];if(h.search(this.#H)>-1)return++this.#t,!1;const r=h.charCodeAt(0);r===10?this.#e+=h.length:r===91&&(this.#e+=(h.match(/\n/g)??[]).length)}throw`ãƒã‚¯ãƒ­[${s}]å®šç¾©ã®çµ‚ç«¯ãƒ»[endmacro]ãŒã‚ã‚Šã¾ã›ã‚“`}#R="call";#N=/\[(call)\b/;#St(t){if("fn"in t!="label"in t)throw"fnã¨labelã¯ã‚»ãƒƒãƒˆã§æŒ‡å®šã—ã¦ä¸‹ã•ã„";const s=O(t,"place",0),i=this.val.getMark(s);if(!i)throw`place=${String(s)} ã¯å­˜åœ¨ã—ã¾ã›ã‚“`;return this.loadFromMark(t,i,2)}loadFromMark(t,s,i=0){this.hTag.clear_event({}),this.val.mark2save(s),this.val.setMp($()),this.#g.recPagebreak();let n=[];i!==1&&(n=this.sndMng.playLoopFromSaveObj(i===2)),m(t,"do_rec",!0)&&(this.#u={hSave:this.val.cloneSave(),hPages:{...s.hPages},aIfStk:[...s.aIfStk]});const h={enabled:!!this.val.getVal("save:const.sn.autowc.enabled"),text:String(this.val.getVal("save:const.sn.autowc.text")),time:Number(this.val.getVal("save:const.sn.autowc.time"))};this.hTag.autowc(h),this.#o=[...this.#u.aIfStk],this.#n=[],y.stopAllTw();const r=Promise.allSettled([...n,...this.#g.playback(this.#u.hPages)]).then(()=>this.#g.cover(!1)),{index:a,fn:l}=t;if(a)return S.debugLog&&console.log(`ğŸ“œ %cloadFromMark index:${String(a)} move!%c fn:${l??""}`,"color:#3B0;",""),r.then(()=>{this.#f(l,"",a)||this.main.resume()}).catch(o=>console.error("loadFromMark e:%o",o)),!0;this.#g.cover(!0);const e=String(this.val.getVal("save:const.sn.scriptFn")),c=Number(this.val.getVal("save:const.sn.scriptIdx"));delete this.#a[e];const{label:f}=t;return r.then(f?()=>{this.#i=e,this.#t=c,this.hTag.call({fn:l,label:f})||this.main.resume()}:()=>{this.#f(e,"",c)||this.main.resume()}).catch(o=>console.error("loadFromMark e:%o",o)),!0}#Tt(t){const s=this.val.getMark(0);if(!s)return!1;delete this.#a[w(s.hSave["const.sn.scriptFn"])];const i={};for(const n in this.#a)try{this.#k(n+"@")}catch{i[n]=this.#a[n]}return this.#a=i,t.do_rec=!1,this.loadFromMark(t,s,1)}#u={hSave:C(),hPages:{},aIfStk:[-1]};#q=()=>{const{fn:t,idx:s}=this.nowScrIdx();return this.val.setVal_Nochk("save","const.sn.scriptFn",t),this.val.setVal_Nochk("save","const.sn.scriptIdx",s),this.#u={hSave:this.val.cloneSave(),hPages:this.#g.record(),aIfStk:this.#o.slice(this.#n.length)},!1};nowScrIdx(){if(this.#n.length===0)return{fn:this.#i,idx:this.#t};const t=this.#n[0];return{fn:t.fn,idx:t.idx}}nowMark(){return{...this.#u}}nowScrFnLn(){const{fn:t,idx:s}=this.nowScrIdx(),i=this.#a[t],n=this.#c(i,s);return{fn:t,...n}}#wt(t){if(!("place"in t))throw"placeã¯å¿…é ˆã§ã™";const s=Number(t.place);delete t[":ã‚¿ã‚°å"],delete t.place,t.text=t.text??"",this.#u.json=t,this.val.setMark(s,this.#u);const i=Number(this.val.getVal("sys:const.sn.save.place"));return s===i&&this.val.setVal_Nochk("sys","const.sn.save.place",i+1),!1}recodeDesign(t){let s="",i=0;const n=this.#n.length;if(t.design_unit&&n>0){const l=this.#n[0];s=l.fn,i=l.idx}else s=this.#i,i=this.#t;t[":path"]=this.#b(s);const h=this.#a[s],r=this.#c(h,i);t[":ln"]=r.ln,t[":col_s"]=r.col_s,t[":col_e"]=r.col_e;const a=i-1;t[":idx_tkn"]=a,t[":token"]=h.aToken[a],this.sys.send2Dbg("_recodeDesign",t)}replace(t,s){this.#s.aToken[t]=s}}export{p as ScriptIterator};
