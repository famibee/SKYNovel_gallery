import{h as M,d as x,u as V,e as N,T as Et,n as ct,o as Nt,L as D,G as W,R as U,p as z,q as At,f as ht,m as K,C as E,D as it,r as _t,s as B,t as dt,v as G,B as Ft,w as j,i as mt,x as Rt,A as vt,y as Pt,j as kt,z as Ot,P as Lt,F as bt,H as Vt,I as tt,J as Bt}from"./web.js";import{v as P,Q as xt,$ as Z}from"./SndBuf.js";import{a as R,D as jt}from"./Reading.js";import{a as pt,R as wt}from"./ScriptIterator.js";import"../web.js";import"./CallStack.js";class et{constructor(t,e,s,i,a,n,h,r){this.cls=e,this.hArg=a,this.sys=n,this.val=h,this.ret=r;const c=n.hFactoryCls[e];if(!c)throw`属性 class【${e}】が不正です`;const p=c(),o=c();p.layname=o.layname=t;const u=a[":id_tag"]=`layer:${t} cls:${e} page:`;p.ctn.name=p.name=u+"A",o.ctn.name=o.name=u+"B",s.addChild(p.ctn),i.addChild(o.ctn),N(a,"visible",!0),N(a,"visible",!0),r.isWait=p.lay(a)||o.lay(a),this.#s={fore:p,back:o},i.visible=!1;const d=`const.sn.lay.${t}`;h.setVal_Nochk("tmp",d,!0),h.defTmp(d+".fore.alpha",()=>this.#s.fore.alpha),h.defTmp(d+".back.alpha",()=>this.#s.back.alpha),h.defTmp(d+".fore.height",()=>this.#s.fore.height),h.defTmp(d+".back.height",()=>this.#s.back.height),h.defTmp(d+".fore.visible",()=>this.#s.fore.ctn.visible),h.defTmp(d+".back.visible",()=>this.#s.back.ctn.visible),h.defTmp(d+".fore.width",()=>this.#s.fore.width),h.defTmp(d+".back.width",()=>this.#s.back.width),h.defTmp(d+".fore.x",()=>this.#s.fore.x),h.defTmp(d+".back.x",()=>this.#s.back.x),h.defTmp(d+".fore.y",()=>this.#s.fore.y),h.defTmp(d+".back.y",()=>this.#s.back.y)}#s;destroy(){this.#s.fore.destroy(),this.#s.back.destroy()}lay=t=>this.getPage(t).lay(t);getPage=t=>et.argChk_page(t,"fore")!=="back"?this.#s.fore:this.#s.back;static argChk_page(t,e){const s=t.page??e;if(s==="fore"||s==="back")return t.page=s,s;throw Error("属性 page【"+s+"】が不正です")}get fore(){return this.#s.fore}get back(){return this.#s.back}transPage(t){[this.#s.back,this.#s.fore]=[this.#s.fore,this.#s.back],this.#s.back.copy(this.#s.fore,t)}}class ut{constructor(t,e=!1){this.bg_col=t,this.isLay=e}static init(t,e,s,i,a,n){}static cvsResizeDesign(){}destroy(){}gethArg(){return this.hArg}hArg={};sethArg(t){this.hArg=t}setOther(t){}adopt(t){}static enterMode(){}static allHide(){}set visible(t){}static leaveMode(){}cvsResize(){}make(){}static replaceToken(t){}}class Dt extends ut{constructor(t,e){super("#29e",!0)}setSp(t){}}class y{constructor(t="",e,s=()=>{},i=()=>{}){this.csvFn=t,this.ctn=e,this.fncFirstComp=s,this.fncAllComp=i,t&&(this.#u=e?a=>{e.addChild(a),this.#c.push(a)}:()=>{},this.ret=y.#x(t,a=>this.fncFirstComp(a),a=>this.fncAllComp(a),a=>this.#u(a)))}static#s;static#e;static#a;static#r;static init(t,e,s,i,a){y.#s=t,y.#e=e,y.#a=s,y.#r=i,s.arg.crypto&&(y.#f=(h,r,c)=>y.#n(h,r,c),y.#h=(h,r,c)=>y.#L(h,r,c));const n=()=>{const h=y.#o*y.#t;for(const r of Object.values(y.#w))r.volume=h};a.setNoticeChgVolume(h=>{y.#o=h,n()},h=>{y.#t=h,n()})}static#t=1;static#o=1;static#p;static setEvtMng(t){y.#p=t}ret=!1;#u;#c=[];destroy(){this.fncFirstComp=()=>{},this.fncAllComp=()=>{},this.#u=t=>t.destroy();for(const t of this.#c)y.stopVideo(t.name),t.parent?.removeChild(t),t.destroy();this.#c=[]}static destroy(){y.#i={},y.#d={},y.#w={}}static#x(t,e,s,i){if(!t)return!1;let a=!1;if(t.startsWith("data:")){const o=()=>{const u=B.from(t);i(u),e(u),s(a)};return t in dt?o():(a=!0,new G().add(t,t).load(o)),a}const n=[],h=new G,r=t.split(","),c=r.length;for(let o=0;o<c;++o){const u=r[o];if(!u)throw"face属性に空要素が含まれます";const{dx:d,dy:l,blendmode:g,fn:b}=y.#i[u]??{fn:u,dx:0,dy:0,blendmode:Ft.NORMAL},_=o===0?e:v=>{v.transform&&(v.x=d,v.y=l,v.blendMode=g)};if(n.push({fn:b,fnc:_}),b in y.#d||b in dt||b in G.shared.resources)continue;a=!0;const m=y.#s.searchPath(b,K.SP_GSM),f=this.#a.arg.crypto?{xhrType:m.endsWith(".json")?j.XHR_RESPONSE_TYPE.TEXT:j.XHR_RESPONSE_TYPE.BUFFER}:{};h.add({...f,name:b,url:m})}const p=(o,u)=>{for(const{fn:d,fnc:l}of n){const g=y.#v(d,u);g.name=d,i(g),l(g)}s(a)};return a?h.use((o,u)=>{try{if(o.extension==="json"){this.#a.dec("json",o.data).then(d=>y.#h(d,o,u));return}this.#a.decAB(o.data).then(d=>y.#f(d,o,u))}catch(d){const l=`画像/動画ロード失敗です fn:${o.name} ${String(d)}`;y.#p.isSkipping?console.warn(l):console.error("%c"+l,"color:#FF3300;")}}).load(p):queueMicrotask(()=>p(0,{})),a}static#i={};static#d={};static#f=(t,{type:e,name:s,data:i},a)=>{switch(e){case j.TYPE.VIDEO:{const n=i;n.volume=y.#o,y.#w[s]=y.#_(n)}}a()};static#g(t){const e=/([^\d]+)\d+\.(\w+)/.exec(t[0]??"");if(!e)return[];const[,s="",i=""]=e,a=s.length,n=-i.length-1;return t.sort((h,r)=>mt(h.slice(a,n))>mt(r.slice(a,n))?1:-1)}static#n(t,e,s){if(e.data=t,e.extension!=="bin"&&s(),t instanceof HTMLImageElement){z.fromLoader(t,e.url,e.name).then(i=>{e.texture=i,e.type=j.TYPE.IMAGE});return}t instanceof HTMLVideoElement&&(t.volume=y.#o,y.#w[e.name]=y.#_(t),e.type=j.TYPE.VIDEO),s()}static#_(t){return y.#e.getVal("const.sn.needClick2Play")&&(it.trace_beforeNew(`[lay系] ${it.strPos()}未クリック状態で動画を自動再生します。音声はミュートされます`,"W"),t.muted=!0),t.setAttribute("playsinline",""),t}static#h=(t,{type:e,spritesheet:s,name:i,data:a},n)=>{switch(e){case j.TYPE.JSON:{const h=s._frameKeys;y.#g(h),y.#d[i]={aTex:h.map(r=>z.from(r)),meta:a.meta}}}n()};static#L(t,e,s){const{meta:i,frames:a}=e.data=JSON.parse(t);if(e.type=j.TYPE.JSON,!i?.image){s();return}const n=Rt(i.image),h=y.#s.searchPath(n,K.SP_GSM);new G().use((r,c)=>{this.#a.decAB(r.data).then(p=>{r.data=p,p instanceof HTMLImageElement&&(r.type=j.TYPE.IMAGE,URL.revokeObjectURL(p.src)),c()}).catch(p=>this.#r.errScript(`画像/動画ロード失敗です dec2res4Cripto fn:${r.name} ${String(p)}`,!1))}).add({name:n,url:h,xhrType:j.XHR_RESPONSE_TYPE.BUFFER}).load((r,c)=>{for(const{data:p}of Object.values(r.resources)){const{baseTexture:o}=z.from(p),u=Object.values(a);y.#d[e.name]={aTex:u.map(({frame:{x:d,y:l,w:g,h:b}})=>new z(o,new U(d,l,g,b))),meta:i}}s()})}static#v(t,e){const s=y.#d[t];if(s){const n=new vt(s.aTex);return n.animationSpeed=s.meta.animationSpeed??1,n.play(),n}if(t in dt)return B.from(t);const i=y.#w[t];if(i)return B.from(i);const a=e[t];return a?new B(a.texture):new B}static#w={};static getHFn2VElm(t){return y.#w[t]}static wv(t){const{fn:e}=t;if(!e)throw"fnは必須です";const s=y.#w[e];if(!s||s.loop)return!1;if(y.#p.isSkipping||s.ended)return y.stopVideo(e),!1;const i="wv fn:"+e,a=N(t,"stop",!0),n=()=>{a&&y.stopVideo(e)};return R.beginProc(i,n,!0,n),s.addEventListener("ended",()=>R.notifyEndProc(i),{once:!0,passive:!0}),!0}static stopVideo(t){const e=y.#w[t];e&&(delete y.#w[t],e.pause(),e.currentTime=e.duration)}static add_face(t){const{name:e}=t;if(!e)throw"nameは必須です";if(e in y.#i)throw"一つのname（"+e+"）に対して同じ画像を複数割り当てられません";const{fn:s=e}=t;return y.#i[e]={fn:s,dx:x(t,"dx",0),dy:x(t,"dy",0),blendmode:D.getBlendmodeNum(t.blendmode??"")},!1}}class H extends D{static#s=new kt;static#e;static init(t,e,s,i,a,n){H.#e=s,y.init(e,n,i,t,a)}static destroy(){H.#s.clear(),y.destroy()}#a=new Dt(this.ctn,this);constructor(){super(),E.isDbg&&(this.#r=t=>this.#a.setSp(t),this.cvsResize=()=>{super.cvsResize(),this.#a.cvsResize()})}#r=()=>{};#t="";#o="";#p="";lay=t=>{const e=R.procID+`GrpLayer lay name:${this.name_}`,s=this.#u(t,i=>{i&&R.endProc(e)});return s&&R.beginProc(e),s};#u(t,e){const{fn:s,face:i=""}=t;if(this.#a.sethArg(t),!s)return super.lay(t),this.ctn.children.length>0&&this.setPos(t),this.#o="",this.#t=this.#p=i,e(!1),!1;const a="fn"in t,n="face"in t;return this.clearLay({clear_filter:N(t,"clear_filter",!0)}),a&&(this.#o=s),n&&(this.#p=i),super.lay(t),t.dx=0,t.dy=0,this.#c.destroy(),this.#c=new y(this.#t=s+(i?","+i:""),this.ctn,h=>{("width"in t||"height"in t)&&(h.width=x(t,"width",0),h.height=x(t,"height",0)),this.#x=h.width,this.#i=h.height,D.setXY(h,t,this.ctn,!0),D.setBlendmode(this.ctn,t),this.#r(h)},h=>e(h)),this.#c.ret}#c=new y;#x=0;#i=0;get width(){return this.#x}get height(){return this.#i}renderStart(){this.#f=new B(this.#d),this.#f.visible=!1,this.ctn.addChildAt(this.#f,0),this.#f.position.set(-this.ctn.x,-this.ctn.y);let t=()=>{const e=this.ctn.alpha;this.ctn.alpha=1;for(const s of this.ctn.children)s.visible=!0;this.#f.visible=!1,H.#e.renderer.render(this.ctn,{renderTexture:this.#d}),this.ctn.alpha=e;for(const s of this.ctn.children)s.visible=!1};if(!this.containMovement){const e=t;t=()=>{t=()=>{},e()}}this.#g=()=>{t(),this.#f.visible=!0},H.#e.ticker.add(this.#g)}#d=tt.create({width:E.stageW,height:E.stageH});#f=new B;#g=()=>{};renderEnd(){H.#e.ticker.remove(this.#g),this.ctn.removeChild(this.#f);for(const t of this.ctn.children)t.visible=!0;this.#f.destroy(!0),this.#d=tt.create({width:E.stageW,height:E.stageH})}setPos(t){D.setXY(this.ctn.children[0]??this.ctn,t,this.ctn,!0)}get containMovement(){if(this.#t==="")return!1;const t=this.ctn.children;return this.#t.split(",").some((e,s)=>t[s]instanceof vt||y.getHFn2VElm(e))}clearLay(t){super.clearLay(t),this.#c.destroy(),this.#o="",this.#p="",this.#t=""}record=()=>({...super.record(),sBkFn:this.#o,sBkFace:this.#p});playback(t,e){if(super.playback(t,e),t.sBkFn===""&&t.sBkFace===""){this.#o="",this.#p="";return}e.push(new Promise(s=>this.#u({fn:t.sBkFn,face:t.sBkFace,left:t.x,top:t.y,alpha:t.alpha,blendmode:D.getNum2Blendmode(t.blendMode),rotation:t.rotation,scale_x:t.scale_x,scale_y:t.scale_y},i=>{this.ctn.position.set(t.x,t.y),s()})))}makeDesignCast(t){this.ctn.visible&&t(this.#a)}cvsResize(){super.cvsResize()}showDesignCast(){this.#a.visible=!0}dump=()=>super.dump()+`, "pic":"${this.#t}"`}const st="、。，．）］｝〉」』】〕”〟ぁぃぅぇぉっゃゅょゎァィゥェォッャュョヮヵヶ！？!?‼⁉・ーゝゞヽヾ々",rt="［（｛〈「『【〔“〝",lt="─‥…",ft=st,$t=new RegExp(`[${st}]`),Mt=new RegExp(`[${rt}]`),It=new RegExp(`[${lt}]`),Ht=$t;class Wt{#s=st;#e=rt;#a=lt;#r=ft;get 行頭禁則(){return this.#s}get 行末禁則(){return this.#e}get 分割禁止(){return this.#a}get ぶら下げ(){return this.#r}#t=$t;#o=Mt;#p=It;#u=Ht;break_fixed=!1;break_fixed_left=0;break_fixed_top=0;bura=!1;lay(t){t.kinsoku_sol&&(this.#s=t.kinsoku_sol,this.#t=new RegExp(`[${this.#s}]`)),t.kinsoku_eol&&(this.#e=t.kinsoku_eol,this.#c(),this.#o=new RegExp(`[${this.#e}]`)),t.kinsoku_dns&&(this.#a=t.kinsoku_dns,this.#x(),this.#p=new RegExp(`[${this.#a}]`)),t.kinsoku_bura&&(this.#r=t.kinsoku_bura,this.#c(),this.#x(),this.#u=new RegExp(`[${this.#r}]`)),"bura"in t&&(this.bura=N(t,"bura",!1)),this.break_fixed=N(t,"break_fixed",this.break_fixed),this.break_fixed_left=x(t,"break_fixed_left",this.break_fixed_left),this.break_fixed_top=x(t,"break_fixed_top",this.break_fixed_top)}#c(){const t=this.#e.length,e=this.#r.length;if(t<e)for(let s=0;s<t;++s){const i=this.#e[s];if(this.#r.includes(i))throw`禁則の競合があります。文字 ${i} がぶら下げ と 行末禁則 の両方に含まれます`}else for(let s=0;s<e;++s){const i=this.#r[s];if(this.#e.includes(i))throw`禁則の競合があります。文字 ${i} がぶら下げ と 行末禁則 の両方に含まれます`}}#x(){const t=this.#a.length,e=this.#r.length;if(t<e)for(let s=0;s<t;++s){const i=this.#a[s];if(this.#r.includes(i))throw`禁則の競合があります。文字 ${i} がぶら下げ と 分割禁止 の両方に含まれます`}else for(let s=0;s<e;++s){const i=this.#r[s];if(this.#a.includes(i))throw`禁則の競合があります。文字 ${i} がぶら下げ と 分割禁止 の両方に含まれます`}}reNew(t){t.#i(this.#s,this.#e,this.#a,this.#r),t.break_fixed=this.break_fixed,t.break_fixed_left=this.break_fixed_left,t.break_fixed_top=this.break_fixed_top,t.bura=this.bura}#i(t,e,s,i){this.#s!==t&&(this.#s=t,this.#t=new RegExp(`[${t}]`)),this.#e!==e&&(this.#e=e,this.#o=new RegExp(`[${e}]`)),this.#a!==s&&(this.#a=s,this.#p=new RegExp(`[${s}]`)),this.#r!==i&&(this.#r=i,this.#u=new RegExp(`[${i}]`))}record(){const t={break_fixed:this.break_fixed,break_fixed_left:this.break_fixed_left,break_fixed_top:this.break_fixed_top,bura:this.bura};return this.#s===st&&(t.行頭禁則=this.#s),this.#e===rt&&(t.行末禁則=this.#e),this.#a===lt&&(t.分割禁止=this.#a),this.#r===ft&&(t.ぶら下げ=this.#r),t}playback(t){t&&(this.#i(t.行頭禁則??st,t.行末禁則??rt,t.分割禁止??lt,t.ぶら下げ??ft),this.break_fixed=t.break_fixed,this.break_fixed_left=t.break_fixed_left,this.break_fixed_top=t.break_fixed_top,this.bura=t.bura)}hyph(t,e,s,i,a){let n,h=0,r=2,c=p=>(c=()=>!1,i===p?(i>0&&(t.innerHTML=a.replaceAll('class="sn_ch"','class="sn_ch sn_ch_in_default"')),!0):p<2);do{if(n=this.#f(t,e),h=n.length,c(h))break;let p=-1/0;for(;r<h;++r){const{elm:o,rect:u,ch:d}=n[r];if(o.tagName==="RT")continue;const l=s?u.y:u.x;if(p<=l||o.previousElementSibling?.tagName==="SPAN"&&o.previousElementSibling?.innerHTML.includes("<br>")||o.parentElement?.previousElementSibling?.tagName==="SPAN"&&o.parentElement?.previousElementSibling?.innerHTML.includes("<br>")){p=l,this.break_fixed||(this.break_fixed_left=u.x,this.break_fixed_top=u.y);continue}const g=this.#d(n,r),{elm:b,rect:_,ch:m}=n[g];if(!this.break_fixed){this.break_fixed_left=_.x,this.break_fixed_top=_.y;const F=globalThis.getComputedStyle(b),O=parseFloat(F.fontSize);s?this.break_fixed_top+=O:this.break_fixed_left+=O}p=-1/0;const f=r,{cont:v,ins:S}=this.bura?this.hyph_alg_bura(n,g,m,r):this.hyph_alg(n,g,m,r,d);if(r=S,v)continue;const C=n[r].elm,$=C.parentElement,k=document.createElement("br");if($.classList.contains("sn_tx"))$.insertBefore(k,C);else{const F=$.parentElement;F.classList.contains("sn_ch")?F.parentElement.insertBefore(k,F):F.insertBefore(k,$)}r+=2,r<f&&(r=f),h=-1;break}}while(h<0);return[n,h]}#d(t,e){const s=e-1,{elm:i}=t[s];return i.tagName!=="RT"?s-(i.style.textCombineUpright==="all"?Array.from(i.textContent).length-1:0):s-Array.from(i.textContent).length}#f(t,e){const s=[];if(t.nodeType!==t.TEXT_NODE)return Array.from(t.childNodes).map(h=>this.#f(h,e)).flat();const i=t.ownerDocument.createRange();i.selectNodeContents(t);let a=0;const n=i.endOffset;for(;a<n;){i.setStart(t,a),i.setEnd(t,++a);const h=i.toString();s.push({ch:h,rect:e(i,h),elm:i.startContainer.parentElement})}return i.detach(),s}hyph_alg(t,e,s,i,a){let n=i;if(!this.#o.test(s)){if(this.#t.test(a))for(;(n=this.#d(t,n))>=0&&this.#t.test(t[n].ch););else if(!(s===a&&this.#p.test(s)))return{cont:!0,ins:n+1}}for(n=e;(n=this.#d(t,n))>=0&&this.#o.test(t[n].ch););return{cont:!1,ins:n+1}}hyph_alg_bura(t,e,s,i){const a=this.#d(t,e),{ch:n}=t[a];if(this.#u.test(n)||this.#t.test(n)){let r=e;(this.#u.test(s)||this.#t.test(s))&&++r;const c=this.#d(t,r),{ch:p}=t[c],{ch:o}=t[r];if(p===o&&this.#p.test(o))return{cont:!1,ins:c};if(!this.#o.test(p))return{cont:!1,ins:r};r=c;do if(!this.#o.test(t[r].ch))break;while((r=this.#d(t,r))>=0);return{cont:!1,ins:r+1}}const h=this.#d(t,a);if(i>=3){const{ch:r}=t[h];if(this.#p.test(n)&&r===n)return{cont:!1,ins:h};if(this.#o.test(r)){let c=h;for(;(c=this.#d(t,c))>=0&&this.#o.test(t[c].ch););return{cont:!1,ins:c+1}}}return{cont:!1,ins:a}}}function zt(q,t,e,s,i,a=!0){const n={escape:m=>m.replaceAll(/([.*+?^${}()|[\]/\\])/g,"\\$1"),mimeType:m=>{const f=o(m).toLowerCase();return h()[f]||""},dataAsUrl:g,isDataUrl:u,resolveUrl:d,getAndEncode:l,asArray:m=>{const f=[],v=m.length;for(let S=0;S<v;++S)f.push(m[S]);return f}};function h(){const m="application/font-woff",f="image/jpeg";return{woff:m,woff2:m,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:f,jpeg:f,gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"}}const r=b(),c=_();function p(m){return c.resolveAll().then(f=>{const v=document.createElement("style");return m.appendChild(v),v.appendChild(document.createTextNode(f)),m})}function o(m){return/\.([^./]*?)$/g.exec(m)?.[1]??""}function u(m){return m.search(/^(data:)/)!==-1}function d(m,f){const v=document.implementation.createHTMLDocument(),S=v.createElement("base");v.head.appendChild(S);const C=v.createElement("a");return v.body.appendChild(C),S.href=f,C.href=m,C.href}function l(m){return new Promise(function(f){const v=new XMLHttpRequest;v.onreadystatechange=S,v.ontimeout=C,v.responseType="blob",v.timeout=3e4,v.open("GET",m,!0),v.send();function S(){if(v.readyState!==4)return;if(v.status!==200){$("cannot fetch resource: "+m+", status: "+v.status);return}const k=new FileReader;k.onloadend=function(){const F=k.result.toString().split(/,/)[1];f(F)},k.readAsDataURL(v.response)}function C(){$("timeout of 30000ms occured while fetching resource: "+m)}function $(k){console.error(k),f("")}})}function g(m,f){return"data:"+f+";base64,"+m}function b(){const m=/url\(['"]?([^'"]+?)['"]?\)/g;return{inlineAll:C,shouldProcess:f};function f($){return $.search(m)!==-1}function v($){const k=[];let F;for(;F=m.exec($);)k.push(F[1]);return k.filter(function(O){return!n.isDataUrl(O)})}function S($,k,F,O){return Promise.resolve(k).then(L=>F?n.resolveUrl(L,F):L).then(O||n.getAndEncode).then(L=>n.dataAsUrl(L,n.mimeType(k))).then(L=>$.replace(Q(k),"$1"+L+"$3"));function Q(L){return new RegExp(`(url\\(['"]?)(`+n.escape(L)+`)(['"]?\\))`,"g")}}function C($,k,F){if(O())return Promise.resolve($);return Promise.resolve($).then(v).then(Q=>{let L=Promise.resolve($);for(const Y of Q)L=L.then(ot=>S(ot,Y,k,F));return L});function O(){return!f($)}}}function _(){return{resolveAll:m,impl:{readAll:f}};function m(){return f().then(v=>Promise.allSettled(v.map(S=>S.resolve()))).then(v=>v.join(`
`))}function f(){return Promise.resolve(n.asArray(document.styleSheets)).then(S).then(v).then($=>$.map(C));function v($){return $.filter(k=>k.type===CSSRule.FONT_FACE_RULE).filter(k=>r.shouldProcess(k.style.getPropertyValue("src")))}function S($){const k=[];for(const F of $)try{if(F.href)continue;n.asArray(F.cssRules||[]).forEach(k.push.bind(k))}catch(O){console.error("Error while reading CSS rules from "+F.href,String(O))}return k}function C($){return{resolve:function(){const k=($.parentStyleSheet||{}).href;return r.inlineAll($.cssText,k)},src(){return $.style.getPropertyValue("src")}}}}}Promise.resolve(t).then(m=>{const f=m.cloneNode(!0);return f.style.padding="0px",f.style.paddingRight=s+"px",f.style.paddingTop=i+"px",f.style.left="0px",f.style.top="0px",f.style.width=e.$width-e.pad_left-e.pad_right+"px",f.style.height=e.$height-e.pad_top-e.pad_bottom+"px",t.hidden=a,f}).then(p).then(m=>{m.setAttribute("xmlns","http://www.w3.org/1999/xhtml");const f=new Image;return f.src=`data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="${e.$width}px" height="${e.$height}px"><foreignObject x="0" y="0" width="100%" height="100%">${new XMLSerializer().serializeToString(m).replaceAll("#","%23").replaceAll(`
`,"%0A")}</foreignObject></svg>`,new Promise(v=>{f.onload=()=>v(f)})}).then(m=>new Promise(f=>setTimeout(()=>f(m),100))).then(m=>{const f=document.createElement("canvas");f.width=e.$width,f.height=e.$height,f.getContext("2d").drawImage(m,0,0),q(z.from(f))}).catch(m=>it.myTrace(`goTxt() = ${m}`))}class w extends M{constructor(t,e,s){super(),this.ctn=t,this.canFocus=e,this.sys=s,this.#t.classList.add("sn_tx"),this.#t.style.position="absolute",w.#e.view.parentElement.appendChild(this.#t),this.addChild(this.#o),this.addChild(this.#p),this.#p.name="grpDbgMasume";const i=E.debugLog?({ch:a,rect:{x:n,y:h,width:r,height:c}})=>console.log(`🍌 masume ch:${a} x:${n} y:${h} w:${r} h:${c}`):()=>{};this.#x=w.#s.oCfg.debug.masume?a=>{i(a);const{x:n,y:h,width:r,height:c}=a.rect;this.#p.beginFill(6737151,.5).lineStyle(2,16724736,1).drawRect(n,h,r,c).endFill()}:()=>{},this.noticeCompTxt=s.isApp&&w.#s.oCfg.debug.dumpHtm?()=>{R.notifyEndProc(wt);const a=this.#t.innerHTML;if(a==="")return;const{fn:n,ln:h}=w.#r.nowScrFnLn(),r=`dumpHtm ${t.name.slice(0,-7).replaceAll(":","=")}(fn=${n} line=${String(h)})`;s.outputFile(s.path_downloads+r+".htm",`<!doctype html><html><head><meta charset=utf-8><title>${r}</title>
<h1>${r}</h1>${a.replaceAll(/ class="sn_ch"|animation-delay: \d+ms; ?| data-add="{&quot;ch_in_style&quot;:&quot;default&quot;, &quot;ch_out_style&quot;:&quot;default&quot;}"/g,"").replaceAll(' style=""',"").replaceAll(/(<\/?ruby>)/g,`
$1
`).replaceAll(/<(br|\/span)>/g,`<$1>
`)}`)}:()=>R.notifyEndProc(wt)}static#s;static#e;static init(t,e){w.#s=t,w.#e=e}static#a;static#r;static setEvtMng(t,e){w.#a=t,w.#r=e}static destroy(){w.#R=Object.create(null),w.#B=Object.create(null),w.delBreak()}#t=document.createElement("span");#o=new M;#p=new W;static#u={"background-color":0,"border-bottom-width":0,"border-left-width":0,"border-right-width":0,"border-top-width":0,"margin-bottom":0,"margin-left":0,"margin-right":0,"margin-top":0};#c=new Wt;noticeCompTxt=()=>{};#x;#i={fontsize:24,$width:0,$height:0,pad_left:0,pad_right:0,pad_top:0,pad_bottom:0};lay(t){const e=this.#t.style;if("style"in t)if(t.style){const s=document.createElement("span");s.style.cssText=t.style;const i=s.style.length;for(let a=0;a<i;++a){const n=s.style[a];if(n in w.#u){it.myTrace(`${String(n)}は指定できません`,"W");continue}e[n]=s.style[n]}!s.style.opacity&&"alpha"in t&&(e.opacity=String(this.ctn.alpha))}else this.#t.style.cssText="";else"alpha"in t&&(e.opacity=String(this.ctn.alpha));if("width"in t&&(e.width=String(t.width??"0")+"px"),"height"in t&&(e.height=String(t.height??"0")+"px"),"pl"in t&&(e.paddingLeft=String(t.pl??"0")+"px"),"pr"in t&&(e.paddingRight=String(t.pr??"0")+"px"),"pt"in t&&(e.paddingTop=String(t.pt??"0")+"px"),"pb"in t&&(e.paddingBottom=String(t.pb??"0")+"px"),this.#c.lay(t),this.#f(),this.#g=this.ctn.position.x,e.transformOrigin=`${this.ctn.pivot.x}px ${this.ctn.pivot.y}px`,this.cvsResize(),e.display=this.ctn.visible?"inline":"none",":redraw"in t&&this.#w>0){const s=[this.#t.innerHTML.replaceAll(/(animation-delay: )\d+ms/g,"$10ms"),`<span class='sn_ch' data-add='{"ch_in_style":"default"}'>&emsp;</span>`];this.#b(),this.goTxt(s,!0)}}#d=0;#f(){const t=this.#t.style,e=parseFloat(t.fontSize||"0");this.#i.fontsize=e,this.#i.pad_left=parseFloat(t.paddingLeft||"0"),this.#i.pad_right=parseFloat(t.paddingRight||"0"),this.#i.pad_top=parseFloat(t.paddingTop||"0"),this.#i.pad_bottom=parseFloat(t.paddingBottom||"0"),this.#i.$width=parseFloat(t.width||"0"),this.#i.$height=parseFloat(t.height||"0"),this.position.set(this.#i.pad_left,this.#i.pad_top),this.#n=t.writingMode==="vertical-rl",this.#_=0,this.#h=0;const s=t.lineHeight??"0";this.#d=this.#n?0:(s.endsWith("px")?parseFloat(s):e*parseFloat(s)-e)/2}cvsResize(){const t=this.#t.style,e=this.sys.cvsScale;t.left=`${this.sys.ofsLeft4elm+this.#g*e}px`,t.top=`${this.sys.ofsTop4elm+this.ctn.position.y*e}px`,t.transform=`rotate(${this.ctn.angle}deg) scale(${this.ctn.scale.x*e}, ${this.ctn.scale.y*e})`}#g=0;#n=!1;get tategaki(){return this.#n}#_=0;#h=0;get infTL(){return this.#i}get getWidth(){return this.#i.$width}get getHeight(){return this.#i.$height}setMySize(t,e){this.#i.$width=t,this.#i.$height=e,this.#t.style.width=String(this.#i.$width)+"px",this.#t.style.height=String(this.#i.$height)+"px"}#L=[];goTxt(t,e){const s=()=>this.#l(t,e);this.#L.push(s)===1&&s()}#v=[];#w=0;static#k="<span class='sn_ch sn_ch_last'>&emsp;</span>";#l(t,e){w.#D.visible=!1;let s=this.#v.length,i="";if(s===0){if(w.#s.oCfg.debug.masume&&(E.debugLog&&console.log(`🍌 masume ${this.name} v:${this.visible} l:${this.x} t:${this.y} a:${this.alpha} pl:${this.#i.pad_left} pr:${this.#i.pad_right} pt:${this.#i.pad_top} pb:${this.#i.pad_bottom} w:${this.#i.$width} h:${this.#i.$height}`),this.#p.clear().beginFill(3407616,.2).lineStyle(1,3407616,1).drawRect(-this.#i.pad_left,-this.#i.pad_top,this.#i.$width,this.#i.$height).endFill().beginFill(13311,.2).lineStyle(2,13311,1).drawRect(0,0,this.#i.$width-this.#i.pad_left-this.#i.pad_right,this.#i.$height-this.#i.pad_top-this.#i.pad_bottom).endFill()),this.#t.innerHTML=[...t].join("").replaceAll(/[\n\t]/g,"")+w.#k,!this.#c.break_fixed){const g=globalThis.getComputedStyle(this.#t),b=parseFloat(g.fontSize);this.#n?(this.#c.break_fixed_left=(this.#i.$width-this.#i.pad_left-this.#i.pad_right-b*1.5)*this.sys.cvsScale,this.#c.break_fixed_top=0):(this.#c.break_fixed_left=0,this.#c.break_fixed_top=b/2*this.sys.cvsScale)}}else i=this.#t.innerHTML,--s,this.#t.getElementsByClassName("sn_ch_last").item(0)?.remove(),this.#t.querySelectorAll(":scope > br").forEach(g=>g.remove()),this.#t.insertAdjacentHTML("beforeend",t.slice(this.#w).join("").replaceAll(/[\n\t]/g,"")+w.#k);this.#t.querySelectorAll(".sn_ch:has(> ruby)").forEach(g=>{g.style.background=""}),this.#w=t.length;const a=this.sys.cvsScale,n=this.#t.getBoundingClientRect(),h=n.left+this.#i.pad_left,r=n.top+this.#i.pad_top;let c;if(a===1)c=(g,b)=>{const _=g.getBoundingClientRect();return new U(_.left-h,_.top-r,_.width,_.height+("gjqy".includes(b)?this.#d:0))};else{const g=this.sys.ofsPadLeft_Dom2PIXI+n.left*(1-a),b=this.sys.ofsPadTop_Dom2PIXI+n.top*(1-a);c=(_,m)=>{const f=_.getBoundingClientRect();return new U((f.left-g)/a-h,(f.top-b)/a-r,f.width/a,(f.height+("gjqy".includes(m)?this.#d:0))/a)}}const[p,o]=this.#c.hyph(this.#t,c,this.#n,s,i);this.#v=p;const u=P.ease(this.#$);for(let g=s;g<o;++g){const b=this.#v[g],{elm:{dataset:_,parentElement:m},rect:f}=b,v=JSON.parse(_.arg??'{"delay": 0}'),S=JSON.parse(_.add??"{}"),C=w.#R[S.ch_in_style];if(this.#x(b),_.cmd==="grp"){const $=new M;this.#o.addChild($),new y(v.pic,$,k=>{this.#S($,v,S,f,u,C??{}),$.parent||$.removeChild(k)})}if(_.lnk){const $=m.closest("[data-arg]"),k=JSON.parse($.dataset.arg??"{}");k.key=`lnk=[${String(g)}] `+this.name;const F=new B;this.#S(F,k,S,f,u,C??{});const O=k.style??"",Q=O+(k.style_hover??""),L=O+(k.style_clicked??""),Y=k.r_style??"",ot=Y+(k.r_style_hover??""),Tt=Y+(k.r_style_clicked??""),gt=Array.from($.getElementsByTagName("rt"));for(const nt of gt)nt.dataset.st_r_bk=nt.style.cssText;const St=$.style.cssText,at=(nt,Ct)=>{$.style.cssText=St+nt;for(const yt of gt)yt.style.cssText=yt.dataset.st_r_bk+Ct};N(k,"enabled",!0)?w.#a.button(k,F,()=>at(O,Y),()=>this.canFocus()?(at(Q,ot),!0):!1,()=>at(L,Tt)):at(O+(k.style_disable??"color: gray;"),Y+(k.r_style_disable??"color: gray;")),this.#o.addChild(F)}}const d=Array.from(this.#t.getElementsByClassName("sn_ch_yet"));this.#m=()=>{this.#m=()=>!1;for(const b of d)b.className="sn_ch";w.#D.position.set(this.#c.break_fixed_left,this.#c.break_fixed_top),w.#D.visible=!0,this.noticeCompTxt();const g=this.#L.shift();return this.#L.length>0&&g(),!0};for(const g of d)g.className=g.className.replace("sn_ch_yet sn","go");s>0&&++s;let l;for(let g=o-2;g>=0;--g){const{elm:b}=this.#v[g];if(b.tagName==="SPAN"){l=b.parentElement?.tagName==="RUBY"?b.parentElement.parentElement??b:b;break}}if(!l||e||s===o){this.#m();return}l.addEventListener("animationend",()=>this.#m(),{once:!0})}#m=()=>!1;#S(t,e,s,i,a,n){t.alpha=0,e.x&&(i.x=e.x.startsWith("=")?i.x+parseInt(e.x.slice(1)):parseInt(e.x)),e.y&&(i.y=e.y.startsWith("=")?i.y+parseInt(e.y.slice(1)):parseInt(e.y)),e.width&&(i.width=parseInt(e.width)),e.height&&(i.height=parseInt(e.height)),e.wait&&(n.wait=e.wait),t.width=i.width,t.height=i.height,n.x?t.position.set(n.x.startsWith("=")?i.x+t.width*n.nx:n.nx,n.y.startsWith("=")?i.y+t.height*n.ny:n.ny):t.position.set(i.x,i.y);const h={sp:t,tw:new jt(t).to({alpha:1,x:i.x,y:i.y,width:i.width,height:i.height,angle:0},n.wait??0).easing(a).delay((s.wait??0)+(e.delay??0)).onComplete(()=>{h.tw=void 0}).start()};this.#V.push(h)}#V=[];skipChIn(){let t=this.#m();for(const e of this.#V)e.tw&&(e.tw.stop().end(),t=!0);return this.#V=[],t}static#R=Object.create(null);static#I=/[{\s.,*{]/;static initChStyle(){w.#R=Object.create(null),w.#B=Object.create(null)}static getChInStyle(t){return w.#R[t]}static ch_in_style(t){const{name:e}=t;if(!e)throw"nameは必須です";if(w.#I.test(e))throw`name【${e}】に使えない文字が含まれます`;if(e in w.#R)throw`name【${e}】はすでにあります`;const s=String(t.x??"=0"),i=String(t.y??"=0");return w.#R[e]={wait:x(t,"wait",500),alpha:x(t,"alpha",0),x:s,y:i,nx:parseFloat(s.at(0)==="="?s.slice(1):s),ny:parseFloat(i.at(0)==="="?i.slice(1):i),scale_x:x(t,"scale_x",1),scale_y:x(t,"scale_y",1),rotate:x(t,"rotate",0),join:N(t,"join",!0),ease:t.ease??"ease-out"}}static#B=Object.create(null);static getChOutStyle(t){return w.#B[t]}static ch_out_style(t){const{name:e}=t;if(!e)throw"nameは必須です";if(w.#I.test(e))throw`name【${e}】に使えない文字が含まれます`;if(e in w.#B)throw`name【${e}】はすでにあります`;const s=String(t.x??"=0"),i=String(t.y??"=0");return w.#B[e]={wait:x(t,"wait",500),alpha:x(t,"alpha",0),x:s,y:i,nx:parseFloat(s.at(0)==="="?s.slice(1):s),ny:parseFloat(i.at(0)==="="?i.slice(1):i),scale_x:x(t,"scale_x",1),scale_y:x(t,"scale_y",1),rotate:x(t,"rotate",0),join:N(t,"join",!1),ease:t.ease??"ease-out"}}static#D=new M;static#P=new y;dispBreak(t){w.delBreak();const e=w.#D;e.visible=!1,this.addChild(e),w.#P.destroy(),w.#P=new y(t.pic,e,s=>{e.parent?(s.x=x(t,"x",0),s.y=x(t,"y",0),s.width=x(t,"width",this.#i.fontsize),s.height=x(t,"height",this.#i.fontsize)):e.removeChild(s)})}static delBreak(){const t=w.#D;t.parent?.removeChild(t),w.#P.destroy()}#$="Quadratic.Out";#C="Quadratic.Out";#b(){this.#p.clear(),this.#v=[],this.#w=0,this.#L=[],this.skipChIn();const t=this.#t.cloneNode(!0);t.textContent="";const e=this.#t,s=Array.from(e.getElementsByClassName("sn_ch"));e.parentElement.insertBefore(t,e);let i=0;s.forEach(n=>{const h=JSON.parse(n.dataset.add??n.children[0]?.getAttribute("data-add")??n.children[0]?.children[0]?.getAttribute("data-add")??"{}");if(!h.ch_out_style)return;const r=w.#B[h.ch_out_style];if(r){if(r.wait===0){n.style.display="none";return}i+=r.wait,r.join||(n.style.animationDelay="0ms"),n.classList.add(`go_ch_out_${String(h.ch_out_style)}`)}});const a=()=>{e.parentElement.removeChild(e);for(const n of this.#o.removeChildren())n instanceof M&&w.#a.unButton(n),n.destroy()};i===0?(this.#t.textContent="",a()):e.lastElementChild?.addEventListener("animationend",a,{once:!0}),this.#t=t}reNew(){this.#b();const t=new w(this.ctn,()=>this.canFocus(),this.sys);return t.#i=this.#i,t.#t.style.cssText=this.#t.style.cssText,t.#g=this.#g,t.name=this.name,t.#f(),t.#M=this.#M,t.#$=this.#$,t.#C=this.#C,this.#c.reNew(t.#c),this.destroy(),t}#M=void 0;record(){return{infTL:this.#i,cssText:this.#t.style.cssText,left:this.#g,ch_filter:this.#M,fi_easing:this.#$,fo_easing:this.#C,hyph:this.#c.record()}}playback(t){this.#i=t.infTL,this.position.set(this.#i.pad_left,this.#i.pad_top),this.#t.style.cssText=t.cssText,this.#g=t.left,this.#f(),this.#M=t.ch_filter,this.#$=t.fi_easing,this.#C=t.fo_easing,this.#c.playback(t.hyph)}get cssText(){return this.#t.style.cssText}set cssText(t){this.#t.style.cssText=t}#y=void 0;snapshot(t,e){zt(s=>{this.#y=B.from(s),this.#n&&(this.#y.x+=E.stageW-(this.#g+this.#i.$width)),this.#y.y-=this.#h,this.#y.texture.frame=new U(0,0,Math.min(this.#y.width,this.#i.$width-this.#g),Math.min(this.#y.height,this.#i.$height)),this.#o.addChild(this.#y),t.render(this.#y,{clear:!1}),e()},this.#t,this.#i,this.#_,this.#h,!1)}snapshot_end(){this.#y&&(this.#o.removeChild(this.#y),this.#y=void 0)}makeDesignCast(t){}showDesignCast(){}dump(){const t=[],e=this.#t.style,s=e.length;for(let i=0;i<s;++i){const a=e[i];t.push(`"${String(a)}":"${e[a].replaceAll(/(["\\])/g,"\\$1")}"`)}return`"txt":"${this.#t.textContent.replaceAll(/(["\\])/g,"\\$1")}", "style":{${t.join(",")}}`}destroy(){w.delBreak(),this.#t.parentElement.removeChild(this.#t),this.removeChild(this.#o),this.removeChild(this.#p),super.destroy()}}class I extends M{constructor(t,e,s,i){if(super(),this.hArg=t,this.evtMng=e,this.resolve=s,this.canFocus=i,this.#t={type:"pic",enabled:N(t,"enabled",!0),x:this.x=V(t.left??0),y:this.y=V(t.top??0),rotation:this.angle=x(t,"rotation",this.angle),pivot_x:this.pivot.x=x(t,"pivot_x",this.pivot.x),pivot_y:this.pivot.y=x(t,"pivot_y",this.pivot.y),scale_x:this.scale.x=x(t,"scale_x",this.scale.x),scale_y:this.scale.y=x(t,"scale_y",this.scale.y),alpha:1,text:"",b_pic:"",width:0,height:0},this.getBtnBounds=()=>(this.#a.x=this.#t.x,this.#a.y=this.#t.y,this.#a),this.#t.enabled&&e.button(t,this,()=>this.normal(),()=>this.#p(),()=>this.#u()),t.pic){this.#t.type="pic",this.#r=new y(t.pic,this,o=>{this.#c(o),this.#a.width=o.width*this.#t.scale_x,this.#a.height=o.height*this.#t.scale_y},o=>s);return}if(!t.text)throw"textまたはpic属性は必須です";const a=x(t,"height",30),n=new Et({align:"center",dropShadow:!0,dropShadowAlpha:.7,dropShadowColor:"white",dropShadowBlur:7,dropShadowDistance:0,fill:this.#t.enabled?"black":"gray",fontFamily:I.fontFamily,fontSize:a,padding:5});if(t.style)try{const o=JSON.parse(t.style);for(const[u,d]of Object.entries(o))n[u]=d;this.#t={...this.#t,...o}}catch(o){throw o instanceof SyntaxError?new Error(ct(t,"style",o.message)):"fn:Button.ts style"}const h=new Nt(t.text??"",n);h.alpha=x(t,"alpha",h.alpha),h.width=x(t,"width",100),h.height=t.height=a,this.setText=o=>{h.text=o},this.#t={...this.#t,type:"text",alpha:h.alpha,text:h.text,width:h.width,height:h.height};let r=!1;if(this.#t.width=this.width,this.#t.height=this.height,t.b_pic&&(this.#t.b_pic=t.b_pic,this.#r=new y(t.b_pic,this,o=>{this.#o(o,h),this.#t.width=this.width,this.#t.height=this.height,h.name=JSON.stringify(this.#t)},o=>{D.setBlendmode(this,t),o&&s()}),r=this.#r.ret),h.name=JSON.stringify(this.#t),this.addChild(h),this.#a.width=h.width,this.#a.height=h.height,t.b_pic||D.setBlendmode(this,t),I.#s(this,h),!this.#t.enabled){r||s();return}const c=n.clone();if(t.style_hover)try{const o=JSON.parse(t.style_hover);for(const[u,d]of Object.entries(o))c[u]=d}catch(o){throw o instanceof SyntaxError?new Error(ct(t,"style_hover",o.message)):"fn:Button.ts style_hover"}else c.fill="white";const p=c.clone();if(t.style_clicked)try{const o=JSON.parse(t.style_clicked);for(const[u,d]of Object.entries(o))p[u]=d}catch(o){throw o instanceof SyntaxError?new Error(ct(t,"style_clicked",o.message)):"fn:Button.ts style_clicked"}else p.dropShadow=!1;this.normal=()=>{h.style=n},this.#p=()=>i()?(h.style=c,!0):!1,this.#u=()=>{h.style=p},r||s()}static fontFamily="'Hiragino Sans', 'Hiragino Kaku Gothic ProN', '游ゴシック Medium', meiryo, sans-serif";static#s=(t,e)=>{};static#e=(t,e,s,i)=>{};static init(t){t.oCfg.debug.masume&&(I.#s=(e,s)=>e.addChild(new W().beginFill(8926088,.2).lineStyle(1,8926088,1).drawRect(s.x,s.y,s.width,s.height).endFill()),I.#e=(e,s,i,a)=>e.addChild(new W().beginFill(8926088,.2).lineStyle(1,8926088,1).drawRect(s.x,s.y,i,a).endFill()))}setText(t){}getBtnBounds=()=>this.#a;#a=new U;#r=new y;#t;destroy(){this.evtMng.unButton(this),this.#r.destroy(),super.destroy()}makeDesignCast(t){}showDesignCast(){}cvsResize(){}#o(t,e){this.setChildIndex(t,0),t.alpha=e.alpha,t.setTransform(e.x,e.y,1,1,e.rotation,0,0,(t.width-e.width)/2,(t.height-e.height)/2),t.name=e.name}normal=()=>{};#p=()=>!1;#u=()=>{};#c(t){this.#t.alpha=t.alpha=x(this.hArg,"alpha",t.alpha);const e=t.width/3,s=this.#t.enabled?e:t.width,i=t.height,a=t.texture.baseTexture,n=new z(a,new U(0,0,e,i)),h=new z(a,new U(e,0,e,i)),r=new z(a,new U(e*2,0,e,i)),c=()=>{t.texture=n};this.#t.enabled&&c(),this.normal=c,this.#p=()=>this.canFocus()?(t.texture=r,!0):!1,this.#u=()=>{t.texture=h},"width"in this.hArg?(this.#t.width=V(this.hArg.width),this.scale.x*=this.#t.width/s):this.#t.width=s,"height"in this.hArg?(this.#t.height=V(this.hArg.height),this.scale.y*=this.#t.height/i):this.#t.height=i,t.name=JSON.stringify(this.#t),I.#e(this,t,s,i)}}class A extends D{static#s;static#e;static#a;static#r;static init(t,e,s,i,a,n){this.#s=t,w.init(t,n),this.#e=s,this.#r=i,this.#a=a,s.setDoRecProc(h=>this.chgDoRec(h)),e.autowc=h=>this.#i(h),e.autowc({enabled:!1,text:"",time:0}),e.ch_in_style=h=>this.#t(h),e.ch_out_style=h=>this.#o(h),w.initChStyle(),At(),ht(t.matchPath(".+",K.FONT).flatMap(h=>Object.values(h).map(r=>`
@font-face {
	font-family: '${r}';
	src: url('${this.#s.searchPath(String(r),K.FONT)}');
}
`)).join("")+`
.sn_tx {
	pointer-events: none;
	user-select: none;
	-webkit-touch-callout: none;
	box-sizing: border-box;
}
.sn_ch {
	position: relative;
	display: inline-block;
}
`),this.#t({name:"default",wait:500,alpha:0,x:"=0.3",y:"=0",scale_x:1,scale_y:1,rotate:0,join:!0,ease:"ease-out"}),this.#o({name:"default",wait:0,alpha:0,x:"=0",y:"=0",scale_x:1,scale_y:1,rotate:0,join:!1,ease:"ease-out"})}static#t(t){const e=w.ch_in_style(t),s=e.x.startsWith("=")?`${e.nx*100}%`:`${e.nx}px`,i=e.y.startsWith("=")?`${e.ny*100}%`:`${e.ny}px`,{name:a}=t;return ht(`
.sn_ch_in_${a} {
	position: relative;
	display: inline-block;
}
.go_ch_in_${a} {
	opacity: ${e.alpha};
	position: relative;
	display: inline-block;
	animation: sn_ch_in_${a} ${e.wait}ms ${e.ease} 0s both;
}
@keyframes sn_ch_in_${a} {
	from {transform: rotate(${e.rotate}deg) scale(${e.scale_x}, ${e.scale_y}) translate(${s}, ${i})}
	to {opacity: 1; transform: none;}
}
`),!1}static#o(t){const e=w.ch_out_style(t),s=e.x.startsWith("=")?`${e.nx*100}%`:`${e.nx}px`,i=e.y.startsWith("=")?`${e.ny*100}%`:`${e.ny}px`,{name:a}=t;return ht(`
.go_ch_out_${a} {
	position: relative;
	display: inline-block;
	animation: go_ch_out_${a} ${e.wait}ms ${e.ease} 0s both;
}
@keyframes go_ch_out_${a} {
	to {
		opacity: ${e.alpha};
		transform: rotate(${e.rotate}deg) scale(${e.scale_x}, ${e.scale_y}) translate(${s}, ${i});
	}
`),!1}static#p;static#u;static setEvtMng(t,e,s){this.#p=t,this.#u=e,w.setEvtMng(t,s)}static#c=!1;static#x={};static#i(t){this.#c=N(t,"enabled",this.#c),this.#e.setVal_Nochk("save","const.sn.autowc.enabled",this.#c);const{text:e}=t;if("text"in t!="time"in t)throw"[autowc] textとtimeは同時指定必須です";if(this.#e.setVal_Nochk("save","const.sn.autowc.text",e),!e)return this.#e.setVal_Nochk("save","const.sn.autowc.time",""),!1;const s=e.length;if(this.#c&&s===0)throw'[autowc] enabled === false かつ text === "" は許されません';const i=String(t.time).split(",");if(i.length!==s)throw"[autowc] text文字数とtimeに記述された待ち時間（コンマ区切り）は同数にして下さい";this.#x={};for(let a=0;a<s;++a)this.#x[e[a]]=V(i[a]);return this.#e.setVal_Nochk("save","const.sn.autowc.time",t.time),!1}#d=0;#f=0;#g=!1;#n=void 0;#_="";#h=new w(this.ctn,()=>this.canFocus(),A.#u);#L=new pt;#v=document.createElement("span");static#w={"text-align":0,"text-align-last":0,height:0,width:0,"padding-left":0,"padding-right":0,"padding-top":0,"padding-bottom":0};#k=new M;constructor(){super(),this.ctn.addChild(this.#h),this.#L.init(this.#G),this.ctn.addChild(this.#k),this.#k.name="cntBtn",this.lay({style:`width: ${E.stageW}px; height: ${E.stageH}px; font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', '游ゴシック Medium', meiryo, sans-serif; color: white; font-size: 24px; line-height: 1.5; padding: 16px;`,in_style:"default",out_style:"default",back_clear:"true"})}destroy(){this.#n&&(this.ctn.removeChild(this.#n).destroy(),this.#n=void 0),A.#r.pagebreak(),this.#h.destroy()}static destroy(){this.#c=!1,this.#x={},this.#M=t=>t}set name(t){this.name_=t,this.#h.name=t}get name(){return this.name_}cvsResize(){this.#h.cvsResize()}cvsResizeChildren(){for(const t of this.#k.children)t.cvsResize()}procSetX(t){this.#h.lay({x:t})}procSetY(t){this.#h.lay({y:t})}lay(t){if(super.lay(t),D.setXY(this.ctn,t,this.ctn),t[":id_tag"]=this.name_.slice(0,-7),pt.setting(t),this.#D(t),this.#h.lay(t),"r_align"in t&&(this.#E=t.r_align??""),this.#y=E.isSafari?this.#h.tategaki?(i,a)=>`text-align: start; height: ${a}em; padding-top: ${i}; padding-bottom: ${i};`:(i,a)=>`text-align: start; width: ${a}em; padding-left: ${i}; padding-right: ${i};`:this.#h.tategaki?i=>`text-align: justify; text-align-last: justify; padding-top: ${i}; padding-bottom: ${i};`:i=>`text-align: justify; text-align-last: justify; padding-left: ${i}; padding-right: ${i};`,E.isFirefox&&(this.#H=this.#Q),"r_style"in t)if(t.r_style){const i=document.createElement("span");i.style.cssText=t.r_style;const a=i.style.length,n=this.#v.style;for(let h=0;h<a;++h){const r=i.style[h];if(r in A.#w){it.myTrace(`${r}は指定できません`,"W");continue}const c=i.style[r];c&&(n[r]=c)}}else this.#v.style.cssText="";if("alpha"in t)for(const i of this.#k.children)i.alpha=this.ctn.alpha;this.#l(t),this.#V(t);const e=R.procID+`TxtLayer lay name:${this.name_}`,s=this.#B(t,i=>{i&&R.endProc(e)});return s&&R.beginProc(e),s}#l(t){const{in_style:e}=t;if(!e)return;const s=w.getChInStyle(e);if(!s)throw`存在しないin_style【${e}】です`;this.#m=e,this.#S=s.join}#m="";#S=!0;get width(){return this.#h.getWidth}get height(){return this.#h.getHeight}#V(t){const{out_style:e}=t;if(e){if(!w.getChOutStyle(e))throw`存在しないout_style【${e}】です`;this.#R=e}}#R="";#I=new y;#B(t,e){if("back_clear"in t)return N(t,"back_clear",!1)&&(this.#d=0,this.#f=0,this.#g=!1,this.#_=""),e(!1),!1;this.#f=x(t,"b_alpha",this.#f),this.#g=N(t,"b_alpha_isfixed",this.#g);const s=(this.#g?1:Number(A.#e.getVal("sys:TextLayer.Back.Alpha")))*this.#f;if(t.b_pic){if(this.#_!==t.b_pic)return this.#_=t.b_pic,this.#n&&(this.ctn.removeChild(this.#n),this.#n.destroy()),this.#I=new y(this.#_,this.ctn,i=>{this.#n=i,i.name="back(pic)",i.visible=s>0,i.alpha=s,this.#h.setMySize(i.width,i.height),this.ctn.setChildIndex(i,0),e(!0)}),this.#I.ret}else"b_color"in t&&(this.#d=_t(t,"b_color",0),this.#n&&(this.ctn.removeChild(this.#n),this.#n.destroy()),this.#_="",this.ctn.addChildAt((this.#n=new W).beginFill(this.#d,s).lineStyle(void 0).drawRect(0,0,this.#h.getWidth,this.#h.getHeight).endFill(),0),this.#n.name="back(color)");return this.#n&&(this.#n.visible=s>0,this.#n.alpha=s),e(!1),!1}chgBackAlpha(t){const e=this.#g?this.#f:t*this.#f;this.#n instanceof W&&(this.#n&&(this.ctn.removeChild(this.#n),this.#n.destroy()),this.ctn.addChildAt((this.#n=new W).beginFill(this.#d,e).lineStyle(void 0).drawRect(0,0,this.#h.getWidth,this.#h.getHeight).endFill(),0),this.#n.name="back(color)"),this.#n&&(this.#n.visible=e>0,this.#n.alpha=e)}#D(t){"noffs"in t&&(this.#C=t.noffs??"",this.#b=new RegExp(`[　${this.#C}]`)),"ffs"in t&&(this.#P??="",this.#$=this.#P===""?()=>"":e=>this.#b.test(e)?"":` font-feature-settings: ${this.#P};`)}#P="";#$=t=>"";#C="";#b=/[　]/;static chgDoRec(t){this.#M=t?e=>e:e=>`<span class='offrec'>${e}</span>`}static#M=t=>t;isCur=!1;#y=()=>"";#H=(t,e,s,i="")=>{if(!s)return` style='${i}'`;const a=t.length*2;if(a-e.length<0)return` style='text-align: ${s}; ${i}'`;let n="";switch(s){case"justify":n=this.#y("0",a);break;case"121":n=this.#y(`calc(${(a-e.length)/(e.length*2)}em)`,a);break;case"even":n=this.#y(`calc(${(a-e.length)/(e.length+1)}em)`,a);break;case"1ruby":n=this.#y("1em",a);break;default:n=`text-align: ${s};`}return` style='${n} ${i}'`};#E="";#Q(t,e,s,i=""){if(!s)return` style='${i}'`;const a=t.length*2;if(a-e.length<0)return` style='text-align: ${s}; ${i}'`;let n="";switch(s){case"left":n="ruby-align: start;";break;case"center":n="ruby-align: center;";break;case"right":n="ruby-align: start;";break;case"justify":n="ruby-align: space-between;";break;case"121":n="ruby-align: space-around;";break;case"even":{const h=(a-e.length)/(e.length+1);n="ruby-align: space-between; "+(this.#h.tategaki?`padding-top: ${h}em; padding-bottom: ${h}em;`:`padding-left: ${h}em; padding-right: ${h}em;`)}break;case"1ruby":n="ruby-align: space-between; "+(this.#h.tategaki?"padding-top: 1em; padding-bottom: 1em;":"padding-left: 1em; padding-right: 1em;");break;default:n=`text-align: ${s};`}return` style='${n} ${i}'`}tagCh(t){this.#L.putTxt(t)}#N=!1;get needGoTxt(){return this.#N}#G=(t,e)=>{let s=e;A.#s.oCfg.debug.putCh&&console.log(`🖊 文字表示 text:\`${t}\`(${t.charCodeAt(0).toString(16)}) ruby:\`${s}\` name:\`${this.name_}\``);const i=s.split("｜");let a="";const[n,...h]=i,r=h.join("｜");switch(i.length){case 1:if(this.#N=!0,t===`
`){this.#O?(this.#O=!1,a="<ruby>&emsp;<rt>&emsp;</rt></ruby><br/>"):a="<br/>";break}this.#O&&(this.#O=!1,s===""&&(s="&emsp;")),a=this.#U(t,s,this.#E);break;default:switch(n){case"start":case"left":case"center":case"right":case"justify":case"121":case"even":case"1ruby":this.#O=!1,this.#N=!0,a=this.#U(t,r,n);break;case"gotxt":this.#X(),this.#N?(this.isCur&&A.#r.recText(this.#T.join("").replace(/^<ruby>&emsp;<rt>&emsp;<\/rt><\/ruby>(<br\/>)+/,"").replaceAll(/style='(anim\S+ [^;]+;\s*)+/g,"style='").replaceAll(/( style=''| data-(add|arg|cmd)='[^']+'|\n+|\t+)/g,"").replaceAll(/class='sn_ch[^']+/g,"class='sn_ch").replaceAll("display: none;","").replaceAll("class='offrec'","style='display: none;'")),this.#h.goTxt(this.#T,this.#W===0),this.#N=!1,this.#W=0):this.isCur&&this.#h.noticeCompTxt();return;case"add":{const c=JSON.parse(r),{style:p="",wait:o=null}=c,{cl:u,sty:d}=this.#z(!0,o?V(o):null);this.#T.push(`<span${u} style='${d} display: inline; ${p}'>`),delete c.style,this.#F(c)}return;case"add_close":this.#T.push("</span>"),this.#X();return;case"grp":this.#N=!0;{const c=JSON.parse(r);if(c.id??=String(this.#T.length),c.id==="break"){this.#h.dispBreak(c);return}this.#O=!1,c.delay=this.#W,c.r??="",c.style??="",c.r_style??="";const{r:p,wait:o=null,r_style:u}=c,{cl:d,sty:l,lnk:g}=this.#z(!0,o?V(o):null);a=`<span${d} style='${l} ${c.style}'><ruby><span data-cmd='grp' data-arg='${JSON.stringify(c)}'${g} style='${l} display: inline;'>&emsp;</span><rt${g}${this.#H("　",p,this.#E,this.#v.style.cssText+(this.#A.at(-1)?.o.r_style??"")+u)}>${c.r}</rt></ruby></span>`}break;case"tcy":this.#O=!1,this.#N=!0;{const{t:c="",r:p="",wait:o=null,style:u="",r_style:d=""}=JSON.parse(r);A.#e.doRecLog()&&(this.#q+=t+(s?`《${s}》`:""),this.#j+=c);const l=E.isSafari?p.replaceAll(/[A-Za-z0-9]/g,m=>String.fromCharCode(m.charCodeAt(0)+65248)):p,{cl:g,sty:b,lnk:_}=this.#z(!0,o?V(o):null);a=`<span${g} style='${b}${this.#$(c)} ${u}'><ruby><span${_} style='${b} display: inline; text-combine-upright: all;'>${c}</span><rt${_}${this.#H(c,l,this.#E,this.#v.style.cssText+(this.#A.at(-1)?.o.r_style??"")+d)}>${l}</rt></ruby></span>`}break;case"del":w.delBreak();return;case"span":this.#N=!0,this.#Y(JSON.parse(r));return;case"link":this.#N=!0;{const c=JSON.parse(r);c[":link"]=" data-lnk='@'";const{cl:p,sty:o,curpos:u}=this.#z(!1,c.wait?V(c.wait):null);this.#T.push(`<span${p} style='${o} display: inline; ${c.style??""}' ${u} data-arg='${r}'>`),delete c.style,this.#Y(c)}return;case"endlink":this.#N=!0,this.#T.push("</span>"),this.#X();return;default:this.#N=!0,a=this.#U(t,s,this.#E)}break}this.#T.push(A.#M(a))};#U(t,e,s){const i=t===" "?"&nbsp;":t==="　"?"&emsp;":t;A.#e.doRecLog()&&(this.#q+=i+(e?`《${e}》`:""),t!==" "&&(this.#j+=t));const{cl:a,sty:n,lnk:h}=this.#z(!0,null,t);return e?`<span${a} style='${n} ${this.#$(t)}'><ruby>${Array.from(t).map((r,c)=>`<span${a}${h} style='${c>0?this.#z(!0,null,t).sty:n} display: inline;'>${r===" "?"&nbsp;":r==="　"?"&emsp;":r}</span>`).join("")}<rt${h}${this.#H(t,e,s,this.#v.style.cssText+(this.#A.at(-1)?.o.r_style??""))}>${e}</rt></ruby></span>`:`<span${a} style='${n} ${this.#$(t)}'${h}>${i}</span>`}#z(t,e,s=`
`){const i=this.#S?e??this.#A.at(0)?.o.wait??(A.#c?A.#x[s.at(0)??""]??0:J.msecChWait):0;A.#p.isSkipping?this.#W=0:t&&this.#S&&(this.#W+=V(i));const a=`data-add='{"ch_in_style":"${this.#m}", "ch_out_style":"${this.#R}"}'`;return{cl:` class='sn_ch sn_ch_yet sn_ch_in_${this.#m}'`,sty:`animation-delay: ${this.#W}ms;${this.#A.at(-1)?.o.style??""}`,lnk:(this.#A.at(0)?.o[":link"]??"")+" "+a,curpos:a}}#W=0;#O=!0;#T=[];#A=[];#F(t){this.#A.push({o:t,r_align:this.#E,ch_in_style:this.#m,ch_out_style:this.#R}),t.r_align&&(this.#E=t.r_align),this.#l(t),this.#V(t)}#X(){const t=this.#A.pop();t&&(this.#E=t.r_align,this.#l({in_style:t.ch_in_style}),this.#V({out_style:t.ch_out_style}))}#Y(t){const e=this.#A.at(-1);if(!e){this.#F(t);return}e.o={...e.o,...t},!t.style&&!t.r_style&&(e.o.style="",e.o.r_style=""),t.r_align&&(this.#E=t.r_align),this.#l(t),this.#V(t)}click=()=>!this.ctn.interactiveChildren||!this.ctn.visible?!1:this.#h.skipChIn();clearText(){this.ctn.addChild(this.#h=this.#h.reNew()),this.#W=0,this.#O=!0,this.#T=[],this.#q="",this.#j="",A.#r.pagebreak()}#q="";#j="";get pageText(){return this.#q.replace("《&emsp;》","")}get pagePlainText(){return this.#j}get enabled(){return this.ctn.interactiveChildren}set enabled(t){this.ctn.interactiveChildren=t}addButton=t=>new Promise(e=>{t.key=`btn=[${this.#k.children.length}] `+this.name_,t[":id_tag"]=t.key.slice(0,-7),N(t,"hint_tate",this.#h.tategaki);const s=new I(t,A.#p,()=>e(),()=>this.canFocus());s.name=JSON.stringify(t).replaceAll('"',"'"),this.#k.addChild(s)});canFocus(){return(this.ctn.interactiveChildren??!1)&&this.ctn.visible&&A.#a(this)}clearLay(t){super.clearLay(t),this.clearText();for(const e of this.#k.removeChildren())e.destroy()}record=()=>({...super.record(),enabled:this.enabled,r_cssText:this.#v.style.cssText,r_align:this.#E,b_do:this.#n===void 0?void 0:this.#n instanceof B?"Sprite":"Graphics",b_pic:this.#_,b_color:this.#d,b_alpha:this.#f,b_alpha_isfixed:this.#g,ffs:this.#P,txs:this.#h.record(),strNoFFS:this.#C,btns:this.#k.children.map(t=>t.name)});playback(t,e){super.playback(t,e),this.enabled=t.enabled,this.#v.style.cssText=t.r_cssText,this.#E=t.r_align,this.cvsResize(),this.#D(t),this.#h.playback(t.txs),this.#f=t.b_alpha,this.#g=t.b_alpha_isfixed,e.push(new Promise(s=>{const i=t.b_do?t.b_do==="Sprite"?{b_pic:t.b_pic}:{b_color:t.b_color}:{b_pic:""};i.b_alpha=t.b_alpha,i.b_alpha_isfixed=t.b_alpha_isfixed,this.#B(i,a=>{a&&s()})||s()}),...t.btns.map(s=>this.addButton(JSON.parse(s.replaceAll("'",'"')))).flat())}get cssText(){return this.#h.cssText}set cssText(t){this.#h.cssText=t}snapshot(t,e){t.render(this.ctn,{clear:!1}),this.#h.snapshot(t,e)}snapshot_end(){this.#h.snapshot_end()}makeDesignCast(t){this.ctn.visible&&this.#h.makeDesignCast(t)}makeDesignCastChildren(t){if(this.ctn.visible)for(const e of this.#k.children)e.makeDesignCast(t)}showDesignCast(){this.#h.showDesignCast()}showDesignCastChildren(){for(const t of this.#k.children)t.showDesignCast()}dump(){return this.#G("","gotxt｜"),super.dump()+`, "enabled":"${this.enabled}", ${this.#h.dump()}, "b_pic":"${this.#_}", "b_color":"${this.#d}", "b_alpha":${this.#f}, "b_alpha_isfixed":"${this.#g}", "width":${this.#h.getWidth}, "height":${this.#h.getHeight}, "pixi_obj":[${this.ctn.children.map(t=>`{"class":"${t instanceof B?"Sprite":t instanceof W?"Graphics":t instanceof M?"Container":"?"}", "name":"${t.name}", "alpha":${t.alpha}, "x":${t.x}, "y":${t.y}, "visible":"${t.visible}"}`).join(",")}], "button":[${this.#k.children.map(t=>t.children[0]?.name??"{}").join(",")}]`}}class T{constructor(t,e,s){this.appPixi=e,this.val=s,t.add_frame=i=>this.#p(i),t.let_frame=i=>this.#f(i),t.set_frame=i=>this.#g(i),t.frame=i=>this.#_(i),t.tsy_frame=i=>this.#h(i)}static#s;static#e;static#a;static init(t,e,s){T.#s=t,T.#e=e,T.#a=s}#r;setEvtMng(t){this.#r=t}#t=Object.create(null);destroy(){for(const t of Object.values(this.#t))t.parentElement.removeChild(t);this.#t=Object.create(null)}hideAllFrame(){for(const[t,{style:e}]of Object.entries(this.#t))this.#o[t]=e.display!=="none",e.display="none"}#o=Object.create(null);restoreAllFrame(){for(const[t,e]of Object.entries(this.#o)){const s=this.#t[t];s&&(s.style.display=e?"inline":"none")}this.#o=Object.create(null)}#p(t){const{id:e,src:s,alpha:i=1,scale_x:a=1,scale_y:n=1,rotate:h=0}=t;if(!e)throw"idは必須です";if(!s)throw"srcは必須です";const r="const.sn.frm."+e;if(this.val.getVal(`tmp:${r}`))throw`frame【${e}】はすでにあります`;const c=N(t,"visible",!0),p=t.b_color?` background-color: ${t.b_color};`:"",o=this.#c(t);T.#a.cvs.insertAdjacentHTML("beforebegin",`<iframe id="${e}" style="opacity: ${i}; ${p} position: absolute; left:${T.#e.ofsLeft4elm+o.x*T.#e.cvsScale}px; top: ${T.#e.ofsTop4elm+o.y*T.#e.cvsScale}px; z-index: 1; border: 0px; overflow: hidden; display: ${c?"inline":"none"}; transform: scale(${a}, ${n}) rotate(${h}deg);" width="${o.width*T.#e.cvsScale}" height="${o.height*T.#e.cvsScale}"></iframe>`);const u=R.procID+`add_frame id:${e}`;R.beginProc(u);const d=T.#s.searchPath(s,K.HTML),l=new G().add({name:s,url:d,xhrType:j.XHR_RESPONSE_TYPE.TEXT});return T.#e.arg.crypto&&l.use((g,b)=>void T.#e.dec(g.extension,g.data).then(_=>{g.data=_,b()}).catch(_=>{T.#a.errScript(`[add_frame]Html ロード失敗です src:${g.name} ${_}`,!1),b()})),l.load((g,b)=>{const _=document.getElementById(e);this.#t[e]=_,this.#u[e]=!1;const m=d.lastIndexOf("/")+1,f=d.slice(0,m),v=f.slice(0,m);_.srcdoc=String(b[s]?.data).replace("sn_repRes();","").replaceAll(/\s(?:src|href)=(["'])(\S+?)\1/g,(S,C,$)=>$.startsWith("../")?v+S.slice(3):S.replace("./","").replace(C,C+f)),_.srcdoc.includes("true/*WEBP*/;")&&(_.srcdoc=_.srcdoc.replaceAll(/data-src="(.+?\.)(?:jpe?g|png)/g,(S,C)=>`data-src="${C}webp`)),_.onload=()=>{R.endProc(u),this.val.setVal_Nochk("tmp",r,!0),this.val.setVal_Nochk("tmp",r+".alpha",i),this.val.setVal_Nochk("tmp",r+".x",o.x),this.val.setVal_Nochk("tmp",r+".y",o.y),this.val.setVal_Nochk("tmp",r+".scale_x",a),this.val.setVal_Nochk("tmp",r+".scale_y",n),this.val.setVal_Nochk("tmp",r+".rotate",h),this.val.setVal_Nochk("tmp",r+".width",o.width),this.val.setVal_Nochk("tmp",r+".height",o.height),this.val.setVal_Nochk("tmp",r+".visible",c);const S=_.contentWindow;this.#r.resvFlameEvent(S.document.body),S.sn_repRes?.(C=>T.#x(C.dataset.src??"",C))}}),!0}#u={};getFrmDisabled(t){return this.#u[t]}#c(t){const e={...t},s=T.#e.resolution;return new DOMRect(x(e,"x",0)*s,x(e,"y",0)*s,x(e,"width",E.stageW)*s,x(e,"height",E.stageH)*s)}static#x(t,e,s){const i=this.#d[t];if(i){e.src=i,s&&(e.onload=()=>s(e));return}const a=this.#i[t];if(a){a.push(e);return}this.#i[t]=[e];const[n="",h=""]=t.split("?"),r=T.#s.searchPath(n,K.SP_GSM),c=new G().add({name:t,url:r,xhrType:j.XHR_RESPONSE_TYPE.BUFFER});T.#e.use4ViteElectron(t,r,c,T.#a)||T.#e.arg.crypto&&r.endsWith(".bin")&&c.use((p,o)=>{if(p.extension!=="bin"){o();return}T.#e.decAB(p.data).then(u=>{p.data=u,u instanceof HTMLImageElement&&(p.type=j.TYPE.IMAGE),o()}).catch(u=>{T.#a.errScript(`FrameMng loadPic ロード失敗です fn:${p.name} ${u}`,!1),o()})}),c.load((p,o)=>{for(const[u,{data:{src:d}}]of Object.entries(o)){const l=this.#d[u]=d+(d.startsWith("blob:")||d.startsWith("data:")?"":h?"?"+h:""),g=this.#i[u];if(g)for(const b of g)b.src=l,s&&(b.onload=()=>s(b));delete this.#i[u]}})}static#i={};static#d={};cvsResize(){for(const[t,e]of Object.entries(this.#t)){const s="const.sn.frm."+t,i=Number(this.val.getVal(s+".x")),a=Number(this.val.getVal(s+".y")),n=Number(this.val.getVal(s+".width")),h=Number(this.val.getVal(s+".height"));e.style.left=`${T.#e.ofsLeft4elm+i*T.#e.cvsScale}px`,e.style.top=`${T.#e.ofsTop4elm+a*T.#e.cvsScale}px`,e.width=String(n*T.#e.cvsScale),e.height=String(h*T.#e.cvsScale)}}#f(t){const{id:e,var_name:s}=t;if(!e)throw"idは必須です";const i=document.getElementById(e);if(!i)throw`id【${e}】はフレームではありません`;const a="const.sn.frm."+e;if(!this.val.getVal(`tmp:${a}`))throw`frame【${e}】が読み込まれていません`;if(!s)throw"var_nameは必須です";const n=i.contentWindow;if(!Object.hasOwn(n,s))throw`frame【${e}】に変数/関数【${s}】がありません。変数は var付きにして下さい`;const h=n[s];return this.val.setVal_Nochk("tmp",a+"."+s,N(t,"function",!1)?h():h),!1}#g(t){const{id:e,var_name:s,text:i}=t;if(!e)throw"idは必須です";const a=document.getElementById(e);if(!a)throw`id【${e}】はフレームではありません`;const n="const.sn.frm."+e;if(!this.val.getVal(`tmp:${n}`))throw`frame【${e}】が読み込まれていません`;if(!s)throw"var_nameは必須です";if(!i)throw"textは必須です";this.val.setVal_Nochk("tmp",n+"."+s,i);const h=a.contentWindow;return h[s]=i,!1}#n=1;#_(t){const{id:e}=t;if(!e)throw"idは必須です";const s=document.getElementById(e);if(!s)throw`id【${e}】はフレームではありません`;const i="const.sn.frm."+e;if(!this.val.getVal("tmp:"+i))throw`frame【${e}】が読み込まれていません`;const a=s.style;if(N(t,"float",!1)?a.zIndex=`${++this.#n}`:"index"in t?a.zIndex=`${x(t,"index",0)}`:t.dive&&(a.zIndex=`-${++this.#n}`),"alpha"in t){const h=a.opacity=String(t.alpha);this.val.setVal_Nochk("tmp",i+".alpha",h)}const n=this.#c(t);if(("x"in t||"y"in t)&&(a.left=`${T.#e.ofsLeft4elm+n.x*T.#e.cvsScale}px`,a.top=`${T.#e.ofsTop4elm+n.y*T.#e.cvsScale}px`,this.val.setVal_Nochk("tmp",i+".x",n.x),this.val.setVal_Nochk("tmp",i+".y",n.y)),"scale_x"in t||"scale_y"in t||"rotate"in t){const h=x(t,"scale_x",1),r=x(t,"scale_y",1),c=x(t,"rotate",0);a.transform=`scale(${h}, ${r}) rotate(${c}deg)`,this.val.setVal_Nochk("tmp",i+".scale_x",h),this.val.setVal_Nochk("tmp",i+".scale_y",r),this.val.setVal_Nochk("tmp",i+".rotate",c)}if("width"in t&&(s.width=String(n.width*T.#e.cvsScale),this.val.setVal_Nochk("tmp",i+".width",n.width)),"height"in t&&(s.height=String(n.height*T.#e.cvsScale),this.val.setVal_Nochk("tmp",i+".height",n.height)),"visible"in t){const h=N(t,"visible",!0);a.display=h?"inline":"none",this.val.setVal_Nochk("tmp",i+".visible",h)}if("b_color"in t&&(a.backgroundColor=t.b_color),"disabled"in t){const h=this.#u[e]=N(t,"disabled",!0),r=s.contentDocument.body;for(const c of[...Array.from(r.getElementsByTagName("input")),...Array.from(r.getElementsByTagName("select"))])c.disabled=h}return!1}#h(t){const{id:e,alpha:s,x:i,y:a,scale_x:n,scale_y:h,rotate:r,width:c,height:p}=t;if(!e)throw"idは必須です";const o=document.getElementById(e);if(!o)throw`id【${e}】はフレームではありません`;const u="const.sn.frm."+e;if(!this.val.getVal(`tmp:${u}`,0))throw`frame【${e}】が読み込まれていません`;const d={};s&&(d.a=Number(o.style.opacity)),(i||a||n||h||r)&&(d.x=Number(this.val.getVal(`tmp:${u}.x`)),d.y=Number(this.val.getVal(`tmp:${u}.y`)),d.sx=Number(this.val.getVal(`tmp:${u}.scale_x`)),d.sy=Number(this.val.getVal(`tmp:${u}.scale_y`)),d.r=Number(this.val.getVal(`tmp:${u}.rotate`))),c&&(d.w=Number(this.val.getVal(`tmp:${u}.width`))),p&&(d.h=Number(this.val.getVal(`tmp:${u}.height`)));const l=P.cnvTweenArg(t,d);let g=()=>{};s&&(x(l,"alpha",0),g=()=>{o.style.opacity=String(d.a),this.val.setVal_Nochk("tmp","alpha",d.a)});let b=()=>{};const _=this.#c(l);(i||a||n||h||r)&&(_.x,_.y,x(l,"scale_x",1),x(l,"scale_y",1),x(l,"rotate",0),b=()=>{o.style.left=`${T.#e.ofsLeft4elm+d.x*T.#e.cvsScale} px`,o.style.top=`${T.#e.ofsTop4elm+d.y*T.#e.cvsScale} px`,o.style.transform=`scale(${d.sx}, ${d.sy}) rotate(${d.r}deg)`,this.val.setVal_Nochk("tmp",u+".x",d.x),this.val.setVal_Nochk("tmp",u+".y",d.y),this.val.setVal_Nochk("tmp",u+".scale_x",d.sx),this.val.setVal_Nochk("tmp",u+".scale_y",d.sy),this.val.setVal_Nochk("tmp",u+".rotate",d.r)});let m=()=>{};c&&(_.width,m=()=>{o.width=`${d.w*T.#e.cvsScale} px`,this.val.setVal_Nochk("tmp",u+".width",d.w)});let f=()=>{};return p&&(_.height,f=()=>{o.height=`${d.h*T.#e.cvsScale} px`,this.val.setVal_Nochk("tmp",u+".height",d.h)}),this.appPixi.stage.interactive=!1,P.tween(`frm
${e}`,t,d,P.cnvTweenArg(t,d),()=>{g(),b(),m(),f()},()=>{this.appPixi.stage.interactive=!0},()=>{}),!1}}class Jt{constructor(t,e,s){this.oCfg=t,this.hTag=e,this.val=s,e.rec_ch=i=>this.#a(i),e.rec_r=i=>this.#r(i),e.reset_rec=i=>this.#t(i),s.defTmp("const.sn.log.json",()=>{this.#s.text=this.#s.text.replaceAll("</span><span class='sn_ch'>","");const i=[...this.#e,this.#s];return JSON.stringify(i)}),this.recText("")}#s={text:""};#e=[];recText(t){this.#s.text=t,this.val.setVal_Nochk("save","const.sn.sLog",String(this.val.getVal("const.sn.log.json")))}#a(t){return this.#s={...t,text:this.#s.text},t.text?(t.record=!0,t.style??="",t.style+="display: none;",t.wait=0,this.hTag.ch(t)):(this.val.setVal_Nochk("save","const.sn.sLog",String(this.val.getVal("const.sn.log.json"))),!1)}#r(t){return this.#a({...t,text:"[r]"})}#t(t){return this.#e=[],t.text??="",this.#s={text:t.text},this.val.setVal_Nochk("save","const.sn.sLog",JSON.stringify([this.#s])),!1}pagebreak(){this.#s.text=this.#s.text.replaceAll("</span><span class='sn_ch'>",""),this.#s.text&&(this.#e.push(this.#s)>this.oCfg.log.max_len&&(this.#e=this.#e.slice(-this.oCfg.log.max_len)),this.#s={text:""})}playback(){this.#e=JSON.parse(String(this.val.getVal("save:const.sn.sLog"))),this.#s={text:""}}}function X(q){return encodeURIComponent(JSON.stringify(q))}class J{constructor(t,e,s,i,a,n,h,r,c){this.cfg=t,this.hTag=e,this.appPixi=s,this.val=i,this.main=a,this.scrItr=n,this.sys=h;const p=()=>{if(h.cvsResize(),this.cvsResizeDesign(),this.#x)for(const l of this.#m)this.#l[l].fore.cvsResizeChildren();else for(const l of this.#m)this.#l[l].fore.cvsResize();this.#r.cvsResize(),this.#f.cvsResize()};if(E.isMobile)this.#p.add(globalThis,"orientationchange",p,{passive:!0});else{let l;this.#p.add(globalThis,"resize",()=>{l||(l=setTimeout(()=>{l=void 0,p()},1e3/60*10))},{passive:!0})}h.cvsResize(),this.#o=new Jt(this.cfg.oCfg,e,i),A.init(t,e,i,this.#o,l=>this.#l[l.layname].fore===l,s),H.init(a,t,s,h,r,i),T.init(t,h,a),I.init(t),this.#r=new T(e,s,i),h.hFactoryCls.grp=()=>new H,h.hFactoryCls.txt=()=>new A,e.loadplugin=l=>this.#w(l),e.snapshot=l=>this.#_(l),this.#h=this.sys.isApp?(l,g,b,_,m)=>this.#L(l,g,b,_,m):(l,g,b,_,m)=>this.#v(l,g,b,_,m),e.add_lay=l=>this.#k(l),e.clear_lay=l=>this.#B(l),e.finish_trans=()=>!1,e.lay=l=>this.#R(l),e.trans=l=>this.#M(l),e.wt=l=>P.wt(l),e.quake=l=>this.#Q(l),e.stop_quake=e.finish_trans,e.wq=e.wt,e.pause_tsy=l=>P.pause_tsy(l),e.resume_tsy=l=>P.resume_tsy(l),e.stop_tsy=l=>P.stop_tsy(l),e.tsy=l=>this.#N(l),e.wait_tsy=l=>P.wait_tsy(l),e.add_filter=l=>this.#G(l),e.clear_filter=l=>this.#z(l),e.enable_filter=l=>this.#W(l),e.ch=l=>this.#A(l),e.clear_text=l=>this.#Z(l),e.current=l=>this.#Y(l),e.endlink=l=>this.#tt(l),e.er=l=>this.#et(l),e.graph=l=>this.#st(l),e.link=l=>this.#it(l),e.r=l=>this.#at(l),e.ruby2=l=>this.#nt(l),e.span=l=>this.#ht(l),e.tcy=l=>this.#rt(l),e.add_face=l=>y.add_face(l),e.wv=l=>y.wv(l),e.dump_lay=l=>this.#lt(l),e.enable_event=l=>this.#ot(l),e.button=l=>this.#ct(l),t.existsBreakline&&(this.breakLine=l=>{delete l.visible,l.id="break",l.pic="breakline",this.#n("grp｜"+X(l))}),t.existsBreakpage&&(this.breakPage=l=>{delete l.visible,l.id="break",l.pic="breakpage",this.#n("grp｜"+X(l))}),this.#t=Pt(String(t.oCfg.init.bg_color));const o=new W;o.beginFill(this.#t).lineStyle(0,this.#t).drawRect(0,0,E.stageW,E.stageH).endFill(),this.#e.addChild(o.clone()),this.#a.addChild(o),this.#a.visible=!1,this.#e.name="page:A",this.#a.name="page:B",this.#s=s.stage,this.#s.addChild(this.#a),this.#s.addChild(this.#e),this.#s.addChild(this.#$),this.#s.addChild(this.#b),this.#s.name="stage";const u=(l,g)=>{this.#g(Number(g))};u("",i.getVal("sys:TextLayer.Back.Alpha",1)),i.defValTrg("sys:TextLayer.Back.Alpha",u);const d=(l,g)=>{I.fontFamily=g};d("",i.getVal("tmp:sn.button.fontFamily",I.fontFamily)),i.defValTrg("tmp:sn.button.fontFamily",d),i.defTmp("const.sn.last_page_text",()=>this.currentTxtlayFore?.pageText??""),i.defTmp("const.sn.last_page_plain_text",()=>this.currentTxtlayFore?.pagePlainText??""),E.isDbg&&(ut.init(s,h,n,c,t,this.#l),this.cvsResizeDesign=()=>ut.cvsResizeDesign(),h.addHook((l,g)=>{this.#u[l]?.(l,g)&&delete this.#u[l]}))}#s;#e=new M;#a=new M;#r;#t;#o;#p=new kt;cvsResizeDesign(){}#u={attach:t=>!1,continue:t=>!1,disconnect:t=>!1,_enterDesign:t=>{for(const e of this.#m){const s=this.#l[e].fore;s.makeDesignCastChildren(i=>i.make()),s.makeDesignCast(i=>i.make())}return this.#i(this.#S),!1},_replaceToken:(t,e)=>!1,_selectNode:(t,e)=>(this.#i(e.node),!1)};#c="";#x="";#i(t){[this.#c="",this.#x=""]=t.split("/");const e=this.#l[this.#c];e&&(this.#x?e.fore.showDesignCastChildren():e.fore.showDesignCast())}getFrmDisabled=t=>this.#r.getFrmDisabled(t);#d=void 0;cover(t,e=0){this.#d&&(this.#s.removeChild(this.#d),this.#d.destroy(),this.#d=void 0),t&&this.#s.addChild((this.#d=new W).beginFill(e).lineStyle(0,e).drawRect(0,0,E.stageW,E.stageH).endFill())}#f;setEvtMng(t){this.#f=t,this.#r.setEvtMng(t),y.setEvtMng(t),P.init(t,this.appPixi)}destroy(){for(const t of Object.values(this.#l))t.destroy();this.#p.clear(),H.destroy(),pt.destroy(),w.destroy(),A.destroy(),this.#r.destroy(),P.destroy(),J.#T=10}#g(t){for(const e of this.#m){const{fore:s,back:i}=this.#l[e];s instanceof A&&(s.chgBackAlpha(t),i.chgBackAlpha(t))}}#n=(t,e=this.currentTxtlayForeNeedErr,s=!0)=>e.tagCh("｜&emsp;《"+t+"》");goTxt=()=>{};get needGoTxt(){return this.currentTxtlayFore?.needGoTxt??!1}breakLine=t=>{};breakPage=t=>{};clearBreak(){this.currentTxtlayFore&&(this.clearBreak=()=>this.#n("del｜break"),this.clearBreak())}clickTxtLay(){return this.currentTxtlayFore?this.#m.map(t=>this.#l[t].fore).some(t=>t instanceof A&&t.click()):!1}#_(t){const e=Ot("-","_","","_"),s=t.fn?t.fn.startsWith(Lt)?t.fn:`${bt+t.fn+e}.png`:`${bt}snapshot${e}.png`,i=this.cfg.searchPath(s),a=x(t,"width",E.stageW),n=x(t,"height",E.stageH);return this.#h(t,i,a,n,`snapshot dt:${e}`)}#h=()=>!1;#L({layer:t},e,s,i,a){if(this.#r.hideAllFrame(),R.beginProc(a),!t)return this.sys.capturePage(e,s,i,()=>{this.#r.restoreAllFrame(),R.endProc(a)}),!0;const n=this.#m.map(h=>{const{ctn:r}=this.#l[h].fore,c=[r,r.visible];return r.visible=!1,c});for(const h of this.#y(t))this.#l[h].fore.ctn.visible=!0;return this.sys.capturePage(e,s,i,()=>{for(const[h,r]of n)h.visible=r;this.#r.restoreAllFrame(),R.endProc(a)}),!0}#v(t,e,s,i,a){R.beginProc(a);const n=_t(t,"b_color",this.#t),h=Vt({width:s,height:i,backgroundAlpha:n>16777216&&e.endsWith(".png")?0:1,antialias:N(t,"smoothing",!1),preserveDrawingBuffer:!0,backgroundColor:n&16777215,autoDensity:!0}),r=t.page!=="back"?"fore":"back",{layer:c}=t;return Promise.allSettled(this.#y(c).map(p=>new Promise(o=>this.#l[p][r].snapshot(h,o)))).then(async()=>{const p=tt.create({width:h.width,height:h.height});h.render(this.#s,{renderTexture:p}),await this.sys.savePic(e,h.plugins.extract.base64(p)),p.destroy();for(const o of this.#y(c))this.#l[o][r].snapshot_end();h.destroy(!0),R.endProc(a)}),!0}#w(t){const{fn:e}=t;if(!e)throw"fnは必須です";if(!e.endsWith(".css"))throw"サポートされない拡張子です";const s=N(t,"join",!0),i=R.procID+`loadplugin fn:${e}`;return s&&R.beginProc(i),(async()=>{const a=await fetch(e);if(!a.ok)throw new Error("Network response was not ok.");ht(await a.text()),s&&R.endProc(i)})(),s}#k(t){const{layer:e,class:s}=t;if(!e)throw"layerは必須です";if(e.includes(","))throw"layer名に「,」は使えません";if(e in this.#l)throw`layer【${e}】はすでにあります`;if(!s)throw"clsは必須です";const i={isWait:!1};switch(this.#l[e]=new et(e,s,this.#e,this.#a,t,this.sys,this.val,i),this.#m.push(e),s){case"txt":this.#S||(this.#K=()=>{},this.#F=a=>this.#X(a),this.#Y=a=>this.#q(a),this.hTag.current({layer:e}),this.goTxt=()=>{this.#f.isSkipping?J.#T=0:this.setNormalChWait();for(const a of this.#m){const n=this.#l[a].fore;n instanceof A&&this.#n("gotxt｜",n,!1)}}),this.val.setVal_Nochk("save","const.sn.layer."+e+".enabled",!0);break;case"grp":if(this.#V)break;this.#V=e;break}return this.scrItr.recodeDesign(t),i.isWait}#l={};#m=[];#S="";#V="";#R(t){const e=this.#J(t),s=this.#l[e],i=s.back.ctn,a=s.fore.ctn;if(N(t,"float",!1))this.#a.setChildIndex(i,this.#a.children.length-1),this.#e.setChildIndex(a,this.#e.children.length-1),this.#I();else if(t.index)x(t,"index",0)&&(this.#a.setChildIndex(i,t.index),this.#e.setChildIndex(a,t.index),this.#I());else if(t.dive){const{dive:n}=t;let h=0;if(e===n)throw"[lay] 属性 layerとdiveが同じ【"+n+"】です";const r=this.#l[n];if(!r)throw"[lay] 属性 dive【"+n+"】が不正です。レイヤーがありません";const c=r.back,p=r.fore,o=this.#a.getChildIndex(c.ctn),u=this.#e.getChildIndex(p.ctn);h=o<u?o:u,h>this.#a.getChildIndex(i)&&--h,this.#e.setChildIndex(a,h),this.#a.setChildIndex(i,h),this.#I()}return t[":id_tag"]=s.fore.name.slice(0,-7),this.scrItr.recodeDesign(t),s.lay(t)}#I(){this.#m=this.#E()}#B(t){return this.#H(t,e=>{const s=this.#l[this.#J({layer:e})];if(t.page==="both"){s.fore.clearLay(t),s.back.clearLay(t);return}s.getPage(t).clearLay(t)}),!1}static#D=`
precision mediump float;

varying vec2 vTextureCoord;
uniform sampler2D uSampler;

uniform sampler2D rule;
uniform float vague;
uniform float tick;

uniform vec4 inputPixel;
uniform highp vec4 outputFrame;
vec2 getUV(vec2 coord) {
	return coord * inputPixel.xy / outputFrame.zw;
}

void main() {
	vec4 fg = texture2D(uSampler, vTextureCoord);
	vec4 ru = texture2D(rule, getUV(vTextureCoord));

	float v = ru.r - tick;
	gl_FragColor = abs(v) < vague
		? vec4(fg.rgb, 1) *fg.a *(0.5 +v /vague *0.5)
		: 0.0 <= v ? fg : vec4(0);
}`;#P=tt.create({width:E.stageW,height:E.stageH});#$=new B(this.#P);#C=tt.create({width:E.stageW,height:E.stageH});#b=new B(this.#C);#M(t){const{layer:e}=t,s=new Set,i=this.#y(e).map(f=>(s.add(f),this.#l[f].fore)),a=()=>{[this.#e,this.#a]=[this.#a,this.#e];const f=[];for(const[v,S]of Object.entries(this.#l)){if(s.has(v)){S.transPage(f);continue}const{fore:{ctn:C},back:{ctn:$}}=S,k=this.#e.getChildIndex($);this.#e.removeChild($),this.#a.removeChild(C),this.#e.addChildAt(C,k),this.#a.addChildAt($,k)}Promise.allSettled(f).then(()=>{this.#e.visible=!0,this.#a.visible=!1,this.#$.visible=!1,this.#b.visible=!1,R.notifyEndProc(xt+Z)})};if(this.#b.filters=[],this.#b.alpha=1,x(t,"time",0)===0||this.#f.isSkipping)return R.beginProc(xt+Z,()=>{}),queueMicrotask(()=>a()),!0;const n=[],h=this.#m.map(f=>{const{fore:v,back:S}=this.#l[f],C=s.has(f)?S:v;return C.ctn.visible&&n.push(C.ctn),C}),{ticker:r,renderer:c}=this.appPixi;c.render(this.#a,{renderTexture:this.#P});let p=()=>{for(const f of n)c.render(f,{renderTexture:this.#P,clear:!1})};if(!h.some(f=>f.containMovement)){const f=p;p=()=>{p=()=>{},f()}}const o=()=>c.render(this.#e,{renderTexture:this.#C});o();let u=()=>{this.#e.visible=!0,o(),this.#e.visible=!1};if(!i.some(f=>f.containMovement)){const f=u;u=()=>{u=()=>{},f()}}const d=()=>{p(),this.#$.visible=!0,u(),this.#b.visible=!0},{glsl:l,rule:g}=t,b=()=>{r.remove(d),a()};if(!l&&!g)return P.tween(Z,t,this.#b,{alpha:0},()=>{},b,()=>{}),r.add(d),!1;const _={rule:z.EMPTY,vague:x(t,"vague",.04),tick:0};this.#b.filters=[new Bt(void 0,l??J.#D,_)];const m=P.tween(Z,t,_,{tick:1},()=>{},b,()=>{},!g);return g?new y(g,void 0,f=>{_.rule=f.texture,f.destroy(),m.start(),r.add(d)},f=>{f&&this.main.resume()}).ret:(r.add(d),!1)}#y(t=""){return t?t.split(","):this.#m}#H(t,e){const s=this.#y(t.layer);for(const i of s){const a=this.#l[i];if(!a)throw`存在しないlayer【${i}】です`;e(i,a)}return s}#E(t=""){return this.#y(t).sort((e,s)=>{const i=this.#e.getChildIndex(this.#l[e].fore.ctn),a=this.#e.getChildIndex(this.#l[s].fore.ctn);return i<a?-1:i>a?1:0})}setAllStyle2TxtLay(t){for(const e of this.#m){const s=this.#l[e].fore;s instanceof A&&s.lay({style:t})}}#Q(t){if(x(t,"time",NaN)===0)return!1;const e=this.#y(t.layer).map(p=>this.#l[p].fore.ctn),{renderer:s,ticker:i}=this.appPixi;this.#C.resize(E.stageW,E.stageH);const a=()=>{this.#e.visible=!0;for(const p of e)s.render(p,{renderTexture:this.#C,clear:!1});this.#e.visible=!1};this.#b.visible=!0,this.#b.alpha=1;const n=V(x(t,"hmax",10)),h=V(x(t,"vmax",10)),r=n===0?()=>{}:()=>{this.#b.x=Math.round(Math.random()*n*2)-n},c=h===0?()=>{}:()=>{this.#b.y=Math.round(Math.random()*h*2)-h};return this.#b.filters=[],P.tween(Z,t,this.#b,{x:0,y:0},()=>{r(),c()},()=>{i.remove(a),this.#e.visible=!0,this.#b.visible=!1,this.#b.x=0,this.#b.y=0},()=>{}),i.add(a),!1}#N(t){const{layer:e,render:s,name:i}=t;if(!e)throw"layerは必須です";const a=this.#l[this.#J(t)],n=a.fore;let h=()=>{};s&&!this.#f.isSkipping&&(n.renderStart(),h=()=>n.renderEnd());const r=P.cnvTweenArg(t,n),c=N(t,"arrive",!1),p=N(t,"backlay",!1),o=a.back.ctn;return P.tween(i??e,t,n,P.cnvTweenArg(t,n),()=>{},h,()=>{if(c&&Object.assign(n,r),p)for(const u of Object.keys(P.hMemberCnt))o[u]=n[u]}),"filter"in t&&(n.ctn.filters=[D.bldFilters(t)],n.aFltHArg=[t]),!1}#G(t){return this.#H(t,e=>{const s=this.#l[this.#J({layer:e})];if(t.page==="both"){this.#U(s.fore,t),this.#U(s.back,t);return}const i=s.getPage(t);this.#U(i,t)}),!1}#U(t,e){const s=t.ctn;s.filters??=[],s.filters=[...s.filters,D.bldFilters(e)],t.aFltHArg.push(e)}#z(t){return this.#H(t,e=>{const s=this.#l[this.#J({layer:e})];if(t.page==="both"){const a=s.fore,n=s.back;a.ctn.filters=null,n.ctn.filters=null,a.aFltHArg=[],n.aFltHArg=[];return}const i=s.getPage(t);i.ctn.filters=null,i.aFltHArg=[]}),!1}#W(t){return this.#H(t,e=>{const s=this.#l[this.#J({layer:e})];if(t.page==="both"){this.#O(s.fore,t),this.#O(s.back,t);return}const i=s.getPage(t);this.#O(i,t)}),!1}#O(t,e){const s=t.ctn;if(!s.filters)throw"フィルターがありません";const i=V(x(e,"index",0)),a=s.filters.length;if(a<=i)throw`フィルターの個数（${String(a)}）を越えています`;t.aFltHArg[i].enabled=s.filters[i].enabled=N(e,"enabled",!0)}static#T=10;static get msecChWait(){return J.#T}#A(t){const{text:e}=t;if(!e)throw"textは必須です";const s=this.#F(t);delete t.text,this.setNormalChWait(),this.#f.isSkipping?t.wait=0:"wait"in t&&x(t,"wait",NaN),this.#n("add｜"+X(t),s);const i=N(t,"record",!0),a=this.val.doRecLog();return i||this.val.setVal_Nochk("save","sn.doRecLog",i),s.tagCh(e.replaceAll("[r]",`
`)),this.val.setVal_Nochk("save","sn.doRecLog",a),this.#n("add_close｜",s),!1}#F=t=>{throw this.#K(),0};#X(t){const e=this.#J(t,this.#S),s=this.#l[e].getPage(t);if(!(s instanceof A))throw e+"はTxtLayerではありません";return s}setNormalChWait(){J.#T=this.scrItr.normalWait}#Y=t=>{throw this.#K(),0};#q(t){const{layer:e}=t;if(!e)throw"[current] layerは必須です";const s=this.#l[e];if(!s||!(s.getPage(t)instanceof A))throw`${e}はTxtLayerではありません`;this.#j=s,this.#o.pagebreak(),this.#S=e,this.val.setVal_Nochk("save","const.sn.mesLayer",e);for(const i of this.#m){const{fore:a,back:n}=this.#l[i];a instanceof A&&(a.isCur=n.isCur=i===e)}return!1}get currentTxtlayForeNeedErr(){return this.#K(),this.currentTxtlayFore}get currentTxtlayFore(){return this.#j?this.#j.fore:null}#j=void 0;#K=()=>{throw"文字レイヤーがありません。文字表示や操作する前に、[add_lay layer=（レイヤ名） class=txt]で文字レイヤを追加して下さい"};#J(t,e=""){const s=t.layer??e;if(s.includes(","))throw"layer名に「,」は使えません";if(!(s in this.#l))throw"属性 layer【"+s+"】が不正です。レイヤーがありません";return t.layer=s,s}recPagebreak(){this.#o.pagebreak()}#Z(t){const e=this.#F(t);return t.layer===this.#S&&t.page==="fore"&&this.#o.pagebreak(),e.clearText(),!1}#tt(t){return this.#n("endlink｜",this.#F(t)),!1}#et(t){return N(t,"rec_page_break",!0)&&this.#o.pagebreak(),this.#j&&(this.#j.fore.clearLay(t),this.#j.back.clearLay(t)),!1}#st(t){if(!t.pic)throw"[graph] picは必須です";return this.#n("grp｜"+X(t),this.#F(t)),!1}#it(t){if(!t.fn&&!t.label&&!t.url)throw"fn,label,url いずれかは必須です";return t.fn??=this.scrItr.scriptFn,t.style??="background-color: rgba(255,0,0,0.5);",t.style_hover??="background-color: rgba(255,0,0,0.9);",t.style_clicked??=t.style,this.#n("link｜"+X(t),this.#F(t)),!1}#at(t){return this.#A({...t,text:`
`})}#nt(t){const{t:e,r:s}=t;if(!e)throw"[ruby2] tは必須です";if(!s)throw"[ruby2] rは必須です";return t.text="｜"+encodeURIComponent(e)+"《"+encodeURIComponent(s)+"》",delete t.t,delete t.r,this.#A(t)}#ht(t){return this.#n("span｜"+X(t),this.#F(t)),!1}#rt(t){if(!t.t)throw"[tcy] tは必須です";return this.#n("tcy｜"+X(t),this.#F(t)),!1}#lt({layer:t}){console.group("🥟 [dump_lay]");for(const e of this.#y(t)){const{fore:s,back:i}=this.#l[e];try{console.info(`%c${s.name.slice(0,-7)} %o`,`color:#${E.isDarkMode?"49F":"05A"};`,JSON.parse(`{"back":{${i.dump()}}, "fore":{${s.dump()}}}`))}catch(a){console.error("dump_lay err:%o",a),console.error(`   back:${i.dump()}`),console.error(`   fore:${s.dump()}`)}}return console.groupEnd(),!1}#ot(t){const e=this.#J(t,this.#S),s=N(t,"enabled",!0);return this.#F(t).enabled=s,this.val.setVal_Nochk("save","const.sn.layer."+e+".enabled",s),!1}#ct(t){return et.argChk_page(t,"back"),t.fn??=this.scrItr.scriptFn,this.#F(t).addButton(t),this.scrItr.recodeDesign(t),!1}record(){const t={};for(const e of this.#m){const s=this.#l[e];t[e]={cls:s.cls,fore:s.fore.record(),back:s.back.record()}}return t}playback(t){this.#o.playback();const e=[],s=[];for(const[a,{fore:n,fore:{idx:h},back:r,cls:c}]of Object.entries(t)){s.push({ln:a,idx:h});const p=this.#l[a]??=new et(a,c,this.#e,this.#a,{},this.sys,this.val,{isWait:!1});p.fore.playback(n,e),p.back.playback(r,e)}const i=this.#e.children.length;return e.push(new Promise(a=>{for(const{ln:n,idx:h}of s.sort(({idx:r},{idx:c})=>r===c?0:r<c?-1:1)){const r=this.#l[n];if(!r)continue;const c=i>h?h:i-1,{fore:p,back:o}=r;this.#e.setChildIndex(p.ctn,c),this.#a.setChildIndex(o.ctn,c)}a()})),e}}const Qt=Object.freeze(Object.defineProperty({__proto__:null,LayerMng:J},Symbol.toStringTag,{value:"Module"}));export{I as B,Qt as L,A as T};
