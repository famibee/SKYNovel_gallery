import{C as k,p as Y,G as B,q as O,E as K,f as Q,l as b,r as Z,t as tt,d as _,v as L,w as et,x as H,y as st,F as it,u as $,z as M,S as j,L as z,m as D}from"./web.js";import{k as w,_ as A}from"./CmnTween.js";import{G,D as U}from"./GrpLayer.js";import{e as I}from"./SpritesMng.js";import{T as N,a as at}from"./TxtLayer.js";import{o as rt}from"./RubySpliter.js";import{P as ht,b as J}from"./Main.js";import{a as C}from"./Reading.js";import{Button as q}from"./Button.js";import"../web.js";import"./DebugMng.js";class E{constructor(t,e,s,i,r,n,h,o){this.cls=e,this.hArg=r,this.sys=n,this.val=h,this.ret=o;const d=n.hFactoryCls[e];if(!d)throw`Â±ûÊÄß class„Äê${e}„Äë„Åå‰∏çÊ≠£„Åß„Åô`;const c=d(),l=d();c.layname=l.layname=t;const f=r[":id_tag"]=`layer:${t} cls:${e} page:`;c.ctn.name=c.name=f+"A",l.ctn.name=l.name=f+"B",s.addChild(c.ctn),i.addChild(l.ctn),_(r,"visible",!0),_(r,"visible",!0),o.isWait=c.lay(r)||l.lay(r),this.#e={fore:c,back:l},i.visible=!1;const u=`const.sn.lay.${t}`;h.setVal_Nochk("tmp",u,!0),h.defTmp(u+".fore.alpha",()=>this.#e.fore.alpha),h.defTmp(u+".back.alpha",()=>this.#e.back.alpha),h.defTmp(u+".fore.height",()=>this.#e.fore.height),h.defTmp(u+".back.height",()=>this.#e.back.height),h.defTmp(u+".fore.visible",()=>this.#e.fore.ctn.visible),h.defTmp(u+".back.visible",()=>this.#e.back.ctn.visible),h.defTmp(u+".fore.width",()=>this.#e.fore.width),h.defTmp(u+".back.width",()=>this.#e.back.width),h.defTmp(u+".fore.x",()=>this.#e.fore.x),h.defTmp(u+".back.x",()=>this.#e.back.x),h.defTmp(u+".fore.y",()=>this.#e.fore.y),h.defTmp(u+".back.y",()=>this.#e.back.y)}#e;destroy(){this.#e.fore.destroy(),this.#e.back.destroy()}lay=t=>this.getPage(t).lay(t);getPage=t=>E.argChk_page(t,"fore")!=="back"?this.#e.fore:this.#e.back;static argChk_page(t,e){const s=t.page??e;if(s==="fore"||s==="back")return t.page=s,s;throw Error("Â±ûÊÄß page„Äê"+s+"„Äë„Åå‰∏çÊ≠£„Åß„Åô")}get fore(){return this.#e.fore}get back(){return this.#e.back}transPage(t){[this.#e.back,this.#e.fore]=[this.#e.fore,this.#e.back],this.#e.back.copy(this.#e.fore,t)}}class g{constructor(t,e,s){this.appPixi=e,this.val=s,t.add_frame=i=>this.#x(i),t.let_frame=i=>this.#d(i),t.set_frame=i=>this.#N(i),t.frame=i=>this.#V(i),t.tsy_frame=i=>this.#w(i)}static#e;static#t;static#i;static init(t,e,s){g.#e=t,g.#t=e,g.#i=s}#n;setEvtMng(t){this.#n=t}#o=Object.create(null);destroy(){for(const t of Object.values(this.#o))t.parentElement.removeChild(t);this.#o=Object.create(null)}hideAllFrame(){for(const[t,{style:e}]of Object.entries(this.#o))this.#l[t]=e.display!=="none",e.display="none"}#l=Object.create(null);restoreAllFrame(){for(const[t,e]of Object.entries(this.#l)){const s=this.#o[t];s&&(s.style.display=e?"inline":"none")}this.#l=Object.create(null)}#x(t){const{id:e,src:s,alpha:i=1,scale_x:r=1,scale_y:n=1,rotate:h=0}=t;if(!e)throw"id„ÅØÂøÖÈ†à„Åß„Åô";if(!s)throw"src„ÅØÂøÖÈ†à„Åß„Åô";const o="const.sn.frm."+e;if(this.val.getVal(`tmp:${o}`))throw`frame„Äê${e}„Äë„ÅØ„Åô„Åß„Å´„ÅÇ„Çä„Åæ„Åô`;const d=_(t,"visible",!0),c=t.b_color?` background-color: ${t.b_color};`:"",l=this.#y(t);g.#i.cvs.insertAdjacentHTML("beforebegin",`<iframe id="${e}" style="opacity: ${i}; ${c} position: absolute; left:${g.#t.ofsLeft4elm+l.x*g.#t.cvsScale}px; top: ${g.#t.ofsTop4elm+l.y*g.#t.cvsScale}px; z-index: 1; border: 0px; overflow: hidden; display: ${d?"inline":"none"}; transform: scale(${r}, ${n}) rotate(${h}deg);" width="${l.width*g.#t.cvsScale}" height="${l.height*g.#t.cvsScale}"></iframe>`);const f=C.procID+`add_frame id:${e}`;C.beginProc(f);const u=g.#e.searchPath(s,j.HTML),a=new z().add({name:s,url:u,xhrType:D.XHR_RESPONSE_TYPE.TEXT});return g.#t.arg.crypto&&a.use((y,x)=>void g.#t.dec(y.extension,y.data).then(v=>{y.data=v,x()}).catch(v=>{g.#i.errScript(`[add_frame]Html „É≠„Éº„ÉâÂ§±Êïó„Åß„Åô src:${y.name} ${v}`,!1),x()})),a.load((y,x)=>{const v=document.getElementById(e);this.#o[e]=v,this.#m[e]=!1;const V=u.lastIndexOf("/")+1,m=u.slice(0,V),p=m.slice(0,V);v.srcdoc=String(x[s]?.data).replace("sn_repRes();","").replaceAll(/\s(?:src|href)=(["'])(\S+?)\1/g,(S,T,F)=>F.startsWith("../")?p+S.slice(3):S.replace("./","").replace(T,T+m)),v.srcdoc.includes("true/*WEBP*/;")&&(v.srcdoc=v.srcdoc.replaceAll(/data-src="(.+?\.)(?:jpe?g|png)/g,(S,T)=>`data-src="${T}webp`)),v.onload=()=>{C.endProc(f),this.val.setVal_Nochk("tmp",o,!0),this.val.setVal_Nochk("tmp",o+".alpha",i),this.val.setVal_Nochk("tmp",o+".x",l.x),this.val.setVal_Nochk("tmp",o+".y",l.y),this.val.setVal_Nochk("tmp",o+".scale_x",r),this.val.setVal_Nochk("tmp",o+".scale_y",n),this.val.setVal_Nochk("tmp",o+".rotate",h),this.val.setVal_Nochk("tmp",o+".width",l.width),this.val.setVal_Nochk("tmp",o+".height",l.height),this.val.setVal_Nochk("tmp",o+".visible",d);const S=v.contentWindow;this.#n.resvFlameEvent(S.document.body),S.sn_repRes?.(T=>g.#k(T.dataset.src??"",T))}}),!0}#m={};getFrmDisabled(t){return this.#m[t]}#y(t){const e={...t};return new DOMRect(b(e,"x",0),b(e,"y",0),b(e,"width",k.stageW),b(e,"height",k.stageH))}static#k(t,e,s){const i=this.#f[t];if(i){e.src=i,s&&(e.onload=()=>s(e));return}const r=this.#p[t];if(r){r.push(e);return}this.#p[t]=[e];const[n="",h=""]=t.split("?"),o=g.#e.searchPath(n,j.SP_GSM),d=new z().add({name:t,url:o,xhrType:D.XHR_RESPONSE_TYPE.BUFFER});g.#t.use4ViteElectron(t,o,d,g.#i)||g.#t.arg.crypto&&o.endsWith(".bin")&&d.use((c,l)=>{if(c.extension!=="bin"){l();return}g.#t.decAB(c.data).then(f=>{c.data=f,f instanceof HTMLImageElement&&(c.type=D.TYPE.IMAGE),l()}).catch(f=>{g.#i.errScript(`FrameMng loadPic „É≠„Éº„ÉâÂ§±Êïó„Åß„Åô fn:${c.name} ${f}`,!1),l()})}),d.load((c,l)=>{for(const[f,{data:{src:u}}]of Object.entries(l)){const a=this.#f[f]=u+(u.startsWith("blob:")||u.startsWith("data:")?"":h?"?"+h:""),y=this.#p[f];if(y)for(const x of y)x.src=a,s&&(x.onload=()=>s(x));delete this.#p[f]}})}static#p={};static#f={};cvsResize(){for(const[t,e]of Object.entries(this.#o)){const s="const.sn.frm."+t,i=Number(this.val.getVal(s+".x")),r=Number(this.val.getVal(s+".y")),n=Number(this.val.getVal(s+".width")),h=Number(this.val.getVal(s+".height"));e.style.left=`${g.#t.ofsLeft4elm+i*g.#t.cvsScale}px`,e.style.top=`${g.#t.ofsTop4elm+r*g.#t.cvsScale}px`,e.width=String(n*g.#t.cvsScale),e.height=String(h*g.#t.cvsScale)}}#d(t){const{id:e,var_name:s}=t;if(!e)throw"id„ÅØÂøÖÈ†à„Åß„Åô";const i=document.getElementById(e);if(!i)throw`id„Äê${e}„Äë„ÅØ„Éï„É¨„Éº„É†„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì`;const r="const.sn.frm."+e;if(!this.val.getVal(`tmp:${r}`))throw`frame„Äê${e}„Äë„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì`;if(!s)throw"var_name„ÅØÂøÖÈ†à„Åß„Åô";const n=i.contentWindow;if(!Object.hasOwn(n,s))throw`frame„Äê${e}„Äë„Å´Â§âÊï∞/Èñ¢Êï∞„Äê${s}„Äë„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÂ§âÊï∞„ÅØ var‰ªò„Åç„Å´„Åó„Å¶‰∏ã„Åï„ÅÑ`;const h=n[s];return this.val.setVal_Nochk("tmp",r+"."+s,_(t,"function",!1)?h():h),!1}#N(t){const{id:e,var_name:s,text:i}=t;if(!e)throw"id„ÅØÂøÖÈ†à„Åß„Åô";const r=document.getElementById(e);if(!r)throw`id„Äê${e}„Äë„ÅØ„Éï„É¨„Éº„É†„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì`;const n="const.sn.frm."+e;if(!this.val.getVal(`tmp:${n}`))throw`frame„Äê${e}„Äë„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì`;if(!s)throw"var_name„ÅØÂøÖÈ†à„Åß„Åô";if(!i)throw"text„ÅØÂøÖÈ†à„Åß„Åô";this.val.setVal_Nochk("tmp",n+"."+s,i);const h=r.contentWindow;return h[s]=i,!1}#r=1;#V(t){const{id:e}=t;if(!e)throw"id„ÅØÂøÖÈ†à„Åß„Åô";const s=document.getElementById(e);if(!s)throw`id„Äê${e}„Äë„ÅØ„Éï„É¨„Éº„É†„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì`;const i="const.sn.frm."+e;if(!this.val.getVal("tmp:"+i))throw`frame„Äê${e}„Äë„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì`;const r=s.style;if(_(t,"float",!1)?r.zIndex=`${++this.#r}`:"index"in t?r.zIndex=`${b(t,"index",0)}`:t.dive&&(r.zIndex=`-${++this.#r}`),"alpha"in t){const h=r.opacity=String(t.alpha);this.val.setVal_Nochk("tmp",i+".alpha",h)}const n=this.#y(t);if(("x"in t||"y"in t)&&(r.left=`${g.#t.ofsLeft4elm+n.x*g.#t.cvsScale}px`,r.top=`${g.#t.ofsTop4elm+n.y*g.#t.cvsScale}px`,this.val.setVal_Nochk("tmp",i+".x",n.x),this.val.setVal_Nochk("tmp",i+".y",n.y)),"scale_x"in t||"scale_y"in t||"rotate"in t){const h=b(t,"scale_x",1),o=b(t,"scale_y",1),d=b(t,"rotate",0);r.transform=`scale(${h}, ${o}) rotate(${d}deg)`,this.val.setVal_Nochk("tmp",i+".scale_x",h),this.val.setVal_Nochk("tmp",i+".scale_y",o),this.val.setVal_Nochk("tmp",i+".rotate",d)}if("width"in t&&(s.width=String(n.width*g.#t.cvsScale),this.val.setVal_Nochk("tmp",i+".width",n.width)),"height"in t&&(s.height=String(n.height*g.#t.cvsScale),this.val.setVal_Nochk("tmp",i+".height",n.height)),"visible"in t){const h=_(t,"visible",!0);r.display=h?"inline":"none",this.val.setVal_Nochk("tmp",i+".visible",h)}if("b_color"in t&&(r.backgroundColor=t.b_color),"disabled"in t){const h=this.#m[e]=_(t,"disabled",!0),o=s.contentDocument.body;for(const d of[...Array.from(o.getElementsByTagName("input")),...Array.from(o.getElementsByTagName("select"))])d.disabled=h}return!1}#w(t){const{id:e,alpha:s,x:i,y:r,scale_x:n,scale_y:h,rotate:o,width:d,height:c}=t;if(!e)throw"id„ÅØÂøÖÈ†à„Åß„Åô";const l=document.getElementById(e);if(!l)throw`id„Äê${e}„Äë„ÅØ„Éï„É¨„Éº„É†„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì`;const f="const.sn.frm."+e;if(!this.val.getVal(`tmp:${f}`,0))throw`frame„Äê${e}„Äë„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì`;const u={};s&&(u.a=Number(l.style.opacity)),(i||r||n||h||o)&&(u.x=Number(this.val.getVal(`tmp:${f}.x`)),u.y=Number(this.val.getVal(`tmp:${f}.y`)),u.sx=Number(this.val.getVal(`tmp:${f}.scale_x`)),u.sy=Number(this.val.getVal(`tmp:${f}.scale_y`)),u.r=Number(this.val.getVal(`tmp:${f}.rotate`))),d&&(u.w=Number(this.val.getVal(`tmp:${f}.width`))),c&&(u.h=Number(this.val.getVal(`tmp:${f}.height`)));const a=w.cnvTweenArg(t,u);let y=p=>{};s&&(b(a,"alpha",0),y=p=>{l.style.opacity=String(p.a),this.val.setVal_Nochk("tmp","alpha",p.a)});let x=p=>{};const v=this.#y(a);(i||r||n||h||o)&&(v.x,v.y,b(a,"scale_x",1),b(a,"scale_y",1),b(a,"rotate",0),x=p=>{l.style.left=`${g.#t.ofsLeft4elm+p.x*g.#t.cvsScale} px`,l.style.top=`${g.#t.ofsTop4elm+p.y*g.#t.cvsScale} px`,l.style.transform=`scale(${p.sx}, ${p.sy}) rotate(${p.r}deg)`,this.val.setVal_Nochk("tmp",f+".x",p.x),this.val.setVal_Nochk("tmp",f+".y",p.y),this.val.setVal_Nochk("tmp",f+".scale_x",p.sx),this.val.setVal_Nochk("tmp",f+".scale_y",p.sy),this.val.setVal_Nochk("tmp",f+".rotate",p.r)});let V=p=>{};d&&(v.width,V=p=>{l.width=`${p.w*g.#t.cvsScale} px`,this.val.setVal_Nochk("tmp",f+".width",p.w)});let m=p=>{};return c&&(v.height,m=p=>{l.height=`${p.h*g.#t.cvsScale} px`,this.val.setVal_Nochk("tmp",f+".height",p.h)}),this.appPixi.stage.interactive=!1,w.tween(`frm
${e}`,t,u,w.cnvTweenArg(t,u),p=>{y(p),x(p),V(p),m(p)},()=>{this.appPixi.stage.interactive=!0},()=>{}),!1}}class nt{constructor(t,e,s){this.oCfg=t,this.hTag=e,this.val=s,e.rec_ch=i=>this.#i(i),e.rec_r=i=>this.#n(i),e.reset_rec=i=>this.#o(i),s.defTmp("const.sn.log.json",()=>{this.#e.text=this.#e.text.replaceAll("</span><span class='sn_ch'>","");const i=[...this.#t,this.#e];return JSON.stringify(i)}),this.recText("")}#e={text:""};#t=[];recText(t){this.#e.text=t,this.val.setVal_Nochk("save","const.sn.sLog",String(this.val.getVal("const.sn.log.json")))}#i(t){return this.#e={...t,text:this.#e.text},t.text?(t.record=!0,t.style??="",t.style+="display: none;",t.wait=0,this.hTag.ch(t)):(this.val.setVal_Nochk("save","const.sn.sLog",String(this.val.getVal("const.sn.log.json"))),!1)}#n(t){return this.#i({...t,text:"[r]"})}#o(t){return this.#t=[],t.text??="",this.#e={text:t.text},this.val.setVal_Nochk("save","const.sn.sLog",JSON.stringify([this.#e])),!1}pagebreak(){this.#e.text=this.#e.text.replaceAll("</span><span class='sn_ch'>",""),this.#e.text&&(this.#t.push(this.#e)>this.oCfg.log.max_len&&(this.#t=this.#t.slice(-this.oCfg.log.max_len)),this.#e={text:""})}playback(){this.#t=JSON.parse(String(this.val.getVal("save:const.sn.sLog"))),this.#e={text:""}}}function P(R){return encodeURIComponent(JSON.stringify(R))}class X{constructor(t,e,s,i,r,n,h,o,d){this.cfg=t,this.hTag=e,this.appPixi=s,this.val=i,this.main=r,this.scrItr=n,this.sys=h;const c=()=>{if(h.cvsResize(),this.cvsResizeDesign(),this.#k)for(const a of this.#h)this.#s[a].fore.cvsResizeChildren();else for(const a of this.#h)this.#s[a].fore.cvsResize();this.#n.cvsResize(),this.#d.cvsResize()};if(k.isMobile)this.#x.add(globalThis,"orientationchange",c,{passive:!0});else{let a;this.#x.add(globalThis,"resize",()=>{a||(a=setTimeout(()=>{a=void 0,c()},1e3/60*10))},{passive:!0})}h.cvsResize(),this.#l=new nt(this.cfg.oCfg,e,i),N.init(t,e,i,this.#l,a=>this.#s[a.layname].fore===a,s),G.init(r,t,s,h,o,i),g.init(t,h,r),this.#n=new g(e,s,i),e.loadplugin=a=>this.#W(a),e.snapshot=a=>this.#V(a),this.#w=this.sys.isApp?(a,y,x,v,V)=>this.#D(a,y,x,v,V):(a,y,x,v,V)=>this.#R(a,y,x,v,V),e.add_lay=a=>this.#B(a),e.clear_lay=a=>this.#H(a),e.finish_trans=()=>!1,e.lay=a=>this.#O(a),e.trans=a=>this.#j(a),e.wt=a=>w.wt(a),e.quake=a=>this.#G(a),e.stop_quake=e.finish_trans,e.wq=e.wt,e.pause_tsy=a=>w.pause_tsy(a),e.resume_tsy=a=>w.resume_tsy(a),e.stop_tsy=a=>w.stop_tsy(a),e.tsy=a=>this.#U(a),e.wait_tsy=a=>w.wait_tsy(a),e.add_filter=a=>this.#J(a),e.clear_filter=a=>this.#q(a),e.enable_filter=a=>this.#X(a),e.ch=a=>this.#I(a),e.clear_text=a=>this.#Q(a),e.current=a=>this.#$(a),e.endlink=a=>this.#Z(a),e.er=a=>this.#tt(a),e.graph=a=>this.#et(a),e.link=a=>this.#st(a),e.r=a=>this.#it(a),e.ruby2=a=>this.#at(a),e.span=a=>this.#rt(a),e.tcy=a=>this.#ht(a),e.add_face=a=>I.add_face(a),e.wv=a=>I.wv(a),e.dump_lay=a=>this.#nt(a),e.enable_event=a=>this.#ot(a),e.button=a=>this.#lt(a),t.existsBreakline&&(this.breakLine=a=>{delete a.visible,a.id="break",a.pic="breakline",this.#r("grpÔΩú"+P(a))}),t.existsBreakpage&&(this.breakPage=a=>{delete a.visible,a.id="break",a.pic="breakpage",this.#r("grpÔΩú"+P(a))}),this.#o=Y(String(t.oCfg.init.bg_color));const l=new B;l.beginFill(this.#o).lineStyle(0,this.#o).drawRect(0,0,k.stageW,k.stageH).endFill(),this.#t.addChild(l.clone()),this.#i.addChild(l),this.#i.visible=!1,this.#t.name="page:A",this.#i.name="page:B",this.#e=s.stage,this.#e.addChild(this.#i),this.#e.addChild(this.#t),this.#e.addChild(this.#F),this.#e.addChild(this.#a),this.#e.name="stage";const f=(a,y)=>{this.#N(Number(y))};f("",i.getVal("sys:TextLayer.Back.Alpha",1)),i.defValTrg("sys:TextLayer.Back.Alpha",f);const u=(a,y)=>{q.fontFamily=y};u("",i.getVal("tmp:sn.button.fontFamily",q.fontFamily)),i.defValTrg("tmp:sn.button.fontFamily",u),i.defTmp("const.sn.last_page_text",()=>this.currentTxtlayFore?.pageText??""),i.defTmp("const.sn.last_page_plain_text",()=>this.currentTxtlayFore?.pagePlainText??""),k.isDbg&&(U.init(s,h,n,d,t,this.#s),this.cvsResizeDesign=()=>U.cvsResizeDesign(),h.addHook((a,y)=>{this.#m[a]?.(a,y)&&delete this.#m[a]}))}#e;#t=new O;#i=new O;#n;#o;#l;#x=new K;cvsResizeDesign(){}#m={attach:t=>!1,continue:t=>!1,disconnect:t=>!1,_enterDesign:t=>{for(const e of this.#h){const s=this.#s[e].fore;s.makeDesignCastChildren(i=>i.make()),s.makeDesignCast(i=>i.make())}return this.#p(this.#v),!1},_replaceToken:(t,e)=>!1,_selectNode:(t,e)=>(this.#p(e.node),!1)};#y="";#k="";#p(t){[this.#y="",this.#k=""]=t.split("/");const e=this.#s[this.#y];e&&(this.#k?e.fore.showDesignCastChildren():e.fore.showDesignCast())}getFrmDisabled=t=>this.#n.getFrmDisabled(t);#f=void 0;cover(t,e=0){this.#f&&(this.#e.removeChild(this.#f),this.#f.destroy(),this.#f=void 0),t&&this.#e.addChild((this.#f=new B).beginFill(e).lineStyle(0,e).drawRect(0,0,k.stageW,k.stageH).endFill())}#d;setEvtMng(t){this.#d=t,this.#n.setEvtMng(t),I.setEvtMng(t),w.init(t,this.appPixi)}destroy(){for(const t of Object.values(this.#s))t.destroy();this.#x.clear(),G.destroy(),rt.destroy(),at.destroy(),N.destroy(),this.#n.destroy(),w.destroy(),N.msecChWait=10}#N(t){for(const e of this.#h){const{fore:s,back:i}=this.#s[e];s instanceof N&&(s.chgBackAlpha(t),i.chgBackAlpha(t))}}#r=(t,e=this.currentTxtlayForeNeedErr,s=!0)=>e.tagCh("ÔΩú&emsp;„Ää"+t+"„Äã");goTxt=()=>{};get needGoTxt(){return this.currentTxtlayFore?.needGoTxt??!1}breakLine=t=>{};breakPage=t=>{};clearBreak(){this.currentTxtlayFore&&(this.clearBreak=()=>this.#r("delÔΩúbreak"),this.clearBreak())}clickTxtLay(){return this.currentTxtlayFore?this.#h.map(t=>this.#s[t].fore).some(t=>t instanceof N&&t.click()):!1}#V(t){const e=Q("-","_","","_"),s=t.fn?t.fn.startsWith(ht)?t.fn:`${J+t.fn+e}.png`:`${J}snapshot${e}.png`,i=this.cfg.searchPath(s),r=b(t,"width",k.stageW),n=b(t,"height",k.stageH);return this.#w(t,i,r,n,`snapshot dt:${e}`)}#w=()=>!1;#D({layer:t},e,s,i,r){if(this.#n.hideAllFrame(),C.beginProc(r),!t)return this.sys.capturePage(e,s,i,()=>{this.#n.restoreAllFrame(),C.endProc(r)}),!0;const n=this.#h.map(h=>{const{ctn:o}=this.#s[h].fore,d=[o,o.visible];return o.visible=!1,d});for(const h of this.#g(t))this.#s[h].fore.ctn.visible=!0;return this.sys.capturePage(e,s,i,()=>{for(const[h,o]of n)h.visible=o;this.#n.restoreAllFrame(),C.endProc(r)}),!0}#R(t,e,s,i,r){C.beginProc(r);const n=Z(t,"b_color",this.#o),h=tt({width:s,height:i,backgroundAlpha:n>16777216&&e.endsWith(".png")?0:1,antialias:_(t,"smoothing",!1),preserveDrawingBuffer:!0,backgroundColor:n&16777215,autoDensity:!0}),o=t.page!=="back"?"fore":"back",{layer:d}=t;return Promise.allSettled(this.#g(d).map(c=>new Promise(l=>this.#s[c][o].snapshot(h,l)))).then(async()=>{const c=L.create({width:h.width,height:h.height});h.render(this.#e,{renderTexture:c}),await this.sys.savePic(e,h.plugins.extract.base64(c)),c.destroy();for(const l of this.#g(d))this.#s[l][o].snapshot_end();h.destroy(!0),C.endProc(r)}),!0}#W(t){const{fn:e}=t;if(!e)throw"fn„ÅØÂøÖÈ†à„Åß„Åô";if(!e.endsWith(".css"))throw"„Çµ„Éù„Éº„Éà„Åï„Çå„Å™„ÅÑÊã°ÂºµÂ≠ê„Åß„Åô";const s=_(t,"join",!0),i=C.procID+`loadplugin fn:${e}`;return s&&C.beginProc(i),(async()=>{const r=await fetch(e);if(!r.ok)throw new Error("Network response was not ok.");et(await r.text()),s&&C.endProc(i)})(),s}#B(t){const{layer:e,class:s}=t;if(!e)throw"layer„ÅØÂøÖÈ†à„Åß„Åô";if(e.includes(","))throw"layerÂêç„Å´„Äå,„Äç„ÅØ‰Ωø„Åà„Åæ„Åõ„Çì";if(e in this.#s)throw`layer„Äê${e}„Äë„ÅØ„Åô„Åß„Å´„ÅÇ„Çä„Åæ„Åô`;if(!s)throw"cls„ÅØÂøÖÈ†à„Åß„Åô";const i={isWait:!1};switch(this.#s[e]=new E(e,s,this.#t,this.#i,t,this.sys,this.val,i),this.#h.push(e),s){case"txt":this.#v||(this.#C=()=>{},this.#c=r=>this.#Y(r),this.#$=r=>this.#K(r),this.hTag.current({layer:e}),this.goTxt=()=>{this.#d.isSkipping?N.msecChWait=0:this.setNormalChWait();for(const r of this.#h){const n=this.#s[r].fore;n instanceof N&&this.#r("gotxtÔΩú",n,!1)}}),this.val.setVal_Nochk("save","const.sn.layer."+e+".enabled",!0);break;case"grp":if(this.#L)break;this.#L=e;break}return this.scrItr.recodeDesign(t),i.isWait}#s={};#h=[];#v="";#L="";#O(t){const e=this.#u(t),s=this.#s[e],i=s.back.ctn,r=s.fore.ctn;if(_(t,"float",!1))this.#i.setChildIndex(i,this.#i.children.length-1),this.#t.setChildIndex(r,this.#t.children.length-1),this.#S();else if(t.index)b(t,"index",0)&&(this.#i.setChildIndex(i,t.index),this.#t.setChildIndex(r,t.index),this.#S());else if(t.dive){const{dive:n}=t;let h=0;if(e===n)throw"[lay] Â±ûÊÄß layer„Å®dive„ÅåÂêå„Åò„Äê"+n+"„Äë„Åß„Åô";const o=this.#s[n];if(!o)throw"[lay] Â±ûÊÄß dive„Äê"+n+"„Äë„Åå‰∏çÊ≠£„Åß„Åô„ÄÇ„É¨„Ç§„É§„Éº„Åå„ÅÇ„Çä„Åæ„Åõ„Çì";const d=o.back,c=o.fore,l=this.#i.getChildIndex(d.ctn),f=this.#t.getChildIndex(c.ctn);h=l<f?l:f,h>this.#i.getChildIndex(i)&&--h,this.#t.setChildIndex(r,h),this.#i.setChildIndex(i,h),this.#S()}return t[":id_tag"]=s.fore.name.slice(0,-7),this.scrItr.recodeDesign(t),s.lay(t)}#S(){this.#h=this.#z()}#H(t){return this.#T(t,e=>{const s=this.#s[this.#u({layer:e})];if(t.page==="both"){s.fore.clearLay(t),s.back.clearLay(t);return}s.getPage(t).clearLay(t)}),!1}static#M=`
precision mediump float;

varying vec2 vTextureCoord;
uniform sampler2D uSampler;

uniform sampler2D rule;
uniform float vague;
uniform float tick;

uniform vec4 inputPixel;
uniform highp vec4 outputFrame;
vec2 getUV(vec2 coord) {
	return coord * inputPixel.xy / outputFrame.zw;
}

void main() {
	vec4 fg = texture2D(uSampler, vTextureCoord);
	vec4 ru = texture2D(rule, getUV(vTextureCoord));

	float v = ru.r - tick;
	gl_FragColor = abs(v) < vague
		? vec4(fg.rgb, 1) *fg.a *(0.5 +v /vague *0.5)
		: 0.0 <= v ? fg : vec4(0);
}`;#P=L.create({width:k.stageW,height:k.stageH});#F=new H(this.#P);#_=L.create({width:k.stageW,height:k.stageH});#a=new H(this.#_);#j(t){const{layer:e}=t,s=new Set,i=this.#g(e).map(m=>(s.add(m),this.#s[m].fore)),r=()=>{[this.#t,this.#i]=[this.#i,this.#t];const m=[];for(const[p,S]of Object.entries(this.#s)){if(s.has(p)){S.transPage(m);continue}const{fore:{ctn:T},back:{ctn:F}}=S,W=this.#t.getChildIndex(F);this.#t.removeChild(F),this.#i.removeChild(T),this.#t.addChildAt(T,W),this.#i.addChildAt(F,W)}Promise.allSettled(m).then(()=>{this.#t.visible=!0,this.#i.visible=!1,this.#F.visible=!1,this.#a.visible=!1,C.notifyEndProc(A)})};if(this.#a.filters=[],this.#a.alpha=1,b(t,"time",0)===0||this.#d.isSkipping)return r(),!1;const n=[],h=this.#h.map(m=>{const{fore:p,back:S}=this.#s[m],T=s.has(m)?S:p;return T.ctn.visible&&n.push(T.ctn),T}),{ticker:o,renderer:d}=this.appPixi;d.render(this.#i,{renderTexture:this.#P});let c=()=>{for(const m of n)d.render(m,{renderTexture:this.#P,clear:!1})};if(!h.some(m=>m.containMovement)){const m=c;c=()=>{c=()=>{},m()}}const l=()=>d.render(this.#t,{renderTexture:this.#_});l();let f=()=>{this.#t.visible=!0,l(),this.#t.visible=!1};if(!i.some(m=>m.containMovement)){const m=f;f=()=>{f=()=>{},m()}}const u=()=>{c(),this.#F.visible=!0,f(),this.#a.visible=!0},{glsl:a,rule:y}=t,x=()=>{o.remove(u),r()};if(!a&&!y)return w.tween(A,t,this.#a,{alpha:0},()=>{},x,()=>{}),o.add(u),!1;const v={rule:st.EMPTY,vague:b(t,"vague",.04),tick:0};this.#a.filters=[new it(void 0,a??X.#M,v)];const V=w.tween(A,t,v,{tick:1},()=>{},x,()=>{},!y);return y?new I(y,void 0,m=>{v.rule=m.texture,m.destroy(),V.start(),o.add(u)},m=>{m&&this.main.resume()}).ret:(o.add(u),!1)}#g(t=""){return t?t.split(","):this.#h}#T(t,e){const s=this.#g(t.layer);for(const i of s){const r=this.#s[i];if(!r)throw`Â≠òÂú®„Åó„Å™„ÅÑlayer„Äê${i}„Äë„Åß„Åô`;e(i,r)}return s}#z(t=""){return this.#g(t).sort((e,s)=>{const i=this.#t.getChildIndex(this.#s[e].fore.ctn),r=this.#t.getChildIndex(this.#s[s].fore.ctn);return i<r?-1:i>r?1:0})}setAllStyle2TxtLay(t){for(const e of this.#h){const s=this.#s[e].fore;s instanceof N&&s.lay({style:t})}}#G(t){if(b(t,"time",NaN)===0)return!1;const e=this.#g(t.layer).map(c=>this.#s[c].fore.ctn),{renderer:s,ticker:i}=this.appPixi;this.#_.resize(k.stageW,k.stageH);const r=()=>{this.#t.visible=!0;for(const c of e)s.render(c,{renderTexture:this.#_,clear:!1});this.#t.visible=!1};this.#a.visible=!0,this.#a.alpha=1;const n=$(b(t,"hmax",10)),h=$(b(t,"vmax",10)),o=n===0?()=>{}:()=>{this.#a.x=Math.round(Math.random()*n*2)-n},d=h===0?()=>{}:()=>{this.#a.y=Math.round(Math.random()*h*2)-h};return this.#a.filters=[],w.tween(A,t,this.#a,{x:0,y:0},()=>{o(),d()},()=>{i.remove(r),this.#t.visible=!0,this.#a.visible=!1,this.#a.x=0,this.#a.y=0,C.notifyEndProc(A)},()=>{}),i.add(r),!1}#U(t){const{layer:e,render:s,name:i}=t;if(!e)throw"layer„ÅØÂøÖÈ†à„Åß„Åô";const r=this.#s[this.#u(t)],n=r.fore;let h=()=>{};s&&(this.#d.isSkipping?n.renderStart(!0):(n.renderStart(!1),h=()=>n.renderEnd()));const o=w.cnvTweenArg(t,n),d=_(t,"arrive",!1),c=_(t,"backlay",!1),l=r.back.ctn;return w.tween(i??e,t,n,w.cnvTweenArg(t,n),()=>{},h,()=>{if(d&&Object.assign(n,o),c)for(const f of w.aLayerPrpNm)l[f]=n[f]}),"filter"in t&&(n.ctn.filters=[M.bldFilters(t)],n.aFltHArg=[t]),!1}#J(t){return this.#T(t,e=>{const s=this.#s[this.#u({layer:e})];if(t.page==="both"){this.#A(s.fore,t),this.#A(s.back,t);return}const i=s.getPage(t);this.#A(i,t)}),!1}#A(t,e){const s=t.ctn;s.filters??=[],s.filters=[...s.filters,M.bldFilters(e)],t.aFltHArg.push(e)}#q(t){return this.#T(t,e=>{const s=this.#s[this.#u({layer:e})];if(t.page==="both"){const r=s.fore,n=s.back;r.ctn.filters=null,n.ctn.filters=null,r.aFltHArg=[],n.aFltHArg=[];return}const i=s.getPage(t);i.ctn.filters=null,i.aFltHArg=[]}),!1}#X(t){return this.#T(t,e=>{const s=this.#s[this.#u({layer:e})];if(t.page==="both"){this.#E(s.fore,t),this.#E(s.back,t);return}const i=s.getPage(t);this.#E(i,t)}),!1}#E(t,e){const s=t.ctn;if(!s.filters)throw"„Éï„Ç£„É´„Çø„Éº„Åå„ÅÇ„Çä„Åæ„Åõ„Çì";const i=$(b(e,"index",0)),r=s.filters.length;if(r<=i)throw`„Éï„Ç£„É´„Çø„Éº„ÅÆÂÄãÊï∞Ôºà${String(r)}Ôºâ„ÇíË∂ä„Åà„Å¶„ÅÑ„Åæ„Åô`;t.aFltHArg[i].enabled=s.filters[i].enabled=_(e,"enabled",!0)}#I(t){const{text:e}=t;if(!e)throw"text„ÅØÂøÖÈ†à„Åß„Åô";const s=this.#c(t);delete t.text,this.setNormalChWait(),this.#d.isSkipping?t.wait=0:"wait"in t&&b(t,"wait",NaN),this.#r("addÔΩú"+P(t),s);const i=_(t,"record",!0),r=this.val.doRecLog();return i||this.val.setVal_Nochk("save","sn.doRecLog",i),s.tagCh(e.replaceAll("[r]",`
`)),this.val.setVal_Nochk("save","sn.doRecLog",r),this.#r("add_closeÔΩú",s),!1}#c=t=>{throw this.#C(),0};#Y(t){const e=this.#u(t,this.#v),s=this.#s[e].getPage(t);if(!(s instanceof N))throw e+"„ÅØTxtLayer„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì";return s}setNormalChWait(){N.msecChWait=this.scrItr.normalWait}#$=t=>{throw this.#C(),0};#K(t){const{layer:e}=t;if(!e)throw"[current] layer„ÅØÂøÖÈ†à„Åß„Åô";const s=this.#s[e];if(!s||!(s.getPage(t)instanceof N))throw`${e}„ÅØTxtLayer„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì`;this.#b=s,this.#l.pagebreak(),this.#v=e,this.val.setVal_Nochk("save","const.sn.mesLayer",e);for(const i of this.#h){const{fore:r,back:n}=this.#s[i];r instanceof N&&(r.isCur=n.isCur=i===e)}return!1}get currentTxtlayForeNeedErr(){return this.#C(),this.currentTxtlayFore}get currentTxtlayFore(){return this.#b?this.#b.fore:null}#b=void 0;#C=()=>{throw"ÊñáÂ≠ó„É¨„Ç§„É§„Éº„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÊñáÂ≠óË°®Á§∫„ÇÑÊìç‰Ωú„Åô„ÇãÂâç„Å´„ÄÅ[add_lay layer=Ôºà„É¨„Ç§„É§ÂêçÔºâ class=txt]„ÅßÊñáÂ≠ó„É¨„Ç§„É§„ÇíËøΩÂä†„Åó„Å¶‰∏ã„Åï„ÅÑ"};#u(t,e=""){const s=t.layer??e;if(s.includes(","))throw"layerÂêç„Å´„Äå,„Äç„ÅØ‰Ωø„Åà„Åæ„Åõ„Çì";if(!(s in this.#s))throw"Â±ûÊÄß layer„Äê"+s+"„Äë„Åå‰∏çÊ≠£„Åß„Åô„ÄÇ„É¨„Ç§„É§„Éº„Åå„ÅÇ„Çä„Åæ„Åõ„Çì";return t.layer=s,s}recPagebreak(){this.#l.pagebreak()}#Q(t){const e=this.#c(t);return t.layer===this.#v&&t.page==="fore"&&this.#l.pagebreak(),e.clearText(),!1}#Z(t){return this.#r("endlinkÔΩú",this.#c(t)),!1}#tt(t){return _(t,"rec_page_break",!0)&&this.#l.pagebreak(),this.#b&&(this.#b.fore.clearLay(t),this.#b.back.clearLay(t)),!1}#et(t){if(!t.pic)throw"[graph] pic„ÅØÂøÖÈ†à„Åß„Åô";return this.#r("grpÔΩú"+P(t),this.#c(t)),!1}#st(t){if(!t.fn&&!t.label&&!t.url)throw"fn,label,url „ÅÑ„Åö„Çå„Åã„ÅØÂøÖÈ†à„Åß„Åô";return t.fn??=this.scrItr.scriptFn,t.style??="background-color: rgba(255,0,0,0.5);",t.style_hover??="background-color: rgba(255,0,0,0.9);",t.style_clicked??=t.style,this.#r("linkÔΩú"+P(t),this.#c(t)),!1}#it(t){return this.#I({...t,text:`
`})}#at(t){const{t:e,r:s}=t;if(!e)throw"[ruby2] t„ÅØÂøÖÈ†à„Åß„Åô";if(!s)throw"[ruby2] r„ÅØÂøÖÈ†à„Åß„Åô";return t.text="ÔΩú"+encodeURIComponent(e)+"„Ää"+encodeURIComponent(s)+"„Äã",delete t.t,delete t.r,this.#I(t)}#rt(t){return this.#r("spanÔΩú"+P(t),this.#c(t)),!1}#ht(t){if(!t.t)throw"[tcy] t„ÅØÂøÖÈ†à„Åß„Åô";return this.#r("tcyÔΩú"+P(t),this.#c(t)),!1}#nt({layer:t}){console.group("ü•ü [dump_lay]");for(const e of this.#g(t)){const{fore:s,back:i}=this.#s[e];try{console.info(`%c${s.name.slice(0,-7)} %o`,`color:#${k.isDarkMode?"49F":"05A"};`,JSON.parse(`{"back":{${i.dump()}}, "fore":{${s.dump()}}}`))}catch(r){console.error("dump_lay err:%o",r),console.error(`   back:${i.dump()}`),console.error(`   fore:${s.dump()}`)}}return console.groupEnd(),!1}#ot(t){const e=this.#u(t,this.#v),s=_(t,"enabled",!0);return this.#c(t).enabled=s,this.val.setVal_Nochk("save","const.sn.layer."+e+".enabled",s),!1}#lt(t){return E.argChk_page(t,"back"),t.fn??=this.scrItr.scriptFn,this.#c(t).addButton(t),this.scrItr.recodeDesign(t),!1}record(){const t={};for(const e of this.#h){const s=this.#s[e];t[e]={cls:s.cls,fore:s.fore.record(),back:s.back.record()}}return t}playback(t){this.#l.playback();const e=[],s=[];for(const[r,{fore:n,fore:{idx:h},back:o,cls:d}]of Object.entries(t)){s.push({ln:r,idx:h});const c=this.#s[r]??=new E(r,d,this.#t,this.#i,{},this.sys,this.val,{isWait:!1});c.fore.playback(n,e),c.back.playback(o,e)}const i=this.#t.children.length;return e.push(new Promise(r=>{for(const{ln:n,idx:h}of s.sort(({idx:o},{idx:d})=>o===d?0:o<d?-1:1)){const o=this.#s[n];if(!o)continue;const d=i>h?h:i-1,{fore:c,back:l}=o;this.#t.setChildIndex(c.ctn,d),this.#i.setChildIndex(l.ctn,d)}r()})),e}}export{X as LayerMng};
