import{z as K,M as lt,w as U,S as tt,d as N,u as P,q as L,C as j,l as k,r as ot,G as O,x as q,R as et,N as G,y as ct}from"./web.js";import{k as dt}from"./CmnTween.js";import{e as B}from"./SpritesMng.js";import{t as V}from"./DebugMng.js";import{a as H,W as pt}from"./Reading.js";import{o as st}from"./RubySpliter.js";import{Button as gt}from"./Button.js";import"../web.js";const z="„ÄÅ„ÄÇÔºåÔºéÔºâÔºΩÔΩù„Äâ„Äç„Äè„Äë„Äï‚Äù„Äü„ÅÅ„ÅÉ„ÅÖ„Åá„Åâ„Å£„ÇÉ„ÇÖ„Çá„Çé„Ç°„Ç£„Ç•„Çß„Ç©„ÉÉ„É£„É•„Éß„ÉÆ„Éµ„É∂ÔºÅÔºü!?‚Äº‚Åâ„Éª„Éº„Çù„Çû„ÉΩ„Éæ„ÄÖ",W="ÔºªÔºàÔΩõ„Äà„Äå„Äé„Äê„Äî‚Äú„Äù",I="‚îÄ‚Ä•‚Ä¶",X=z,it=new RegExp(`[${z}]`),ut=new RegExp(`[${W}]`),ft=new RegExp(`[${I}]`),yt=it;class mt{#c=z;#n=W;#l=I;#a=X;get Ë°åÈ†≠Á¶ÅÂâá(){return this.#c}get Ë°åÊú´Á¶ÅÂâá(){return this.#n}get ÂàÜÂâ≤Á¶ÅÊ≠¢(){return this.#l}get „Å∂„Çâ‰∏ã„Åí(){return this.#a}#e=it;#h=ut;#p=ft;#S=yt;break_fixed=!1;break_fixed_left=0;break_fixed_top=0;bura=!1;lay(t){t.kinsoku_sol&&(this.#c=t.kinsoku_sol,this.#e=new RegExp(`[${this.#c}]`)),t.kinsoku_eol&&(this.#n=t.kinsoku_eol,this.#r(),this.#h=new RegExp(`[${this.#n}]`)),t.kinsoku_dns&&(this.#l=t.kinsoku_dns,this.#f(),this.#p=new RegExp(`[${this.#l}]`)),t.kinsoku_bura&&(this.#a=t.kinsoku_bura,this.#r(),this.#f(),this.#S=new RegExp(`[${this.#a}]`)),"bura"in t&&(this.bura=N(t,"bura",!1)),this.break_fixed=N(t,"break_fixed",this.break_fixed),this.break_fixed_left=k(t,"break_fixed_left",this.break_fixed_left),this.break_fixed_top=k(t,"break_fixed_top",this.break_fixed_top)}#r(){const t=this.#n.length,e=this.#a.length;if(t<e)for(let s=0;s<t;++s){const i=this.#n[s];if(this.#a.includes(i))throw`Á¶ÅÂâá„ÅÆÁ´∂Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÊñáÂ≠ó ${String(i)} „Åå„Å∂„Çâ‰∏ã„Åí „Å® Ë°åÊú´Á¶ÅÂâá „ÅÆ‰∏°Êñπ„Å´Âê´„Åæ„Çå„Åæ„Åô`}else for(let s=0;s<e;++s){const i=this.#a[s];if(this.#n.includes(i))throw`Á¶ÅÂâá„ÅÆÁ´∂Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÊñáÂ≠ó ${String(i)} „Åå„Å∂„Çâ‰∏ã„Åí „Å® Ë°åÊú´Á¶ÅÂâá „ÅÆ‰∏°Êñπ„Å´Âê´„Åæ„Çå„Åæ„Åô`}}#f(){const t=this.#l.length,e=this.#a.length;if(t<e)for(let s=0;s<t;++s){const i=this.#l[s];if(this.#a.includes(i))throw`Á¶ÅÂâá„ÅÆÁ´∂Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÊñáÂ≠ó ${String(i)} „Åå„Å∂„Çâ‰∏ã„Åí „Å® ÂàÜÂâ≤Á¶ÅÊ≠¢ „ÅÆ‰∏°Êñπ„Å´Âê´„Åæ„Çå„Åæ„Åô`}else for(let s=0;s<e;++s){const i=this.#a[s];if(this.#l.includes(i))throw`Á¶ÅÂâá„ÅÆÁ´∂Âêà„Åå„ÅÇ„Çä„Åæ„Åô„ÄÇÊñáÂ≠ó ${String(i)} „Åå„Å∂„Çâ‰∏ã„Åí „Å® ÂàÜÂâ≤Á¶ÅÊ≠¢ „ÅÆ‰∏°Êñπ„Å´Âê´„Åæ„Çå„Åæ„Åô`}}reNew(t){t.#t(this.#c,this.#n,this.#l,this.#a),t.break_fixed=this.break_fixed,t.break_fixed_left=this.break_fixed_left,t.break_fixed_top=this.break_fixed_top,t.bura=this.bura}#t(t,e,s,i){this.#c!==t&&(this.#c=t,this.#e=new RegExp(`[${t}]`)),this.#n!==e&&(this.#n=e,this.#h=new RegExp(`[${e}]`)),this.#l!==s&&(this.#l=s,this.#p=new RegExp(`[${s}]`)),this.#a!==i&&(this.#a=i,this.#S=new RegExp(`[${i}]`))}record(){const t={break_fixed:this.break_fixed,break_fixed_left:this.break_fixed_left,break_fixed_top:this.break_fixed_top,bura:this.bura};return this.#c===z&&(t.Ë°åÈ†≠Á¶ÅÂâá=this.#c),this.#n===W&&(t.Ë°åÊú´Á¶ÅÂâá=this.#n),this.#l===I&&(t.ÂàÜÂâ≤Á¶ÅÊ≠¢=this.#l),this.#a===X&&(t.„Å∂„Çâ‰∏ã„Åí=this.#a),t}playback(t){t&&(this.#t(t.Ë°åÈ†≠Á¶ÅÂâá??z,t.Ë°åÊú´Á¶ÅÂâá??W,t.ÂàÜÂâ≤Á¶ÅÊ≠¢??I,t.„Å∂„Çâ‰∏ã„Åí??X),this.break_fixed=t.break_fixed,this.break_fixed_left=t.break_fixed_left,this.break_fixed_top=t.break_fixed_top,this.bura=t.bura)}hyph(t,e,s,i,a){let n,r=0,h=2,l=_=>(l=()=>!1,i===_?(i>0&&(t.innerHTML=a.replaceAll('class="sn_ch"','class="sn_ch sn_ch_in_default"')),!0):_<2);do{if(n=this.#y(t,e),r=n.length,l(r))break;let _=-1/0;for(;h<r;++h){const{elm:m,rect:$,ch:C}=n[h];if(m.tagName==="RT")continue;const x=s?$.y:$.x;if(_<=x||m.previousElementSibling?.tagName==="SPAN"&&m.previousElementSibling?.innerHTML.includes("<br>")||m.parentElement?.previousElementSibling?.tagName==="SPAN"&&m.parentElement?.previousElementSibling?.innerHTML.includes("<br>")){_=x,this.break_fixed||(this.break_fixed_left=$.x,this.break_fixed_top=$.y);continue}const A=this.#u(n,h),{elm:y,rect:b,ch:o}=n[A];if(!this.break_fixed){this.break_fixed_left=b.x,this.break_fixed_top=b.y;const u=globalThis.getComputedStyle(y),T=parseFloat(u.fontSize);s?this.break_fixed_top+=T:this.break_fixed_left+=T}_=-1/0;const d=h,{cont:p,ins:S}=this.bura?this.hyph_alg_bura(n,A,o,h):this.hyph_alg(n,A,o,h,C);if(h=S,p)continue;const v=n[h].elm,f=v.parentElement,g=document.createElement("br");if(f.classList.contains("sn_tx"))f.insertBefore(g,v);else{const u=f.parentElement;u.classList.contains("sn_ch")?u.parentElement.insertBefore(g,u):u.insertBefore(g,f)}h+=2,h<d&&(h=d),r=-1;break}}while(r<0);return[n,r]}#u(t,e){const s=e-1,{elm:i}=t[s];return i.tagName!=="RT"?s-(i.style.textCombineUpright==="all"?Array.from(i.textContent).length-1:0):s-Array.from(i.textContent).length}#y(t,e){const s=[];if(t.nodeType!==t.TEXT_NODE)return Array.from(t.childNodes).map(r=>this.#y(r,e)).flat();const i=t.ownerDocument.createRange();i.selectNodeContents(t);let a=0;const n=i.endOffset;for(;a<n;){i.setStart(t,a),i.setEnd(t,++a);const r=i.toString();s.push({ch:r,rect:e(i,r),elm:i.startContainer.parentElement})}return i.detach(),s}hyph_alg(t,e,s,i,a){let n=i;if(!this.#h.test(s)){if(this.#e.test(a))for(;(n=this.#u(t,n))>=0&&this.#e.test(t[n].ch););else if(!(s===a&&this.#p.test(s)))return{cont:!0,ins:n+1}}for(n=e;(n=this.#u(t,n))>=0&&this.#h.test(t[n].ch););return{cont:!1,ins:n+1}}hyph_alg_bura(t,e,s,i){const a=this.#u(t,e),{ch:n}=t[a];if(this.#S.test(n)||this.#e.test(n)){let h=e;(this.#S.test(s)||this.#e.test(s))&&++h;const l=this.#u(t,h),{ch:_}=t[l],{ch:m}=t[h];if(_===m&&this.#p.test(m))return{cont:!1,ins:l};if(!this.#h.test(_))return{cont:!1,ins:h};h=l;do if(!this.#h.test(t[h].ch))break;while((h=this.#u(t,h))>=0);return{cont:!1,ins:h+1}}const r=this.#u(t,a);if(i>=3){const{ch:h}=t[r];if(this.#p.test(n)&&h===n)return{cont:!1,ins:r};if(this.#h.test(h)){let l=r;for(;(l=this.#u(t,l))>=0&&this.#h.test(t[l].ch););return{cont:!1,ins:l+1}}}return{cont:!1,ins:a}}}function _t(Y,t,e,s,i,a=!0){const n={escape:o=>o.replaceAll(/([.*+?^${}()|[\]/\\])/g,"\\$1"),mimeType:o=>{const d=m(o).toLowerCase();return r()[d]||""},dataAsUrl:A,isDataUrl:$,resolveUrl:C,getAndEncode:x,asArray:o=>{const d=[],p=o.length;for(let S=0;S<p;++S)d.push(o[S]);return d}};function r(){const o="application/font-woff",d="image/jpeg";return{woff:o,woff2:o,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:d,jpeg:d,gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"}}const h=y(),l=b();function _(o){return l.resolveAll().then(d=>{const p=document.createElement("style");return o.appendChild(p),p.appendChild(document.createTextNode(d)),o})}function m(o){return/\.([^./]*?)$/g.exec(o)?.[1]??""}function $(o){return o.search(/^(data:)/)!==-1}function C(o,d){const p=document.implementation.createHTMLDocument(),S=p.createElement("base");p.head.appendChild(S);const v=p.createElement("a");return p.body.appendChild(v),S.href=d,v.href=o,v.href}function x(o){return new Promise(function(d){const p=new XMLHttpRequest;p.onreadystatechange=S,p.ontimeout=v,p.responseType="blob",p.timeout=3e4,p.open("GET",o,!0),p.send();function S(){if(p.readyState!==4)return;if(p.status!==200){f("cannot fetch resource: "+o+", status: "+p.status);return}const g=new FileReader;g.onloadend=function(){const u=g.result.toString().split(/,/)[1];d(u)},g.readAsDataURL(p.response)}function v(){f("timeout of 30000ms occured while fetching resource: "+o)}function f(g){console.error(g),d("")}})}function A(o,d){return"data:"+d+";base64,"+o}function y(){const o=/url\(['"]?([^'"]+?)['"]?\)/g;return{inlineAll:v,shouldProcess:d};function d(f){return f.search(o)!==-1}function p(f){const g=[];let u;for(;u=o.exec(f);)g.push(u[1]);return g.filter(function(T){return!n.isDataUrl(T)})}function S(f,g,u,T){return Promise.resolve(g).then(E=>u?n.resolveUrl(E,u):E).then(T||n.getAndEncode).then(E=>n.dataAsUrl(E,n.mimeType(g))).then(E=>f.replace(R(g),"$1"+E+"$3"));function R(E){return new RegExp(`(url\\(['"]?)(`+n.escape(E)+`)(['"]?\\))`,"g")}}function v(f,g,u){if(T())return Promise.resolve(f);return Promise.resolve(f).then(p).then(R=>{let E=Promise.resolve(f);for(const J of R)E=E.then(F=>S(F,J,g,u));return E});function T(){return!d(f)}}}function b(){return{resolveAll:o,impl:{readAll:d}};function o(){return d().then(p=>Promise.allSettled(p.map(S=>S.resolve()))).then(p=>p.join(`
`))}function d(){return Promise.resolve(n.asArray(document.styleSheets)).then(S).then(p).then(f=>f.map(v));function p(f){return f.filter(g=>g.type===CSSRule.FONT_FACE_RULE).filter(g=>h.shouldProcess(g.style.getPropertyValue("src")))}function S(f){const g=[];for(const u of f)try{if(u.href)continue;n.asArray(u.cssRules||[]).forEach(g.push.bind(g))}catch(T){console.error("Error while reading CSS rules from "+u.href,String(T))}return g}function v(f){return{resolve:function(){const g=(f.parentStyleSheet||{}).href;return h.inlineAll(f.cssText,g)},src(){return f.style.getPropertyValue("src")}}}}}Promise.resolve(t).then(o=>{const d=o.cloneNode(!0);return d.style.padding="0px",d.style.paddingRight=s+"px",d.style.paddingTop=i+"px",d.style.left="0px",d.style.top="0px",d.style.width=e.$width-e.pad_left-e.pad_right+"px",d.style.height=e.$height-e.pad_top-e.pad_bottom+"px",t.hidden=a,d}).then(_).then(o=>{o.setAttribute("xmlns","http://www.w3.org/1999/xhtml");const d=new Image;return d.src=`data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="${String(e.$width)}px" height="${String(e.$height)}px"><foreignObject x="0" y="0" width="100%" height="100%">${new XMLSerializer().serializeToString(o).replaceAll("#","%23").replaceAll(`
`,"%0A")}</foreignObject></svg>`,new Promise(p=>{d.onload=()=>p(d)})}).then(o=>new Promise(d=>setTimeout(()=>d(o),100))).then(o=>{const d=document.createElement("canvas");d.width=e.$width,d.height=e.$height,d.getContext("2d").drawImage(o,0,0),Y(ct.from(d))}).catch(o=>V.myTrace(`goTxt() = ${String(o)}`))}class c extends L{constructor(t,e,s){super(),this.ctn=t,this.canFocus=e,this.sys=s,this.#e.classList.add("sn_tx"),this.#e.style.position="absolute",c.#n.view.parentElement.appendChild(this.#e),this.addChild(this.#h),this.addChild(this.#p),this.#p.name="grpDbgMasume";const i=j.debugLog?({ch:a,rect:{x:n,y:r,width:h,height:l}})=>console.log(`üçå masume ch:${a} x:${String(n)} y:${String(r)} w:${String(h)} h:${String(l)}`):()=>{};this.#f=c.#c.oCfg.debug.masume?a=>{i(a);const{x:n,y:r,width:h,height:l}=a.rect;this.#p.beginFill(6737151,.5).lineStyle(2,16724736,1).drawRect(n,r,h,l).endFill()}:()=>{},this.noticeCompTxt=s.isApp&&c.#c.oCfg.debug.dumpHtm?()=>{H.notifyEndProc(et);const a=this.#e.innerHTML;if(a==="")return;const{fn:n,ln:r}=c.#a.nowScrFnLn(),h=`dumpHtm ${t.name.slice(0,-7).replaceAll(":","=")}(fn=${n} line=${String(r)})`;s.outputFile(s.path_downloads+h+".htm",`<!doctype html><html><head><meta charset=utf-8><title>${h}</title>
<h1>${h}</h1>${a.replaceAll(/ class="sn_ch"|animation-delay: \d+ms; ?| data-add="{&quot;ch_in_style&quot;:&quot;default&quot;, &quot;ch_out_style&quot;:&quot;default&quot;}"/g,"").replaceAll(' style=""',"").replaceAll(/(<\/?ruby>)/g,`
$1
`).replaceAll(/<(br|\/span)>/g,`<$1>
`)}`)}:()=>H.notifyEndProc(et)}static#c;static#n;static init(t,e){c.#c=t,c.#n=e}static#l;static#a;static setEvtMng(t,e){c.#l=t,c.#a=e}static destroy(){c.#x=Object.create(null),c.#T=Object.create(null),c.delBreak()}#e=document.createElement("span");#h=new L;#p=new O;static#S={"background-color":0,"border-bottom-width":0,"border-left-width":0,"border-right-width":0,"border-top-width":0,"margin-bottom":0,"margin-left":0,"margin-right":0,"margin-top":0};#r=new mt;noticeCompTxt=()=>{};#f;#t={fontsize:24,$width:0,$height:0,pad_left:0,pad_right:0,pad_top:0,pad_bottom:0};lay(t){const e=this.#e.style;if("style"in t)if(t.style){const s=document.createElement("span");s.style.cssText=t.style;const i=s.style.length;for(let a=0;a<i;++a){const n=s.style[a];if(n in c.#S){V.myTrace(`${String(n)}„ÅØÊåáÂÆö„Åß„Åç„Åæ„Åõ„Çì`,"W");continue}e[n]=s.style[n]}!s.style.opacity&&"alpha"in t&&(e.opacity=String(this.ctn.alpha))}else this.#e.style.cssText="";else"alpha"in t&&(e.opacity=String(this.ctn.alpha));if("width"in t&&(e.width=String(t.width??"0")+"px"),"height"in t&&(e.height=String(t.height??"0")+"px"),"pl"in t&&(e.paddingLeft=String(t.pl??"0")+"px"),"pr"in t&&(e.paddingRight=String(t.pr??"0")+"px"),"pt"in t&&(e.paddingTop=String(t.pt??"0")+"px"),"pb"in t&&(e.paddingBottom=String(t.pb??"0")+"px"),this.#r.lay(t),this.#y(),this.#o=this.ctn.position.x,e.transformOrigin=`${String(this.ctn.pivot.x)}px ${String(this.ctn.pivot.y)}px`,this.cvsResize(),e.display=this.ctn.visible?"inline":"none",":redraw"in t&&this.#m>0){const s=[this.#e.innerHTML.replaceAll(/(animation-delay: )\d+ms/g,"$10ms"),`<span class='sn_ch' data-add='{"ch_in_style":"default"}'>&emsp;</span>`];this.#M(),this.goTxt(s,!0)}}#u=0;#y(){const t=this.#e.style,e=parseFloat(t.fontSize||"0");this.#t.fontsize=e,this.#t.pad_left=parseFloat(t.paddingLeft||"0"),this.#t.pad_right=parseFloat(t.paddingRight||"0"),this.#t.pad_top=parseFloat(t.paddingTop||"0"),this.#t.pad_bottom=parseFloat(t.paddingBottom||"0"),this.#t.$width=parseFloat(t.width||"0"),this.#t.$height=parseFloat(t.height||"0"),this.position.set(this.#t.pad_left,this.#t.pad_top),this.#g=t.writingMode==="vertical-rl",this.#i=0,this.#b=0;const s=t.lineHeight??"0";this.#u=this.#g?0:(s.endsWith("px")?parseFloat(s):e*parseFloat(s)-e)/2}cvsResize(){const t=this.#e.style,e=this.sys.cvsScale;t.left=`${String(this.sys.ofsLeft4elm+this.#o*e)}px`,t.top=`${String(this.sys.ofsTop4elm+this.ctn.position.y*e)}px`,t.transform=`rotate(${String(this.ctn.angle)}deg) scale(${String(this.ctn.scale.x*e)}, ${String(this.ctn.scale.y*e)})`}#o=0;#g=!1;get tategaki(){return this.#g}#i=0;#b=0;get infTL(){return this.#t}get getWidth(){return this.#t.$width}get getHeight(){return this.#t.$height}setMySize(t,e){this.#t.$width=t,this.#t.$height=e,this.#e.style.width=String(this.#t.$width)+"px",this.#e.style.height=String(this.#t.$height)+"px"}#s=[];goTxt(t,e){const s=()=>this.#_(t,e);this.#s.push(s)===1&&s()}#v=[];#m=0;static#W="<span class='sn_ch sn_ch_last'>&emsp;</span>";#_(t,e){c.#F.visible=!1;let s=this.#v.length,i="";if(s===0){if(c.#c.oCfg.debug.masume&&(j.debugLog&&console.log(`üçå masume ${this.name} v:${String(this.visible)} l:${String(this.x)} t:${String(this.y)} a:${String(this.alpha)} pl:${String(this.#t.pad_left)} pr:${String(this.#t.pad_right)} pt:${String(this.#t.pad_top)} pb:${String(this.#t.pad_bottom)} w:${String(this.#t.$width)} h:${String(this.#t.$height)}`),this.#p.clear().beginFill(3407616,.2).lineStyle(1,3407616,1).drawRect(-this.#t.pad_left,-this.#t.pad_top,this.#t.$width,this.#t.$height).endFill().beginFill(13311,.2).lineStyle(2,13311,1).drawRect(0,0,this.#t.$width-this.#t.pad_left-this.#t.pad_right,this.#t.$height-this.#t.pad_top-this.#t.pad_bottom).endFill()),this.#e.innerHTML=[...t].join("").replaceAll(/[\n\t]/g,"")+c.#W,!this.#r.break_fixed){const y=globalThis.getComputedStyle(this.#e),b=parseFloat(y.fontSize);this.#g?(this.#r.break_fixed_left=(this.#t.$width-this.#t.pad_left-this.#t.pad_right-b*1.5)*this.sys.cvsScale,this.#r.break_fixed_top=0):(this.#r.break_fixed_left=0,this.#r.break_fixed_top=b/2*this.sys.cvsScale)}}else i=this.#e.innerHTML,--s,this.#e.getElementsByClassName("sn_ch_last").item(0)?.remove(),this.#e.querySelectorAll(":scope > br").forEach(y=>y.remove()),this.#e.insertAdjacentHTML("beforeend",t.slice(this.#m).join("").replaceAll(/[\n\t]/g,"")+c.#W);this.#e.querySelectorAll(".sn_ch:has(> ruby)").forEach(y=>{y.style.background=""}),this.#m=t.length;const a=this.sys.cvsScale,n=this.#e.getBoundingClientRect(),r=n.left+this.#t.pad_left,h=n.top+this.#t.pad_top;let l;if(a===1)l=(y,b)=>{const o=y.getBoundingClientRect();return new G(o.left-r,o.top-h,o.width,o.height+("gjqy".includes(b)?this.#u:0))};else{const y=this.sys.ofsPadLeft_Dom2PIXI+n.left*(1-a),b=this.sys.ofsPadTop_Dom2PIXI+n.top*(1-a);l=(o,d)=>{const p=o.getBoundingClientRect();return new G((p.left-y)/a-r,(p.top-b)/a-h,p.width/a,(p.height+("gjqy".includes(d)?this.#u:0))/a)}}const[_,m]=this.#r.hyph(this.#e,l,this.#g,s,i);this.#v=_;const $=dt.ease(this.#C);for(let y=s;y<m;++y){const b=this.#v[y],{elm:{dataset:o,parentElement:d},rect:p}=b,S=JSON.parse(o.arg??'{"delay": 0}'),v=JSON.parse(o.add??"{}"),f=c.#x[v.ch_in_style];if(this.#f(b),o.cmd==="grp"){const g=new L;this.#h.addChild(g),new B(S.pic,g,u=>{this.#O(g,S,v,p,$,f??{}),g.parent||g.removeChild(u)})}if(o.lnk){const g=d.closest("[data-arg]"),u=JSON.parse(g.dataset.arg??"{}");u.key=`lnk=[${String(y)}] `+this.name;const T=new q;this.#O(T,u,v,p,$,f??{});const R=u.style??"",E=R+(u.style_hover??""),J=R+(u.style_clicked??""),F=u.r_style??"",nt=F+(u.r_style_hover??""),at=F+(u.r_style_clicked??""),Q=Array.from(g.getElementsByTagName("rt"));for(const M of Q)M.dataset.st_r_bk=M.style.cssText;const ht=g.style.cssText,D=(M,rt)=>{g.style.cssText=ht+M;for(const Z of Q)Z.style.cssText=Z.dataset.st_r_bk+rt};N(u,"enabled",!0)?c.#l.button(u,T,()=>D(R,F),()=>this.canFocus()?(D(E,nt),!0):!1,()=>D(J,at)):D(R+(u.style_disable??"color: gray;"),F+(u.r_style_disable??"color: gray;")),this.#h.addChild(T)}}const C=Array.from(this.#e.getElementsByClassName("sn_ch_yet"));this.#k=()=>{this.#k=()=>!1;for(const b of C)b.className="sn_ch";c.#F.position.set(this.#r.break_fixed_left,this.#r.break_fixed_top),c.#F.visible=!0,this.noticeCompTxt();const y=this.#s.shift();return this.#s.length>0&&y(),!0};for(const y of C)y.className=y.className.replace("sn_ch_yet sn","go");s>0&&++s;let x;for(let y=m-2;y>=0;--y){const{elm:b}=this.#v[y];if(b.tagName==="SPAN"){x=b.parentElement?.tagName==="RUBY"?b.parentElement.parentElement??b:b;break}}if(!x||e||s===m){this.#k();return}const A=()=>{x.removeEventListener("animationend",A),this.#k()};x.addEventListener("animationend",A,{once:!0,signal:this.#A.signal})}#k=()=>!1;#O(t,e,s,i,a,n){t.alpha=0,e.x&&(i.x=e.x.startsWith("=")?i.x+parseInt(e.x.slice(1)):parseInt(e.x)),e.y&&(i.y=e.y.startsWith("=")?i.y+parseInt(e.y.slice(1)):parseInt(e.y)),e.width&&(i.width=parseInt(e.width)),e.height&&(i.height=parseInt(e.height)),e.wait&&(n.wait=e.wait),t.width=i.width,t.height=i.height,n.x?t.position.set(n.x.startsWith("=")?i.x+t.width*n.nx:n.nx,n.y.startsWith("=")?i.y+t.height*n.ny:n.ny):t.position.set(i.x,i.y);const r={sp:t,tw:new pt(t).to({alpha:1,x:i.x,y:i.y,width:i.width,height:i.height,angle:0},n.wait??0).easing(a).delay((s.wait??0)+(e.delay??0)).onComplete(()=>{r.tw=void 0}).start()};this.#L.push(r)}#L=[];skipChIn(){let t=this.#k();for(const e of this.#L)e.tw&&(e.tw.stop().end(),t=!0);return this.#L=[],t}static#x=Object.create(null);static#H=/[{\s.,*{]/;static initChStyle(){c.#x=Object.create(null),c.#T=Object.create(null)}static getChInStyle(t){return c.#x[t]}static ch_in_style(t){const{name:e}=t;if(!e)throw"name„ÅØÂøÖÈ†à„Åß„Åô";if(c.#H.test(e))throw`name„Äê${e}„Äë„Å´‰Ωø„Åà„Å™„ÅÑÊñáÂ≠ó„ÅåÂê´„Åæ„Çå„Åæ„Åô`;if(e in c.#x)throw`name„Äê${e}„Äë„ÅØ„Åô„Åß„Å´„ÅÇ„Çä„Åæ„Åô`;const s=String(t.x??"=0"),i=String(t.y??"=0");return c.#x[e]={wait:k(t,"wait",500),alpha:k(t,"alpha",0),x:s,y:i,nx:parseFloat(s.at(0)==="="?s.slice(1):s),ny:parseFloat(i.at(0)==="="?i.slice(1):i),scale_x:k(t,"scale_x",1),scale_y:k(t,"scale_y",1),rotate:k(t,"rotate",0),join:N(t,"join",!0),ease:t.ease??"ease-out"}}static#T=Object.create(null);static getChOutStyle(t){return c.#T[t]}static ch_out_style(t){const{name:e}=t;if(!e)throw"name„ÅØÂøÖÈ†à„Åß„Åô";if(c.#H.test(e))throw`name„Äê${e}„Äë„Å´‰Ωø„Åà„Å™„ÅÑÊñáÂ≠ó„ÅåÂê´„Åæ„Çå„Åæ„Åô`;if(e in c.#T)throw`name„Äê${e}„Äë„ÅØ„Åô„Åß„Å´„ÅÇ„Çä„Åæ„Åô`;const s=String(t.x??"=0"),i=String(t.y??"=0");return c.#T[e]={wait:k(t,"wait",500),alpha:k(t,"alpha",0),x:s,y:i,nx:parseFloat(s.at(0)==="="?s.slice(1):s),ny:parseFloat(i.at(0)==="="?i.slice(1):i),scale_x:k(t,"scale_x",1),scale_y:k(t,"scale_y",1),rotate:k(t,"rotate",0),join:N(t,"join",!1),ease:t.ease??"ease-out"}}static#F=new L;static#z=new B;dispBreak(t){c.delBreak();const e=c.#F;e.visible=!1,this.addChild(e),c.#z.destroy(),c.#z=new B(t.pic,e,s=>{e.parent?(s.x=k(t,"x",0),s.y=k(t,"y",0),s.width=k(t,"width",this.#t.fontsize),s.height=k(t,"height",this.#t.fontsize)):e.removeChild(s)})}static delBreak(){const t=c.#F;t.parent?.removeChild(t),c.#z.destroy()}#C="Quadratic.Out";#E="Quadratic.Out";#A=new AbortController;#M(){this.#p.clear(),this.#v=[],this.#m=0,this.#s=[],this.#A.abort(),this.#A=new AbortController,this.skipChIn();const t=document.createElement("span");t.style.cssText=this.#e.style.cssText,t.classList.value=this.#e.classList.value;const e=this.#e,s=Array.from(e.getElementsByClassName("sn_ch"));e.parentElement.insertBefore(t,e);let i=0;s.forEach(n=>{const r=JSON.parse(n.dataset.add??n.children[0]?.getAttribute("data-add")??n.children[0]?.children[0]?.getAttribute("data-add")??"{}");if(!r.ch_out_style)return;const h=c.#T[r.ch_out_style];if(h){if(h.wait===0){n.style.display="none";return}i+=h.wait,h.join||(n.style.animationDelay="0ms"),n.classList.add(`go_ch_out_${String(r.ch_out_style)}`)}});const a=()=>{e.parentElement.removeChild(e);for(const n of this.#h.removeChildren())n instanceof L&&c.#l.unButton(n),n.destroy()};if(i===0)this.#e.textContent="",this.#e=document.createElement("span"),a();else{const n=e.lastElementChild;if(n){const r=()=>{n.removeEventListener("animationend",r),a()};n.addEventListener("animationend",r,{once:!0,signal:this.#A.signal})}else a()}this.#e=t}reNew(){this.#M();const t=new c(this.ctn,this.canFocus,this.sys);return t.#t=this.#t,t.#e.style.cssText=this.#e.style.cssText,t.#o=this.#o,t.name=this.name,t.#y(),t.#N=this.#N,t.#C=this.#C,t.#E=this.#E,this.#r.reNew(t.#r),this.destroy(),t}#N=void 0;record(){return{infTL:this.#t,cssText:this.#e.style.cssText,left:this.#o,ch_filter:this.#N,fi_easing:this.#C,fo_easing:this.#E,hyph:this.#r.record()}}playback(t){this.#t=t.infTL,this.position.set(this.#t.pad_left,this.#t.pad_top),this.#e.style.cssText=t.cssText,this.#o=t.left,this.#y(),this.#N=t.ch_filter,this.#C=t.fi_easing,this.#E=t.fo_easing,this.#r.playback(t.hyph)}get cssText(){return this.#e.style.cssText}set cssText(t){this.#e.style.cssText=t}#d=void 0;snapshot(t,e){_t(s=>{this.#d=q.from(s),this.#g&&(this.#d.x+=j.stageW-(this.#o+this.#t.$width)),this.#d.y-=this.#b,this.#d.texture.frame=new G(0,0,Math.min(this.#d.width,this.#t.$width-this.#o),Math.min(this.#d.height,this.#t.$height)),this.#h.addChild(this.#d),t.render(this.#d,{clear:!1}),e()},this.#e,this.#t,this.#i,this.#b,!1)}snapshot_end(){this.#d&&(this.#h.removeChild(this.#d),this.#d=void 0)}makeDesignCast(t){}showDesignCast(){}dump(){const t=[],e=this.#e.style,s=e.length;for(let i=0;i<s;++i){const a=e[i];t.push(`"${String(a)}":"${e[a].replaceAll(/(["\\])/g,"\\$1")}"`)}return`"txt":"${this.#e.textContent.replaceAll(/(["\\])/g,"\\$1")}", "style":{${t.join(",")}}`}destroy(){c.delBreak(),this.#e.parentElement.removeChild(this.#e),this.#e=document.createElement("span"),this.removeChild(this.#h),this.removeChild(this.#p),this.#p.clear(),this.#f=()=>{},this.#s=[],this.#v=[],this.#m=0,this.#L=[],this.#A.abort(),this.#N=void 0,super.destroy()}}class w extends K{static#c;static#n;static#l;static#a;static init(t,e,s,i,a,n){this.#c=t,c.init(t,n),this.#n=s,this.#a=i,this.#l=a,s.setDoRecProc(r=>this.chgDoRec(r)),e.autowc=r=>this.#u(r),e.autowc({enabled:!1,text:"",time:0}),e.ch_in_style=r=>this.#e(r),e.ch_out_style=r=>this.#h(r),c.initChStyle(),lt(),U(t.matchPath(".+",tt.FONT).flatMap(r=>Object.values(r).map(h=>`
@font-face {
	font-family: '${String(h)}';
	src: url('${this.#c.searchPath(String(h),tt.FONT)}');
}
`)).join("")+`
.sn_tx {
	pointer-events: none;
	user-select: none;
	-webkit-touch-callout: none;
	box-sizing: border-box;
}
.sn_ch {
	position: relative;
	display: inline-block;
}
`),this.#e({name:"default",wait:500,alpha:0,x:"=0.3",y:"=0",scale_x:1,scale_y:1,rotate:0,join:!0,ease:"ease-out"}),this.#h({name:"default",wait:0,alpha:0,x:"=0",y:"=0",scale_x:1,scale_y:1,rotate:0,join:!1,ease:"ease-out"})}static#e(t){const{x:e,y:s,nx:i,ny:a,alpha:n,wait:r,ease:h,rotate:l,scale_x:_,scale_y:m}=c.ch_in_style(t),$=e.startsWith("=")?`${String(i*100)}%`:`${String(i)}px`,C=s.startsWith("=")?`${String(a*100)}%`:`${String(a)}px`,{name:x=""}=t;return U(`
.sn_ch_in_${x} {
	position: relative;
	display: inline-block;
}
.go_ch_in_${x} {
	opacity: ${String(n)};
	position: relative;
	display: inline-block;
	animation: sn_ch_in_${x} ${String(r)}ms ${h} 0s both;
}
@keyframes sn_ch_in_${x} {
	from {transform: rotate(${String(l)}deg) scale(${String(_)}, ${String(m)}) translate(${$}, ${C})}
	to {opacity: 1; transform: none;}
}
`),!1}static#h(t){const{x:e,y:s,nx:i,ny:a,alpha:n,wait:r,ease:h,rotate:l,scale_x:_,scale_y:m}=c.ch_out_style(t),$=e.startsWith("=")?`${String(i*100)}%`:`${String(i)}px`,C=s.startsWith("=")?`${String(a*100)}%`:`${String(a)}px`,{name:x=""}=t;return U(`
.go_ch_out_${x} {
	position: relative;
	display: inline-block;
	animation: go_ch_out_${x} ${String(r)}ms ${h} 0s both;
}
@keyframes go_ch_out_${x} {
	to {
		opacity: ${String(n)};
		transform: rotate(${String(l)}deg) scale(${String(_)}, ${String(m)}) translate(${$}, ${C});
	}
`),!1}static#p=10;static set msecChWait(t){w.#p=t}static get msecChWait(){return w.#p}static#S;static#r;static setEvtMng(t,e,s){this.#S=t,this.#r=e,c.setEvtMng(t,s)}static#f=!1;static#t={};static#u(t){this.#f=N(t,"enabled",this.#f),this.#n.setVal_Nochk("save","const.sn.autowc.enabled",this.#f);const{text:e}=t;if("text"in t!="time"in t)throw"[autowc] text„Å®time„ÅØÂêåÊôÇÊåáÂÆöÂøÖÈ†à„Åß„Åô";if(this.#n.setVal_Nochk("save","const.sn.autowc.text",e),!e)return this.#n.setVal_Nochk("save","const.sn.autowc.time",""),!1;const s=e.length;if(this.#f&&s===0)throw'[autowc] enabled === false „Åã„Å§ text === "" „ÅØË®±„Åï„Çå„Åæ„Åõ„Çì';const i=String(t.time).split(",");if(i.length!==s)throw"[autowc] textÊñáÂ≠óÊï∞„Å®time„Å´Ë®òËø∞„Åï„Çå„ÅüÂæÖ„Å°ÊôÇÈñìÔºà„Ç≥„É≥„ÉûÂå∫Âàá„ÇäÔºâ„ÅØÂêåÊï∞„Å´„Åó„Å¶‰∏ã„Åï„ÅÑ";this.#t={};for(let a=0;a<s;++a)this.#t[e[a]]=P(i[a]);return this.#n.setVal_Nochk("save","const.sn.autowc.time",t.time),!1}#y=0;#o=0;#g=!1;#i=void 0;#b="";#s=new c(this.ctn,()=>this.canFocus(),w.#r);#v=new st;#m=document.createElement("span");static#W={"text-align":0,"text-align-last":0,height:0,width:0,"padding-left":0,"padding-right":0,"padding-top":0,"padding-bottom":0};#_=new L;constructor(){super(),this.ctn.addChild(this.#s),this.#v.init(this.#X),this.ctn.addChild(this.#_),this.#_.name="cntBtn",this.lay({style:`width: ${String(j.stageW)}px; height: ${String(j.stageH)}px; font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', 'Ê∏∏„Ç¥„Ç∑„ÉÉ„ÇØ Medium', meiryo, sans-serif; color: white; font-size: 24px; line-height: 1.5; padding: ${String(16)}px;`,in_style:"default",out_style:"default",back_clear:"true"})}destroy(){this.#i&&(this.ctn.removeChild(this.#i).destroy(),this.#i=void 0),w.#a.pagebreak(),this.#s.destroy()}static destroy(){this.#f=!1,this.#t={},this.#N=t=>t}set name(t){this.name_=t,this.#s.name=t}get name(){return this.name_}cvsResize(){this.#s.cvsResize()}cvsResizeChildren(){for(const t of this.#_.children)t.cvsResize()}procSetX(t){this.#s.lay({x:t})}procSetY(t){this.#s.lay({y:t})}lay(t){if(super.lay(t),K.setXY(this.ctn,t,this.ctn),t[":id_tag"]=this.name_.slice(0,-7),st.setting(t),this.#z(t),this.#s.lay(t),"r_align"in t&&(this.#$=t.r_align??""),this.#d=j.isSafari?this.#s.tategaki?(i,a)=>`text-align: start; height: ${String(a)}em; padding-top: ${i}; padding-bottom: ${i};`:(i,a)=>`text-align: start; width: ${String(a)}em; padding-left: ${i}; padding-right: ${i};`:this.#s.tategaki?i=>`text-align: justify; text-align-last: justify; padding-top: ${i}; padding-bottom: ${i};`:i=>`text-align: justify; text-align-last: justify; padding-left: ${i}; padding-right: ${i};`,j.isFirefox&&(this.#I=this.#Q),"r_style"in t)if(t.r_style){const i=document.createElement("span");i.style.cssText=t.r_style;const a=i.style.length,n=this.#m.style;for(let r=0;r<a;++r){const h=i.style[r];if(h in w.#W){V.myTrace(`${String(h)}„ÅØÊåáÂÆö„Åß„Åç„Åæ„Åõ„Çì`,"W");continue}const l=i.style[h];l&&(n[h]=l)}}else this.#m.style.cssText="";if("alpha"in t)for(const i of this.#_.children)i.alpha=this.ctn.alpha;this.#k(t),this.#x(t);const e=H.procID+`TxtLayer lay name:${this.name_}`,s=this.#F(t,i=>{i&&H.endProc(e)});return s&&H.beginProc(e),s}#k(t){const{in_style:e}=t;if(!e)return;const s=c.getChInStyle(e);if(!s)throw`Â≠òÂú®„Åó„Å™„ÅÑin_style„Äê${e}„Äë„Åß„Åô`;this.#O=e,this.#L=s.join}#O="";#L=!0;get width(){return this.#s.getWidth}get height(){return this.#s.getHeight}#x(t){const{out_style:e}=t;if(e){if(!c.getChOutStyle(e))throw`Â≠òÂú®„Åó„Å™„ÅÑout_style„Äê${e}„Äë„Åß„Åô`;this.#H=e}}#H="";#T=new B;#F(t,e){if("back_clear"in t)return N(t,"back_clear",!1)&&(this.#y=0,this.#o=0,this.#g=!1,this.#b=""),e(!1),!1;this.#o=k(t,"b_alpha",this.#o),this.#g=N(t,"b_alpha_isfixed",this.#g);const s=(this.#g?1:Number(w.#n.getVal("sys:TextLayer.Back.Alpha")))*this.#o;if(t.b_pic){if(this.#b!==t.b_pic)return this.#b=t.b_pic,this.#i&&(this.ctn.removeChild(this.#i),this.#i.destroy()),this.#T=new B(this.#b,this.ctn,i=>{this.#i=i,i.name="back(pic)",i.visible=s>0,i.alpha=s,this.#s.setMySize(i.width,i.height),this.ctn.setChildIndex(i,0),e(!0)}),this.#T.ret}else"b_color"in t&&(this.#y=ot(t,"b_color",0),this.#i&&(this.ctn.removeChild(this.#i),this.#i.destroy()),this.#b="",this.ctn.addChildAt((this.#i=new O).beginFill(this.#y,s).lineStyle(void 0).drawRect(0,0,this.#s.getWidth,this.#s.getHeight).endFill(),0),this.#i.name="back(color)");return this.#i&&(this.#i.visible=s>0,this.#i.alpha=s),e(!1),!1}chgBackAlpha(t){const e=this.#g?this.#o:t*this.#o;this.#i instanceof O&&(this.#i&&(this.ctn.removeChild(this.#i),this.#i.destroy()),this.ctn.addChildAt((this.#i=new O).beginFill(this.#y,e).lineStyle(void 0).drawRect(0,0,this.#s.getWidth,this.#s.getHeight).endFill(),0),this.#i.name="back(color)"),this.#i&&(this.#i.visible=e>0,this.#i.alpha=e)}#z(t){"noffs"in t&&(this.#A=t.noffs??"",this.#M=new RegExp(`[„ÄÄ${this.#A}]`)),"ffs"in t&&(this.#C??="",this.#E=this.#C===""?()=>"":e=>this.#M.test(e)?"":` font-feature-settings: ${this.#C};`)}#C="";#E=t=>"";#A="";#M=/[„ÄÄ]/;static chgDoRec(t){this.#N=t?e=>e:e=>`<span class='offrec'>${e}</span>`}static#N=t=>t;isCur=!1;#d=()=>"";#I=(t,e,s,i="")=>{if(!s)return` style='${i}'`;const a=t.length*2;if(a-e.length<0)return` style='text-align: ${s}; ${i}'`;let n="";switch(s){case"justify":n=this.#d("0",a);break;case"121":n=this.#d(`calc(${String((a-e.length)/(e.length*2))}em)`,a);break;case"even":n=this.#d(`calc(${String((a-e.length)/(e.length+1))}em)`,a);break;case"1ruby":n=this.#d("1em",a);break;default:n=`text-align: ${s};`}return` style='${n} ${i}'`};#$="";#Q(t,e,s,i=""){if(!s)return` style='${i}'`;const a=t.length*2;if(a-e.length<0)return` style='text-align: ${s}; ${i}'`;let n="";switch(s){case"left":n="ruby-align: start;";break;case"center":n="ruby-align: center;";break;case"right":n="ruby-align: start;";break;case"justify":n="ruby-align: space-between;";break;case"121":n="ruby-align: space-around;";break;case"even":{const r=` ${String((a-e.length)/(e.length+1))}em;`;n="ruby-align: space-between; "+(this.#s.tategaki?`padding-top:${r} padding-bottom:${r}`:`padding-left:${r} padding-right:${r}`)}break;case"1ruby":n="ruby-align: space-between; "+(this.#s.tategaki?"padding-top: 1em; padding-bottom: 1em;":"padding-left: 1em; padding-right: 1em;");break;default:n=`text-align: ${s};`}return` style='${n} ${i}'`}tagCh(t){this.#v.putTxt(t)}#w=!1;get needGoTxt(){return this.#w}#X=(t,e)=>{let s=e;w.#c.oCfg.debug.putCh&&console.log(`üñä ÊñáÂ≠óË°®Á§∫ text:\`${t}\`(${t.charCodeAt(0).toString(16)}) ruby:\`${s}\` name:\`${this.name_}\``);const i=s.split("ÔΩú");let a="";const[n,...r]=i,h=r.join("ÔΩú");switch(i.length){case 1:if(this.#w=!0,t===`
`){this.#P?(this.#P=!1,a="<ruby>&emsp;<rt>&emsp;</rt></ruby><br/>"):a="<br/>";break}this.#P&&(this.#P=!1,s===""&&(s="&emsp;")),a=this.#U(t,s,this.#$);break;default:switch(n){case"start":case"left":case"center":case"right":case"justify":case"121":case"even":case"1ruby":this.#P=!1,this.#w=!0,a=this.#U(t,h,n);break;case"gotxt":this.#G(),this.#w?(this.isCur&&w.#a.recText(this.#R.join("").replace(/^<ruby>&emsp;<rt>&emsp;<\/rt><\/ruby>(<br\/>)+/,"").replaceAll(/style='(anim\S+ [^;]+;\s*)+/g,"style='").replaceAll(/( style=''| data-(add|arg|cmd)='[^']+'|\n+|\t+)/g,"").replaceAll(/class='sn_ch[^']+/g,"class='sn_ch").replaceAll("display: none;","").replaceAll("class='offrec'","style='display: none;'")),this.#s.goTxt(this.#R,this.#B===0),this.#w=!1,this.#B=0):this.isCur&&this.#s.noticeCompTxt();return;case"add":{const l=JSON.parse(h),{style:_="",wait:m=null}=l,{cl:$,sty:C}=this.#D(!0,m?P(m):null);this.#R.push(`<span${$} style='${C} display: inline; ${_}'>`),delete l.style,this.#V(l)}return;case"add_close":this.#R.push("</span>"),this.#G();return;case"grp":this.#w=!0;{const l=JSON.parse(h);if(l.id??=String(this.#R.length),l.id==="break"){this.#s.dispBreak(l);return}this.#P=!1,l.delay=this.#B,l.r??="",l.style??="",l.r_style??="";const{r:_,wait:m=null,r_style:$}=l,{cl:C,sty:x,lnk:A}=this.#D(!0,m?P(m):null);a=`<span${C} style='${x} ${l.style}'><ruby><span data-cmd='grp' data-arg='${JSON.stringify(l)}'${A} style='${x} display: inline;'>&emsp;</span><rt${A}${this.#I("„ÄÄ",_,this.#$,this.#m.style.cssText+(this.#j.at(-1)?.o.r_style??"")+$)}>${l.r}</rt></ruby></span>`}break;case"tcy":this.#P=!1,this.#w=!0;{const{t:l="",r:_="",wait:m=null,style:$="",r_style:C=""}=JSON.parse(h);w.#n.doRecLog()&&(this.#q+=t+(s?`„Ää${s}„Äã`:""),this.#J+=l);const x=j.isSafari?_.replaceAll(/[A-Za-z0-9]/g,o=>String.fromCharCode(o.charCodeAt(0)+65248)):_,{cl:A,sty:y,lnk:b}=this.#D(!0,m?P(m):null);a=`<span${A} style='${y}${this.#E(l)} ${$}'><ruby><span${b} style='${y} display: inline; text-combine-upright: all;'>${l}</span><rt${b}${this.#I(l,x,this.#$,this.#m.style.cssText+(this.#j.at(-1)?.o.r_style??"")+C)}>${x}</rt></ruby></span>`}break;case"del":c.delBreak();return;case"span":this.#w=!0,this.#Y(JSON.parse(h));return;case"link":this.#w=!0;{const l=JSON.parse(h);l[":link"]=" data-lnk='@'";const{cl:_,sty:m,curpos:$}=this.#D(!1,l.wait?P(l.wait):null);this.#R.push(`<span${_} style='${m} display: inline; ${l.style??""}' ${$} data-arg='${h}'>`),delete l.style,this.#Y(l)}return;case"endlink":this.#w=!0,this.#R.push("</span>"),this.#G();return;default:this.#w=!0,a=this.#U(t,s,this.#$)}break}this.#R.push(w.#N(a))};#U(t,e,s){const i=t===" "?"&nbsp;":t==="„ÄÄ"?"&emsp;":t;w.#n.doRecLog()&&(this.#q+=i+(e?`„Ää${e}„Äã`:""),t!==" "&&(this.#J+=t));const{cl:a,sty:n,lnk:r}=this.#D(!0,null,t);return e?`<span${a} style='${n} ${this.#E(t)}'><ruby>${Array.from(t).map((h,l)=>`<span${a}${r} style='${l>0?this.#D(!0,null,t).sty:n} display: inline;'>${h===" "?"&nbsp;":h==="„ÄÄ"?"&emsp;":h}</span>`).join("")}<rt${r}${this.#I(t,e,s,this.#m.style.cssText+(this.#j.at(-1)?.o.r_style??""))}>${e}</rt></ruby></span>`:`<span${a} style='${n} ${this.#E(t)}'${r}>${i}</span>`}#D(t,e,s=`
`){const i=this.#L?e??this.#j.at(0)?.o.wait??(w.#f?w.#t[s.at(0)??""]??0:w.msecChWait):0;w.#S.isSkipping?this.#B=0:t&&this.#L&&(this.#B+=P(i));const a=`data-add='{"ch_in_style":"${this.#O}", "ch_out_style":"${this.#H}"}'`;return{cl:` class='sn_ch sn_ch_yet sn_ch_in_${this.#O}'`,sty:`animation-delay: ${String(this.#B)}ms;${this.#j.at(-1)?.o.style??""}`,lnk:(this.#j.at(0)?.o[":link"]??"")+" "+a,curpos:a}}#B=0;#P=!0;#R=[];#j=[];#V(t){this.#j.push({o:t,r_align:this.#$,ch_in_style:this.#O,ch_out_style:this.#H}),t.r_align&&(this.#$=t.r_align),this.#k(t),this.#x(t)}#G(){const t=this.#j.pop();t&&(this.#$=t.r_align,this.#k({in_style:t.ch_in_style}),this.#x({out_style:t.ch_out_style}))}#Y(t){const e=this.#j.at(-1);if(!e){this.#V(t);return}e.o={...e.o,...t},!t.style&&!t.r_style&&(e.o.style="",e.o.r_style=""),t.r_align&&(this.#$=t.r_align),this.#k(t),this.#x(t)}click=()=>!this.ctn.interactiveChildren||!this.ctn.visible?!1:this.#s.skipChIn();clearText(){this.ctn.removeChild(this.#s),this.ctn.addChild(this.#s=this.#s.reNew()),this.#B=0,this.#P=!0,this.#R=[],this.#q="",this.#J="",w.#a.pagebreak()}#q="";#J="";get pageText(){return this.#q.replace("„Ää&emsp;„Äã","")}get pagePlainText(){return this.#J}get enabled(){return this.ctn.interactiveChildren}set enabled(t){this.ctn.interactiveChildren=t}addButton=t=>new Promise(e=>{t.key=`btn=[${String(this.#_.children.length)}] `+this.name_,t[":id_tag"]=t.key.slice(0,-7),N(t,"hint_tate",this.#s.tategaki);const s=new gt(t,w.#S,()=>e(),()=>this.canFocus());s.name=JSON.stringify(t).replaceAll('"',"'"),this.#_.addChild(s)});canFocus(){return(this.ctn.interactiveChildren??!1)&&this.ctn.visible&&w.#l(this)}clearLay(t){super.clearLay(t),this.clearText();for(const e of this.#_.removeChildren())e.destroy()}record=()=>({...super.record(),enabled:this.enabled,r_cssText:this.#m.style.cssText,r_align:this.#$,b_do:this.#i===void 0?void 0:this.#i instanceof q?"Sprite":"Graphics",b_pic:this.#b,b_color:this.#y,b_alpha:this.#o,b_alpha_isfixed:this.#g,ffs:this.#C,txs:this.#s.record(),strNoFFS:this.#A,btns:this.#_.children.map(t=>t.name)});playback(t,e){super.playback(t,e),this.enabled=t.enabled,this.#m.style.cssText=t.r_cssText,this.#$=t.r_align,this.cvsResize(),this.#z(t),this.#s.playback(t.txs),this.#o=t.b_alpha,this.#g=t.b_alpha_isfixed,e.push(new Promise(s=>{const i=t.b_do?t.b_do==="Sprite"?{b_pic:t.b_pic}:{b_color:t.b_color}:{b_pic:""};i.b_alpha=t.b_alpha,i.b_alpha_isfixed=t.b_alpha_isfixed,this.#F(i,a=>{a&&s()})||s()}),...t.btns.map(s=>this.addButton(JSON.parse(s.replaceAll("'",'"')))).flat())}get cssText(){return this.#s.cssText}set cssText(t){this.#s.cssText=t}snapshot(t,e){t.render(this.ctn,{clear:!1}),this.#s.snapshot(t,e)}snapshot_end(){this.#s.snapshot_end()}makeDesignCast(t){this.ctn.visible&&this.#s.makeDesignCast(t)}makeDesignCastChildren(t){if(this.ctn.visible)for(const e of this.#_.children)e.makeDesignCast(t)}showDesignCast(){this.#s.showDesignCast()}showDesignCastChildren(){for(const t of this.#_.children)t.showDesignCast()}dump(){return this.#X("","gotxtÔΩú"),super.dump()+`, "enabled":"${String(this.enabled)}", ${this.#s.dump()}, "b_pic":"${this.#b}", "b_color":"${String(this.#y)}", "b_alpha":${String(this.#o)}, "b_alpha_isfixed":"${String(this.#g)}", "width":${String(this.#s.getWidth)}, "height":${String(this.#s.getHeight)}, "pixi_obj":[${this.ctn.children.map(t=>`{"class":"${t instanceof q?"Sprite":t instanceof O?"Graphics":t instanceof L?"Container":"?"}", "name":"${t.name}", "alpha":${String(t.alpha)}, "x":${String(t.x)}, "y":${String(t.y)}, "visible":"${String(t.visible)}"}`).join(",")}], "button":[${this.#_.children.map(t=>t.children[0]?.name??"{}").join(",")}]`}}const Tt=Object.freeze(Object.defineProperty({__proto__:null,TxtLayer:w},Symbol.toStringTag,{value:"Module"}));export{w as T,c as a,Tt as b};
