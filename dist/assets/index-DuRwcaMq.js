import{x as c,b as r}from"./web-D5cyPUip.js";import{R as o,S as f,b as u,B as p}from"./pixi-BNm1jFGN.js";import"../web.js";class i extends c{constructor(e){if(super(),this.pia=e,i.#r++%2!==1){if(i.#r===1){const{window:{width:s,height:h}}=e.getInfo();switch(i.#a=s,i.#n=h,String(this.pia.getVal("const.sn.platform.os.family"))){case"Android":case"iOS":EmotePlayer.maskMode=EmotePlayer.MaskMode.STENCIL;break}EmotePlayer.createRenderCanvas(i.#a,i.#n)}this.#t=o.create({width:i.#a,height:i.#n}),this.ctn.addChild(new f(this.#t)),this.#s=document.createElement("canvas"),this.#s.id=`emote:${i.#r}`,this.#s.width=i.#a,this.#s.height=i.#n,this.#s.hidden=!0,this.#i.width=i.#a,this.#i.height=i.#n}}static#r=0;static#a=0;static#n=0;#t;#s;#i=new f;#e;lay(e,s){if(!this.#t)return!1;if(!e.layer){if(e[":タグ名"]==="add_lay")return!1;throw"layerは必須です"}if(super.lay(e),e.fn){const n=e.fn,a=new EmotePlayer(this.#s);this.#e={fn:n,player:a};const l={...e};return delete l.fn,l[":タグ名"]="lay",a.onUpdate=()=>{a&&(this.#i.texture.destroy(),this.#i.texture=new u(new p(this.#s)),this.pia.render(this.#i,this.#t,!0))},a.promiseLoadDataFromURL(this.pia.searchPath(n,"emtbytes_|emtbytes")).then(()=>{this.lay(l,s),this.pia.resume(s)}),!0}else if(e[":タグ名"]==="add_lay")return!1;if(!this.#e)return!1;c.setXY(this.#i,e,this.ctn,!0);const t=this.#e.player;if(e.label){const n=[...t.mainTimelineLabels,...t.diffTimelineLabels];if(!n.includes(e.label))throw console.error(`エラーが発生しました。参考までに ${this.#e.fn}.emtbytes 内に存在するアニメ名を列挙します`),n.forEach(a=>console.info(`  label=${a}`)),`${this.#e.fn}.emtbytes 内に存在しないアニメ（label=${e.label}）です`;t.mainTimelineLabel=e.label}return"scale"in e&&(t.scale=r(e,"scale",1)),"grayscale"in e&&(t.grayscale=r(e,"grayscale",1)),"windSpeed"in e&&(t.windSpeed=r(e,"windSpeed",0)),"windPowerMin"in e&&(t.windPowerMin=r(e,"windPowerMin",0)),"windPowerMax"in e&&(t.windPowerMax=r(e,"windPowerMax",0)),!1}clearLay(e){this.#t&&(super.clearLay(e),this.#e&&(this.#e.player.onUpdate=()=>{},this.#e=null,this.#i.visible=!1,this.pia.render(this.#i,this.#t,!0),this.#i.visible=!0))}record=()=>Object.assign(super.record(),this.#e?{fn:this.#e.fn,label:this.#e.player.mainTimelineLabel,scale:this.#e.player.scale,grayscale:this.#e.player.grayscale,windSpeed:this.#e.player.windSpeed,windPowerMin:this.#e.player.windPowerMin,windPowerMax:this.#e.player.windPowerMax}:{fn:""});playback(e,s){return super.playback(e,s),e.fn?this.lay(e):(this.clearLay(e),!1)}dump(){return this.#t?super.dump()+(this.#e?`, "mdl":{"fn":"${this.#e.fn}","label":"${this.#e.player.mainTimelineLabel}","scale":"${this.#e.player.scale}"}`:', "mdl":{"fn":""}'):'"is":"nothing"'}destroy(){this.#t&&(this.clearLay({}),this.ctn.removeChildren().forEach(e=>e.destroy()))}}async function b(d){d.addLayCls("emote",()=>new i(d))}export{b as init};
