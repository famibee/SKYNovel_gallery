"use strict";(self.webpackChunkgallery=self.webpackChunkgallery||[]).push([[717],{7859:(t,e,s)=>{s.d(e,{C:()=>a});var i=s(662),n=s(3653);class a{static#t={};static#e;static#s;static init(t,e){a.#t={},a.#e=t,a.#s=e,a.#s.ticker.add(a.#i)}static#i=()=>(0,n.u)();static destroy(){a.stopAllTw(),a.#s.ticker.remove(a.#i)}static setTwProp(t,e){const s=(0,i.b)(e,"repeat",1);return t.delay((0,i.b)(e,"delay",0)).easing(a.ease(e.ease)).repeat(s>0?s-1:1/0).yoyo((0,i.a)(e,"yoyo",!1))}static#n={"Back.In":t=>n.E.Back.In(t),"Back.InOut":t=>n.E.Back.InOut(t),"Back.Out":t=>n.E.Back.Out(t),"Bounce.In":t=>n.E.Bounce.In(t),"Bounce.InOut":t=>n.E.Bounce.InOut(t),"Bounce.Out":t=>n.E.Bounce.Out(t),"Circular.In":t=>n.E.Circular.In(t),"Circular.InOut":t=>n.E.Circular.InOut(t),"Circular.Out":t=>n.E.Circular.Out(t),"Cubic.In":t=>n.E.Cubic.In(t),"Cubic.InOut":t=>n.E.Cubic.InOut(t),"Cubic.Out":t=>n.E.Cubic.Out(t),"Elastic.In":t=>n.E.Elastic.In(t),"Elastic.InOut":t=>n.E.Elastic.InOut(t),"Elastic.Out":t=>n.E.Elastic.Out(t),"Exponential.In":t=>n.E.Exponential.In(t),"Exponential.InOut":t=>n.E.Exponential.InOut(t),"Exponential.Out":t=>n.E.Exponential.Out(t),"Linear.None":t=>n.E.Linear.None(t),"Quadratic.In":t=>n.E.Quadratic.In(t),"Quadratic.InOut":t=>n.E.Quadratic.InOut(t),"Quadratic.Out":t=>n.E.Quadratic.Out(t),"Quartic.In":t=>n.E.Quartic.In(t),"Quartic.InOut":t=>n.E.Quartic.InOut(t),"Quartic.Out":t=>n.E.Quartic.Out(t),"Quintic.In":t=>n.E.Quintic.In(t),"Quintic.InOut":t=>n.E.Quintic.InOut(t),"Quintic.Out":t=>n.E.Quintic.Out(t),"Sinusoidal.In":t=>n.E.Sinusoidal.In(t),"Sinusoidal.InOut":t=>n.E.Sinusoidal.InOut(t),"Sinusoidal.Out":t=>n.E.Sinusoidal.Out(t)};static ease(t){if(!t)return t=>n.E.Linear.None(t);const e=a.#n[t];if(!e)throw"異常なease指定です";return e}static hMemberCnt={alpha:0,height:0,rotation:0,scale_x:0,scale_y:0,pivot_x:0,pivot_y:0,width:0,x:0,y:0};static cnvTweenArg(t,e){const s={};for(const i of Object.keys(a.hMemberCnt)){const n=t[i];if(!n)continue;const a=String(n),h=a.startsWith("="),r=h?a.slice(1):a;if(!r)continue;const[o,c]=r.split(","),l=s[i]=parseFloat(o);c&&(s[i]+=Math.round(Math.random()*(parseFloat(c)-l+1))),h&&(s[i]+=parseFloat(e[i]))}return s}static stopAllTw(){a.#t={},(0,n.a)()}static tween(t,e,s,h,r,o,c,l=!0){const d=this.#e.isSkipping?0:(0,i.b)(e,"time",NaN),p=new n.T(s).to(h,d).onUpdate(r);a.setTwProp(p,e),a.#t[t]={tw:p,onEnd:c};const{path:f}=e;let u=p;if(f){i.C.debugLog&&console.group(`🍝 [${e[":タグ名"]}] path=${f}= start(${s.x},${s.y},${s.alpha})`);for(const{groups:t}of f.matchAll(a.#a)){const{x:h,x2:r,y:o,y2:c,o:l,o2:p,json:f}=t;let g={};if(f)try{g=JSON.parse(f)}catch(t){console.error(`🍝 json=${f} `+t);continue}else(h??r)&&(g.x=h??r),(o??c)&&(g.y=o??c),(l??p)&&(g.alpha=l??p);const y=a.cnvTweenArg(g,s);i.C.debugLog&&console.info(`🍝 ${f??`{x:${h} y:${o} o:${l}}`} => hTo:${JSON.stringify(y)}`);const m=new n.T(s).to(y,d);a.setTwProp(m,e),u.chain(m),u=m}i.C.debugLog&&console.groupEnd()}u.onComplete((()=>{const e=a.#t[t];e&&(delete a.#t[t],e.tw=void 0,p.stop(),a.#e.breakEvent("tsy nm:"+t),e.onEnd?.(),o())}));const{chain:g}=e;if(g){const t=a.#t[g];if(!t?.tw)throw`${g}は存在しない・または終了したトゥイーンです`;delete t.onEnd,t.tw.chain(p)}else l&&p.start();return p}static#a=/\(\s*(?:(?<x>[-=\d\.]+)|(['"])(?<x2>.*?)\2)?(?:\s*,\s*(?:(?<y>[-=\d\.]+)|(['"])(?<y2>.*?)\5)?(?:\s*,\s*(?:(?<o>[-=\d\.]+)|(['"])(?<o2>.*?)\8))?)?|(?<json>\{[^{}]*})/g;static wt(t){return!!a.#t[a.TW_INT_TRANS]?.tw&&a.#e.waitEvent("tsy nm:"+a.TW_INT_TRANS,t,(()=>a.finish_trans()))}static TW_INT_TRANS="trans\n";static finish_trans(){return a.#t[a.TW_INT_TRANS]?.tw?.stop().end(),!1}static wait_tsy(t){const{layer:e="",id:s,name:n}=t,h=s?`frm\n${s}`:n??e;if(!h)throw"トゥイーンが指定されていません";const r=a.#t[h];if(!r?.tw){if((0,i.a)(t,"chk_exist_tw",!1))throw s?`フレームトゥイーン ${s} が見つかりません。`:`トゥイーン ${h} が見つかりません。(layer:${e} name:${n})`;return!1}return a.#e.waitEvent("tsy nm:"+h,t,(()=>r.tw?.end()))}static stop_tsy(t){const{layer:e="",id:s,name:i}=t,n=s?`frm\n${s}`:i??e;if(!n)throw"トゥイーンが指定されていません";return a.#t[n]?.tw?.stop().end(),!1}static pause_tsy(t){const{layer:e="",id:s,name:i}=t,n=s?`frm\n${s}`:i??e;if(!n)throw"トゥイーンが指定されていません";return a.#t[n]?.tw?.pause(),!1}static resume_tsy(t){const{layer:e="",id:s,name:i}=t,n=s?`frm\n${s}`:i??e;if(!n)throw"トゥイーンが指定されていません";return a.#t[n]?.tw?.resume(),!1}}},2717:(t,e,s)=>{s.r(e),s.d(e,{B:()=>v,L:()=>T,T:()=>k});var i=s(662),n=s(7859),a=s(3653),h=s(7659);class r{constructor(t,e,s,n,a,h,r,o){this.cls=e,this.hArg=a,this.sys=h,this.val=r,this.ret=o;const c=h.hFactoryCls[e];if(!c)throw`属性 class【${e}】が不正です`;const l=c(),d=c();l.layname=d.layname=t;const p=a[":id_tag"]=`layer:${t} cls:${e} page:`;l.ctn.name=l.name=p+"A",d.ctn.name=d.name=p+"B",s.addChild(l.ctn),n.addChild(d.ctn),(0,i.a)(a,"visible",!0),(0,i.a)(a,"visible",!0),o.isWait=l.lay(a)||d.lay(a),this.#e={fore:l,back:d};const f=`const.sn.lay.${t}`;r.setVal_Nochk("tmp",f,!0),r.defTmp(f+".fore.alpha",(()=>this.#e.fore.alpha)),r.defTmp(f+".back.alpha",(()=>this.#e.back.alpha)),r.defTmp(f+".fore.height",(()=>this.#e.fore.height)),r.defTmp(f+".back.height",(()=>this.#e.back.height)),r.defTmp(f+".fore.visible",(()=>this.#e.fore.ctn.visible)),r.defTmp(f+".back.visible",(()=>this.#e.back.ctn.visible)),r.defTmp(f+".fore.width",(()=>this.#e.fore.width)),r.defTmp(f+".back.width",(()=>this.#e.back.width)),r.defTmp(f+".fore.x",(()=>this.#e.fore.x)),r.defTmp(f+".back.x",(()=>this.#e.back.x)),r.defTmp(f+".fore.y",(()=>this.#e.fore.y)),r.defTmp(f+".back.y",(()=>this.#e.back.y))}#e;destroy(){this.#e.fore.destroy(),this.#e.back.destroy()}lay=t=>this.getPage(t).lay(t);getPage=t=>"back"!==r.argChk_page(t,"fore")?this.#e.fore:this.#e.back;static argChk_page(t,e){const s=t.page??e;if("fore"===s||"back"===s)return t.page=s;throw Error("属性 page【"+s+"】が不正です")}get fore(){return this.#e.fore}get back(){return this.#e.back}transPage(t){[this.#e.back,this.#e.fore]=[this.#e.fore,this.#e.back],this.#e.back.copy(this.#e.fore,t)}}class o{constructor(t,e=!1){this.bg_col=t,this.isLay=e}static init(t,e,s,i,n,a){}static cvsResizeDesign(){}destroy(){}gethArg(){return this.hArg}hArg={};sethArg(t){this.hArg=t}setOther(t){}adopt(t){}static enterMode(){}static allHide(){}set visible(t){}static leaveMode(){}cvsResize(){}make(){}static replaceToken(t){}}class c extends o{constructor(t,e){super("#29e",!0)}setSp(t){}}class l{constructor(t="",e,s=()=>{},i=()=>{}){this.csvFn=t,this.ctn=e,this.fncFirstComp=s,this.fncAllComp=i,t&&(this.#h=e?t=>{e.addChild(t),this.#r.push(t)}:()=>{},this.ret=l.#i(t,(t=>this.fncFirstComp(t)),(t=>this.fncAllComp(t)),(t=>this.#h(t))))}static#e;static#o;static#a;static#n;static init(t,e,s,i,n){l.#e=t,l.#o=e,l.#a=s,l.#n=i,s.arg.crypto&&(l.#c=l.#l,l.#d=l.#p);const a=()=>{const t=l.#f*l.#t;for(const e of Object.values(l.#u))e.volume=t};n.setNoticeChgVolume((t=>{l.#f=t,a()}),(t=>{l.#t=t,a()}))}static#t=1;static#f=1;static#g;static setEvtMng(t){l.#g=t}ret=!1;#h;#r=[];destroy(){this.fncFirstComp=()=>{},this.fncAllComp=()=>{},this.#h=t=>t.destroy();for(const t of this.#r)l.stopVideo(t.name),t.parent?.removeChild(t),t.destroy();this.#r=[]}static destroy(){l.#y={},l.#m={},l.#u={}}static#i(t,e,s,n){if(!t)return!1;let a=!1;if(t.startsWith("data:")){const h=()=>{const h=i.w.from(t);n(h),e(h),s(a)};return t in i.q?h():(a=!0,(new i.L).add(t,t).load(h)),a}const h=[],r=new i.L,o=t.split(","),c=o.length;for(let t=0;t<c;++t){const s=o[t];if(!s)throw"face属性に空要素が含まれます";const{dx:n,dy:c,blendmode:d,fn:p}=l.#y[s]||{fn:s,dx:0,dy:0,blendmode:i.r.NORMAL},f=0===t?e:t=>{t.x=n,t.y=c,t.blendMode=d};if(h.push({fn:p,fnc:f}),p in l.#m||p in i.q||p in i.L.shared.resources)break;a=!0;const u=l.#e.searchPath(p,i.S.SP_GSM),g=this.#a.arg.crypto?{xhrType:".json"===u.slice(-5)?i.c.XHR_RESPONSE_TYPE.TEXT:i.c.XHR_RESPONSE_TYPE.BUFFER}:{};r.add({...g,name:p,url:u})}const d=(t,e)=>{for(const{fn:t,fnc:s}of h){const i=l.#b(t,e);i.name=t,n(i),s(i)}s(a)};return a?r.use((async(t,e)=>{try{if("json"===t.extension){const s=await this.#a.dec("json",t.data);return void l.#d(s,t,e)}const s=await this.#a.decAB(t.data);l.#c(s,t,e)}catch(e){const s=`画像/動画ロード失敗です fn:${t.name} ${e}`;l.#g.isSkipping?console.warn(s):console.error("%c"+s,"color:#FF3300;")}})).load(d):queueMicrotask((()=>d(0,{}))),a}static#y={};static#m={};static#c=(t,{type:e,name:s,data:n},a)=>{if(e===i.c.TYPE.VIDEO){const t=n;t.volume=l.#f,l.#u[s]=l.#_(t)}a()};static#x(t){const e=/([^\d]+)\d+\.(\w+)/.exec(t[0]??"");if(!e)return[];const s=e[1].length,n=-e[2].length-1;return t.sort(((t,e)=>(0,i.i)(t.slice(s,n))>(0,i.i)(e.slice(s,n))?1:-1))}static async#l(t,e,s){e.data=t,"bin"!==e.extension&&s(),t instanceof HTMLImageElement?(e.texture=await i.s.fromLoader(t,e.url,e.name),e.type=i.c.TYPE.IMAGE):t instanceof HTMLVideoElement&&(t.volume=l.#f,l.#u[e.name]=l.#_(t),e.type=i.c.TYPE.VIDEO),s()}static#_(t){return l.#o.getVal("const.sn.needClick2Play")&&(i.D.trace_beforeNew(`[lay系] ${i.D.strPos()}未クリック状態で動画を自動再生します。音声はミュートされます`,"W"),t.muted=!0),t.setAttribute("playsinline",""),t}static#d=(t,{type:e,spritesheet:s,name:n,data:a},h)=>{if(e===i.c.TYPE.JSON){const t=s._frameKeys;l.#x(t),l.#m[n]={aTex:t.map((t=>i.s.from(t))),meta:a.meta}}h()};static#p(t,e,s){const{meta:n,frames:a}=e.data=JSON.parse(t);if(e.type=i.c.TYPE.JSON,!n?.image)return void s();const h=(0,i.f)(n.image),r=l.#e.searchPath(h,i.S.SP_GSM);(new i.L).use(((t,e)=>{this.#a.decAB(t.data).then((s=>{t.data=s,s instanceof HTMLImageElement&&(t.type=i.c.TYPE.IMAGE,URL.revokeObjectURL(s.src)),e()})).catch((e=>this.#n.errScript(`画像/動画ロード失敗です dec2res4Cripto fn:${t.name} ${e}`,!1)))})).add({name:h,url:r,xhrType:i.c.XHR_RESPONSE_TYPE.BUFFER}).load(((t,h)=>{for(const{data:s}of Object.values(t.resources)){const{baseTexture:t}=i.s.from(s),h=Object.values(a);l.#m[e.name]={aTex:h.map((({frame:{x:e,y:s,w:n,h:a}})=>new i.s(t,new i.R(e,s,n,a)))),meta:n}}s()}))}static#b(t,e){const s=l.#m[t];if(s){const t=new i.v(s.aTex);return t.animationSpeed=s.meta.animationSpeed??1,t.play(),t}if(t in i.q)return i.w.from(t);const n=l.#u[t];if(n)return i.w.from(n);const a=e[t];return a?new i.w(a.texture):new i.w}static#u={};static getHFn2VElm(t){return l.#u[t]}static wv(t){const{fn:e}=t;if(!e)throw"fnは必須です";const s=l.#u[e];if(!s||s.loop)return!1;if(l.#g.isSkipping||s.ended)return l.stopVideo(e),!1;const n=()=>l.#g.breakEvent("wv fn:"+e);s.addEventListener("ended",n,{once:!0,passive:!0});const a=(0,i.a)(t,"stop",!0);return l.#g.waitEvent("wv fn:"+e,t,(()=>{s.removeEventListener("ended",n),a&&l.stopVideo(e),n()}))}static stopVideo(t){const e=l.#u[t];e&&(delete l.#u[t],e.pause(),e.currentTime=e.duration)}static add_face(t){const{name:e}=t;if(!e)throw"nameは必須です";if(e in l.#y)throw"一つのname（"+e+"）に対して同じ画像を複数割り当てられません";const{fn:s=e}=t;return l.#y[e]={fn:s,dx:(0,i.b)(t,"dx",0),dy:(0,i.b)(t,"dy",0),blendmode:i.x.getBlendmodeNum(t.blendmode||"")},!1}}class d extends i.x{static#e=new i.E;static#o;static init(t,e,s,i,n,a){d.#o=s,l.init(e,a,i,t,n)}static destroy(){d.#e.clear(),l.destroy()}#a=new c(this.ctn,this);constructor(){super(),i.C.isDbg&&(this.#n=t=>this.#a.setSp(t),this.cvsResize=()=>{super.cvsResize(),this.#a.cvsResize()})}#n=()=>{};#t="";#f="";#g="";lay=t=>{const e=this.#h(t,(t=>{t&&(0,a.e)()}));return e&&(0,a.d)(),e};#h(t,e){const{fn:s,face:n=""}=t;if(this.#a.sethArg(t),!s)return super.lay(t),this.ctn.children.length>0&&this.setPos(t),this.#f="",this.#t=this.#g=n,e(!1),!1;const a="fn"in t,h="face"in t;return this.clearLay({clear_filter:(0,i.a)(t,"clear_filter",!0)}),a&&(this.#f=s),h&&(this.#g=n),super.lay(t),t.dx=0,t.dy=0,this.#r.destroy(),this.#r=new l(this.#t=s+(n?","+n:""),this.ctn,(e=>{("width"in t||"height"in t)&&(e.width=(0,i.b)(t,"width",0),e.height=(0,i.b)(t,"height",0)),this.#i=e.width,this.#y=e.height,i.x.setXY(e,t,this.ctn,!0),i.x.setBlendmode(this.ctn,t),this.#n(e)}),(t=>e(t))),this.#r.ret}#r=new l;#i=0;#y=0;get width(){return this.#i}get height(){return this.#y}renderStart(){this.#c=new i.w(this.#m),this.#c.visible=!1,this.ctn.addChildAt(this.#c,0),this.#c.position.set(-this.ctn.x,-this.ctn.y);let t=()=>{const t=this.ctn.alpha;this.ctn.alpha=1;for(const t of this.ctn.children)t.visible=!0;this.#c.visible=!1,d.#o.renderer.render(this.ctn,{renderTexture:this.#m}),this.ctn.alpha=t;for(const t of this.ctn.children)t.visible=!1};if(!this.containMovement){let e=t;t=()=>{t=()=>{},e()}}this.#x=()=>{t(),this.#c.visible=!0},d.#o.ticker.add(this.#x)}#m=i.y.create({width:i.C.stageW,height:i.C.stageH});#c=new i.w;#x=()=>{};renderEnd(){d.#o.ticker.remove(this.#x),this.ctn.removeChild(this.#c);for(const t of this.ctn.children)t.visible=!0;this.#c.destroy(!0),this.#m=i.y.create({width:i.C.stageW,height:i.C.stageH})}setPos(t){i.x.setXY(this.ctn.children[0]??this.ctn,t,this.ctn,!0)}get containMovement(){if(""===this.#t)return!1;const t=this.ctn.children;return this.#t.split(",").some(((e,s)=>t[s]instanceof i.v||l.getHFn2VElm(e)))}clearLay(t){super.clearLay(t),this.#r.destroy(),this.#f="",this.#g="",this.#t=""}record=()=>({...super.record(),sBkFn:this.#f,sBkFace:this.#g});playback(t,e){if(super.playback(t,e),""===t.sBkFn&&""===t.sBkFace)return this.#f="",void(this.#g="");e.push(new Promise((e=>this.#h({fn:t.sBkFn,face:t.sBkFace,left:t.x,top:t.y,alpha:t.alpha,blendmode:i.x.getNum2Blendmode(t.blendMode),rotation:t.rotation,scale_x:t.scale_x,scale_y:t.scale_y},(s=>{this.ctn.position.set(t.x,t.y),e()})))))}makeDesignCast(t){this.ctn.visible&&t(this.#a)}cvsResize(){super.cvsResize()}showDesignCast(){this.#a.visible=!0}dump=()=>super.dump()+`, "pic":"${this.#t}"`}const p="、。，．）］｝〉」』】〕”〟ぁぃぅぇぉっゃゅょゎァィゥェォッャュョヮヵヶ！？!?‼⁉・ーゝゞヽヾ々",f="［（｛〈「『【〔“〝",u="─‥…",g=p,y=new RegExp(`[${p}]`),m=new RegExp(`[${f}]`),b=new RegExp(`[${u}]`),_=y;class x{#e=p;#o=f;#a=u;#n=g;get 行頭禁則(){return this.#e}get 行末禁則(){return this.#o}get 分割禁止(){return this.#a}get ぶら下げ(){return this.#n}#t=y;#f=m;#g=b;#h=_;break_fixed=!1;break_fixed_left=0;break_fixed_top=0;bura=!1;lay(t){t.kinsoku_sol&&(this.#e=t.kinsoku_sol,this.#t=new RegExp(`[${this.#e}]`)),t.kinsoku_eol&&(this.#o=t.kinsoku_eol,this.#r(),this.#f=new RegExp(`[${this.#o}]`)),t.kinsoku_dns&&(this.#a=t.kinsoku_dns,this.#i(),this.#g=new RegExp(`[${this.#a}]`)),t.kinsoku_bura&&(this.#n=t.kinsoku_bura,this.#r(),this.#i(),this.#h=new RegExp(`[${this.#n}]`)),"bura"in t&&(this.bura=(0,i.a)(t,"bura",!1)),this.break_fixed=(0,i.a)(t,"break_fixed",this.break_fixed),this.break_fixed_left=(0,i.b)(t,"break_fixed_left",this.break_fixed_left),this.break_fixed_top=(0,i.b)(t,"break_fixed_top",this.break_fixed_top)}#r(){const t=this.#o.length,e=this.#n.length;if(t<e)for(let e=0;e<t;++e){const t=this.#o[e];if(this.#n.includes(t))throw`禁則の競合があります。文字 ${t} がぶら下げ と 行末禁則 の両方に含まれます`}else for(let t=0;t<e;++t){const e=this.#n[t];if(this.#o.includes(e))throw`禁則の競合があります。文字 ${e} がぶら下げ と 行末禁則 の両方に含まれます`}}#i(){const t=this.#a.length,e=this.#n.length;if(t<e)for(let e=0;e<t;++e){const t=this.#a[e];if(this.#n.includes(t))throw`禁則の競合があります。文字 ${t} がぶら下げ と 分割禁止 の両方に含まれます`}else for(let t=0;t<e;++t){const e=this.#n[t];if(this.#a.includes(e))throw`禁則の競合があります。文字 ${e} がぶら下げ と 分割禁止 の両方に含まれます`}}reNew(t){t.#y(this.#e,this.#o,this.#a,this.#n),t.break_fixed=this.break_fixed,t.break_fixed_left=this.break_fixed_left,t.break_fixed_top=this.break_fixed_top,t.bura=this.bura}#y(t,e,s,i){this.#e!=t&&(this.#e=t,this.#t=new RegExp(`[${t}]`)),this.#o!=e&&(this.#o=e,this.#f=new RegExp(`[${e}]`)),this.#a!=s&&(this.#a=s,this.#g=new RegExp(`[${s}]`)),this.#n!=i&&(this.#n=i,this.#h=new RegExp(`[${i}]`))}record(){const t={break_fixed:this.break_fixed,break_fixed_left:this.break_fixed_left,break_fixed_top:this.break_fixed_top,bura:this.bura};return this.#e===p&&(t.行頭禁則=this.#e),this.#o===f&&(t.行末禁則=this.#o),this.#a===u&&(t.分割禁止=this.#a),this.#n===g&&(t.ぶら下げ=this.#n),t}playback(t){t&&(this.#y(t.行頭禁則??p,t.行末禁則??f,t.分割禁止??u,t.ぶら下げ??g),this.break_fixed=t.break_fixed,this.break_fixed_left=t.break_fixed_left,this.break_fixed_top=t.break_fixed_top,this.bura=t.bura)}hyph(t,e,s,i,n){let a,h=0,r=2,o=e=>(o=()=>!1,i===e?(i>0&&(t.innerHTML=n.replaceAll('class="sn_ch"','class="sn_ch sn_ch_in_default"')),!0):e<2);do{if(a=this.#c(t,e),h=a.length,o(h))break;let i=-1/0;for(;r<h;++r){const{elm:t,rect:e,ch:n}=a[r];if("RT"===t.tagName)continue;const o=s?e.y:e.x;if(i<=o||"SPAN"===t.previousElementSibling?.tagName&&t.previousElementSibling?.innerHTML.includes("<br>")||"SPAN"===t.parentElement?.previousElementSibling?.tagName&&t.parentElement?.previousElementSibling?.innerHTML.includes("<br>")){i=o,this.break_fixed||(this.break_fixed_left=e.x,this.break_fixed_top=e.y);continue}const c=this.#m(a,r),{elm:l,rect:d,ch:p}=a[c];if(!this.break_fixed){this.break_fixed_left=d.x,this.break_fixed_top=d.y;const t=globalThis.getComputedStyle(l),e=parseFloat(t.fontSize);s?this.break_fixed_top+=e:this.break_fixed_left+=e}i=-1/0;const f=r,{cont:u,ins:g}=this.bura?this.hyph_alg_bura(a,c,p,r):this.hyph_alg(a,c,p,r,n);if(r=g,u)continue;const y=a[r].elm,m=y.parentElement,b=document.createElement("br");if(m.classList.contains("sn_tx"))m.insertBefore(b,y);else{const t=m.parentElement;t.classList.contains("sn_ch")?t.parentElement.insertBefore(b,t):t.insertBefore(b,m)}r+=2,r<f&&(r=f),h=-1;break}}while(h<0);return[a,h]}#m(t,e){const s=e-1,{elm:i}=t[s];return"RT"!==i.tagName?s-("all"===i.style.textCombineUpright?Array.from(i.textContent??"").length-1:0):s-Array.from(i.textContent??"").length}#c(t,e){const s=[];if(t.nodeType!==t.TEXT_NODE)return Array.from(t.childNodes).map((t=>this.#c(t,e))).flat();const i=t.ownerDocument.createRange();i.selectNodeContents(t);let n=0;const a=i.endOffset;for(;n<a;){i.setStart(t,n),i.setEnd(t,++n);const a=i.toString();s.push({ch:a,rect:e(i,a),elm:i.startContainer.parentElement})}return i.detach(),s}hyph_alg(t,e,s,i,n){if(!this.#f.test(s))if(this.#t.test(n))for(;(i=this.#m(t,i))>=0&&this.#t.test(t[i].ch););else if(s!==n||!this.#g.test(s))return{cont:!0,ins:i+1};for(i=e;(i=this.#m(t,i))>=0&&this.#f.test(t[i].ch););return{cont:!1,ins:i+1}}hyph_alg_bura(t,e,s,i){const n=this.#m(t,e),{ch:a}=t[n];if(this.#h.test(a)||this.#t.test(a)){let i=e;(this.#h.test(s)||this.#t.test(s))&&++i;const n=this.#m(t,i),{ch:a}=t[n],{ch:h}=t[i];if(a===h&&this.#g.test(h))return{cont:!1,ins:n};if(!this.#f.test(a))return{cont:!1,ins:i};i=n;do{if(!this.#f.test(t[i].ch))break}while((i=this.#m(t,i))>=0);return{cont:!1,ins:i+1}}const h=this.#m(t,n);if(i>=3){const{ch:e}=t[h];if(this.#g.test(a)&&e===a)return{cont:!1,ins:h};if(this.#f.test(e)){let e=h;for(;(e=this.#m(t,e))>=0&&this.#f.test(t[e].ch););return{cont:!1,ins:e+1}}}return{cont:!1,ins:n}}}class w extends i.j{constructor(t,e,s){super(),this.ctn=t,this.canFocus=e,this.sys=s,this.#t.classList.add("sn_tx"),this.#t.style.position="absolute",w.#o.view.parentElement.appendChild(this.#t),this.addChild(this.#f),this.addChild(this.#g),this.#g.name="grpDbgMasume",this.noticeCompTxt=s.isApp&&w.#e.oCfg.debug.dumpHtm?()=>{a.R.noticeCompTxt();const e=this.#t.innerHTML;if(""===e)return;const{fn:i,ln:n}=w.#n.nowScrFnLn(),h=`dumpHtm ${t.name.slice(0,-7).replaceAll(":","=")}(fn=${i} line=${n})`;s.outputFile(s.path_downloads+h+".htm",`<!doctype html><html><head><meta charset=utf-8><title>${h}</title>\n<h1>${h}</h1>${e.replaceAll(/ class="sn_ch"|animation-delay: \d+ms; ?| data-add="{&quot;ch_in_style&quot;:&quot;default&quot;, &quot;ch_out_style&quot;:&quot;default&quot;}"/g,"").replaceAll(' style=""',"").replaceAll(/(<\/?ruby>)/g,"\n$1\n").replaceAll(/<(br|\/span)>/g,"<$1>\n")}`)}:()=>a.R.noticeCompTxt()}static#e;static#o;static init(t,e){w.#e=t,w.#o=e}static#a;static#n;static setEvtMng(t,e){w.#a=t,w.#n=e}static destroy(){w.#w=Object.create(null),w.#v=Object.create(null),w.delBreak()}#t=document.createElement("span");#f=new i.j;#g=new i.z;static#h={"background-color":0,"border-bottom-width":0,"border-left-width":0,"border-right-width":0,"border-top-width":0,"margin-bottom":0,"margin-left":0,"margin-right":0,"margin-top":0};#r=new x;noticeCompTxt=()=>{};#i={fontsize:24,$width:0,$height:0,pad_left:0,pad_right:0,pad_top:0,pad_bottom:0};lay(t){const e=this.#t.style;if("style"in t)if(t.style){const s=document.createElement("span");s.style.cssText=t.style;const n=s.style.length;for(let t=0;t<n;++t){const n=s.style[t];n in w.#h?i.D.myTrace(`${n}は指定できません`,"W"):e[n]=s.style[n]}!s.style.opacity&&"alpha"in t&&(e.opacity=String(this.ctn.alpha))}else this.#t.style.cssText="";else"alpha"in t&&(e.opacity=String(this.ctn.alpha));if("width"in t&&(e.width=(t.width??"0")+"px"),"height"in t&&(e.height=(t.height??"0")+"px"),"pl"in t&&(e.paddingLeft=(t.pl??"0")+"px"),"pr"in t&&(e.paddingRight=(t.pr??"0")+"px"),"pt"in t&&(e.paddingTop=(t.pt??"0")+"px"),"pb"in t&&(e.paddingBottom=(t.pb??"0")+"px"),this.#r.lay(t),this.#m(),this.#c=this.ctn.position.x,e.transformOrigin=`${this.ctn.pivot.x}px ${this.ctn.pivot.y}px`,this.cvsResize(),e.display=this.ctn.visible?"inline":"none",":redraw"in t&&this.#s>0){const t=[this.#t.innerHTML.replaceAll(/(animation-delay: )\d+ms/g,"$10ms"),"<span class='sn_ch' data-add='{\"ch_in_style\":\"default\"}'>&emsp;</span>"];this.#k(),this.goTxt(t,!0)}}#y=0;#m(){const t=this.#t.style,e=parseFloat(t.fontSize||"0");this.#i.fontsize=e,this.#i.pad_left=parseFloat(t.paddingLeft||"0"),this.#i.pad_right=parseFloat(t.paddingRight||"0"),this.#i.pad_top=parseFloat(t.paddingTop||"0"),this.#i.pad_bottom=parseFloat(t.paddingBottom||"0"),this.#i.$width=parseFloat(t.width||"0"),this.#i.$height=parseFloat(t.height||"0"),this.position.set(this.#i.pad_left,this.#i.pad_top),this.#x="vertical-rl"===t.writingMode,this.#l=0,this.#_=0;const s=t.lineHeight??"0";this.#y=this.#x?0:(s.endsWith("px")?parseFloat(s):e*parseFloat(s)-e)/2}cvsResize(){const t=this.#t.style,e=this.sys.cvsScale;t.left=`${this.sys.ofsLeft4elm+this.#c*e}px`,t.top=`${this.sys.ofsTop4elm+this.ctn.position.y*e}px`,t.transform=`rotate(${this.ctn.angle}deg) scale(${this.ctn.scale.x*e}, ${this.ctn.scale.y*e})`}#c=0;#x=!1;get tategaki(){return this.#x}#l=0;#_=0;get infTL(){return this.#i}get getWidth(){return this.#i.$width}get getHeight(){return this.#i.$height}setMySize(t,e){this.#i.$width=t,this.#i.$height=e,this.#t.style.width=this.#i.$width+"px",this.#t.style.height=this.#i.$height+"px"}#d(t,e=!0){const s={escape:t=>t.replaceAll(/([.*+?^${}()|\[\]\/\\])/g,"\\$1"),mimeType:t=>{const e=function(t){return/\.([^\.\/]*?)$/g.exec(t)?.[1]??""}(t).toLowerCase();return function(){const t="application/font-woff",e="image/jpeg";return{woff:t,woff2:t,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:e,jpeg:e,gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"}}()[e]||""},dataAsUrl:function(t,e){return"data:"+e+";base64,"+t},isDataUrl:function(t){return-1!==t.search(/^(data:)/)},resolveUrl:function(t,e){const s=document.implementation.createHTMLDocument(),i=s.createElement("base");s.head.appendChild(i);const n=s.createElement("a");return s.body.appendChild(n),i.href=e,n.href=t,n.href},getAndEncode:function(t){return new Promise((function(e){const s=new XMLHttpRequest;function i(t){console.error(t),e("")}s.onreadystatechange=function(){if(4!==s.readyState)return;if(200!==s.status)return void i("cannot fetch resource: "+t+", status: "+s.status);const n=new FileReader;n.onloadend=function(){const t=n.result.toString().split(/,/)[1];e(t)},n.readAsDataURL(s.response)},s.ontimeout=function(){i("timeout of 30000ms occured while fetching resource: "+t)},s.responseType="blob",s.timeout=3e4,s.open("GET",t,!0),s.send()}))},asArray:t=>{const e=[],s=t.length;for(let i=0;i<s;++i)e.push(t[i]);return e}},n=function(){const t=/url\(['"]?([^'"]+?)['"]?\)/g;return{inlineAll:function(t,s,a){return e(t)?Promise.resolve(t).then(i).then((e=>{let i=Promise.resolve(t);for(const t of e)i=i.then((e=>n(e,t,s,a)));return i})):Promise.resolve(t)},shouldProcess:e};function e(e){return-1!==e.search(t)}function i(e){const i=[];let n;for(;n=t.exec(e);)i.push(n[1]);return i.filter((function(t){return!s.isDataUrl(t)}))}function n(t,e,i,n){return Promise.resolve(e).then((t=>i?s.resolveUrl(t,i):t)).then(n||s.getAndEncode).then((t=>s.dataAsUrl(t,s.mimeType(e)))).then((i=>t.replace(function(t){return new RegExp("(url\\(['\"]?)("+s.escape(t)+")(['\"]?\\))","g")}(e),"$1"+i+"$3")))}}(),a=function(){return{resolveAll:function(){return t().then((t=>Promise.allSettled(t.map((t=>t.resolve()))))).then((t=>t.join("\n")))},impl:{readAll:t}};function t(){return Promise.resolve(s.asArray(document.styleSheets)).then((function(t){const e=[];for(const i of t)try{if(i.href)continue;s.asArray(i.cssRules||[]).forEach(e.push.bind(e))}catch(t){console.error("Error while reading CSS rules from "+i.href,String(t))}return e})).then((function(t){return t.filter((t=>t.type===CSSRule.FONT_FACE_RULE)).filter((t=>n.shouldProcess(t.style.getPropertyValue("src"))))})).then((e=>e.map(t)));function t(t){return{resolve:function(){const e=(t.parentStyleSheet||{}).href;return n.inlineAll(t.cssText,e)},src:function(){return t.style.getPropertyValue("src")}}}}}();Promise.resolve(this.#t).then((t=>{const s=t.cloneNode(!0);return s.style.padding="0px",s.style.paddingRight=this.#l+"px",s.style.paddingTop=this.#_+"px",s.style.left="0px",s.style.top="0px",s.style.width=this.#i.$width-this.#i.pad_left-this.#i.pad_right+"px",s.style.height=this.#i.$height-this.#i.pad_top-this.#i.pad_bottom+"px",this.#t.hidden=e,s})).then((function(t){return a.resolveAll().then((e=>{const s=document.createElement("style");return t.appendChild(s),s.appendChild(document.createTextNode(e)),t}))})).then((t=>{t.setAttribute("xmlns","http://www.w3.org/1999/xhtml");const e=new Image;return e.src=`data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="${this.#i.$width}px" height="${this.#i.$height}px"><foreignObject x="0" y="0" width="100%" height="100%">${(new XMLSerializer).serializeToString(t).replaceAll("#","%23").replaceAll("\n","%0A")}</foreignObject></svg>`,new Promise((t=>e.onload=()=>t(e)))})).then((t=>new Promise((e=>setTimeout((()=>e(t)),100))))).then((e=>{const s=document.createElement("canvas");s.width=this.#i.$width,s.height=this.#i.$height,s.getContext("2d").drawImage(e,0,0),t(i.s.from(s))})).catch((t=>i.D.myTrace(`goTxt() = ${t}`)))}#p=void 0;#b=[];#u=[];#s=0;static#$="<span class='sn_ch sn_ch_last'>&emsp;</span>";goTxt(t,e){w.#C.visible=!1;let s=this.#u.length,a="";if(0===s){if(w.#e.oCfg.debug.masume&&(i.C.debugLog&&console.log(`🍌 masume ${this.name} v:${this.visible} l:${this.x} t:${this.y} a:${this.alpha} pl:${this.#i.pad_left} pr:${this.#i.pad_right} pt:${this.#i.pad_top} pb:${this.#i.pad_bottom} w:${this.#i.$width} h:${this.#i.$height}`),this.#g.clear().beginFill(3407616,.2).lineStyle(1,3407616,1).drawRect(-this.#i.pad_left,-this.#i.pad_top,this.#i.$width,this.#i.$height).endFill().beginFill(13311,.2).lineStyle(2,13311,1).drawRect(0,0,this.#i.$width-this.#i.pad_left-this.#i.pad_right,this.#i.$height-this.#i.pad_top-this.#i.pad_bottom).endFill()),this.#t.innerHTML=[...t].join("").replaceAll(/[\n\t]/g,"")+w.#$,!this.#r.break_fixed){const t=globalThis.getComputedStyle(this.#t),e=parseFloat(t.fontSize);this.#x?(this.#r.break_fixed_left=(this.#i.$width-this.#i.pad_left-this.#i.pad_right-1.5*e)*this.sys.cvsScale,this.#r.break_fixed_top=0):(this.#r.break_fixed_left=0,this.#r.break_fixed_top=e/2*this.sys.cvsScale)}}else a=this.#t.innerHTML,--s,this.#t.querySelector(".sn_ch_last")?.remove(),this.#t.querySelectorAll(":scope > br").forEach((t=>t.remove())),this.#t.insertAdjacentHTML("beforeend",t.slice(this.#s).join("").replaceAll(/[\n\t]/g,"")+w.#$);this.#t.querySelectorAll(".sn_ch:has(> ruby)").forEach((t=>t.style.background="")),this.#s=t.length;const h=this.sys.cvsScale,r=this.#t.getBoundingClientRect(),o=r.left+this.#i.pad_left,c=r.top+this.#i.pad_top;let d;if(1===h)d=(t,e)=>{const s=t.getBoundingClientRect();return new i.R(s.left-o,s.top-c,s.width,s.height+("gjqy".includes(e)?this.#y:0))};else{const t=this.sys.ofsPadLeft_Dom2PIXI+r.left*(1-h),e=this.sys.ofsPadTop_Dom2PIXI+r.top*(1-h);d=(s,n)=>{const a=s.getBoundingClientRect();return new i.R((a.left-t)/h-o,(a.top-e)/h-c,a.width/h,(a.height+("gjqy".includes(n)?this.#y:0))/h)}}const[p,f]=this.#r.hyph(this.#t,d,this.#x,s,a);this.#u=p;const u=i.C.debugLog?({ch:t},{x:e,y:s,width:i,height:n})=>console.log(`🍌 masume ch:${t} x:${e} y:${s} w:${i} h:${n}`):()=>{},g=w.#e.oCfg.debug.masume?(t,e)=>{u(t,e),this.#g.beginFill(6737151,.5).lineStyle(2,16724736,1).drawRect(e.x,e.y,e.width,e.height).endFill()}:()=>{},y=n.C.ease(this.#T);for(let t=s;t<f;++t){const e=this.#u[t],s=e.rect,n=JSON.parse(e.elm.dataset.arg??'{"delay": 0}'),a=JSON.parse(e.elm.dataset.add??"{}"),h=w.#w[a.ch_in_style];if(g(e,s),"grp"===e.elm.dataset.cmd){const t=new i.j;this.#f.addChild(t),new l(n.pic,t,(e=>{this.#S(t,n,a,s,y,h??{}),t.parent||t.removeChild(e)}))}if(e.elm.dataset.lnk){const n=e.elm.parentElement.closest("[data-arg]"),r=JSON.parse(n.dataset.arg??"{}");r.key=`lnk=[${t}] `+this.name;const o=new i.w;this.#S(o,r,a,s,y,h??{});const c=r.style??"",l=c+(r.style_hover??""),d=c+(r.style_clicked??""),p=r.r_style??"",f=p+(r.r_style_hover??""),u=p+(r.r_style_clicked??""),g=Array.from(n.getElementsByTagName("rt"));for(const t of g)t.dataset.st_r_bk=t.style.cssText;const m=n.style.cssText,b=(t,e)=>{n.style.cssText=m+t;for(const t of g)t.style.cssText=t.dataset.st_r_bk+e};(0,i.a)(r,"enabled",!0)?w.#a.button(r,o,(()=>b(c,p)),(()=>!!this.canFocus()&&(b(l,f),!0)),(()=>b(d,u))):b(c+(r.style_disable??"color: gray;"),p+(r.r_style_disable??"color: gray;")),this.#f.addChild(o)}}const m=Array.from(this.#t.getElementsByClassName("sn_ch"));this.#E=()=>{this.#E=()=>!1;for(const t of m)t.className=t.className.replaceAll(/ go_ch_in_[^\s"]+/g,"");return w.#C.position.set(this.#r.break_fixed_left,this.#r.break_fixed_top),w.#C.visible=!0,this.noticeCompTxt(),!0};for(const t of m)t.className=t.className.replaceAll(/sn_ch_in_([^\s"]+)/g,"go_ch_in_$1");let b;s>0&&++s;for(let t=f-2;t>=0;--t){const{elm:e}=this.#u[t];if("SPAN"===e.tagName){b="RUBY"===e.parentElement?.tagName?e.parentElement.parentElement??e:e;break}}b&&!e&&s!==f?b.addEventListener("animationend",(()=>this.#E()),{once:!0,passive:!0}):this.#E()}#E=()=>!1;#S(t,e,s,i,n,h){t.alpha=0,e.x&&(i.x=e.x.startsWith("=")?i.x+parseInt(e.x.slice(1)):parseInt(e.x)),e.y&&(i.y=e.y.startsWith("=")?i.y+parseInt(e.y.slice(1)):parseInt(e.y)),e.width&&(i.width=parseInt(e.width)),e.height&&(i.height=parseInt(e.height)),e.wait&&(h.wait=parseInt(e.wait)),t.width=i.width,t.height=i.height,h.x?t.position.set(h.x.startsWith("=")?i.x+t.width*h.nx:h.nx,h.y.startsWith("=")?i.y+t.height*h.ny:h.ny):t.position.set(i.x,i.y);const r={sp:t,tw:new a.T(t).to({alpha:1,x:i.x,y:i.y,width:i.width,height:i.height,angle:0},h.wait??0).easing(n).delay((s.wait??0)+(e.delay??0)).onComplete((()=>{r.tw=void 0})).start()};this.#b.push(r)}skipChIn(){let t=this.#E();for(const e of this.#b)e.tw&&(e.tw.stop().end(),t=!0);return this.#b=[],t}static#w=Object.create(null);static#N=/[\s\.,]/;static initChStyle(){w.#w=Object.create(null),w.#v=Object.create(null)}static getChInStyle(t){return w.#w[t]}static ch_in_style(t){const{name:e}=t;if(!e)throw"nameは必須です";if(w.#N.test(e))throw`name【${e}】に使えない文字が含まれます`;if(e in w.#w)throw`name【${e}】はすでにあります`;const s=String(t.x??"=0"),n=String(t.y??"=0");return w.#w[e]={wait:(0,i.b)(t,"wait",500),alpha:(0,i.b)(t,"alpha",0),x:s,y:n,nx:parseFloat("="===s.at(0)?s.slice(1):s),ny:parseFloat("="===n.at(0)?n.slice(1):n),scale_x:(0,i.b)(t,"scale_x",1),scale_y:(0,i.b)(t,"scale_y",1),rotate:(0,i.b)(t,"rotate",0),join:(0,i.a)(t,"join",!0),ease:t.ease??"ease-out"}}static#v=Object.create(null);static getChOutStyle(t){return w.#v[t]}static ch_out_style(t){const{name:e}=t;if(!e)throw"nameは必須です";if(w.#N.test(e))throw`name【${e}】に使えない文字が含まれます`;if(e in w.#v)throw`name【${e}】はすでにあります`;const s=String(t.x??"=0"),n=String(t.y??"=0");return w.#v[e]={wait:(0,i.b)(t,"wait",500),alpha:(0,i.b)(t,"alpha",0),x:s,y:n,nx:parseFloat("="===s.at(0)?s.slice(1):s),ny:parseFloat("="===n.at(0)?n.slice(1):n),scale_x:(0,i.b)(t,"scale_x",1),scale_y:(0,i.b)(t,"scale_y",1),rotate:(0,i.b)(t,"rotate",0),join:(0,i.a)(t,"join",!1),ease:t.ease??"ease-out"}}static#C=new i.j;static#A=new l;dispBreak(t){w.delBreak();const e=w.#C;e.visible=!1,this.addChild(e),w.#A.destroy(),w.#A=new l(t.pic,e,(s=>{e.parent?(s.x=(0,i.b)(t,"x",0),s.y=(0,i.b)(t,"y",0),s.width=(0,i.b)(t,"width",this.#i.fontsize),s.height=(0,i.b)(t,"height",this.#i.fontsize)):e.removeChild(s)}))}static delBreak(){const t=w.#C;t.parent?.removeChild(t),w.#A.destroy()}#T="Quadratic.Out";#O="Quadratic.Out";#k(){this.#g.clear(),this.#u=[],this.#s=0,this.skipChIn();const t=this.#t.cloneNode(!0);t.textContent="";const e=this.#t;e.parentElement.insertBefore(t,e);let s=0;e.querySelectorAll("span.sn_ch").forEach((t=>{const e=JSON.parse(t?.dataset.add??t?.children[0]?.getAttribute("data-add")??t?.children[0]?.children[0]?.getAttribute("data-add")??"{}");if(!e.ch_out_style)return;const i=w.#v[e.ch_out_style];if(i){if(0===i.wait)return void(t.style.display="none");s+=i.wait,i.join||(t.style.animationDelay="0ms"),t.classList.add(`go_ch_out_${e.ch_out_style}`)}}));const n=()=>{e.parentElement.removeChild(e);for(const t of this.#f.removeChildren())t instanceof i.j&&w.#a.unButton(t),t.destroy()};0===s?(this.#t.textContent="",n()):e.lastElementChild?.addEventListener("animationend",n,{once:!0,passive:!0}),this.#t=t}reNew(){this.#k();const t=new w(this.ctn,(()=>this.canFocus()),this.sys);return t.#i=this.#i,t.#t.style.cssText=this.#t.style.cssText,t.#c=this.#c,t.name=this.name,t.#m(),t.#p=this.#p,t.#T=this.#T,t.#O=this.#O,this.#r.reNew(t.#r),this.destroy(),t}record(){return{infTL:this.#i,cssText:this.#t.style.cssText,left:this.#c,ch_filter:this.#p,fi_easing:this.#T,fo_easing:this.#O,hyph:this.#r.record()}}playback(t){this.#i=t.infTL,this.position.set(this.#i.pad_left,this.#i.pad_top),this.#t.style.cssText=t.cssText,this.#c=t.left,this.#m(),this.#p=t.ch_filter,this.#T=t.fi_easing,this.#O=t.fo_easing,this.#r.playback(t.hyph)}get cssText(){return this.#t.style.cssText}set cssText(t){this.#t.style.cssText=t}#R=void 0;snapshot(t,e){this.#d((s=>{this.#R=i.w.from(s),this.#x&&(this.#R.x+=i.C.stageW-(this.#c+this.#i.$width)),this.#R.y-=this.#_,this.#R.texture.frame=new i.R(0,0,Math.min(this.#R.width,this.#i.$width-this.#c),Math.min(this.#R.height,this.#i.$height)),this.#f.addChild(this.#R),t.render(this.#R,{clear:!1}),e()}),!1)}snapshot_end(){this.#R&&(this.#f.removeChild(this.#R),this.#R=void 0)}makeDesignCast(t){}showDesignCast(){}dump(){const t=[],e=this.#t.style,s=e.length;for(let i=0;i<s;++i){const s=e[i];t.push(`"${s}":"${e[s].replaceAll(/(["\\])/g,"\\$1")}"`)}return`"txt":"${this.#t.textContent.replaceAll(/(["\\])/g,"\\$1")}", "style":{${t.join(",")}}`}destroy(){w.delBreak(),this.#t.parentElement.removeChild(this.#t),this.removeChild(this.#f),this.removeChild(this.#g),super.destroy()}}class v extends i.j{constructor(t,e,s,n){if(super(),this.hArg=t,this.evtMng=e,this.resolve=s,this.canFocus=n,this.#t={type:"pic",enabled:(0,i.a)(t,"enabled",!0),x:this.x=(0,i.u)(t.left??0),y:this.y=(0,i.u)(t.top??0),rotation:this.angle=(0,i.b)(t,"rotation",this.angle),pivot_x:this.pivot.x=(0,i.b)(t,"pivot_x",this.pivot.x),pivot_y:this.pivot.y=(0,i.b)(t,"pivot_y",this.pivot.y),scale_x:this.scale.x=(0,i.b)(t,"scale_x",this.scale.x),scale_y:this.scale.y=(0,i.b)(t,"scale_y",this.scale.y),alpha:1,text:"",b_pic:"",width:0,height:0},this.getBtnBounds=()=>(this.#a.x=this.#t.x,this.#a.y=this.#t.y,this.#a),this.#t.enabled&&e.button(t,this,(()=>this.normal()),(()=>this.#g()),(()=>this.#h())),t.pic)return this.#t.type="pic",void(this.#n=new l(t.pic,this,(t=>{this.#r(t),this.#a.width=t.width*this.#t.scale_x,this.#a.height=t.height*this.#t.scale_y}),(t=>s)));if(!t.text)throw"textまたはpic属性は必須です";const a=(0,i.b)(t,"height",30),h=new i.F({align:"center",dropShadow:!0,dropShadowAlpha:.7,dropShadowColor:"white",dropShadowBlur:7,dropShadowDistance:0,fill:this.#t.enabled?"black":"gray",fontFamily:v.fontFamily,fontSize:a,padding:5});if(t.style)try{const e=JSON.parse(t.style);for(const[t,s]of Object.entries(e))h[t]=s;this.#t={...this.#t,...e}}catch(e){throw e instanceof SyntaxError?new Error((0,i.o)(t,"style",e.message)):"fn:Button.ts style"}const r=new i.H(t.text??"",h);r.alpha=(0,i.b)(t,"alpha",r.alpha),r.width=(0,i.b)(t,"width",100),r.height=t.height=a,this.setText=t=>r.text=t,this.#t={...this.#t,type:"text",alpha:r.alpha,text:r.text,width:r.width,height:r.height};let o=!1;if(this.#t.width=this.width,this.#t.height=this.height,t.b_pic&&(this.#t.b_pic=t.b_pic,this.#n=new l(t.b_pic,this,(t=>{this.#f(t,r),this.#t.width=this.width,this.#t.height=this.height,r.name=JSON.stringify(this.#t)}),(e=>{i.x.setBlendmode(this,t),e&&s()})),o=this.#n.ret),r.name=JSON.stringify(this.#t),this.addChild(r),this.#a.width=r.width,this.#a.height=r.height,t.b_pic||i.x.setBlendmode(this,t),v.#e(this,r),!this.#t.enabled)return void(o||s());const c=h.clone();if(t.style_hover)try{const e=JSON.parse(t.style_hover);for(const[t,s]of Object.entries(e))c[t]=s}catch(e){throw e instanceof SyntaxError?new Error((0,i.o)(t,"style_hover",e.message)):"fn:Button.ts style_hover"}else c.fill="white";const d=c.clone();if(t.style_clicked)try{const e=JSON.parse(t.style_clicked);for(const[t,s]of Object.entries(e))d[t]=s}catch(e){throw e instanceof SyntaxError?new Error((0,i.o)(t,"style_clicked",e.message)):"fn:Button.ts style_clicked"}else d.dropShadow=!1;this.normal=()=>r.style=h,this.#g=()=>!!n()&&(r.style=c,!0),this.#h=()=>r.style=d,o||s()}static fontFamily="'Hiragino Sans', 'Hiragino Kaku Gothic ProN', '游ゴシック Medium', meiryo, sans-serif";static#e=(t,e)=>{};static#o=(t,e,s,i)=>{};static init(t){t.oCfg.debug.masume&&(v.#e=(t,e)=>t.addChild((new i.z).beginFill(8926088,.2).lineStyle(1,8926088,1).drawRect(e.x,e.y,e.width,e.height).endFill()),v.#o=(t,e,s,n)=>t.addChild((new i.z).beginFill(8926088,.2).lineStyle(1,8926088,1).drawRect(e.x,e.y,s,n).endFill()))}setText(t){}getBtnBounds=()=>this.#a;#a=new i.R;#n=new l;#t;destroy(){this.evtMng.unButton(this),this.#n.destroy(),super.destroy()}makeDesignCast(t){}showDesignCast(){}cvsResize(){}#f(t,e){this.setChildIndex(t,0),t.alpha=e.alpha,t.setTransform(e.x,e.y,1,1,e.rotation,0,0,(t.width-e.width)/2,(t.height-e.height)/2),t.name=e.name}normal=()=>{};#g=()=>!1;#h=()=>{};#r(t){this.#t.alpha=t.alpha=(0,i.b)(this.hArg,"alpha",t.alpha);const e=t.width/3,s=this.#t.enabled?e:t.width,n=t.height,a=t.texture.baseTexture,h=new i.s(a,new i.R(0,0,e,n)),r=new i.s(a,new i.R(e,0,e,n)),o=new i.s(a,new i.R(2*e,0,e,n)),c=()=>t.texture=h;this.#t.enabled&&c(),this.normal=c,this.#g=()=>!!this.canFocus()&&(t.texture=o,!0),this.#h=()=>t.texture=r,"width"in this.hArg?(this.#t.width=(0,i.u)(this.hArg.width),this.scale.x*=this.#t.width/s):this.#t.width=s,"height"in this.hArg?(this.#t.height=(0,i.u)(this.hArg.height),this.scale.y*=this.#t.height/n):this.#t.height=n,t.name=JSON.stringify(this.#t),v.#o(this,t,s,n)}}class k extends i.x{static#e;static#o;static#a;static#n;static init(t,e,s,n,a,h){k.#e=t,w.init(t,h),k.#o=s,k.#n=n,k.#a=a,s.setDoRecProc(k.chgDoRec),e.autowc=t=>k.#y(t),e.autowc({enabled:!1,text:"",time:0}),e.ch_in_style=t=>k.#t(t),e.ch_out_style=t=>k.#f(t),w.initChStyle(),(0,i.I)(),(0,i.k)(t.matchPath(".+",i.S.FONT).flatMap((t=>Object.values(t).map((t=>`\n@font-face {\n\tfont-family: '${t}';\n\tsrc: url('${this.#e.searchPath(t,i.S.FONT)}');\n}\n`)))).join("")+"\n.sn_tx {\n\tpointer-events: none;\n\tuser-select: none;\n\t-webkit-touch-callout: none;\n\tbox-sizing: border-box;\n}\n.sn_ch {\n\tposition: relative;\n\tdisplay: inline-block;\n}\n"),k.#t({name:"default",wait:500,alpha:0,x:"=0.3",y:"=0",scale_x:1,scale_y:1,rotate:0,join:!0,ease:"ease-out"}),k.#f({name:"default",wait:0,alpha:0,x:"=0",y:"=0",scale_x:1,scale_y:1,rotate:0,join:!1,ease:"ease-out"})}static#t(t){const e=w.ch_in_style(t),s=e.x.startsWith("=")?100*e.nx+"%":`${e.nx}px`,n=e.y.startsWith("=")?100*e.ny+"%":`${e.ny}px`,{name:a}=t;return(0,i.k)(`\n.sn_ch_in_${a} {\n\tposition: relative;\n\tdisplay: inline-block;\n}\n.go_ch_in_${a} {\n\topacity: ${e.alpha};\n\tposition: relative;\n\tdisplay: inline-block;\n\tanimation: sn_ch_in_${a} ${e.wait}ms ${e.ease} 0s both;\n}\n@keyframes sn_ch_in_${a} {\n\tfrom {transform: rotate(${e.rotate}deg) scale(${e.scale_x}, ${e.scale_y}) translate(${s}, ${n})}\n\tto {opacity: 1; transform: none;}\n}\n`),!1}static#f(t){const e=w.ch_out_style(t),s=e.x.startsWith("=")?100*e.nx+"%":`${e.nx}px`,n=e.y.startsWith("=")?100*e.ny+"%":`${e.ny}px`,{name:a}=t;return(0,i.k)(`\n.go_ch_out_${a} {\n\tposition: relative;\n\tdisplay: inline-block;\n\tanimation: go_ch_out_${a} ${e.wait}ms ${e.ease} 0s both;\n}\n@keyframes go_ch_out_${a} {\n\tto {\n\t\topacity: ${e.alpha};\n\t\ttransform: rotate(${e.rotate}deg) scale(${e.scale_x}, ${e.scale_y}) translate(${s}, ${n});\n\t}\n`),!1}static#g;static#h;static setEvtMng(t,e,s){k.#g=t,k.#h=e,w.setEvtMng(t,s)}static#r=!1;static#i={};static#y(t){k.#r=(0,i.a)(t,"enabled",k.#r),k.#o.setVal_Nochk("save","const.sn.autowc.enabled",k.#r);const{text:e}=t;if("text"in t!="time"in t)throw"[autowc] textとtimeは同時指定必須です";if(k.#o.setVal_Nochk("save","const.sn.autowc.text",e),!e)return k.#o.setVal_Nochk("save","const.sn.autowc.time",""),!1;const s=e.length;if(k.#r&&0===s)throw'[autowc] enabled === false かつ text === "" は許されません';const n=String(t.time).split(",");if(n.length!==s)throw"[autowc] text文字数とtimeに記述された待ち時間（コンマ区切り）は同数にして下さい";k.#i={};for(let t=0;t<s;++t)k.#i[e[t]]=(0,i.u)(n[t]);return k.#o.setVal_Nochk("save","const.sn.autowc.time",t.time),!1}#m=0;#c=0;#x=!1;#l=void 0;#_="";#d=new w(this.ctn,(()=>this.canFocus()),k.#h);#p=new h.R;#b=document.createElement("span");static#u={"text-align":0,"text-align-last":0,height:0,width:0,"padding-left":0,"padding-right":0,"padding-top":0,"padding-bottom":0};#s=new i.j;constructor(){super(),this.ctn.addChild(this.#d),this.#p.init(this.#F),this.ctn.addChild(this.#s),this.#s.name="cntBtn",this.lay({style:`width: ${i.C.stageW}px; height: ${i.C.stageH}px; font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', '游ゴシック Medium', meiryo, sans-serif; color: white; font-size: 24px; line-height: 1.5; padding: 16px;`,in_style:"default",out_style:"default",back_clear:"true"})}destroy(){this.#l&&(this.ctn.removeChild(this.#l).destroy(),this.#l=void 0),k.#n.recPagebreak(),this.#d.destroy()}static destroy(){k.#r=!1,k.#i={},k.#I=t=>t}set name(t){this.name_=t,this.#d.name=t}get name(){return this.name_}cvsResize(){this.#d.cvsResize()}cvsResizeChildren(){for(const t of this.#s.children)t.cvsResize()}procSetX(t){this.#d.lay({x:t})}procSetY(t){this.#d.lay({y:t})}lay(t){if(super.lay(t),i.x.setXY(this.ctn,t,this.ctn),t[":id_tag"]=this.name_.slice(0,-7),h.R.setting(t),this.#A(t),this.#d.lay(t),"r_align"in t&&(this.#P=t.r_align??""),this.#j=i.C.isSafari?this.#d.tategaki?(t,e)=>`text-align: start; height: ${e}em; padding-top: ${t}; padding-bottom: ${t};`:(t,e)=>`text-align: start; width: ${e}em; padding-left: ${t}; padding-right: ${t};`:this.#d.tategaki?t=>`text-align: justify; text-align-last: justify; padding-top: ${t}; padding-bottom: ${t};`:t=>`text-align: justify; text-align-last: justify; padding-left: ${t}; padding-right: ${t};`,i.C.isFirefox&&(this.#L=this.#B),"r_style"in t)if(t.r_style){const e=document.createElement("span");e.style.cssText=t.r_style;const s=e.style.length,n=this.#b.style;for(let t=0;t<s;++t){const s=e.style[t];if(s in k.#u){i.D.myTrace(`${s}は指定できません`,"W");continue}const a=e.style[s];a&&(n[s]=a)}}else this.#b.style.cssText="";if("alpha"in t)for(const t of this.#s.children)t.alpha=this.ctn.alpha;this.#$(t),this.#w(t);const e=this.#C(t,(t=>{t&&(0,a.e)()}));return e&&(0,a.d)(),e}#$(t){const{in_style:e}=t;if(!e)return;const s=w.getChInStyle(e);if(!s)throw`存在しないin_style【${e}】です`;this.#E=e,this.#S=s.join}#E="";#S=!0;get width(){return this.#d.getWidth}get height(){return this.#d.getHeight}#w(t){const{out_style:e}=t;if(e){if(!w.getChOutStyle(e))throw`存在しないout_style【${e}】です`;this.#N=e}}#N="";#v=new l;#C(t,e){if("back_clear"in t)return(0,i.a)(t,"back_clear",!1)&&(this.#m=0,this.#c=0,this.#x=!1,this.#_=""),e(!1),!1;this.#c=(0,i.b)(t,"b_alpha",this.#c),this.#x=(0,i.a)(t,"b_alpha_isfixed",this.#x);const s=(this.#x?1:Number(k.#o.getVal("sys:TextLayer.Back.Alpha")))*this.#c;if(t.b_pic){if(this.#_!==t.b_pic)return this.#_=t.b_pic,this.#l&&(this.ctn.removeChild(this.#l),this.#l.destroy()),this.#v=new l(this.#_,this.ctn,(t=>{this.#l=t,t.name="back(pic)",t.visible=s>0,t.alpha=s,this.#d.setMySize(t.width,t.height),this.ctn.setChildIndex(t,0),e(!0)})),this.#v.ret}else"b_color"in t&&(this.#m=(0,i.J)(t,"b_color",0),this.#l&&(this.ctn.removeChild(this.#l),this.#l.destroy()),this.#_="",this.ctn.addChildAt((this.#l=new i.z).beginFill(this.#m).lineStyle(void 0).drawRect(0,0,this.#d.getWidth,this.#d.getHeight).endFill(),0),this.#l.name="back(color)");return this.#l&&(this.#l.visible=s>0,this.#l.alpha=s),e(!1),!1}chgBackAlpha(t){const e=this.#x?this.#c:t*this.#c;this.#l instanceof i.z&&(this.#l&&(this.ctn.removeChild(this.#l),this.#l.destroy()),this.ctn.addChildAt((this.#l=new i.z).beginFill(this.#m).lineStyle(void 0).drawRect(0,0,this.#d.getWidth,this.#d.getHeight).endFill(),0),this.#l.name="back(color)"),this.#l&&(this.#l.visible=e>0,this.#l.alpha=e)}#A(t){"noffs"in t&&(this.#k=t.noffs??"",this.#R=new RegExp(`[　${this.#k}]`)),"ffs"in t&&(this.#T??="",this.#O=""===this.#T?()=>"":t=>this.#R.test(t)?"":` font-feature-settings: ${this.#T};`)}#T="";#O=t=>"";#k="";#R=/[　]/;static chgDoRec(t){k.#I=t?t=>t:t=>`<span class='offrec'>${t}</span>`}static#I=t=>t;isCur=!1;#j=()=>"";#L=(t,e,s,i="")=>{if(!s)return` style='${i}'`;const n=2*t.length;if(n-e.length<0)return` style='text-align: ${s}; ${i}'`;let a="";switch(s){case"justify":a=this.#j("0",n);break;case"121":a=this.#j(`calc(${(n-e.length)/(2*e.length)}em)`,n);break;case"even":a=this.#j(`calc(${(n-e.length)/(e.length+1)}em)`,n);break;case"1ruby":a=this.#j("1em",n);break;default:a=`text-align: ${s};`}return` style='${a} ${i}'`};#P="";#B(t,e,s,i=""){if(!s)return` style='${i}'`;const n=2*t.length;if(n-e.length<0)return` style='text-align: ${s}; ${i}'`;let a="";switch(s){case"left":case"right":a="ruby-align: start;";break;case"center":a="ruby-align: center;";break;case"justify":a="ruby-align: space-between;";break;case"121":a="ruby-align: space-around;";break;case"even":const t=(n-e.length)/(e.length+1);a="ruby-align: space-between; "+(this.#d.tategaki?`padding-top: ${t}em; padding-bottom: ${t}em;`:`padding-left: ${t}em; padding-right: ${t}em;`);break;case"1ruby":a="ruby-align: space-between; "+(this.#d.tategaki?"padding-top: 1em; padding-bottom: 1em;":"padding-left: 1em; padding-right: 1em;");break;default:a=`text-align: ${s};`}return` style='${a} ${i}'`}tagCh(t){this.#p.putTxt(t)}#V=!1;#F=(t,e)=>{k.#e.oCfg.debug.putCh&&console.log(`🖊 文字表示 text:\`${t}\`(${t.charCodeAt(0).toString(16)}) ruby:\`${e}\` name:\`${this.name_}\``);const s=e.split("｜");let n="";const[a,...h]=s,r=h.join("｜");switch(s.length){case 1:if(this.#V=!0,"\n"===t){this.#M?(this.#M=!1,n="<ruby>&emsp;<rt>&emsp;</rt></ruby><br/>"):n="<br/>";break}this.#M&&(this.#M=!1,""===e&&(e="&emsp;")),n=this.#D(t,e,this.#P);break;default:switch(a){case"start":case"left":case"center":case"right":case"justify":case"121":case"even":case"1ruby":this.#M=!1,this.#V=!0,n=this.#D(t,r,a);break;case"gotxt":return this.#z(),void(this.#V?(this.isCur&&k.#n.recText(this.#H.join("").replace(/^<ruby>&emsp;<rt>&emsp;<\/rt><\/ruby>(<br\/>)+/,"").replaceAll(/style='(anim\S+ \S+?;\s*)+/g,"style='").replaceAll(/( style=''| data-(add|arg|cmd)='.+?'|\n+|\t+)/g,"").replaceAll(/class='sn_ch .+?'/g,"class='sn_ch'").replaceAll("display: none;","").replaceAll("class='offrec'","style='display: none;'")),this.#d.goTxt(this.#H,0===this.#W),this.#V=!1,this.#W=0):this.isCur&&this.#d.noticeCompTxt());case"add":{const t=JSON.parse(r),{style:e="",wait:s=null}=t,{cl:i,sty:n}=this.#J(!0,s);this.#H.push(`<span${i} style='${n} display: inline; ${e}'>`),delete t.style,this.#U(t)}return;case"add_close":return this.#H.push("</span>"),void this.#z();case"grp":this.#V=!0;{const t=JSON.parse(r);if(t.id??=this.#H.length,"break"===t.id)return void this.#d.dispBreak(t);this.#M=!1,t.delay=this.#W,t.r??="",t.style??="",t.r_style??="";const{cl:e,sty:s,lnk:i}=this.#J(!0,t.wait);n=`<span${e} style='${s} ${t.style}'><ruby><span data-cmd='grp' data-arg='${JSON.stringify(t)}'${i} style='${s} display: inline;'>&emsp;</span><rt${i}${this.#L("　",t.r,this.#P,this.#b.style.cssText+(this.#q.at(-1)?.o.r_style??"")+t.r_style)}>${t.r}</rt></ruby></span>`}break;case"tcy":this.#M=!1,this.#V=!0;{const{t:s,r:a="",wait:h=null,style:o="",r_style:c=""}=JSON.parse(r);k.#o.doRecLog()&&(this.#Q+=t+(e?`《${e}》`:""),this.#Y+=s);const l=i.C.isSafari?a.replaceAll(/[A-Za-z0-9]/g,(t=>String.fromCharCode(t.charCodeAt(0)+65248))):a,{cl:d,sty:p,lnk:f}=this.#J(!0,h);n=`<span${d} style='${p}${this.#O(s)} ${o}'><ruby><span${f} style='${p} display: inline; text-combine-upright: all;'>${s}</span><rt${f}${this.#L(s,l,this.#P,this.#b.style.cssText+(this.#q.at(-1)?.o.r_style??"")+c)}>${l}</rt></ruby></span>`}break;case"del":return void w.delBreak();case"span":return this.#V=!0,void this.#X(JSON.parse(r));case"link":this.#V=!0;{const t=JSON.parse(r);t[":link"]=" data-lnk='@'";const{cl:e,sty:s,curpos:i}=this.#J(!1,t.wait);this.#H.push(`<span${e} style='${s} display: inline; ${t.style??""}' ${i} data-arg='${r}'>`),delete t.style,this.#X(t)}return;case"endlink":return this.#V=!0,this.#H.push("</span>"),void this.#z();default:this.#V=!0,n=this.#D(t,e,this.#P)}}this.#H.push(k.#I(n))};#D(t,e,s){const i=" "===t?"&nbsp;":"　"===t?"&emsp;":t;k.#o.doRecLog()&&(this.#Q+=i+(e?`《${e}》`:"")," "!==t&&(this.#Y+=t));const{cl:n,sty:a,lnk:h}=this.#J(!0,null,t);return e?`<span${n} style='${a} ${this.#O(t)}'><ruby>${Array.from(t).map(((e,s)=>`<span${n}${h} style='${s>0?this.#J(!0,null,t).sty:a} display: inline;'>${" "===e?"&nbsp;":"　"===e?"&emsp;":e}</span>`)).join("")}<rt${h}${this.#L(t,e,s,this.#b.style.cssText+(this.#q.at(-1)?.o.r_style??""))}>${e}</rt></ruby></span>`:`<span${n} style='${a} ${this.#O(t)}'${h}>${i}</span>`}#J(t,e,s="\n"){const i=this.#S?e??this.#q.at(0)?.o.wait??(k.#r?k.#i[s.at(0)??""]??0:C.msecChWait):0;k.#g.isSkipping?this.#W=0:t&&this.#S&&(this.#W+=Number(i));const n=`data-add='{"ch_in_style":"${this.#E}", "ch_out_style":"${this.#N}"}'`;return{cl:` class='sn_ch sn_ch_in_${this.#E}'`,sty:`animation-delay: ${this.#W}ms;${this.#q.at(-1)?.o.style??""}`,lnk:(this.#q.at(0)?.o[":link"]??"")+" "+n,curpos:n}}#W=0;#M=!0;#H=[];#q=[];#U(t){this.#q.push({o:t,r_align:this.#P,ch_in_style:this.#E,ch_out_style:this.#N}),"r_align"in t&&(this.#P=t.r_align),this.#$(t),this.#w(t)}#z(){const t=this.#q.pop();t&&(this.#P=t.r_align,this.#$({in_style:t.ch_in_style}),this.#w({out_style:t.ch_out_style}))}#X(t){const e=this.#q.at(-1);e?(e.o={...e.o,...t},!t.style&&!t.r_style&&(e.o.style="",e.o.r_style=""),"r_align"in t&&(this.#P=t.r_align),this.#$(t),this.#w(t)):this.#U(t)}click=()=>!(!this.ctn.interactiveChildren||!this.ctn.visible)&&this.#d.skipChIn();clearText(){this.ctn.addChild(this.#d=this.#d.reNew()),this.#W=0,this.#M=!0,this.#H=[],this.#Q="",this.#Y="",k.#n.recPagebreak()}#Q="";#Y="";get pageText(){return this.#Q.replace("《&emsp;》","")}get pagePlainText(){return this.#Y}get enabled(){return this.ctn.interactiveChildren}set enabled(t){this.ctn.interactiveChildren=t}addButton=t=>new Promise((e=>{t.key=`btn=[${this.#s.children.length}] `+this.name_,t[":id_tag"]=t.key.slice(0,-7),(0,i.a)(t,"hint_tate",this.#d.tategaki);const s=new v(t,k.#g,(()=>e()),(()=>this.canFocus()));s.name=JSON.stringify(t).replaceAll('"',"'"),this.#s.addChild(s)}));canFocus(){return(this.ctn.interactiveChildren??!1)&&this.ctn.visible&&k.#a(this)}clearLay(t){super.clearLay(t),this.clearText();for(const t of this.#s.removeChildren())t.destroy()}record=()=>({...super.record(),enabled:this.enabled,r_cssText:this.#b.style.cssText,r_align:this.#P,b_do:void 0===this.#l?void 0:this.#l instanceof i.w?"Sprite":"Graphics",b_pic:this.#_,b_color:this.#m,b_alpha:this.#c,b_alpha_isfixed:this.#x,ffs:this.#T,txs:this.#d.record(),strNoFFS:this.#k,btns:this.#s.children.map((t=>t.name))});playback(t,e){super.playback(t,e),this.enabled=t.enabled,this.#b.style.cssText=t.r_cssText,this.#P=t.r_align,this.cvsResize(),this.#A(t),this.#d.playback(t.txs),this.#c=t.b_alpha,this.#x=t.b_alpha_isfixed,e=[e,new Promise((e=>{const s=t.b_do?"Sprite"===t.b_do?{b_pic:t.b_pic}:{b_color:t.b_color}:{b_pic:""};s.b_alpha=t.b_alpha,s.b_alpha_isfixed=t.b_alpha_isfixed,this.#C(s,(t=>{t&&e()}))||e()})),t.btns.map((t=>new Promise((e=>{this.addButton(JSON.parse(t.replaceAll("'",'"'))),e()}))))].flat()}get cssText(){return this.#d.cssText}set cssText(t){this.#d.cssText=t}snapshot(t,e){t.render(this.ctn,{clear:!1}),this.#d.snapshot(t,e)}snapshot_end(){this.#d.snapshot_end()}makeDesignCast(t){this.ctn.visible&&this.#d.makeDesignCast(t)}makeDesignCastChildren(t){if(this.ctn.visible)for(const e of this.#s.children)e.makeDesignCast(t)}showDesignCast(){this.#d.showDesignCast()}showDesignCastChildren(){for(const t of this.#s.children)t.showDesignCast()}dump(){return this.#F("","gotxt｜"),super.dump()+`, "enabled":"${this.enabled}", ${this.#d.dump()}, "b_pic":"${this.#_}", "b_color":"${this.#m}", "b_alpha":${this.#c}, "b_alpha_isfixed":"${this.#x}", "width":${this.#d.getWidth}, "height":${this.#d.getHeight}, "pixi_obj":[${this.ctn.children.map((t=>`{"class":"${t instanceof i.w?"Sprite":t instanceof i.z?"Graphics":t instanceof i.j?"Container":"?"}", "name":"${t.name}", "alpha":${t.alpha}, "x":${t.x}, "y":${t.y}, "visible":"${t.visible}"}`)).join(",")}], "button":[${this.#s.children.map((t=>t.children[0]?.name??"{}")).join(",")}]`}}class ${constructor(t,e,s){this.appPixi=e,this.val=s,t.add_frame=t=>this.#g(t),t.let_frame=t=>this.#c(t),t.set_frame=t=>this.#x(t),t.frame=t=>this.#_(t),t.tsy_frame=t=>this.#d(t)}static#e;static#o;static#a;static init(t,e,s){$.#e=t,$.#o=e,$.#a=s}#n;setEvtMng(t){this.#n=t}#t=Object.create(null);destroy(){for(const t of Object.values(this.#t))t.parentElement.removeChild(t);this.#t=Object.create(null)}hideAllFrame(){for(const[t,{style:e}]of Object.entries(this.#t))this.#f[t]="none"!==e.display,e.display="none"}#f=Object.create(null);restoreAllFrame(){for(const[t,e]of Object.entries(this.#f)){const s=this.#t[t];s&&(s.style.display=e?"inline":"none")}this.#f=Object.create(null)}#g(t){const{id:e,src:s,alpha:n=1,scale_x:h=1,scale_y:r=1,rotate:o=0}=t;if(!e)throw"idは必須です";if(!s)throw"srcは必須です";const c="const.sn.frm."+e;if(this.val.getVal(`tmp:${c}`))throw`frame【${e}】はすでにあります`;const l=(0,i.a)(t,"visible",!0),d=t.b_color?` background-color: ${t.b_color};`:"",p=this.#r(t);$.#a.cvs.insertAdjacentHTML("beforebegin",`<iframe id="${e}" style="opacity: ${n}; ${d} position: absolute; left:${$.#o.ofsLeft4elm+p.x*$.#o.cvsScale}px; top: ${$.#o.ofsTop4elm+p.y*$.#o.cvsScale}px; z-index: 1; border: 0px; overflow: hidden; display: ${l?"inline":"none"}; transform: scale(${h}, ${r}) rotate(${o}deg);" width="${p.width*$.#o.cvsScale}" height="${p.height*$.#o.cvsScale}"></iframe>`),(0,a.d)();const f=$.#e.searchPath(s,i.S.HTML),u=(new i.L).add({name:s,url:f,xhrType:i.c.XHR_RESPONSE_TYPE.TEXT});return $.#o.arg.crypto&&u.use((async(t,e)=>{try{t.data=await $.#o.dec(t.extension,t.data)}catch(e){$.#a.errScript(`[add_frame]Html ロード失敗です src:${t.name} ${e}`,!1)}e()})),u.load(((t,i)=>{const d=document.getElementById(e);this.#t[e]=d,this.#h[e]=!1;const u=f.lastIndexOf("/")+1,g=f.slice(0,u),y=g.slice(0,u);d.srcdoc=String(i[s]?.data).replace("sn_repRes();","").replaceAll(/\s(?:src|href)=(["'])(\S+?)\1/g,((t,e,s)=>s.startsWith("../")?t.replace("../",y):t.replace("./","").replace(e,e+g))),d.srcdoc.includes("true/*WEBP*/;")&&(d.srcdoc=d.srcdoc.replaceAll(/data-src="(.+?\.)(?:jpe?g|png)/g,((t,e)=>`data-src="${e}webp`))),d.onload=()=>{this.val.setVal_Nochk("tmp",c,!0),this.val.setVal_Nochk("tmp",c+".alpha",n),this.val.setVal_Nochk("tmp",c+".x",p.x),this.val.setVal_Nochk("tmp",c+".y",p.y),this.val.setVal_Nochk("tmp",c+".scale_x",h),this.val.setVal_Nochk("tmp",c+".scale_y",r),this.val.setVal_Nochk("tmp",c+".rotate",o),this.val.setVal_Nochk("tmp",c+".width",p.width),this.val.setVal_Nochk("tmp",c+".height",p.height),this.val.setVal_Nochk("tmp",c+".visible",l);const t=d.contentWindow;this.#n.resvFlameEvent(t),t.sn_repRes?.((t=>$.#i(t.dataset.src??"",t))),(0,a.e)()}})),!0}#h={};getFrmDisabled(t){return this.#h[t]}#r(t){const e={...t},s=$.#o.resolution;return new DOMRect((0,i.b)(e,"x",0)*s,(0,i.b)(e,"y",0)*s,(0,i.b)(e,"width",i.C.stageW)*s,(0,i.b)(e,"height",i.C.stageH)*s)}static#i(t,e,s){const n=this.#m[t];if(n)return e.src=n,void(s&&(e.onload=()=>s(e)));const a=this.#y[t];if(a)return void a.push(e);this.#y[t]=[e];const[h="",r=""]=t.split("?"),o=$.#e.searchPath(h,i.S.SP_GSM),c=(new i.L).add({name:t,url:o,xhrType:i.c.XHR_RESPONSE_TYPE.BUFFER});$.#o.arg.crypto&&"bin"===(0,i.K)(o)&&c.use((async(t,e)=>{try{const s=await $.#o.decAB(t.data);if("bin"!==t.extension)return void e();t.data=s,s instanceof HTMLImageElement&&(t.type=i.c.TYPE.IMAGE)}catch(e){$.#a.errScript(`GrpLayer loadPic ロード失敗です fn:${t.name} ${e}`,!1)}e()})),c.load(((t,e)=>{for(const[t,{data:{src:i}}]of Object.entries(e)){const e=this.#m[t]=i+(i.startsWith("blob:")?"":(r?"?":"")+r),n=this.#y[t];if(n)for(const t of n)t.src=e,s&&(t.onload=()=>s(t));delete this.#y[t]}}))}static#y={};static#m={};cvsResize(){for(const[t,e]of Object.entries(this.#t)){const s="const.sn.frm."+t,i=Number(this.val.getVal(s+".x")),n=Number(this.val.getVal(s+".y")),a=Number(this.val.getVal(s+".width")),h=Number(this.val.getVal(s+".height"));e.style.left=`${$.#o.ofsLeft4elm+i*$.#o.cvsScale}px`,e.style.top=`${$.#o.ofsTop4elm+n*$.#o.cvsScale}px`,e.width=String(a*$.#o.cvsScale),e.height=String(h*$.#o.cvsScale)}}#c(t){const{id:e,var_name:s}=t;if(!e)throw"idは必須です";const n=document.getElementById(e);if(!n)throw`id【${e}】はフレームではありません`;const a="const.sn.frm."+e;if(!this.val.getVal(`tmp:${a}`))throw`frame【${e}】が読み込まれていません`;if(!s)throw"var_nameは必須です";const h=n.contentWindow;if(!h.hasOwnProperty(s))throw`frame【${e}】に変数/関数【${s}】がありません。変数は var付きにして下さい`;const r=h[s];return this.val.setVal_Nochk("tmp",a+"."+s,(0,i.a)(t,"function",!1)?r():r),!1}#x(t){const{id:e,var_name:s,text:i}=t;if(!e)throw"idは必須です";const n=document.getElementById(e);if(!n)throw`id【${e}】はフレームではありません`;const a="const.sn.frm."+e;if(!this.val.getVal(`tmp:${a}`))throw`frame【${e}】が読み込まれていません`;if(!s)throw"var_nameは必須です";if(!i)throw"textは必須です";return this.val.setVal_Nochk("tmp",a+"."+s,i),n.contentWindow[s]=i,!1}#l=1;#_(t){const{id:e}=t;if(!e)throw"idは必須です";const s=document.getElementById(e);if(!s)throw`id【${e}】はフレームではありません`;const n="const.sn.frm."+e;if(!this.val.getVal("tmp:"+n))throw`frame【${e}】が読み込まれていません`;const a=s.style;if((0,i.a)(t,"float",!1)?a.zIndex=""+ ++this.#l:"index"in t?a.zIndex=`${(0,i.b)(t,"index",0)}`:t.dive&&(a.zIndex="-"+ ++this.#l),"alpha"in t){const e=a.opacity=String(t.alpha);this.val.setVal_Nochk("tmp",n+".alpha",e)}const h=this.#r(t);if(("x"in t||"y"in t)&&(a.left=`${$.#o.ofsLeft4elm+h.x*$.#o.cvsScale}px`,a.top=`${$.#o.ofsTop4elm+h.y*$.#o.cvsScale}px`,this.val.setVal_Nochk("tmp",n+".x",h.x),this.val.setVal_Nochk("tmp",n+".y",h.y)),"scale_x"in t||"scale_y"in t||"rotate"in t){const e=(0,i.b)(t,"scale_x",1),s=(0,i.b)(t,"scale_y",1),h=(0,i.b)(t,"rotate",0);a.transform=`scale(${e}, ${s}) rotate(${h}deg)`,this.val.setVal_Nochk("tmp",n+".scale_x",e),this.val.setVal_Nochk("tmp",n+".scale_y",s),this.val.setVal_Nochk("tmp",n+".rotate",h)}if("width"in t&&(s.width=String(h.width*$.#o.cvsScale),this.val.setVal_Nochk("tmp",n+".width",h.width)),"height"in t&&(s.height=String(h.height*$.#o.cvsScale),this.val.setVal_Nochk("tmp",n+".height",h.height)),"visible"in t){const e=(0,i.a)(t,"visible",!0);a.display=e?"inline":"none",this.val.setVal_Nochk("tmp",n+".visible",e)}if("b_color"in t&&(a.backgroundColor=t.b_color),"disabled"in t){const n=this.#h[e]=(0,i.a)(t,"disabled",!0),a=s.contentDocument.body;for(const t of[...Array.from(a.getElementsByTagName("input")),...Array.from(a.getElementsByTagName("select"))])t.disabled=n}return!1}#d(t){const{id:e,alpha:s,x:a,y:h,scale_x:r,scale_y:o,rotate:c,width:l,height:d}=t;if(!e)throw"idは必須です";const p=document.getElementById(e);if(!p)throw`id【${e}】はフレームではありません`;const f="const.sn.frm."+e;if(!this.val.getVal(`tmp:${f}`,0))throw`frame【${e}】が読み込まれていません`;const u={};s&&(u.a=p.style.opacity),(a||h||r||o||c)&&(u.x=Number(this.val.getVal(`tmp:${f}.x`)),u.y=Number(this.val.getVal(`tmp:${f}.y`)),u.sx=Number(this.val.getVal(`tmp:${f}.scale_x`)),u.sy=Number(this.val.getVal(`tmp:${f}.scale_y`)),u.r=Number(this.val.getVal(`tmp:${f}.rotate`))),l&&(u.w=this.val.getVal(`tmp:${f}.width`)),d&&(u.h=this.val.getVal(`tmp:${f}.height`));const g=n.C.cnvTweenArg(t,u);let y=()=>{};s&&((0,i.b)(g,"alpha",0),y=()=>{p.style.opacity=u.a,this.val.setVal_Nochk("tmp","alpha",u.a)});let m=()=>{};const b=this.#r(g);(a||h||r||o||c)&&(b.x,b.y,(0,i.b)(g,"scale_x",1),(0,i.b)(g,"scale_y",1),(0,i.b)(g,"rotate",0),m=()=>{p.style.left=$.#o.ofsLeft4elm+u.x*$.#o.cvsScale+"px",p.style.top=$.#o.ofsTop4elm+u.y*$.#o.cvsScale+"px",p.style.transform=`scale(${u.sx}, ${u.sy}) rotate(${u.r}deg)`,this.val.setVal_Nochk("tmp",f+".x",u.x),this.val.setVal_Nochk("tmp",f+".y",u.y),this.val.setVal_Nochk("tmp",f+".scale_x",u.sx),this.val.setVal_Nochk("tmp",f+".scale_y",u.sy),this.val.setVal_Nochk("tmp",f+".rotate",u.r)});let _=()=>{};l&&(b.width,_=()=>{p.width=u.w*$.#o.cvsScale+"px",this.val.setVal_Nochk("tmp",f+".width",u.w)});let x=()=>{};return d&&(b.height,x=()=>{p.height=u.h*$.#o.cvsScale+"px",this.val.setVal_Nochk("tmp",f+".height",u.h)}),this.appPixi.stage.interactive=!1,n.C.tween(`frm\n${e}`,t,u,n.C.cnvTweenArg(t,u),(()=>{y(),m(),_(),x()}),(()=>this.appPixi.stage.interactive=!0),(()=>{})),!1}}class C{constructor(t,e,s,a,h,r,c,p,f){this.cfg=t,this.hTag=e,this.appPixi=s,this.val=a,this.main=h,this.scrItr=r,this.sys=c,this.sndMng=p,this.prpPrs=f;const u=()=>{if(c.cvsResize(),this.cvsResizeDesign(),this.#r)for(const t of this.#$)this.#s[t].fore.cvsResizeChildren();else for(const t of this.#$)this.#s[t].fore.cvsResize();this.#n.cvsResize(),this.#m.cvsResize()};if(i.C.isMobile)this.#f.add(globalThis,"orientationchange",u,{passive:!0});else{let t;this.#f.add(globalThis,"resize",(()=>{t||(t=setTimeout((()=>{t=void 0,u()}),1e3/60*10))}),{passive:!0})}c.cvsResize(),k.init(t,e,a,this,(t=>this.#s[t.layname].fore===t),s),d.init(h,t,s,c,p,a),$.init(t,c,h),v.init(t),this.#n=new $(e,s,a),c.hFactoryCls.grp=()=>new d,c.hFactoryCls.txt=()=>new k,e.loadplugin=t=>this.#b(t),e.snapshot=t=>this.#l(t),this.#_=this.sys.isApp?this.#d:this.#p,e.add_lay=t=>this.#u(t),e.clear_lay=t=>this.#v(t),e.finish_trans=()=>n.C.finish_trans(),e.lay=t=>this.#w(t),e.trans=t=>this.#R(t),e.wt=t=>n.C.wt(t),e.quake=t=>this.#P(t),e.stop_quake=e.finish_trans,e.wq=t=>e.wt(t),e.pause_tsy=t=>n.C.pause_tsy(t),e.resume_tsy=t=>n.C.resume_tsy(t),e.stop_tsy=t=>n.C.stop_tsy(t),e.tsy=t=>this.#B(t),e.wait_tsy=t=>n.C.wait_tsy(t),e.add_filter=t=>this.#V(t),e.clear_filter=t=>this.#D(t),e.enable_filter=t=>this.#J(t),e.ch=t=>this.#H(t),e.clear_text=t=>this.#G(t),e.current=t=>this.#z(t),e.endlink=t=>this.#K(t),e.er=t=>this.#Z(t),e.graph=t=>this.#tt(t),e.link=t=>this.#et(t),e.r=t=>this.#st(t),e.rec_ch=t=>this.#it(t),e.rec_r=t=>this.#nt(t),e.reset_rec=t=>this.#at(t),e.ruby2=t=>this.#ht(t),e.span=t=>this.#rt(t),e.tcy=t=>this.#ot(t),e.add_face=t=>l.add_face(t),e.wv=t=>l.wv(t),e.dump_lay=t=>this.#ct(t),e.enable_event=t=>this.#lt(t),e.button=t=>this.#dt(t),t.existsBreakline&&(this.breakLine=t=>{delete t.visible,t.id="break",t.pic="breakline";const e=encodeURIComponent(JSON.stringify(t));this.#x("grp｜"+e)}),t.existsBreakpage&&(this.breakPage=t=>{delete t.visible,t.id="break",t.pic="breakpage";const e=encodeURIComponent(JSON.stringify(t));this.#x("grp｜"+e)}),this.#t=(0,i.M)(String(t.oCfg.init.bg_color));const g=new i.z;g.beginFill(this.#t,1).lineStyle(0,this.#t).drawRect(0,0,i.C.stageW,i.C.stageH).endFill(),this.#o.addChild(g.clone()),this.#a.addChild(g),this.#a.visible=!1,this.#o.name="page:A",this.#a.name="page:B",this.#e=s.stage,this.#e.addChild(this.#a),this.#e.addChild(this.#o),this.#e.addChild(this.#T),this.#e.addChild(this.#k),this.#e.name="stage";const y=(t,e)=>{this.#c(Number(e))};y(0,a.getVal("sys:TextLayer.Back.Alpha",1)),a.defValTrg("sys:TextLayer.Back.Alpha",y);const m=(t,e)=>v.fontFamily=e;m(0,a.getVal("tmp:sn.button.fontFamily",v.fontFamily)),a.defValTrg("tmp:sn.button.fontFamily",m),a.defTmp("const.sn.log.json",(()=>JSON.stringify((this.#pt.text=this.#pt.text?.replaceAll("</span><span class='sn_ch'>","")??"")?[...this.#ft,this.#pt]:this.#ft))),a.defTmp("const.sn.last_page_text",(()=>this.currentTxtlayFore?.pageText??"")),a.defTmp("const.sn.last_page_plain_text",(()=>this.currentTxtlayFore?.pagePlainText??"")),i.C.isDbg&&(o.init(s,c,r,f,t,this.#s),this.cvsResizeDesign=()=>o.cvsResizeDesign(),c.addHook(((t,e)=>{this.#g[t]?.(t,e)&&delete this.#g[t]})))}#e;#o=new i.j;#a=new i.j;#n;#t;#f=new i.E;cvsResizeDesign(){}#g={attach:t=>!1,continue:t=>!1,disconnect:t=>!1,_enterDesign:t=>{for(const t of this.#$){const e=this.#s[t].fore;e.makeDesignCastChildren((t=>t.make())),e.makeDesignCast((t=>t.make()))}return this.#i(this.#E),!1},_replaceToken:(t,e)=>!1,_selectNode:(t,e)=>(this.#i(e.node),!1)};#h="";#r="";#i(t){[this.#h="",this.#r=""]=t.split("/");const e=this.#s[this.#h];e&&(this.#r?e.fore.showDesignCastChildren():e.fore.showDesignCast())}getFrmDisabled=t=>this.#n.getFrmDisabled(t);#y=void 0;cover(t,e=0){this.#y&&(this.#e.removeChild(this.#y),this.#y.destroy(),this.#y=void 0),t&&this.#e.addChild((this.#y=new i.z).beginFill(e).lineStyle(0,e).drawRect(0,0,i.C.stageW,i.C.stageH).endFill())}#m;setEvtMng(t){this.#m=t,this.#n.setEvtMng(t),l.setEvtMng(t),n.C.init(t,this.appPixi)}destroy(){for(const t of Object.values(this.#s))t.destroy();this.#f.clear(),d.destroy(),h.R.destroy(),w.destroy(),k.destroy(),this.#n.destroy(),n.C.destroy(),C.#M=10}#c(t){for(const e of this.#I()){const s=this.#s[e];s.fore instanceof k&&(s.fore.chgBackAlpha(t),s.back.chgBackAlpha(t))}}#x=(t,e=this.currentTxtlayForeNeedErr,s=!0)=>e.tagCh("｜&emsp;《"+t+"》");goTxt=()=>{};breakLine=t=>{};breakPage=t=>{};clearBreak(){this.currentTxtlayFore&&(this.clearBreak=()=>this.#x("del｜break"),this.clearBreak())}clickTxtLay(){return!!this.currentTxtlayFore&&this.#I().some((t=>{const e=this.#s[t].fore;return e instanceof k&&e.click()}))}#l(t){const e=t.fn?t.fn.startsWith("userdata:/")?t.fn:`downloads:/${t.fn+(0,i.g)("-","_","","_")}.png`:`downloads:/snapshot${(0,i.g)("-","_","","_")}.png`,s=this.cfg.searchPath(e),n=(0,i.b)(t,"width",i.C.stageW),a=(0,i.b)(t,"height",i.C.stageH);return this.#_(t,s,n,a)}#_=()=>!1;#d(t,e,s,i){if(this.#n.hideAllFrame(),(0,a.d)(),!("layer"in t))return this.sys.capturePage(e,s,i,(()=>{this.#n.restoreAllFrame(),(0,a.e)()})),!0;const n={};for(const t of this.#I()){const e=this.#s[t].fore.ctn;n[t]=e.visible,e.visible=!1}for(const e of this.#I(t.layer))this.#s[e].fore.ctn.visible=!0;return this.sys.capturePage(e,s,i,(()=>{for(const[t,e]of Object.entries(n))this.#s[t].fore.ctn.visible=e;this.#n.restoreAllFrame(),(0,a.e)()})),!0}#p(t,e,s,n){(0,a.d)();const h=(0,i.J)(t,"b_color",this.#t),r=(0,i.N)({width:s,height:n,backgroundAlpha:h>16777216&&e.endsWith(".png")?0:1,antialias:(0,i.a)(t,"smoothing",!1),preserveDrawingBuffer:!0,backgroundColor:16777215&h,autoDensity:!0}),o="back"!==t.page?"fore":"back";return Promise.allSettled(this.#I(t.layer).map((t=>new Promise((e=>this.#s[t][o].snapshot(r,e)))))).then((async()=>{const s=i.y.create({width:r.width,height:r.height});r.render(this.#e,{renderTexture:s}),await this.sys.savePic(e,r.plugins.extract.base64(s)),s.destroy();for(const e of this.#I(t.layer))this.#s[e][o].snapshot_end();r.destroy(!0),(0,a.e)()})),!0}#b(t){const{fn:e}=t;if(!e)throw"fnは必須です";const s=(0,i.a)(t,"join",!0);if(s&&(0,a.d)(),!e.endsWith(".css"))throw"サポートされない拡張子です";return(async()=>{const t=await fetch(e);if(!t.ok)throw new Error("Network response was not ok.");(0,i.k)(await t.text()),s&&(0,a.e)()})(),s}#u(t){const{layer:e,class:s}=t;if(!e)throw"layerは必須です";if(e.includes(","))throw"layer名に「,」は使えません";if(e in this.#s)throw`layer【${e}】はすでにあります`;if(!s)throw"clsは必須です";const i={isWait:!1};switch(this.#s[e]=new r(e,s,this.#o,this.#a,t,this.sys,this.val,i),this.#$.push(e),s){case"txt":this.#E||(this.#Y=()=>{},this.#q=this.#U,this.#z=this.#X,this.hTag.current({layer:e}),this.goTxt=()=>{this.#m.isSkipping?C.#M=0:this.setNormalChWait();for(const t of this.#I()){const e=this.#s[t].fore;e instanceof k&&this.#x("gotxt｜",e,!1)}}),this.val.setVal_Nochk("save","const.sn.layer."+(e??this.#E)+".enabled",!0);break;case"grp":if(this.#S)break;this.#S=e}return this.scrItr.recodeDesign(t),i.isWait}#s={};#$=[];#E="";#S="";#w(t){const e=this.#ut(t),s=this.#s[e],n=s.back.ctn,a=s.fore.ctn;if((0,i.a)(t,"float",!1))this.#a.setChildIndex(n,this.#a.children.length-1),this.#o.setChildIndex(a,this.#o.children.length-1),this.#N();else if(t.index)(0,i.b)(t,"index",0)&&(this.#a.setChildIndex(n,t.index),this.#o.setChildIndex(a,t.index),this.#N());else if(t.dive){const{dive:s}=t;let i=0;if(e===s)throw"[lay] 属性 layerとdiveが同じ【"+s+"】です";const h=this.#s[s];if(!h)throw"[lay] 属性 dive【"+s+"】が不正です。レイヤーがありません";const r=h.back,o=h.fore,c=this.#a.getChildIndex(r.ctn),l=this.#o.getChildIndex(o.ctn);i=c<l?c:l,i>this.#a.getChildIndex(n)&&--i,this.#o.setChildIndex(a,i),this.#a.setChildIndex(n,i),this.#N()}return t[":id_tag"]=s.fore.name.slice(0,-7),this.scrItr.recodeDesign(t),s.lay(t)}#N(){this.#$=this.#L()}#v(t){return this.#j(t,(e=>{const s=this.#s[this.#ut({layer:e})];if("both"===t.page)return s.fore.clearLay(t),void s.back.clearLay(t);s.getPage(t).clearLay(t)})),!1}static#C="\nprecision mediump float;\n\nvarying vec2 vTextureCoord;\nuniform sampler2D uSampler;\n\nuniform sampler2D rule;\nuniform float vague;\nuniform float tick;\n\nuniform vec4 inputPixel;\nuniform highp vec4 outputFrame;\nvec2 getUV(vec2 coord) {\n\treturn coord * inputPixel.xy / outputFrame.zw;\n}\n\nvoid main() {\n\tvec4 fg = texture2D(uSampler, vTextureCoord);\n\tvec4 ru = texture2D(rule, getUV(vTextureCoord));\n\n\tfloat v = ru.r - tick;\n\tgl_FragColor = abs(v) < vague\n\t\t? vec4(fg.rgb, 1) *fg.a *(0.5 +v /vague *0.5)\n\t\t: 0.0 <= v ? fg : vec4(0);\n}";#A=i.y.create({width:i.C.stageW,height:i.C.stageH});#T=new i.w(this.#A);#O=i.y.create({width:i.C.stageW,height:i.C.stageH});#k=new i.w(this.#O);#R(t){n.C.finish_trans(),this.#m.hideHint();const{layer:e}=t,s=new Set,a=[];for(const t of this.#I(e))s.add(t),a.push(this.#s[t].fore);const h=async()=>{[this.#o,this.#a]=[this.#a,this.#o];const t=[];for(const[e,i]of Object.entries(this.#s)){if(s.has(e)){i.transPage(t);continue}const{fore:{ctn:n},back:{ctn:a}}=i,h=this.#o.getChildIndex(a);this.#o.removeChild(a),this.#a.removeChild(n),this.#o.addChildAt(n,h),this.#a.addChildAt(a,h)}await Promise.allSettled(t),this.#o.visible=!0,this.#a.visible=!1,this.#T.visible=!1,this.#k.visible=!1};if(this.#k.filters=[],this.#k.alpha=1,0===(0,i.b)(t,"time",0)||this.#m.isSkipping)return h(),!1;let r=[];const o=[];for(const t of this.#I()){const e=this.#s[t][s.has(t)?"back":"fore"];e.ctn.visible&&r.push(e.ctn),o.push(e)}const{ticker:c,renderer:d}=this.appPixi;d.render(this.#a,{renderTexture:this.#A});let p=()=>{for(const t of r)d.render(t,{renderTexture:this.#A,clear:!1})};if(!o.some((t=>t.containMovement))){const t=p;p=()=>{p=()=>{},t()}}const f=()=>d.render(this.#o,{renderTexture:this.#O});f();let u=()=>{this.#o.visible=!0,f(),this.#o.visible=!1};if(!a.some((t=>t.containMovement))){const t=u;u=()=>{u=()=>{},t()}}const g=()=>{p(),this.#T.visible=!0,u(),this.#k.visible=!0},{glsl:y,rule:m}=t,b=()=>{c.remove(g),h()};if(!y&&!m)return n.C.tween(n.C.TW_INT_TRANS,t,this.#k,{alpha:0},(()=>{}),b,(()=>{})),c.add(g),!1;const _={rule:i.s.EMPTY,vague:(0,i.b)(t,"vague",.04),tick:0};this.#k.filters=[new i.O(void 0,y??C.#C,_)];const x=n.C.tween(n.C.TW_INT_TRANS,t,_,{tick:1},(()=>{}),b,(()=>{}),!m);if(!m)return c.add(g),!1;const w=new l(m,void 0,(t=>{_.rule=t.texture,t.destroy(),w.destroy(),x.start(),c.add(g)}));return!1}#I(t=""){return t?t.split(","):this.#$}#j(t,e){const s=this.#I(t.layer);for(const t of s){const s=this.#s[t];if(!s)throw"存在しないlayer【"+t+"】です";e(t,s)}return s}#L(t=""){return this.#I(t).sort(((t,e)=>{const s=this.#o.getChildIndex(this.#s[t].fore.ctn),i=this.#o.getChildIndex(this.#s[e].fore.ctn);return s<i?-1:s>i?1:0}))}setAllStyle2TxtLay(t){const e=this.#I();for(const s of e){const e=this.#s[s].fore;e instanceof k&&e.lay({style:t})}}#P(t){if(n.C.finish_trans(),0===(0,i.b)(t,"time",NaN)||this.#m.isSkipping)return!1;const{layer:e}=t,s=[];for(const t of this.#I(e))s.push(this.#s[t].fore.ctn);this.#O.resize(i.C.stageW,i.C.stageH);const a=()=>{this.#o.visible=!0;const{renderer:t}=this.appPixi;for(const e of s)t.render(e,{renderTexture:this.#O,clear:!1});this.#o.visible=!1};this.#k.visible=!0,this.#k.alpha=1;const h=(0,i.u)((0,i.b)(t,"hmax",10)),r=(0,i.u)((0,i.b)(t,"vmax",10)),o=0===h?()=>{}:()=>this.#k.x=Math.round(Math.random()*h*2)-h,c=0===r?()=>{}:()=>this.#k.y=Math.round(Math.random()*r*2)-r;return this.#k.filters=[],n.C.tween(n.C.TW_INT_TRANS,t,this.#k,{x:0,y:0},(()=>{o(),c()}),(()=>{this.appPixi.ticker.remove(a),this.#o.visible=!0,this.#k.visible=!1,this.#k.x=0,this.#k.y=0}),(()=>{})),this.appPixi.ticker.add(a),!1}#B(t){const{layer:e,render:s,name:a}=t;if(!e)throw"layerは必須です";const h=this.#s[this.#ut(t)],r=h.fore;let o=()=>{};s&&!this.#m.isSkipping&&(r.renderStart(),o=()=>r.renderEnd());const c=n.C.cnvTweenArg(t,r),l=(0,i.a)(t,"arrive",!1),d=(0,i.a)(t,"backlay",!1),p=h.back.ctn;return n.C.tween(a??e,t,r,n.C.cnvTweenArg(t,r),(()=>{}),o,(()=>{if(l&&Object.assign(r,c),d)for(const t of Object.keys(n.C.hMemberCnt))p[t]=r[t]})),"filter"in t&&(r.ctn.filters=[i.x.bldFilters(t)],r.aFltHArg=[t]),!1}#V(t){return n.C.finish_trans(),this.#j(t,(e=>{const s=this.#s[this.#ut({layer:e})];if("both"===t.page)return this.#F(s.fore,t),void this.#F(s.back,t);const i=s.getPage(t);this.#F(i,t)})),!1}#F(t,e){const s=t.ctn;s.filters??=[],s.filters=[...s.filters,i.x.bldFilters(e)],t.aFltHArg.push(e)}#D(t){return this.#j(t,(e=>{const s=this.#s[this.#ut({layer:e})];if("both"===t.page){const t=s.fore,e=s.back;return t.ctn.filters=null,e.ctn.filters=null,t.aFltHArg=[],void(e.aFltHArg=[])}const i=s.getPage(t);i.ctn.filters=null,i.aFltHArg=[]})),!1}#J(t){return this.#j(t,(e=>{const s=this.#s[this.#ut({layer:e})];if("both"===t.page)return this.#W(s.fore,t),void this.#W(s.back,t);const i=s.getPage(t);this.#W(i,t)})),!1}#W(t,e){const s=t.ctn;if(!s.filters)throw"フィルターがありません";const n=(0,i.u)((0,i.b)(e,"index",0)),a=s.filters.length;if(a<=n)throw`フィルターの個数（${a}）を越えています`;t.aFltHArg[n].enabled=s.filters[n].enabled=(0,i.a)(e,"enabled",!0)}static#M=10;static get msecChWait(){return C.#M}#H(t){const{text:e}=t;if(!e)throw"textは必須です";const s=this.#q(t);delete t.text,this.setNormalChWait(),this.#m.isSkipping?t.wait=0:"wait"in t&&(0,i.b)(t,"wait",NaN);const n=encodeURIComponent(JSON.stringify(t));this.#x("add｜"+n,s);const a=(0,i.a)(t,"record",!0),h=this.val.doRecLog();return a||this.val.setVal_Nochk("save","sn.doRecLog",a),s.tagCh(e.replaceAll("[r]","\n")),this.val.setVal_Nochk("save","sn.doRecLog",h),this.#x("add_close｜",s),!1}#q=t=>{throw this.#Y(),0};#U(t){const e=this.#ut(t,this.#E),s=this.#s[e].getPage(t);if(!(s instanceof k))throw e+"はTxtLayerではありません";return s}setNormalChWait(){C.#M=this.scrItr.normalWait}#z=t=>{throw this.#Y(),0};#X(t){const{layer:e}=t;if(!e)throw"[current] layerは必須です";const s=this.#s[e];if(!(s&&s.getPage(t)instanceof k))throw`${e}はTxtLayerではありません`;this.#Q=s,this.recPagebreak(),this.#E=e,this.val.setVal_Nochk("save","const.sn.mesLayer",e);for(const t of this.#I()){const s=this.#s[t];s.fore instanceof k&&(s.fore.isCur=s.back.isCur=t===e)}return!1}get currentTxtlayForeNeedErr(){return this.#Y(),this.currentTxtlayFore}get currentTxtlayFore(){return this.#Q?this.#Q.fore:null}#Q;#Y=()=>{throw"文字レイヤーがありません。文字表示や操作する前に、[add_lay layer=（レイヤ名） class=txt]で文字レイヤを追加して下さい"};#ut(t,e=""){const s=t.layer??e;if(s.includes(","))throw"layer名に「,」は使えません";if(!(s in this.#s))throw"属性 layer【"+s+"】が不正です。レイヤーがありません";return t.layer=s}#pt={text:""};#ft=[];recText(t){this.#pt={text:t},this.val.setVal_Nochk("save","const.sn.sLog",String(this.val.getVal("const.sn.log.json")))}recPagebreak(){this.#pt.text&&(this.#pt.text=this.#pt.text.replaceAll("</span><span class='sn_ch'>",""),this.#ft.push(this.#pt)>this.cfg.oCfg.log.max_len&&(this.#ft=this.#ft.slice(-this.cfg.oCfg.log.max_len)),this.#pt={text:""})}#G(t){const e=this.#q(t);return t.layer===this.#E&&"fore"===t.page&&this.recPagebreak(),e.clearText(),!1}#K(t){return this.#x("endlink｜",this.#q(t)),!1}#Z(t){return(0,i.a)(t,"rec_page_break",!0)&&this.recPagebreak(),this.#Q&&(this.#Q.fore.clearLay(t),this.#Q.back.clearLay(t)),!1}#tt(t){if(!t.pic)throw"[graph] picは必須です";const e=encodeURIComponent(JSON.stringify(t));return this.#x("grp｜"+e,this.#q(t)),!1}#et(t){if(!t.fn&&!t.label&&!t.url)throw"fn,label,url いずれかは必須です";t.fn??=this.scrItr.scriptFn,t.style??="background-color: rgba(255,0,0,0.5);",t.style_hover??="background-color: rgba(255,0,0,0.9);",t.style_clicked??=t.style;const e=encodeURIComponent(JSON.stringify(t));return this.#x("link｜"+e,this.#q(t)),!1}#st(t){return t.text="\n",this.#H(t)}#nt(t){return this.#it({...t,text:"[r]"})}#it(t){return this.#pt={...t,text:this.#pt.text},!!t.text&&(t.record=!0,t.style??="",t.style+="display: none;",t.wait=0,this.#H(t))}#at(t){return this.#ft=[],this.#pt={text:t.text??""},this.val.setVal_Nochk("save","const.sn.sLog",t.text?`[{text:"${t.text}"}]`:"[]"),!1}#ht(t){const{t:e,r:s}=t;if(!e)throw"[ruby2] tは必須です";if(!s)throw"[ruby2] rは必須です";return t.text="｜"+encodeURIComponent(e)+"《"+encodeURIComponent(s)+"》",delete t.t,delete t.r,this.#H(t)}#rt(t){const e=encodeURIComponent(JSON.stringify(t));return this.#x("span｜"+e,this.#q(t)),!1}#ot(t){if(!t.t)throw"[tcy] tは必須です";const e=encodeURIComponent(JSON.stringify(t));return this.#x("tcy｜"+e,this.#q(t)),!1}#ct(t){console.group("🥟 [dump_lay]");for(const e of this.#I(t.layer)){const t=this.#s[e];try{console.info(`%c${t.fore.name.slice(0,-7)} %o`,`color:#${i.C.isDarkMode?"49F":"05A"};`,JSON.parse(`{"back":{${t.back.dump()}}, "fore":{${t.fore.dump()}}}`))}catch(e){console.error("dump_lay err:%o",e),console.error(`   back:${t.back.dump()}`),console.error(`   fore:${t.fore.dump()}`)}}return console.groupEnd(),!1}#lt(t){const e=this.#ut(t,this.#E),s=(0,i.a)(t,"enabled",!0);return this.#q(t).enabled=s,this.val.setVal_Nochk("save","const.sn.layer."+e+".enabled",s),!1}#dt(t){return r.argChk_page(t,"back"),t.fn??=this.scrItr.scriptFn,this.#q(t).addButton(t),this.scrItr.recodeDesign(t),!1}record(){const t={};for(const e of this.#$){const s=this.#s[e];t[e]={cls:s.cls,fore:s.fore.record(),back:s.back.record()}}return t}playback(t){this.#ft=JSON.parse(String(this.val.getVal("save:const.sn.sLog"))),this.#pt={text:""};const e=[],s=[];for(const[i,{fore:n,fore:{idx:a},back:h,cls:o}]of Object.entries(t)){s.push({ln:i,idx:a});const t=this.#s[i]??=new r(i,o,this.#o,this.#a,{},this.sys,this.val,{isWait:!1});t.fore.playback(n,e),t.back.playback(h,e)}const i=this.#o.children.length;return e.push(new Promise((t=>{for(const{ln:t,idx:e}of s.sort((({idx:t},{idx:e})=>t===e?0:t<e?-1:1))){const{fore:s,back:n}=this.#s[t];if(!s)continue;const a=i>e?e:i-1;this.#o.setChildIndex(s.ctn,a),this.#a.setChildIndex(n.ctn,a)}t()}))),e}}const T=Object.freeze(Object.defineProperty({__proto__:null,LayerMng:C},Symbol.toStringTag,{value:"Module"}))},7659:(t,e,s)=>{s.d(e,{R:()=>i});class i{static#i="ヽ";static setting(t){t.sesame&&(i.#i=t.sesame)}static getSesame(){return i.#i}static destroy(){i.#i="ヽ"}#t=()=>{};init(t){this.#t=t}static#a;static setEscape(t){i.#a=new RegExp((t?`(?<ce>\\${t}\\S)|`:"")+"｜(?<str>[^《\\n]+)《(?<ruby>[^》\\n]+)》|(?:(?<kan>[⺀-⿟々〇〻㐀-鿿豈-﫿]+[ぁ-ヿ]*|[^　｜《》\\n])《(?<kan_ruby>[^》\\n]+)》)|(?<txt>[\ud800-\udbff][\udc00-\udfff]|[^｜《》]+?|.)","gs")}putTxt(t){for(const{groups:e}of t.matchAll(i.#a)){const{ruby:t,kan_ruby:s,kan:i="",ce:n,txt:a="",str:h=""}=e;if(t)this.putTxtRb(decodeURIComponent(h),t);else if(s)this.putTxtRb(i,s);else if(n)this.#t(n.slice(1),"");else for(const t of Array.from(a))this.#t(t,"")}}putTxtRb(t,e){if(/^\w+｜{"/.test(e))return void this.#t(t,e);const s=Array.from(t),n=s.length;if(/^\*.?$/.test(e)){const t="center｜"+("*"===e?i.#i:e.charAt(1));for(let e=0;e<n;++e)this.#t(s[e],t);return}if(1===n||!e.includes(" "))return void this.#t(t,decodeURIComponent(e));const a=e.split(" "),h=a.length,r=h>n?h:n;for(let t=0;t<r;++t)this.#t(t<n?s[t]:"",t<h?decodeURIComponent(a[t]):"")}}}}]);