"use strict";(self.webpackChunkgallery=self.webpackChunkgallery||[]).push([[35],{7859:(t,s,i)=>{i.d(s,{C:()=>h});var n=i(4449),e=i(3653);class h{static#t={};static#s;static#i;static init(t,s){h.#t={},h.#s=t,h.#i=s,h.#i.ticker.add(h.#n)}static#n=()=>(0,e.u)();static destroy(){h.stopAllTw(),h.#i.ticker.remove(h.#n)}static setTwProp(t,s){const i=(0,n.b)(s,"repeat",1);return t.delay((0,n.b)(s,"delay",0)).easing(h.ease(s.ease)).repeat(i>0?i-1:1/0).yoyo((0,n.a)(s,"yoyo",!1))}static#e={"Back.In":t=>e.E.Back.In(t),"Back.InOut":t=>e.E.Back.InOut(t),"Back.Out":t=>e.E.Back.Out(t),"Bounce.In":t=>e.E.Bounce.In(t),"Bounce.InOut":t=>e.E.Bounce.InOut(t),"Bounce.Out":t=>e.E.Bounce.Out(t),"Circular.In":t=>e.E.Circular.In(t),"Circular.InOut":t=>e.E.Circular.InOut(t),"Circular.Out":t=>e.E.Circular.Out(t),"Cubic.In":t=>e.E.Cubic.In(t),"Cubic.InOut":t=>e.E.Cubic.InOut(t),"Cubic.Out":t=>e.E.Cubic.Out(t),"Elastic.In":t=>e.E.Elastic.In(t),"Elastic.InOut":t=>e.E.Elastic.InOut(t),"Elastic.Out":t=>e.E.Elastic.Out(t),"Exponential.In":t=>e.E.Exponential.In(t),"Exponential.InOut":t=>e.E.Exponential.InOut(t),"Exponential.Out":t=>e.E.Exponential.Out(t),"Linear.None":t=>e.E.Linear.None(t),"Quadratic.In":t=>e.E.Quadratic.In(t),"Quadratic.InOut":t=>e.E.Quadratic.InOut(t),"Quadratic.Out":t=>e.E.Quadratic.Out(t),"Quartic.In":t=>e.E.Quartic.In(t),"Quartic.InOut":t=>e.E.Quartic.InOut(t),"Quartic.Out":t=>e.E.Quartic.Out(t),"Quintic.In":t=>e.E.Quintic.In(t),"Quintic.InOut":t=>e.E.Quintic.InOut(t),"Quintic.Out":t=>e.E.Quintic.Out(t),"Sinusoidal.In":t=>e.E.Sinusoidal.In(t),"Sinusoidal.InOut":t=>e.E.Sinusoidal.InOut(t),"Sinusoidal.Out":t=>e.E.Sinusoidal.Out(t)};static ease(t){if(!t)return t=>e.E.Linear.None(t);const s=h.#e[t];if(!s)throw"異常なease指定です";return s}static hMemberCnt={alpha:0,height:0,rotation:0,scale_x:0,scale_y:0,pivot_x:0,pivot_y:0,width:0,x:0,y:0};static cnvTweenArg(t,s){const i={};for(const n of Object.keys(h.hMemberCnt)){const e=t[n];if(!e)continue;const h=String(e),a=h.startsWith("="),o=a?h.slice(1):h;if(!o)continue;const[r,c]=o.split(","),l=i[n]=parseFloat(r);c&&(i[n]+=Math.round(Math.random()*(parseFloat(c)-l+1))),a&&(i[n]+=parseFloat(s[n]))}return i}static stopAllTw(){h.#t={},(0,e.a)()}static tween(t,s,i,a,o,r,c,l=!0){const u=this.#s.isSkipping?0:(0,n.b)(s,"time",NaN),f=new e.T(i).to(a,u).onUpdate(o);h.setTwProp(f,s),h.#t[t]={tw:f,onEnd:c};const{path:p}=s;let d=f;if(p){n.C.debugLog&&console.group(`🍝 [${s[":タグ名"]}] path=${p}= start(${i.x},${i.y},${i.alpha})`);for(const{groups:t}of p.matchAll(h.#h)){const{x:a,x2:o,y:r,y2:c,o:l,o2:f,json:p}=t;let m={};if(p)try{m=JSON.parse(p)}catch(t){console.error(`🍝 json=${p} `+t);continue}else(a??o)&&(m.x=a??o),(r??c)&&(m.y=r??c),(l??f)&&(m.alpha=l??f);const g=h.cnvTweenArg(m,i);n.C.debugLog&&console.info(`🍝 ${p??`{x:${a} y:${r} o:${l}}`} => hTo:${JSON.stringify(g)}`);const k=new e.T(i).to(g,u);h.setTwProp(k,s),d.chain(k),d=k}n.C.debugLog&&console.groupEnd()}d.onComplete((()=>{const s=h.#t[t];s&&(delete h.#t[t],s.tw=void 0,f.stop(),h.#s.breakEvent("tsy nm:"+t),s.onEnd?.(),r())}));const{chain:m}=s;if(m){const t=h.#t[m];if(!t?.tw)throw`${m}は存在しない・または終了したトゥイーンです`;delete t.onEnd,t.tw.chain(f)}else l&&f.start();return f}static#h=/\(\s*(?:(?<x>[-=\d\.]+)|(['"])(?<x2>.*?)\2)?(?:\s*,\s*(?:(?<y>[-=\d\.]+)|(['"])(?<y2>.*?)\5)?(?:\s*,\s*(?:(?<o>[-=\d\.]+)|(['"])(?<o2>.*?)\8))?)?|(?<json>\{[^{}]*})/g;static wt(t){return!!h.#t[h.TW_INT_TRANS]?.tw&&h.#s.waitEvent("tsy nm:"+h.TW_INT_TRANS,t,(()=>h.finish_trans()))}static TW_INT_TRANS="trans\n";static finish_trans(){return h.#t[h.TW_INT_TRANS]?.tw?.stop().end(),!1}static wait_tsy(t){const{layer:s="",id:i,name:e}=t,a=i?`frm\n${i}`:e??s;if(!a)throw"トゥイーンが指定されていません";const o=h.#t[a];if(!o?.tw){if((0,n.a)(t,"chk_exist_tw",!1))throw i?`フレームトゥイーン ${i} が見つかりません。`:`トゥイーン ${a} が見つかりません。(layer:${s} name:${e})`;return!1}return h.#s.waitEvent("tsy nm:"+a,t,(()=>o.tw?.end()))}static stop_tsy(t){const{layer:s="",id:i,name:n}=t,e=i?`frm\n${i}`:n??s;if(!e)throw"トゥイーンが指定されていません";return h.#t[e]?.tw?.stop().end(),!1}static pause_tsy(t){const{layer:s="",id:i,name:n}=t,e=i?`frm\n${i}`:n??s;if(!e)throw"トゥイーンが指定されていません";return h.#t[e]?.tw?.pause(),!1}static resume_tsy(t){const{layer:s="",id:i,name:n}=t,e=i?`frm\n${i}`:n??s;if(!e)throw"トゥイーンが指定されていません";return h.#t[e]?.tw?.resume(),!1}}},7659:(t,s,i)=>{i.d(s,{R:()=>n});class n{static#n="ヽ";static setting(t){t.sesame&&(n.#n=t.sesame)}static getSesame(){return n.#n}static destroy(){n.#n="ヽ"}#t=()=>{};init(t){this.#t=t}static#h;static setEscape(t){n.#h=new RegExp((t?`(?<ce>\\${t}\\S)|`:"")+"｜(?<str>[^《\\n]+)《(?<ruby>[^》\\n]+)》|(?:(?<kan>[⺀-⿟々〇〻㐀-鿿豈-﫿]+[ぁ-ヿ]*|[^　｜《》\\n])《(?<kan_ruby>[^》\\n]+)》)|(?<txt>[\ud800-\udbff][\udc00-\udfff]|[^｜《》]+?|.)","gs")}putTxt(t){for(const{groups:s}of t.matchAll(n.#h)){const{ruby:t,kan_ruby:i,kan:n="",ce:e,txt:h="",str:a=""}=s;if(t)this.putTxtRb(decodeURIComponent(a),t);else if(i)this.putTxtRb(n,i);else if(e)this.#t(e.slice(1),"");else for(const t of Array.from(h))this.#t(t,"")}}putTxtRb(t,s){if(/^\w+｜{"/.test(s))return void this.#t(t,s);const i=Array.from(t),e=i.length;if(/^\*.?$/.test(s)){const t="center｜"+("*"===s?n.#n:s.charAt(1));for(let s=0;s<e;++s)this.#t(i[s],t);return}if(1===e||!s.includes(" "))return void this.#t(t,decodeURIComponent(s));const h=s.split(" "),a=h.length,o=a>e?a:e;for(let t=0;t<o;++t)this.#t(t<e?i[t]:"",t<a?decodeURIComponent(h[t]):"")}}},2035:(t,s,i)=>{i.r(s),i.d(s,{ScriptIterator:()=>r});var n=i(4449),e=i(7659),h=i(3653),a=i(7859);class o{constructor(t="",s=0,i={":hEvt1Time":{},":hMp":{},":lenIfStk":1}){this.fn=t,this.idx=s,this.csArg=i}toString=()=>`[fn:${this.fn}, idx:${this.idx}, csArg:${this.csArg}]`}class r{constructor(t,s,i,h,a,o,c){this.cfg=t,this.hTag=s,this.main=i,this.val=h,this.prpPrs=a,this.sndMng=o,this.sys=c,s.let_ml=t=>this.#a(t),s.endlet_ml=()=>!1,s.dump_stack=()=>this.#o(),s.dump_script=t=>this.#r(t),s.else=s.elsif=s.endif=()=>this.#c(),s.if=t=>this.#l(t),s.call=t=>this.#u(t),s.jump=t=>this.#f(t),s.pop_stack=t=>this.#p(t),s.return=t=>this.#d(t),s.bracket2macro=t=>this.#m(t),s.char2macro=t=>this.#g(t),s.endmacro=t=>this.#d(t),s.macro=t=>this.#k(t),s.load=t=>this.#b(t),s.reload_script=t=>this.#y(t),s.record_place=()=>this.#v(),s.save=t=>this.#T(t),t.oCfg.debug.token&&(this.#_=t=>{""!==t.trim()&&console.log(`🌱 トークン fn:${this.#s} idx:${this.#t} ln:${this.#w} token【${t}】`)}),h.defTmp("const.sn.aIfStk.length",(()=>this.#e.length)),h.defTmp("const.sn.vctCallStk.length",(()=>this.#h.length)),this.#E=new n.G(t);const l=t.oCfg.init.escape;if(this.#E.setEscape(l),e.R.setEscape(l),n.C.isDbg){c.addHook(((t,s)=>this.#I[t]?.(s))),this.isBreak=this.#x;const t=this.analyzeInit;this.analyzeInit=()=>{this.analyzeInit=()=>{},this.sys.send2Dbg("hi",{})},this.#I.auth=s=>{const i=s.hBreakpoint.hFn2hLineBP;for(const[t,s]of Object.entries(i))this.#S(t,s);r.#$={};for(const t of s.hBreakpoint.aFunc)r.#$[t.name]=1;if(s.stopOnEntry){for(;;){let t=this.nextToken();if(!t)break;const s=t.charCodeAt(0);if(91===s||38===s||42===s&&1===t.length)break;10===s&&(this.#w+=t.length)}this.sys.callHook("stopOnEntry",{}),this.analyzeInit=t,this.analyzeInit()}else this.noticeWait=()=>{this.noticeWait=()=>{},this.sys.callHook("stopOnEntry",{})},this.analyzeInit=t,this.analyzeInit()}}else this.recodeDesign=()=>{};t.oCfg.debug.tag&&(this.#O=t=>console.log(`🌲 タグ解析 fn:${this.#s} idx:${this.#t} ln:${this.#w} %c[${t} %o]`,"background-color:#30B;",this.#N.hPrm))}#n={aToken:[""],len:1,aLNum:[1]};#s="";get scriptFn(){return this.#s}#t=0;subIdxToken(){--this.#t}#w=0;get lineNum(){return this.#w}addLineNum=t=>this.#w+=t;jumpJustBefore(){this.#L(this.#s,"",--this.#t)}#h=[];#E;#N=new n.A;noticeWait=()=>{};#S(t,s){r.#C[this.#A(t)]=s}destroy(){this.isBreak=()=>!1}#I={disconnect:()=>{r.#C={},r.#$={},this.isBreak=()=>!1,this.#I.continue({}),this.#B=0},restart:()=>this.isBreak=()=>!1,add_break:t=>this.#S(t.fn,t.o),data_break:t=>{0===this.#B&&(this.#B=1,this.main.setLoop(!1,`変数 ${t.dataId}【${t.old_v}】→【${t.new_v}】データブレーク`),this.sys.callHook("stopOnDataBreakpoint",{}),this.sys.send2Dbg("stopOnDataBreakpoint",{}))},set_func_break:t=>{r.#$={};for(const s of t.a)r.#$[s.name]=1;this.sys.send2Dbg(t.ri,{})},stack:t=>this.sys.send2Dbg(t.ri,{a:this.#P()}),eval:t=>{this.sys.send2Dbg(t.ri,{v:this.prpPrs.parse(t.txt)})},continue:()=>{this.#D()||(this.#t-=this.#j,this.#B=3,this.main.setLoop(!0),this.main.resume())},stepover:t=>this.#M(t),stepin:()=>{if(this.#D())return;const t=this.#n.aToken[this.#t-this.#j];this.sys.callHook("stopOnStep"+(this.#W.test(t??"")?"In":""),{}),this.#t-=this.#j,this.#B=1===this.#B?4:5,this.main.setLoop(!0),this.main.resume()},stepout:t=>{this.#D()||(this.#h.length>0?this.#F(!0):this.#M(t))},pause:()=>{this.#B=4,this.main.setLoop(!1,"一時停止"),this.sys.send2Dbg("stopOnStep",{})},stopOnEntry:()=>{this.#B=4,this.main.setLoop(!1,"一時停止"),this.sys.send2Dbg("stopOnEntry",{})}};#Q=t=>this.cfg.searchPath(t,n.S.SCRIPT);static#R=/(.+)\/crypto_prj\/([^\/]+)\/[^\.]+(\.\w+)/;#A=t=>(this.sys.pathBaseCnvSnPath4Dbg+this.#Q(t)).replace(r.#R,`$1/prj/$2/${this.#s}$3`);cnvPath4Dbg=t=>this.sys.pathBaseCnvSnPath4Dbg+t.replace("/crypto_prj/","/prj/");#M(t){if(this.#D())return;const s=this.#n.aToken[this.#t-this.#j];this.#W.test(s??"")?this.#F(!1):(this.sys.callHook("stopOnStep",{}),this.#I.stepin(t))}#F(t){this.sys.callHook("stopOnStep"+(t?"Out":""),{}),this.#V=this.#h.length-(t?1:0),this.#t-=this.#j,this.#B=t?7:6,this.main.setLoop(!0),this.main.resume()}#V=0;get#j(){return 2===this.#B||4===this.#B?1:0}#D(){return!(this.#t<this.#n.len||(this.sys.callHook("stopOnEntry",{}),this.main.setLoop(!1,"スクリプト終端です"),0))}static#C={};static#$={};#B=0;isBreak=t=>!1;#x(t){switch(this.#B){case 6:this.#z(),this.#B=7;break;case 7:if(this.#h.length!==this.#V)break;return this.#B=4,this.main.setLoop(!1,"ステップ実行"),this.sys.send2Dbg("stopOnStep",{}),!0;case 5:this.#z(),this.#B=4;break;case 4:return this.#z(),this.main.setLoop(!1,"ステップ実行"),this.sys.send2Dbg("stopOnStep",{}),!0;case 3:this.#z(),this.#B=0;break;default:if((0,n.t)(t)in r.#$)return this.#B=2,this.main.setLoop(!1,`関数 ${t} ブレーク`),this.sys.callHook("stopOnBreakpoint",{}),this.sys.send2Dbg("stopOnBreakpoint",{}),!0;{const t=r.#C[this.#A(this.#s)];if(!t)break;const s=t[this.#w];if(!s)break;if(s.condition){if(!this.prpPrs.parse(s.condition))break}else if("hitCondition"in s&&--s.hitCondition>0)break;const i=0===this.#B;this.#B=2,this.main.setLoop(!1,i?(s.condition?"条件":"ヒットカウント")+"ブレーク":"ステップ実行");const n=i?"stopOnBreakpoint":"stopOnStep";this.sys.callHook(n,{}),this.sys.send2Dbg(n,{})}return!0}return!1}#z(){const t=r.#C[(0,n.f)(this.#s)]?.[this.#w];t?.hitCondition&&--t.hitCondition}#P(){const t=3===this.#B?1:0,s=this.#n.aToken[this.#t-1+t],i=this.#A(this.#s),e=(0,n.t)(s),h=e?`[${e}]`:s,a=this.val.getVal("mp:const.sn.macro")??"{}";if(0===this.#t)return[{fn:i,ln:1,col:1,nm:h,ma:a}];const o=this.#H(this.#n,this.#t),r=[{fn:i,ln:o.ln,col:o.col_s+1,nm:h,ma:a}],c=this.#h.length;if(0===c)return r;for(let t=c-1;t>=0;--t){const s=this.#h[t],i=this.#i[s.fn];if(!i)continue;const e=i.aToken[s.idx-1];if(!e)continue;const h=this.#H(i,s.idx),a=(0,n.t)(e);r.push({fn:this.#A(s.fn),ln:h.ln,col:h.col_s+1,nm:a?`[${a}]`:e,ma:s.csArg[":hMp"]["const.sn.macro"]??"{}"})}return r}#O=t=>{};タグ解析(t){const[s,i]=(0,n.h)(t),e=this.hTag[s];if(!e)throw`未定義のタグ【${s}】です`;this.#N.parse(i),this.#O(s);const h=this.#N.hPrm;if(h.cond){const t=h.cond.val;if(!t||t.startsWith("&"))throw"属性condは「&」が不要です";const s=this.prpPrs.parse(t),i=String(s);if("null"===i||"undefined"===i||!s)return!1}let a={};const o=this.#h.length,r=0===o?{}:this.#h[o-1].csArg;if(this.#N.isKomeParam){if(0===o)throw"属性「*」はマクロのみ有効です";a={...r}}a[":タグ名"]=s;for(const[t,{val:s,def:i}]of Object.entries(h)){let n=s;if(n?.startsWith("%")){if(0===o)throw"属性「%」はマクロ定義内でのみ使用できます（そのマクロの引数を示す簡略文法であるため）";const s=r[n.slice(1)];if(s){a[t]=s;continue}if(void 0===i||"null"===i)continue;n=i}n=this.prpPrs.getValAmpersand(n??""),"undefined"===n?void 0!==i&&(n=this.prpPrs.getValAmpersand(i),"undefined"!==n&&(a[t]=n)):a[t]=n}return e(a)}#K;#U;setOtherObj(t,s){this.#K=t,this.#U=s}#a(t){const{name:s}=t;if(!s)throw"nameは必須です";let i="";const n=this.#n.len;for(;this.#t<n&&(i=this.#n.aToken[this.#t],""===i);++this.#t);return t.text=i,t.cast="str",this.hTag.let(t),this.#t+=2,this.#w+=(i.match(/\n/g)??[]).length,!1}#o(){if(0===this.#t)return console.group(`🥟 [dump_stack] スクリプト現在地 fn:${this.#s} line:1 col:0`),console.groupEnd(),!1;const t=this.#H(this.#n,this.#t),s=`スクリプト現在地 fn:${this.#s} line:${t.ln} col:${t.col_s+1}`;console.group(`🥟 [dump_stack] ${s}`);const i=this.#h.length;if(i>0){console.info(s);for(let t=i-1;t>=0;--t){const s=this.#h[t],n=s.csArg[":hMp"],e=n?n[":タグ名"]:void 0,h=s.csArg[":タグ名"]??"",a=this.#H(this.#i[s.fn],s.idx);console.info(`${i-t}つ前のコール元 fn:${s.fn} line:${a.ln} col:${a.col_s+1}`+(e?"（["+e+"]マクロ内）":" ")+`で [${h} ...]をコール`)}}return console.groupEnd(),!1}#H(t,s){const i={ln:1,col_s:0,col_e:0};if(!t)return i;let n=s-1;const e=i.ln=t.aLNum[n];for(;t.aLNum[n]===e;){if(!t.aToken[n].startsWith("\n")){const s=t.aToken[n].length;i.col_e>0&&(i.col_s+=s),i.col_e+=s}if(--n<0)break}return i}#r(t){const{set_fnc:s,break_fnc:i}=t;if(!s)throw"set_fncは必須です";if(this.#J=globalThis[s],!this.#J){if((0,n.a)(t,"need_err",!0))throw`HTML内に関数${s}が見つかりません`;return this.#J=()=>{},!1}if(this.noticeBreak=t=>{this.#G!==this.#s&&(this.#G=this.#s,this.#J(this.#q[this.#s]??=this.#n.aToken.join(""))),this.#X(this.#w,t)},this.noticeBreak(!0),!i)return!1;if(this.#X=globalThis[i],!this.#X){if((0,n.a)(t,"need_err",!0))throw`HTML内に関数${i}が見つかりません`;this.#X=()=>{}}return!1}#J=()=>{};#X=()=>{};#G="";#q={};noticeBreak=t=>{};#Y=5;dumpErrForeLine(){if(0===this.#t)return console.group(`🥟 Error line (from 0 rows before) fn:${this.#s}`),void console.groupEnd();let t="";for(let s=this.#t-1;s>=0&&(t=this.#n.aToken[s]+t,!((t.match(/\n/g)??[]).length>=this.#Y));--s);const s=t.split("\n").slice(-this.#Y),i=s.length;console.group(`🥟 Error line (from ${i} rows before) fn:${this.#s}`);const n=String(this.#w).length,e=this.#H(this.#n,this.#t);for(let t=0;t<i;++t){const h=this.#w-i+t+1,a=`${String(h).padStart(n," ")}: %c`,o=s[t],r=o.length>75?o.slice(0,75)+"…":o;t===i-1?console.info(a+r.slice(0,e.col_s)+"%c"+r.slice(e.col_s),"color: black; background-color: skyblue;","color: black; background-color: pink;"):console.info(a+r,"color: black; background-color: skyblue;")}console.groupEnd()}#e=[-1];#c(){const t=this.#e[0];if(!t)throw"this.#aIfStk が異常です";if(-1===t)throw"ifブロック内ではありません";return this.#t=t,this.#e.shift(),!1}#l(t){const{exp:s}=t;if(!s)throw"expは必須です";if(s.startsWith("&"))throw"属性expは「&」が不要です";let i=0,e=this.prpPrs.parse(s)?this.#t:-1;const h=this.#n.aLNum[this.#t];let a=this.#w-(h||0);const o=this.#n.len;for(;this.#t<o;++this.#t){const t=this.#n.aLNum[this.#t];this.#n.aLNum[this.#t]=(t||0)+a;const s=this.#n.aToken[this.#t];if(!s)continue;const h=s.charCodeAt(0);if(10===h){this.#w+=s.length;continue}if(91!==h)continue;const[o,r]=(0,n.h)(s);if(!(o in this.hTag))throw`未定義のタグ[${o}]です`;switch(this.#N.parse(r),o){case"if":++i;break;case"elsif":if(i>0||e>-1)break;const t=this.#N.hPrm.exp?.val;if(!t)throw"expは必須です";if(t.startsWith("&"))throw"属性expは「&」が不要です";this.prpPrs.parse(t)&&(e=this.#t+1);break;case"else":if(i>0)break;-1===e&&(e=this.#t+1);break;case"endif":if(i>0){--i;break}return-1===e?(++this.#t,this.#n.aLNum[this.#t]+=a):(this.#e.unshift(this.#t+1),this.#t=e,this.#w=this.#n.aLNum[this.#t]),!1}}throw"[endif]がないままスクリプト終端です"}#u(t){(0,n.a)(t,"count",!1)||this.#Z();const{fn:s}=t;return s&&this.#Q(s),this.#tt({...t,":hEvt1Time":this.#K.popLocalEvts()}),(0,n.a)(t,"clear_local_event",!1)&&this.hTag.clear_event({}),this.#L(s,t.label)}#tt(t){const s={...t,":hMp":this.val.cloneMp(),":lenIfStk":this.#e.length};this.#n.aLNum[this.#t]=this.#w,this.#st||(s[":resvToken"]="",this.#it()),this.#h.push(new o(this.#s,this.#t,s)),this.#e.unshift(-1)}#f(t){return(0,n.a)(t,"count",!0)||this.#Z(),this.#e[0]=-1,this.#L(t.fn,t.label)}#p(t){if((0,n.a)(t,"clear",!1))this.#h=[];else if(!this.#h.pop())throw"[pop_stack] スタックが空です";return this.#it(),this.#e=[-1],this.val.setMp({}),!1}#d(t){const s=this.#h.pop();if(!s)throw"[return] スタックが空です";const i=s.csArg;this.#e=this.#e.slice(-i[":lenIfStk"]);const n=i[":hMp"];n&&this.val.setMp(n);const e=i[":resvToken"];e?this.nextToken=()=>(this.#it(),e):this.#it(),i[":hEvt1Time"]&&this.#K.pushLocalEvts(i[":hEvt1Time"]);const{fn:h,label:a}=t;return h||a?this.#L(h,a):s.fn in this.#i?(this.#nt(s),!1):this.#L(s.fn,"",s.idx)}#st="";#it(){this.#st="",this.nextToken=this.#et}#ht="";#L(t="",s="",i=0){if(!t&&!s&&this.main.errScript("[jump系] fnまたはlabelは必須です"),s?(s.startsWith("*")||this.main.errScript("[jump系] labelは*で始まります"),this.#ht=s,this.#ht.startsWith("**")||(this.#t=i)):(this.#ht="",this.#t=i),!t)return this.analyzeInit(),!1;if(t.includes("@"))throw"[jump系] fn には文字「@」は禁止です";const e=this.#Q(t);if(t===this.#s)return this.analyzeInit(),!1;this.#s=t;const a=this.#i[t];if(a)return this.#n=a,this.analyzeInit(),!1;(0,h.d)();const o=new n.L;let r="";try{r=this.#Q(t+"@"),o.add({name:t+":base",url:e}),o.add({name:t,url:r})}catch{o.add({name:t,url:e})}return o.use((async(t,s)=>{try{t.data=await this.sys.dec(t.extension,t.data)}catch(s){this.main.errScript(`[jump系]snロード失敗です fn:${t.name} ${s}`,!1)}s()})).load(((s,i)=>{if(r){const s=i[t+":base"].data,n=i[t].data,e=s.split("\n"),h=n.split("\n"),a=e.length,o=h.length;for(let t=0;t<o&&t<a;++t)h[t]||=e[t];i[t].data=h.join("\n"),delete i[t+":base"]}this.nextToken=this.#et,this.#w=1,this.#at(i[t].data),this.hTag.record_place({}),this.analyzeInit(),(0,h.e)()})),!0}analyzeInit(){const t=this.#ot(this.#n,!!this.val.getVal("mp:const.sn.macro.name"),this.#w,this.#ht,this.#t);this.#t=t.idx,this.#w=t.ln}nextToken=()=>"";#et(){if(this.#rt())return"";this.#ct(),this.#n.aLNum[this.#t]||=this.#w;const t=this.#n.aToken[this.#t];return this.#_(t),++this.#t,t}#_=t=>{};#rt(){return!(this.#t<this.#n.len||(this.main.errScript("スクリプト終端です"),0))}#lt=/(\*{2,})([^\|]*)/;#ut=/^\[macro\s/;#ft=/^\[endmacro[\s\]]/;#ot(t,s,i,e,h){const a=t.aToken.length;if(!e){if(this.#rt())return{idx:h,ln:i};if(t.aLNum[h])i=t.aLNum[h];else{i=1;for(let s=0;s<h;++s){t.aLNum[s]||=i;const n=t.aToken[s];n.startsWith("\n")?i+=n.length:i+=(n.match(/\n/g)??[]).length}t.aLNum[h]=i}return{idx:h,ln:i}}t.aLNum[0]=1;const o=e.match(this.#lt);if(o){e=o[1];let r=h;switch(o[2]){case"before":for(;t.aToken[--r]!==e;)0===r&&n.D.myTrace("[jump系 無名ラベルbefore] "+i+"行目以前で"+(s?"マクロ内に":"")+"ラベル【"+e+"】がありません","ET"),s&&t.aToken[r].search(this.#ut)>-1&&n.D.myTrace("[jump系 無名ラベルbefore] マクロ内にラベル【"+e+"】がありません","ET");return{idx:r+1,ln:t.aLNum[r]};case"after":for(;t.aToken[++r]!==e;)r===a&&n.D.myTrace("[jump系 無名ラベルafter] "+i+"行目以後でマクロ内にラベル【"+e+"】がありません","ET"),t.aToken[r].search(this.#ft)>-1&&n.D.myTrace("[jump系 無名ラベルafter] "+i+"行目以後でマクロ内にラベル【"+e+"】がありません","ET");return{idx:r+1,ln:t.aLNum[r]};default:n.D.myTrace("[jump系] 無名ラベル指定【label="+e+"】が間違っています","ET")}}i=1;const r=new RegExp("^"+e.replaceAll("*","\\*")+"(?=\\s|;|\\[|\\||$)");let c=!1;for(let s=0;s<a;++s){t.aLNum[s]||=i;const n=t.aToken[s];if(c){this.#E.testTagEndLetml(n)?c=!1:i+=(n.match(/\n/g)??[]).length;continue}const e=n.charCodeAt(0);if(10!==e){if(42!==e)91===e&&(i+=(n.match(/\n/g)??[]).length,this.#E.testTagLetml(n)&&(c=!0));else if(n.search(r)>-1)return{idx:s+1,ln:i}}else i+=n.length}throw c?"[let_ml]の終端・[endlet_ml]がありません":(n.D.myTrace(`[jump系] ラベル【${e}】がありません`,"ET"),"Dummy")}#i=Object.create(null);#at(t){let s="";try{s="ScriptIterator.resolveScript";const i=this.#E.resolveScript(t);s="ScriptIterator.replaceScript_Wildcard",this.#pt(i),this.#i[this.#s]=this.#n=i}catch(t){t instanceof Error?s+=`例外 mes=${t.message}(${t.name})`:s=String(t),this.main.errScript(s,!1)}this.val.touchAreaKidoku(this.#s)}#nt(t){this.#s=t.fn,this.#t=t.idx;const s=this.#i[this.#s];s&&(this.#n=s),this.#w=this.#n.aLNum[t.idx]}#dt=/^\[(call|loadplugin)\s/;#mt=/\bfn\s*=\s*[^\s\]]+/;#pt(t){for(let s=t.len-1;s>=0;--s){const i=t.aToken[s];if(!this.#dt.test(i))continue;const[e,h]=(0,n.h)(i);this.#N.parse(h);const a=this.#N.hPrm.fn;if(!a)continue;const{val:o}=a;if(!o||!o.endsWith("*"))continue;t.aToken.splice(s,1,"\t","; "+i),t.aLNum.splice(s,1,NaN,NaN);const r="loadplugin"===e?n.S.CSS:n.S.SN,c=this.cfg.matchPath("^"+o.slice(0,-1)+".*",r);for(const e of c){const h=i.replace(this.#mt,"fn="+decodeURIComponent((0,n.f)(e[r])));t.aToken.splice(s,0,h),t.aLNum.splice(s,0,NaN)}}t.len=t.aToken.length}#ct(){const t=this.val.touchAreaKidoku(this.#s);this.#h.length>0?t.record(this.#t):(this.#gt=t.search(this.#t),this.val.setVal_Nochk("tmp","const.sn.isKidoku",this.#gt),!this.#gt&&t.record(this.#t))}#gt=!1;get isKidoku(){return this.#gt}#Z(){this.val.getAreaKidoku(this.#s)?.erase(this.#t),this.#gt=!1}get isNextKidoku(){let t=this.#s,s=this.#t,i=this.#n.len;if(this.#h.length>0){const n=this.#h[0];t=n.fn,s=n.idx;const e=this.#i[t];e&&(i=e.len)}const n=this.val.getAreaKidoku(t);return s!==i&&n.search(s)}get normalWait(){return this.#gt?this.val.tagCh_doWait_Kidoku?this.val.tagCh_msecWait_Kidoku:0:this.val.tagCh_doWait?this.val.tagCh_msecWait:0}#m(t){return this.#E.bracket2macro(t,this.hTag,this.#n,this.#t),!1}#g(t){return this.#E.char2macro(t,this.hTag,this.#n,this.#t),!1}#kt=/["'#;\\]　]+/;#k(t){const{name:s}=t;if(!s)throw"nameは必須です";if(s in this.hTag)throw`[${s}]はタグかすでに定義済みのマクロです`;if(this.#kt.test(s))throw`[${s}]はマクロ名として異常です`;const i=this.#w,n=new o(this.#s,this.#t);for(this.#bt+="|"+s,this.#W=new RegExp(`\\[(${this.#bt})\\b`),this.hTag[s]=s=>(s.design_unit=t.design_unit,this.#tt(s),this.val.setMp(s),this.val.setVal_Nochk("mp","const.sn.macro",JSON.stringify({name:t.name})),this.val.setVal_Nochk("mp","const.sn.me_call_scriptFn",this.#s),this.#w=i,this.#nt(n),!1);this.#t<this.#n.len;++this.#t){this.#n.aLNum[this.#t]||=this.#w;const t=this.#n.aToken[this.#t];if(t.search(this.#ft)>-1)return++this.#t,!1;const s=t.charCodeAt(0);10===s?this.#w+=t.length:91===s&&(this.#w+=(t.match(/\n/g)??[]).length)}throw`マクロ[${s}]定義の終端・[endmacro]がありません`}#bt="call";#W=/\[(call)\b/;#b(t){if("fn"in t!="label"in t)throw"fnとlabelはセットで指定して下さい";const s=(0,n.b)(t,"place",0),i=this.val.getMark(s);return this.loadFromMark(t,i,2)}loadFromMark(t,s,i=0){this.hTag.clear_event({}),this.val.mark2save(s),this.val.setMp({}),this.#U.recPagebreak();let e=[];1!==i&&(e=this.sndMng.playLoopFromSaveObj(2===i)),(0,n.a)(t,"do_rec",!0)&&(this.#yt={hSave:this.val.cloneSave(),hPages:{...s.hPages},aIfStk:[...s.aIfStk]});const o={enabled:this.val.getVal("save:const.sn.autowc.enabled"),text:this.val.getVal("save:const.sn.autowc.text"),time:Number(this.val.getVal("save:const.sn.autowc.time"))};this.hTag.autowc(o),this.#e=[...this.#yt.aIfStk],this.#h=[],a.C.stopAllTw();const r=Promise.allSettled([...e,...this.#U.playback(this.#yt.hPages)]).then((()=>this.#U.cover(!1))).catch((t=>console.error("fn:ScriptIterator.ts loadFromMark e:%o",t))),{index:c,fn:l}=t;if(c)return r.then((()=>this.#L(l,"",c))),!0;this.#U.cover(!0),(0,h.d)();const u=String(this.val.getVal("save:const.sn.scriptFn")),f=Number(this.val.getVal("save:const.sn.scriptIdx"));delete this.#i[u];const{label:p}=t;return p?r.then((()=>{this.#s=u,this.#t=f,this.hTag.call({fn:l,label:p})})):r.then((()=>this.#L(u,"",f))),!0}#y(t){const s=this.val.getMark(0);delete this.#i[(0,n.f)(s.hSave["const.sn.scriptFn"])];const i={};for(const t in this.#i)try{this.#Q(t+"@")}catch{i[t]=this.#i[t]}return this.#i=i,t.do_rec=!1,this.loadFromMark(t,s,1)}#yt={hSave:{},hPages:{},aIfStk:[-1]};#v(){if(this.main.isDestroyed())return!1;const{fn:t,idx:s}=this.nowScrIdx();return this.val.setVal_Nochk("save","const.sn.scriptFn",t),this.val.setVal_Nochk("save","const.sn.scriptIdx",s),this.#yt={hSave:this.val.cloneSave(),hPages:this.#U.record(),aIfStk:this.#e.slice(this.#h.length)},!1}nowScrIdx(){if(0===this.#h.length)return{fn:this.#s,idx:this.#t};const t=this.#h[0];return{fn:t.fn,idx:t.idx}}nowMark(){return{...this.#yt}}nowScrFnLn(){const{fn:t,idx:s}=this.nowScrIdx(),i=this.#i[t];return{fn:t,...this.#H(i,s)}}#T(t){if(!("place"in t))throw"placeは必須です";const s=Number(t.place);delete t[":タグ名"],delete t.place,t.text=t.text??"",this.#yt.json=t,this.val.setMark(s,this.#yt);const i=Number(this.val.getVal("sys:const.sn.save.place"));return s===i&&this.val.setVal_Nochk("sys","const.sn.save.place",i+1),!1}recodeDesign(t){let s="",i=0;const n=this.#h.length;if(t.design_unit&&n>0){const t=this.#h[0];s=t.fn,i=t.idx}else s=this.#s,i=this.#t;t[":path"]=this.#A(s);const e=this.#i[s],h=this.#H(e,i);t[":ln"]=h.ln,t[":col_s"]=h.col_s,t[":col_e"]=h.col_e;const a=i-1;t[":idx_tkn"]=a,t[":token"]=e.aToken[a],this.sys.send2Dbg("_recodeDesign",t)}replace(t,s){this.#n.aToken[t]=s}}}}]);