import{K as C,C as S,M as O,m as w,N as y,x as _,e as m,O as $,v as A,D as k,d as D,c as M}from"./web.js";import{c as j,a as x,r as L}from"./CallStack.js";import{v as N,z as B}from"./SndBuf.js";import{a as v,n as I}from"./Reading.js";import"../web.js";class d{static#s="ヽ";static setting(t){t.sesame&&(d.#s=t.sesame)}static getSesame(){return d.#s}static destroy(){d.#s="ヽ"}#i=()=>{};init(t){this.#i=t}static#t;static setEscape(t){d.#t=new RegExp((t?`(?<ce>\\${t}\\S)|`:"")+"｜(?<str>[^《\\n]+)《(?<ruby>[^》\\n]+)》|(?:(?<kan>[⺀-⿟々〇〻㐀-鿿豈-﫿]+[ぁ-ヿ]*|[^　｜《》\\n])《(?<kan_ruby>[^》\\n]+)》)|(?<txt>[\uD800-\uDBFF][\uDC00-\uDFFF]|[^｜《》]+?|.)","gs")}putTxt(t){for(const{groups:s}of t.matchAll(d.#t)){const{ruby:i,kan_ruby:n,kan:h="",ce:o,txt:a="",str:r=""}=s;if(i){this.putTxtRb(decodeURIComponent(r),i);continue}if(n){this.putTxtRb(h,n);continue}if(o){this.#i(o.slice(1),"");continue}for(const e of Array.from(a))this.#i(e,"")}}putTxtRb(t,s){if(/^\w+｜{"/.test(s)){this.#i(t,s);return}const i=Array.from(t),n=i.length;if(/^\*.?$/.test(s)){const r="center｜"+(s==="*"?d.#s:s.charAt(1));for(let e=0;e<n;++e)this.#i(i[e],r);return}if(n===1||!s.includes(" ")){this.#i(t,decodeURIComponent(s));return}const h=s.split(" "),o=h.length,a=o>n?o:n;for(let r=0;r<a;++r)this.#i(r<n?i[r]:"",r<o?decodeURIComponent(h[r]):"")}}const E="compChIn";class g{constructor(t,s,i,n,h,o,a){this.cfg=t,this.hTag=s,this.main=i,this.val=n,this.prpPrs=h,this.sndMng=o,this.sys=a,s.let_ml=e=>this.#Z(e),s.endlet_ml=()=>!1,s.dump_stack=()=>this.#tt(),s.dump_script=e=>this.#st(e),s.else=s.elsif=s.endif=()=>this.#et(),s.if=e=>this.#nt(e),s.call=e=>this.#ht(e),s.jump=e=>this.#at(e),s.pop_stack=e=>this.#ot(e),s.return=e=>this.#j(e),s.bracket2macro=e=>this.#dt(e),s.char2macro=e=>this.#kt(e),s.endmacro=e=>this.#j(e),s.macro=e=>this.#vt(e),s.load=e=>this.#Tt(e),s.reload_script=e=>this.#St(e),s.record_place=()=>this.#q(),s.save=e=>this.#wt(e),t.oCfg.debug.token&&(this.#W=e=>{e.trim()!==""&&console.log(`🌱 トークン ${this.#i}:${String(this.#e)} (i:${String(this.#t)} cs:${String(this.#n.length)}) %c【${e}】`,"background-color:#350;")}),t.oCfg.debug.tag&&(this.#O=e=>console.log(`🌲 タグ解析 ${this.#i}:${String(this.#e)} (i:${String(this.#t)} cs:${String(this.#n.length)}) %c[${e} %o]`,"background-color:#30B;",this.#r.hPrm)),n.defTmp("const.sn.aIfStk.length",()=>this.#o.length),n.defTmp("const.sn.vctCallStk.length",()=>this.#n.length),this.#c=new C(t);const r=t.oCfg.init.escape;if(this.#c.setEscape(r),d.setEscape(r),S.isDbg){this.#d,a.addHook((l,f)=>this.#d[l]?.(f)),this.isBreak=l=>this.#U(l);const e=()=>this.analyzeInit();this.analyzeInit=()=>{this.analyzeInit=()=>{},this.sys.send2Dbg("hi",{})},this.#d.auth=l=>{const f=l.hBreakpoint.hFn2hLineBP;for(const[c,u]of Object.entries(f))this.#I(c,u);g.#g={};for(const c of l.hBreakpoint.aFunc)g.#g[c.name]=1;if(l.stopOnEntry){let c;for(;c=this.nextToken();){const u=c.charCodeAt(0);if(u===91||u===38||u===42&&c.length===1)break;u===10&&(this.#e+=c.length)}this.sys.callHook("stopOnEntry",{}),this.analyzeInit=e,this.analyzeInit()}else this.noticeWait=()=>{this.noticeWait=()=>{},this.sys.callHook("stopOnEntry",{})},this.analyzeInit=e,this.analyzeInit()}}else this.recodeDesign=()=>{}}#s={aToken:[""],len:1,aLNum:[1]};#i="";get scriptFn(){return this.#i}#t=0;get idxToken(){return this.#t}subIdxToken(){--this.#t}#e=0;get lineNum(){return this.#e}addLineNum=t=>{this.#e+=t};jumpJustBefore(){this.#f(this.#i,"",--this.#t)}#n=[];#c;#r=new O;noticeWait=()=>{};#I(t,s){g.#w[this.#b(t)]=s}destroy(){this.isBreak=this.#q=()=>!1}#d={auth:()=>{},disconnect:()=>{g.#w={},g.#g={},this.isBreak=()=>!1,this.#d.continue({}),this.#h=0},restart:()=>{this.isBreak=()=>!1},add_break:t=>this.#I(t.fn,t.o),data_break:t=>{this.#h===0&&(this.#h=1,this.main.setLoop(!1,`変数 ${t.dataId}【${t.old_v}】→【${t.new_v}】データブレーク`),this.sys.callHook("stopOnDataBreakpoint",{}),this.sys.send2Dbg("stopOnDataBreakpoint",{}))},set_func_break:t=>{g.#g={};for(const s of t.a)g.#g[s.name]=1;this.sys.send2Dbg(t.ri,{})},stack:t=>this.sys.send2Dbg(t.ri,{a:this.#G()}),eval:t=>{this.sys.send2Dbg(t.ri,{v:this.prpPrs.parse(t.txt)})},continue:()=>{this.#S()||(this.#t-=this.#v,this.#h=3,this.main.setLoop(!0),this.main.resume())},stepover:t=>this.#E(t),stepin:()=>{if(this.#S())return;const t=this.#s.aToken[this.#t-this.#v];this.sys.callHook(`stopOnStep${this.#N.test(t??"")?"In":""}`,{}),this.#t-=this.#v,this.#h=this.#h===1?4:5,this.main.setLoop(!0),this.main.resume()},stepout:t=>{this.#S()||(this.#n.length>0?this.#P(!0):this.#E(t))},pause:()=>{this.#h=4,this.main.setLoop(!1,"一時停止"),this.sys.send2Dbg("stopOnStep",{})},stopOnEntry:()=>{this.#h=4,this.main.setLoop(!1,"一時停止"),this.sys.send2Dbg("stopOnEntry",{})}};#k=t=>this.cfg.searchPath(t,w.SCRIPT);#b=t=>this.sys.pathBaseCnvSnPath4Dbg+this.#k(t);#E(t){if(this.#S())return;const s=this.#s.aToken[this.#t-this.#v];this.#N.test(s??"")?this.#P(!1):(this.sys.callHook("stopOnStep",{}),this.#d.stepin(t))}#P(t){this.sys.callHook(`stopOnStep${t?"Out":""}`,{}),this.#C=this.#n.length-(t?1:0),this.#t-=this.#v,this.#h=t?7:6,this.main.setLoop(!0),this.main.resume()}#C=0;get#v(){return this.#h===2||this.#h===4?1:0}#S(){return this.#t<this.#s.len?!1:(this.sys.callHook("stopOnEntry",{}),this.main.setLoop(!1,"スクリプト終端です isIdxOverLast"),!0)}static#w={};static#g={};#h=0;isBreak=t=>!1;#U(t){switch(this.#h){case 6:this.#y(),this.#h=7;break;case 7:if(this.#n.length!==this.#C)break;return this.#h=4,this.main.setLoop(!1,"ステップ実行"),this.sys.send2Dbg("stopOnStep",{}),!0;case 5:this.#y(),this.#h=4;break;case 4:return this.#y(),this.main.setLoop(!1,"ステップ実行"),this.sys.send2Dbg("stopOnStep",{}),!0;case 3:this.#y(),this.#h=0;break;default:if(y(t)in g.#g)return this.#h=2,this.main.setLoop(!1,`関数 ${t} ブレーク`),this.sys.callHook("stopOnBreakpoint",{}),this.sys.send2Dbg("stopOnBreakpoint",{}),!0;{const s=g.#w[this.#b(this.#i)];if(!s)break;const i=s[this.#e];if(!i)break;if(i.condition){if(!this.prpPrs.parse(i.condition))break}else if("hitCondition"in i&&--i.hitCondition>0)break;const n=this.#h===0;this.#h=2,this.main.setLoop(!1,n?(i.condition?"条件":"ヒットカウント")+"ブレーク":"ステップ実行");const h=n?"stopOnBreakpoint":"stopOnStep";this.sys.callHook(h,{}),this.sys.send2Dbg(h,{})}return!0}return!1}#y(){const t=g.#w[_(this.#i)]?.[this.#e];t?.hitCondition&&--t.hitCondition}#G(){const t=this.#h===3?1:0,s=this.#s.aToken[this.#t-1+t],i=this.#b(this.#i),n=y(s),h=n?`[${n}]`:s,o=String(this.val.getVal("mp:const.sn.macro")??"{}");if(this.#t===0)return[{fn:i,ln:1,col:1,nm:h,ma:o}];const a=this.#l(this.#s,this.#t),r=[{fn:i,ln:a.ln,col:a.col_s+1,nm:h,ma:o}],e=this.#n.length;if(e===0)return r;for(let l=e-1;l>=0;--l){const f=this.#n[l],c=this.#a[f.fn];if(!c)continue;const u=c.aToken[f.idx-1];if(!u)continue;const p=this.#l(c,f.idx),T=y(u);r.push({fn:this.#b(f.fn),ln:p.ln,col:p.col_s+1,nm:T?`[${T}]`:u,ma:f.csArg[":hMp"]["const.sn.macro"]})}return r}#O=t=>{};async タグ解析(t,s){const i=this.hTag[t];if(!i)throw`未定義のタグ【${t}】です`;this.#r.parse(s),this.#O(t);const n=this.#r.hPrm;if(n.cond){const e=n.cond.val;if(!e||e.startsWith("&"))throw"属性condは「&」が不要です";const l=this.prpPrs.parse(e),f=String(l);if(f==="null"||f==="undefined"||!l)return!1}let h={};const o=this.#n.at(-1)?.csArg??j(),a=this.#n.length;if(this.#r.isKomeParam){if(a===0)throw"属性「*」はマクロのみ有効です";h={...o}}h[":タグ名"]=t;for(const[e,{val:l,def:f}]of Object.entries(n)){let c=l;if(l.startsWith("%")){if(a===0)throw"属性「%」はマクロ定義内でのみ使用できます（そのマクロの引数を示す簡略文法であるため）";const u=o[c.slice(1)];if(u){h[e]=u;continue}if(f===void 0||f==="null")continue;c=f}if(c=this.prpPrs.getValAmpersand(c??""),c!=="undefined"){h[e]=c;continue}f!==void 0&&(c=this.prpPrs.getValAmpersand(f),c!=="undefined"&&(h[e]=c))}if(v.needGoTxt&&this.#J.has(t)){const{promise:e,resolve:l}=Promise.withResolvers();v.beginProc(E,()=>l(0),!1,()=>l(0)),v.goTxt(),this.val.saveKidoku(),await e}this.#X.has(t)&&(this.#L.hideHint(),await N.closeTrans());const r=this.#Q[t];return r&&m(h,"canskip",this.#Y[t]??!0)&&this.#L.isSkipping?r(n):i(h)}#J=new Set(["trans","wt","wait_tsy","wv","l","p","s","wait","waitclick","wb","wf","wl","ws","quake","wq"]);#X=new Set(["finish_trans","trans","quake","stop_quake","add_filter"]);#Q={wt:()=>!1,wait_tsy:t=>this.hTag.stop_tsy(t),wait:()=>!1,wb:()=>this.hTag.stopfadese({buf:B}),wf:t=>this.hTag.stopfadese(t),wq:()=>this.hTag.stop_quake({}),quake:()=>!1};#Y={wt:!0,wait_tsy:!0,wv:!0,wait:!0,playbgm:!1,playse:!0,wb:!1,wf:!1,ws:!1,wq:!0};#L;#p;setOtherObj(t,s){this.#L=t,this.#p=s}#Z(t){const{name:s}=t;if(!s)throw"nameは必須です";let i="";const n=this.#s.len;for(;this.#t<n&&(i=this.#s.aToken[this.#t],i==="");++this.#t);return t.text=i,t.cast="str",this.hTag.let(t),this.#t+=2,this.#e+=(i.match(/\n/g)??[]).length,!1}#tt(){if(this.#t===0)return console.group(`🥟 [dump_stack] スクリプト現在地 fn:${this.#i} line:1 col:0`),console.groupEnd(),!1;const t=this.#l(this.#s,this.#t),s=`スクリプト現在地 fn:${this.#i} line:${String(t.ln)} col:${String(t.col_s+1)}`;console.group(`🥟 [dump_stack] ${s}`);const i=this.#n.length;if(i>0){console.info(s);for(let n=i-1;n>=0;--n){const h=this.#n[n],o=h.csArg[":hMp"],a=o?o[":タグ名"]:void 0,r=h.csArg[":タグ名"]??"",e=this.#l(this.#a[h.fn],h.idx);console.info(`${String(i-n)}つ前のコール元 fn:${h.fn} line:${String(e.ln)} col:${String(e.col_s+1)}${a?"（["+a+"]マクロ内）":" "}で [${r} ...]をコール`)}}return console.groupEnd(),!1}#l(t,s){const i={ln:1,col_s:0,col_e:0};if(!t)return i;let n=s-1;const h=i.ln=t.aLNum[n];for(;t.aLNum[n]===h;){const o=t.aToken[n];if(!o.startsWith(`
`)){const a=o.length;i.col_e>0&&(i.col_s+=a),i.col_e+=a}if(--n<0)break}return i}#st(t){const{set_fnc:s,break_fnc:i}=t;if(!s)throw"set_fncは必須です";if(this.#_=globalThis[s],!this.#_){if(m(t,"need_err",!0))throw`HTML内に関数${s}が見つかりません`;return this.#_=()=>{},!1}if(this.noticeBreak=n=>{this.#A!==this.#i&&(this.#A=this.#i,this.#_(this.#it[this.#i]??=this.#s.aToken.join(""))),this.#$(this.#e,n)},this.noticeBreak(!0),!i)return!1;if(this.#$=globalThis[i],!this.#$){if(m(t,"need_err",!0))throw`HTML内に関数${i}が見つかりません`;this.#$=()=>{}}return!1}#_=()=>{};#$=()=>{};#A="";#it={};noticeBreak=t=>{};#D=5;dumpErrForeLine(){if(this.#t===0){console.group(`🥟 Error line (from 0 rows before) fn:${this.#i}`),console.groupEnd();return}let t="";for(let o=this.#t-1;o>=0&&(t=String(this.#s.aToken[o])+t,!((t.match(/\n/g)??[]).length>=this.#D));--o);const s=t.split(`
`).slice(-this.#D),i=s.length;console.group(`🥟 Error line (from ${String(i)} rows before) fn:${this.#i}`);const n=String(this.#e).length,h=this.#l(this.#s,this.#t);for(let o=0;o<i;++o){const a=this.#e-i+o+1,r=`${String(a).padStart(n," ")}: %c`,e=s[o],l=e.length>75?e.slice(0,75)+"…":e;o===i-1?console.info(r+l.slice(0,h.col_s)+"%c"+l.slice(h.col_s),"color: black; background-color: skyblue;","color: black; background-color: pink;"):console.info(r+l,"color: black; background-color: skyblue;")}console.groupEnd()}#o=[-1];#et(){const t=this.#o[0];if(!t)throw"this.#aIfStk が異常です";if(t===-1)throw"ifブロック内ではありません";return this.#t=t,this.#o.shift(),!1}#nt(t){const{exp:s}=t;if(!s)throw"expは必須です";if(s.startsWith("&"))throw"属性expは「&」が不要です";let i=0,n=this.prpPrs.parse(s)?this.#t:-1;const h=this.#s.aLNum[this.#t],o=this.#e-((h??0)||0),a=this.#s.len;for(;this.#t<a;++this.#t){const r=this.#s.aLNum[this.#t];this.#s.aLNum[this.#t]=((r??0)||0)+o;const e=this.#s.aToken[this.#t];if(!e)continue;const l=e.charCodeAt(0);if(l===10){this.#e+=e.length;continue}if(l!==91)continue;const[f,c]=$(e);if(!(f in this.hTag))throw`未定義のタグ[${f}]です`;switch(this.#r.parse(c),f){case"if":++i;break;case"elsif":{if(i>0||n>-1)break;const u=this.#r.hPrm.exp?.val;if(!u)throw"expは必須です";if(u.startsWith("&"))throw"属性expは「&」が不要です";this.prpPrs.parse(u)&&(n=this.#t+1)}break;case"else":if(i>0)break;n===-1&&(n=this.#t+1);break;case"endif":if(i>0){--i;break}return n===-1?(++this.#t,this.#s.aLNum[this.#t]+=o):(this.#o.unshift(this.#t+1),this.#t=n,this.#e=this.#s.aLNum[this.#t]),!1}}throw"[endif]がないままスクリプト終端です"}#ht(t){m(t,"count",!1)||this.#V();const{fn:s}=t;return s&&this.#k(s),this.#M({...t},I.popLocalEvts()),m(t,"clear_local_event",!1)&&this.hTag.clear_event({}),this.#f(s,t.label)}#M(t,s){const i={...t,":hEvt1Time":s,":hMp":this.val.cloneMp(),":lenIfStk":this.#o.length};this.#s.aLNum[this.#t]=this.#e,this.#B||(i[":resvToken"]="",this.#x()),this.#n.push(new x(this.#i,this.#t,i)),this.#o.unshift(-1)}#at(t){return m(t,"count",!0)||this.#V(),this.#o[0]=-1,this.#f(t.fn,t.label)}#ot(t){if(m(t,"clear",!1))this.#n=[];else if(!this.#n.pop())throw"スタックが空です";return this.#x(),this.#o=[-1],this.val.setMp(L()),!1}#j(t){const s=this.#n.pop();if(!s)throw"スタックが空です";const i=s.csArg;this.#o=this.#o.slice(-i[":lenIfStk"]);const n=i[":hMp"];n&&this.val.setMp(n);const h=i[":resvToken"];h?this.nextToken=()=>(this.#x(),h):this.#x(),i[":hEvt1Time"]&&I.pushLocalEvts(i[":hEvt1Time"]);const{fn:o,label:a}=t;return o||a?this.#f(o,a):s.fn in this.#a?(this.#R(s),!1):this.#f(s.fn,"",s.idx)}#B="";#x(){this.#B="",this.nextToken=()=>this.#F()}#T="";#f(t="",s="",i=0){if(S.debugLog&&console.log(`📜 %c1:jumpWork%c fn:${t} lbl:${s} idx:${String(i)}`,"color:#3B0;",""),!t&&!s&&this.main.errScript("[jump系] fnまたはlabelは必須です"),s?(s.startsWith("*")||this.main.errScript("[jump系] labelは*で始まります"),this.#T=s,this.#T.startsWith("**")||(this.#t=i)):(this.#T="",this.#t=i),!t)return this.analyzeInit(),!1;if(t.includes("@"))throw"[jump系] fn には文字「@」は禁止です";const n=this.#k(t);if(t===this.#i)return this.analyzeInit(),!1;this.#i=t;const h=this.#a[t];if(h)return this.#s=h,this.analyzeInit(),!1;const o=`jumpWork fn:${t}`;v.beginProc(o);let a="";const r=new A;try{a=this.#k(t+"@"),r.add({name:t+":base",url:n}),r.add({name:t,url:a})}catch{r.add({name:t,url:n})}return r.use((e,l)=>{this.sys.dec(e.extension,e.data).then(f=>{e.data=f,l()}).catch(f=>{this.main.errScript(`[jump系]snロード失敗です fn:${e.name} ${String(f)}`,!1),l()})}).load((e,l)=>{if(v.endProc(o),a){const f=l[t+":base"].data,c=l[t].data,u=f.split(`
`),p=c.split(`
`),T=u.length,P=p.length;for(let b=0;b<P&&b<T;++b)p[b]||=u[b]??"";l[t].data=p.join(`
`),delete l[t+":base"]}this.nextToken=this.#F,this.#e=1,this.#ft(l[t].data),this.hTag.record_place({}),this.analyzeInit()}),!0}analyzeInit(){S.debugLog&&console.log(`📜 %c9:analyzeInit%c fn:${this.#i} lbl:${this.#T} idx:${String(this.#t)}`,"color:#3B0;","");const t=this.#lt(this.#s,!!this.val.getVal("mp:const.sn.macro.name"),this.#e,this.#T,this.#t);this.#t=t.idx,this.#e=t.ln}nextToken=()=>"";#F(){if(this.#z())return"";this.#mt(),this.#s.aLNum[this.#t]||=this.#e;const t=this.#s.aToken[this.#t];return this.#W(t),++this.#t,t}#W=t=>{};#z(){return this.#t<this.#s.len?!1:(this.main.errScript("スクリプト終端です errOverScr"),!0)}#rt=/(\*{2,})([^|]*)/;#ct=/^\[macro\s/;#H=/^\[endmacro[\s\]]/;#lt(t,s,i,n,h){const o=t.aToken.length;let a=i,r=n;if(!r){if(this.#z())return{idx:h,ln:a};if(t.aLNum[h])a=t.aLNum[h];else{a=1;for(let c=0;c<h;++c){t.aLNum[c]||=a;const u=t.aToken[c];u.startsWith(`
`)?a+=u.length:a+=(u.match(/\n/g)??[]).length}t.aLNum[h]=a}return{idx:h,ln:a}}t.aLNum[0]=1;const e=r.match(this.#rt);if(e){r=e[1];let c=h;switch(e[2]){case"before":for(;t.aToken[--c]!==r;)c===0&&k.myTrace(`[jump系 無名ラベルbefore] 
						${String(a)} 行目以前で ${s?"マクロ内に":""} ラベル【 ${r} 】がありません`,"ET"),s&&t.aToken[c].search(this.#ct)>-1&&k.myTrace("[jump系 無名ラベルbefore] マクロ内にラベル【"+r+"】がありません","ET");return{idx:c+1,ln:t.aLNum[c]};case"after":for(;t.aToken[++c]!==r;)c===o&&k.myTrace(`[jump系 無名ラベルafter] ${String(a)} 行目以後でマクロ内にラベル【${r}】がありません`,"ET"),t.aToken[c].search(this.#H)>-1&&k.myTrace(`[jump系 無名ラベルafter] ${String(a)} 行目以後でマクロ内にラベル【 ${r} 】がありません`,"ET");return{idx:c+1,ln:t.aLNum[c]};default:k.myTrace("[jump系] 無名ラベル指定【label="+r+"】が間違っています","ET")}}a=1;const l=new RegExp("^"+r.replaceAll("*","\\*")+"(?=\\s|;|\\[|\\||$)");let f=!1;for(let c=0;c<o;++c){t.aLNum[c]||=a;const u=t.aToken[c];if(f){this.#c.testTagEndLetml(u)?f=!1:a+=(u.match(/\n/g)??[]).length;continue}const p=u.charCodeAt(0);if(p===10){a+=u.length;continue}if(p===42){if(u.search(l)>-1)return{idx:c+1,ln:a};continue}p===91&&(a+=(u.match(/\n/g)??[]).length,this.#c.testTagLetml(u)&&(f=!0))}throw f?"[let_ml]の終端・[endlet_ml]がありません":(k.myTrace(`[jump系] ラベル【${r}】がありません`,"ET"),"Dummy")}#a=Object.create(null);#ft(t){let s="";try{s="ScriptIterator.resolveScript";const i=this.#c.resolveScript(t);s="ScriptIterator.replaceScript_Wildcard",this.#pt(i),this.#a[this.#i]=this.#s=i}catch(i){i instanceof Error?s+=`例外 mes=${i.message}(${i.name})`:s=String(i),this.main.errScript(s,!1)}this.val.touchAreaKidoku(this.#i)}#R(t){this.#i=t.fn,this.#t=t.idx;const s=this.#a[this.#i];s&&(this.#s=s),this.#e=this.#s.aLNum[t.idx]}#ut=/^\[(call|loadplugin)\s/;#gt=/\bfn\s*=\s*[^\s\]]+/;#pt(t){for(let s=t.len-1;s>=0;--s){const i=t.aToken[s];if(!this.#ut.test(i))continue;const[n,h]=$(i);this.#r.parse(h);const o=this.#r.hPrm.fn;if(!o)continue;const{val:a}=o;if(!a.endsWith("*"))continue;t.aToken.splice(s,1,"	","; "+i),t.aLNum.splice(s,1,NaN,NaN);const r=n==="loadplugin"?w.CSS:w.SN,e=this.cfg.matchPath("^"+a.slice(0,-1)+".*",r);for(const l of e){const f=i.replace(this.#gt,"fn="+decodeURIComponent(_(l[r])));t.aToken.splice(s,0,f),t.aLNum.splice(s,0,NaN)}}t.len=t.aToken.length}#mt(){const t=this.val.touchAreaKidoku(this.#i);if(this.#n.length>0){t.record(this.#t);return}this.#m=t.search(this.#t),this.val.setVal_Nochk("tmp","const.sn.isKidoku",this.#m),!this.#m&&t.record(this.#t)}#m=!1;get isKidoku(){return this.#m}#V(){this.val.getAreaKidoku(this.#i)?.erase(this.#t),this.#m=!1}get isNextKidoku(){let t=this.#i,s=this.#t,i=this.#s.len;if(this.#n.length>0){const n=this.#n[0];t=n.fn,s=n.idx;const h=this.#a[t];h&&(i=h.len)}return s===i?!1:this.val.getAreaKidoku(t)?.search(s)??!1}get normalWait(){return this.#m?this.val.tagCh_doWait_Kidoku?this.val.tagCh_msecWait_Kidoku:0:this.val.tagCh_doWait?this.val.tagCh_msecWait:0}#dt(t){return this.#c.bracket2macro(t,this.hTag,this.#s,this.#t),!1}#kt(t){return this.#c.char2macro(t,this.hTag,this.#s,this.#t),!1}#bt=/["'#;\\]　]+/;#vt(t){const{name:s}=t;if(!s)throw"nameは必須です";if(s in this.hTag)throw`[${s}]はタグかすでに定義済みのマクロです`;if(this.#bt.test(s))throw`[${s}]はマクロ名として異常です`;const i=this.#e,n=new x(this.#i,this.#t);for(this.#K+="|"+s,this.#N=new RegExp(`\\[(${this.#K})\\b`),this.hTag[s]=h=>(h.design_unit=t.design_unit,this.#M(h),this.val.setMp({...h,"const.sn.macro":JSON.stringify({name:t.name}),"const.sn.me_call_scriptFn":this.#i}),this.val.setVal_Nochk("mp","const.sn.me_call_scriptFn",this.#i),this.#e=i,this.#R(n),!1);this.#t<this.#s.len;++this.#t){this.#s.aLNum[this.#t]||=this.#e;const h=this.#s.aToken[this.#t];if(h.search(this.#H)>-1)return++this.#t,!1;const o=h.charCodeAt(0);o===10?this.#e+=h.length:o===91&&(this.#e+=(h.match(/\n/g)??[]).length)}throw`マクロ[${s}]定義の終端・[endmacro]がありません`}#K="call";#N=/\[(call)\b/;#Tt(t){if("fn"in t!="label"in t)throw"fnとlabelはセットで指定して下さい";const s=D(t,"place",0),i=this.val.getMark(s);if(!i)throw`place=${String(s)} は存在しません`;return this.loadFromMark(t,i,2)}loadFromMark(t,s,i=0){this.hTag.clear_event({}),this.val.mark2save(s),this.val.setMp(L()),this.#p.recPagebreak();let n=[];i!==1&&(n=this.sndMng.playLoopFromSaveObj(i===2)),m(t,"do_rec",!0)&&(this.#u={hSave:this.val.cloneSave(),hPages:{...s.hPages},aIfStk:[...s.aIfStk]});const h={enabled:!!this.val.getVal("save:const.sn.autowc.enabled"),text:String(this.val.getVal("save:const.sn.autowc.text")),time:Number(this.val.getVal("save:const.sn.autowc.time"))};this.hTag.autowc(h),this.#o=[...this.#u.aIfStk],this.#n=[],N.stopAllTw();const o=Promise.allSettled([...n,...this.#p.playback(this.#u.hPages)]).then(()=>this.#p.cover(!1)),{index:a,fn:r}=t;if(a)return S.debugLog&&console.log(`📜 %cloadFromMark index:${String(a)} move!%c fn:${r??""}`,"color:#3B0;",""),o.then(()=>{this.#f(r,"",a)||this.main.resume()}).catch(c=>console.error("loadFromMark e:%o",c)),!0;this.#p.cover(!0);const e=String(this.val.getVal("save:const.sn.scriptFn")),l=Number(this.val.getVal("save:const.sn.scriptIdx"));delete this.#a[e];const{label:f}=t;return o.then(f?()=>{this.#i=e,this.#t=l,this.hTag.call({fn:r,label:f})||this.main.resume()}:()=>{this.#f(e,"",l)||this.main.resume()}).catch(c=>console.error("loadFromMark e:%o",c)),!0}#St(t){const s=this.val.getMark(0);if(!s)return!1;delete this.#a[_(s.hSave["const.sn.scriptFn"])];const i={};for(const n in this.#a)try{this.#k(n+"@")}catch{i[n]=this.#a[n]}return this.#a=i,t.do_rec=!1,this.loadFromMark(t,s,1)}#u={hSave:M(),hPages:{},aIfStk:[-1]};#q=()=>{const{fn:t,idx:s}=this.nowScrIdx();return this.val.setVal_Nochk("save","const.sn.scriptFn",t),this.val.setVal_Nochk("save","const.sn.scriptIdx",s),this.#u={hSave:this.val.cloneSave(),hPages:this.#p.record(),aIfStk:this.#o.slice(this.#n.length)},!1};nowScrIdx(){if(this.#n.length===0)return{fn:this.#i,idx:this.#t};const t=this.#n[0];return{fn:t.fn,idx:t.idx}}nowMark(){return{...this.#u}}nowScrFnLn(){const{fn:t,idx:s}=this.nowScrIdx(),i=this.#a[t],n=this.#l(i,s);return{fn:t,...n}}#wt(t){if(!("place"in t))throw"placeは必須です";const s=Number(t.place);delete t[":タグ名"],delete t.place,t.text=t.text??"",this.#u.json=t,this.val.setMark(s,this.#u);const i=Number(this.val.getVal("sys:const.sn.save.place"));return s===i&&this.val.setVal_Nochk("sys","const.sn.save.place",i+1),!1}recodeDesign(t){let s="",i=0;const n=this.#n.length;if(t.design_unit&&n>0){const r=this.#n[0];s=r.fn,i=r.idx}else s=this.#i,i=this.#t;t[":path"]=this.#b(s);const h=this.#a[s],o=this.#l(h,i);t[":ln"]=o.ln,t[":col_s"]=o.col_s,t[":col_e"]=o.col_e;const a=i-1;t[":idx_tkn"]=a,t[":token"]=h.aToken[a],this.sys.send2Dbg("_recodeDesign",t)}replace(t,s){this.#s.aToken[t]=s}}const V=Object.freeze(Object.defineProperty({__proto__:null,RPN_COMP_CHIN:E,ScriptIterator:g},Symbol.toStringTag,{value:"Module"}));export{E as R,V as S,d as a};
