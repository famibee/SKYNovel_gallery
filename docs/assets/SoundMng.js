import{I as b,S as h,c as r,B as l,b as v,d as n,a as m}from"./web.js";import"../web.js";class _{constructor(s,t,o,i,a){this.val=o,t.volume=e=>this.#f(e),t.fadebgm=e=>this.#l(e),t.fadeoutbgm=e=>this.#m(e),t.fadeoutse=e=>this.#b(e),t.fadese=e=>this.#t(e),t.playbgm=e=>this.#n(e),t.playse=e=>this.#i(e),t.stop_allse=()=>this.#e(),t.stopbgm=e=>this.#v(e),t.stopse=e=>this.#o(e),t.wb=e=>this.#d(e),t.wf=e=>this.#u(e),t.stopfadese=e=>this.#h(e),t.wl=e=>this.#g(e),t.ws=e=>this.#r(e),t.xchgbuf=e=>this.#p(e),o.setVal_Nochk("save","const.sn.loopPlaying","{}"),o.setVal_Nochk("tmp","const.sn.sound.codecs",JSON.stringify(b.supported)),h.init(s,o,i,a,this.#s),r.disableAutoPause=!0}#s={};#a;setEvtMng(s){this.#a=s,h.setEvtMng(s)}setNoticeChgVolume(s,t){this.val.defValTrg("sys:sn.sound.global_volume",(o,i)=>s(r.volumeAll=Number(i))),this.val.defValTrg("sys:sn.sound.movie_volume",(o,i)=>t(Number(i))),this.val.setVal_Nochk("sys","sn.sound.global_volume",this.val.getVal("sys:sn.sound.global_volume",1)),this.val.setVal_Nochk("sys","sn.sound.movie_volume",this.val.getVal("sys:sn.sound.movie_volume",1))}#f(s){const{buf:t=l}=s,o="const.sn.sound."+t+".volume",i=this.#c(s,1);return Number(this.val.getVal("sys:"+o))===i?!1:(this.val.setVal_Nochk("sys",o,i),this.val.flush(),s.time=0,s.volume=Number(this.val.getVal("save:"+o)),this.#t(s))}#c(s,t){const o=v(s,"volume",t);return o<0?0:o>1?1:o}#m(s){return s.volume=0,this.#l(s)}#b(s){return s.volume=0,this.#t(s)}#l(s){return s.buf=n,this.#t(s)}#t(s){const{buf:t=l}=s;return this.#h(s),this.#s[t]?.fade(s),!1}#n(s){return s.buf=n,s.canskip=!1,m(s,"loop",!0),this.#i(s)}#i(s){const{buf:t=l,fn:o}=s;if(this.#o({buf:t}),!o)throw`fnは必須です buf:${t}`;return m(s,"canskip",!0)&&this.#a.isSkipping?!1:(this.#s[t]=new h(s,t,o)).needLoad}clearCache(){r.removeAll()}#e(){for(const s of Object.keys(this.#s))this.#o({buf:s});return this.#s={},r.stopAll(),!1}#v(s){return s.buf=n,this.#o(s)}#o(s){const{buf:t=l}=s;return this.#s[t]?.stopse(s),!1}#d(s){return s.buf=n,this.#u(s)}#u(s){const{buf:t=l}=s;return this.#s[t]?.wf(s)}#h(s){const{buf:t=l}=s;return this.#s[t]?.stopfadese(s),!1}#g(s){return s.buf=n,this.#r(s)}#r(s){const{buf:t=l}=s;return this.#s[t]?.ws(s)}#p(s){const{buf:t=l,buf2:o=l}=s;if(t===o)return!1;const i=this.#s[t],a=this.#s[o];return i?this.#s[o]=i:delete this.#s[o],a?this.#s[t]=a:delete this.#s[t],h.xchgbuf(s),!1}playLoopFromSaveObj(s){const t=String(this.val.getVal("save:const.sn.loopPlaying","{}"));if(t==="{}")return this.#e(),this.clearCache(),[];const o=JSON.parse(t);if(s)this.#e(),this.clearCache();else for(const[i,a]of Object.entries(this.#s))i in o||a?.stopse({buf:i});return Object.entries(o).map(([i,a])=>new Promise(e=>{const c=this.#s[i];if(!s&&c&&c.fn===a){e();return}const u="save:const.sn.sound."+i+".",f={fn:a,buf:i,join:!1,loop:!0,volume:Number(this.val.getVal(u+"volume")),start_ms:Number(this.val.getVal(u+"start_ms")),end_ms:Number(this.val.getVal(u+"end_ms")),ret_ms:Number(this.val.getVal(u+"ret_ms")),fnc:e};f.buf===n?this.#n(f):this.#i(f)}))}destroy(){this.#e(),this.clearCache()}}export{_ as SoundMng};
