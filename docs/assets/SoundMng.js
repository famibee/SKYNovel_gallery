import{b as S,a as L,S as ut,L as tt,c as O,d as I,T as B,n as at,e as lt}from"./web.js";import{i as ct}from"./CmnTween.js";import{O as ht,a as ft,x as pt,l as dt}from"./ReadState.js";import"../web.js";/*!
 * @pixi/sound - v4.4.1
 * https://github.com/pixijs/pixi-sound
 * Compiled Tue, 15 Aug 2023 19:22:13 UTC
 *
 * @pixi/sound is licensed under the MIT license.
 * http://www.opensource.org/licenses/mit-license
 */var et;function _(){return et}var st=function(n,t){return(st=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,s){e.__proto__=s}||function(e,s){for(var o in s)Object.prototype.hasOwnProperty.call(s,o)&&(e[o]=s[o])})(n,t)};function v(n,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function e(){this.constructor=n}st(n,t),n.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}var T=function(){return(T=Object.assign||function(n){for(var t,e=1,s=arguments.length;e<s;e++)for(var o in t=arguments[e])Object.prototype.hasOwnProperty.call(t,o)&&(n[o]=t[o]);return n}).apply(this,arguments)},nt=["mp3","ogg","oga","opus","mpeg","wav","m4a","aiff","wma","mid","caf"],q={};function _t(n){var t=T({m4a:"audio/mp4",oga:"audio/ogg",opus:'audio/ogg; codecs="opus"',caf:'audio/x-caf; codecs="opus"'},{}),e=document.createElement("audio"),s={},o=/^no$/;nt.forEach(function(i){var r=e.canPlayType("audio/".concat(i)).replace(o,""),u=t[i]?e.canPlayType(t[i]).replace(o,""):"";s[i]=!!r||!!u}),Object.assign(q,s)}_t();var yt=/\.(\{([^\}]+)\})(\?.*)?$/;function ot(n){var t=yt,e=typeof n=="string"?n:n.url;if(!t.test(e))return e;for(var s=t.exec(e),o=s[2].split(","),i=o[o.length-1],r=0,u=o.length;r<u;r++){var a=o[r];if(q[a]){i=a;break}}var l=e.replace(s[1],i);if(typeof n!="string"){var h=n;h.extension=i,h.url=l}return l}var H=nt.filter(function(n){return q[n]}),X=function(){function n(){}return n.add=function(){n.setLegacy(_().useLegacy)},n.setLegacy=function(t){t?H.forEach(function(e){O.setExtensionXhrType(e,O.XHR_RESPONSE_TYPE.DEFAULT),O.setExtensionLoadType(e,O.LOAD_TYPE.AUDIO)}):H.forEach(function(e){O.setExtensionXhrType(e,O.XHR_RESPONSE_TYPE.BUFFER),O.setExtensionLoadType(e,O.LOAD_TYPE.XHR)})},n.pre=function(t,e){ot(t),e()},n.use=function(t,e){t.data&&H.indexOf(t.extension)>-1?t.sound=_().add(t.name,{loaded:e,preload:!0,url:t.url,source:t.data}):e()},n.extension="loader",n}(),mt=0,bt=function(n){function t(e){var s=n.call(this)||this;return s.id=mt++,s.init(e),s}return v(t,n),t.prototype.set=function(e,s){if(this[e]===void 0)throw new Error("Property with name ".concat(e," does not exist."));switch(e){case"speed":this.speed=s;break;case"volume":this.volume=s;break;case"paused":this.paused=s;break;case"loop":this.loop=s;break;case"muted":this.muted=s}return this},Object.defineProperty(t.prototype,"progress",{get:function(){return this._source.currentTime/this._duration},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"paused",{get:function(){return this._paused},set:function(e){this._paused=e,this.refreshPaused()},enumerable:!1,configurable:!0}),t.prototype._onPlay=function(){this._playing=!0},t.prototype._onPause=function(){this._playing=!1},t.prototype.init=function(e){this._playing=!1,this._duration=e.source.duration;var s=this._source=e.source.cloneNode(!1);s.src=e.parent.url,s.onplay=this._onPlay.bind(this),s.onpause=this._onPause.bind(this),e.context.on("refresh",this.refresh,this),e.context.on("refreshPaused",this.refreshPaused,this),this._media=e},t.prototype._internalStop=function(){this._source&&this._playing&&(this._source.onended=null,this._source.pause())},t.prototype.stop=function(){this._internalStop(),this._source&&this.emit("stop")},Object.defineProperty(t.prototype,"speed",{get:function(){return this._speed},set:function(e){this._speed=e,this.refresh()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"volume",{get:function(){return this._volume},set:function(e){this._volume=e,this.refresh()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"loop",{get:function(){return this._loop},set:function(e){this._loop=e,this.refresh()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"muted",{get:function(){return this._muted},set:function(e){this._muted=e,this.refresh()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"filters",{get:function(){return null},set:function(e){},enumerable:!1,configurable:!0}),t.prototype.refresh=function(){var e=this._media.context,s=this._media.parent;this._source.loop=this._loop||s.loop;var o=e.volume*(e.muted?0:1),i=s.volume*(s.muted?0:1),r=this._volume*(this._muted?0:1);this._source.volume=r*o*i,this._source.playbackRate=this._speed*e.speed*s.speed},t.prototype.refreshPaused=function(){var e=this._media.context,s=this._media.parent,o=this._paused||s.paused||e.paused;o!==this._pausedReal&&(this._pausedReal=o,o?(this._internalStop(),this.emit("paused")):(this.emit("resumed"),this.play({start:this._source.currentTime,end:this._end,volume:this._volume,speed:this._speed,loop:this._loop})),this.emit("pause",o))},t.prototype.play=function(e){var s=this,o=e.start,i=e.end,r=e.speed,u=e.loop,a=e.volume,l=e.muted;this._speed=r,this._volume=a,this._loop=!!u,this._muted=l,this.refresh(),this.loop&&i!==null&&(this.loop=!1),this._start=o,this._end=i||this._duration,this._start=Math.max(0,this._start-t.PADDING),this._end=Math.min(this._end+t.PADDING,this._duration),this._source.onloadedmetadata=function(){s._source&&(s._source.currentTime=o,s._source.onloadedmetadata=null,s.emit("progress",o,s._duration),B.shared.add(s._onUpdate,s))},this._source.onended=this._onComplete.bind(this),this._source.play(),this.emit("start")},t.prototype._onUpdate=function(){this.emit("progress",this.progress,this._duration),this._source.currentTime>=this._end&&!this._source.loop&&this._onComplete()},t.prototype._onComplete=function(){B.shared.remove(this._onUpdate,this),this._internalStop(),this.emit("progress",1,this._duration),this.emit("end",this)},t.prototype.destroy=function(){B.shared.remove(this._onUpdate,this),this.removeAllListeners();var e=this._source;e&&(e.onended=null,e.onplay=null,e.onpause=null,this._internalStop()),this._source=null,this._speed=1,this._volume=1,this._loop=!1,this._end=null,this._start=0,this._duration=0,this._playing=!1,this._pausedReal=!1,this._paused=!1,this._muted=!1,this._media&&(this._media.context.off("refresh",this.refresh,this),this._media.context.off("refreshPaused",this.refreshPaused,this),this._media=null)},t.prototype.toString=function(){return"[HTMLAudioInstance id=".concat(this.id,"]")},t.PADDING=.1,t}(I),gt=function(n){function t(){return n!==null&&n.apply(this,arguments)||this}return v(t,n),t.prototype.init=function(e){this.parent=e,this._source=e.options.source||new Audio,e.url&&(this._source.src=e.url)},t.prototype.create=function(){return new bt(this)},Object.defineProperty(t.prototype,"isPlayable",{get:function(){return!!this._source&&this._source.readyState===4},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"duration",{get:function(){return this._source.duration},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"context",{get:function(){return this.parent.context},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"filters",{get:function(){return null},set:function(e){},enumerable:!1,configurable:!0}),t.prototype.destroy=function(){this.removeAllListeners(),this.parent=null,this._source&&(this._source.src="",this._source.load(),this._source=null)},Object.defineProperty(t.prototype,"source",{get:function(){return this._source},enumerable:!1,configurable:!0}),t.prototype.load=function(e){var s=this._source,o=this.parent;if(s.readyState!==4)if(o.url){s.src=o.url;var i=function(){a(),o.isLoaded=!0;var h=o.autoPlayStart();e&&e(null,o,h)},r=function(){a(),e&&e(new Error("Sound loading has been aborted"))},u=function(){a();var h="Failed to load audio element (code: ".concat(s.error.code,")");e&&e(new Error(h))},a=function(){s.removeEventListener("canplaythrough",i),s.removeEventListener("load",i),s.removeEventListener("abort",r),s.removeEventListener("error",u)};s.addEventListener("canplaythrough",i,!1),s.addEventListener("load",i,!1),s.addEventListener("abort",r,!1),s.addEventListener("error",u,!1),s.load()}else e(new Error("sound.url or sound.source must be set"));else{o.isLoaded=!0;var l=o.autoPlayStart();e&&setTimeout(function(){e(null,o,l)},0)}},t}(I),vt=function(){function n(t,e){this.parent=t,Object.assign(this,e),this.duration=this.end-this.start}return n.prototype.play=function(t){return this.parent.play({complete:t,speed:this.speed||this.parent.speed,end:this.end,start:this.start,loop:this.loop})},n.prototype.destroy=function(){this.parent=null},n}(),P=function(){function n(){}return n.setParamValue=function(t,e){if(t.setValueAtTime){var s=_().context;t.setValueAtTime(e,s.audioContext.currentTime)}else t.value=e;return e},n}(),Pt=0,xt=function(n){function t(e){var s=n.call(this)||this;return s.id=Pt++,s._media=null,s._paused=!1,s._muted=!1,s._elapsed=0,s.init(e),s}return v(t,n),t.prototype.set=function(e,s){if(this[e]===void 0)throw new Error("Property with name ".concat(e," does not exist."));switch(e){case"speed":this.speed=s;break;case"volume":this.volume=s;break;case"muted":this.muted=s;break;case"loop":this.loop=s;break;case"paused":this.paused=s}return this},t.prototype.stop=function(){this._source&&(this._internalStop(),this.emit("stop"))},Object.defineProperty(t.prototype,"speed",{get:function(){return this._speed},set:function(e){this._speed=e,this.refresh(),this._update(!0)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"volume",{get:function(){return this._volume},set:function(e){this._volume=e,this.refresh()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"muted",{get:function(){return this._muted},set:function(e){this._muted=e,this.refresh()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"loop",{get:function(){return this._loop},set:function(e){this._loop=e,this.refresh()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"filters",{get:function(){return this._filters},set:function(e){var s;this._filters&&((s=this._filters)===null||s===void 0||s.filter(function(o){return o}).forEach(function(o){return o.disconnect()}),this._filters=null,this._source.connect(this._gain)),this._filters=e?.length?e.slice(0):null,this.refresh()},enumerable:!1,configurable:!0}),t.prototype.refresh=function(){if(this._source){var e=this._media.context,s=this._media.parent;this._source.loop=this._loop||s.loop;var o=e.volume*(e.muted?0:1),i=s.volume*(s.muted?0:1),r=this._volume*(this._muted?0:1);P.setParamValue(this._gain.gain,r*i*o),P.setParamValue(this._source.playbackRate,this._speed*s.speed*e.speed),this.applyFilters()}},t.prototype.applyFilters=function(){var e;if(!((e=this._filters)===null||e===void 0)&&e.length){this._source.disconnect();var s=this._source;this._filters.forEach(function(o){s.connect(o.destination),s=o}),s.connect(this._gain)}},t.prototype.refreshPaused=function(){var e=this._media.context,s=this._media.parent,o=this._paused||s.paused||e.paused;o!==this._pausedReal&&(this._pausedReal=o,o?(this._internalStop(),this.emit("paused")):(this.emit("resumed"),this.play({start:this._elapsed%this._duration,end:this._end,speed:this._speed,loop:this._loop,volume:this._volume})),this.emit("pause",o))},t.prototype.play=function(e){var s=e.start,o=e.end,i=e.speed,r=e.loop,u=e.volume,a=e.muted,l=e.filters;this._paused=!1;var h=this._media.nodes.cloneBufferSource(),x=h.source,y=h.gain;this._source=x,this._gain=y,this._speed=i,this._volume=u,this._loop=!!r,this._muted=a,this._filters=l,this.refresh();var b=this._source.buffer.duration;this._duration=b,this._end=o,this._lastUpdate=this._now(),this._elapsed=s,this._source.onended=this._onComplete.bind(this),this._loop?(this._source.loopEnd=o,this._source.loopStart=s,this._source.start(0,s)):o?this._source.start(0,s,o-s):this._source.start(0,s),this.emit("start"),this._update(!0),this.enableTicker(!0)},t.prototype.enableTicker=function(e){B.shared.remove(this._updateListener,this),e&&B.shared.add(this._updateListener,this)},Object.defineProperty(t.prototype,"progress",{get:function(){return this._progress},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"paused",{get:function(){return this._paused},set:function(e){this._paused=e,this.refreshPaused()},enumerable:!1,configurable:!0}),t.prototype.destroy=function(){var e;this.removeAllListeners(),this._internalStop(),this._gain&&(this._gain.disconnect(),this._gain=null),this._media&&(this._media.context.events.off("refresh",this.refresh,this),this._media.context.events.off("refreshPaused",this.refreshPaused,this),this._media=null),(e=this._filters)===null||e===void 0||e.forEach(function(s){return s.disconnect()}),this._filters=null,this._end=null,this._speed=1,this._volume=1,this._loop=!1,this._elapsed=0,this._duration=0,this._paused=!1,this._muted=!1,this._pausedReal=!1},t.prototype.toString=function(){return"[WebAudioInstance id=".concat(this.id,"]")},t.prototype._now=function(){return this._media.context.audioContext.currentTime},t.prototype._updateListener=function(){this._update()},t.prototype._update=function(e){if(e===void 0&&(e=!1),this._source){var s=this._now(),o=s-this._lastUpdate;if(o>0||e){var i=this._source.playbackRate.value;this._elapsed+=o*i,this._lastUpdate=s;var r=this._duration,u=void 0;if(this._source.loopStart){var a=this._source.loopEnd-this._source.loopStart;u=(this._source.loopStart+this._elapsed%a)/r}else u=this._elapsed%r/r;this._progress=u,this.emit("progress",this._progress,r)}}},t.prototype.init=function(e){this._media=e,e.context.events.on("refresh",this.refresh,this),e.context.events.on("refreshPaused",this.refreshPaused,this)},t.prototype._internalStop=function(){if(this._source){this.enableTicker(!1),this._source.onended=null,this._source.stop(0),this._source.disconnect();try{this._source.buffer=null}catch{}this._source=null}},t.prototype._onComplete=function(){if(this._source){this.enableTicker(!1),this._source.onended=null,this._source.disconnect();try{this._source.buffer=null}catch{}}this._source=null,this._progress=1,this.emit("progress",1,this._duration),this.emit("end",this)},t}(I),it=function(){function n(t,e){this._output=e,this._input=t}return Object.defineProperty(n.prototype,"destination",{get:function(){return this._input},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"filters",{get:function(){return this._filters},set:function(t){var e=this;if(this._filters&&(this._filters.forEach(function(o){o&&o.disconnect()}),this._filters=null,this._input.connect(this._output)),t&&t.length){this._filters=t.slice(0),this._input.disconnect();var s=null;t.forEach(function(o){s===null?e._input.connect(o.destination):s.connect(o.destination),s=o}),s.connect(this._output)}},enumerable:!1,configurable:!0}),n.prototype.destroy=function(){this.filters=null,this._input=null,this._output=null},n}(),wt=function(n){function t(e){var s=this,o=e.audioContext,i=o.createBufferSource(),r=o.createGain(),u=o.createAnalyser();return i.connect(u),u.connect(r),r.connect(e.destination),(s=n.call(this,u,r)||this).context=e,s.bufferSource=i,s.gain=r,s.analyser=u,s}return v(t,n),Object.defineProperty(t.prototype,"script",{get:function(){return this._script||(this._script=this.context.audioContext.createScriptProcessor(t.BUFFER_SIZE),this._script.connect(this.context.destination)),this._script},enumerable:!1,configurable:!0}),t.prototype.destroy=function(){n.prototype.destroy.call(this),this.bufferSource.disconnect(),this._script&&this._script.disconnect(),this.gain.disconnect(),this.analyser.disconnect(),this.bufferSource=null,this._script=null,this.gain=null,this.analyser=null,this.context=null},t.prototype.cloneBufferSource=function(){var e=this.bufferSource,s=this.context.audioContext.createBufferSource();s.buffer=e.buffer,P.setParamValue(s.playbackRate,e.playbackRate.value),s.loop=e.loop;var o=this.context.audioContext.createGain();return s.connect(o),o.connect(this.destination),{source:s,gain:o}},Object.defineProperty(t.prototype,"bufferSize",{get:function(){return this.script.bufferSize},enumerable:!1,configurable:!0}),t.BUFFER_SIZE=0,t}(it),Ot=function(){function n(){}return n.prototype.init=function(t){this.parent=t,this._nodes=new wt(this.context),this._source=this._nodes.bufferSource,this.source=t.options.source},n.prototype.destroy=function(){this.parent=null,this._nodes.destroy(),this._nodes=null;try{this._source.buffer=null}catch{}this._source=null,this.source=null},n.prototype.create=function(){return new xt(this)},Object.defineProperty(n.prototype,"context",{get:function(){return this.parent.context},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"isPlayable",{get:function(){return!!this._source&&!!this._source.buffer},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"filters",{get:function(){return this._nodes.filters},set:function(t){this._nodes.filters=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"duration",{get:function(){return this._source.buffer.duration},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"buffer",{get:function(){return this._source.buffer},set:function(t){this._source.buffer=t},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"nodes",{get:function(){return this._nodes},enumerable:!1,configurable:!0}),n.prototype.load=function(t){this.source?this._decode(this.source,t):this.parent.url?this._loadUrl(t):t&&t(new Error("sound.url or sound.source must be set"))},n.prototype._loadUrl=function(t){var e=this,s=new XMLHttpRequest,o=this.parent.url;s.open("GET",o,!0),s.responseType="arraybuffer",s.onload=function(){e.source=s.response,e._decode(s.response,t)},s.send()},n.prototype._decode=function(t,e){var s=this,o=function(i,r){if(i)e&&e(i);else{s.parent.isLoaded=!0,s.buffer=r;var u=s.parent.autoPlayStart();e&&e(null,s.parent,u)}};t instanceof AudioBuffer?o(null,t):this.parent.context.decode(t,o)},n}(),G=function(){function n(t,e){this.media=t,this.options=e,this._instances=[],this._sprites={},this.media.init(this);var s=e.complete;this._autoPlayOptions=s?{complete:s}:null,this.isLoaded=!1,this.isPlaying=!1,this.autoPlay=e.autoPlay,this.singleInstance=e.singleInstance,this.preload=e.preload||this.autoPlay,this.url=e.url,this.speed=e.speed,this.volume=e.volume,this.loop=e.loop,e.sprites&&this.addSprites(e.sprites),this.preload&&this._preload(e.loaded)}return n.from=function(t){var e={};return typeof t=="string"?e.url=t:t instanceof ArrayBuffer||t instanceof AudioBuffer||t instanceof HTMLAudioElement?e.source=t:e=t,(e=T({autoPlay:!1,singleInstance:!1,url:null,source:null,preload:!1,volume:1,speed:1,complete:null,loaded:null,loop:!1},e)).url&&(e.url=ot(e.url)),Object.freeze(e),new n(_().useLegacy?new gt:new Ot,e)},Object.defineProperty(n.prototype,"context",{get:function(){return _().context},enumerable:!1,configurable:!0}),n.prototype.pause=function(){return this.isPlaying=!1,this.paused=!0,this},n.prototype.resume=function(){return this.isPlaying=this._instances.length>0,this.paused=!1,this},Object.defineProperty(n.prototype,"paused",{get:function(){return this._paused},set:function(t){this._paused=t,this.refreshPaused()},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"speed",{get:function(){return this._speed},set:function(t){this._speed=t,this.refresh()},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"filters",{get:function(){return this.media.filters},set:function(t){this.media.filters=t},enumerable:!1,configurable:!0}),n.prototype.addSprites=function(t,e){if(typeof t=="object"){var s={};for(var o in t)s[o]=this.addSprites(o,t[o]);return s}var i=new vt(this,e);return this._sprites[t]=i,i},n.prototype.destroy=function(){this._removeInstances(),this.removeSprites(),this.media.destroy(),this.media=null,this._sprites=null,this._instances=null},n.prototype.removeSprites=function(t){if(t){var e=this._sprites[t];e!==void 0&&(e.destroy(),delete this._sprites[t])}else for(var s in this._sprites)this.removeSprites(s);return this},Object.defineProperty(n.prototype,"isPlayable",{get:function(){return this.isLoaded&&this.media&&this.media.isPlayable},enumerable:!1,configurable:!0}),n.prototype.stop=function(){if(!this.isPlayable)return this.autoPlay=!1,this._autoPlayOptions=null,this;this.isPlaying=!1;for(var t=this._instances.length-1;t>=0;t--)this._instances[t].stop();return this},n.prototype.play=function(t,e){var s,o=this;if(typeof t=="string"?s={sprite:r=t,loop:this.loop,complete:e}:typeof t=="function"?(s={}).complete=t:s=t,(s=T({complete:null,loaded:null,sprite:null,end:null,start:0,volume:1,speed:1,muted:!1,loop:!1},s||{})).sprite){var i=s.sprite,r=this._sprites[i];s.start=r.start+(s.start||0),s.end=r.end,s.speed=r.speed||1,s.loop=r.loop||s.loop,delete s.sprite}if(s.offset&&(s.start=s.offset),!this.isLoaded)return new Promise(function(a,l){o.autoPlay=!0,o._autoPlayOptions=s,o._preload(function(h,x,y){h?l(h):(s.loaded&&s.loaded(h,x,y),a(y))})});(this.singleInstance||s.singleInstance)&&this._removeInstances();var u=this._createInstance();return this._instances.push(u),this.isPlaying=!0,u.once("end",function(){s.complete&&s.complete(o),o._onComplete(u)}),u.once("stop",function(){o._onComplete(u)}),u.play(s),u},n.prototype.refresh=function(){for(var t=this._instances.length,e=0;e<t;e++)this._instances[e].refresh()},n.prototype.refreshPaused=function(){for(var t=this._instances.length,e=0;e<t;e++)this._instances[e].refreshPaused()},Object.defineProperty(n.prototype,"volume",{get:function(){return this._volume},set:function(t){this._volume=t,this.refresh()},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"muted",{get:function(){return this._muted},set:function(t){this._muted=t,this.refresh()},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"loop",{get:function(){return this._loop},set:function(t){this._loop=t,this.refresh()},enumerable:!1,configurable:!0}),n.prototype._preload=function(t){this.media.load(t)},Object.defineProperty(n.prototype,"instances",{get:function(){return this._instances},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"sprites",{get:function(){return this._sprites},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"duration",{get:function(){return this.media.duration},enumerable:!1,configurable:!0}),n.prototype.autoPlayStart=function(){var t;return this.autoPlay&&(t=this.play(this._autoPlayOptions)),t},n.prototype._removeInstances=function(){for(var t=this._instances.length-1;t>=0;t--)this._poolInstance(this._instances[t]);this._instances.length=0},n.prototype._onComplete=function(t){if(this._instances){var e=this._instances.indexOf(t);e>-1&&this._instances.splice(e,1),this.isPlaying=this._instances.length>0}this._poolInstance(t)},n.prototype._createInstance=function(){if(n._pool.length>0){var t=n._pool.pop();return t.init(this.media),t}return this.media.create()},n.prototype._poolInstance=function(t){t.destroy(),n._pool.indexOf(t)<0&&n._pool.push(t)},n._pool=[],n}(),St=function(n){function t(){var e=n!==null&&n.apply(this,arguments)||this;return e.speed=1,e.muted=!1,e.volume=1,e.paused=!1,e}return v(t,n),t.prototype.refresh=function(){this.emit("refresh")},t.prototype.refreshPaused=function(){this.emit("refreshPaused")},Object.defineProperty(t.prototype,"filters",{get:function(){return null},set:function(e){},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"audioContext",{get:function(){return null},enumerable:!1,configurable:!0}),t.prototype.toggleMute=function(){return this.muted=!this.muted,this.refresh(),this.muted},t.prototype.togglePause=function(){return this.paused=!this.paused,this.refreshPaused(),this.paused},t.prototype.destroy=function(){this.removeAllListeners()},t}(I),z=function(n){function t(){var e=n.call(this,null,null)||this;e.autoPause=!0;var s=window,o=new t.AudioContext,i=o.createDynamicsCompressor(),r=o.createAnalyser();return r.connect(i),i.connect(o.destination),e._input=r,e._output=o.destination,e._ctx=o,e._offlineCtx=new t.OfflineAudioContext(1,2,s.OfflineAudioContext?Math.max(8e3,Math.min(96e3,o.sampleRate)):44100),e.compressor=i,e.analyser=r,e.events=new I,e.volume=1,e.speed=1,e.muted=!1,e.paused=!1,e._locked=o.state==="suspended"&&("ontouchstart"in globalThis||"onclick"in globalThis),e._locked&&(e._unlock(),e._unlock=e._unlock.bind(e),document.addEventListener("mousedown",e._unlock,!0),document.addEventListener("touchstart",e._unlock,!0),document.addEventListener("touchend",e._unlock,!0)),e.onFocus=e.onFocus.bind(e),e.onBlur=e.onBlur.bind(e),globalThis.addEventListener("focus",e.onFocus),globalThis.addEventListener("blur",e.onBlur),e}return v(t,n),t.prototype.onFocus=function(){if(this.autoPause){var e=this._ctx.state;e!=="suspended"&&e!=="interrupted"&&this._locked||(this.paused=this._pausedOnBlur,this.refreshPaused())}},t.prototype.onBlur=function(){this.autoPause&&(this._locked||(this._pausedOnBlur=this._paused,this.paused=!0,this.refreshPaused()))},t.prototype._unlock=function(){this._locked&&(this.playEmptySound(),this._ctx.state==="running"&&(document.removeEventListener("mousedown",this._unlock,!0),document.removeEventListener("touchend",this._unlock,!0),document.removeEventListener("touchstart",this._unlock,!0),this._locked=!1))},t.prototype.playEmptySound=function(){var e=this._ctx.createBufferSource();e.buffer=this._ctx.createBuffer(1,1,22050),e.connect(this._ctx.destination),e.start(0,0,0),e.context.state==="suspended"&&e.context.resume()},Object.defineProperty(t,"AudioContext",{get:function(){var e=window;return e.AudioContext||e.webkitAudioContext||null},enumerable:!1,configurable:!0}),Object.defineProperty(t,"OfflineAudioContext",{get:function(){var e=window;return e.OfflineAudioContext||e.webkitOfflineAudioContext||null},enumerable:!1,configurable:!0}),t.prototype.destroy=function(){n.prototype.destroy.call(this);var e=this._ctx;e.close!==void 0&&e.close(),globalThis.removeEventListener("focus",this.onFocus),globalThis.removeEventListener("blur",this.onBlur),this.events.removeAllListeners(),this.analyser.disconnect(),this.compressor.disconnect(),this.analyser=null,this.compressor=null,this.events=null,this._offlineCtx=null,this._ctx=null},Object.defineProperty(t.prototype,"audioContext",{get:function(){return this._ctx},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"offlineContext",{get:function(){return this._offlineCtx},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"paused",{get:function(){return this._paused},set:function(e){e&&this._ctx.state==="running"?this._ctx.suspend():e||this._ctx.state!=="suspended"||this._ctx.resume(),this._paused=e},enumerable:!1,configurable:!0}),t.prototype.refresh=function(){this.events.emit("refresh")},t.prototype.refreshPaused=function(){this.events.emit("refreshPaused")},t.prototype.toggleMute=function(){return this.muted=!this.muted,this.refresh(),this.muted},t.prototype.togglePause=function(){return this.paused=!this.paused,this.refreshPaused(),this._paused},t.prototype.decode=function(e,s){var o=function(r){s(new Error(r?.message||"Unable to decode file"))},i=this._offlineCtx.decodeAudioData(e,function(r){s(null,r)},o);i&&i.catch(o)},t}(it),Et=function(){function n(){this.init()}return n.prototype.init=function(){return this.supported&&(this._webAudioContext=new z),this._htmlAudioContext=new St,this._sounds={},this.useLegacy=!this.supported,this},Object.defineProperty(n.prototype,"context",{get:function(){return this._context},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"filtersAll",{get:function(){return this.useLegacy?[]:this._context.filters},set:function(t){this.useLegacy||(this._context.filters=t)},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"supported",{get:function(){return z.AudioContext!==null},enumerable:!1,configurable:!0}),n.prototype.add=function(t,e){if(typeof t=="object"){var s={};for(var o in t){var i=this._getOptions(t[o],e);s[o]=this.add(o,i)}return s}if(e instanceof G)return this._sounds[t]=e,e;var r=this._getOptions(e),u=G.from(r);return this._sounds[t]=u,u},n.prototype._getOptions=function(t,e){var s;return s=typeof t=="string"?{url:t}:t instanceof ArrayBuffer||t instanceof AudioBuffer||t instanceof HTMLAudioElement?{source:t}:t,s=T(T({},s),e||{})},Object.defineProperty(n.prototype,"useLegacy",{get:function(){return this._useLegacy},set:function(t){X.setLegacy(t),this._useLegacy=t,this._context=!t&&this.supported?this._webAudioContext:this._htmlAudioContext},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"disableAutoPause",{get:function(){return!this._webAudioContext.autoPause},set:function(t){this._webAudioContext.autoPause=!t},enumerable:!1,configurable:!0}),n.prototype.remove=function(t){return this.exists(t,!0),this._sounds[t].destroy(),delete this._sounds[t],this},Object.defineProperty(n.prototype,"volumeAll",{get:function(){return this._context.volume},set:function(t){this._context.volume=t,this._context.refresh()},enumerable:!1,configurable:!0}),Object.defineProperty(n.prototype,"speedAll",{get:function(){return this._context.speed},set:function(t){this._context.speed=t,this._context.refresh()},enumerable:!1,configurable:!0}),n.prototype.togglePauseAll=function(){return this._context.togglePause()},n.prototype.pauseAll=function(){return this._context.paused=!0,this._context.refreshPaused(),this},n.prototype.resumeAll=function(){return this._context.paused=!1,this._context.refreshPaused(),this},n.prototype.toggleMuteAll=function(){return this._context.toggleMute()},n.prototype.muteAll=function(){return this._context.muted=!0,this._context.refresh(),this},n.prototype.unmuteAll=function(){return this._context.muted=!1,this._context.refresh(),this},n.prototype.removeAll=function(){for(var t in this._sounds)this._sounds[t].destroy(),delete this._sounds[t];return this},n.prototype.stopAll=function(){for(var t in this._sounds)this._sounds[t].stop();return this},n.prototype.exists=function(t,e){return!!this._sounds[t]},n.prototype.find=function(t){return this.exists(t,!0),this._sounds[t]},n.prototype.play=function(t,e){return this.find(t).play(e)},n.prototype.stop=function(t){return this.find(t).stop()},n.prototype.pause=function(t){return this.find(t).pause()},n.prototype.resume=function(t){return this.find(t).resume()},n.prototype.volume=function(t,e){var s=this.find(t);return e!==void 0&&(s.volume=e),s.volume},n.prototype.speed=function(t,e){var s=this.find(t);return e!==void 0&&(s.speed=e),s.speed},n.prototype.duration=function(t){return this.find(t).duration},n.prototype.close=function(){return this.removeAll(),this._sounds=null,this._webAudioContext&&(this._webAudioContext.destroy(),this._webAudioContext=null),this._htmlAudioContext&&(this._htmlAudioContext.destroy(),this._htmlAudioContext=null),this._context=null,this},n}(),F=function(){function n(t,e){this.init(t,e)}return n.prototype.init=function(t,e){this.destination=t,this.source=e||t},n.prototype.connect=function(t){this.source.connect(t)},n.prototype.disconnect=function(){this.source.disconnect()},n.prototype.destroy=function(){this.disconnect(),this.destination=null,this.source=null},n}(),U={__proto__:null,EqualizerFilter:function(n){function t(e,s,o,i,r,u,a,l,h,x){e===void 0&&(e=0),s===void 0&&(s=0),o===void 0&&(o=0),i===void 0&&(i=0),r===void 0&&(r=0),u===void 0&&(u=0),a===void 0&&(a=0),l===void 0&&(l=0),h===void 0&&(h=0),x===void 0&&(x=0);var y=this;if(!_().useLegacy){var b=[{f:t.F32,type:"lowshelf",gain:e},{f:t.F64,type:"peaking",gain:s},{f:t.F125,type:"peaking",gain:o},{f:t.F250,type:"peaking",gain:i},{f:t.F500,type:"peaking",gain:r},{f:t.F1K,type:"peaking",gain:u},{f:t.F2K,type:"peaking",gain:a},{f:t.F4K,type:"peaking",gain:l},{f:t.F8K,type:"peaking",gain:h},{f:t.F16K,type:"highshelf",gain:x}].map(function(f){var m=_().context.audioContext.createBiquadFilter();return m.type=f.type,P.setParamValue(m.Q,1),m.frequency.value=f.f,P.setParamValue(m.gain,f.gain),m});(y=n.call(this,b[0],b[b.length-1])||this).bands=b,y.bandsMap={};for(var d=0;d<y.bands.length;d++){var w=y.bands[d];d>0&&y.bands[d-1].connect(w),y.bandsMap[w.frequency.value]=w}return y}y=n.call(this,null)||this}return v(t,n),t.prototype.setGain=function(e,s){if(s===void 0&&(s=0),!this.bandsMap[e])throw new Error("No band found for frequency ".concat(e));P.setParamValue(this.bandsMap[e].gain,s)},t.prototype.getGain=function(e){if(!this.bandsMap[e])throw new Error("No band found for frequency ".concat(e));return this.bandsMap[e].gain.value},Object.defineProperty(t.prototype,"f32",{get:function(){return this.getGain(t.F32)},set:function(e){this.setGain(t.F32,e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"f64",{get:function(){return this.getGain(t.F64)},set:function(e){this.setGain(t.F64,e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"f125",{get:function(){return this.getGain(t.F125)},set:function(e){this.setGain(t.F125,e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"f250",{get:function(){return this.getGain(t.F250)},set:function(e){this.setGain(t.F250,e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"f500",{get:function(){return this.getGain(t.F500)},set:function(e){this.setGain(t.F500,e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"f1k",{get:function(){return this.getGain(t.F1K)},set:function(e){this.setGain(t.F1K,e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"f2k",{get:function(){return this.getGain(t.F2K)},set:function(e){this.setGain(t.F2K,e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"f4k",{get:function(){return this.getGain(t.F4K)},set:function(e){this.setGain(t.F4K,e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"f8k",{get:function(){return this.getGain(t.F8K)},set:function(e){this.setGain(t.F8K,e)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"f16k",{get:function(){return this.getGain(t.F16K)},set:function(e){this.setGain(t.F16K,e)},enumerable:!1,configurable:!0}),t.prototype.reset=function(){this.bands.forEach(function(e){P.setParamValue(e.gain,0)})},t.prototype.destroy=function(){this.bands.forEach(function(e){e.disconnect()}),this.bands=null,this.bandsMap=null},t.F32=32,t.F64=64,t.F125=125,t.F250=250,t.F500=500,t.F1K=1e3,t.F2K=2e3,t.F4K=4e3,t.F8K=8e3,t.F16K=16e3,t}(F),DistortionFilter:function(n){function t(e){e===void 0&&(e=0);var s=this;if(!_().useLegacy){var o=_().context.audioContext.createWaveShaper();return(s=n.call(this,o)||this)._distortion=o,s.amount=e,s}s=n.call(this,null)||this}return v(t,n),Object.defineProperty(t.prototype,"amount",{get:function(){return this._amount},set:function(e){this._amount=e;for(var s,o=1e3*e,i=44100,r=new Float32Array(i),u=Math.PI/180,a=0;a<i;++a)s=2*a/i-1,r[a]=(3+o)*s*20*u/(Math.PI+o*Math.abs(s));this._distortion.curve=r,this._distortion.oversample="4x"},enumerable:!1,configurable:!0}),t.prototype.destroy=function(){this._distortion=null,n.prototype.destroy.call(this)},t}(F),StereoFilter:function(n){function t(e){e===void 0&&(e=0);var s=this;if(!_().useLegacy){var o,i,r,u=_().context.audioContext;return u.createStereoPanner?r=o=u.createStereoPanner():((i=u.createPanner()).panningModel="equalpower",r=i),(s=n.call(this,r)||this)._stereo=o,s._panner=i,s.pan=e,s}s=n.call(this,null)||this}return v(t,n),Object.defineProperty(t.prototype,"pan",{get:function(){return this._pan},set:function(e){this._pan=e,this._stereo?P.setParamValue(this._stereo.pan,e):this._panner.setPosition(e,0,1-Math.abs(e))},enumerable:!1,configurable:!0}),t.prototype.destroy=function(){n.prototype.destroy.call(this),this._stereo=null,this._panner=null},t}(F),ReverbFilter:function(n){function t(e,s,o){e===void 0&&(e=3),s===void 0&&(s=2),o===void 0&&(o=!1);var i=this;if(!_().useLegacy)return(i=n.call(this,null)||this)._seconds=i._clamp(e,1,50),i._decay=i._clamp(s,0,100),i._reverse=o,i._rebuild(),i;i=n.call(this,null)||this}return v(t,n),t.prototype._clamp=function(e,s,o){return Math.min(o,Math.max(s,e))},Object.defineProperty(t.prototype,"seconds",{get:function(){return this._seconds},set:function(e){this._seconds=this._clamp(e,1,50),this._rebuild()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"decay",{get:function(){return this._decay},set:function(e){this._decay=this._clamp(e,0,100),this._rebuild()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"reverse",{get:function(){return this._reverse},set:function(e){this._reverse=e,this._rebuild()},enumerable:!1,configurable:!0}),t.prototype._rebuild=function(){for(var e,s=_().context.audioContext,o=s.sampleRate,i=o*this._seconds,r=s.createBuffer(2,i,o),u=r.getChannelData(0),a=r.getChannelData(1),l=0;l<i;l++)e=this._reverse?i-l:l,u[l]=(2*Math.random()-1)*Math.pow(1-e/i,this._decay),a[l]=(2*Math.random()-1)*Math.pow(1-e/i,this._decay);var h=_().context.audioContext.createConvolver();h.buffer=r,this.init(h)},t}(F),MonoFilter:function(n){function t(){var e=this;if(!_().useLegacy){var s=_().context.audioContext,o=s.createChannelSplitter(),i=s.createChannelMerger();return i.connect(o),(e=n.call(this,i,o)||this)._merger=i,e}e=n.call(this,null)||this}return v(t,n),t.prototype.destroy=function(){this._merger.disconnect(),this._merger=null,n.prototype.destroy.call(this)},t}(F),StreamFilter:function(n){function t(){var e=this;if(!_().useLegacy){var s=_().context.audioContext,o=s.createMediaStreamDestination(),i=s.createMediaStreamSource(o.stream);return(e=n.call(this,o,i)||this)._stream=o.stream,e}e=n.call(this,null)||this}return v(t,n),Object.defineProperty(t.prototype,"stream",{get:function(){return this._stream},enumerable:!1,configurable:!0}),t.prototype.destroy=function(){this._stream=null,n.prototype.destroy.call(this)},t}(F),TelephoneFilter:function(n){function t(){if(!_().useLegacy){var e=_().context.audioContext,s=e.createBiquadFilter(),o=e.createBiquadFilter(),i=e.createBiquadFilter(),r=e.createBiquadFilter();return s.type="lowpass",P.setParamValue(s.frequency,2e3),o.type="lowpass",P.setParamValue(o.frequency,2e3),i.type="highpass",P.setParamValue(i.frequency,500),r.type="highpass",P.setParamValue(r.frequency,500),s.connect(o),o.connect(i),i.connect(r),n.call(this,s,r)||this}n.call(this,null)}return v(t,n),t}(F)},kt={__proto__:null,supported:q},N=function(n){return et=n,n}(new Et);"extensions"in at?lt.add(X):tt.registerPlugin(X);class j{constructor(t,e,s,o,i,r,u,a){this.fn=t,this.buf=e,this.start_ms=s,this.end_ms=o,this.ret_ms=i,this.volume=r,this.pan=u,this.stt=a?new D:new jt,a&&this.addSnd(a)}static#t=1;stt;loop=!1;addSnd(t){switch(this.loop=t.loop,this.stt.onLoad(this),this.pan!==0&&(t.filters=[new U.StereoFilter(this.pan)]),this.setVol=e=>t.volume=e,this.tw=()=>new pt(t),this.onPlayEnd=()=>{this.stt.onPlayEnd(this.buf),this.#s()},this.stop=()=>{t.stop(),this.#s()},this.destroy=()=>t.destroy(),this.buf){case Q:const e=Number(c.getVal("sys:sn.sound.BGM.vol_mul_talking")??1);if(e===1)break;j.#t=e;const s=J[E];s&&s.setVol(this.volume*j.#t);break;case E:t.volume=this.volume*j.#t;break}}#s=()=>{if(this.#s=()=>{},j.#t===1||this.buf!==Q)return;j.#t=1;const t=J[E];t&&t.setVol(this.volume*j.#t)};setVol(t){}tw(){}onPlayEnd(){}stop(){}destroy(){}}let W,c,k,Z,J,M;const E="BGM",g="SE",Q="VOICE";class p{constructor(t,e,s){this.hArg=t,this.buf=e,this.fn=s;const o=S(t,"start_ms",0),i=S(t,"end_ms",p.#s),r=S(t,"ret_ms",0),u=S(t,"pan",0),a=S(t,"speed",1);if(o<0)throw`[playse] start_ms:${o} が負の値です`;if(r<0)throw`[playse] ret_ms:${r} が負の値です`;if(0<i){if(i<=o)throw`[playse] start_ms:${o} >= end_ms:${i} は異常値です`;if(i<=r)throw`[playse] ret_ms:${r} >= end_ms:${i} は異常値です`}const l="const.sn.sound."+e+".";c.setVal_Nochk("save",l+"fn",s);const h=p.getVol(t,1);c.setVal_Nochk("save",l+"volume",h);const x=h*Number(c.getVal("sys:"+l+"volume",1)),y=L(t,"loop",!1);y?(p.#t[e]=s,c.setVal_Nochk("save","const.sn.loopPlaying",JSON.stringify(p.#t))):p.delLoopPlay(e),c.setVal_Nochk("save",l+"start_ms",o),c.setVal_Nochk("save",l+"end_ms",i),c.setVal_Nochk("save",l+"ret_ms",r),c.setVal_Nochk("tmp",l+"playing",!0),c.flush();const b=N.find(s);this.#e=new j(s,e,o,i,r,x,u,b);const d={loop:y,speed:a,volume:x,loaded:(f,m)=>{if(!this.#e.stt.isDestroy){if(f){k.errScript(`ロード失敗です SndBuf fn:${s} ${f}`,!1);return}m&&(this.#e.addSnd(m),u!==0&&(m.filters=[new U.StereoFilter(u)]),t.fnc?.())}}};let w="";if(0<o||i<p.#s){w=`${s};${o};${i};${r}`;const f=(d.sprites??={})[w]={start:o/1e3,end:i/1e3};d.preload=!0;const m=d.loaded;d.loaded=(C,V)=>{if(this.#e.stt.isDestroy)return;m(C,V);const K=V,$=K.duration;f.end<0&&(f.end+=$,K.removeSprites(w),K.addSprites(w,f)),f.end<=f.start&&k.errScript(`[playse] end_ms:${i}(${f.end*1e3}) >= start_ms:${o} は異常値です`),f.end*1e3<=r&&k.errScript(`[playse] end_ms:${i}(${f.end*1e3}) <= ret_ms:${r} は異常値です`),$<=f.start&&k.errScript(`[playse] 音声ファイル再生時間:${$*1e3} <= start_ms:${o} は異常値です`),i!==p.#s&&$<=f.end&&k.errScript(`[playse] 音声ファイル再生時間:${$*1e3} <= end_ms:${i} は異常値です`),K.play(w,rt=>d.complete?.(rt))}}else d.autoPlay=!0;if(y?r!==0&&(d.loop=!1,d.complete=async f=>{const m=f.duration,C=r/1e3,V=i/1e3;m<=C&&k.errScript(`[playse] 音声ファイル再生時間:${m*1e3} <=  ret_ms:${r} は異常値です`),await f.play({...d,start:C,end:V<0?V+m:V,loop:!0,filters:u!==0?[new U.StereoFilter(u)]:[]})}):d.complete=()=>{Y(this.#e,e),this.#e.onPlayEnd()},this.#n(),b){if(b.volume=x,w)this.#o(s,d);else if(b.isPlayable){const f=b.options.source;!(f instanceof ArrayBuffer)||f.byteLength===0?b.play(d):this.#e.addSnd(G.from({...d,url:b.options.url,source:f})),u!==0&&(b.filters=[new U.StereoFilter(u)])}this.needLoad=!1;return}if(this.needLoad=L(t,"join",!0)){ht();const f=d.loaded;d.loaded=(m,C)=>{this.#e.stt.isDestroy||f(m,C),ft()}}this.#o(s,d)}static#t={};static init(t,e,s,o,i){p.#t={},W=t,c=e,k=s,Z=o,J=i}static setEvtMng(t){M=t}static delLoopPlay(t){delete p.#t[t];const e="const.sn.sound."+t+".";c.setVal_Nochk("save",e+"fn",""),c.setVal_Nochk("save","const.sn.loopPlaying",JSON.stringify(p.#t)),c.flush()}static getVol(t,e){const s=S(t,"volume",e);return s<0?0:s>1?1:s}static xchgbuf({buf:t=g,buf2:e=g}){if(t===e)throw`[xchgbuf] buf:${t} が同じ値です`;const s="const.sn.sound."+t+".",o=Number(c.getVal("save:"+s+"volume")),i=String(c.getVal("save:"+s+"fn")),r="const.sn.sound."+e+".",u=Number(c.getVal("save:"+r+"volume")),a=String(c.getVal("save:"+r+"fn"));c.setVal_Nochk("save",s+"volume",u),c.setVal_Nochk("save",r+"volume",o),c.setVal_Nochk("save",s+"fn",a),c.setVal_Nochk("save",r+"fn",i),t in p.#t!=e in p.#t&&(t in p.#t?(delete p.#t[t],p.#t[e]=i):(delete p.#t[e],p.#t[t]=a),c.setVal_Nochk("save","const.sn.loopPlaying",JSON.stringify(p.#t))),c.flush()}static#s=999e3;#e;needLoad;#n=()=>{N.volumeAll=Number(c.getVal("sys:sn.sound.global_volume",1)),this.#n=()=>{}};#o(t,e){const s=W.searchPath(t,ut.SOUND);if(!s.endsWith(".bin")){e.url=s,G.from(e);return}new tt().add({name:t,url:s,xhrType:O.XHR_RESPONSE_TYPE.BUFFER}).use(async(o,i)=>{try{o.data=await Z.decAB(o.data)}catch(r){k.errScript(`Sound ロード失敗ですc fn:${o.name} ${r}`,!1)}i()}).load((o,i)=>{e.source=i[t]?.data,G.from(e)})}setVol(t){this.#e.setVol(t)}ws=t=>this.#e.stt.ws(this.#e,t);stopse({buf:t=g}){Y(this.#e,t),this.#e.stt.stopse(this.#e)}fade=t=>this.#e.stt.fade(this.#e,t);wf=t=>this.#e.stt.wf(this.#e,t);stopfadese=t=>this.#e.stt.stopfadese(this.#e,t)}function Y({loop:n},t){if(n){p.delLoopPlay(t);return}const e="const.sn.sound."+t+".";c.setVal_Nochk("tmp",e+"playing",!1),c.flush()}function R(n){n.stop().end()}class jt{onLoad(t){t.stt=new D}stopse(t){t.stt=new A(t,!1)}ws=()=>!1;onPlayEnd(){}fade(){}wf=()=>!1;compFade(){}stopfadese(){}isDestroy=!1}class D{onLoad(){}stopse(t){t.stt=new A(t)}ws(t,e){if(t.loop)return!1;const{buf:s=g}=e,o=L(e,"stop",!0);return L(e,"canskip",!1),M.waitEvent("buf:"+s,e,()=>{Y(t,s),t.onPlayEnd(),o?t.stt.stopse(t):t.stt.onPlayEnd=()=>{}})?(t.stt=new Lt,!0):!1}onPlayEnd(){}fade(t,e){const{buf:s=g}=e,o="const.sn.sound."+s+".volume",i=p.getVol(e,NaN);c.setVal_Nochk("save",o,i);const r=i*Number(c.getVal("sys:"+o,1)),u=L(e,"stop",i===0);u&&p.delLoopPlay(s),c.flush();const a=S(e,"time",NaN),l=S(e,"delay",0);if(a===0&&l===0||M.isSkipping){t.setVol(r),t.stt=u?new A(t):new D;return}const h=t.tw();h&&(ct.setTwProp(h,e).to({volume:r},a).onComplete(()=>{dt(h),t.stt.compFade(s),t.stt=u?new A(t):new D}).start(),t.stt=new Ft(h))}wf=()=>!1;compFade(){}stopfadese(){}isDestroy=!1}class Lt{onLoad(){}stopse(t){t.stt=new A(t)}ws=()=>!1;onPlayEnd(t){M.breakEvent("buf:"+t)}fade(){}wf=()=>!1;compFade(){}stopfadese(){}isDestroy=!1}class Ft{constructor(t){this.tw=t}onLoad(){}stopse(t){R(this.tw),t.stt=new A(t)}ws=()=>!1;onPlayEnd(){}fade(){}wf(t,e){const{buf:s=g}=e;return L(e,"canskip",!1),M.waitEvent("buf:"+s,e,()=>R(this.tw))?(t.stt=new At(this.tw),!0):!1}compFade(){}stopfadese=()=>R(this.tw);isDestroy=!1}class At{constructor(t){this.tw=t}onLoad(){}stopse(t){R(this.tw),t.stt=new A(t)}ws=()=>!1;onPlayEnd(){}fade(){}wf=()=>!1;compFade(t){M.breakEvent("buf:"+t)}stopfadese=()=>R(this.tw);isDestroy=!1}class A{constructor(t,e=!0){this.si=t,this.stop=e,e&&(t.stop(),t.loop&&(t.destroy(),t.destroy=()=>{}))}onLoad(){}stopse(){}ws=()=>!1;onPlayEnd(){}fade(){}wf=()=>!1;compFade(){}stopfadese(){}isDestroy=!0}class Mt{constructor(t,e,s,o,i){this.val=s,e.volume=r=>this.#e(r),e.fadebgm=r=>this.#l(r),e.fadeoutbgm=r=>this.#o(r),e.fadeoutse=r=>this.#d(r),e.fadese=r=>this.#i(r),e.playbgm=r=>this.#c(r),e.playse=r=>this.#a(r),e.stop_allse=()=>this.#r(),e.stopbgm=r=>this.#_(r),e.stopse=r=>this.#u(r),e.wb=r=>this.#y(r),e.wf=r=>this.#h(r),e.stopfadese=r=>this.#f(r),e.wl=r=>this.#m(r),e.ws=r=>this.#p(r),e.xchgbuf=r=>this.#b(r),s.setVal_Nochk("save","const.sn.loopPlaying","{}"),s.setVal_Nochk("tmp","const.sn.sound.codecs",JSON.stringify(kt.supported)),p.init(t,s,o,i,this.#t),N.disableAutoPause=!0}#t={};#s;setEvtMng(t){this.#s=t,p.setEvtMng(t)}setNoticeChgVolume(t,e){this.val.defValTrg("sys:sn.sound.global_volume",(s,o)=>t(N.volumeAll=Number(o))),this.val.defValTrg("sys:sn.sound.movie_volume",(s,o)=>e(Number(o))),this.val.setVal_Nochk("sys","sn.sound.global_volume",this.val.getVal("sys:sn.sound.global_volume",1)),this.val.setVal_Nochk("sys","sn.sound.movie_volume",this.val.getVal("sys:sn.sound.movie_volume",1))}#e(t){const{buf:e=g}=t,s="const.sn.sound."+e+".volume",o=this.#n(t,1);return Number(this.val.getVal("sys:"+s))===o?!1:(this.val.setVal_Nochk("sys",s,o),this.val.flush(),t.time=0,t.volume=Number(this.val.getVal("save:"+s)),this.#i(t))}#n(t,e){const s=S(t,"volume",e);return s<0?0:s>1?1:s}#o(t){return t.volume=0,this.#l(t)}#d(t){return t.volume=0,this.#i(t)}#l(t){return t.buf=E,this.#i(t)}#i(t){const{buf:e=g}=t;return this.#f(t),this.#t[e]?.fade(t),!1}#c(t){return t.buf=E,t.canskip=!1,L(t,"loop",!0),this.#a(t)}#a(t){const{buf:e=g,fn:s}=t;if(this.#u({buf:e}),!s)throw`fnは必須です buf:${e}`;return L(t,"canskip",!0)&&this.#s.isSkipping?!1:(this.#t[e]=new p(t,e,s)).needLoad}clearCache(){N.removeAll()}#r(){for(const t of Object.keys(this.#t))this.#u({buf:t});return this.#t={},N.stopAll(),!1}#_(t){return t.buf=E,this.#u(t)}#u(t){const{buf:e=g}=t;return this.#t[e]?.stopse(t),!1}#y(t){return t.buf=E,this.#h(t)}#h(t){const{buf:e=g}=t;return this.#t[e]?.wf(t)}#f(t){const{buf:e=g}=t;return this.#t[e]?.stopfadese(t),!1}#m(t){return t.buf=E,this.#p(t)}#p(t){const{buf:e=g}=t;return this.#t[e]?.ws(t)}#b(t){const{buf:e=g,buf2:s=g}=t;if(e===s)return!1;const o=this.#t[e],i=this.#t[s];return o?this.#t[s]=o:delete this.#t[s],i?this.#t[e]=i:delete this.#t[e],p.xchgbuf(t),!1}playLoopFromSaveObj(t){const e=String(this.val.getVal("save:const.sn.loopPlaying","{}"));if(e==="{}")return this.#r(),this.clearCache(),[];const s=JSON.parse(e);if(t)this.#r(),this.clearCache();else for(const[o,i]of Object.entries(this.#t))o in s||i?.stopse({buf:o});return Object.entries(s).map(([o,i])=>new Promise(r=>{const u=this.#t[o];if(!t&&u&&u.fn===i){r();return}const a="save:const.sn.sound."+o+".",l={fn:i,buf:o,join:!1,loop:!0,volume:Number(this.val.getVal(a+"volume")),start_ms:Number(this.val.getVal(a+"start_ms")),end_ms:Number(this.val.getVal(a+"end_ms")),ret_ms:Number(this.val.getVal(a+"ret_ms")),fnc:r};l.buf===E?this.#c(l):this.#a(l)}))}destroy(){this.#r(),this.clearCache()}}export{Mt as SoundMng};
