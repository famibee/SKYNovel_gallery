import{l as V,q as M,D as Q,r as D,s as P,a as E,b as v,C as T,R as W,u as z,v as Tt,o as ht,w as St,x as L,y as Nt,j as st,S as Y,z as mt,F as Et,E as bt,g as gt,H as At,I as X,J as Ft,K as rt,L as U,M as Rt,c as O,i as ut,f as Pt,N as xt,O as Ot}from"./web-D5cyPUip.js";import{i as R}from"./CmnTween-r55hjyCD.js";import{f as yt,x as Lt,a as J,O as q}from"./ReadState-DHFxOgnr.js";import{o as lt}from"./RubySpliter-9A4-WyyF.js";import"../web.js";class G{constructor(t,e,s,i,n,h,a,r){this.cls=e,this.hArg=n,this.sys=h,this.val=a,this.ret=r;const c=h.hFactoryCls[e];if(!c)throw`属性 class【${e}】が不正です`;const u=c(),l=c();u.layname=l.layname=t;const g=n[":id_tag"]=`layer:${t} cls:${e} page:`;u.ctn.name=u.name=g+"A",l.ctn.name=l.name=g+"B",s.addChild(u.ctn),i.addChild(l.ctn),E(n,"visible",!0),E(n,"visible",!0),r.isWait=u.lay(n)||l.lay(n),this.#i={fore:u,back:l};const p=`const.sn.lay.${t}`;a.setVal_Nochk("tmp",p,!0),a.defTmp(p+".fore.alpha",()=>this.#i.fore.alpha),a.defTmp(p+".back.alpha",()=>this.#i.back.alpha),a.defTmp(p+".fore.height",()=>this.#i.fore.height),a.defTmp(p+".back.height",()=>this.#i.back.height),a.defTmp(p+".fore.visible",()=>this.#i.fore.ctn.visible),a.defTmp(p+".back.visible",()=>this.#i.back.ctn.visible),a.defTmp(p+".fore.width",()=>this.#i.fore.width),a.defTmp(p+".back.width",()=>this.#i.back.width),a.defTmp(p+".fore.x",()=>this.#i.fore.x),a.defTmp(p+".back.x",()=>this.#i.back.x),a.defTmp(p+".fore.y",()=>this.#i.fore.y),a.defTmp(p+".back.y",()=>this.#i.back.y)}#i;destroy(){this.#i.fore.destroy(),this.#i.back.destroy()}lay=t=>this.getPage(t).lay(t);getPage=t=>G.argChk_page(t,"fore")!=="back"?this.#i.fore:this.#i.back;static argChk_page(t,e){const s=t.page??e;if(s==="fore"||s==="back")return t.page=s;throw Error("属性 page【"+s+"】が不正です")}get fore(){return this.#i.fore}get back(){return this.#i.back}transPage(t){[this.#i.back,this.#i.fore]=[this.#i.fore,this.#i.back],this.#i.back.copy(this.#i.fore,t)}}class ct{constructor(t,e=!1){this.bg_col=t,this.isLay=e}static init(t,e,s,i,n,h){}static cvsResizeDesign(){}destroy(){}gethArg(){return this.hArg}hArg={};sethArg(t){this.hArg=t}setOther(t){}adopt(t){}static enterMode(){}static allHide(){}set visible(t){}static leaveMode(){}cvsResize(){}make(){}static replaceToken(t){}}class Vt extends ct{constructor(t,e){super("#29e",!0)}setSp(t){}}class m{constructor(t="",e,s=()=>{},i=()=>{}){this.csvFn=t,this.ctn=e,this.fncFirstComp=s,this.fncAllComp=i,t&&(this.#u=e?n=>{e.addChild(n),this.#o.push(n)}:()=>{},this.ret=m.#s(t,n=>this.fncFirstComp(n),n=>this.fncAllComp(n),n=>this.#u(n)))}static#i;static#e;static#n;static#h;static init(t,e,s,i,n){m.#i=t,m.#e=e,m.#n=s,m.#h=i,s.arg.crypto&&(m.#p=m.#f,m.#r=m.#O);const h=()=>{const a=m.#c*m.#t;for(const r of Object.values(m.#w))r.volume=a};n.setNoticeChgVolume(a=>{m.#c=a,h()},a=>{m.#t=a,h()})}static#t=1;static#c=1;static#d;static setEvtMng(t){m.#d=t}ret=!1;#u;#o=[];destroy(){this.fncFirstComp=()=>{},this.fncAllComp=()=>{},this.#u=t=>t.destroy();for(const t of this.#o)m.stopVideo(t.name),t.parent?.removeChild(t),t.destroy();this.#o=[]}static destroy(){m.#y={},m.#l={},m.#w={}}static#s(t,e,s,i){if(!t)return!1;let n=!1;if(t.startsWith("data:")){const l=()=>{const g=P.from(t);i(g),e(g),s(n)};return t in rt?l():(n=!0,new U().add(t,t).load(l)),n}const h=[],a=new U,r=t.split(","),c=r.length;for(let l=0;l<c;++l){const g=r[l];if(!g)throw"face属性に空要素が含まれます";const{dx:p,dy:o,blendmode:d,fn:f}=m.#y[g]||{fn:g,dx:0,dy:0,blendmode:Rt.NORMAL},y=l===0?e:x=>{x.x=p,x.y=o,x.blendMode=d};if(h.push({fn:f,fnc:y}),f in m.#l||f in rt||f in U.shared.resources)break;n=!0;const b=m.#i.searchPath(f,Y.SP_GSM),C=this.#n.arg.crypto?{xhrType:b.slice(-5)===".json"?O.XHR_RESPONSE_TYPE.TEXT:O.XHR_RESPONSE_TYPE.BUFFER}:{};a.add({...C,name:f,url:b})}const u=(l,g)=>{for(const{fn:p,fnc:o}of h){const d=m.#$(p,g);d.name=p,i(d),o(d)}s(n)};return n?a.use(async(l,g)=>{try{if(l.extension==="json"){const o=await this.#n.dec("json",l.data);m.#r(o,l,g);return}const p=await this.#n.decAB(l.data);m.#p(p,l,g)}catch(p){const o=`画像/動画ロード失敗です fn:${l.name} ${p}`;m.#d.isSkipping?console.warn(o):console.error("%c"+o,"color:#FF3300;")}}).load(u):queueMicrotask(()=>u(0,{})),n}static#y={};static#l={};static#p=(t,{type:e,name:s,data:i},n)=>{switch(e){case O.TYPE.VIDEO:const h=i;h.volume=m.#c,m.#w[s]=m.#x(h)}n()};static#g(t){const e=/([^\d]+)\d+\.(\w+)/.exec(t[0]??"");if(!e)return[];const s=e[1].length,i=-e[2].length-1;return t.sort((n,h)=>ut(n.slice(s,i))>ut(h.slice(s,i))?1:-1)}static async#f(t,e,s){e.data=t,e.extension!=="bin"&&s(),t instanceof HTMLImageElement?(e.texture=await D.fromLoader(t,e.url,e.name),e.type=O.TYPE.IMAGE):t instanceof HTMLVideoElement&&(t.volume=m.#c,m.#w[e.name]=m.#x(t),e.type=O.TYPE.VIDEO),s()}static#x(t){return m.#e.getVal("const.sn.needClick2Play")&&(Q.trace_beforeNew(`[lay系] ${Q.strPos()}未クリック状態で動画を自動再生します。音声はミュートされます`,"W"),t.muted=!0),t.setAttribute("playsinline",""),t}static#r=(t,{type:e,spritesheet:s,name:i,data:n},h)=>{switch(e){case O.TYPE.JSON:const a=s._frameKeys;m.#g(a),m.#l[i]={aTex:a.map(r=>D.from(r)),meta:n.meta}}h()};static#O(t,e,s){const{meta:i,frames:n}=e.data=JSON.parse(t);if(e.type=O.TYPE.JSON,!i?.image){s();return}const h=Pt(i.image),a=m.#i.searchPath(h,Y.SP_GSM);new U().use((r,c)=>{this.#n.decAB(r.data).then(u=>{r.data=u,u instanceof HTMLImageElement&&(r.type=O.TYPE.IMAGE,URL.revokeObjectURL(u.src)),c()}).catch(u=>this.#h.errScript(`画像/動画ロード失敗です dec2res4Cripto fn:${r.name} ${u}`,!1))}).add({name:h,url:a,xhrType:O.XHR_RESPONSE_TYPE.BUFFER}).load((r,c)=>{for(const{data:u}of Object.values(r.resources)){const{baseTexture:l}=D.from(u),g=Object.values(n);m.#l[e.name]={aTex:g.map(({frame:{x:p,y:o,w:d,h:f}})=>new D(l,new W(p,o,d,f))),meta:i}}s()})}static#$(t,e){const s=m.#l[t];if(s){const h=new xt(s.aTex);return h.animationSpeed=s.meta.animationSpeed??1,h.play(),h}if(t in rt)return P.from(t);const i=m.#w[t];if(i)return P.from(i);const n=e[t];return n?new P(n.texture):new P}static#w={};static getHFn2VElm(t){return m.#w[t]}static wv(t){const{fn:e}=t;if(!e)throw"fnは必須です";const s=m.#w[e];if(!s||s.loop)return!1;if(m.#d.isSkipping||s.ended)return m.stopVideo(e),!1;const i=()=>m.#d.breakEvent("wv fn:"+e);s.addEventListener("ended",i,{once:!0,passive:!0});const n=E(t,"stop",!0);return m.#d.waitEvent("wv fn:"+e,t,()=>{s.removeEventListener("ended",i),n&&m.stopVideo(e),i()})}static stopVideo(t){const e=m.#w[t];e&&(delete m.#w[t],e.pause(),e.currentTime=e.duration)}static add_face(t){const{name:e}=t;if(!e)throw"nameは必須です";if(e in m.#y)throw"一つのname（"+e+"）に対して同じ画像を複数割り当てられません";const{fn:s=e}=t;return m.#y[e]={fn:s,dx:v(t,"dx",0),dy:v(t,"dy",0),blendmode:L.getBlendmodeNum(t.blendmode||"")},!1}}class B extends L{static#i=new bt;static#e;static init(t,e,s,i,n,h){B.#e=s,m.init(e,h,i,t,n)}static destroy(){B.#i.clear(),m.destroy()}#n=new Vt(this.ctn,this);constructor(){super(),T.isDbg&&(this.#h=t=>this.#n.setSp(t),this.cvsResize=()=>{super.cvsResize(),this.#n.cvsResize()})}#h=()=>{};#t="";#c="";#d="";lay=t=>{const e=this.#u(t,s=>{s&&J()});return e&&q(),e};#u(t,e){const{fn:s,face:i=""}=t;if(this.#n.sethArg(t),!s)return super.lay(t),this.ctn.children.length>0&&this.setPos(t),this.#c="",this.#t=this.#d=i,e(!1),!1;const n="fn"in t,h="face"in t;return this.clearLay({clear_filter:E(t,"clear_filter",!0)}),n&&(this.#c=s),h&&(this.#d=i),super.lay(t),t.dx=0,t.dy=0,this.#o.destroy(),this.#o=new m(this.#t=s+(i?","+i:""),this.ctn,a=>{("width"in t||"height"in t)&&(a.width=v(t,"width",0),a.height=v(t,"height",0)),this.#s=a.width,this.#y=a.height,L.setXY(a,t,this.ctn,!0),L.setBlendmode(this.ctn,t),this.#h(a)},a=>e(a)),this.#o.ret}#o=new m;#s=0;#y=0;get width(){return this.#s}get height(){return this.#y}renderStart(){this.#p=new P(this.#l),this.#p.visible=!1,this.ctn.addChildAt(this.#p,0),this.#p.position.set(-this.ctn.x,-this.ctn.y);let t=()=>{const e=this.ctn.alpha;this.ctn.alpha=1;for(const s of this.ctn.children)s.visible=!0;this.#p.visible=!1,B.#e.renderer.render(this.ctn,{renderTexture:this.#l}),this.ctn.alpha=e;for(const s of this.ctn.children)s.visible=!1};if(!this.containMovement){let e=t;t=()=>{t=()=>{},e()}}this.#g=()=>{t(),this.#p.visible=!0},B.#e.ticker.add(this.#g)}#l=X.create({width:T.stageW,height:T.stageH});#p=new P;#g=()=>{};renderEnd(){B.#e.ticker.remove(this.#g),this.ctn.removeChild(this.#p);for(const t of this.ctn.children)t.visible=!0;this.#p.destroy(!0),this.#l=X.create({width:T.stageW,height:T.stageH})}setPos(t){L.setXY(this.ctn.children[0]??this.ctn,t,this.ctn,!0)}get containMovement(){if(this.#t==="")return!1;const t=this.ctn.children;return this.#t.split(",").some((e,s)=>t[s]instanceof xt||m.getHFn2VElm(e))}clearLay(t){super.clearLay(t),this.#o.destroy(),this.#c="",this.#d="",this.#t=""}record=()=>({...super.record(),sBkFn:this.#c,sBkFace:this.#d});playback(t,e){if(super.playback(t,e),t.sBkFn===""&&t.sBkFace===""){this.#c="",this.#d="";return}e.push(new Promise(s=>this.#u({fn:t.sBkFn,face:t.sBkFace,left:t.x,top:t.y,alpha:t.alpha,blendmode:L.getNum2Blendmode(t.blendMode),rotation:t.rotation,scale_x:t.scale_x,scale_y:t.scale_y},i=>{this.ctn.position.set(t.x,t.y),s()})))}makeDesignCast(t){this.ctn.visible&&t(this.#n)}cvsResize(){super.cvsResize()}showDesignCast(){this.#n.visible=!0}dump=()=>super.dump()+`, "pic":"${this.#t}"`}const K="、。，．）］｝〉」』】〕”〟ぁぃぅぇぉっゃゅょゎァィゥェォッャュョヮヵヶ！？!?‼⁉・ーゝゞヽヾ々",it="［（｛〈「『【〔“〝",nt="─‥…",ot=K,wt=new RegExp(`[${K}]`),It=new RegExp(`[${it}]`),jt=new RegExp(`[${nt}]`),Bt=wt;class Mt{#i=K;#e=it;#n=nt;#h=ot;get 行頭禁則(){return this.#i}get 行末禁則(){return this.#e}get 分割禁止(){return this.#n}get ぶら下げ(){return this.#h}#t=wt;#c=It;#d=jt;#u=Bt;break_fixed=!1;break_fixed_left=0;break_fixed_top=0;bura=!1;lay(t){t.kinsoku_sol&&(this.#i=t.kinsoku_sol,this.#t=new RegExp(`[${this.#i}]`)),t.kinsoku_eol&&(this.#e=t.kinsoku_eol,this.#o(),this.#c=new RegExp(`[${this.#e}]`)),t.kinsoku_dns&&(this.#n=t.kinsoku_dns,this.#s(),this.#d=new RegExp(`[${this.#n}]`)),t.kinsoku_bura&&(this.#h=t.kinsoku_bura,this.#o(),this.#s(),this.#u=new RegExp(`[${this.#h}]`)),"bura"in t&&(this.bura=E(t,"bura",!1)),this.break_fixed=E(t,"break_fixed",this.break_fixed),this.break_fixed_left=v(t,"break_fixed_left",this.break_fixed_left),this.break_fixed_top=v(t,"break_fixed_top",this.break_fixed_top)}#o(){const t=this.#e.length,e=this.#h.length;if(t<e)for(let s=0;s<t;++s){const i=this.#e[s];if(this.#h.includes(i))throw`禁則の競合があります。文字 ${i} がぶら下げ と 行末禁則 の両方に含まれます`}else for(let s=0;s<e;++s){const i=this.#h[s];if(this.#e.includes(i))throw`禁則の競合があります。文字 ${i} がぶら下げ と 行末禁則 の両方に含まれます`}}#s(){const t=this.#n.length,e=this.#h.length;if(t<e)for(let s=0;s<t;++s){const i=this.#n[s];if(this.#h.includes(i))throw`禁則の競合があります。文字 ${i} がぶら下げ と 分割禁止 の両方に含まれます`}else for(let s=0;s<e;++s){const i=this.#h[s];if(this.#n.includes(i))throw`禁則の競合があります。文字 ${i} がぶら下げ と 分割禁止 の両方に含まれます`}}reNew(t){t.#y(this.#i,this.#e,this.#n,this.#h),t.break_fixed=this.break_fixed,t.break_fixed_left=this.break_fixed_left,t.break_fixed_top=this.break_fixed_top,t.bura=this.bura}#y(t,e,s,i){this.#i!=t&&(this.#i=t,this.#t=new RegExp(`[${t}]`)),this.#e!=e&&(this.#e=e,this.#c=new RegExp(`[${e}]`)),this.#n!=s&&(this.#n=s,this.#d=new RegExp(`[${s}]`)),this.#h!=i&&(this.#h=i,this.#u=new RegExp(`[${i}]`))}record(){const t={break_fixed:this.break_fixed,break_fixed_left:this.break_fixed_left,break_fixed_top:this.break_fixed_top,bura:this.bura};return this.#i===K&&(t.行頭禁則=this.#i),this.#e===it&&(t.行末禁則=this.#e),this.#n===nt&&(t.分割禁止=this.#n),this.#h===ot&&(t.ぶら下げ=this.#h),t}playback(t){t&&(this.#y(t.行頭禁則??K,t.行末禁則??it,t.分割禁止??nt,t.ぶら下げ??ot),this.break_fixed=t.break_fixed,this.break_fixed_left=t.break_fixed_left,this.break_fixed_top=t.break_fixed_top,this.bura=t.bura)}hyph(t,e,s,i,n){let h,a=0,r=2,c=u=>(c=()=>!1,i===u?(i>0&&(t.innerHTML=n.replaceAll('class="sn_ch"','class="sn_ch sn_ch_in_default"')),!0):u<2);do{if(h=this.#p(t,e),a=h.length,c(a))break;let u=-1/0;for(;r<a;++r){const{elm:l,rect:g,ch:p}=h[r];if(l.tagName==="RT")continue;const o=s?g.y:g.x;if(u<=o||l.previousElementSibling?.tagName==="SPAN"&&l.previousElementSibling?.innerHTML.includes("<br>")||l.parentElement?.previousElementSibling?.tagName==="SPAN"&&l.parentElement?.previousElementSibling?.innerHTML.includes("<br>")){u=o,this.break_fixed||(this.break_fixed_left=g.x,this.break_fixed_top=g.y);continue}const d=this.#l(h,r),{elm:f,rect:y,ch:b}=h[d];if(!this.break_fixed){this.break_fixed_left=y.x,this.break_fixed_top=y.y;const F=globalThis.getComputedStyle(f),j=parseFloat(F.fontSize);s?this.break_fixed_top+=j:this.break_fixed_left+=j}u=-1/0;const C=r,{cont:x,ins:k}=this.bura?this.hyph_alg_bura(h,d,b,r):this.hyph_alg(h,d,b,r,p);if(r=k,x)continue;const S=h[r].elm,N=S.parentElement,A=document.createElement("br");if(N.classList.contains("sn_tx"))N.insertBefore(A,S);else{const F=N.parentElement;F.classList.contains("sn_ch")?F.parentElement.insertBefore(A,F):F.insertBefore(A,N)}r+=2,r<C&&(r=C),a=-1;break}}while(a<0);return[h,a]}#l(t,e){const s=e-1,{elm:i}=t[s];return i.tagName!=="RT"?s-(i.style.textCombineUpright==="all"?Array.from(i.textContent??"").length-1:0):s-Array.from(i.textContent??"").length}#p(t,e){const s=[];if(t.nodeType!==t.TEXT_NODE)return Array.from(t.childNodes).map(a=>this.#p(a,e)).flat();const i=t.ownerDocument.createRange();i.selectNodeContents(t);let n=0;const h=i.endOffset;for(;n<h;){i.setStart(t,n),i.setEnd(t,++n);const a=i.toString();s.push({ch:a,rect:e(i,a),elm:i.startContainer.parentElement})}return i.detach(),s}hyph_alg(t,e,s,i,n){if(!this.#c.test(s)){if(this.#t.test(n))for(;(i=this.#l(t,i))>=0&&this.#t.test(t[i].ch););else if(!(s===n&&this.#d.test(s)))return{cont:!0,ins:i+1}}for(i=e;(i=this.#l(t,i))>=0&&this.#c.test(t[i].ch););return{cont:!1,ins:i+1}}hyph_alg_bura(t,e,s,i){const n=this.#l(t,e),{ch:h}=t[n];if(this.#u.test(h)||this.#t.test(h)){let r=e;(this.#u.test(s)||this.#t.test(s))&&++r;const c=this.#l(t,r),{ch:u}=t[c],{ch:l}=t[r];if(u===l&&this.#d.test(l))return{cont:!1,ins:c};if(!this.#c.test(u))return{cont:!1,ins:r};r=c;do if(!this.#c.test(t[r].ch))break;while((r=this.#l(t,r))>=0);return{cont:!1,ins:r+1}}const a=this.#l(t,n);if(i>=3){const{ch:r}=t[a];if(this.#d.test(h)&&r===h)return{cont:!1,ins:a};if(this.#c.test(r)){let c=a;for(;(c=this.#l(t,c))>=0&&this.#c.test(t[c].ch););return{cont:!1,ins:c+1}}}return{cont:!1,ins:n}}}class _ extends V{constructor(t,e,s){super(),this.ctn=t,this.canFocus=e,this.sys=s,this.#t.classList.add("sn_tx"),this.#t.style.position="absolute",_.#e.view.parentElement.appendChild(this.#t),this.addChild(this.#c),this.addChild(this.#d),this.#d.name="grpDbgMasume",this.noticeCompTxt=s.isApp&&_.#i.oCfg.debug.dumpHtm?()=>{yt.noticeCompTxt();const i=this.#t.innerHTML;if(i==="")return;const{fn:n,ln:h}=_.#h.nowScrFnLn(),a=`dumpHtm ${t.name.slice(0,-7).replaceAll(":","=")}(fn=${n} line=${h})`;s.outputFile(s.path_downloads+a+".htm",`<!doctype html><html><head><meta charset=utf-8><title>${a}</title>
<h1>${a}</h1>${i.replaceAll(/ class="sn_ch"|animation-delay: \d+ms; ?| data-add="{&quot;ch_in_style&quot;:&quot;default&quot;, &quot;ch_out_style&quot;:&quot;default&quot;}"/g,"").replaceAll(' style=""',"").replaceAll(/(<\/?ruby>)/g,`
$1
`).replaceAll(/<(br|\/span)>/g,`<$1>
`)}`)}:()=>yt.noticeCompTxt()}static#i;static#e;static init(t,e){_.#i=t,_.#e=e}static#n;static#h;static setEvtMng(t,e){_.#n=t,_.#h=e}static destroy(){_.#E=Object.create(null),_.#L=Object.create(null),_.delBreak()}#t=document.createElement("span");#c=new V;#d=new M;static#u={"background-color":0,"border-bottom-width":0,"border-left-width":0,"border-right-width":0,"border-top-width":0,"margin-bottom":0,"margin-left":0,"margin-right":0,"margin-top":0};#o=new Mt;noticeCompTxt=()=>{};#s={fontsize:24,$width:0,$height:0,pad_left:0,pad_right:0,pad_top:0,pad_bottom:0};lay(t){const e=this.#t.style;if("style"in t)if(t.style){const s=document.createElement("span");s.style.cssText=t.style;const i=s.style.length;for(let n=0;n<i;++n){const h=s.style[n];if(h in _.#u){Q.myTrace(`${h}は指定できません`,"W");continue}e[h]=s.style[h]}!s.style.opacity&&"alpha"in t&&(e.opacity=String(this.ctn.alpha))}else this.#t.style.cssText="";else"alpha"in t&&(e.opacity=String(this.ctn.alpha));if("width"in t&&(e.width=(t.width??"0")+"px"),"height"in t&&(e.height=(t.height??"0")+"px"),"pl"in t&&(e.paddingLeft=(t.pl??"0")+"px"),"pr"in t&&(e.paddingRight=(t.pr??"0")+"px"),"pt"in t&&(e.paddingTop=(t.pt??"0")+"px"),"pb"in t&&(e.paddingBottom=(t.pb??"0")+"px"),this.#o.lay(t),this.#l(),this.#p=this.ctn.position.x,e.transformOrigin=`${this.ctn.pivot.x}px ${this.ctn.pivot.y}px`,this.cvsResize(),e.display=this.ctn.visible?"inline":"none",":redraw"in t&&this.#a>0){const s=[this.#t.innerHTML.replaceAll(/(animation-delay: )\d+ms/g,"$10ms"),`<span class='sn_ch' data-add='{"ch_in_style":"default"}'>&emsp;</span>`];this.#m(),this.goTxt(s,!0)}}#y=0;#l(){const t=this.#t.style,e=parseFloat(t.fontSize||"0");this.#s.fontsize=e,this.#s.pad_left=parseFloat(t.paddingLeft||"0"),this.#s.pad_right=parseFloat(t.paddingRight||"0"),this.#s.pad_top=parseFloat(t.paddingTop||"0"),this.#s.pad_bottom=parseFloat(t.paddingBottom||"0"),this.#s.$width=parseFloat(t.width||"0"),this.#s.$height=parseFloat(t.height||"0"),this.position.set(this.#s.pad_left,this.#s.pad_top),this.#g=t.writingMode==="vertical-rl",this.#f=0,this.#x=0;const s=t.lineHeight??"0";this.#y=this.#g?0:(s.endsWith("px")?parseFloat(s):e*parseFloat(s)-e)/2}cvsResize(){const t=this.#t.style,e=this.sys.cvsScale;t.left=`${this.sys.ofsLeft4elm+this.#p*e}px`,t.top=`${this.sys.ofsTop4elm+this.ctn.position.y*e}px`,t.transform=`rotate(${this.ctn.angle}deg) scale(${this.ctn.scale.x*e}, ${this.ctn.scale.y*e})`}#p=0;#g=!1;get tategaki(){return this.#g}#f=0;#x=0;get infTL(){return this.#s}get getWidth(){return this.#s.$width}get getHeight(){return this.#s.$height}setMySize(t,e){this.#s.$width=t,this.#s.$height=e,this.#t.style.width=this.#s.$width+"px",this.#t.style.height=this.#s.$height+"px"}#r(t,e=!0){const s={escape:d=>d.replaceAll(/([.*+?^${}()|\[\]\/\\])/g,"\\$1"),mimeType:d=>{const f=r(d).toLowerCase();return i()[f]||""},dataAsUrl:g,isDataUrl:c,resolveUrl:u,getAndEncode:l,asArray:d=>{const f=[],y=d.length;for(let b=0;b<y;++b)f.push(d[b]);return f}};function i(){const d="application/font-woff",f="image/jpeg";return{woff:d,woff2:d,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:f,jpeg:f,gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"}}const n=p(),h=o();function a(d){return h.resolveAll().then(f=>{const y=document.createElement("style");return d.appendChild(y),y.appendChild(document.createTextNode(f)),d})}function r(d){return/\.([^\.\/]*?)$/g.exec(d)?.[1]??""}function c(d){return d.search(/^(data:)/)!==-1}function u(d,f){const y=document.implementation.createHTMLDocument(),b=y.createElement("base");y.head.appendChild(b);const C=y.createElement("a");return y.body.appendChild(C),b.href=f,C.href=d,C.href}function l(d){let f=3e4;return new Promise(function(y){const b=new XMLHttpRequest;b.onreadystatechange=C,b.ontimeout=x,b.responseType="blob",b.timeout=f,b.open("GET",d,!0),b.send();function C(){if(b.readyState!==4)return;if(b.status!==200){k("cannot fetch resource: "+d+", status: "+b.status);return}const S=new FileReader;S.onloadend=function(){const N=S.result.toString().split(/,/)[1];y(N)},S.readAsDataURL(b.response)}function x(){k("timeout of "+f+"ms occured while fetching resource: "+d)}function k(S){console.error(S),y("")}})}function g(d,f){return"data:"+f+";base64,"+d}function p(){const d=/url\(['"]?([^'"]+?)['"]?\)/g;return{inlineAll:C,shouldProcess:f};function f(x){return x.search(d)!==-1}function y(x){const k=[];let S;for(;S=d.exec(x);)k.push(S[1]);return k.filter(function(N){return!s.isDataUrl(N)})}function b(x,k,S,N){return Promise.resolve(k).then(F=>S?s.resolveUrl(F,S):F).then(N||s.getAndEncode).then(F=>s.dataAsUrl(F,s.mimeType(k))).then(F=>x.replace(A(k),"$1"+F+"$3"));function A(F){return new RegExp(`(url\\(['"]?)(`+s.escape(F)+`)(['"]?\\))`,"g")}}function C(x,k,S){if(N())return Promise.resolve(x);return Promise.resolve(x).then(y).then(A=>{let F=Promise.resolve(x);for(const j of A)F=F.then(at=>b(at,j,k,S));return F});function N(){return!f(x)}}}function o(){return{resolveAll:d,impl:{readAll:f}};function d(){return f().then(y=>Promise.allSettled(y.map(b=>b.resolve()))).then(y=>y.join(`
`))}function f(){return Promise.resolve(s.asArray(document.styleSheets)).then(b).then(y).then(x=>x.map(C));function y(x){return x.filter(k=>k.type===CSSRule.FONT_FACE_RULE).filter(k=>n.shouldProcess(k.style.getPropertyValue("src")))}function b(x){const k=[];for(const S of x)try{if(S.href)continue;s.asArray(S.cssRules||[]).forEach(k.push.bind(k))}catch(N){console.error("Error while reading CSS rules from "+S.href,String(N))}return k}function C(x){return{resolve:function(){const k=(x.parentStyleSheet||{}).href;return n.inlineAll(x.cssText,k)},src:function(){return x.style.getPropertyValue("src")}}}}}Promise.resolve(this.#t).then(d=>{const f=d.cloneNode(!0);return f.style.padding="0px",f.style.paddingRight=this.#f+"px",f.style.paddingTop=this.#x+"px",f.style.left="0px",f.style.top="0px",f.style.width=this.#s.$width-this.#s.pad_left-this.#s.pad_right+"px",f.style.height=this.#s.$height-this.#s.pad_top-this.#s.pad_bottom+"px",this.#t.hidden=e,f}).then(a).then(d=>{d.setAttribute("xmlns","http://www.w3.org/1999/xhtml");const f=new Image;return f.src=`data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="${this.#s.$width}px" height="${this.#s.$height}px"><foreignObject x="0" y="0" width="100%" height="100%">${new XMLSerializer().serializeToString(d).replaceAll("#","%23").replaceAll(`
`,"%0A")}</foreignObject></svg>`,new Promise(y=>f.onload=()=>y(f))}).then(d=>new Promise(f=>setTimeout(()=>f(d),100))).then(d=>{const f=document.createElement("canvas");f.width=this.#s.$width,f.height=this.#s.$height,f.getContext("2d").drawImage(d,0,0),t(D.from(f))}).catch(d=>Q.myTrace(`goTxt() = ${d}`))}#O=void 0;#$=[];#w=[];#a=0;static#C="<span class='sn_ch sn_ch_last'>&emsp;</span>";goTxt(t,e){_.#B.visible=!1;let s=this.#w.length,i="";if(s===0){if(_.#i.oCfg.debug.masume&&(T.debugLog&&console.log(`🍌 masume ${this.name} v:${this.visible} l:${this.x} t:${this.y} a:${this.alpha} pl:${this.#s.pad_left} pr:${this.#s.pad_right} pt:${this.#s.pad_top} pb:${this.#s.pad_bottom} w:${this.#s.$width} h:${this.#s.$height}`),this.#d.clear().beginFill(3407616,.2).lineStyle(1,3407616,1).drawRect(-this.#s.pad_left,-this.#s.pad_top,this.#s.$width,this.#s.$height).endFill().beginFill(13311,.2).lineStyle(2,13311,1).drawRect(0,0,this.#s.$width-this.#s.pad_left-this.#s.pad_right,this.#s.$height-this.#s.pad_top-this.#s.pad_bottom).endFill()),this.#t.innerHTML=[...t].join("").replaceAll(/[\n\t]/g,"")+_.#C,!this.#o.break_fixed){const y=globalThis.getComputedStyle(this.#t),b=parseFloat(y.fontSize);this.#g?(this.#o.break_fixed_left=(this.#s.$width-this.#s.pad_left-this.#s.pad_right-b*1.5)*this.sys.cvsScale,this.#o.break_fixed_top=0):(this.#o.break_fixed_left=0,this.#o.break_fixed_top=b/2*this.sys.cvsScale)}}else i=this.#t.innerHTML,--s,this.#t.querySelector(".sn_ch_last")?.remove(),this.#t.querySelectorAll(":scope > br").forEach(y=>y.remove()),this.#t.insertAdjacentHTML("beforeend",t.slice(this.#a).join("").replaceAll(/[\n\t]/g,"")+_.#C);this.#t.querySelectorAll(".sn_ch:has(> ruby)").forEach(y=>y.style.background=""),this.#a=t.length;const n=this.sys.cvsScale,h=this.#t.getBoundingClientRect(),a=h.left+this.#s.pad_left,r=h.top+this.#s.pad_top;let c;if(n===1)c=(y,b)=>{const C=y.getBoundingClientRect();return new W(C.left-a,C.top-r,C.width,C.height+("gjqy".includes(b)?this.#y:0))};else{const y=this.sys.ofsPadLeft_Dom2PIXI+h.left*(1-n),b=this.sys.ofsPadTop_Dom2PIXI+h.top*(1-n);c=(C,x)=>{const k=C.getBoundingClientRect();return new W((k.left-y)/n-a,(k.top-b)/n-r,k.width/n,(k.height+("gjqy".includes(x)?this.#y:0))/n)}}const[u,l]=this.#o.hyph(this.#t,c,this.#g,s,i);this.#w=u;const g=T.debugLog?({ch:y},{x:b,y:C,width:x,height:k})=>console.log(`🍌 masume ch:${y} x:${b} y:${C} w:${x} h:${k}`):()=>{},p=_.#i.oCfg.debug.masume?(y,b)=>{g(y,b),this.#d.beginFill(6737151,.5).lineStyle(2,16724736,1).drawRect(b.x,b.y,b.width,b.height).endFill()}:()=>{},o=R.ease(this.#T);for(let y=s;y<l;++y){const b=this.#w[y],C=b.rect,x=JSON.parse(b.elm.dataset.arg??'{"delay": 0}'),k=JSON.parse(b.elm.dataset.add??"{}"),S=_.#E[k.ch_in_style];if(p(b,C),b.elm.dataset.cmd==="grp"){const N=new V;this.#c.addChild(N),new m(x.pic,N,A=>{this.#H(N,x,k,C,o,S??{}),N.parent||N.removeChild(A)})}if(b.elm.dataset.lnk){const N=b.elm.parentElement.closest("[data-arg]"),A=JSON.parse(N.dataset.arg??"{}");A.key=`lnk=[${y}] `+this.name;const F=new P;this.#H(F,A,k,C,o,S??{});const j=A.style??"",at=j+(A.style_hover??""),vt=j+(A.style_clicked??""),Z=A.r_style??"",_t=Z+(A.r_style_hover??""),kt=Z+(A.r_style_clicked??""),pt=Array.from(N.getElementsByTagName("rt"));for(const et of pt)et.dataset.st_r_bk=et.style.cssText;const $t=N.style.cssText,tt=(et,Ct)=>{N.style.cssText=$t+et;for(const ft of pt)ft.style.cssText=ft.dataset.st_r_bk+Ct};E(A,"enabled",!0)?_.#n.button(A,F,()=>tt(j,Z),()=>this.canFocus()?(tt(at,_t),!0):!1,()=>tt(vt,kt)):tt(j+(A.style_disable??"color: gray;"),Z+(A.r_style_disable??"color: gray;")),this.#c.addChild(F)}}const d=Array.from(this.#t.getElementsByClassName("sn_ch"));this.#_=()=>{this.#_=()=>!1;for(const y of d)y.className=y.className.replaceAll(/ go_ch_in_[^\s"]+/g,"");return _.#B.position.set(this.#o.break_fixed_left,this.#o.break_fixed_top),_.#B.visible=!0,this.noticeCompTxt(),!0};for(const y of d)y.className=y.className.replaceAll(/sn_ch_in_([^\s"]+)/g,"go_ch_in_$1");s>0&&++s;let f;for(let y=l-2;y>=0;--y){const{elm:b}=this.#w[y];if(b.tagName==="SPAN"){f=b.parentElement?.tagName==="RUBY"?b.parentElement.parentElement??b:b;break}}if(!f||e||s===l){this.#_();return}f.addEventListener("animationend",()=>this.#_(),{once:!0,passive:!0})}#_=()=>!1;#H(t,e,s,i,n,h){t.alpha=0,e.x&&(i.x=e.x.startsWith("=")?i.x+parseInt(e.x.slice(1)):parseInt(e.x)),e.y&&(i.y=e.y.startsWith("=")?i.y+parseInt(e.y.slice(1)):parseInt(e.y)),e.width&&(i.width=parseInt(e.width)),e.height&&(i.height=parseInt(e.height)),e.wait&&(h.wait=parseInt(e.wait)),t.width=i.width,t.height=i.height,h.x?t.position.set(h.x.startsWith("=")?i.x+t.width*h.nx:h.nx,h.y.startsWith("=")?i.y+t.height*h.ny:h.ny):t.position.set(i.x,i.y);const a={sp:t,tw:new Lt(t).to({alpha:1,x:i.x,y:i.y,width:i.width,height:i.height,angle:0},h.wait??0).easing(n).delay((s.wait??0)+(e.delay??0)).onComplete(()=>{a.tw=void 0}).start()};this.#$.push(a)}skipChIn(){let t=this.#_();for(const e of this.#$)e.tw&&(e.tw.stop().end(),t=!0);return this.#$=[],t}static#E=Object.create(null);static#j=/[\s\.,]/;static initChStyle(){_.#E=Object.create(null),_.#L=Object.create(null)}static getChInStyle(t){return _.#E[t]}static ch_in_style(t){const{name:e}=t;if(!e)throw"nameは必須です";if(_.#j.test(e))throw`name【${e}】に使えない文字が含まれます`;if(e in _.#E)throw`name【${e}】はすでにあります`;const s=String(t.x??"=0"),i=String(t.y??"=0");return _.#E[e]={wait:v(t,"wait",500),alpha:v(t,"alpha",0),x:s,y:i,nx:parseFloat(s.at(0)==="="?s.slice(1):s),ny:parseFloat(i.at(0)==="="?i.slice(1):i),scale_x:v(t,"scale_x",1),scale_y:v(t,"scale_y",1),rotate:v(t,"rotate",0),join:E(t,"join",!0),ease:t.ease??"ease-out"}}static#L=Object.create(null);static getChOutStyle(t){return _.#L[t]}static ch_out_style(t){const{name:e}=t;if(!e)throw"nameは必須です";if(_.#j.test(e))throw`name【${e}】に使えない文字が含まれます`;if(e in _.#L)throw`name【${e}】はすでにあります`;const s=String(t.x??"=0"),i=String(t.y??"=0");return _.#L[e]={wait:v(t,"wait",500),alpha:v(t,"alpha",0),x:s,y:i,nx:parseFloat(s.at(0)==="="?s.slice(1):s),ny:parseFloat(i.at(0)==="="?i.slice(1):i),scale_x:v(t,"scale_x",1),scale_y:v(t,"scale_y",1),rotate:v(t,"rotate",0),join:E(t,"join",!1),ease:t.ease??"ease-out"}}static#B=new V;static#M=new m;dispBreak(t){_.delBreak();const e=_.#B;e.visible=!1,this.addChild(e),_.#M.destroy(),_.#M=new m(t.pic,e,s=>{e.parent?(s.x=v(t,"x",0),s.y=v(t,"y",0),s.width=v(t,"width",this.#s.fontsize),s.height=v(t,"height",this.#s.fontsize)):e.removeChild(s)})}static delBreak(){const t=_.#B;t.parent?.removeChild(t),_.#M.destroy()}#T="Quadratic.Out";#S="Quadratic.Out";#m(){this.#d.clear(),this.#w=[],this.#a=0,this.skipChIn();const t=this.#t.cloneNode(!0);t.textContent="";const e=this.#t;e.parentElement.insertBefore(t,e);let s=0;e.querySelectorAll("span.sn_ch").forEach(n=>{const h=JSON.parse(n?.dataset.add??n?.children[0]?.getAttribute("data-add")??n?.children[0]?.children[0]?.getAttribute("data-add")??"{}");if(!h.ch_out_style)return;const a=_.#L[h.ch_out_style];if(a){if(a.wait===0){n.style.display="none";return}s+=a.wait,a.join||(n.style.animationDelay="0ms"),n.classList.add(`go_ch_out_${h.ch_out_style}`)}});const i=()=>{e.parentElement.removeChild(e);for(const n of this.#c.removeChildren())n instanceof V&&_.#n.unButton(n),n.destroy()};s===0?(this.#t.textContent="",i()):e.lastElementChild?.addEventListener("animationend",i,{once:!0,passive:!0}),this.#t=t}reNew(){this.#m();const t=new _(this.ctn,()=>this.canFocus(),this.sys);return t.#s=this.#s,t.#t.style.cssText=this.#t.style.cssText,t.#p=this.#p,t.name=this.name,t.#l(),t.#O=this.#O,t.#T=this.#T,t.#S=this.#S,this.#o.reNew(t.#o),this.destroy(),t}record(){return{infTL:this.#s,cssText:this.#t.style.cssText,left:this.#p,ch_filter:this.#O,fi_easing:this.#T,fo_easing:this.#S,hyph:this.#o.record()}}playback(t){this.#s=t.infTL,this.position.set(this.#s.pad_left,this.#s.pad_top),this.#t.style.cssText=t.cssText,this.#p=t.left,this.#l(),this.#O=t.ch_filter,this.#T=t.fi_easing,this.#S=t.fo_easing,this.#o.playback(t.hyph)}get cssText(){return this.#t.style.cssText}set cssText(t){this.#t.style.cssText=t}#k=void 0;snapshot(t,e){this.#r(s=>{this.#k=P.from(s),this.#g&&(this.#k.x+=T.stageW-(this.#p+this.#s.$width)),this.#k.y-=this.#x,this.#k.texture.frame=new W(0,0,Math.min(this.#k.width,this.#s.$width-this.#p),Math.min(this.#k.height,this.#s.$height)),this.#c.addChild(this.#k),t.render(this.#k,{clear:!1}),e()},!1)}snapshot_end(){this.#k&&(this.#c.removeChild(this.#k),this.#k=void 0)}makeDesignCast(t){}showDesignCast(){}dump(){const t=[],e=this.#t.style,s=e.length;for(let i=0;i<s;++i){const n=e[i];t.push(`"${n}":"${e[n].replaceAll(/(["\\])/g,"\\$1")}"`)}return`"txt":"${this.#t.textContent.replaceAll(/(["\\])/g,"\\$1")}", "style":{${t.join(",")}}`}destroy(){_.delBreak(),this.#t.parentElement.removeChild(this.#t),this.removeChild(this.#c),this.removeChild(this.#d),super.destroy()}}class I extends V{constructor(t,e,s,i){if(super(),this.hArg=t,this.evtMng=e,this.resolve=s,this.canFocus=i,this.#t={type:"pic",enabled:E(t,"enabled",!0),x:this.x=z(t.left??0),y:this.y=z(t.top??0),rotation:this.angle=v(t,"rotation",this.angle),pivot_x:this.pivot.x=v(t,"pivot_x",this.pivot.x),pivot_y:this.pivot.y=v(t,"pivot_y",this.pivot.y),scale_x:this.scale.x=v(t,"scale_x",this.scale.x),scale_y:this.scale.y=v(t,"scale_y",this.scale.y),alpha:1,text:"",b_pic:"",width:0,height:0},this.getBtnBounds=()=>(this.#n.x=this.#t.x,this.#n.y=this.#t.y,this.#n),this.#t.enabled&&e.button(t,this,()=>this.normal(),()=>this.#d(),()=>this.#u()),t.pic){this.#t.type="pic",this.#h=new m(t.pic,this,l=>{this.#o(l),this.#n.width=l.width*this.#t.scale_x,this.#n.height=l.height*this.#t.scale_y},l=>s);return}if(!t.text)throw"textまたはpic属性は必須です";const n=v(t,"height",30),h=new Tt({align:"center",dropShadow:!0,dropShadowAlpha:.7,dropShadowColor:"white",dropShadowBlur:7,dropShadowDistance:0,fill:this.#t.enabled?"black":"gray",fontFamily:I.fontFamily,fontSize:n,padding:5});if(t.style)try{const l=JSON.parse(t.style);for(const[g,p]of Object.entries(l))h[g]=p;this.#t={...this.#t,...l}}catch(l){throw l instanceof SyntaxError?new Error(ht(t,"style",l.message)):"fn:Button.ts style"}const a=new St(t.text??"",h);a.alpha=v(t,"alpha",a.alpha),a.width=v(t,"width",100),a.height=t.height=n,this.setText=l=>a.text=l,this.#t={...this.#t,type:"text",alpha:a.alpha,text:a.text,width:a.width,height:a.height};let r=!1;if(this.#t.width=this.width,this.#t.height=this.height,t.b_pic&&(this.#t.b_pic=t.b_pic,this.#h=new m(t.b_pic,this,l=>{this.#c(l,a),this.#t.width=this.width,this.#t.height=this.height,a.name=JSON.stringify(this.#t)},l=>{L.setBlendmode(this,t),l&&s()}),r=this.#h.ret),a.name=JSON.stringify(this.#t),this.addChild(a),this.#n.width=a.width,this.#n.height=a.height,t.b_pic||L.setBlendmode(this,t),I.#i(this,a),!this.#t.enabled){r||s();return}const c=h.clone();if(t.style_hover)try{const l=JSON.parse(t.style_hover);for(const[g,p]of Object.entries(l))c[g]=p}catch(l){throw l instanceof SyntaxError?new Error(ht(t,"style_hover",l.message)):"fn:Button.ts style_hover"}else c.fill="white";const u=c.clone();if(t.style_clicked)try{const l=JSON.parse(t.style_clicked);for(const[g,p]of Object.entries(l))u[g]=p}catch(l){throw l instanceof SyntaxError?new Error(ht(t,"style_clicked",l.message)):"fn:Button.ts style_clicked"}else u.dropShadow=!1;this.normal=()=>a.style=h,this.#d=()=>i()?(a.style=c,!0):!1,this.#u=()=>a.style=u,r||s()}static fontFamily="'Hiragino Sans', 'Hiragino Kaku Gothic ProN', '游ゴシック Medium', meiryo, sans-serif";static#i=(t,e)=>{};static#e=(t,e,s,i)=>{};static init(t){t.oCfg.debug.masume&&(I.#i=(e,s)=>e.addChild(new M().beginFill(8926088,.2).lineStyle(1,8926088,1).drawRect(s.x,s.y,s.width,s.height).endFill()),I.#e=(e,s,i,n)=>e.addChild(new M().beginFill(8926088,.2).lineStyle(1,8926088,1).drawRect(s.x,s.y,i,n).endFill()))}setText(t){}getBtnBounds=()=>this.#n;#n=new W;#h=new m;#t;destroy(){this.evtMng.unButton(this),this.#h.destroy(),super.destroy()}makeDesignCast(t){}showDesignCast(){}cvsResize(){}#c(t,e){this.setChildIndex(t,0),t.alpha=e.alpha,t.setTransform(e.x,e.y,1,1,e.rotation,0,0,(t.width-e.width)/2,(t.height-e.height)/2),t.name=e.name}normal=()=>{};#d=()=>!1;#u=()=>{};#o(t){this.#t.alpha=t.alpha=v(this.hArg,"alpha",t.alpha);const e=t.width/3,s=this.#t.enabled?e:t.width,i=t.height,n=t.texture.baseTexture,h=new D(n,new W(0,0,e,i)),a=new D(n,new W(e,0,e,i)),r=new D(n,new W(e*2,0,e,i)),c=()=>t.texture=h;this.#t.enabled&&c(),this.normal=c,this.#d=()=>this.canFocus()?(t.texture=r,!0):!1,this.#u=()=>t.texture=a,"width"in this.hArg?(this.#t.width=z(this.hArg.width),this.scale.x*=this.#t.width/s):this.#t.width=s,"height"in this.hArg?(this.#t.height=z(this.hArg.height),this.scale.y*=this.#t.height/i):this.#t.height=i,t.name=JSON.stringify(this.#t),I.#e(this,t,s,i)}}class w extends L{static#i;static#e;static#n;static#h;static init(t,e,s,i,n,h){w.#i=t,_.init(t,h),w.#e=s,w.#h=i,w.#n=n,s.setDoRecProc(w.chgDoRec),e.autowc=a=>w.#y(a),e.autowc({enabled:!1,text:"",time:0}),e.ch_in_style=a=>w.#t(a),e.ch_out_style=a=>w.#c(a),_.initChStyle(),Nt(),st(t.matchPath(".+",Y.FONT).flatMap(a=>Object.values(a).map(r=>`
@font-face {
	font-family: '${r}';
	src: url('${this.#i.searchPath(r,Y.FONT)}');
}
`)).join("")+`
.sn_tx {
	pointer-events: none;
	user-select: none;
	-webkit-touch-callout: none;
	box-sizing: border-box;
}
.sn_ch {
	position: relative;
	display: inline-block;
}
`),w.#t({name:"default",wait:500,alpha:0,x:"=0.3",y:"=0",scale_x:1,scale_y:1,rotate:0,join:!0,ease:"ease-out"}),w.#c({name:"default",wait:0,alpha:0,x:"=0",y:"=0",scale_x:1,scale_y:1,rotate:0,join:!1,ease:"ease-out"})}static#t(t){const e=_.ch_in_style(t),s=e.x.startsWith("=")?`${e.nx*100}%`:`${e.nx}px`,i=e.y.startsWith("=")?`${e.ny*100}%`:`${e.ny}px`,{name:n}=t;return st(`
.sn_ch_in_${n} {
	position: relative;
	display: inline-block;
}
.go_ch_in_${n} {
	opacity: ${e.alpha};
	position: relative;
	display: inline-block;
	animation: sn_ch_in_${n} ${e.wait}ms ${e.ease} 0s both;
}
@keyframes sn_ch_in_${n} {
	from {transform: rotate(${e.rotate}deg) scale(${e.scale_x}, ${e.scale_y}) translate(${s}, ${i})}
	to {opacity: 1; transform: none;}
}
`),!1}static#c(t){const e=_.ch_out_style(t),s=e.x.startsWith("=")?`${e.nx*100}%`:`${e.nx}px`,i=e.y.startsWith("=")?`${e.ny*100}%`:`${e.ny}px`,{name:n}=t;return st(`
.go_ch_out_${n} {
	position: relative;
	display: inline-block;
	animation: go_ch_out_${n} ${e.wait}ms ${e.ease} 0s both;
}
@keyframes go_ch_out_${n} {
	to {
		opacity: ${e.alpha};
		transform: rotate(${e.rotate}deg) scale(${e.scale_x}, ${e.scale_y}) translate(${s}, ${i});
	}
`),!1}static#d;static#u;static setEvtMng(t,e,s){w.#d=t,w.#u=e,_.setEvtMng(t,s)}static#o=!1;static#s={};static#y(t){w.#o=E(t,"enabled",w.#o),w.#e.setVal_Nochk("save","const.sn.autowc.enabled",w.#o);const{text:e}=t;if("text"in t!="time"in t)throw"[autowc] textとtimeは同時指定必須です";if(w.#e.setVal_Nochk("save","const.sn.autowc.text",e),!e)return w.#e.setVal_Nochk("save","const.sn.autowc.time",""),!1;const s=e.length;if(w.#o&&s===0)throw'[autowc] enabled === false かつ text === "" は許されません';const i=String(t.time).split(",");if(i.length!==s)throw"[autowc] text文字数とtimeに記述された待ち時間（コンマ区切り）は同数にして下さい";w.#s={};for(let n=0;n<s;++n)w.#s[e[n]]=z(i[n]);return w.#e.setVal_Nochk("save","const.sn.autowc.time",t.time),!1}#l=0;#p=0;#g=!1;#f=void 0;#x="";#r=new _(this.ctn,()=>this.canFocus(),w.#u);#O=new lt;#$=document.createElement("span");static#w={"text-align":0,"text-align-last":0,height:0,width:0,"padding-left":0,"padding-right":0,"padding-top":0,"padding-bottom":0};#a=new V;constructor(){super(),this.ctn.addChild(this.#r),this.#O.init(this.#Y),this.ctn.addChild(this.#a),this.#a.name="cntBtn",this.lay({style:`width: ${T.stageW}px; height: ${T.stageH}px; font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', '游ゴシック Medium', meiryo, sans-serif; color: white; font-size: 24px; line-height: 1.5; padding: 16px;`,in_style:"default",out_style:"default",back_clear:"true"})}destroy(){this.#f&&(this.ctn.removeChild(this.#f).destroy(),this.#f=void 0),w.#h.recPagebreak(),this.#r.destroy()}static destroy(){w.#o=!1,w.#s={},w.#v=t=>t}set name(t){this.name_=t,this.#r.name=t}get name(){return this.name_}cvsResize(){this.#r.cvsResize()}cvsResizeChildren(){for(const t of this.#a.children)t.cvsResize()}procSetX(t){this.#r.lay({x:t})}procSetY(t){this.#r.lay({y:t})}lay(t){if(super.lay(t),L.setXY(this.ctn,t,this.ctn),t[":id_tag"]=this.name_.slice(0,-7),lt.setting(t),this.#M(t),this.#r.lay(t),"r_align"in t&&(this.#A=t.r_align??""),this.#D=T.isSafari?this.#r.tategaki?(s,i)=>`text-align: start; height: ${i}em; padding-top: ${s}; padding-bottom: ${s};`:(s,i)=>`text-align: start; width: ${i}em; padding-left: ${s}; padding-right: ${s};`:this.#r.tategaki?s=>`text-align: justify; text-align-last: justify; padding-top: ${s}; padding-bottom: ${s};`:s=>`text-align: justify; text-align-last: justify; padding-left: ${s}; padding-right: ${s};`,T.isFirefox&&(this.#q=this.#Z),"r_style"in t)if(t.r_style){const s=document.createElement("span");s.style.cssText=t.r_style;const i=s.style.length,n=this.#$.style;for(let h=0;h<i;++h){const a=s.style[h];if(a in w.#w){Q.myTrace(`${a}は指定できません`,"W");continue}const r=s.style[a];r&&(n[a]=r)}}else this.#$.style.cssText="";if("alpha"in t)for(const s of this.#a.children)s.alpha=this.ctn.alpha;this.#C(t),this.#E(t);const e=this.#B(t,s=>{s&&J()});return e&&q(),e}#C(t){const{in_style:e}=t;if(!e)return;const s=_.getChInStyle(e);if(!s)throw`存在しないin_style【${e}】です`;this.#_=e,this.#H=s.join}#_="";#H=!0;get width(){return this.#r.getWidth}get height(){return this.#r.getHeight}#E(t){const{out_style:e}=t;if(e){if(!_.getChOutStyle(e))throw`存在しないout_style【${e}】です`;this.#j=e}}#j="";#L=new m;#B(t,e){if("back_clear"in t)return E(t,"back_clear",!1)&&(this.#l=0,this.#p=0,this.#g=!1,this.#x=""),e(!1),!1;this.#p=v(t,"b_alpha",this.#p),this.#g=E(t,"b_alpha_isfixed",this.#g);const s=(this.#g?1:Number(w.#e.getVal("sys:TextLayer.Back.Alpha")))*this.#p;if(t.b_pic){if(this.#x!==t.b_pic)return this.#x=t.b_pic,this.#f&&(this.ctn.removeChild(this.#f),this.#f.destroy()),this.#L=new m(this.#x,this.ctn,i=>{this.#f=i,i.name="back(pic)",i.visible=s>0,i.alpha=s,this.#r.setMySize(i.width,i.height),this.ctn.setChildIndex(i,0),e(!0)}),this.#L.ret}else"b_color"in t&&(this.#l=mt(t,"b_color",0),this.#f&&(this.ctn.removeChild(this.#f),this.#f.destroy()),this.#x="",this.ctn.addChildAt((this.#f=new M).beginFill(this.#l).lineStyle(void 0).drawRect(0,0,this.#r.getWidth,this.#r.getHeight).endFill(),0),this.#f.name="back(color)");return this.#f&&(this.#f.visible=s>0,this.#f.alpha=s),e(!1),!1}chgBackAlpha(t){const e=this.#g?this.#p:t*this.#p;this.#f instanceof M&&(this.#f&&(this.ctn.removeChild(this.#f),this.#f.destroy()),this.ctn.addChildAt((this.#f=new M).beginFill(this.#l).lineStyle(void 0).drawRect(0,0,this.#r.getWidth,this.#r.getHeight).endFill(),0),this.#f.name="back(color)"),this.#f&&(this.#f.visible=e>0,this.#f.alpha=e)}#M(t){"noffs"in t&&(this.#m=t.noffs??"",this.#k=new RegExp(`[　${this.#m}]`)),"ffs"in t&&(this.#T??="",this.#S=this.#T===""?()=>"":e=>this.#k.test(e)?"":` font-feature-settings: ${this.#T};`)}#T="";#S=t=>"";#m="";#k=/[　]/;static chgDoRec(t){w.#v=t?e=>e:e=>`<span class='offrec'>${e}</span>`}static#v=t=>t;isCur=!1;#D=()=>"";#q=(t,e,s,i="")=>{if(!s)return` style='${i}'`;const n=t.length*2;if(n-e.length<0)return` style='text-align: ${s}; ${i}'`;let h="";switch(s){case"justify":h=this.#D("0",n);break;case"121":h=this.#D(`calc(${(n-e.length)/(e.length*2)}em)`,n);break;case"even":h=this.#D(`calc(${(n-e.length)/(e.length+1)}em)`,n);break;case"1ruby":h=this.#D("1em",n);break;default:h=`text-align: ${s};`}return` style='${h} ${i}'`};#A="";#Z(t,e,s,i=""){if(!s)return` style='${i}'`;const n=t.length*2;if(n-e.length<0)return` style='text-align: ${s}; ${i}'`;let h="";switch(s){case"left":h="ruby-align: start;";break;case"center":h="ruby-align: center;";break;case"right":h="ruby-align: start;";break;case"justify":h="ruby-align: space-between;";break;case"121":h="ruby-align: space-around;";break;case"even":const a=(n-e.length)/(e.length+1);h="ruby-align: space-between; "+(this.#r.tategaki?`padding-top: ${a}em; padding-bottom: ${a}em;`:`padding-left: ${a}em; padding-right: ${a}em;`);break;case"1ruby":h="ruby-align: space-between; "+(this.#r.tategaki?"padding-top: 1em; padding-bottom: 1em;":"padding-left: 1em; padding-right: 1em;");break;default:h=`text-align: ${s};`}return` style='${h} ${i}'`}tagCh(t){this.#O.putTxt(t)}#P=!1;#Y=(t,e)=>{w.#i.oCfg.debug.putCh&&console.log(`🖊 文字表示 text:\`${t}\`(${t.charCodeAt(0).toString(16)}) ruby:\`${e}\` name:\`${this.name_}\``);const s=e.split("｜");let i="";const[n,...h]=s,a=h.join("｜");switch(s.length){case 1:if(this.#P=!0,t===`
`){this.#F?(this.#F=!1,i="<ruby>&emsp;<rt>&emsp;</rt></ruby><br/>"):i="<br/>";break}this.#F&&(this.#F=!1,e===""&&(e="&emsp;")),i=this.#G(t,e,this.#A);break;default:switch(n){case"start":case"left":case"center":case"right":case"justify":case"121":case"even":case"1ruby":this.#F=!1,this.#P=!0,i=this.#G(t,a,n);break;case"gotxt":this.#X(),this.#P?(this.isCur&&w.#h.recText(this.#N.join("").replace(/^<ruby>&emsp;<rt>&emsp;<\/rt><\/ruby>(<br\/>)+/,"").replaceAll(/style='(anim\S+ \S+?;\s*)+/g,"style='").replaceAll(/( style=''| data-(add|arg|cmd)='.+?'|\n+|\t+)/g,"").replaceAll(/class='sn_ch .+?'/g,"class='sn_ch'").replaceAll("display: none;","").replaceAll("class='offrec'","style='display: none;'")),this.#r.goTxt(this.#N,this.#V===0),this.#P=!1,this.#V=0):this.isCur&&this.#r.noticeCompTxt();return;case"add":{const r=JSON.parse(a),{style:c="",wait:u=null}=r,{cl:l,sty:g}=this.#z(!0,u);this.#N.push(`<span${l} style='${g} display: inline; ${c}'>`),delete r.style,this.#K(r)}return;case"add_close":this.#N.push("</span>"),this.#X();return;case"grp":this.#P=!0;{const r=JSON.parse(a);if(r.id??=this.#N.length,r.id==="break"){this.#r.dispBreak(r);return}this.#F=!1,r.delay=this.#V,r.r??="",r.style??="",r.r_style??="";const{cl:c,sty:u,lnk:l}=this.#z(!0,r.wait);i=`<span${c} style='${u} ${r.style}'><ruby><span data-cmd='grp' data-arg='${JSON.stringify(r)}'${l} style='${u} display: inline;'>&emsp;</span><rt${l}${this.#q("　",r.r,this.#A,this.#$.style.cssText+(this.#b.at(-1)?.o.r_style??"")+r.r_style)}>${r.r}</rt></ruby></span>`}break;case"tcy":this.#F=!1,this.#P=!0;{const{t:r,r:c="",wait:u=null,style:l="",r_style:g=""}=JSON.parse(a);w.#e.doRecLog()&&(this.#I+=t+(e?`《${e}》`:""),this.#W+=r);const p=T.isSafari?c.replaceAll(/[A-Za-z0-9]/g,y=>String.fromCharCode(y.charCodeAt(0)+65248)):c,{cl:o,sty:d,lnk:f}=this.#z(!0,u);i=`<span${o} style='${d}${this.#S(r)} ${l}'><ruby><span${f} style='${d} display: inline; text-combine-upright: all;'>${r}</span><rt${f}${this.#q(r,p,this.#A,this.#$.style.cssText+(this.#b.at(-1)?.o.r_style??"")+g)}>${p}</rt></ruby></span>`}break;case"del":_.delBreak();return;case"span":this.#P=!0,this.#Q(JSON.parse(a));return;case"link":this.#P=!0;{const r=JSON.parse(a);r[":link"]=" data-lnk='@'";const{cl:c,sty:u,curpos:l}=this.#z(!1,r.wait);this.#N.push(`<span${c} style='${u} display: inline; ${r.style??""}' ${l} data-arg='${a}'>`),delete r.style,this.#Q(r)}return;case"endlink":this.#P=!0,this.#N.push("</span>"),this.#X();return;default:this.#P=!0,i=this.#G(t,e,this.#A)}break}this.#N.push(w.#v(i))};#G(t,e,s){const i=t===" "?"&nbsp;":t==="　"?"&emsp;":t;w.#e.doRecLog()&&(this.#I+=i+(e?`《${e}》`:""),t!==" "&&(this.#W+=t));const{cl:n,sty:h,lnk:a}=this.#z(!0,null,t);return e?`<span${n} style='${h} ${this.#S(t)}'><ruby>${Array.from(t).map((r,c)=>`<span${n}${a} style='${c>0?this.#z(!0,null,t).sty:h} display: inline;'>${r===" "?"&nbsp;":r==="　"?"&emsp;":r}</span>`).join("")}<rt${a}${this.#q(t,e,s,this.#$.style.cssText+(this.#b.at(-1)?.o.r_style??""))}>${e}</rt></ruby></span>`:`<span${n} style='${h} ${this.#S(t)}'${a}>${i}</span>`}#z(t,e,s=`
`){const i=this.#H?e??this.#b.at(0)?.o.wait??(w.#o?w.#s[s.at(0)??""]??0:H.msecChWait):0;w.#d.isSkipping?this.#V=0:t&&this.#H&&(this.#V+=Number(i));const n=`data-add='{"ch_in_style":"${this.#_}", "ch_out_style":"${this.#j}"}'`;return{cl:` class='sn_ch sn_ch_in_${this.#_}'`,sty:`animation-delay: ${this.#V}ms;${this.#b.at(-1)?.o.style??""}`,lnk:(this.#b.at(0)?.o[":link"]??"")+" "+n,curpos:n}}#V=0;#F=!0;#N=[];#b=[];#K(t){this.#b.push({o:t,r_align:this.#A,ch_in_style:this.#_,ch_out_style:this.#j}),"r_align"in t&&(this.#A=t.r_align),this.#C(t),this.#E(t)}#X(){const t=this.#b.pop();t&&(this.#A=t.r_align,this.#C({in_style:t.ch_in_style}),this.#E({out_style:t.ch_out_style}))}#Q(t){const e=this.#b.at(-1);if(!e){this.#K(t);return}e.o={...e.o,...t},!t.style&&!t.r_style&&(e.o.style="",e.o.r_style=""),"r_align"in t&&(this.#A=t.r_align),this.#C(t),this.#E(t)}click=()=>!this.ctn.interactiveChildren||!this.ctn.visible?!1:this.#r.skipChIn();clearText(){this.ctn.addChild(this.#r=this.#r.reNew()),this.#V=0,this.#F=!0,this.#N=[],this.#I="",this.#W="",w.#h.recPagebreak()}#I="";#W="";get pageText(){return this.#I.replace("《&emsp;》","")}get pagePlainText(){return this.#W}get enabled(){return this.ctn.interactiveChildren}set enabled(t){this.ctn.interactiveChildren=t}addButton=t=>new Promise(e=>{t.key=`btn=[${this.#a.children.length}] `+this.name_,t[":id_tag"]=t.key.slice(0,-7),E(t,"hint_tate",this.#r.tategaki);const s=new I(t,w.#d,()=>e(),()=>this.canFocus());s.name=JSON.stringify(t).replaceAll('"',"'"),this.#a.addChild(s)});canFocus(){return(this.ctn.interactiveChildren??!1)&&this.ctn.visible&&w.#n(this)}clearLay(t){super.clearLay(t),this.clearText();for(const e of this.#a.removeChildren())e.destroy()}record=()=>({...super.record(),enabled:this.enabled,r_cssText:this.#$.style.cssText,r_align:this.#A,b_do:this.#f===void 0?void 0:this.#f instanceof P?"Sprite":"Graphics",b_pic:this.#x,b_color:this.#l,b_alpha:this.#p,b_alpha_isfixed:this.#g,ffs:this.#T,txs:this.#r.record(),strNoFFS:this.#m,btns:this.#a.children.map(t=>t.name)});playback(t,e){super.playback(t,e),this.enabled=t.enabled,this.#$.style.cssText=t.r_cssText,this.#A=t.r_align,this.cvsResize(),this.#M(t),this.#r.playback(t.txs),this.#p=t.b_alpha,this.#g=t.b_alpha_isfixed,e=[e,new Promise(s=>{const i=t.b_do?t.b_do==="Sprite"?{b_pic:t.b_pic}:{b_color:t.b_color}:{b_pic:""};i.b_alpha=t.b_alpha,i.b_alpha_isfixed=t.b_alpha_isfixed,this.#B(i,n=>{n&&s()})||s()}),t.btns.map(s=>new Promise(i=>{this.addButton(JSON.parse(s.replaceAll("'",'"'))),i()}))].flat()}get cssText(){return this.#r.cssText}set cssText(t){this.#r.cssText=t}snapshot(t,e){t.render(this.ctn,{clear:!1}),this.#r.snapshot(t,e)}snapshot_end(){this.#r.snapshot_end()}makeDesignCast(t){this.ctn.visible&&this.#r.makeDesignCast(t)}makeDesignCastChildren(t){if(this.ctn.visible)for(const e of this.#a.children)e.makeDesignCast(t)}showDesignCast(){this.#r.showDesignCast()}showDesignCastChildren(){for(const t of this.#a.children)t.showDesignCast()}dump(){return this.#Y("","gotxt｜"),super.dump()+`, "enabled":"${this.enabled}", ${this.#r.dump()}, "b_pic":"${this.#x}", "b_color":"${this.#l}", "b_alpha":${this.#p}, "b_alpha_isfixed":"${this.#g}", "width":${this.#r.getWidth}, "height":${this.#r.getHeight}, "pixi_obj":[${this.ctn.children.map(t=>`{"class":"${t instanceof P?"Sprite":t instanceof M?"Graphics":t instanceof V?"Container":"?"}", "name":"${t.name}", "alpha":${t.alpha}, "x":${t.x}, "y":${t.y}, "visible":"${t.visible}"}`).join(",")}], "button":[${this.#a.children.map(t=>t.children[0]?.name??"{}").join(",")}]`}}class ${constructor(t,e,s){this.appPixi=e,this.val=s,t.add_frame=i=>this.#d(i),t.let_frame=i=>this.#p(i),t.set_frame=i=>this.#g(i),t.frame=i=>this.#x(i),t.tsy_frame=i=>this.#r(i)}static#i;static#e;static#n;static init(t,e,s){$.#i=t,$.#e=e,$.#n=s}#h;setEvtMng(t){this.#h=t}#t=Object.create(null);destroy(){for(const t of Object.values(this.#t))t.parentElement.removeChild(t);this.#t=Object.create(null)}hideAllFrame(){for(const[t,{style:e}]of Object.entries(this.#t))this.#c[t]=e.display!=="none",e.display="none"}#c=Object.create(null);restoreAllFrame(){for(const[t,e]of Object.entries(this.#c)){const s=this.#t[t];s&&(s.style.display=e?"inline":"none")}this.#c=Object.create(null)}#d(t){const{id:e,src:s,alpha:i=1,scale_x:n=1,scale_y:h=1,rotate:a=0}=t;if(!e)throw"idは必須です";if(!s)throw"srcは必須です";const r="const.sn.frm."+e;if(this.val.getVal(`tmp:${r}`))throw`frame【${e}】はすでにあります`;const c=E(t,"visible",!0),u=t.b_color?` background-color: ${t.b_color};`:"",l=this.#o(t);$.#n.cvs.insertAdjacentHTML("beforebegin",`<iframe id="${e}" style="opacity: ${i}; ${u} position: absolute; left:${$.#e.ofsLeft4elm+l.x*$.#e.cvsScale}px; top: ${$.#e.ofsTop4elm+l.y*$.#e.cvsScale}px; z-index: 1; border: 0px; overflow: hidden; display: ${c?"inline":"none"}; transform: scale(${n}, ${h}) rotate(${a}deg);" width="${l.width*$.#e.cvsScale}" height="${l.height*$.#e.cvsScale}"></iframe>`),q();const g=$.#i.searchPath(s,Y.HTML),p=new U().add({name:s,url:g,xhrType:O.XHR_RESPONSE_TYPE.TEXT});return $.#e.arg.crypto&&p.use(async(o,d)=>{try{o.data=await $.#e.dec(o.extension,o.data)}catch(f){$.#n.errScript(`[add_frame]Html ロード失敗です src:${o.name} ${f}`,!1)}d()}),p.load((o,d)=>{const f=document.getElementById(e);this.#t[e]=f,this.#u[e]=!1;const y=g.lastIndexOf("/")+1,b=g.slice(0,y),C=b.slice(0,y);f.srcdoc=String(d[s]?.data).replace("sn_repRes();","").replaceAll(/\s(?:src|href)=(["'])(\S+?)\1/g,(x,k,S)=>S.startsWith("../")?x.replace("../",C):x.replace("./","").replace(k,k+b)),f.srcdoc.includes("true/*WEBP*/;")&&(f.srcdoc=f.srcdoc.replaceAll(/data-src="(.+?\.)(?:jpe?g|png)/g,(x,k)=>`data-src="${k}webp`)),f.onload=()=>{this.val.setVal_Nochk("tmp",r,!0),this.val.setVal_Nochk("tmp",r+".alpha",i),this.val.setVal_Nochk("tmp",r+".x",l.x),this.val.setVal_Nochk("tmp",r+".y",l.y),this.val.setVal_Nochk("tmp",r+".scale_x",n),this.val.setVal_Nochk("tmp",r+".scale_y",h),this.val.setVal_Nochk("tmp",r+".rotate",a),this.val.setVal_Nochk("tmp",r+".width",l.width),this.val.setVal_Nochk("tmp",r+".height",l.height),this.val.setVal_Nochk("tmp",r+".visible",c);const x=f.contentWindow;this.#h.resvFlameEvent(x),x.sn_repRes?.(k=>$.#s(k.dataset.src??"",k)),J()}}),!0}#u={};getFrmDisabled(t){return this.#u[t]}#o(t){const e={...t},s=$.#e.resolution;return new DOMRect(v(e,"x",0)*s,v(e,"y",0)*s,v(e,"width",T.stageW)*s,v(e,"height",T.stageH)*s)}static#s(t,e,s){const i=this.#l[t];if(i){e.src=i,s&&(e.onload=()=>s(e));return}const n=this.#y[t];if(n){n.push(e);return}this.#y[t]=[e];const[h="",a=""]=t.split("?"),r=$.#i.searchPath(h,Y.SP_GSM),c=new U().add({name:t,url:r,xhrType:O.XHR_RESPONSE_TYPE.BUFFER});$.#e.arg.crypto&&Ot(r)==="bin"&&c.use(async(u,l)=>{try{const g=await $.#e.decAB(u.data);if(u.extension!=="bin"){l();return}u.data=g,g instanceof HTMLImageElement&&(u.type=O.TYPE.IMAGE)}catch(g){$.#n.errScript(`GrpLayer loadPic ロード失敗です fn:${u.name} ${g}`,!1)}l()}),c.load((u,l)=>{for(const[g,{data:{src:p}}]of Object.entries(l)){const o=this.#l[g]=p+(p.startsWith("blob:")?"":(a?"?":"")+a),d=this.#y[g];if(d)for(const f of d)f.src=o,s&&(f.onload=()=>s(f));delete this.#y[g]}})}static#y={};static#l={};cvsResize(){for(const[t,e]of Object.entries(this.#t)){const s="const.sn.frm."+t,i=Number(this.val.getVal(s+".x")),n=Number(this.val.getVal(s+".y")),h=Number(this.val.getVal(s+".width")),a=Number(this.val.getVal(s+".height"));e.style.left=`${$.#e.ofsLeft4elm+i*$.#e.cvsScale}px`,e.style.top=`${$.#e.ofsTop4elm+n*$.#e.cvsScale}px`,e.width=String(h*$.#e.cvsScale),e.height=String(a*$.#e.cvsScale)}}#p(t){const{id:e,var_name:s}=t;if(!e)throw"idは必須です";const i=document.getElementById(e);if(!i)throw`id【${e}】はフレームではありません`;const n="const.sn.frm."+e;if(!this.val.getVal(`tmp:${n}`))throw`frame【${e}】が読み込まれていません`;if(!s)throw"var_nameは必須です";const h=i.contentWindow;if(!h.hasOwnProperty(s))throw`frame【${e}】に変数/関数【${s}】がありません。変数は var付きにして下さい`;const a=h[s];return this.val.setVal_Nochk("tmp",n+"."+s,E(t,"function",!1)?a():a),!1}#g(t){const{id:e,var_name:s,text:i}=t;if(!e)throw"idは必須です";const n=document.getElementById(e);if(!n)throw`id【${e}】はフレームではありません`;const h="const.sn.frm."+e;if(!this.val.getVal(`tmp:${h}`))throw`frame【${e}】が読み込まれていません`;if(!s)throw"var_nameは必須です";if(!i)throw"textは必須です";this.val.setVal_Nochk("tmp",h+"."+s,i);const a=n.contentWindow;return a[s]=i,!1}#f=1;#x(t){const{id:e}=t;if(!e)throw"idは必須です";const s=document.getElementById(e);if(!s)throw`id【${e}】はフレームではありません`;const i="const.sn.frm."+e;if(!this.val.getVal("tmp:"+i))throw`frame【${e}】が読み込まれていません`;const n=s.style;if(E(t,"float",!1)?n.zIndex=`${++this.#f}`:"index"in t?n.zIndex=`${v(t,"index",0)}`:t.dive&&(n.zIndex=`-${++this.#f}`),"alpha"in t){const a=n.opacity=String(t.alpha);this.val.setVal_Nochk("tmp",i+".alpha",a)}const h=this.#o(t);if(("x"in t||"y"in t)&&(n.left=`${$.#e.ofsLeft4elm+h.x*$.#e.cvsScale}px`,n.top=`${$.#e.ofsTop4elm+h.y*$.#e.cvsScale}px`,this.val.setVal_Nochk("tmp",i+".x",h.x),this.val.setVal_Nochk("tmp",i+".y",h.y)),"scale_x"in t||"scale_y"in t||"rotate"in t){const a=v(t,"scale_x",1),r=v(t,"scale_y",1),c=v(t,"rotate",0);n.transform=`scale(${a}, ${r}) rotate(${c}deg)`,this.val.setVal_Nochk("tmp",i+".scale_x",a),this.val.setVal_Nochk("tmp",i+".scale_y",r),this.val.setVal_Nochk("tmp",i+".rotate",c)}if("width"in t&&(s.width=String(h.width*$.#e.cvsScale),this.val.setVal_Nochk("tmp",i+".width",h.width)),"height"in t&&(s.height=String(h.height*$.#e.cvsScale),this.val.setVal_Nochk("tmp",i+".height",h.height)),"visible"in t){const a=E(t,"visible",!0);n.display=a?"inline":"none",this.val.setVal_Nochk("tmp",i+".visible",a)}if("b_color"in t&&(n.backgroundColor=t.b_color),"disabled"in t){const a=this.#u[e]=E(t,"disabled",!0),r=s.contentDocument.body;for(const c of[...Array.from(r.getElementsByTagName("input")),...Array.from(r.getElementsByTagName("select"))])c.disabled=a}return!1}#r(t){const{id:e,alpha:s,x:i,y:n,scale_x:h,scale_y:a,rotate:r,width:c,height:u}=t;if(!e)throw"idは必須です";const l=document.getElementById(e);if(!l)throw`id【${e}】はフレームではありません`;const g="const.sn.frm."+e;if(!this.val.getVal(`tmp:${g}`,0))throw`frame【${e}】が読み込まれていません`;const p={};s&&(p.a=l.style.opacity),(i||n||h||a||r)&&(p.x=Number(this.val.getVal(`tmp:${g}.x`)),p.y=Number(this.val.getVal(`tmp:${g}.y`)),p.sx=Number(this.val.getVal(`tmp:${g}.scale_x`)),p.sy=Number(this.val.getVal(`tmp:${g}.scale_y`)),p.r=Number(this.val.getVal(`tmp:${g}.rotate`))),c&&(p.w=this.val.getVal(`tmp:${g}.width`)),u&&(p.h=this.val.getVal(`tmp:${g}.height`));const o=R.cnvTweenArg(t,p);let d=()=>{};s&&(v(o,"alpha",0),d=()=>{l.style.opacity=p.a,this.val.setVal_Nochk("tmp","alpha",p.a)});let f=()=>{};const y=this.#o(o);(i||n||h||a||r)&&(y.x,y.y,v(o,"scale_x",1),v(o,"scale_y",1),v(o,"rotate",0),f=()=>{l.style.left=$.#e.ofsLeft4elm+p.x*$.#e.cvsScale+"px",l.style.top=$.#e.ofsTop4elm+p.y*$.#e.cvsScale+"px",l.style.transform=`scale(${p.sx}, ${p.sy}) rotate(${p.r}deg)`,this.val.setVal_Nochk("tmp",g+".x",p.x),this.val.setVal_Nochk("tmp",g+".y",p.y),this.val.setVal_Nochk("tmp",g+".scale_x",p.sx),this.val.setVal_Nochk("tmp",g+".scale_y",p.sy),this.val.setVal_Nochk("tmp",g+".rotate",p.r)});let b=()=>{};c&&(y.width,b=()=>{l.width=p.w*$.#e.cvsScale+"px",this.val.setVal_Nochk("tmp",g+".width",p.w)});let C=()=>{};return u&&(y.height,C=()=>{l.height=p.h*$.#e.cvsScale+"px",this.val.setVal_Nochk("tmp",g+".height",p.h)}),this.appPixi.stage.interactive=!1,R.tween(`frm
${e}`,t,p,R.cnvTweenArg(t,p),()=>{d(),f(),b(),C()},()=>this.appPixi.stage.interactive=!0,()=>{}),!1}}class H{constructor(t,e,s,i,n,h,a,r,c){this.cfg=t,this.hTag=e,this.appPixi=s,this.val=i,this.main=n,this.scrItr=h,this.sys=a,this.sndMng=r,this.prpPrs=c;const u=()=>{if(a.cvsResize(),this.cvsResizeDesign(),this.#o)for(const o of this.#C)this.#a[o].fore.cvsResizeChildren();else for(const o of this.#C)this.#a[o].fore.cvsResize();this.#h.cvsResize(),this.#l.cvsResize()};if(T.isMobile)this.#c.add(globalThis,"orientationchange",u,{passive:!0});else{let o;this.#c.add(globalThis,"resize",()=>{o||(o=setTimeout(()=>{o=void 0,u()},1e3/60*10))},{passive:!0})}a.cvsResize(),w.init(t,e,i,this,o=>this.#a[o.layname].fore===o,s),B.init(n,t,s,a,r,i),$.init(t,a,n),I.init(t),this.#h=new $(e,s,i),a.hFactoryCls.grp=()=>new B,a.hFactoryCls.txt=()=>new w,e.loadplugin=o=>this.#$(o),e.snapshot=o=>this.#f(o),this.#x=this.sys.isApp?this.#r:this.#O,e.add_lay=o=>this.#w(o),e.clear_lay=o=>this.#L(o),e.finish_trans=()=>R.finish_trans(),e.lay=o=>this.#E(o),e.trans=o=>this.#k(o),e.wt=o=>R.wt(o),e.quake=o=>this.#A(o),e.stop_quake=e.finish_trans,e.wq=o=>e.wt(o),e.pause_tsy=o=>R.pause_tsy(o),e.resume_tsy=o=>R.resume_tsy(o),e.stop_tsy=o=>R.stop_tsy(o),e.tsy=o=>this.#Z(o),e.wait_tsy=o=>R.wait_tsy(o),e.add_filter=o=>this.#P(o),e.clear_filter=o=>this.#G(o),e.enable_filter=o=>this.#z(o),e.ch=o=>this.#N(o),e.clear_text=o=>this.#et(o),e.current=o=>this.#X(o),e.endlink=o=>this.#st(o),e.er=o=>this.#it(o),e.graph=o=>this.#nt(o),e.link=o=>this.#at(o),e.r=o=>this.#ht(o),e.rec_ch=o=>this.#tt(o),e.rec_r=o=>this.#rt(o),e.reset_rec=o=>this.#ot(o),e.ruby2=o=>this.#lt(o),e.span=o=>this.#ct(o),e.tcy=o=>this.#dt(o),e.add_face=o=>m.add_face(o),e.wv=o=>m.wv(o),e.dump_lay=o=>this.#pt(o),e.enable_event=o=>this.#ft(o),e.button=o=>this.#gt(o),t.existsBreakline&&(this.breakLine=o=>{delete o.visible,o.id="break",o.pic="breakline";const d=encodeURIComponent(JSON.stringify(o));this.#g("grp｜"+d)}),t.existsBreakpage&&(this.breakPage=o=>{delete o.visible,o.id="break",o.pic="breakpage";const d=encodeURIComponent(JSON.stringify(o));this.#g("grp｜"+d)}),this.#t=Et(String(t.oCfg.init.bg_color));const l=new M;l.beginFill(this.#t,1).lineStyle(0,this.#t).drawRect(0,0,T.stageW,T.stageH).endFill(),this.#e.addChild(l.clone()),this.#n.addChild(l),this.#n.visible=!1,this.#e.name="page:A",this.#n.name="page:B",this.#i=s.stage,this.#i.addChild(this.#n),this.#i.addChild(this.#e),this.#i.addChild(this.#T),this.#i.addChild(this.#m),this.#i.name="stage";const g=(o,d)=>{this.#p(Number(d))};g("",i.getVal("sys:TextLayer.Back.Alpha",1)),i.defValTrg("sys:TextLayer.Back.Alpha",g);const p=(o,d)=>I.fontFamily=d;p("",i.getVal("tmp:sn.button.fontFamily",I.fontFamily)),i.defValTrg("tmp:sn.button.fontFamily",p),i.defTmp("const.sn.log.json",()=>JSON.stringify((this.#R.text=this.#R.text?.replaceAll("</span><span class='sn_ch'>","")??"")?[...this.#U,this.#R]:this.#U)),i.defTmp("const.sn.last_page_text",()=>this.currentTxtlayFore?.pageText??""),i.defTmp("const.sn.last_page_plain_text",()=>this.currentTxtlayFore?.pagePlainText??""),T.isDbg&&(ct.init(s,a,h,c,t,this.#a),this.cvsResizeDesign=()=>ct.cvsResizeDesign(),a.addHook((o,d)=>{this.#d[o]?.(o,d)&&delete this.#d[o]}))}#i;#e=new V;#n=new V;#h;#t;#c=new bt;cvsResizeDesign(){}#d={attach:t=>!1,continue:t=>!1,disconnect:t=>!1,_enterDesign:t=>{for(const e of this.#C){const s=this.#a[e].fore;s.makeDesignCastChildren(i=>i.make()),s.makeDesignCast(i=>i.make())}return this.#s(this.#_),!1},_replaceToken:(t,e)=>!1,_selectNode:(t,e)=>(this.#s(e.node),!1)};#u="";#o="";#s(t){[this.#u="",this.#o=""]=t.split("/");const e=this.#a[this.#u];e&&(this.#o?e.fore.showDesignCastChildren():e.fore.showDesignCast())}getFrmDisabled=t=>this.#h.getFrmDisabled(t);#y=void 0;cover(t,e=0){this.#y&&(this.#i.removeChild(this.#y),this.#y.destroy(),this.#y=void 0),t&&this.#i.addChild((this.#y=new M).beginFill(e).lineStyle(0,e).drawRect(0,0,T.stageW,T.stageH).endFill())}#l;setEvtMng(t){this.#l=t,this.#h.setEvtMng(t),m.setEvtMng(t),R.init(t,this.appPixi)}destroy(){for(const t of Object.values(this.#a))t.destroy();this.#c.clear(),B.destroy(),lt.destroy(),_.destroy(),w.destroy(),this.#h.destroy(),R.destroy(),H.#F=10}#p(t){for(const e of this.#v()){const s=this.#a[e];s.fore instanceof w&&(s.fore.chgBackAlpha(t),s.back.chgBackAlpha(t))}}#g=(t,e=this.currentTxtlayForeNeedErr,s=!0)=>e.tagCh("｜&emsp;《"+t+"》");goTxt=()=>{};breakLine=t=>{};breakPage=t=>{};clearBreak(){this.currentTxtlayFore&&(this.clearBreak=()=>this.#g("del｜break"),this.clearBreak())}clickTxtLay(){return this.currentTxtlayFore?this.#v().some(t=>{const e=this.#a[t].fore;return e instanceof w&&e.click()}):!1}#f(t){const e=t.fn?t.fn.startsWith("userdata:/")?t.fn:`downloads:/${t.fn+gt("-","_","","_")}.png`:`downloads:/snapshot${gt("-","_","","_")}.png`,s=this.cfg.searchPath(e),i=v(t,"width",T.stageW),n=v(t,"height",T.stageH);return this.#x(t,s,i,n)}#x=()=>!1;#r(t,e,s,i){if(this.#h.hideAllFrame(),q(),!("layer"in t))return this.sys.capturePage(e,s,i,()=>{this.#h.restoreAllFrame(),J()}),!0;const n={};for(const h of this.#v()){const a=this.#a[h].fore.ctn;n[h]=a.visible,a.visible=!1}for(const h of this.#v(t.layer))this.#a[h].fore.ctn.visible=!0;return this.sys.capturePage(e,s,i,()=>{for(const[h,a]of Object.entries(n))this.#a[h].fore.ctn.visible=a;this.#h.restoreAllFrame(),J()}),!0}#O(t,e,s,i){q();const n=mt(t,"b_color",this.#t),h=At({width:s,height:i,backgroundAlpha:n>16777216&&e.endsWith(".png")?0:1,antialias:E(t,"smoothing",!1),preserveDrawingBuffer:!0,backgroundColor:n&16777215,autoDensity:!0}),a=t.page!=="back"?"fore":"back";return Promise.allSettled(this.#v(t.layer).map(r=>new Promise(c=>this.#a[r][a].snapshot(h,c)))).then(async()=>{const r=X.create({width:h.width,height:h.height});h.render(this.#i,{renderTexture:r}),await this.sys.savePic(e,h.plugins.extract.base64(r)),r.destroy();for(const c of this.#v(t.layer))this.#a[c][a].snapshot_end();h.destroy(!0),J()}),!0}#$(t){const{fn:e}=t;if(!e)throw"fnは必須です";const s=E(t,"join",!0);if(s&&q(),e.endsWith(".css"))(async()=>{const i=await fetch(e);if(!i.ok)throw new Error("Network response was not ok.");st(await i.text()),s&&J()})();else throw"サポートされない拡張子です";return s}#w(t){const{layer:e,class:s}=t;if(!e)throw"layerは必須です";if(e.includes(","))throw"layer名に「,」は使えません";if(e in this.#a)throw`layer【${e}】はすでにあります`;if(!s)throw"clsは必須です";const i={isWait:!1};switch(this.#a[e]=new G(e,s,this.#e,this.#n,t,this.sys,this.val,i),this.#C.push(e),s){case"txt":this.#_||(this.#W=()=>{},this.#b=this.#K,this.#X=this.#Q,this.hTag.current({layer:e}),this.goTxt=()=>{this.#l.isSkipping?H.#F=0:this.setNormalChWait();for(const n of this.#v()){const h=this.#a[n].fore;h instanceof w&&this.#g("gotxt｜",h,!1)}}),this.val.setVal_Nochk("save","const.sn.layer."+(e??this.#_)+".enabled",!0);break;case"grp":if(this.#H)break;this.#H=e;break}return this.scrItr.recodeDesign(t),i.isWait}#a={};#C=[];#_="";#H="";#E(t){const e=this.#J(t),s=this.#a[e],i=s.back.ctn,n=s.fore.ctn;if(E(t,"float",!1))this.#n.setChildIndex(i,this.#n.children.length-1),this.#e.setChildIndex(n,this.#e.children.length-1),this.#j();else if(t.index)v(t,"index",0)&&(this.#n.setChildIndex(i,t.index),this.#e.setChildIndex(n,t.index),this.#j());else if(t.dive){const{dive:h}=t;let a=0;if(e===h)throw"[lay] 属性 layerとdiveが同じ【"+h+"】です";const r=this.#a[h];if(!r)throw"[lay] 属性 dive【"+h+"】が不正です。レイヤーがありません";const c=r.back,u=r.fore,l=this.#n.getChildIndex(c.ctn),g=this.#e.getChildIndex(u.ctn);a=l<g?l:g,a>this.#n.getChildIndex(i)&&--a,this.#e.setChildIndex(n,a),this.#n.setChildIndex(i,a),this.#j()}return t[":id_tag"]=s.fore.name.slice(0,-7),this.scrItr.recodeDesign(t),s.lay(t)}#j(){this.#C=this.#q()}#L(t){return this.#D(t,e=>{const s=this.#a[this.#J({layer:e})];if(t.page==="both"){s.fore.clearLay(t),s.back.clearLay(t);return}s.getPage(t).clearLay(t)}),!1}static#B=`
precision mediump float;

varying vec2 vTextureCoord;
uniform sampler2D uSampler;

uniform sampler2D rule;
uniform float vague;
uniform float tick;

uniform vec4 inputPixel;
uniform highp vec4 outputFrame;
vec2 getUV(vec2 coord) {
	return coord * inputPixel.xy / outputFrame.zw;
}

void main() {
	vec4 fg = texture2D(uSampler, vTextureCoord);
	vec4 ru = texture2D(rule, getUV(vTextureCoord));

	float v = ru.r - tick;
	gl_FragColor = abs(v) < vague
		? vec4(fg.rgb, 1) *fg.a *(0.5 +v /vague *0.5)
		: 0.0 <= v ? fg : vec4(0);
}`;#M=X.create({width:T.stageW,height:T.stageH});#T=new P(this.#M);#S=X.create({width:T.stageW,height:T.stageH});#m=new P(this.#S);#k(t){R.finish_trans(),this.#l.hideHint();const{layer:e}=t,s=new Set,i=[];for(const x of this.#v(e))s.add(x),i.push(this.#a[x].fore);const n=async()=>{[this.#e,this.#n]=[this.#n,this.#e];const x=[];for(const[k,S]of Object.entries(this.#a)){if(s.has(k)){S.transPage(x);continue}const{fore:{ctn:N},back:{ctn:A}}=S,F=this.#e.getChildIndex(A);this.#e.removeChild(A),this.#n.removeChild(N),this.#e.addChildAt(N,F),this.#n.addChildAt(A,F)}await Promise.allSettled(x),this.#e.visible=!0,this.#n.visible=!1,this.#T.visible=!1,this.#m.visible=!1};if(this.#m.filters=[],this.#m.alpha=1,v(t,"time",0)===0||this.#l.isSkipping)return n(),!1;let h=[];const a=[];for(const x of this.#v()){const k=this.#a[x][s.has(x)?"back":"fore"];k.ctn.visible&&h.push(k.ctn),a.push(k)}const{ticker:r,renderer:c}=this.appPixi;c.render(this.#n,{renderTexture:this.#M});let u=()=>{for(const x of h)c.render(x,{renderTexture:this.#M,clear:!1})};if(!a.some(x=>x.containMovement)){const x=u;u=()=>{u=()=>{},x()}}const l=()=>c.render(this.#e,{renderTexture:this.#S});l();let g=()=>{this.#e.visible=!0,l(),this.#e.visible=!1};if(!i.some(x=>x.containMovement)){const x=g;g=()=>{g=()=>{},x()}}const p=()=>{u(),this.#T.visible=!0,g(),this.#m.visible=!0},{glsl:o,rule:d}=t,f=()=>{r.remove(p),n()};if(!o&&!d)return R.tween(R.TW_INT_TRANS,t,this.#m,{alpha:0},()=>{},f,()=>{}),r.add(p),!1;const y={rule:D.EMPTY,vague:v(t,"vague",.04),tick:0};this.#m.filters=[new Ft(void 0,o??H.#B,y)];const b=R.tween(R.TW_INT_TRANS,t,y,{tick:1},()=>{},f,()=>{},!d);if(!d)return r.add(p),!1;const C=new m(d,void 0,x=>{y.rule=x.texture,x.destroy(),C.destroy(),b.start(),r.add(p)});return!1}#v(t=""){return t?t.split(","):this.#C}#D(t,e){const s=this.#v(t.layer);for(const i of s){const n=this.#a[i];if(!n)throw"存在しないlayer【"+i+"】です";e(i,n)}return s}#q(t=""){return this.#v(t).sort((e,s)=>{const i=this.#e.getChildIndex(this.#a[e].fore.ctn),n=this.#e.getChildIndex(this.#a[s].fore.ctn);return i<n?-1:i>n?1:0})}setAllStyle2TxtLay(t){const e=this.#v();for(const s of e){const i=this.#a[s].fore;i instanceof w&&i.lay({style:t})}}#A(t){if(R.finish_trans(),v(t,"time",NaN)===0||this.#l.isSkipping)return!1;const{layer:e}=t,s=[];for(const c of this.#v(e))s.push(this.#a[c].fore.ctn);this.#S.resize(T.stageW,T.stageH);const i=()=>{this.#e.visible=!0;const{renderer:c}=this.appPixi;for(const u of s)c.render(u,{renderTexture:this.#S,clear:!1});this.#e.visible=!1};this.#m.visible=!0,this.#m.alpha=1;const n=z(v(t,"hmax",10)),h=z(v(t,"vmax",10)),a=n===0?()=>{}:()=>this.#m.x=Math.round(Math.random()*n*2)-n,r=h===0?()=>{}:()=>this.#m.y=Math.round(Math.random()*h*2)-h;return this.#m.filters=[],R.tween(R.TW_INT_TRANS,t,this.#m,{x:0,y:0},()=>{a(),r()},()=>{this.appPixi.ticker.remove(i),this.#e.visible=!0,this.#m.visible=!1,this.#m.x=0,this.#m.y=0},()=>{}),this.appPixi.ticker.add(i),!1}#Z(t){const{layer:e,render:s,name:i}=t;if(!e)throw"layerは必須です";const n=this.#a[this.#J(t)],h=n.fore;let a=()=>{};s&&!this.#l.isSkipping&&(h.renderStart(),a=()=>h.renderEnd());const r=R.cnvTweenArg(t,h),c=E(t,"arrive",!1),u=E(t,"backlay",!1),l=n.back.ctn;return R.tween(i??e,t,h,R.cnvTweenArg(t,h),()=>{},a,()=>{if(c&&Object.assign(h,r),u)for(const g of Object.keys(R.hMemberCnt))l[g]=h[g]}),"filter"in t&&(h.ctn.filters=[L.bldFilters(t)],h.aFltHArg=[t]),!1}#P(t){return R.finish_trans(),this.#D(t,e=>{const s=this.#a[this.#J({layer:e})];if(t.page==="both"){this.#Y(s.fore,t),this.#Y(s.back,t);return}const i=s.getPage(t);this.#Y(i,t)}),!1}#Y(t,e){const s=t.ctn;s.filters??=[],s.filters=[...s.filters,L.bldFilters(e)],t.aFltHArg.push(e)}#G(t){return this.#D(t,e=>{const s=this.#a[this.#J({layer:e})];if(t.page==="both"){const n=s.fore,h=s.back;n.ctn.filters=null,h.ctn.filters=null,n.aFltHArg=[],h.aFltHArg=[];return}const i=s.getPage(t);i.ctn.filters=null,i.aFltHArg=[]}),!1}#z(t){return this.#D(t,e=>{const s=this.#a[this.#J({layer:e})];if(t.page==="both"){this.#V(s.fore,t),this.#V(s.back,t);return}const i=s.getPage(t);this.#V(i,t)}),!1}#V(t,e){const s=t.ctn;if(!s.filters)throw"フィルターがありません";const i=z(v(e,"index",0)),n=s.filters.length;if(n<=i)throw`フィルターの個数（${n}）を越えています`;t.aFltHArg[i].enabled=s.filters[i].enabled=E(e,"enabled",!0)}static#F=10;static get msecChWait(){return H.#F}#N(t){const{text:e}=t;if(!e)throw"textは必須です";const s=this.#b(t);delete t.text,this.setNormalChWait(),this.#l.isSkipping?t.wait=0:"wait"in t&&v(t,"wait",NaN);const i=encodeURIComponent(JSON.stringify(t));this.#g("add｜"+i,s);const n=E(t,"record",!0),h=this.val.doRecLog();return n||this.val.setVal_Nochk("save","sn.doRecLog",n),s.tagCh(e.replaceAll("[r]",`
`)),this.val.setVal_Nochk("save","sn.doRecLog",h),this.#g("add_close｜",s),!1}#b=t=>{throw this.#W(),0};#K(t){const e=this.#J(t,this.#_),s=this.#a[e].getPage(t);if(!(s instanceof w))throw e+"はTxtLayerではありません";return s}setNormalChWait(){H.#F=this.scrItr.normalWait}#X=t=>{throw this.#W(),0};#Q(t){const{layer:e}=t;if(!e)throw"[current] layerは必須です";const s=this.#a[e];if(!s||!(s.getPage(t)instanceof w))throw`${e}はTxtLayerではありません`;this.#I=s,this.recPagebreak(),this.#_=e,this.val.setVal_Nochk("save","const.sn.mesLayer",e);for(const i of this.#v()){const n=this.#a[i];n.fore instanceof w&&(n.fore.isCur=n.back.isCur=i===e)}return!1}get currentTxtlayForeNeedErr(){return this.#W(),this.currentTxtlayFore}get currentTxtlayFore(){return this.#I?this.#I.fore:null}#I;#W=()=>{throw"文字レイヤーがありません。文字表示や操作する前に、[add_lay layer=（レイヤ名） class=txt]で文字レイヤを追加して下さい"};#J(t,e=""){const s=t.layer??e;if(s.includes(","))throw"layer名に「,」は使えません";if(!(s in this.#a))throw"属性 layer【"+s+"】が不正です。レイヤーがありません";return t.layer=s}#R={text:""};#U=[];recText(t){this.#R={text:t},this.val.setVal_Nochk("save","const.sn.sLog",String(this.val.getVal("const.sn.log.json")))}recPagebreak(){this.#R.text&&(this.#R.text=this.#R.text.replaceAll("</span><span class='sn_ch'>",""),this.#U.push(this.#R)>this.cfg.oCfg.log.max_len&&(this.#U=this.#U.slice(-this.cfg.oCfg.log.max_len)),this.#R={text:""})}#et(t){const e=this.#b(t);return t.layer===this.#_&&t.page==="fore"&&this.recPagebreak(),e.clearText(),!1}#st(t){return this.#g("endlink｜",this.#b(t)),!1}#it(t){return E(t,"rec_page_break",!0)&&this.recPagebreak(),this.#I&&(this.#I.fore.clearLay(t),this.#I.back.clearLay(t)),!1}#nt(t){if(!t.pic)throw"[graph] picは必須です";const e=encodeURIComponent(JSON.stringify(t));return this.#g("grp｜"+e,this.#b(t)),!1}#at(t){if(!t.fn&&!t.label&&!t.url)throw"fn,label,url いずれかは必須です";t.fn??=this.scrItr.scriptFn,t.style??="background-color: rgba(255,0,0,0.5);",t.style_hover??="background-color: rgba(255,0,0,0.9);",t.style_clicked??=t.style;const e=encodeURIComponent(JSON.stringify(t));return this.#g("link｜"+e,this.#b(t)),!1}#ht(t){return t.text=`
`,this.#N(t)}#rt(t){return this.#tt({...t,text:"[r]"})}#tt(t){return this.#R={...t,text:this.#R.text},t.text?(t.record=!0,t.style??="",t.style+="display: none;",t.wait=0,this.#N(t)):!1}#ot(t){return this.#U=[],this.#R={text:t.text??""},this.val.setVal_Nochk("save","const.sn.sLog",t.text?`[{text:"${t.text}"}]`:"[]"),!1}#lt(t){const{t:e,r:s}=t;if(!e)throw"[ruby2] tは必須です";if(!s)throw"[ruby2] rは必須です";return t.text="｜"+encodeURIComponent(e)+"《"+encodeURIComponent(s)+"》",delete t.t,delete t.r,this.#N(t)}#ct(t){const e=encodeURIComponent(JSON.stringify(t));return this.#g("span｜"+e,this.#b(t)),!1}#dt(t){if(!t.t)throw"[tcy] tは必須です";const e=encodeURIComponent(JSON.stringify(t));return this.#g("tcy｜"+e,this.#b(t)),!1}#pt(t){console.group("🥟 [dump_lay]");for(const e of this.#v(t.layer)){const s=this.#a[e];try{console.info(`%c${s.fore.name.slice(0,-7)} %o`,`color:#${T.isDarkMode?"49F":"05A"};`,JSON.parse(`{"back":{${s.back.dump()}}, "fore":{${s.fore.dump()}}}`))}catch(i){console.error("dump_lay err:%o",i),console.error(`   back:${s.back.dump()}`),console.error(`   fore:${s.fore.dump()}`)}}return console.groupEnd(),!1}#ft(t){const e=this.#J(t,this.#_),s=E(t,"enabled",!0);return this.#b(t).enabled=s,this.val.setVal_Nochk("save","const.sn.layer."+e+".enabled",s),!1}#gt(t){return G.argChk_page(t,"back"),t.fn??=this.scrItr.scriptFn,this.#b(t).addButton(t),this.scrItr.recodeDesign(t),!1}record(){const t={};for(const e of this.#C){const s=this.#a[e];t[e]={cls:s.cls,fore:s.fore.record(),back:s.back.record()}}return t}playback(t){this.#U=JSON.parse(String(this.val.getVal("save:const.sn.sLog"))),this.#R={text:""};const e=[],s=[];for(const[n,{fore:h,fore:{idx:a},back:r,cls:c}]of Object.entries(t)){s.push({ln:n,idx:a});const u=this.#a[n]??=new G(n,c,this.#e,this.#n,{},this.sys,this.val,{isWait:!1});u.fore.playback(h,e),u.back.playback(r,e)}const i=this.#e.children.length;return e.push(new Promise(n=>{for(const{ln:h,idx:a}of s.sort(({idx:r},{idx:c})=>r===c?0:r<c?-1:1)){const{fore:r,back:c}=this.#a[h];if(!r)continue;const u=i>a?a:i-1;this.#e.setChildIndex(r.ctn,u),this.#n.setChildIndex(c.ctn,u)}n()})),e}}const Ut=Object.freeze(Object.defineProperty({__proto__:null,LayerMng:H},Symbol.toStringTag,{value:"Module"}));export{I as B,Ut as L,w as T};
