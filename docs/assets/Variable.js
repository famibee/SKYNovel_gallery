import{g as b,p as w,a as k,u as N,b as r,i as p}from"./web.js";import{PropParser as y}from"./PropParser.js";import{n as m}from"./Reading.js";import"../web.js";class _{hAreas=Object.create(null);clear(){this.hAreas={}}search(s){return Object.entries(this.hAreas).some(([t,e])=>s>=parseInt(t)&&s<=e)}record(s){if(!this.search(s)){for(const[t,e]of Object.entries(this.hAreas))if(e+1===s){String(s+1)in this.hAreas?(this.hAreas[t]=this.hAreas[s+1],delete this.hAreas[s+1]):this.hAreas[t]=s;return}if(String(s+1)in this.hAreas){this.hAreas[s]=this.hAreas[s+1],delete this.hAreas[s+1];return}this.hAreas[s]=s}}erase(s){if(this.search(s)){if(String(s)in this.hAreas){this.hAreas[s]>s&&(this.hAreas[s+1]=this.hAreas[s]),delete this.hAreas[s];return}for(const[t,e]of Object.entries(this.hAreas))if(!(s<parseInt(t)||e<s)){if(this.hAreas[t]===s){this.hAreas[t]=s-1;return}this.hAreas[s+1]=e,this.hAreas[t]=s-1;return}}}get count(){return Object.keys(this.hAreas).length}toString(){let s="";for(const t of Object.keys(this.hAreas).map(e=>parseInt(e)).sort((e,o)=>e-o))s+=t===this.hAreas[t]?","+t:","+t+"~"+this.hAreas[t];return s}}class u{constructor(s,t){if(this.cfg=s,t.let=i=>this.#a(i),t.let_abs=i=>this.#j(i),t.let_char_at=i=>this.#W(i),t.let_index_of=i=>this.#P(i),t.let_length=i=>this.#K(i),t.let_replace=i=>this.#L(i),t.let_round=i=>this.#F(i),t.let_search=i=>this.#M(i),t.let_substr=i=>this.#D(i),t.clearsysvar=()=>this.#c(),t.clearvar=()=>this.#w(),t.dump_val=()=>this.#J(),t.copybookmark=i=>this.#C(i),t.erasebookmark=i=>this.#O(i),this.#i["sn.userFnTail"]="",this.defTmp("const.sn.bookmark.json",()=>{const i=[];for(const a of Object.keys(this.#e.mark).sort()){const c={...this.#e.mark[a].json};c.place=a,i.push(c)}return JSON.stringify(i)}),this.#s["const.sn.isFirstBoot"]=!0,this.#s["const.sn.last_page_text"]="",this.#s["const.sn.last_page_plain_text"]="",this.#s["const.sn.displayState"]=!1,this.#s["const.Date.getTime"]=()=>new Date().getTime(),this.#s["const.Date.getDateStr"]=()=>b(),this.#s["const.sn.platform"]=JSON.stringify(w),this.#c(!0),this.#w(),this.#s["const.sn.config.window.width"]=s.oCfg.window.width,this.#s["const.sn.config.window.height"]=s.oCfg.window.height,this.#s["const.sn.config.book.title"]=s.oCfg.book.title,this.#s["const.sn.config.book.version"]=s.oCfg.book.version,this.#s["const.sn.Math.PI"]=Math.PI,this.#s["const.sn.isPaging"]=!1,typeof window>"u")return;const e=window,o=e.AudioContext??e.webkitAudioContext;this.#s["const.sn.needClick2Play"]=()=>new o().state==="suspended"}#t={sys:{},save:{},tmp:{},mp:{}};#i=this.#t.save;#s=this.#t.tmp;#n;#e={sys:{},mark:{},kidoku:{}};#o;#h={};#d;async setSys(s){this.#n=s,await s.initVal(this.#e,this.#s,t=>{this.updateData(t),sessionStorage.clear();const e=this.cfg.getNs();this.#_=this.cfg.oCfg.debug.variable?()=>{const i={};for(const[h,n]of Object.entries(this.#o))i["sys:"+h]=n instanceof Function?n():n;sessionStorage[e+"sys"]=JSON.stringify(i);const a={};for(const[h,n]of Object.entries(this.#i))a["save:"+h]=n instanceof Function?n():n;sessionStorage[e+"save"]=JSON.stringify(a);const c={};for(const[h,n]of Object.entries(this.#s))c[h]=n instanceof Function?n():n;sessionStorage[e+"tmp"]=JSON.stringify(c);const l={};for(const[h,n]of Object.entries(this.#t.mp))l[h]=n instanceof Function?n():n;sessionStorage[e+"mp"]=JSON.stringify(l);const g={};for(const[h,n]of Object.entries(this.#e.mark))g[h]=n instanceof Function?n():n;sessionStorage[e+"mark"]=JSON.stringify(g);const f={};for(const[h,n]of Object.entries(this.#e.kidoku))f[h]=n instanceof Function?n():n;sessionStorage[e+"kidoku"]=JSON.stringify(f),s.flush()}:()=>s.flush(),this.#d=(i,a)=>s.callHook(i,a),s.addHook((i,a)=>this.#V[i]?.(i,a));const o=this.getVal("sys:sn.tagCh.msecWait",-1);(this.#s["const.sn.isFirstBoot"]||o===-1)&&this.#c(!0),this.#f=this.getVal("sys:sn.tagCh.doWait"),this.#g=this.getVal("sys:sn.tagCh.doWait_Kidoku"),this.#u=this.getVal("sys:sn.tagCh.msecWait"),this.#k=this.getVal("sys:sn.tagCh.msecWait_Kidoku"),this.#p()})}#p(){m.playbackPage(this.getVal("sys:const.sn.aPageLog")??"[]",this.getVal("save:const.sn.styPaging")??m.INI_STYPAGE)}#V={auth:(s,t)=>this.#y(t.hBreakpoint.aData),var:(s,t)=>this.#n.send2Dbg(t.ri,{v:this.#t[t.scope]??{}}),set_var:(s,t)=>{try{this.#N(t.nm,t.val),this.#n.send2Dbg(t.ri,{})}catch{}},set_data_break:(s,t)=>{this.#y(t.a),this.#n.send2Dbg(t.ri,{})},disconnect:s=>u.#r={}};#y(s){u.#r={};for(const t of s)u.#r[t.dataId]=1}updateData(s){this.#e=s,this.#o=this.#t.sys=this.#e.sys,this.#h={};for(const[t,e]of Object.entries(this.#e.kidoku)){const o=new _;o.hAreas={...e},this.#h[t]=o}}#_=()=>{};flush(){this.#_()}setDoRecProc(s){this.#b=s}#b=s=>{};defTmp(s,t){this.#s[s]=t}cloneMp(){return{...this.#t.mp}}setMp(s){this.#t.mp=s}setMark(s,t){this.#e.mark[s]=t,this.flush()}getMark=s=>{const t=this.#e.mark[s];if(!t)throw`place【${s}】は存在しません`;return t};cloneSave(){return{...this.#t.save}}mark2save(s){this.#i=this.#t.save={...s.hSave},this.#l=this.#i["sn.doRecLog"]??!1}touchAreaKidoku(s){return this.#h[s]??=new _}getAreaKidoku=s=>{const t=this.#h[s];if(!t)throw`hAreaKidoku${s}】は存在しません`;return t};saveKidoku(){for(const[s,{hAreas:t}]of Object.entries(this.#h))this.#e.kidoku[s]={...t};this.flush()}#C(s){if(!("from"in s))throw"fromは必須です";if(!("to"in s))throw"toは必須です";const t=Number(s.from),e=Number(s.to);if(t===e)return!1;const o=this.#e.mark[t];if(!o)throw`from:${t} のセーブデータは存在しません`;return this.setMark(e,{...o}),this.#n.copyBMFolder(t,e),!1}#O(s){const{place:t}=s;if(!t)throw"placeは必須です";return delete this.#e.mark[t],this.flush(),this.#n.eraseBMFolder(t),!1}#a(s){if(!s.name)throw"nameは必須です";let t=!0;if(s.cast)switch(s.cast){case"num":r(s,"text",NaN);break;case"int":s.text=String(p(r(s,"text",NaN)));break;case"uint":s.text=String(N(r(s,"text",NaN)));break;case"bool":k(s,"text",!1);break;case"str":t=!1;break;default:throw"cast【"+s.cast+"】は未定義です"}return this.#N(s.name,s.text,t),!1}#j(s){const t=r(s,"text",0);return s.text=String(t<0?-t:t),this.#a(s),!1}#W(s){return s.text=(s.text??"").charAt(r(s,"pos",0)),this.#a(s),!1}#P(s){const{val:t}=s;if(!t)throw"valは必須です";const e=r(s,"start",0);return s.text=String((s.text??"").indexOf(t,e)),this.#a(s),!1}#K(s){return s.text=String((s.text??"").length),this.#a(s),!1}#L(s){if(!s.reg)throw"regは必須です";const{flags:t}=s,e=t?new RegExp(s.reg,t):new RegExp(s.reg);return s.text=String(s.text??"").replace(e,String(s.val)),this.#a(s),!1}#F(s){const t=r(s,"text",0);return s.text=String(Math.round(t)),this.#a(s),!1}#M(s){if(!s.reg)throw"regは必須です";const{flags:t}=s,e=t?new RegExp(s.reg,t):new RegExp(s.reg);return s.text=String((s.text??"").search(e)),this.#a(s),!1}#D(s){const t=r(s,"pos",0);return s.text=s.len!=="all"?(s.text??"").slice(t,t+p(r(s,"len",1))):(s.text??"").slice(t),this.#a(s),!1}#c(s=!1){const t=this.#o=this.#t.sys=this.#e.sys={};typeof process<"u"||(this.setVal_Nochk("sys","const.sn.window.x",0),this.setVal_Nochk("sys","const.sn.window.y",0)),this.setVal_Nochk("sys","sn.tagCh.doWait",!0),this.setVal_Nochk("sys","sn.tagCh.doWait_Kidoku",!0),this.setVal_Nochk("sys","sn.tagCh.msecWait",this.cfg.oCfg.init.tagch_msecwait),this.setVal_Nochk("sys","sn.tagCh.msecWait_Kidoku",this.cfg.oCfg.init.tagch_msecwait),this.setVal_Nochk("sys","sn.tagCh.canskip",!0),this.setVal_Nochk("sys","sn.skip.mode","s"),this.setVal_Nochk("sys","sn.auto.msecPageWait",r(t,"sn.auto.msecPageWait",this.cfg.oCfg.init.auto_msecpagewait??3500)),this.setVal_Nochk("sys","sn.auto.msecPageWait_Kidoku",r(t,"sn.auto.msecPageWait",this.cfg.oCfg.init.auto_msecpagewait??3500)),this.setVal_Nochk("sys","sn.auto.msecLineWait",500),this.setVal_Nochk("sys","sn.auto.msecLineWait_Kidoku",500),this.setVal_Nochk("sys","sn.sound.BGM.vol_mul_talking",1),this.setVal_Nochk("sys","const.sn.sound.BGM.volume",1),this.setVal_Nochk("sys","const.sn.sound.SE.volume",1),this.setVal_Nochk("sys","const.sn.sound.SYS.volume",1);for(const[e,o]of Object.entries(this.#e.kidoku))o.hAreas={},this.#h[e]?.clear();return this.setVal_Nochk("sys","TextLayer.Back.Alpha",.5),this.#t.mark=this.#e.mark={},this.setVal_Nochk("sys","const.sn.save.place",1),this.setVal_Nochk("sys","const.sn.aPageLog","[]"),s||this.#p(),this.flush(),!1}#w(){const s=this.#i["const.sn.mesLayer"]??"",t=this.#i["sn.doRecLog"]??!1,e=this.#i["const.sn.sLog"]??"[]",o=this.#i["const.sn.styPaging"]??m.INI_STYPAGE;return this.#i=this.#t.save={},this.setVal_Nochk("save","const.sn.mesLayer",s),this.setVal_Nochk("save","sn.doRecLog",t),this.setVal_Nochk("save","const.sn.sLog",e),this.setVal_Nochk("save","const.sn.styPaging",o),!1}#N=(s,t,e=!0)=>{if(!s)throw"[変数に値セット] nameは必須です";if(t==null)throw"[変数に値セット] textは必須です（空文字はOK）";const o=y.getValName(s);if(!o)throw"[変数参照] name("+s+")が変数名として異常です";const i=this.#t[o.scope];if(!i)throw"[変数に値セット] scopeが異常【"+o.scope+"】です";const a=o.name;if(a.startsWith("const.")&&a in i)throw"[変数に値セット] 変数【"+a+"】は書き換え不可です";this.setVal_Nochk(o.scope,a,t,e)};setVal_Nochk(s,t,e,o=!1){const i=this.#t[s];o&&(e=this.#v(e));const a=s+":"+t;if(a in u.#r){const c=i[t],l=e;c!=l&&this.#d("data_break",{dataId:a,old_v:c,new_v:l})}i[t]=e,this.#S[a]?.(t,e)}static#r={};getVal=(s,t)=>{if(!s)throw"[変数参照] nameは必須です";const e=y.getValName(s);if(!e)throw"[変数参照] name("+s+")が変数名として異常です";const o=this.#t[e.scope];if(!o)throw"[変数参照] scopeが異常【"+e.scope+"】です";const i=e.name;let a=o[i];if(!(i in o)){a=t;let c="";const l=i.split("."),g=l.length;for(let f=0;f<g;++f,c+="."){if(c+=l[f],!(c in o))continue;let h=JSON.parse(o[c]);if(Object.prototype.toString.call(h)!=="[object Object]"){if(f+1===g){a=h;break}continue}let n=f;for(;++n<g;){const d=l[n];if(!(d in h)){a=t;break}if(h=h[d],Object.prototype.toString.call(h)!=="[object Object]"||n+1===g){a=h;break}}a instanceof Object&&(a=JSON.stringify(a));break}}return a instanceof Function&&(a=a()),e.at==="@str"?a:this.#v(a)};#v(s){const t=s;if(t==="true")return!0;if(t==="false")return!1;if(t==="null")return null;if(t!=="undefined")return this.#I.test(t)?parseFloat(t):s}#I=/^-?[\d\.]+$/;#J=()=>{const s={tmp:{},sys:{},save:{},mp:{}};for(let t in s){const e=this.#t[t],o=s[t];for(let[i,a]of Object.entries(e))o[i]=Object.prototype.toString.call(a)==="[object Function]"?a():a}return console.info("🥟 [dump_val]",s),!1};#l=!1;doRecLog(){return this.#l}#f=!1;get tagCh_doWait(){return this.#f}#g=!1;get tagCh_doWait_Kidoku(){return this.#g}#u=0;get tagCh_msecWait(){return this.#u}#k=0;get tagCh_msecWait_Kidoku(){return this.#k}#S={"sys:sn.tagCh.doWait":s=>{this.#f=this.#m(s)},"sys:sn.tagCh.doWait_Kidoku":s=>{this.#g=this.#m(s)},"sys:sn.tagCh.msecWait":s=>{this.#u=this.#R(s)},"sys:sn.tagCh.msecWait_Kidoku":s=>{this.#k=this.#T(s)},"sys:sn.tagCh.canskip":s=>this.#m(s),"sys:sn.auto.msecPageWait":s=>this.#A(s),"sys:sn.auto.msecPageWait_Kidoku":s=>this.#A(s),"sys:sn.auto.msecLineWait":s=>this.#x(s),"sys:sn.auto.msecLineWait_Kidoku":s=>this.#x(s),"save:sn.doRecLog":s=>{this.#b(this.#l=this.#B(s))},"save:sn.userFnTail":(s,t)=>{if(t.includes("@"))throw"この変数では文字「@」は禁止です";this.cfg.userFnTail=t},"tmp:flash.desktop.NativeApplication.nativeApplication.systemIdleMode":()=>{}};defValTrg(s,t){this.#S[s]=t}#m=s=>k(this.#o,s,!0);#R=s=>r(this.#o,s,10);#T=s=>r(this.#o,s,this.cfg.oCfg.init.tagch_msecwait===void 0?10:this.cfg.oCfg.init.tagch_msecwait);#A=s=>r(this.#o,s,this.cfg.oCfg.init.auto_msecpagewait===void 0?3500:this.cfg.oCfg.init.auto_msecpagewait);#x=s=>r(this.#o,s,500);#B(s){return k(this.#i,s,!0)}}export{u as Variable};
