import{e as V,b as w,u as W,a as N,T as St,m as ht,l as Et,L as B,G as M,R as J,n as H,o as Nt,c as st,k as Y,C as E,D as K,q as bt,r as O,s as rt,t as U,B as At,v as L,i as ut,w as Pt,A as xt,x as Ft,f as wt,g as Rt,P as Ot,y as gt,z as Lt,F as X,H as Bt}from"./web.js";import{v as R,Q as mt,$ as q}from"./SndBuf.js";import{a as F,m as Vt}from"./Reading.js";import{a as lt,R as yt}from"./ScriptIterator.js";import"../web.js";class G{constructor(t,e,s,i,a,n,h,r){this.cls=e,this.hArg=a,this.sys=n,this.val=h,this.ret=r;const d=n.hFactoryCls[e];if(!d)throw`属性 class【${e}】が不正です`;const p=d(),l=d();p.layname=l.layname=t;const g=a[":id_tag"]=`layer:${t} cls:${e} page:`;p.ctn.name=p.name=g+"A",l.ctn.name=l.name=g+"B",s.addChild(p.ctn),i.addChild(l.ctn),N(a,"visible",!0),N(a,"visible",!0),r.isWait=p.lay(a)||l.lay(a),this.#i={fore:p,back:l},i.visible=!1;const u=`const.sn.lay.${t}`;h.setVal_Nochk("tmp",u,!0),h.defTmp(u+".fore.alpha",()=>this.#i.fore.alpha),h.defTmp(u+".back.alpha",()=>this.#i.back.alpha),h.defTmp(u+".fore.height",()=>this.#i.fore.height),h.defTmp(u+".back.height",()=>this.#i.back.height),h.defTmp(u+".fore.visible",()=>this.#i.fore.ctn.visible),h.defTmp(u+".back.visible",()=>this.#i.back.ctn.visible),h.defTmp(u+".fore.width",()=>this.#i.fore.width),h.defTmp(u+".back.width",()=>this.#i.back.width),h.defTmp(u+".fore.x",()=>this.#i.fore.x),h.defTmp(u+".back.x",()=>this.#i.back.x),h.defTmp(u+".fore.y",()=>this.#i.fore.y),h.defTmp(u+".back.y",()=>this.#i.back.y)}#i;destroy(){this.#i.fore.destroy(),this.#i.back.destroy()}lay=t=>this.getPage(t).lay(t);getPage=t=>G.argChk_page(t,"fore")!=="back"?this.#i.fore:this.#i.back;static argChk_page(t,e){const s=t.page??e;if(s==="fore"||s==="back")return t.page=s;throw Error("属性 page【"+s+"】が不正です")}get fore(){return this.#i.fore}get back(){return this.#i.back}transPage(t){[this.#i.back,this.#i.fore]=[this.#i.fore,this.#i.back],this.#i.back.copy(this.#i.fore,t)}}class ct{constructor(t,e=!1){this.bg_col=t,this.isLay=e}static init(t,e,s,i,a,n){}static cvsResizeDesign(){}destroy(){}gethArg(){return this.hArg}hArg={};sethArg(t){this.hArg=t}setOther(t){}adopt(t){}static enterMode(){}static allHide(){}set visible(t){}static leaveMode(){}cvsResize(){}make(){}static replaceToken(t){}}class jt extends ct{constructor(t,e){super("#29e",!0)}setSp(t){}}class m{constructor(t="",e,s=()=>{},i=()=>{}){this.csvFn=t,this.ctn=e,this.fncFirstComp=s,this.fncAllComp=i,t&&(this.#g=e?a=>{e.addChild(a),this.#o.push(a)}:()=>{},this.ret=m.#b(t,a=>this.fncFirstComp(a),a=>this.fncAllComp(a),a=>this.#g(a)))}static#i;static#e;static#a;static#r;static init(t,e,s,i,a){m.#i=t,m.#e=e,m.#a=s,m.#r=i,s.arg.crypto&&(m.#u=m.#c,m.#h=m.#z);const n=()=>{const h=m.#l*m.#t;for(const r of Object.values(m.#w))r.volume=h};a.setNoticeChgVolume(h=>{m.#l=h,n()},h=>{m.#t=h,n()})}static#t=1;static#l=1;static#p;static setEvtMng(t){m.#p=t}ret=!1;#g;#o=[];destroy(){this.fncFirstComp=()=>{},this.fncAllComp=()=>{},this.#g=t=>t.destroy();for(const t of this.#o)m.stopVideo(t.name),t.parent?.removeChild(t),t.destroy();this.#o=[]}static destroy(){m.#s={},m.#d={},m.#w={}}static#b(t,e,s,i){if(!t)return!1;let a=!1;if(t.startsWith("data:")){const l=()=>{const g=O.from(t);i(g),e(g),s(a)};return t in rt?l():(a=!0,new U().add(t,t).load(l)),a}const n=[],h=new U,r=t.split(","),d=r.length;for(let l=0;l<d;++l){const g=r[l];if(!g)throw"face属性に空要素が含まれます";const{dx:u,dy:o,blendmode:c,fn:f}=m.#s[g]||{fn:g,dx:0,dy:0,blendmode:At.NORMAL},y=l===0?e:T=>{T.transform!==null&&(T.x=u,T.y=o,T.blendMode=c)};if(n.push({fn:f,fnc:y}),f in m.#d||f in rt||f in U.shared.resources)continue;a=!0;const k=m.#i.searchPath(f,Y.SP_GSM),b=this.#a.arg.crypto?{xhrType:k.slice(-5)===".json"?L.XHR_RESPONSE_TYPE.TEXT:L.XHR_RESPONSE_TYPE.BUFFER}:{};h.add({...b,name:f,url:k})}const p=(l,g)=>{for(const{fn:u,fnc:o}of n){const c=m.#$(u,g);c.name=u,i(c),o(c)}s(a)};return a?h.use(async(l,g)=>{try{if(l.extension==="json"){const o=await this.#a.dec("json",l.data);m.#h(o,l,g);return}const u=await this.#a.decAB(l.data);m.#u(u,l,g)}catch(u){const o=`画像/動画ロード失敗です fn:${l.name} ${u}`;m.#p.isSkipping?console.warn(o):console.error("%c"+o,"color:#FF3300;")}}).load(p):queueMicrotask(()=>p(0,{})),a}static#s={};static#d={};static#u=(t,{type:e,name:s,data:i},a)=>{switch(e){case L.TYPE.VIDEO:const n=i;n.volume=m.#l,m.#w[s]=m.#_(n)}a()};static#f(t){const e=/([^\d]+)\d+\.(\w+)/.exec(t[0]??"");if(!e)return[];const s=e[1].length,i=-e[2].length-1;return t.sort((a,n)=>ut(a.slice(s,i))>ut(n.slice(s,i))?1:-1)}static async#c(t,e,s){e.data=t,e.extension!=="bin"&&s(),t instanceof HTMLImageElement?(e.texture=await H.fromLoader(t,e.url,e.name),e.type=L.TYPE.IMAGE):t instanceof HTMLVideoElement&&(t.volume=m.#l,m.#w[e.name]=m.#_(t),e.type=L.TYPE.VIDEO),s()}static#_(t){return m.#e.getVal("const.sn.needClick2Play")&&(K.trace_beforeNew(`[lay系] ${K.strPos()}未クリック状態で動画を自動再生します。音声はミュートされます`,"W"),t.muted=!0),t.setAttribute("playsinline",""),t}static#h=(t,{type:e,spritesheet:s,name:i,data:a},n)=>{switch(e){case L.TYPE.JSON:const h=s._frameKeys;m.#f(h),m.#d[i]={aTex:h.map(r=>H.from(r)),meta:a.meta}}n()};static#z(t,e,s){const{meta:i,frames:a}=e.data=JSON.parse(t);if(e.type=L.TYPE.JSON,!i?.image){s();return}const n=Pt(i.image),h=m.#i.searchPath(n,Y.SP_GSM);new U().use((r,d)=>{this.#a.decAB(r.data).then(p=>{r.data=p,p instanceof HTMLImageElement&&(r.type=L.TYPE.IMAGE,URL.revokeObjectURL(p.src)),d()}).catch(p=>this.#r.errScript(`画像/動画ロード失敗です dec2res4Cripto fn:${r.name} ${p}`,!1))}).add({name:n,url:h,xhrType:L.XHR_RESPONSE_TYPE.BUFFER}).load((r,d)=>{for(const{data:p}of Object.values(r.resources)){const{baseTexture:l}=H.from(p),g=Object.values(a);m.#d[e.name]={aTex:g.map(({frame:{x:u,y:o,w:c,h:f}})=>new H(l,new J(u,o,c,f))),meta:i}}s()})}static#$(t,e){const s=m.#d[t];if(s){const n=new xt(s.aTex);return n.animationSpeed=s.meta.animationSpeed??1,n.play(),n}if(t in rt)return O.from(t);const i=m.#w[t];if(i)return O.from(i);const a=e[t];return a?new O(a.texture):new O}static#w={};static getHFn2VElm(t){return m.#w[t]}static wv(t){const{fn:e}=t;if(!e)throw"fnは必須です";const s=m.#w[e];if(!s||s.loop)return!1;if(m.#p.isSkipping||s.ended)return m.stopVideo(e),!1;const i="wv fn:"+e,a=N(t,"stop",!0),n=()=>{a&&m.stopVideo(e)};return F.beginProc(i,n,!0,n),s.addEventListener("ended",()=>F.notifyEndProc(i),{once:!0,passive:!0}),!0}static stopVideo(t){const e=m.#w[t];e&&(delete m.#w[t],e.pause(),e.currentTime=e.duration)}static add_face(t){const{name:e}=t;if(!e)throw"nameは必須です";if(e in m.#s)throw"一つのname（"+e+"）に対して同じ画像を複数割り当てられません";const{fn:s=e}=t;return m.#s[e]={fn:s,dx:w(t,"dx",0),dy:w(t,"dy",0),blendmode:B.getBlendmodeNum(t.blendmode||"")},!1}}class I extends B{static#i=new wt;static#e;static init(t,e,s,i,a,n){I.#e=s,m.init(e,n,i,t,a)}static destroy(){I.#i.clear(),m.destroy()}#a=new jt(this.ctn,this);constructor(){super(),E.isDbg&&(this.#r=t=>this.#a.setSp(t),this.cvsResize=()=>{super.cvsResize(),this.#a.cvsResize()})}#r=()=>{};#t="";#l="";#p="";lay=t=>{const e=F.procID+`GrpLayer lay name:${this.name_}`,s=this.#g(t,i=>{i&&F.endProc(e)});return s&&F.beginProc(e),s};#g(t,e){const{fn:s,face:i=""}=t;if(this.#a.sethArg(t),!s)return super.lay(t),this.ctn.children.length>0&&this.setPos(t),this.#l="",this.#t=this.#p=i,e(!1),!1;const a="fn"in t,n="face"in t;return this.clearLay({clear_filter:N(t,"clear_filter",!0)}),a&&(this.#l=s),n&&(this.#p=i),super.lay(t),t.dx=0,t.dy=0,this.#o.destroy(),this.#o=new m(this.#t=s+(i?","+i:""),this.ctn,h=>{("width"in t||"height"in t)&&(h.width=w(t,"width",0),h.height=w(t,"height",0)),this.#b=h.width,this.#s=h.height,B.setXY(h,t,this.ctn,!0),B.setBlendmode(this.ctn,t),this.#r(h)},h=>e(h)),this.#o.ret}#o=new m;#b=0;#s=0;get width(){return this.#b}get height(){return this.#s}renderStart(){this.#u=new O(this.#d),this.#u.visible=!1,this.ctn.addChildAt(this.#u,0),this.#u.position.set(-this.ctn.x,-this.ctn.y);let t=()=>{const e=this.ctn.alpha;this.ctn.alpha=1;for(const s of this.ctn.children)s.visible=!0;this.#u.visible=!1,I.#e.renderer.render(this.ctn,{renderTexture:this.#d}),this.ctn.alpha=e;for(const s of this.ctn.children)s.visible=!1};if(!this.containMovement){let e=t;t=()=>{t=()=>{},e()}}this.#f=()=>{t(),this.#u.visible=!0},I.#e.ticker.add(this.#f)}#d=X.create({width:E.stageW,height:E.stageH});#u=new O;#f=()=>{};renderEnd(){I.#e.ticker.remove(this.#f),this.ctn.removeChild(this.#u);for(const t of this.ctn.children)t.visible=!0;this.#u.destroy(!0),this.#d=X.create({width:E.stageW,height:E.stageH})}setPos(t){B.setXY(this.ctn.children[0]??this.ctn,t,this.ctn,!0)}get containMovement(){if(this.#t==="")return!1;const t=this.ctn.children;return this.#t.split(",").some((e,s)=>t[s]instanceof xt||m.getHFn2VElm(e))}clearLay(t){super.clearLay(t),this.#o.destroy(),this.#l="",this.#p="",this.#t=""}record=()=>({...super.record(),sBkFn:this.#l,sBkFace:this.#p});playback(t,e){if(super.playback(t,e),t.sBkFn===""&&t.sBkFace===""){this.#l="",this.#p="";return}e.push(new Promise(s=>this.#g({fn:t.sBkFn,face:t.sBkFace,left:t.x,top:t.y,alpha:t.alpha,blendmode:B.getNum2Blendmode(t.blendMode),rotation:t.rotation,scale_x:t.scale_x,scale_y:t.scale_y},i=>{this.ctn.position.set(t.x,t.y),s()})))}makeDesignCast(t){this.ctn.visible&&t(this.#a)}cvsResize(){super.cvsResize()}showDesignCast(){this.#a.visible=!0}dump=()=>super.dump()+`, "pic":"${this.#t}"`}const Q="、。，．）］｝〉」』】〕”〟ぁぃぅぇぉっゃゅょゎァィゥェォッャュョヮヵヶ！？!?‼⁉・ーゝゞヽヾ々",it="［（｛〈「『【〔“〝",at="─‥…",ot=Q,_t=new RegExp(`[${Q}]`),Dt=new RegExp(`[${it}]`),It=new RegExp(`[${at}]`),Mt=_t;class Ht{#i=Q;#e=it;#a=at;#r=ot;get 行頭禁則(){return this.#i}get 行末禁則(){return this.#e}get 分割禁止(){return this.#a}get ぶら下げ(){return this.#r}#t=_t;#l=Dt;#p=It;#g=Mt;break_fixed=!1;break_fixed_left=0;break_fixed_top=0;bura=!1;lay(t){t.kinsoku_sol&&(this.#i=t.kinsoku_sol,this.#t=new RegExp(`[${this.#i}]`)),t.kinsoku_eol&&(this.#e=t.kinsoku_eol,this.#o(),this.#l=new RegExp(`[${this.#e}]`)),t.kinsoku_dns&&(this.#a=t.kinsoku_dns,this.#b(),this.#p=new RegExp(`[${this.#a}]`)),t.kinsoku_bura&&(this.#r=t.kinsoku_bura,this.#o(),this.#b(),this.#g=new RegExp(`[${this.#r}]`)),"bura"in t&&(this.bura=N(t,"bura",!1)),this.break_fixed=N(t,"break_fixed",this.break_fixed),this.break_fixed_left=w(t,"break_fixed_left",this.break_fixed_left),this.break_fixed_top=w(t,"break_fixed_top",this.break_fixed_top)}#o(){const t=this.#e.length,e=this.#r.length;if(t<e)for(let s=0;s<t;++s){const i=this.#e[s];if(this.#r.includes(i))throw`禁則の競合があります。文字 ${i} がぶら下げ と 行末禁則 の両方に含まれます`}else for(let s=0;s<e;++s){const i=this.#r[s];if(this.#e.includes(i))throw`禁則の競合があります。文字 ${i} がぶら下げ と 行末禁則 の両方に含まれます`}}#b(){const t=this.#a.length,e=this.#r.length;if(t<e)for(let s=0;s<t;++s){const i=this.#a[s];if(this.#r.includes(i))throw`禁則の競合があります。文字 ${i} がぶら下げ と 分割禁止 の両方に含まれます`}else for(let s=0;s<e;++s){const i=this.#r[s];if(this.#a.includes(i))throw`禁則の競合があります。文字 ${i} がぶら下げ と 分割禁止 の両方に含まれます`}}reNew(t){t.#s(this.#i,this.#e,this.#a,this.#r),t.break_fixed=this.break_fixed,t.break_fixed_left=this.break_fixed_left,t.break_fixed_top=this.break_fixed_top,t.bura=this.bura}#s(t,e,s,i){this.#i!=t&&(this.#i=t,this.#t=new RegExp(`[${t}]`)),this.#e!=e&&(this.#e=e,this.#l=new RegExp(`[${e}]`)),this.#a!=s&&(this.#a=s,this.#p=new RegExp(`[${s}]`)),this.#r!=i&&(this.#r=i,this.#g=new RegExp(`[${i}]`))}record(){const t={break_fixed:this.break_fixed,break_fixed_left:this.break_fixed_left,break_fixed_top:this.break_fixed_top,bura:this.bura};return this.#i===Q&&(t.行頭禁則=this.#i),this.#e===it&&(t.行末禁則=this.#e),this.#a===at&&(t.分割禁止=this.#a),this.#r===ot&&(t.ぶら下げ=this.#r),t}playback(t){t&&(this.#s(t.行頭禁則??Q,t.行末禁則??it,t.分割禁止??at,t.ぶら下げ??ot),this.break_fixed=t.break_fixed,this.break_fixed_left=t.break_fixed_left,this.break_fixed_top=t.break_fixed_top,this.bura=t.bura)}hyph(t,e,s,i,a){let n,h=0,r=2,d=p=>(d=()=>!1,i===p?(i>0&&(t.innerHTML=a.replaceAll('class="sn_ch"','class="sn_ch sn_ch_in_default"')),!0):p<2);do{if(n=this.#u(t,e),h=n.length,d(h))break;let p=-1/0;for(;r<h;++r){const{elm:l,rect:g,ch:u}=n[r];if(l.tagName==="RT")continue;const o=s?g.y:g.x;if(p<=o||l.previousElementSibling?.tagName==="SPAN"&&l.previousElementSibling?.innerHTML.includes("<br>")||l.parentElement?.previousElementSibling?.tagName==="SPAN"&&l.parentElement?.previousElementSibling?.innerHTML.includes("<br>")){p=o,this.break_fixed||(this.break_fixed_left=g.x,this.break_fixed_top=g.y);continue}const c=this.#d(n,r),{elm:f,rect:y,ch:k}=n[c];if(!this.break_fixed){this.break_fixed_left=y.x,this.break_fixed_top=y.y;const P=globalThis.getComputedStyle(f),D=parseFloat(P.fontSize);s?this.break_fixed_top+=D:this.break_fixed_left+=D}p=-1/0;const b=r,{cont:T,ins:v}=this.bura?this.hyph_alg_bura(n,c,k,r):this.hyph_alg(n,c,k,r,u);if(r=v,T)continue;const C=n[r].elm,S=C.parentElement,A=document.createElement("br");if(S.classList.contains("sn_tx"))S.insertBefore(A,C);else{const P=S.parentElement;P.classList.contains("sn_ch")?P.parentElement.insertBefore(A,P):P.insertBefore(A,S)}r+=2,r<b&&(r=b),h=-1;break}}while(h<0);return[n,h]}#d(t,e){const s=e-1,{elm:i}=t[s];return i.tagName!=="RT"?s-(i.style.textCombineUpright==="all"?Array.from(i.textContent??"").length-1:0):s-Array.from(i.textContent??"").length}#u(t,e){const s=[];if(t.nodeType!==t.TEXT_NODE)return Array.from(t.childNodes).map(h=>this.#u(h,e)).flat();const i=t.ownerDocument.createRange();i.selectNodeContents(t);let a=0;const n=i.endOffset;for(;a<n;){i.setStart(t,a),i.setEnd(t,++a);const h=i.toString();s.push({ch:h,rect:e(i,h),elm:i.startContainer.parentElement})}return i.detach(),s}hyph_alg(t,e,s,i,a){if(!this.#l.test(s)){if(this.#t.test(a))for(;(i=this.#d(t,i))>=0&&this.#t.test(t[i].ch););else if(!(s===a&&this.#p.test(s)))return{cont:!0,ins:i+1}}for(i=e;(i=this.#d(t,i))>=0&&this.#l.test(t[i].ch););return{cont:!1,ins:i+1}}hyph_alg_bura(t,e,s,i){const a=this.#d(t,e),{ch:n}=t[a];if(this.#g.test(n)||this.#t.test(n)){let r=e;(this.#g.test(s)||this.#t.test(s))&&++r;const d=this.#d(t,r),{ch:p}=t[d],{ch:l}=t[r];if(p===l&&this.#p.test(l))return{cont:!1,ins:d};if(!this.#l.test(p))return{cont:!1,ins:r};r=d;do if(!this.#l.test(t[r].ch))break;while((r=this.#d(t,r))>=0);return{cont:!1,ins:r+1}}const h=this.#d(t,a);if(i>=3){const{ch:r}=t[h];if(this.#p.test(n)&&r===n)return{cont:!1,ins:h};if(this.#l.test(r)){let d=h;for(;(d=this.#d(t,d))>=0&&this.#l.test(t[d].ch););return{cont:!1,ins:d+1}}}return{cont:!1,ins:a}}}class _ extends V{constructor(t,e,s){super(),this.ctn=t,this.canFocus=e,this.sys=s,this.#t.classList.add("sn_tx"),this.#t.style.position="absolute",_.#e.view.parentElement.appendChild(this.#t),this.addChild(this.#l),this.addChild(this.#p),this.#p.name="grpDbgMasume";const i=E.debugLog?({ch:a,rect:{x:n,y:h,width:r,height:d}})=>console.log(`🍌 masume ch:${a} x:${n} y:${h} w:${r} h:${d}`):()=>{};this.#b=_.#i.oCfg.debug.masume?a=>{i(a);const{x:n,y:h,width:r,height:d}=a.rect;this.#p.beginFill(6737151,.5).lineStyle(2,16724736,1).drawRect(n,h,r,d).endFill()}:()=>{},this.noticeCompTxt=s.isApp&&_.#i.oCfg.debug.dumpHtm?()=>{F.notifyEndProc(yt);const a=this.#t.innerHTML;if(a==="")return;const{fn:n,ln:h}=_.#r.nowScrFnLn(),r=`dumpHtm ${t.name.slice(0,-7).replaceAll(":","=")}(fn=${n} line=${h})`;s.outputFile(s.path_downloads+r+".htm",`<!doctype html><html><head><meta charset=utf-8><title>${r}</title>
<h1>${r}</h1>${a.replaceAll(/ class="sn_ch"|animation-delay: \d+ms; ?| data-add="{&quot;ch_in_style&quot;:&quot;default&quot;, &quot;ch_out_style&quot;:&quot;default&quot;}"/g,"").replaceAll(' style=""',"").replaceAll(/(<\/?ruby>)/g,`
$1
`).replaceAll(/<(br|\/span)>/g,`<$1>
`)}`)}:()=>F.notifyEndProc(yt)}static#i;static#e;static init(t,e){_.#i=t,_.#e=e}static#a;static#r;static setEvtMng(t,e){_.#a=t,_.#r=e}static destroy(){_.#V=Object.create(null),_.#N=Object.create(null),_.delBreak()}#t=document.createElement("span");#l=new V;#p=new M;static#g={"background-color":0,"border-bottom-width":0,"border-left-width":0,"border-right-width":0,"border-top-width":0,"margin-bottom":0,"margin-left":0,"margin-right":0,"margin-top":0};#o=new Ht;noticeCompTxt=()=>{};#b;#s={fontsize:24,$width:0,$height:0,pad_left:0,pad_right:0,pad_top:0,pad_bottom:0};lay(t){const e=this.#t.style;if("style"in t)if(t.style){const s=document.createElement("span");s.style.cssText=t.style;const i=s.style.length;for(let a=0;a<i;++a){const n=s.style[a];if(n in _.#g){K.myTrace(`${n}は指定できません`,"W");continue}e[n]=s.style[n]}!s.style.opacity&&"alpha"in t&&(e.opacity=String(this.ctn.alpha))}else this.#t.style.cssText="";else"alpha"in t&&(e.opacity=String(this.ctn.alpha));if("width"in t&&(e.width=(t.width??"0")+"px"),"height"in t&&(e.height=(t.height??"0")+"px"),"pl"in t&&(e.paddingLeft=(t.pl??"0")+"px"),"pr"in t&&(e.paddingRight=(t.pr??"0")+"px"),"pt"in t&&(e.paddingTop=(t.pt??"0")+"px"),"pb"in t&&(e.paddingBottom=(t.pb??"0")+"px"),this.#o.lay(t),this.#u(),this.#f=this.ctn.position.x,e.transformOrigin=`${this.ctn.pivot.x}px ${this.ctn.pivot.y}px`,this.cvsResize(),e.display=this.ctn.visible?"inline":"none",":redraw"in t&&this.#n>0){const s=[this.#t.innerHTML.replaceAll(/(animation-delay: )\d+ms/g,"$10ms"),`<span class='sn_ch' data-add='{"ch_in_style":"default"}'>&emsp;</span>`];this.#v(),this.goTxt(s,!0)}}#d=0;#u(){const t=this.#t.style,e=parseFloat(t.fontSize||"0");this.#s.fontsize=e,this.#s.pad_left=parseFloat(t.paddingLeft||"0"),this.#s.pad_right=parseFloat(t.paddingRight||"0"),this.#s.pad_top=parseFloat(t.paddingTop||"0"),this.#s.pad_bottom=parseFloat(t.paddingBottom||"0"),this.#s.$width=parseFloat(t.width||"0"),this.#s.$height=parseFloat(t.height||"0"),this.position.set(this.#s.pad_left,this.#s.pad_top),this.#c=t.writingMode==="vertical-rl",this.#_=0,this.#h=0;const s=t.lineHeight??"0";this.#d=this.#c?0:(s.endsWith("px")?parseFloat(s):e*parseFloat(s)-e)/2}cvsResize(){const t=this.#t.style,e=this.sys.cvsScale;t.left=`${this.sys.ofsLeft4elm+this.#f*e}px`,t.top=`${this.sys.ofsTop4elm+this.ctn.position.y*e}px`,t.transform=`rotate(${this.ctn.angle}deg) scale(${this.ctn.scale.x*e}, ${this.ctn.scale.y*e})`}#f=0;#c=!1;get tategaki(){return this.#c}#_=0;#h=0;get infTL(){return this.#s}get getWidth(){return this.#s.$width}get getHeight(){return this.#s.$height}setMySize(t,e){this.#s.$width=t,this.#s.$height=e,this.#t.style.width=this.#s.$width+"px",this.#t.style.height=this.#s.$height+"px"}#z(t,e=!0){const s={escape:c=>c.replaceAll(/([.*+?^${}()|\[\]\/\\])/g,"\\$1"),mimeType:c=>{const f=r(c).toLowerCase();return i()[f]||""},dataAsUrl:g,isDataUrl:d,resolveUrl:p,getAndEncode:l,asArray:c=>{const f=[],y=c.length;for(let k=0;k<y;++k)f.push(c[k]);return f}};function i(){const c="application/font-woff",f="image/jpeg";return{woff:c,woff2:c,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:f,jpeg:f,gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"}}const a=u(),n=o();function h(c){return n.resolveAll().then(f=>{const y=document.createElement("style");return c.appendChild(y),y.appendChild(document.createTextNode(f)),c})}function r(c){return/\.([^\.\/]*?)$/g.exec(c)?.[1]??""}function d(c){return c.search(/^(data:)/)!==-1}function p(c,f){const y=document.implementation.createHTMLDocument(),k=y.createElement("base");y.head.appendChild(k);const b=y.createElement("a");return y.body.appendChild(b),k.href=f,b.href=c,b.href}function l(c){let f=3e4;return new Promise(function(y){const k=new XMLHttpRequest;k.onreadystatechange=b,k.ontimeout=T,k.responseType="blob",k.timeout=f,k.open("GET",c,!0),k.send();function b(){if(k.readyState!==4)return;if(k.status!==200){v("cannot fetch resource: "+c+", status: "+k.status);return}const C=new FileReader;C.onloadend=function(){const S=C.result.toString().split(/,/)[1];y(S)},C.readAsDataURL(k.response)}function T(){v("timeout of "+f+"ms occured while fetching resource: "+c)}function v(C){console.error(C),y("")}})}function g(c,f){return"data:"+f+";base64,"+c}function u(){const c=/url\(['"]?([^'"]+?)['"]?\)/g;return{inlineAll:b,shouldProcess:f};function f(T){return T.search(c)!==-1}function y(T){const v=[];let C;for(;C=c.exec(T);)v.push(C[1]);return v.filter(function(S){return!s.isDataUrl(S)})}function k(T,v,C,S){return Promise.resolve(v).then(P=>C?s.resolveUrl(P,C):P).then(S||s.getAndEncode).then(P=>s.dataAsUrl(P,s.mimeType(v))).then(P=>T.replace(A(v),"$1"+P+"$3"));function A(P){return new RegExp(`(url\\(['"]?)(`+s.escape(P)+`)(['"]?\\))`,"g")}}function b(T,v,C){if(S())return Promise.resolve(T);return Promise.resolve(T).then(y).then(A=>{let P=Promise.resolve(T);for(const D of A)P=P.then(nt=>k(nt,D,v,C));return P});function S(){return!f(T)}}}function o(){return{resolveAll:c,impl:{readAll:f}};function c(){return f().then(y=>Promise.allSettled(y.map(k=>k.resolve()))).then(y=>y.join(`
`))}function f(){return Promise.resolve(s.asArray(document.styleSheets)).then(k).then(y).then(T=>T.map(b));function y(T){return T.filter(v=>v.type===CSSRule.FONT_FACE_RULE).filter(v=>a.shouldProcess(v.style.getPropertyValue("src")))}function k(T){const v=[];for(const C of T)try{if(C.href)continue;s.asArray(C.cssRules||[]).forEach(v.push.bind(v))}catch(S){console.error("Error while reading CSS rules from "+C.href,String(S))}return v}function b(T){return{resolve:function(){const v=(T.parentStyleSheet||{}).href;return a.inlineAll(T.cssText,v)},src:function(){return T.style.getPropertyValue("src")}}}}}Promise.resolve(this.#t).then(c=>{const f=c.cloneNode(!0);return f.style.padding="0px",f.style.paddingRight=this.#_+"px",f.style.paddingTop=this.#h+"px",f.style.left="0px",f.style.top="0px",f.style.width=this.#s.$width-this.#s.pad_left-this.#s.pad_right+"px",f.style.height=this.#s.$height-this.#s.pad_top-this.#s.pad_bottom+"px",this.#t.hidden=e,f}).then(h).then(c=>{c.setAttribute("xmlns","http://www.w3.org/1999/xhtml");const f=new Image;return f.src=`data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="${this.#s.$width}px" height="${this.#s.$height}px"><foreignObject x="0" y="0" width="100%" height="100%">${new XMLSerializer().serializeToString(c).replaceAll("#","%23").replaceAll(`
`,"%0A")}</foreignObject></svg>`,new Promise(y=>f.onload=()=>y(f))}).then(c=>new Promise(f=>setTimeout(()=>f(c),100))).then(c=>{const f=document.createElement("canvas");f.width=this.#s.$width,f.height=this.#s.$height,f.getContext("2d").drawImage(c,0,0),t(H.from(f))}).catch(c=>K.myTrace(`goTxt() = ${c}`))}#$=[];goTxt(t,e){const s=()=>this.#C(t,e);this.#$.push(s)===1&&s()}#w=[];#n=0;static#y="<span class='sn_ch sn_ch_last'>&emsp;</span>";#C(t,e){_.#S.visible=!1;let s=this.#w.length,i="";if(s===0){if(_.#i.oCfg.debug.masume&&(E.debugLog&&console.log(`🍌 masume ${this.name} v:${this.visible} l:${this.x} t:${this.y} a:${this.alpha} pl:${this.#s.pad_left} pr:${this.#s.pad_right} pt:${this.#s.pad_top} pb:${this.#s.pad_bottom} w:${this.#s.$width} h:${this.#s.$height}`),this.#p.clear().beginFill(3407616,.2).lineStyle(1,3407616,1).drawRect(-this.#s.pad_left,-this.#s.pad_top,this.#s.$width,this.#s.$height).endFill().beginFill(13311,.2).lineStyle(2,13311,1).drawRect(0,0,this.#s.$width-this.#s.pad_left-this.#s.pad_right,this.#s.$height-this.#s.pad_top-this.#s.pad_bottom).endFill()),this.#t.innerHTML=[...t].join("").replaceAll(/[\n\t]/g,"")+_.#y,!this.#o.break_fixed){const c=globalThis.getComputedStyle(this.#t),f=parseFloat(c.fontSize);this.#c?(this.#o.break_fixed_left=(this.#s.$width-this.#s.pad_left-this.#s.pad_right-f*1.5)*this.sys.cvsScale,this.#o.break_fixed_top=0):(this.#o.break_fixed_left=0,this.#o.break_fixed_top=f/2*this.sys.cvsScale)}}else i=this.#t.innerHTML,--s,this.#t.getElementsByClassName("sn_ch_last").item(0)?.remove(),this.#t.querySelectorAll(":scope > br").forEach(c=>c.remove()),this.#t.insertAdjacentHTML("beforeend",t.slice(this.#n).join("").replaceAll(/[\n\t]/g,"")+_.#y);this.#t.querySelectorAll(".sn_ch:has(> ruby)").forEach(c=>c.style.background=""),this.#n=t.length;const a=this.sys.cvsScale,n=this.#t.getBoundingClientRect(),h=n.left+this.#s.pad_left,r=n.top+this.#s.pad_top;let d;if(a===1)d=(c,f)=>{const y=c.getBoundingClientRect();return new J(y.left-h,y.top-r,y.width,y.height+("gjqy".includes(f)?this.#d:0))};else{const c=this.sys.ofsPadLeft_Dom2PIXI+n.left*(1-a),f=this.sys.ofsPadTop_Dom2PIXI+n.top*(1-a);d=(y,k)=>{const b=y.getBoundingClientRect();return new J((b.left-c)/a-h,(b.top-f)/a-r,b.width/a,(b.height+("gjqy".includes(k)?this.#d:0))/a)}}const[p,l]=this.#o.hyph(this.#t,d,this.#c,s,i);this.#w=p;const g=R.ease(this.#m);for(let c=s;c<l;++c){const f=this.#w[c],{elm:{dataset:y,parentElement:k},rect:b}=f,T=JSON.parse(y.arg??'{"delay": 0}'),v=JSON.parse(y.add??"{}"),C=_.#V[v.ch_in_style];if(this.#b(f),y.cmd==="grp"){const S=new V;this.#l.addChild(S),new m(T.pic,S,A=>{this.#I(S,T,v,b,g,C??{}),S.parent||S.removeChild(A)})}if(y.lnk){const S=k.closest("[data-arg]"),A=JSON.parse(S.dataset.arg??"{}");A.key=`lnk=[${c}] `+this.name;const P=new O;this.#I(P,A,v,b,g,C??{});const D=A.style??"",nt=D+(A.style_hover??""),kt=D+(A.style_clicked??""),Z=A.r_style??"",$t=Z+(A.r_style_hover??""),vt=Z+(A.r_style_clicked??""),ft=Array.from(S.getElementsByTagName("rt"));for(const et of ft)et.dataset.st_r_bk=et.style.cssText;const Tt=S.style.cssText,tt=(et,Ct)=>{S.style.cssText=Tt+et;for(const pt of ft)pt.style.cssText=pt.dataset.st_r_bk+Ct};N(A,"enabled",!0)?_.#a.button(A,P,()=>tt(D,Z),()=>this.canFocus()?(tt(nt,$t),!0):!1,()=>tt(kt,vt)):tt(D+(A.style_disable??"color: gray;"),Z+(A.r_style_disable??"color: gray;")),this.#l.addChild(P)}}const u=Array.from(this.#t.getElementsByClassName("sn_ch_yet"));this.#L=()=>{this.#L=()=>!1;for(const f of u)f.className="sn_ch";_.#S.position.set(this.#o.break_fixed_left,this.#o.break_fixed_top),_.#S.visible=!0,this.noticeCompTxt();const c=this.#$.shift();return this.#$.length>0&&c(),!0};for(const c of u)c.className=c.className.replace("sn_ch_yet sn","go");s>0&&++s;let o;for(let c=l-2;c>=0;--c){const{elm:f}=this.#w[c];if(f.tagName==="SPAN"){o=f.parentElement?.tagName==="RUBY"?f.parentElement.parentElement??f:f;break}}if(!o||e||s===l){this.#L();return}o.addEventListener("animationend",()=>this.#L(),{once:!0})}#L=()=>!1;#I(t,e,s,i,a,n){t.alpha=0,e.x&&(i.x=e.x.startsWith("=")?i.x+parseInt(e.x.slice(1)):parseInt(e.x)),e.y&&(i.y=e.y.startsWith("=")?i.y+parseInt(e.y.slice(1)):parseInt(e.y)),e.width&&(i.width=parseInt(e.width)),e.height&&(i.height=parseInt(e.height)),e.wait&&(n.wait=parseInt(e.wait)),t.width=i.width,t.height=i.height,n.x?t.position.set(n.x.startsWith("=")?i.x+t.width*n.nx:n.nx,n.y.startsWith("=")?i.y+t.height*n.ny:n.ny):t.position.set(i.x,i.y);const h={sp:t,tw:new Vt(t).to({alpha:1,x:i.x,y:i.y,width:i.width,height:i.height,angle:0},n.wait??0).easing(a).delay((s.wait??0)+(e.delay??0)).onComplete(()=>{h.tw=void 0}).start()};this.#B.push(h)}#B=[];skipChIn(){let t=this.#L();for(const e of this.#B)e.tw&&(e.tw.stop().end(),t=!0);return this.#B=[],t}static#V=Object.create(null);static#U=/[{\s\.,*\{]/;static initChStyle(){_.#V=Object.create(null),_.#N=Object.create(null)}static getChInStyle(t){return _.#V[t]}static ch_in_style(t){const{name:e}=t;if(!e)throw"nameは必須です";if(_.#U.test(e))throw`name【${e}】に使えない文字が含まれます`;if(e in _.#V)throw`name【${e}】はすでにあります`;const s=String(t.x??"=0"),i=String(t.y??"=0");return _.#V[e]={wait:w(t,"wait",500),alpha:w(t,"alpha",0),x:s,y:i,nx:parseFloat(s.at(0)==="="?s.slice(1):s),ny:parseFloat(i.at(0)==="="?i.slice(1):i),scale_x:w(t,"scale_x",1),scale_y:w(t,"scale_y",1),rotate:w(t,"rotate",0),join:N(t,"join",!0),ease:t.ease??"ease-out"}}static#N=Object.create(null);static getChOutStyle(t){return _.#N[t]}static ch_out_style(t){const{name:e}=t;if(!e)throw"nameは必須です";if(_.#U.test(e))throw`name【${e}】に使えない文字が含まれます`;if(e in _.#N)throw`name【${e}】はすでにあります`;const s=String(t.x??"=0"),i=String(t.y??"=0");return _.#N[e]={wait:w(t,"wait",500),alpha:w(t,"alpha",0),x:s,y:i,nx:parseFloat(s.at(0)==="="?s.slice(1):s),ny:parseFloat(i.at(0)==="="?i.slice(1):i),scale_x:w(t,"scale_x",1),scale_y:w(t,"scale_y",1),rotate:w(t,"rotate",0),join:N(t,"join",!1),ease:t.ease??"ease-out"}}static#S=new V;static#A=new m;dispBreak(t){_.delBreak();const e=_.#S;e.visible=!1,this.addChild(e),_.#A.destroy(),_.#A=new m(t.pic,e,s=>{e.parent?(s.x=w(t,"x",0),s.y=w(t,"y",0),s.width=w(t,"width",this.#s.fontsize),s.height=w(t,"height",this.#s.fontsize)):e.removeChild(s)})}static delBreak(){const t=_.#S;t.parent?.removeChild(t),_.#A.destroy()}#m="Quadratic.Out";#M="Quadratic.Out";#v(){this.#p.clear(),this.#w=[],this.#n=0,this.#$=[],this.skipChIn();const t=this.#t.cloneNode(!0);t.textContent="";const e=this.#t,s=Array.from(e.getElementsByClassName("sn_ch"));e.parentElement.insertBefore(t,e);let i=0;s.forEach(n=>{const h=JSON.parse(n.dataset.add??n.children[0]?.getAttribute("data-add")??n.children[0]?.children[0]?.getAttribute("data-add")??"{}");if(!h.ch_out_style)return;const r=_.#N[h.ch_out_style];if(r){if(r.wait===0){n.style.display="none";return}i+=r.wait,r.join||(n.style.animationDelay="0ms"),n.classList.add(`go_ch_out_${h.ch_out_style}`)}});const a=()=>{e.parentElement.removeChild(e);for(const n of this.#l.removeChildren())n instanceof V&&_.#a.unButton(n),n.destroy()};i===0?(this.#t.textContent="",a()):e.lastElementChild?.addEventListener("animationend",a,{once:!0}),this.#t=t}reNew(){this.#v();const t=new _(this.ctn,()=>this.canFocus(),this.sys);return t.#s=this.#s,t.#t.style.cssText=this.#t.style.cssText,t.#f=this.#f,t.name=this.name,t.#u(),t.#T=this.#T,t.#m=this.#m,t.#M=this.#M,this.#o.reNew(t.#o),this.destroy(),t}#T=void 0;record(){return{infTL:this.#s,cssText:this.#t.style.cssText,left:this.#f,ch_filter:this.#T,fi_easing:this.#m,fo_easing:this.#M,hyph:this.#o.record()}}playback(t){this.#s=t.infTL,this.position.set(this.#s.pad_left,this.#s.pad_top),this.#t.style.cssText=t.cssText,this.#f=t.left,this.#u(),this.#T=t.ch_filter,this.#m=t.fi_easing,this.#M=t.fo_easing,this.#o.playback(t.hyph)}get cssText(){return this.#t.style.cssText}set cssText(t){this.#t.style.cssText=t}#k=void 0;snapshot(t,e){this.#z(s=>{this.#k=O.from(s),this.#c&&(this.#k.x+=E.stageW-(this.#f+this.#s.$width)),this.#k.y-=this.#h,this.#k.texture.frame=new J(0,0,Math.min(this.#k.width,this.#s.$width-this.#f),Math.min(this.#k.height,this.#s.$height)),this.#l.addChild(this.#k),t.render(this.#k,{clear:!1}),e()},!1)}snapshot_end(){this.#k&&(this.#l.removeChild(this.#k),this.#k=void 0)}makeDesignCast(t){}showDesignCast(){}dump(){const t=[],e=this.#t.style,s=e.length;for(let i=0;i<s;++i){const a=e[i];t.push(`"${a}":"${e[a].replaceAll(/(["\\])/g,"\\$1")}"`)}return`"txt":"${this.#t.textContent.replaceAll(/(["\\])/g,"\\$1")}", "style":{${t.join(",")}}`}destroy(){_.delBreak(),this.#t.parentElement.removeChild(this.#t),this.removeChild(this.#l),this.removeChild(this.#p),super.destroy()}}class j extends V{constructor(t,e,s,i){if(super(),this.hArg=t,this.evtMng=e,this.resolve=s,this.canFocus=i,this.#t={type:"pic",enabled:N(t,"enabled",!0),x:this.x=W(t.left??0),y:this.y=W(t.top??0),rotation:this.angle=w(t,"rotation",this.angle),pivot_x:this.pivot.x=w(t,"pivot_x",this.pivot.x),pivot_y:this.pivot.y=w(t,"pivot_y",this.pivot.y),scale_x:this.scale.x=w(t,"scale_x",this.scale.x),scale_y:this.scale.y=w(t,"scale_y",this.scale.y),alpha:1,text:"",b_pic:"",width:0,height:0},this.getBtnBounds=()=>(this.#a.x=this.#t.x,this.#a.y=this.#t.y,this.#a),this.#t.enabled&&e.button(t,this,()=>this.normal(),()=>this.#p(),()=>this.#g()),t.pic){this.#t.type="pic",this.#r=new m(t.pic,this,l=>{this.#o(l),this.#a.width=l.width*this.#t.scale_x,this.#a.height=l.height*this.#t.scale_y},l=>s);return}if(!t.text)throw"textまたはpic属性は必須です";const a=w(t,"height",30),n=new St({align:"center",dropShadow:!0,dropShadowAlpha:.7,dropShadowColor:"white",dropShadowBlur:7,dropShadowDistance:0,fill:this.#t.enabled?"black":"gray",fontFamily:j.fontFamily,fontSize:a,padding:5});if(t.style)try{const l=JSON.parse(t.style);for(const[g,u]of Object.entries(l))n[g]=u;this.#t={...this.#t,...l}}catch(l){throw l instanceof SyntaxError?new Error(ht(t,"style",l.message)):"fn:Button.ts style"}const h=new Et(t.text??"",n);h.alpha=w(t,"alpha",h.alpha),h.width=w(t,"width",100),h.height=t.height=a,this.setText=l=>h.text=l,this.#t={...this.#t,type:"text",alpha:h.alpha,text:h.text,width:h.width,height:h.height};let r=!1;if(this.#t.width=this.width,this.#t.height=this.height,t.b_pic&&(this.#t.b_pic=t.b_pic,this.#r=new m(t.b_pic,this,l=>{this.#l(l,h),this.#t.width=this.width,this.#t.height=this.height,h.name=JSON.stringify(this.#t)},l=>{B.setBlendmode(this,t),l&&s()}),r=this.#r.ret),h.name=JSON.stringify(this.#t),this.addChild(h),this.#a.width=h.width,this.#a.height=h.height,t.b_pic||B.setBlendmode(this,t),j.#i(this,h),!this.#t.enabled){r||s();return}const d=n.clone();if(t.style_hover)try{const l=JSON.parse(t.style_hover);for(const[g,u]of Object.entries(l))d[g]=u}catch(l){throw l instanceof SyntaxError?new Error(ht(t,"style_hover",l.message)):"fn:Button.ts style_hover"}else d.fill="white";const p=d.clone();if(t.style_clicked)try{const l=JSON.parse(t.style_clicked);for(const[g,u]of Object.entries(l))p[g]=u}catch(l){throw l instanceof SyntaxError?new Error(ht(t,"style_clicked",l.message)):"fn:Button.ts style_clicked"}else p.dropShadow=!1;this.normal=()=>h.style=n,this.#p=()=>i()?(h.style=d,!0):!1,this.#g=()=>h.style=p,r||s()}static fontFamily="'Hiragino Sans', 'Hiragino Kaku Gothic ProN', '游ゴシック Medium', meiryo, sans-serif";static#i=(t,e)=>{};static#e=(t,e,s,i)=>{};static init(t){t.oCfg.debug.masume&&(j.#i=(e,s)=>e.addChild(new M().beginFill(8926088,.2).lineStyle(1,8926088,1).drawRect(s.x,s.y,s.width,s.height).endFill()),j.#e=(e,s,i,a)=>e.addChild(new M().beginFill(8926088,.2).lineStyle(1,8926088,1).drawRect(s.x,s.y,i,a).endFill()))}setText(t){}getBtnBounds=()=>this.#a;#a=new J;#r=new m;#t;destroy(){this.evtMng.unButton(this),this.#r.destroy(),super.destroy()}makeDesignCast(t){}showDesignCast(){}cvsResize(){}#l(t,e){this.setChildIndex(t,0),t.alpha=e.alpha,t.setTransform(e.x,e.y,1,1,e.rotation,0,0,(t.width-e.width)/2,(t.height-e.height)/2),t.name=e.name}normal=()=>{};#p=()=>!1;#g=()=>{};#o(t){this.#t.alpha=t.alpha=w(this.hArg,"alpha",t.alpha);const e=t.width/3,s=this.#t.enabled?e:t.width,i=t.height,a=t.texture.baseTexture,n=new H(a,new J(0,0,e,i)),h=new H(a,new J(e,0,e,i)),r=new H(a,new J(e*2,0,e,i)),d=()=>t.texture=n;this.#t.enabled&&d(),this.normal=d,this.#p=()=>this.canFocus()?(t.texture=r,!0):!1,this.#g=()=>t.texture=h,"width"in this.hArg?(this.#t.width=W(this.hArg.width),this.scale.x*=this.#t.width/s):this.#t.width=s,"height"in this.hArg?(this.#t.height=W(this.hArg.height),this.scale.y*=this.#t.height/i):this.#t.height=i,t.name=JSON.stringify(this.#t),j.#e(this,t,s,i)}}class x extends B{static#i;static#e;static#a;static#r;static init(t,e,s,i,a,n){x.#i=t,_.init(t,n),x.#e=s,x.#r=i,x.#a=a,s.setDoRecProc(x.chgDoRec),e.autowc=h=>x.#s(h),e.autowc({enabled:!1,text:"",time:0}),e.ch_in_style=h=>x.#t(h),e.ch_out_style=h=>x.#l(h),_.initChStyle(),Nt(),st(t.matchPath(".+",Y.FONT).flatMap(h=>Object.values(h).map(r=>`
@font-face {
	font-family: '${r}';
	src: url('${this.#i.searchPath(r,Y.FONT)}');
}
`)).join("")+`
.sn_tx {
	pointer-events: none;
	user-select: none;
	-webkit-touch-callout: none;
	box-sizing: border-box;
}
.sn_ch {
	position: relative;
	display: inline-block;
}
`),x.#t({name:"default",wait:500,alpha:0,x:"=0.3",y:"=0",scale_x:1,scale_y:1,rotate:0,join:!0,ease:"ease-out"}),x.#l({name:"default",wait:0,alpha:0,x:"=0",y:"=0",scale_x:1,scale_y:1,rotate:0,join:!1,ease:"ease-out"})}static#t(t){const e=_.ch_in_style(t),s=e.x.startsWith("=")?`${e.nx*100}%`:`${e.nx}px`,i=e.y.startsWith("=")?`${e.ny*100}%`:`${e.ny}px`,{name:a}=t;return st(`
.sn_ch_in_${a} {
	position: relative;
	display: inline-block;
}
.go_ch_in_${a} {
	opacity: ${e.alpha};
	position: relative;
	display: inline-block;
	animation: sn_ch_in_${a} ${e.wait}ms ${e.ease} 0s both;
}
@keyframes sn_ch_in_${a} {
	from {transform: rotate(${e.rotate}deg) scale(${e.scale_x}, ${e.scale_y}) translate(${s}, ${i})}
	to {opacity: 1; transform: none;}
}
`),!1}static#l(t){const e=_.ch_out_style(t),s=e.x.startsWith("=")?`${e.nx*100}%`:`${e.nx}px`,i=e.y.startsWith("=")?`${e.ny*100}%`:`${e.ny}px`,{name:a}=t;return st(`
.go_ch_out_${a} {
	position: relative;
	display: inline-block;
	animation: go_ch_out_${a} ${e.wait}ms ${e.ease} 0s both;
}
@keyframes go_ch_out_${a} {
	to {
		opacity: ${e.alpha};
		transform: rotate(${e.rotate}deg) scale(${e.scale_x}, ${e.scale_y}) translate(${s}, ${i});
	}
`),!1}static#p;static#g;static setEvtMng(t,e,s){x.#p=t,x.#g=e,_.setEvtMng(t,s)}static#o=!1;static#b={};static#s(t){x.#o=N(t,"enabled",x.#o),x.#e.setVal_Nochk("save","const.sn.autowc.enabled",x.#o);const{text:e}=t;if("text"in t!="time"in t)throw"[autowc] textとtimeは同時指定必須です";if(x.#e.setVal_Nochk("save","const.sn.autowc.text",e),!e)return x.#e.setVal_Nochk("save","const.sn.autowc.time",""),!1;const s=e.length;if(x.#o&&s===0)throw'[autowc] enabled === false かつ text === "" は許されません';const i=String(t.time).split(",");if(i.length!==s)throw"[autowc] text文字数とtimeに記述された待ち時間（コンマ区切り）は同数にして下さい";x.#b={};for(let a=0;a<s;++a)x.#b[e[a]]=W(i[a]);return x.#e.setVal_Nochk("save","const.sn.autowc.time",t.time),!1}#d=0;#u=0;#f=!1;#c=void 0;#_="";#h=new _(this.ctn,()=>this.canFocus(),x.#g);#z=new lt;#$=document.createElement("span");static#w={"text-align":0,"text-align-last":0,height:0,width:0,"padding-left":0,"padding-right":0,"padding-top":0,"padding-bottom":0};#n=new V;constructor(){super(),this.ctn.addChild(this.#h),this.#z.init(this.#q),this.ctn.addChild(this.#n),this.#n.name="cntBtn",this.lay({style:`width: ${E.stageW}px; height: ${E.stageH}px; font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', '游ゴシック Medium', meiryo, sans-serif; color: white; font-size: 24px; line-height: 1.5; padding: 16px;`,in_style:"default",out_style:"default",back_clear:"true"})}destroy(){this.#c&&(this.ctn.removeChild(this.#c).destroy(),this.#c=void 0),x.#r.recPagebreak(),this.#h.destroy()}static destroy(){x.#o=!1,x.#b={},x.#v=t=>t}set name(t){this.name_=t,this.#h.name=t}get name(){return this.name_}cvsResize(){this.#h.cvsResize()}cvsResizeChildren(){for(const t of this.#n.children)t.cvsResize()}procSetX(t){this.#h.lay({x:t})}procSetY(t){this.#h.lay({y:t})}lay(t){if(super.lay(t),B.setXY(this.ctn,t,this.ctn),t[":id_tag"]=this.name_.slice(0,-7),lt.setting(t),this.#N(t),this.#h.lay(t),"r_align"in t&&(this.#P=t.r_align??""),this.#T=E.isSafari?this.#h.tategaki?(i,a)=>`text-align: start; height: ${a}em; padding-top: ${i}; padding-bottom: ${i};`:(i,a)=>`text-align: start; width: ${a}em; padding-left: ${i}; padding-right: ${i};`:this.#h.tategaki?i=>`text-align: justify; text-align-last: justify; padding-top: ${i}; padding-bottom: ${i};`:i=>`text-align: justify; text-align-last: justify; padding-left: ${i}; padding-right: ${i};`,E.isFirefox&&(this.#k=this.#Z),"r_style"in t)if(t.r_style){const i=document.createElement("span");i.style.cssText=t.r_style;const a=i.style.length,n=this.#$.style;for(let h=0;h<a;++h){const r=i.style[h];if(r in x.#w){K.myTrace(`${r}は指定できません`,"W");continue}const d=i.style[r];d&&(n[r]=d)}}else this.#$.style.cssText="";if("alpha"in t)for(const i of this.#n.children)i.alpha=this.ctn.alpha;this.#y(t),this.#I(t);const e=F.procID+`TxtLayer lay name:${this.name_}`,s=this.#U(t,i=>{i&&F.endProc(e)});return s&&F.beginProc(e),s}#y(t){const{in_style:e}=t;if(!e)return;const s=_.getChInStyle(e);if(!s)throw`存在しないin_style【${e}】です`;this.#C=e,this.#L=s.join}#C="";#L=!0;get width(){return this.#h.getWidth}get height(){return this.#h.getHeight}#I(t){const{out_style:e}=t;if(e){if(!_.getChOutStyle(e))throw`存在しないout_style【${e}】です`;this.#B=e}}#B="";#V=new m;#U(t,e){if("back_clear"in t)return N(t,"back_clear",!1)&&(this.#d=0,this.#u=0,this.#f=!1,this.#_=""),e(!1),!1;this.#u=w(t,"b_alpha",this.#u),this.#f=N(t,"b_alpha_isfixed",this.#f);const s=(this.#f?1:Number(x.#e.getVal("sys:TextLayer.Back.Alpha")))*this.#u;if(t.b_pic){if(this.#_!==t.b_pic)return this.#_=t.b_pic,this.#c&&(this.ctn.removeChild(this.#c),this.#c.destroy()),this.#V=new m(this.#_,this.ctn,i=>{this.#c=i,i.name="back(pic)",i.visible=s>0,i.alpha=s,this.#h.setMySize(i.width,i.height),this.ctn.setChildIndex(i,0),e(!0)}),this.#V.ret}else"b_color"in t&&(this.#d=bt(t,"b_color",0),this.#c&&(this.ctn.removeChild(this.#c),this.#c.destroy()),this.#_="",this.ctn.addChildAt((this.#c=new M).beginFill(this.#d,s).lineStyle(void 0).drawRect(0,0,this.#h.getWidth,this.#h.getHeight).endFill(),0),this.#c.name="back(color)");return this.#c&&(this.#c.visible=s>0,this.#c.alpha=s),e(!1),!1}chgBackAlpha(t){const e=this.#f?this.#u:t*this.#u;this.#c instanceof M&&(this.#c&&(this.ctn.removeChild(this.#c),this.#c.destroy()),this.ctn.addChildAt((this.#c=new M).beginFill(this.#d,e).lineStyle(void 0).drawRect(0,0,this.#h.getWidth,this.#h.getHeight).endFill(),0),this.#c.name="back(color)"),this.#c&&(this.#c.visible=e>0,this.#c.alpha=e)}#N(t){"noffs"in t&&(this.#m=t.noffs??"",this.#M=new RegExp(`[　${this.#m}]`)),"ffs"in t&&(this.#S??="",this.#A=this.#S===""?()=>"":e=>this.#M.test(e)?"":` font-feature-settings: ${this.#S};`)}#S="";#A=t=>"";#m="";#M=/[　]/;static chgDoRec(t){x.#v=t?e=>e:e=>`<span class='offrec'>${e}</span>`}static#v=t=>t;isCur=!1;#T=()=>"";#k=(t,e,s,i="")=>{if(!s)return` style='${i}'`;const a=t.length*2;if(a-e.length<0)return` style='text-align: ${s}; ${i}'`;let n="";switch(s){case"justify":n=this.#T("0",a);break;case"121":n=this.#T(`calc(${(a-e.length)/(e.length*2)}em)`,a);break;case"even":n=this.#T(`calc(${(a-e.length)/(e.length+1)}em)`,a);break;case"1ruby":n=this.#T("1em",a);break;default:n=`text-align: ${s};`}return` style='${n} ${i}'`};#P="";#Z(t,e,s,i=""){if(!s)return` style='${i}'`;const a=t.length*2;if(a-e.length<0)return` style='text-align: ${s}; ${i}'`;let n="";switch(s){case"left":n="ruby-align: start;";break;case"center":n="ruby-align: center;";break;case"right":n="ruby-align: start;";break;case"justify":n="ruby-align: space-between;";break;case"121":n="ruby-align: space-around;";break;case"even":const h=(a-e.length)/(e.length+1);n="ruby-align: space-between; "+(this.#h.tategaki?`padding-top: ${h}em; padding-bottom: ${h}em;`:`padding-left: ${h}em; padding-right: ${h}em;`);break;case"1ruby":n="ruby-align: space-between; "+(this.#h.tategaki?"padding-top: 1em; padding-bottom: 1em;":"padding-left: 1em; padding-right: 1em;");break;default:n=`text-align: ${s};`}return` style='${n} ${i}'`}tagCh(t){this.#z.putTxt(t)}#F=!1;get needGoTxt(){return this.#F}#q=(t,e)=>{x.#i.oCfg.debug.putCh&&console.log(`🖊 文字表示 text:\`${t}\`(${t.charCodeAt(0).toString(16)}) ruby:\`${e}\` name:\`${this.name_}\``);const s=e.split("｜");let i="";const[a,...n]=s,h=n.join("｜");switch(s.length){case 1:if(this.#F=!0,t===`
`){this.#R?(this.#R=!1,i="<ruby>&emsp;<rt>&emsp;</rt></ruby><br/>"):i="<br/>";break}this.#R&&(this.#R=!1,e===""&&(e="&emsp;")),i=this.#G(t,e,this.#P);break;default:switch(a){case"start":case"left":case"center":case"right":case"justify":case"121":case"even":case"1ruby":this.#R=!1,this.#F=!0,i=this.#G(t,h,a);break;case"gotxt":this.#X(),this.#F?(this.isCur&&x.#r.recText(this.#E.join("").replace(/^<ruby>&emsp;<rt>&emsp;<\/rt><\/ruby>(<br\/>)+/,"").replaceAll(/style='(anim\S+ [^;]+;\s*)+/g,"style='").replaceAll(/( style=''| data-(add|arg|cmd)='[^']+'|\n+|\t+)/g,"").replaceAll(/class='sn_ch[^']+/g,"class='sn_ch").replaceAll("display: none;","").replaceAll("class='offrec'","style='display: none;'")),this.#h.goTxt(this.#E,this.#j===0),this.#F=!1,this.#j=0):this.isCur&&this.#h.noticeCompTxt();return;case"add":{const r=JSON.parse(h),{style:d="",wait:p=null}=r,{cl:l,sty:g}=this.#W(!0,p);this.#E.push(`<span${l} style='${g} display: inline; ${d}'>`),delete r.style,this.#Q(r)}return;case"add_close":this.#E.push("</span>"),this.#X();return;case"grp":this.#F=!0;{const r=JSON.parse(h);if(r.id??=this.#E.length,r.id==="break"){this.#h.dispBreak(r);return}this.#R=!1,r.delay=this.#j,r.r??="",r.style??="",r.r_style??="";const{cl:d,sty:p,lnk:l}=this.#W(!0,r.wait);i=`<span${d} style='${p} ${r.style}'><ruby><span data-cmd='grp' data-arg='${JSON.stringify(r)}'${l} style='${p} display: inline;'>&emsp;</span><rt${l}${this.#k("　",r.r,this.#P,this.#$.style.cssText+(this.#x.at(-1)?.o.r_style??"")+r.r_style)}>${r.r}</rt></ruby></span>`}break;case"tcy":this.#R=!1,this.#F=!0;{const{t:r,r:d="",wait:p=null,style:l="",r_style:g=""}=JSON.parse(h);x.#e.doRecLog()&&(this.#D+=t+(e?`《${e}》`:""),this.#H+=r);const u=E.isSafari?d.replaceAll(/[A-Za-z0-9]/g,y=>String.fromCharCode(y.charCodeAt(0)+65248)):d,{cl:o,sty:c,lnk:f}=this.#W(!0,p);i=`<span${o} style='${c}${this.#A(r)} ${l}'><ruby><span${f} style='${c} display: inline; text-combine-upright: all;'>${r}</span><rt${f}${this.#k(r,u,this.#P,this.#$.style.cssText+(this.#x.at(-1)?.o.r_style??"")+g)}>${u}</rt></ruby></span>`}break;case"del":_.delBreak();return;case"span":this.#F=!0,this.#K(JSON.parse(h));return;case"link":this.#F=!0;{const r=JSON.parse(h);r[":link"]=" data-lnk='@'";const{cl:d,sty:p,curpos:l}=this.#W(!1,r.wait);this.#E.push(`<span${d} style='${p} display: inline; ${r.style??""}' ${l} data-arg='${h}'>`),delete r.style,this.#K(r)}return;case"endlink":this.#F=!0,this.#E.push("</span>"),this.#X();return;default:this.#F=!0,i=this.#G(t,e,this.#P)}break}this.#E.push(x.#v(i))};#G(t,e,s){const i=t===" "?"&nbsp;":t==="　"?"&emsp;":t;x.#e.doRecLog()&&(this.#D+=i+(e?`《${e}》`:""),t!==" "&&(this.#H+=t));const{cl:a,sty:n,lnk:h}=this.#W(!0,null,t);return e?`<span${a} style='${n} ${this.#A(t)}'><ruby>${Array.from(t).map((r,d)=>`<span${a}${h} style='${d>0?this.#W(!0,null,t).sty:n} display: inline;'>${r===" "?"&nbsp;":r==="　"?"&emsp;":r}</span>`).join("")}<rt${h}${this.#k(t,e,s,this.#$.style.cssText+(this.#x.at(-1)?.o.r_style??""))}>${e}</rt></ruby></span>`:`<span${a} style='${n} ${this.#A(t)}'${h}>${i}</span>`}#W(t,e,s=`
`){const i=this.#L?e??this.#x.at(0)?.o.wait??(x.#o?x.#b[s.at(0)??""]??0:z.msecChWait):0;x.#p.isSkipping?this.#j=0:t&&this.#L&&(this.#j+=Number(i));const a=`data-add='{"ch_in_style":"${this.#C}", "ch_out_style":"${this.#B}"}'`;return{cl:` class='sn_ch sn_ch_yet sn_ch_in_${this.#C}'`,sty:`animation-delay: ${this.#j}ms;${this.#x.at(-1)?.o.style??""}`,lnk:(this.#x.at(0)?.o[":link"]??"")+" "+a,curpos:a}}#j=0;#R=!0;#E=[];#x=[];#Q(t){this.#x.push({o:t,r_align:this.#P,ch_in_style:this.#C,ch_out_style:this.#B}),"r_align"in t&&(this.#P=t.r_align),this.#y(t),this.#I(t)}#X(){const t=this.#x.pop();t&&(this.#P=t.r_align,this.#y({in_style:t.ch_in_style}),this.#I({out_style:t.ch_out_style}))}#K(t){const e=this.#x.at(-1);if(!e){this.#Q(t);return}e.o={...e.o,...t},!t.style&&!t.r_style&&(e.o.style="",e.o.r_style=""),"r_align"in t&&(this.#P=t.r_align),this.#y(t),this.#I(t)}click=()=>!this.ctn.interactiveChildren||!this.ctn.visible?!1:this.#h.skipChIn();clearText(){this.ctn.addChild(this.#h=this.#h.reNew()),this.#j=0,this.#R=!0,this.#E=[],this.#D="",this.#H="",x.#r.recPagebreak()}#D="";#H="";get pageText(){return this.#D.replace("《&emsp;》","")}get pagePlainText(){return this.#H}get enabled(){return this.ctn.interactiveChildren}set enabled(t){this.ctn.interactiveChildren=t}addButton=t=>new Promise(e=>{t.key=`btn=[${this.#n.children.length}] `+this.name_,t[":id_tag"]=t.key.slice(0,-7),N(t,"hint_tate",this.#h.tategaki);const s=new j(t,x.#p,()=>e(),()=>this.canFocus());s.name=JSON.stringify(t).replaceAll('"',"'"),this.#n.addChild(s)});canFocus(){return(this.ctn.interactiveChildren??!1)&&this.ctn.visible&&x.#a(this)}clearLay(t){super.clearLay(t),this.clearText();for(const e of this.#n.removeChildren())e.destroy()}record=()=>({...super.record(),enabled:this.enabled,r_cssText:this.#$.style.cssText,r_align:this.#P,b_do:this.#c===void 0?void 0:this.#c instanceof O?"Sprite":"Graphics",b_pic:this.#_,b_color:this.#d,b_alpha:this.#u,b_alpha_isfixed:this.#f,ffs:this.#S,txs:this.#h.record(),strNoFFS:this.#m,btns:this.#n.children.map(t=>t.name)});playback(t,e){super.playback(t,e),this.enabled=t.enabled,this.#$.style.cssText=t.r_cssText,this.#P=t.r_align,this.cvsResize(),this.#N(t),this.#h.playback(t.txs),this.#u=t.b_alpha,this.#f=t.b_alpha_isfixed,e=[e,new Promise(s=>{const i=t.b_do?t.b_do==="Sprite"?{b_pic:t.b_pic}:{b_color:t.b_color}:{b_pic:""};i.b_alpha=t.b_alpha,i.b_alpha_isfixed=t.b_alpha_isfixed,this.#U(i,a=>{a&&s()})||s()}),t.btns.map(s=>new Promise(i=>{this.addButton(JSON.parse(s.replaceAll("'",'"'))),i()}))].flat()}get cssText(){return this.#h.cssText}set cssText(t){this.#h.cssText=t}snapshot(t,e){t.render(this.ctn,{clear:!1}),this.#h.snapshot(t,e)}snapshot_end(){this.#h.snapshot_end()}makeDesignCast(t){this.ctn.visible&&this.#h.makeDesignCast(t)}makeDesignCastChildren(t){if(this.ctn.visible)for(const e of this.#n.children)e.makeDesignCast(t)}showDesignCast(){this.#h.showDesignCast()}showDesignCastChildren(){for(const t of this.#n.children)t.showDesignCast()}dump(){return this.#q("","gotxt｜"),super.dump()+`, "enabled":"${this.enabled}", ${this.#h.dump()}, "b_pic":"${this.#_}", "b_color":"${this.#d}", "b_alpha":${this.#u}, "b_alpha_isfixed":"${this.#f}", "width":${this.#h.getWidth}, "height":${this.#h.getHeight}, "pixi_obj":[${this.ctn.children.map(t=>`{"class":"${t instanceof O?"Sprite":t instanceof M?"Graphics":t instanceof V?"Container":"?"}", "name":"${t.name}", "alpha":${t.alpha}, "x":${t.x}, "y":${t.y}, "visible":"${t.visible}"}`).join(",")}], "button":[${this.#n.children.map(t=>t.children[0]?.name??"{}").join(",")}]`}}class ${constructor(t,e,s){this.appPixi=e,this.val=s,t.add_frame=i=>this.#p(i),t.let_frame=i=>this.#u(i),t.set_frame=i=>this.#f(i),t.frame=i=>this.#_(i),t.tsy_frame=i=>this.#h(i)}static#i;static#e;static#a;static init(t,e,s){$.#i=t,$.#e=e,$.#a=s}#r;setEvtMng(t){this.#r=t}#t=Object.create(null);destroy(){for(const t of Object.values(this.#t))t.parentElement.removeChild(t);this.#t=Object.create(null)}hideAllFrame(){for(const[t,{style:e}]of Object.entries(this.#t))this.#l[t]=e.display!=="none",e.display="none"}#l=Object.create(null);restoreAllFrame(){for(const[t,e]of Object.entries(this.#l)){const s=this.#t[t];s&&(s.style.display=e?"inline":"none")}this.#l=Object.create(null)}#p(t){const{id:e,src:s,alpha:i=1,scale_x:a=1,scale_y:n=1,rotate:h=0}=t;if(!e)throw"idは必須です";if(!s)throw"srcは必須です";const r="const.sn.frm."+e;if(this.val.getVal(`tmp:${r}`))throw`frame【${e}】はすでにあります`;const d=N(t,"visible",!0),p=t.b_color?` background-color: ${t.b_color};`:"",l=this.#o(t);$.#a.cvs.insertAdjacentHTML("beforebegin",`<iframe id="${e}" style="opacity: ${i}; ${p} position: absolute; left:${$.#e.ofsLeft4elm+l.x*$.#e.cvsScale}px; top: ${$.#e.ofsTop4elm+l.y*$.#e.cvsScale}px; z-index: 1; border: 0px; overflow: hidden; display: ${d?"inline":"none"}; transform: scale(${a}, ${n}) rotate(${h}deg);" width="${l.width*$.#e.cvsScale}" height="${l.height*$.#e.cvsScale}"></iframe>`);const g=F.procID+`add_frame id:${e}`;F.beginProc(g);const u=$.#i.searchPath(s,Y.HTML),o=new U().add({name:s,url:u,xhrType:L.XHR_RESPONSE_TYPE.TEXT});return $.#e.arg.crypto&&o.use(async(c,f)=>{try{c.data=await $.#e.dec(c.extension,c.data)}catch(y){$.#a.errScript(`[add_frame]Html ロード失敗です src:${c.name} ${y}`,!1)}f()}),o.load((c,f)=>{const y=document.getElementById(e);this.#t[e]=y,this.#g[e]=!1;const k=u.lastIndexOf("/")+1,b=u.slice(0,k),T=b.slice(0,k);y.srcdoc=String(f[s]?.data).replace("sn_repRes();","").replaceAll(/\s(?:src|href)=(["'])(\S+?)\1/g,(v,C,S)=>S.startsWith("../")?T+v.slice(3):v.replace("./","").replace(C,C+b)),y.srcdoc.includes("true/*WEBP*/;")&&(y.srcdoc=y.srcdoc.replaceAll(/data-src="(.+?\.)(?:jpe?g|png)/g,(v,C)=>`data-src="${C}webp`)),y.onload=()=>{F.endProc(g),this.val.setVal_Nochk("tmp",r,!0),this.val.setVal_Nochk("tmp",r+".alpha",i),this.val.setVal_Nochk("tmp",r+".x",l.x),this.val.setVal_Nochk("tmp",r+".y",l.y),this.val.setVal_Nochk("tmp",r+".scale_x",a),this.val.setVal_Nochk("tmp",r+".scale_y",n),this.val.setVal_Nochk("tmp",r+".rotate",h),this.val.setVal_Nochk("tmp",r+".width",l.width),this.val.setVal_Nochk("tmp",r+".height",l.height),this.val.setVal_Nochk("tmp",r+".visible",d);const v=y.contentWindow;this.#r.resvFlameEvent(v.document.body),v.sn_repRes?.(C=>$.#b(C.dataset.src??"",C))}}),!0}#g={};getFrmDisabled(t){return this.#g[t]}#o(t){const e={...t},s=$.#e.resolution;return new DOMRect(w(e,"x",0)*s,w(e,"y",0)*s,w(e,"width",E.stageW)*s,w(e,"height",E.stageH)*s)}static#b(t,e,s){const i=this.#d[t];if(i){e.src=i,s&&(e.onload=()=>s(e));return}const a=this.#s[t];if(a){a.push(e);return}this.#s[t]=[e];const[n="",h=""]=t.split("?"),r=$.#i.searchPath(n,Y.SP_GSM),d=new U().add({name:t,url:r,xhrType:L.XHR_RESPONSE_TYPE.BUFFER});$.#e.arg.crypto&&r.endsWith(".bin")&&d.use(async(p,l)=>{try{const g=await $.#e.decAB(p.data);if(p.extension!=="bin"){l();return}p.data=g,g instanceof HTMLImageElement&&(p.type=L.TYPE.IMAGE)}catch(g){$.#a.errScript(`FrameMng loadPic ロード失敗です fn:${p.name} ${g}`,!1)}l()}),d.load((p,l)=>{for(const[g,{data:{src:u}}]of Object.entries(l)){const o=this.#d[g]=u+(u.startsWith("blob:")||u.startsWith("data:")?"":h?"?"+h:""),c=this.#s[g];if(c)for(const f of c)f.src=o,s&&(f.onload=()=>s(f));delete this.#s[g]}})}static#s={};static#d={};cvsResize(){for(const[t,e]of Object.entries(this.#t)){const s="const.sn.frm."+t,i=Number(this.val.getVal(s+".x")),a=Number(this.val.getVal(s+".y")),n=Number(this.val.getVal(s+".width")),h=Number(this.val.getVal(s+".height"));e.style.left=`${$.#e.ofsLeft4elm+i*$.#e.cvsScale}px`,e.style.top=`${$.#e.ofsTop4elm+a*$.#e.cvsScale}px`,e.width=String(n*$.#e.cvsScale),e.height=String(h*$.#e.cvsScale)}}#u(t){const{id:e,var_name:s}=t;if(!e)throw"idは必須です";const i=document.getElementById(e);if(!i)throw`id【${e}】はフレームではありません`;const a="const.sn.frm."+e;if(!this.val.getVal(`tmp:${a}`))throw`frame【${e}】が読み込まれていません`;if(!s)throw"var_nameは必須です";const n=i.contentWindow;if(!Object.hasOwn(n,s))throw`frame【${e}】に変数/関数【${s}】がありません。変数は var付きにして下さい`;const h=n[s];return this.val.setVal_Nochk("tmp",a+"."+s,N(t,"function",!1)?h():h),!1}#f(t){const{id:e,var_name:s,text:i}=t;if(!e)throw"idは必須です";const a=document.getElementById(e);if(!a)throw`id【${e}】はフレームではありません`;const n="const.sn.frm."+e;if(!this.val.getVal(`tmp:${n}`))throw`frame【${e}】が読み込まれていません`;if(!s)throw"var_nameは必須です";if(!i)throw"textは必須です";this.val.setVal_Nochk("tmp",n+"."+s,i);const h=a.contentWindow;return h[s]=i,!1}#c=1;#_(t){const{id:e}=t;if(!e)throw"idは必須です";const s=document.getElementById(e);if(!s)throw`id【${e}】はフレームではありません`;const i="const.sn.frm."+e;if(!this.val.getVal("tmp:"+i))throw`frame【${e}】が読み込まれていません`;const a=s.style;if(N(t,"float",!1)?a.zIndex=`${++this.#c}`:"index"in t?a.zIndex=`${w(t,"index",0)}`:t.dive&&(a.zIndex=`-${++this.#c}`),"alpha"in t){const h=a.opacity=String(t.alpha);this.val.setVal_Nochk("tmp",i+".alpha",h)}const n=this.#o(t);if(("x"in t||"y"in t)&&(a.left=`${$.#e.ofsLeft4elm+n.x*$.#e.cvsScale}px`,a.top=`${$.#e.ofsTop4elm+n.y*$.#e.cvsScale}px`,this.val.setVal_Nochk("tmp",i+".x",n.x),this.val.setVal_Nochk("tmp",i+".y",n.y)),"scale_x"in t||"scale_y"in t||"rotate"in t){const h=w(t,"scale_x",1),r=w(t,"scale_y",1),d=w(t,"rotate",0);a.transform=`scale(${h}, ${r}) rotate(${d}deg)`,this.val.setVal_Nochk("tmp",i+".scale_x",h),this.val.setVal_Nochk("tmp",i+".scale_y",r),this.val.setVal_Nochk("tmp",i+".rotate",d)}if("width"in t&&(s.width=String(n.width*$.#e.cvsScale),this.val.setVal_Nochk("tmp",i+".width",n.width)),"height"in t&&(s.height=String(n.height*$.#e.cvsScale),this.val.setVal_Nochk("tmp",i+".height",n.height)),"visible"in t){const h=N(t,"visible",!0);a.display=h?"inline":"none",this.val.setVal_Nochk("tmp",i+".visible",h)}if("b_color"in t&&(a.backgroundColor=t.b_color),"disabled"in t){const h=this.#g[e]=N(t,"disabled",!0),r=s.contentDocument.body;for(const d of[...Array.from(r.getElementsByTagName("input")),...Array.from(r.getElementsByTagName("select"))])d.disabled=h}return!1}#h(t){const{id:e,alpha:s,x:i,y:a,scale_x:n,scale_y:h,rotate:r,width:d,height:p}=t;if(!e)throw"idは必須です";const l=document.getElementById(e);if(!l)throw`id【${e}】はフレームではありません`;const g="const.sn.frm."+e;if(!this.val.getVal(`tmp:${g}`,0))throw`frame【${e}】が読み込まれていません`;const u={};s&&(u.a=l.style.opacity),(i||a||n||h||r)&&(u.x=Number(this.val.getVal(`tmp:${g}.x`)),u.y=Number(this.val.getVal(`tmp:${g}.y`)),u.sx=Number(this.val.getVal(`tmp:${g}.scale_x`)),u.sy=Number(this.val.getVal(`tmp:${g}.scale_y`)),u.r=Number(this.val.getVal(`tmp:${g}.rotate`))),d&&(u.w=this.val.getVal(`tmp:${g}.width`)),p&&(u.h=this.val.getVal(`tmp:${g}.height`));const o=R.cnvTweenArg(t,u);let c=()=>{};s&&(w(o,"alpha",0),c=()=>{l.style.opacity=u.a,this.val.setVal_Nochk("tmp","alpha",u.a)});let f=()=>{};const y=this.#o(o);(i||a||n||h||r)&&(y.x,y.y,w(o,"scale_x",1),w(o,"scale_y",1),w(o,"rotate",0),f=()=>{l.style.left=$.#e.ofsLeft4elm+u.x*$.#e.cvsScale+"px",l.style.top=$.#e.ofsTop4elm+u.y*$.#e.cvsScale+"px",l.style.transform=`scale(${u.sx}, ${u.sy}) rotate(${u.r}deg)`,this.val.setVal_Nochk("tmp",g+".x",u.x),this.val.setVal_Nochk("tmp",g+".y",u.y),this.val.setVal_Nochk("tmp",g+".scale_x",u.sx),this.val.setVal_Nochk("tmp",g+".scale_y",u.sy),this.val.setVal_Nochk("tmp",g+".rotate",u.r)});let k=()=>{};d&&(y.width,k=()=>{l.width=u.w*$.#e.cvsScale+"px",this.val.setVal_Nochk("tmp",g+".width",u.w)});let b=()=>{};return p&&(y.height,b=()=>{l.height=u.h*$.#e.cvsScale+"px",this.val.setVal_Nochk("tmp",g+".height",u.h)}),this.appPixi.stage.interactive=!1,R.tween(`frm
${e}`,t,u,R.cnvTweenArg(t,u),()=>{c(),f(),k(),b()},()=>this.appPixi.stage.interactive=!0,()=>{}),!1}}class z{constructor(t,e,s,i,a,n,h,r,d){this.cfg=t,this.hTag=e,this.appPixi=s,this.val=i,this.main=a,this.scrItr=n,this.sys=h,this.sndMng=r,this.prpPrs=d;const p=()=>{if(h.cvsResize(),this.cvsResizeDesign(),this.#o)for(const o of this.#y)this.#n[o].fore.cvsResizeChildren();else for(const o of this.#y)this.#n[o].fore.cvsResize();this.#r.cvsResize(),this.#d.cvsResize()};if(E.isMobile)this.#l.add(globalThis,"orientationchange",p,{passive:!0});else{let o;this.#l.add(globalThis,"resize",()=>{o||(o=setTimeout(()=>{o=void 0,p()},1e3/60*10))},{passive:!0})}h.cvsResize(),x.init(t,e,i,this,o=>this.#n[o.layname].fore===o,s),I.init(a,t,s,h,r,i),$.init(t,h,a),j.init(t),this.#r=new $(e,s,i),h.hFactoryCls.grp=()=>new I,h.hFactoryCls.txt=()=>new x,e.loadplugin=o=>this.#$(o),e.snapshot=o=>this.#c(o),this.#_=this.sys.isApp?this.#h:this.#z,e.add_lay=o=>this.#w(o),e.clear_lay=o=>this.#V(o),e.finish_trans=()=>!1,e.lay=o=>this.#I(o),e.trans=o=>this.#M(o),e.wt=o=>R.wt(o),e.quake=o=>this.#P(o),e.stop_quake=e.finish_trans,e.wq=e.wt,e.pause_tsy=o=>R.pause_tsy(o),e.resume_tsy=o=>R.resume_tsy(o),e.stop_tsy=o=>R.stop_tsy(o),e.tsy=o=>this.#Z(o),e.wait_tsy=o=>R.wait_tsy(o),e.add_filter=o=>this.#F(o),e.clear_filter=o=>this.#G(o),e.enable_filter=o=>this.#W(o),e.ch=o=>this.#E(o),e.clear_text=o=>this.#et(o),e.current=o=>this.#X(o),e.endlink=o=>this.#st(o),e.er=o=>this.#it(o),e.graph=o=>this.#at(o),e.link=o=>this.#nt(o),e.r=o=>this.#ht(o),e.rec_ch=o=>this.#tt(o),e.rec_r=o=>this.#rt(o),e.reset_rec=o=>this.#ot(o),e.ruby2=o=>this.#lt(o),e.span=o=>this.#ct(o),e.tcy=o=>this.#dt(o),e.add_face=o=>m.add_face(o),e.wv=o=>m.wv(o),e.dump_lay=o=>this.#ft(o),e.enable_event=o=>this.#pt(o),e.button=o=>this.#ut(o),t.existsBreakline&&(this.breakLine=o=>{delete o.visible,o.id="break",o.pic="breakline";const c=encodeURIComponent(JSON.stringify(o));this.#f("grp｜"+c)}),t.existsBreakpage&&(this.breakPage=o=>{delete o.visible,o.id="break",o.pic="breakpage";const c=encodeURIComponent(JSON.stringify(o));this.#f("grp｜"+c)}),this.#t=Ft(String(t.oCfg.init.bg_color));const l=new M;l.beginFill(this.#t).lineStyle(0,this.#t).drawRect(0,0,E.stageW,E.stageH).endFill(),this.#e.addChild(l.clone()),this.#a.addChild(l),this.#a.visible=!1,this.#e.name="page:A",this.#a.name="page:B",this.#i=s.stage,this.#i.addChild(this.#a),this.#i.addChild(this.#e),this.#i.addChild(this.#S),this.#i.addChild(this.#m),this.#i.name="stage";const g=(o,c)=>{this.#u(Number(c))};g("",i.getVal("sys:TextLayer.Back.Alpha",1)),i.defValTrg("sys:TextLayer.Back.Alpha",g);const u=(o,c)=>j.fontFamily=c;u("",i.getVal("tmp:sn.button.fontFamily",j.fontFamily)),i.defValTrg("tmp:sn.button.fontFamily",u),i.defTmp("const.sn.log.json",()=>JSON.stringify((this.#O.text=this.#O.text?.replaceAll("</span><span class='sn_ch'>","")??"")?[...this.#Y,this.#O]:this.#Y)),i.defTmp("const.sn.last_page_text",()=>this.currentTxtlayFore?.pageText??""),i.defTmp("const.sn.last_page_plain_text",()=>this.currentTxtlayFore?.pagePlainText??""),E.isDbg&&(ct.init(s,h,n,d,t,this.#n),this.cvsResizeDesign=()=>ct.cvsResizeDesign(),h.addHook((o,c)=>{this.#p[o]?.(o,c)&&delete this.#p[o]}))}#i;#e=new V;#a=new V;#r;#t;#l=new wt;cvsResizeDesign(){}#p={attach:t=>!1,continue:t=>!1,disconnect:t=>!1,_enterDesign:t=>{for(const e of this.#y){const s=this.#n[e].fore;s.makeDesignCastChildren(i=>i.make()),s.makeDesignCast(i=>i.make())}return this.#b(this.#C),!1},_replaceToken:(t,e)=>!1,_selectNode:(t,e)=>(this.#b(e.node),!1)};#g="";#o="";#b(t){[this.#g="",this.#o=""]=t.split("/");const e=this.#n[this.#g];e&&(this.#o?e.fore.showDesignCastChildren():e.fore.showDesignCast())}getFrmDisabled=t=>this.#r.getFrmDisabled(t);#s=void 0;cover(t,e=0){this.#s&&(this.#i.removeChild(this.#s),this.#s.destroy(),this.#s=void 0),t&&this.#i.addChild((this.#s=new M).beginFill(e).lineStyle(0,e).drawRect(0,0,E.stageW,E.stageH).endFill())}#d;setEvtMng(t){this.#d=t,this.#r.setEvtMng(t),m.setEvtMng(t),R.init(t,this.appPixi)}destroy(){for(const t of Object.values(this.#n))t.destroy();this.#l.clear(),I.destroy(),lt.destroy(),_.destroy(),x.destroy(),this.#r.destroy(),R.destroy(),z.#R=10}#u(t){for(const e of this.#y){const{fore:s,back:i}=this.#n[e];s instanceof x&&(s.chgBackAlpha(t),i.chgBackAlpha(t))}}#f=(t,e=this.currentTxtlayForeNeedErr,s=!0)=>e.tagCh("｜&emsp;《"+t+"》");goTxt=()=>{};get needGoTxt(){return this.currentTxtlayFore?.needGoTxt??!1}breakLine=t=>{};breakPage=t=>{};clearBreak(){this.currentTxtlayFore&&(this.clearBreak=()=>this.#f("del｜break"),this.clearBreak())}clickTxtLay(){return this.currentTxtlayFore?this.#y.map(t=>this.#n[t].fore).some(t=>t instanceof x&&t.click()):!1}#c(t){const e=Rt("-","_","","_"),s=t.fn?t.fn.startsWith(Ot)?t.fn:`${gt+t.fn+e}.png`:`${gt}snapshot${e}.png`,i=this.cfg.searchPath(s),a=w(t,"width",E.stageW),n=w(t,"height",E.stageH);return this.#_(t,i,a,n,`snapshot dt:${e}`)}#_=()=>!1;#h({layer:t},e,s,i,a){if(this.#r.hideAllFrame(),F.beginProc(a),!t)return this.sys.capturePage(e,s,i,()=>{this.#r.restoreAllFrame(),F.endProc(a)}),!0;const n=this.#y.map(h=>{const{ctn:r}=this.#n[h].fore,d=[r,r.visible];return r.visible=!1,d});for(const h of this.#v(t))this.#n[h].fore.ctn.visible=!0;return this.sys.capturePage(e,s,i,()=>{for(const[h,r]of n)h.visible=r;this.#r.restoreAllFrame(),F.endProc(a)}),!0}#z(t,e,s,i,a){F.beginProc(a);const n=bt(t,"b_color",this.#t),h=Lt({width:s,height:i,backgroundAlpha:n>16777216&&e.endsWith(".png")?0:1,antialias:N(t,"smoothing",!1),preserveDrawingBuffer:!0,backgroundColor:n&16777215,autoDensity:!0}),r=t.page!=="back"?"fore":"back",{layer:d}=t;return Promise.allSettled(this.#v(d).map(p=>new Promise(l=>this.#n[p][r].snapshot(h,l)))).then(async()=>{const p=X.create({width:h.width,height:h.height});h.render(this.#i,{renderTexture:p}),await this.sys.savePic(e,h.plugins.extract.base64(p)),p.destroy();for(const l of this.#v(d))this.#n[l][r].snapshot_end();h.destroy(!0),F.endProc(a)}),!0}#$(t){const{fn:e}=t;if(!e)throw"fnは必須です";if(!e.endsWith(".css"))throw"サポートされない拡張子です";const s=N(t,"join",!0),i=F.procID+`loadplugin fn:${e}`;return s&&F.beginProc(i),(async()=>{const a=await fetch(e);if(!a.ok)throw new Error("Network response was not ok.");st(await a.text()),s&&F.endProc(i)})(),s}#w(t){const{layer:e,class:s}=t;if(!e)throw"layerは必須です";if(e.includes(","))throw"layer名に「,」は使えません";if(e in this.#n)throw`layer【${e}】はすでにあります`;if(!s)throw"clsは必須です";const i={isWait:!1};switch(this.#n[e]=new G(e,s,this.#e,this.#a,t,this.sys,this.val,i),this.#y.push(e),s){case"txt":this.#C||(this.#H=()=>{},this.#x=this.#Q,this.#X=this.#K,this.hTag.current({layer:e}),this.goTxt=()=>{this.#d.isSkipping?z.#R=0:this.setNormalChWait();for(const a of this.#y){const n=this.#n[a].fore;n instanceof x&&this.#f("gotxt｜",n,!1)}}),this.val.setVal_Nochk("save","const.sn.layer."+(e??this.#C)+".enabled",!0);break;case"grp":if(this.#L)break;this.#L=e;break}return this.scrItr.recodeDesign(t),i.isWait}#n={};#y=[];#C="";#L="";#I(t){const e=this.#J(t),s=this.#n[e],i=s.back.ctn,a=s.fore.ctn;if(N(t,"float",!1))this.#a.setChildIndex(i,this.#a.children.length-1),this.#e.setChildIndex(a,this.#e.children.length-1),this.#B();else if(t.index)w(t,"index",0)&&(this.#a.setChildIndex(i,t.index),this.#e.setChildIndex(a,t.index),this.#B());else if(t.dive){const{dive:n}=t;let h=0;if(e===n)throw"[lay] 属性 layerとdiveが同じ【"+n+"】です";const r=this.#n[n];if(!r)throw"[lay] 属性 dive【"+n+"】が不正です。レイヤーがありません";const d=r.back,p=r.fore,l=this.#a.getChildIndex(d.ctn),g=this.#e.getChildIndex(p.ctn);h=l<g?l:g,h>this.#a.getChildIndex(i)&&--h,this.#e.setChildIndex(a,h),this.#a.setChildIndex(i,h),this.#B()}return t[":id_tag"]=s.fore.name.slice(0,-7),this.scrItr.recodeDesign(t),s.lay(t)}#B(){this.#y=this.#k()}#V(t){return this.#T(t,e=>{const s=this.#n[this.#J({layer:e})];if(t.page==="both"){s.fore.clearLay(t),s.back.clearLay(t);return}s.getPage(t).clearLay(t)}),!1}static#U=`
precision mediump float;

varying vec2 vTextureCoord;
uniform sampler2D uSampler;

uniform sampler2D rule;
uniform float vague;
uniform float tick;

uniform vec4 inputPixel;
uniform highp vec4 outputFrame;
vec2 getUV(vec2 coord) {
	return coord * inputPixel.xy / outputFrame.zw;
}

void main() {
	vec4 fg = texture2D(uSampler, vTextureCoord);
	vec4 ru = texture2D(rule, getUV(vTextureCoord));

	float v = ru.r - tick;
	gl_FragColor = abs(v) < vague
		? vec4(fg.rgb, 1) *fg.a *(0.5 +v /vague *0.5)
		: 0.0 <= v ? fg : vec4(0);
}`;#N=X.create({width:E.stageW,height:E.stageH});#S=new O(this.#N);#A=X.create({width:E.stageW,height:E.stageH});#m=new O(this.#A);#M(t){const{layer:e}=t,s=new Set,i=this.#v(e).map(b=>(s.add(b),this.#n[b].fore)),a=async()=>{[this.#e,this.#a]=[this.#a,this.#e];const b=[];for(const[T,v]of Object.entries(this.#n)){if(s.has(T)){v.transPage(b);continue}const{fore:{ctn:C},back:{ctn:S}}=v,A=this.#e.getChildIndex(S);this.#e.removeChild(S),this.#a.removeChild(C),this.#e.addChildAt(C,A),this.#a.addChildAt(S,A)}await Promise.allSettled(b),this.#e.visible=!0,this.#a.visible=!1,this.#S.visible=!1,this.#m.visible=!1,F.notifyEndProc(mt+q)};if(this.#m.filters=[],this.#m.alpha=1,w(t,"time",0)===0||this.#d.isSkipping)return F.beginProc(mt+q,()=>{}),queueMicrotask(()=>a()),!0;const n=[],h=this.#y.map(b=>{const{fore:T,back:v}=this.#n[b],C=s.has(b)?v:T;return C.ctn.visible&&n.push(C.ctn),C}),{ticker:r,renderer:d}=this.appPixi;d.render(this.#a,{renderTexture:this.#N});let p=()=>{for(const b of n)d.render(b,{renderTexture:this.#N,clear:!1})};if(!h.some(b=>b.containMovement)){const b=p;p=()=>{p=()=>{},b()}}const l=()=>d.render(this.#e,{renderTexture:this.#A});l();let g=()=>{this.#e.visible=!0,l(),this.#e.visible=!1};if(!i.some(b=>b.containMovement)){const b=g;g=()=>{g=()=>{},b()}}const u=()=>{p(),this.#S.visible=!0,g(),this.#m.visible=!0},{glsl:o,rule:c}=t,f=async()=>{r.remove(u),await a()};if(!o&&!c)return R.tween(q,t,this.#m,{alpha:0},()=>{},f,()=>{}),r.add(u),!1;const y={rule:H.EMPTY,vague:w(t,"vague",.04),tick:0};this.#m.filters=[new Bt(void 0,o??z.#U,y)];const k=R.tween(q,t,y,{tick:1},()=>{},f,()=>{},!c);return c?new m(c,void 0,b=>{y.rule=b.texture,b.destroy(),k.start(),r.add(u)},b=>{b&&this.main.resume()}).ret:(r.add(u),!1)}#v(t=""){return t?t.split(","):this.#y}#T(t,e){const s=this.#v(t.layer);for(const i of s){const a=this.#n[i];if(!a)throw`存在しないlayer【${i}】です`;e(i,a)}return s}#k(t=""){return this.#v(t).sort((e,s)=>{const i=this.#e.getChildIndex(this.#n[e].fore.ctn),a=this.#e.getChildIndex(this.#n[s].fore.ctn);return i<a?-1:i>a?1:0})}setAllStyle2TxtLay(t){for(const e of this.#y){const s=this.#n[e].fore;s instanceof x&&s.lay({style:t})}}#P(t){if(w(t,"time",NaN)===0)return!1;const e=this.#v(t.layer).map(p=>this.#n[p].fore.ctn),{renderer:s,ticker:i}=this.appPixi;this.#A.resize(E.stageW,E.stageH);const a=()=>{this.#e.visible=!0;for(const p of e)s.render(p,{renderTexture:this.#A,clear:!1});this.#e.visible=!1};this.#m.visible=!0,this.#m.alpha=1;const n=W(w(t,"hmax",10)),h=W(w(t,"vmax",10)),r=n===0?()=>{}:()=>this.#m.x=Math.round(Math.random()*n*2)-n,d=h===0?()=>{}:()=>this.#m.y=Math.round(Math.random()*h*2)-h;return this.#m.filters=[],R.tween(q,t,this.#m,{x:0,y:0},()=>{r(),d()},()=>{i.remove(a),this.#e.visible=!0,this.#m.visible=!1,this.#m.x=0,this.#m.y=0},()=>{}),i.add(a),!1}#Z(t){const{layer:e,render:s,name:i}=t;if(!e)throw"layerは必須です";const a=this.#n[this.#J(t)],n=a.fore;let h=()=>{};s&&!this.#d.isSkipping&&(n.renderStart(),h=()=>n.renderEnd());const r=R.cnvTweenArg(t,n),d=N(t,"arrive",!1),p=N(t,"backlay",!1),l=a.back.ctn;return R.tween(i??e,t,n,R.cnvTweenArg(t,n),()=>{},h,()=>{if(d&&Object.assign(n,r),p)for(const g of Object.keys(R.hMemberCnt))l[g]=n[g]}),"filter"in t&&(n.ctn.filters=[B.bldFilters(t)],n.aFltHArg=[t]),!1}#F(t){return this.#T(t,e=>{const s=this.#n[this.#J({layer:e})];if(t.page==="both"){this.#q(s.fore,t),this.#q(s.back,t);return}const i=s.getPage(t);this.#q(i,t)}),!1}#q(t,e){const s=t.ctn;s.filters??=[],s.filters=[...s.filters,B.bldFilters(e)],t.aFltHArg.push(e)}#G(t){return this.#T(t,e=>{const s=this.#n[this.#J({layer:e})];if(t.page==="both"){const a=s.fore,n=s.back;a.ctn.filters=null,n.ctn.filters=null,a.aFltHArg=[],n.aFltHArg=[];return}const i=s.getPage(t);i.ctn.filters=null,i.aFltHArg=[]}),!1}#W(t){return this.#T(t,e=>{const s=this.#n[this.#J({layer:e})];if(t.page==="both"){this.#j(s.fore,t),this.#j(s.back,t);return}const i=s.getPage(t);this.#j(i,t)}),!1}#j(t,e){const s=t.ctn;if(!s.filters)throw"フィルターがありません";const i=W(w(e,"index",0)),a=s.filters.length;if(a<=i)throw`フィルターの個数（${a}）を越えています`;t.aFltHArg[i].enabled=s.filters[i].enabled=N(e,"enabled",!0)}static#R=10;static get msecChWait(){return z.#R}#E(t){const{text:e}=t;if(!e)throw"textは必須です";const s=this.#x(t);delete t.text,this.setNormalChWait(),this.#d.isSkipping?t.wait=0:"wait"in t&&w(t,"wait",NaN);const i=encodeURIComponent(JSON.stringify(t));this.#f("add｜"+i,s);const a=N(t,"record",!0),n=this.val.doRecLog();return a||this.val.setVal_Nochk("save","sn.doRecLog",a),s.tagCh(e.replaceAll("[r]",`
`)),this.val.setVal_Nochk("save","sn.doRecLog",n),this.#f("add_close｜",s),!1}#x=t=>{throw this.#H(),0};#Q(t){const e=this.#J(t,this.#C),s=this.#n[e].getPage(t);if(!(s instanceof x))throw e+"はTxtLayerではありません";return s}setNormalChWait(){z.#R=this.scrItr.normalWait}#X=t=>{throw this.#H(),0};#K(t){const{layer:e}=t;if(!e)throw"[current] layerは必須です";const s=this.#n[e];if(!s||!(s.getPage(t)instanceof x))throw`${e}はTxtLayerではありません`;this.#D=s,this.recPagebreak(),this.#C=e,this.val.setVal_Nochk("save","const.sn.mesLayer",e);for(const i of this.#y){const{fore:a,back:n}=this.#n[i];a instanceof x&&(a.isCur=n.isCur=i===e)}return!1}get currentTxtlayForeNeedErr(){return this.#H(),this.currentTxtlayFore}get currentTxtlayFore(){return this.#D?this.#D.fore:null}#D;#H=()=>{throw"文字レイヤーがありません。文字表示や操作する前に、[add_lay layer=（レイヤ名） class=txt]で文字レイヤを追加して下さい"};#J(t,e=""){const s=t.layer??e;if(s.includes(","))throw"layer名に「,」は使えません";if(!(s in this.#n))throw"属性 layer【"+s+"】が不正です。レイヤーがありません";return t.layer=s}#O={text:""};#Y=[];recText(t){this.#O={text:t},this.val.setVal_Nochk("save","const.sn.sLog",String(this.val.getVal("const.sn.log.json")))}recPagebreak(){this.#O.text&&(this.#O.text=this.#O.text.replaceAll("</span><span class='sn_ch'>",""),this.#Y.push(this.#O)>this.cfg.oCfg.log.max_len&&(this.#Y=this.#Y.slice(-this.cfg.oCfg.log.max_len)),this.#O={text:""})}#et(t){const e=this.#x(t);return t.layer===this.#C&&t.page==="fore"&&this.recPagebreak(),e.clearText(),!1}#st(t){return this.#f("endlink｜",this.#x(t)),!1}#it(t){return N(t,"rec_page_break",!0)&&this.recPagebreak(),this.#D&&(this.#D.fore.clearLay(t),this.#D.back.clearLay(t)),!1}#at(t){if(!t.pic)throw"[graph] picは必須です";const e=encodeURIComponent(JSON.stringify(t));return this.#f("grp｜"+e,this.#x(t)),!1}#nt(t){if(!t.fn&&!t.label&&!t.url)throw"fn,label,url いずれかは必須です";t.fn??=this.scrItr.scriptFn,t.style??="background-color: rgba(255,0,0,0.5);",t.style_hover??="background-color: rgba(255,0,0,0.9);",t.style_clicked??=t.style;const e=encodeURIComponent(JSON.stringify(t));return this.#f("link｜"+e,this.#x(t)),!1}#ht(t){return t.text=`
`,this.#E(t)}#rt(t){return this.#tt({...t,text:"[r]"})}#tt(t){return this.#O={...t,text:this.#O.text},t.text?(t.record=!0,t.style??="",t.style+="display: none;",t.wait=0,this.#E(t)):!1}#ot(t){return this.#Y=[],this.#O={text:t.text??""},this.val.setVal_Nochk("save","const.sn.sLog",t.text?`[{text:"${t.text}"}]`:"[]"),!1}#lt(t){const{t:e,r:s}=t;if(!e)throw"[ruby2] tは必須です";if(!s)throw"[ruby2] rは必須です";return t.text="｜"+encodeURIComponent(e)+"《"+encodeURIComponent(s)+"》",delete t.t,delete t.r,this.#E(t)}#ct(t){const e=encodeURIComponent(JSON.stringify(t));return this.#f("span｜"+e,this.#x(t)),!1}#dt(t){if(!t.t)throw"[tcy] tは必須です";const e=encodeURIComponent(JSON.stringify(t));return this.#f("tcy｜"+e,this.#x(t)),!1}#ft({layer:t}){console.group("🥟 [dump_lay]");for(const e of this.#v(t)){const{fore:s,back:i}=this.#n[e];try{console.info(`%c${s.name.slice(0,-7)} %o`,`color:#${E.isDarkMode?"49F":"05A"};`,JSON.parse(`{"back":{${i.dump()}}, "fore":{${s.dump()}}}`))}catch(a){console.error("dump_lay err:%o",a),console.error(`   back:${i.dump()}`),console.error(`   fore:${s.dump()}`)}}return console.groupEnd(),!1}#pt(t){const e=this.#J(t,this.#C),s=N(t,"enabled",!0);return this.#x(t).enabled=s,this.val.setVal_Nochk("save","const.sn.layer."+e+".enabled",s),!1}#ut(t){return G.argChk_page(t,"back"),t.fn??=this.scrItr.scriptFn,this.#x(t).addButton(t),this.scrItr.recodeDesign(t),!1}record(){const t={};for(const e of this.#y){const s=this.#n[e];t[e]={cls:s.cls,fore:s.fore.record(),back:s.back.record()}}return t}playback(t){this.#Y=JSON.parse(String(this.val.getVal("save:const.sn.sLog"))),this.#O={text:""};const e=[],s=[];for(const[a,{fore:n,fore:{idx:h},back:r,cls:d}]of Object.entries(t)){s.push({ln:a,idx:h});const p=this.#n[a]??=new G(a,d,this.#e,this.#a,{},this.sys,this.val,{isWait:!1});p.fore.playback(n,e),p.back.playback(r,e)}const i=this.#e.children.length;return e.push(new Promise(a=>{for(const{ln:n,idx:h}of s.sort(({idx:r},{idx:d})=>r===d?0:r<d?-1:1)){const{fore:r,back:d}=this.#n[n];if(!r)continue;const p=i>h?h:i-1;this.#e.setChildIndex(r.ctn,p),this.#a.setChildIndex(d.ctn,p)}a()})),e}}const qt=Object.freeze(Object.defineProperty({__proto__:null,LayerMng:z},Symbol.toStringTag,{value:"Module"}));export{j as B,qt as L,x as T};
