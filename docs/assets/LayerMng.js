import{e as j,b as v,u as W,a as E,T as Tt,m as ht,h as St,L as B,G as M,R as J,j as H,k as Nt,c as st,f as G,C as N,D as K,l as mt,n as O,o as rt,q as U,B as Et,r as L,i as ut,s as At,A as bt,t as Pt,E as xt,g as Ft,P as Rt,v as gt,w as Ot,x as q,F as Lt}from"./web.js";import{v as F,W as et,Y as Bt}from"./SndBuf.js";import{r as R,B as jt}from"./Reading.js";import{a as lt,R as yt}from"./ScriptIterator.js";import"../web.js";class X{constructor(t,e,s,i,a,h,n,r){this.cls=e,this.hArg=a,this.sys=h,this.val=n,this.ret=r;const c=h.hFactoryCls[e];if(!c)throw`属性 class【${e}】が不正です`;const f=c(),l=c();f.layname=l.layname=t;const u=a[":id_tag"]=`layer:${t} cls:${e} page:`;f.ctn.name=f.name=u+"A",l.ctn.name=l.name=u+"B",s.addChild(f.ctn),i.addChild(l.ctn),E(a,"visible",!0),E(a,"visible",!0),r.isWait=f.lay(a)||l.lay(a),this.#i={fore:f,back:l};const p=`const.sn.lay.${t}`;n.setVal_Nochk("tmp",p,!0),n.defTmp(p+".fore.alpha",()=>this.#i.fore.alpha),n.defTmp(p+".back.alpha",()=>this.#i.back.alpha),n.defTmp(p+".fore.height",()=>this.#i.fore.height),n.defTmp(p+".back.height",()=>this.#i.back.height),n.defTmp(p+".fore.visible",()=>this.#i.fore.ctn.visible),n.defTmp(p+".back.visible",()=>this.#i.back.ctn.visible),n.defTmp(p+".fore.width",()=>this.#i.fore.width),n.defTmp(p+".back.width",()=>this.#i.back.width),n.defTmp(p+".fore.x",()=>this.#i.fore.x),n.defTmp(p+".back.x",()=>this.#i.back.x),n.defTmp(p+".fore.y",()=>this.#i.fore.y),n.defTmp(p+".back.y",()=>this.#i.back.y)}#i;destroy(){this.#i.fore.destroy(),this.#i.back.destroy()}lay=t=>this.getPage(t).lay(t);getPage=t=>X.argChk_page(t,"fore")!=="back"?this.#i.fore:this.#i.back;static argChk_page(t,e){const s=t.page??e;if(s==="fore"||s==="back")return t.page=s;throw Error("属性 page【"+s+"】が不正です")}get fore(){return this.#i.fore}get back(){return this.#i.back}transPage(t){[this.#i.back,this.#i.fore]=[this.#i.fore,this.#i.back],this.#i.back.copy(this.#i.fore,t)}}class ct{constructor(t,e=!1){this.bg_col=t,this.isLay=e}static init(t,e,s,i,a,h){}static cvsResizeDesign(){}destroy(){}gethArg(){return this.hArg}hArg={};sethArg(t){this.hArg=t}setOther(t){}adopt(t){}static enterMode(){}static allHide(){}set visible(t){}static leaveMode(){}cvsResize(){}make(){}static replaceToken(t){}}class Vt extends ct{constructor(t,e){super("#29e",!0)}setSp(t){}}class b{constructor(t="",e,s=()=>{},i=()=>{}){this.csvFn=t,this.ctn=e,this.fncFirstComp=s,this.fncAllComp=i,t&&(this.#g=e?a=>{e.addChild(a),this.#o.push(a)}:()=>{},this.ret=b.#s(t,a=>this.fncFirstComp(a),a=>this.fncAllComp(a),a=>this.#g(a)))}static#i;static#e;static#a;static#h;static init(t,e,s,i,a){b.#i=t,b.#e=e,b.#a=s,b.#h=i,s.arg.crypto&&(b.#d=b.#f,b.#r=b.#L);const h=()=>{const n=b.#l*b.#t;for(const r of Object.values(b.#v))r.volume=n};a.setNoticeChgVolume(n=>{b.#l=n,h()},n=>{b.#t=n,h()})}static#t=1;static#l=1;static#p;static setEvtMng(t){b.#p=t}ret=!1;#g;#o=[];destroy(){this.fncFirstComp=()=>{},this.fncAllComp=()=>{},this.#g=t=>t.destroy();for(const t of this.#o)b.stopVideo(t.name),t.parent?.removeChild(t),t.destroy();this.#o=[]}static destroy(){b.#y={},b.#c={},b.#v={}}static#s(t,e,s,i){if(!t)return!1;let a=!1;if(t.startsWith("data:")){const l=()=>{const u=O.from(t);i(u),e(u),s(a)};return t in rt?l():(a=!0,new U().add(t,t).load(l)),a}const h=[],n=new U,r=t.split(","),c=r.length;for(let l=0;l<c;++l){const u=r[l];if(!u)throw"face属性に空要素が含まれます";const{dx:p,dy:o,blendmode:d,fn:y}=b.#y[u]||{fn:u,dx:0,dy:0,blendmode:Et.NORMAL},g=l===0?e:x=>{x.transform!==null&&(x.x=p,x.y=o,x.blendMode=d)};if(h.push({fn:y,fnc:g}),y in b.#c||y in rt||y in U.shared.resources)continue;a=!0;const m=b.#i.searchPath(y,G.SP_GSM),T=this.#a.arg.crypto?{xhrType:m.slice(-5)===".json"?L.XHR_RESPONSE_TYPE.TEXT:L.XHR_RESPONSE_TYPE.BUFFER}:{};n.add({...T,name:y,url:m})}const f=(l,u)=>{for(const{fn:p,fnc:o}of h){const d=b.#_(p,u);d.name=p,i(d),o(d)}s(a)};return a?n.use(async(l,u)=>{try{if(l.extension==="json"){const o=await this.#a.dec("json",l.data);b.#r(o,l,u);return}const p=await this.#a.decAB(l.data);b.#d(p,l,u)}catch(p){const o=`画像/動画ロード失敗です fn:${l.name} ${p}`;b.#p.isSkipping?console.warn(o):console.error("%c"+o,"color:#FF3300;")}}).load(f):queueMicrotask(()=>f(0,{})),a}static#y={};static#c={};static#d=(t,{type:e,name:s,data:i},a)=>{switch(e){case L.TYPE.VIDEO:const h=i;h.volume=b.#l,b.#v[s]=b.#w(h)}a()};static#u(t){const e=/([^\d]+)\d+\.(\w+)/.exec(t[0]??"");if(!e)return[];const s=e[1].length,i=-e[2].length-1;return t.sort((a,h)=>ut(a.slice(s,i))>ut(h.slice(s,i))?1:-1)}static async#f(t,e,s){e.data=t,e.extension!=="bin"&&s(),t instanceof HTMLImageElement?(e.texture=await H.fromLoader(t,e.url,e.name),e.type=L.TYPE.IMAGE):t instanceof HTMLVideoElement&&(t.volume=b.#l,b.#v[e.name]=b.#w(t),e.type=L.TYPE.VIDEO),s()}static#w(t){return b.#e.getVal("const.sn.needClick2Play")&&(K.trace_beforeNew(`[lay系] ${K.strPos()}未クリック状態で動画を自動再生します。音声はミュートされます`,"W"),t.muted=!0),t.setAttribute("playsinline",""),t}static#r=(t,{type:e,spritesheet:s,name:i,data:a},h)=>{switch(e){case L.TYPE.JSON:const n=s._frameKeys;b.#u(n),b.#c[i]={aTex:n.map(r=>H.from(r)),meta:a.meta}}h()};static#L(t,e,s){const{meta:i,frames:a}=e.data=JSON.parse(t);if(e.type=L.TYPE.JSON,!i?.image){s();return}const h=At(i.image),n=b.#i.searchPath(h,G.SP_GSM);new U().use((r,c)=>{this.#a.decAB(r.data).then(f=>{r.data=f,f instanceof HTMLImageElement&&(r.type=L.TYPE.IMAGE,URL.revokeObjectURL(f.src)),c()}).catch(f=>this.#h.errScript(`画像/動画ロード失敗です dec2res4Cripto fn:${r.name} ${f}`,!1))}).add({name:h,url:n,xhrType:L.XHR_RESPONSE_TYPE.BUFFER}).load((r,c)=>{for(const{data:f}of Object.values(r.resources)){const{baseTexture:l}=H.from(f),u=Object.values(a);b.#c[e.name]={aTex:u.map(({frame:{x:p,y:o,w:d,h:y}})=>new H(l,new J(p,o,d,y))),meta:i}}s()})}static#_(t,e){const s=b.#c[t];if(s){const h=new bt(s.aTex);return h.animationSpeed=s.meta.animationSpeed??1,h.play(),h}if(t in rt)return O.from(t);const i=b.#v[t];if(i)return O.from(i);const a=e[t];return a?new O(a.texture):new O}static#v={};static getHFn2VElm(t){return b.#v[t]}static wv(t){const{fn:e}=t;if(!e)throw"fnは必須です";const s=b.#v[e];if(!s||s.loop)return!1;if(b.#p.isSkipping||s.ended)return b.stopVideo(e),!1;const i="wv fn:"+e,a=E(t,"stop",!0),h=()=>{a&&b.stopVideo(e)};return R.beginProc(i,h,!0,h),s.addEventListener("ended",()=>R.notifyEndProc(i),{once:!0,passive:!0}),!0}static stopVideo(t){const e=b.#v[t];e&&(delete b.#v[t],e.pause(),e.currentTime=e.duration)}static add_face(t){const{name:e}=t;if(!e)throw"nameは必須です";if(e in b.#y)throw"一つのname（"+e+"）に対して同じ画像を複数割り当てられません";const{fn:s=e}=t;return b.#y[e]={fn:s,dx:v(t,"dx",0),dy:v(t,"dy",0),blendmode:B.getBlendmodeNum(t.blendmode||"")},!1}}class D extends B{static#i=new xt;static#e;static init(t,e,s,i,a,h){D.#e=s,b.init(e,h,i,t,a)}static destroy(){D.#i.clear(),b.destroy()}#a=new Vt(this.ctn,this);constructor(){super(),N.isDbg&&(this.#h=t=>this.#a.setSp(t),this.cvsResize=()=>{super.cvsResize(),this.#a.cvsResize()})}#h=()=>{};#t="";#l="";#p="";lay=t=>{const e=R.procID+`GrpLayer lay name:${this.name_}`,s=this.#g(t,i=>{i&&R.endProc(e)});return s&&R.beginProc(e),s};#g(t,e){const{fn:s,face:i=""}=t;if(this.#a.sethArg(t),!s)return super.lay(t),this.ctn.children.length>0&&this.setPos(t),this.#l="",this.#t=this.#p=i,e(!1),!1;const a="fn"in t,h="face"in t;return this.clearLay({clear_filter:E(t,"clear_filter",!0)}),a&&(this.#l=s),h&&(this.#p=i),super.lay(t),t.dx=0,t.dy=0,this.#o.destroy(),this.#o=new b(this.#t=s+(i?","+i:""),this.ctn,n=>{("width"in t||"height"in t)&&(n.width=v(t,"width",0),n.height=v(t,"height",0)),this.#s=n.width,this.#y=n.height,B.setXY(n,t,this.ctn,!0),B.setBlendmode(this.ctn,t),this.#h(n)},n=>e(n)),this.#o.ret}#o=new b;#s=0;#y=0;get width(){return this.#s}get height(){return this.#y}renderStart(){this.#d=new O(this.#c),this.#d.visible=!1,this.ctn.addChildAt(this.#d,0),this.#d.position.set(-this.ctn.x,-this.ctn.y);let t=()=>{const e=this.ctn.alpha;this.ctn.alpha=1;for(const s of this.ctn.children)s.visible=!0;this.#d.visible=!1,D.#e.renderer.render(this.ctn,{renderTexture:this.#c}),this.ctn.alpha=e;for(const s of this.ctn.children)s.visible=!1};if(!this.containMovement){let e=t;t=()=>{t=()=>{},e()}}this.#u=()=>{t(),this.#d.visible=!0},D.#e.ticker.add(this.#u)}#c=q.create({width:N.stageW,height:N.stageH});#d=new O;#u=()=>{};renderEnd(){D.#e.ticker.remove(this.#u),this.ctn.removeChild(this.#d);for(const t of this.ctn.children)t.visible=!0;this.#d.destroy(!0),this.#c=q.create({width:N.stageW,height:N.stageH})}setPos(t){B.setXY(this.ctn.children[0]??this.ctn,t,this.ctn,!0)}get containMovement(){if(this.#t==="")return!1;const t=this.ctn.children;return this.#t.split(",").some((e,s)=>t[s]instanceof bt||b.getHFn2VElm(e))}clearLay(t){super.clearLay(t),this.#o.destroy(),this.#l="",this.#p="",this.#t=""}record=()=>({...super.record(),sBkFn:this.#l,sBkFace:this.#p});playback(t,e){if(super.playback(t,e),t.sBkFn===""&&t.sBkFace===""){this.#l="",this.#p="";return}e.push(new Promise(s=>this.#g({fn:t.sBkFn,face:t.sBkFace,left:t.x,top:t.y,alpha:t.alpha,blendmode:B.getNum2Blendmode(t.blendMode),rotation:t.rotation,scale_x:t.scale_x,scale_y:t.scale_y},i=>{this.ctn.position.set(t.x,t.y),s()})))}makeDesignCast(t){this.ctn.visible&&t(this.#a)}cvsResize(){super.cvsResize()}showDesignCast(){this.#a.visible=!0}dump=()=>super.dump()+`, "pic":"${this.#t}"`}const Y="、。，．）］｝〉」』】〕”〟ぁぃぅぇぉっゃゅょゎァィゥェォッャュョヮヵヶ！？!?‼⁉・ーゝゞヽヾ々",it="［（｛〈「『【〔“〝",at="─‥…",ot=Y,wt=new RegExp(`[${Y}]`),It=new RegExp(`[${it}]`),Dt=new RegExp(`[${at}]`),Mt=wt;class Ht{#i=Y;#e=it;#a=at;#h=ot;get 行頭禁則(){return this.#i}get 行末禁則(){return this.#e}get 分割禁止(){return this.#a}get ぶら下げ(){return this.#h}#t=wt;#l=It;#p=Dt;#g=Mt;break_fixed=!1;break_fixed_left=0;break_fixed_top=0;bura=!1;lay(t){t.kinsoku_sol&&(this.#i=t.kinsoku_sol,this.#t=new RegExp(`[${this.#i}]`)),t.kinsoku_eol&&(this.#e=t.kinsoku_eol,this.#o(),this.#l=new RegExp(`[${this.#e}]`)),t.kinsoku_dns&&(this.#a=t.kinsoku_dns,this.#s(),this.#p=new RegExp(`[${this.#a}]`)),t.kinsoku_bura&&(this.#h=t.kinsoku_bura,this.#o(),this.#s(),this.#g=new RegExp(`[${this.#h}]`)),"bura"in t&&(this.bura=E(t,"bura",!1)),this.break_fixed=E(t,"break_fixed",this.break_fixed),this.break_fixed_left=v(t,"break_fixed_left",this.break_fixed_left),this.break_fixed_top=v(t,"break_fixed_top",this.break_fixed_top)}#o(){const t=this.#e.length,e=this.#h.length;if(t<e)for(let s=0;s<t;++s){const i=this.#e[s];if(this.#h.includes(i))throw`禁則の競合があります。文字 ${i} がぶら下げ と 行末禁則 の両方に含まれます`}else for(let s=0;s<e;++s){const i=this.#h[s];if(this.#e.includes(i))throw`禁則の競合があります。文字 ${i} がぶら下げ と 行末禁則 の両方に含まれます`}}#s(){const t=this.#a.length,e=this.#h.length;if(t<e)for(let s=0;s<t;++s){const i=this.#a[s];if(this.#h.includes(i))throw`禁則の競合があります。文字 ${i} がぶら下げ と 分割禁止 の両方に含まれます`}else for(let s=0;s<e;++s){const i=this.#h[s];if(this.#a.includes(i))throw`禁則の競合があります。文字 ${i} がぶら下げ と 分割禁止 の両方に含まれます`}}reNew(t){t.#y(this.#i,this.#e,this.#a,this.#h),t.break_fixed=this.break_fixed,t.break_fixed_left=this.break_fixed_left,t.break_fixed_top=this.break_fixed_top,t.bura=this.bura}#y(t,e,s,i){this.#i!=t&&(this.#i=t,this.#t=new RegExp(`[${t}]`)),this.#e!=e&&(this.#e=e,this.#l=new RegExp(`[${e}]`)),this.#a!=s&&(this.#a=s,this.#p=new RegExp(`[${s}]`)),this.#h!=i&&(this.#h=i,this.#g=new RegExp(`[${i}]`))}record(){const t={break_fixed:this.break_fixed,break_fixed_left:this.break_fixed_left,break_fixed_top:this.break_fixed_top,bura:this.bura};return this.#i===Y&&(t.行頭禁則=this.#i),this.#e===it&&(t.行末禁則=this.#e),this.#a===at&&(t.分割禁止=this.#a),this.#h===ot&&(t.ぶら下げ=this.#h),t}playback(t){t&&(this.#y(t.行頭禁則??Y,t.行末禁則??it,t.分割禁止??at,t.ぶら下げ??ot),this.break_fixed=t.break_fixed,this.break_fixed_left=t.break_fixed_left,this.break_fixed_top=t.break_fixed_top,this.bura=t.bura)}hyph(t,e,s,i,a){let h,n=0,r=2,c=f=>(c=()=>!1,i===f?(i>0&&(t.innerHTML=a.replaceAll('class="sn_ch"','class="sn_ch sn_ch_in_default"')),!0):f<2);do{if(h=this.#d(t,e),n=h.length,c(n))break;let f=-1/0;for(;r<n;++r){const{elm:l,rect:u,ch:p}=h[r];if(l.tagName==="RT")continue;const o=s?u.y:u.x;if(f<=o||l.previousElementSibling?.tagName==="SPAN"&&l.previousElementSibling?.innerHTML.includes("<br>")||l.parentElement?.previousElementSibling?.tagName==="SPAN"&&l.parentElement?.previousElementSibling?.innerHTML.includes("<br>")){f=o,this.break_fixed||(this.break_fixed_left=u.x,this.break_fixed_top=u.y);continue}const d=this.#c(h,r),{elm:y,rect:g,ch:m}=h[d];if(!this.break_fixed){this.break_fixed_left=g.x,this.break_fixed_top=g.y;const P=globalThis.getComputedStyle(y),I=parseFloat(P.fontSize);s?this.break_fixed_top+=I:this.break_fixed_left+=I}f=-1/0;const T=r,{cont:x,ins:_}=this.bura?this.hyph_alg_bura(h,d,m,r):this.hyph_alg(h,d,m,r,p);if(r=_,x)continue;const C=h[r].elm,S=C.parentElement,A=document.createElement("br");if(S.classList.contains("sn_tx"))S.insertBefore(A,C);else{const P=S.parentElement;P.classList.contains("sn_ch")?P.parentElement.insertBefore(A,P):P.insertBefore(A,S)}r+=2,r<T&&(r=T),n=-1;break}}while(n<0);return[h,n]}#c(t,e){const s=e-1,{elm:i}=t[s];return i.tagName!=="RT"?s-(i.style.textCombineUpright==="all"?Array.from(i.textContent??"").length-1:0):s-Array.from(i.textContent??"").length}#d(t,e){const s=[];if(t.nodeType!==t.TEXT_NODE)return Array.from(t.childNodes).map(n=>this.#d(n,e)).flat();const i=t.ownerDocument.createRange();i.selectNodeContents(t);let a=0;const h=i.endOffset;for(;a<h;){i.setStart(t,a),i.setEnd(t,++a);const n=i.toString();s.push({ch:n,rect:e(i,n),elm:i.startContainer.parentElement})}return i.detach(),s}hyph_alg(t,e,s,i,a){if(!this.#l.test(s)){if(this.#t.test(a))for(;(i=this.#c(t,i))>=0&&this.#t.test(t[i].ch););else if(!(s===a&&this.#p.test(s)))return{cont:!0,ins:i+1}}for(i=e;(i=this.#c(t,i))>=0&&this.#l.test(t[i].ch););return{cont:!1,ins:i+1}}hyph_alg_bura(t,e,s,i){const a=this.#c(t,e),{ch:h}=t[a];if(this.#g.test(h)||this.#t.test(h)){let r=e;(this.#g.test(s)||this.#t.test(s))&&++r;const c=this.#c(t,r),{ch:f}=t[c],{ch:l}=t[r];if(f===l&&this.#p.test(l))return{cont:!1,ins:c};if(!this.#l.test(f))return{cont:!1,ins:r};r=c;do if(!this.#l.test(t[r].ch))break;while((r=this.#c(t,r))>=0);return{cont:!1,ins:r+1}}const n=this.#c(t,a);if(i>=3){const{ch:r}=t[n];if(this.#p.test(h)&&r===h)return{cont:!1,ins:n};if(this.#l.test(r)){let c=n;for(;(c=this.#c(t,c))>=0&&this.#l.test(t[c].ch););return{cont:!1,ins:c+1}}}return{cont:!1,ins:a}}}class $ extends j{constructor(t,e,s){super(),this.ctn=t,this.canFocus=e,this.sys=s,this.#t.classList.add("sn_tx"),this.#t.style.position="absolute",$.#e.view.parentElement.appendChild(this.#t),this.addChild(this.#l),this.addChild(this.#p),this.#p.name="grpDbgMasume",this.noticeCompTxt=s.isApp&&$.#i.oCfg.debug.dumpHtm?()=>{R.notifyEndProc(yt);const i=this.#t.innerHTML;if(i==="")return;const{fn:a,ln:h}=$.#h.nowScrFnLn(),n=`dumpHtm ${t.name.slice(0,-7).replaceAll(":","=")}(fn=${a} line=${h})`;s.outputFile(s.path_downloads+n+".htm",`<!doctype html><html><head><meta charset=utf-8><title>${n}</title>
<h1>${n}</h1>${i.replaceAll(/ class="sn_ch"|animation-delay: \d+ms; ?| data-add="{&quot;ch_in_style&quot;:&quot;default&quot;, &quot;ch_out_style&quot;:&quot;default&quot;}"/g,"").replaceAll(' style=""',"").replaceAll(/(<\/?ruby>)/g,`
$1
`).replaceAll(/<(br|\/span)>/g,`<$1>
`)}`)}:()=>R.notifyEndProc(yt)}static#i;static#e;static init(t,e){$.#i=t,$.#e=e}static#a;static#h;static setEvtMng(t,e){$.#a=t,$.#h=e}static destroy(){$.#S=Object.create(null),$.#B=Object.create(null),$.delBreak()}#t=document.createElement("span");#l=new j;#p=new M;static#g={"background-color":0,"border-bottom-width":0,"border-left-width":0,"border-right-width":0,"border-top-width":0,"margin-bottom":0,"margin-left":0,"margin-right":0,"margin-top":0};#o=new Ht;noticeCompTxt=()=>{};#s={fontsize:24,$width:0,$height:0,pad_left:0,pad_right:0,pad_top:0,pad_bottom:0};lay(t){const e=this.#t.style;if("style"in t)if(t.style){const s=document.createElement("span");s.style.cssText=t.style;const i=s.style.length;for(let a=0;a<i;++a){const h=s.style[a];if(h in $.#g){K.myTrace(`${h}は指定できません`,"W");continue}e[h]=s.style[h]}!s.style.opacity&&"alpha"in t&&(e.opacity=String(this.ctn.alpha))}else this.#t.style.cssText="";else"alpha"in t&&(e.opacity=String(this.ctn.alpha));if("width"in t&&(e.width=(t.width??"0")+"px"),"height"in t&&(e.height=(t.height??"0")+"px"),"pl"in t&&(e.paddingLeft=(t.pl??"0")+"px"),"pr"in t&&(e.paddingRight=(t.pr??"0")+"px"),"pt"in t&&(e.paddingTop=(t.pt??"0")+"px"),"pb"in t&&(e.paddingBottom=(t.pb??"0")+"px"),this.#o.lay(t),this.#c(),this.#d=this.ctn.position.x,e.transformOrigin=`${this.ctn.pivot.x}px ${this.ctn.pivot.y}px`,this.cvsResize(),e.display=this.ctn.visible?"inline":"none",":redraw"in t&&this.#v>0){const s=[this.#t.innerHTML.replaceAll(/(animation-delay: )\d+ms/g,"$10ms"),`<span class='sn_ch' data-add='{"ch_in_style":"default"}'>&emsp;</span>`];this.#J(),this.goTxt(s,!0)}}#y=0;#c(){const t=this.#t.style,e=parseFloat(t.fontSize||"0");this.#s.fontsize=e,this.#s.pad_left=parseFloat(t.paddingLeft||"0"),this.#s.pad_right=parseFloat(t.paddingRight||"0"),this.#s.pad_top=parseFloat(t.paddingTop||"0"),this.#s.pad_bottom=parseFloat(t.paddingBottom||"0"),this.#s.$width=parseFloat(t.width||"0"),this.#s.$height=parseFloat(t.height||"0"),this.position.set(this.#s.pad_left,this.#s.pad_top),this.#u=t.writingMode==="vertical-rl",this.#f=0,this.#w=0;const s=t.lineHeight??"0";this.#y=this.#u?0:(s.endsWith("px")?parseFloat(s):e*parseFloat(s)-e)/2}cvsResize(){const t=this.#t.style,e=this.sys.cvsScale;t.left=`${this.sys.ofsLeft4elm+this.#d*e}px`,t.top=`${this.sys.ofsTop4elm+this.ctn.position.y*e}px`,t.transform=`rotate(${this.ctn.angle}deg) scale(${this.ctn.scale.x*e}, ${this.ctn.scale.y*e})`}#d=0;#u=!1;get tategaki(){return this.#u}#f=0;#w=0;get infTL(){return this.#s}get getWidth(){return this.#s.$width}get getHeight(){return this.#s.$height}setMySize(t,e){this.#s.$width=t,this.#s.$height=e,this.#t.style.width=this.#s.$width+"px",this.#t.style.height=this.#s.$height+"px"}#r(t,e=!0){const s={escape:d=>d.replaceAll(/([.*+?^${}()|\[\]\/\\])/g,"\\$1"),mimeType:d=>{const y=r(d).toLowerCase();return i()[y]||""},dataAsUrl:u,isDataUrl:c,resolveUrl:f,getAndEncode:l,asArray:d=>{const y=[],g=d.length;for(let m=0;m<g;++m)y.push(d[m]);return y}};function i(){const d="application/font-woff",y="image/jpeg";return{woff:d,woff2:d,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:y,jpeg:y,gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"}}const a=p(),h=o();function n(d){return h.resolveAll().then(y=>{const g=document.createElement("style");return d.appendChild(g),g.appendChild(document.createTextNode(y)),d})}function r(d){return/\.([^\.\/]*?)$/g.exec(d)?.[1]??""}function c(d){return d.search(/^(data:)/)!==-1}function f(d,y){const g=document.implementation.createHTMLDocument(),m=g.createElement("base");g.head.appendChild(m);const T=g.createElement("a");return g.body.appendChild(T),m.href=y,T.href=d,T.href}function l(d){let y=3e4;return new Promise(function(g){const m=new XMLHttpRequest;m.onreadystatechange=T,m.ontimeout=x,m.responseType="blob",m.timeout=y,m.open("GET",d,!0),m.send();function T(){if(m.readyState!==4)return;if(m.status!==200){_("cannot fetch resource: "+d+", status: "+m.status);return}const C=new FileReader;C.onloadend=function(){const S=C.result.toString().split(/,/)[1];g(S)},C.readAsDataURL(m.response)}function x(){_("timeout of "+y+"ms occured while fetching resource: "+d)}function _(C){console.error(C),g("")}})}function u(d,y){return"data:"+y+";base64,"+d}function p(){const d=/url\(['"]?([^'"]+?)['"]?\)/g;return{inlineAll:T,shouldProcess:y};function y(x){return x.search(d)!==-1}function g(x){const _=[];let C;for(;C=d.exec(x);)_.push(C[1]);return _.filter(function(S){return!s.isDataUrl(S)})}function m(x,_,C,S){return Promise.resolve(_).then(P=>C?s.resolveUrl(P,C):P).then(S||s.getAndEncode).then(P=>s.dataAsUrl(P,s.mimeType(_))).then(P=>x.replace(A(_),"$1"+P+"$3"));function A(P){return new RegExp(`(url\\(['"]?)(`+s.escape(P)+`)(['"]?\\))`,"g")}}function T(x,_,C){if(S())return Promise.resolve(x);return Promise.resolve(x).then(g).then(A=>{let P=Promise.resolve(x);for(const I of A)P=P.then(nt=>m(nt,I,_,C));return P});function S(){return!y(x)}}}function o(){return{resolveAll:d,impl:{readAll:y}};function d(){return y().then(g=>Promise.allSettled(g.map(m=>m.resolve()))).then(g=>g.join(`
`))}function y(){return Promise.resolve(s.asArray(document.styleSheets)).then(m).then(g).then(x=>x.map(T));function g(x){return x.filter(_=>_.type===CSSRule.FONT_FACE_RULE).filter(_=>a.shouldProcess(_.style.getPropertyValue("src")))}function m(x){const _=[];for(const C of x)try{if(C.href)continue;s.asArray(C.cssRules||[]).forEach(_.push.bind(_))}catch(S){console.error("Error while reading CSS rules from "+C.href,String(S))}return _}function T(x){return{resolve:function(){const _=(x.parentStyleSheet||{}).href;return a.inlineAll(x.cssText,_)},src:function(){return x.style.getPropertyValue("src")}}}}}Promise.resolve(this.#t).then(d=>{const y=d.cloneNode(!0);return y.style.padding="0px",y.style.paddingRight=this.#f+"px",y.style.paddingTop=this.#w+"px",y.style.left="0px",y.style.top="0px",y.style.width=this.#s.$width-this.#s.pad_left-this.#s.pad_right+"px",y.style.height=this.#s.$height-this.#s.pad_top-this.#s.pad_bottom+"px",this.#t.hidden=e,y}).then(n).then(d=>{d.setAttribute("xmlns","http://www.w3.org/1999/xhtml");const y=new Image;return y.src=`data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="${this.#s.$width}px" height="${this.#s.$height}px"><foreignObject x="0" y="0" width="100%" height="100%">${new XMLSerializer().serializeToString(d).replaceAll("#","%23").replaceAll(`
`,"%0A")}</foreignObject></svg>`,new Promise(g=>y.onload=()=>g(y))}).then(d=>new Promise(y=>setTimeout(()=>y(d),100))).then(d=>{const y=document.createElement("canvas");y.width=this.#s.$width,y.height=this.#s.$height,y.getContext("2d").drawImage(d,0,0),t(H.from(y))}).catch(d=>K.myTrace(`goTxt() = ${d}`))}#L=[];goTxt(t,e){const s=()=>this.#T(t,e);this.#L.push(s)===1&&s()}#_=[];#v=0;static#n="<span class='sn_ch sn_ch_last'>&emsp;</span>";#T(t,e){$.#R.visible=!1;let s=this.#_.length,i="";if(s===0){if($.#i.oCfg.debug.masume&&(N.debugLog&&console.log(`🍌 masume ${this.name} v:${this.visible} l:${this.x} t:${this.y} a:${this.alpha} pl:${this.#s.pad_left} pr:${this.#s.pad_right} pt:${this.#s.pad_top} pb:${this.#s.pad_bottom} w:${this.#s.$width} h:${this.#s.$height}`),this.#p.clear().beginFill(3407616,.2).lineStyle(1,3407616,1).drawRect(-this.#s.pad_left,-this.#s.pad_top,this.#s.$width,this.#s.$height).endFill().beginFill(13311,.2).lineStyle(2,13311,1).drawRect(0,0,this.#s.$width-this.#s.pad_left-this.#s.pad_right,this.#s.$height-this.#s.pad_top-this.#s.pad_bottom).endFill()),this.#t.innerHTML=[...t].join("").replaceAll(/[\n\t]/g,"")+$.#n,!this.#o.break_fixed){const g=globalThis.getComputedStyle(this.#t),m=parseFloat(g.fontSize);this.#u?(this.#o.break_fixed_left=(this.#s.$width-this.#s.pad_left-this.#s.pad_right-m*1.5)*this.sys.cvsScale,this.#o.break_fixed_top=0):(this.#o.break_fixed_left=0,this.#o.break_fixed_top=m/2*this.sys.cvsScale)}}else i=this.#t.innerHTML,--s,this.#t.getElementsByClassName("sn_ch_last").item(0)?.remove(),this.#t.querySelectorAll(":scope > br").forEach(g=>g.remove()),this.#t.insertAdjacentHTML("beforeend",t.slice(this.#v).join("").replaceAll(/[\n\t]/g,"")+$.#n);this.#t.querySelectorAll(".sn_ch:has(> ruby)").forEach(g=>g.style.background=""),this.#v=t.length;const a=this.sys.cvsScale,h=this.#t.getBoundingClientRect(),n=h.left+this.#s.pad_left,r=h.top+this.#s.pad_top;let c;if(a===1)c=(g,m)=>{const T=g.getBoundingClientRect();return new J(T.left-n,T.top-r,T.width,T.height+("gjqy".includes(m)?this.#y:0))};else{const g=this.sys.ofsPadLeft_Dom2PIXI+h.left*(1-a),m=this.sys.ofsPadTop_Dom2PIXI+h.top*(1-a);c=(T,x)=>{const _=T.getBoundingClientRect();return new J((_.left-g)/a-n,(_.top-m)/a-r,_.width/a,(_.height+("gjqy".includes(x)?this.#y:0))/a)}}const[f,l]=this.#o.hyph(this.#t,c,this.#u,s,i);this.#_=f;const u=N.debugLog?({ch:g},{x:m,y:T,width:x,height:_})=>console.log(`🍌 masume ch:${g} x:${m} y:${T} w:${x} h:${_}`):()=>{},p=$.#i.oCfg.debug.masume?(g,m)=>{u(g,m),this.#p.beginFill(6737151,.5).lineStyle(2,16724736,1).drawRect(m.x,m.y,m.width,m.height).endFill()}:()=>{},o=F.ease(this.#C);for(let g=s;g<l;++g){const m=this.#_[g],T=m.rect,x=JSON.parse(m.elm.dataset.arg??'{"delay": 0}'),_=JSON.parse(m.elm.dataset.add??"{}"),C=$.#S[_.ch_in_style];if(p(m,T),m.elm.dataset.cmd==="grp"){const S=new j;this.#l.addChild(S),new b(x.pic,S,A=>{this.#D(S,x,_,T,o,C??{}),S.parent||S.removeChild(A)})}if(m.elm.dataset.lnk){const S=m.elm.parentElement.closest("[data-arg]"),A=JSON.parse(S.dataset.arg??"{}");A.key=`lnk=[${g}] `+this.name;const P=new O;this.#D(P,A,_,T,o,C??{});const I=A.style??"",nt=I+(A.style_hover??""),vt=I+(A.style_clicked??""),Q=A.r_style??"",$t=Q+(A.r_style_hover??""),_t=Q+(A.r_style_clicked??""),ft=Array.from(S.getElementsByTagName("rt"));for(const tt of ft)tt.dataset.st_r_bk=tt.style.cssText;const kt=S.style.cssText,Z=(tt,Ct)=>{S.style.cssText=kt+tt;for(const pt of ft)pt.style.cssText=pt.dataset.st_r_bk+Ct};E(A,"enabled",!0)?$.#a.button(A,P,()=>Z(I,Q),()=>this.canFocus()?(Z(nt,$t),!0):!1,()=>Z(vt,_t)):Z(I+(A.style_disable??"color: gray;"),Q+(A.r_style_disable??"color: gray;")),this.#l.addChild(P)}}const d=Array.from(this.#t.getElementsByClassName("sn_ch_yet"));this.#$=()=>{this.#$=()=>!1;for(const m of d)m.className="sn_ch";$.#R.position.set(this.#o.break_fixed_left,this.#o.break_fixed_top),$.#R.visible=!0,this.noticeCompTxt();const g=this.#L.shift();return this.#L.length>0&&g(),!0};for(const g of d)g.className=g.className.replace("sn_ch_yet sn","go");s>0&&++s;let y;for(let g=l-2;g>=0;--g){const{elm:m}=this.#_[g];if(m.tagName==="SPAN"){y=m.parentElement?.tagName==="RUBY"?m.parentElement.parentElement??m:m;break}}if(!y||e||s===l){this.#$();return}y.addEventListener("animationend",()=>this.#$(),{once:!0})}#$=()=>!1;#D(t,e,s,i,a,h){t.alpha=0,e.x&&(i.x=e.x.startsWith("=")?i.x+parseInt(e.x.slice(1)):parseInt(e.x)),e.y&&(i.y=e.y.startsWith("=")?i.y+parseInt(e.y.slice(1)):parseInt(e.y)),e.width&&(i.width=parseInt(e.width)),e.height&&(i.height=parseInt(e.height)),e.wait&&(h.wait=parseInt(e.wait)),t.width=i.width,t.height=i.height,h.x?t.position.set(h.x.startsWith("=")?i.x+t.width*h.nx:h.nx,h.y.startsWith("=")?i.y+t.height*h.ny:h.ny):t.position.set(i.x,i.y);const n={sp:t,tw:new jt(t).to({alpha:1,x:i.x,y:i.y,width:i.width,height:i.height,angle:0},h.wait??0).easing(a).delay((s.wait??0)+(e.delay??0)).onComplete(()=>{n.tw=void 0}).start()};this.#I.push(n)}#I=[];skipChIn(){let t=this.#$();for(const e of this.#I)e.tw&&(e.tw.stop().end(),t=!0);return this.#I=[],t}static#S=Object.create(null);static#W=/[{\s\.,*\{]/;static initChStyle(){$.#S=Object.create(null),$.#B=Object.create(null)}static getChInStyle(t){return $.#S[t]}static ch_in_style(t){const{name:e}=t;if(!e)throw"nameは必須です";if($.#W.test(e))throw`name【${e}】に使えない文字が含まれます`;if(e in $.#S)throw`name【${e}】はすでにあります`;const s=String(t.x??"=0"),i=String(t.y??"=0");return $.#S[e]={wait:v(t,"wait",500),alpha:v(t,"alpha",0),x:s,y:i,nx:parseFloat(s.at(0)==="="?s.slice(1):s),ny:parseFloat(i.at(0)==="="?i.slice(1):i),scale_x:v(t,"scale_x",1),scale_y:v(t,"scale_y",1),rotate:v(t,"rotate",0),join:E(t,"join",!0),ease:t.ease??"ease-out"}}static#B=Object.create(null);static getChOutStyle(t){return $.#B[t]}static ch_out_style(t){const{name:e}=t;if(!e)throw"nameは必須です";if($.#W.test(e))throw`name【${e}】に使えない文字が含まれます`;if(e in $.#B)throw`name【${e}】はすでにあります`;const s=String(t.x??"=0"),i=String(t.y??"=0");return $.#B[e]={wait:v(t,"wait",500),alpha:v(t,"alpha",0),x:s,y:i,nx:parseFloat(s.at(0)==="="?s.slice(1):s),ny:parseFloat(i.at(0)==="="?i.slice(1):i),scale_x:v(t,"scale_x",1),scale_y:v(t,"scale_y",1),rotate:v(t,"rotate",0),join:E(t,"join",!1),ease:t.ease??"ease-out"}}static#R=new j;static#O=new b;dispBreak(t){$.delBreak();const e=$.#R;e.visible=!1,this.addChild(e),$.#O.destroy(),$.#O=new b(t.pic,e,s=>{e.parent?(s.x=v(t,"x",0),s.y=v(t,"y",0),s.width=v(t,"width",this.#s.fontsize),s.height=v(t,"height",this.#s.fontsize)):e.removeChild(s)})}static delBreak(){const t=$.#R;t.parent?.removeChild(t),$.#O.destroy()}#C="Quadratic.Out";#m="Quadratic.Out";#J(){this.#p.clear(),this.#_=[],this.#v=0,this.#L=[],this.skipChIn();const t=this.#t.cloneNode(!0);t.textContent="";const e=this.#t;e.parentElement.insertBefore(t,e);let s=0;Array.from(e.getElementsByClassName("sn_ch")).forEach(a=>{const h=JSON.parse(a.dataset.add??a.children[0]?.getAttribute("data-add")??a.children[0]?.children[0]?.getAttribute("data-add")??"{}");if(!h.ch_out_style)return;const n=$.#B[h.ch_out_style];if(n){if(n.wait===0){a.style.display="none";return}s+=n.wait,n.join||(a.style.animationDelay="0ms"),a.classList.add(`go_ch_out_${h.ch_out_style}`)}});const i=()=>{e.parentElement.removeChild(e);for(const a of this.#l.removeChildren())a instanceof j&&$.#a.unButton(a),a.destroy()};s===0?(this.#t.textContent="",i()):e.lastElementChild?.addEventListener("animationend",i,{once:!0}),this.#t=t}reNew(){this.#J();const t=new $(this.ctn,()=>this.canFocus(),this.sys);return t.#s=this.#s,t.#t.style.cssText=this.#t.style.cssText,t.#d=this.#d,t.name=this.name,t.#c(),t.#k=this.#k,t.#C=this.#C,t.#m=this.#m,this.#o.reNew(t.#o),this.destroy(),t}#k=void 0;record(){return{infTL:this.#s,cssText:this.#t.style.cssText,left:this.#d,ch_filter:this.#k,fi_easing:this.#C,fo_easing:this.#m,hyph:this.#o.record()}}playback(t){this.#s=t.infTL,this.position.set(this.#s.pad_left,this.#s.pad_top),this.#t.style.cssText=t.cssText,this.#d=t.left,this.#c(),this.#k=t.ch_filter,this.#C=t.fi_easing,this.#m=t.fo_easing,this.#o.playback(t.hyph)}get cssText(){return this.#t.style.cssText}set cssText(t){this.#t.style.cssText=t}#b=void 0;snapshot(t,e){this.#r(s=>{this.#b=O.from(s),this.#u&&(this.#b.x+=N.stageW-(this.#d+this.#s.$width)),this.#b.y-=this.#w,this.#b.texture.frame=new J(0,0,Math.min(this.#b.width,this.#s.$width-this.#d),Math.min(this.#b.height,this.#s.$height)),this.#l.addChild(this.#b),t.render(this.#b,{clear:!1}),e()},!1)}snapshot_end(){this.#b&&(this.#l.removeChild(this.#b),this.#b=void 0)}makeDesignCast(t){}showDesignCast(){}dump(){const t=[],e=this.#t.style,s=e.length;for(let i=0;i<s;++i){const a=e[i];t.push(`"${a}":"${e[a].replaceAll(/(["\\])/g,"\\$1")}"`)}return`"txt":"${this.#t.textContent.replaceAll(/(["\\])/g,"\\$1")}", "style":{${t.join(",")}}`}destroy(){$.delBreak(),this.#t.parentElement.removeChild(this.#t),this.removeChild(this.#l),this.removeChild(this.#p),super.destroy()}}class V extends j{constructor(t,e,s,i){if(super(),this.hArg=t,this.evtMng=e,this.resolve=s,this.canFocus=i,this.#t={type:"pic",enabled:E(t,"enabled",!0),x:this.x=W(t.left??0),y:this.y=W(t.top??0),rotation:this.angle=v(t,"rotation",this.angle),pivot_x:this.pivot.x=v(t,"pivot_x",this.pivot.x),pivot_y:this.pivot.y=v(t,"pivot_y",this.pivot.y),scale_x:this.scale.x=v(t,"scale_x",this.scale.x),scale_y:this.scale.y=v(t,"scale_y",this.scale.y),alpha:1,text:"",b_pic:"",width:0,height:0},this.getBtnBounds=()=>(this.#a.x=this.#t.x,this.#a.y=this.#t.y,this.#a),this.#t.enabled&&e.button(t,this,()=>this.normal(),()=>this.#p(),()=>this.#g()),t.pic){this.#t.type="pic",this.#h=new b(t.pic,this,l=>{this.#o(l),this.#a.width=l.width*this.#t.scale_x,this.#a.height=l.height*this.#t.scale_y},l=>s);return}if(!t.text)throw"textまたはpic属性は必須です";const a=v(t,"height",30),h=new Tt({align:"center",dropShadow:!0,dropShadowAlpha:.7,dropShadowColor:"white",dropShadowBlur:7,dropShadowDistance:0,fill:this.#t.enabled?"black":"gray",fontFamily:V.fontFamily,fontSize:a,padding:5});if(t.style)try{const l=JSON.parse(t.style);for(const[u,p]of Object.entries(l))h[u]=p;this.#t={...this.#t,...l}}catch(l){throw l instanceof SyntaxError?new Error(ht(t,"style",l.message)):"fn:Button.ts style"}const n=new St(t.text??"",h);n.alpha=v(t,"alpha",n.alpha),n.width=v(t,"width",100),n.height=t.height=a,this.setText=l=>n.text=l,this.#t={...this.#t,type:"text",alpha:n.alpha,text:n.text,width:n.width,height:n.height};let r=!1;if(this.#t.width=this.width,this.#t.height=this.height,t.b_pic&&(this.#t.b_pic=t.b_pic,this.#h=new b(t.b_pic,this,l=>{this.#l(l,n),this.#t.width=this.width,this.#t.height=this.height,n.name=JSON.stringify(this.#t)},l=>{B.setBlendmode(this,t),l&&s()}),r=this.#h.ret),n.name=JSON.stringify(this.#t),this.addChild(n),this.#a.width=n.width,this.#a.height=n.height,t.b_pic||B.setBlendmode(this,t),V.#i(this,n),!this.#t.enabled){r||s();return}const c=h.clone();if(t.style_hover)try{const l=JSON.parse(t.style_hover);for(const[u,p]of Object.entries(l))c[u]=p}catch(l){throw l instanceof SyntaxError?new Error(ht(t,"style_hover",l.message)):"fn:Button.ts style_hover"}else c.fill="white";const f=c.clone();if(t.style_clicked)try{const l=JSON.parse(t.style_clicked);for(const[u,p]of Object.entries(l))f[u]=p}catch(l){throw l instanceof SyntaxError?new Error(ht(t,"style_clicked",l.message)):"fn:Button.ts style_clicked"}else f.dropShadow=!1;this.normal=()=>n.style=h,this.#p=()=>i()?(n.style=c,!0):!1,this.#g=()=>n.style=f,r||s()}static fontFamily="'Hiragino Sans', 'Hiragino Kaku Gothic ProN', '游ゴシック Medium', meiryo, sans-serif";static#i=(t,e)=>{};static#e=(t,e,s,i)=>{};static init(t){t.oCfg.debug.masume&&(V.#i=(e,s)=>e.addChild(new M().beginFill(8926088,.2).lineStyle(1,8926088,1).drawRect(s.x,s.y,s.width,s.height).endFill()),V.#e=(e,s,i,a)=>e.addChild(new M().beginFill(8926088,.2).lineStyle(1,8926088,1).drawRect(s.x,s.y,i,a).endFill()))}setText(t){}getBtnBounds=()=>this.#a;#a=new J;#h=new b;#t;destroy(){this.evtMng.unButton(this),this.#h.destroy(),super.destroy()}makeDesignCast(t){}showDesignCast(){}cvsResize(){}#l(t,e){this.setChildIndex(t,0),t.alpha=e.alpha,t.setTransform(e.x,e.y,1,1,e.rotation,0,0,(t.width-e.width)/2,(t.height-e.height)/2),t.name=e.name}normal=()=>{};#p=()=>!1;#g=()=>{};#o(t){this.#t.alpha=t.alpha=v(this.hArg,"alpha",t.alpha);const e=t.width/3,s=this.#t.enabled?e:t.width,i=t.height,a=t.texture.baseTexture,h=new H(a,new J(0,0,e,i)),n=new H(a,new J(e,0,e,i)),r=new H(a,new J(e*2,0,e,i)),c=()=>t.texture=h;this.#t.enabled&&c(),this.normal=c,this.#p=()=>this.canFocus()?(t.texture=r,!0):!1,this.#g=()=>t.texture=n,"width"in this.hArg?(this.#t.width=W(this.hArg.width),this.scale.x*=this.#t.width/s):this.#t.width=s,"height"in this.hArg?(this.#t.height=W(this.hArg.height),this.scale.y*=this.#t.height/i):this.#t.height=i,t.name=JSON.stringify(this.#t),V.#e(this,t,s,i)}}class w extends B{static#i;static#e;static#a;static#h;static init(t,e,s,i,a,h){w.#i=t,$.init(t,h),w.#e=s,w.#h=i,w.#a=a,s.setDoRecProc(w.chgDoRec),e.autowc=n=>w.#y(n),e.autowc({enabled:!1,text:"",time:0}),e.ch_in_style=n=>w.#t(n),e.ch_out_style=n=>w.#l(n),$.initChStyle(),Nt(),st(t.matchPath(".+",G.FONT).flatMap(n=>Object.values(n).map(r=>`
@font-face {
	font-family: '${r}';
	src: url('${this.#i.searchPath(r,G.FONT)}');
}
`)).join("")+`
.sn_tx {
	pointer-events: none;
	user-select: none;
	-webkit-touch-callout: none;
	box-sizing: border-box;
}
.sn_ch {
	position: relative;
	display: inline-block;
}
`),w.#t({name:"default",wait:500,alpha:0,x:"=0.3",y:"=0",scale_x:1,scale_y:1,rotate:0,join:!0,ease:"ease-out"}),w.#l({name:"default",wait:0,alpha:0,x:"=0",y:"=0",scale_x:1,scale_y:1,rotate:0,join:!1,ease:"ease-out"})}static#t(t){const e=$.ch_in_style(t),s=e.x.startsWith("=")?`${e.nx*100}%`:`${e.nx}px`,i=e.y.startsWith("=")?`${e.ny*100}%`:`${e.ny}px`,{name:a}=t;return st(`
.sn_ch_in_${a} {
	position: relative;
	display: inline-block;
}
.go_ch_in_${a} {
	opacity: ${e.alpha};
	position: relative;
	display: inline-block;
	animation: sn_ch_in_${a} ${e.wait}ms ${e.ease} 0s both;
}
@keyframes sn_ch_in_${a} {
	from {transform: rotate(${e.rotate}deg) scale(${e.scale_x}, ${e.scale_y}) translate(${s}, ${i})}
	to {opacity: 1; transform: none;}
}
`),!1}static#l(t){const e=$.ch_out_style(t),s=e.x.startsWith("=")?`${e.nx*100}%`:`${e.nx}px`,i=e.y.startsWith("=")?`${e.ny*100}%`:`${e.ny}px`,{name:a}=t;return st(`
.go_ch_out_${a} {
	position: relative;
	display: inline-block;
	animation: go_ch_out_${a} ${e.wait}ms ${e.ease} 0s both;
}
@keyframes go_ch_out_${a} {
	to {
		opacity: ${e.alpha};
		transform: rotate(${e.rotate}deg) scale(${e.scale_x}, ${e.scale_y}) translate(${s}, ${i});
	}
`),!1}static#p;static#g;static setEvtMng(t,e,s){w.#p=t,w.#g=e,$.setEvtMng(t,s)}static#o=!1;static#s={};static#y(t){w.#o=E(t,"enabled",w.#o),w.#e.setVal_Nochk("save","const.sn.autowc.enabled",w.#o);const{text:e}=t;if("text"in t!="time"in t)throw"[autowc] textとtimeは同時指定必須です";if(w.#e.setVal_Nochk("save","const.sn.autowc.text",e),!e)return w.#e.setVal_Nochk("save","const.sn.autowc.time",""),!1;const s=e.length;if(w.#o&&s===0)throw'[autowc] enabled === false かつ text === "" は許されません';const i=String(t.time).split(",");if(i.length!==s)throw"[autowc] text文字数とtimeに記述された待ち時間（コンマ区切り）は同数にして下さい";w.#s={};for(let a=0;a<s;++a)w.#s[e[a]]=W(i[a]);return w.#e.setVal_Nochk("save","const.sn.autowc.time",t.time),!1}#c=0;#d=0;#u=!1;#f=void 0;#w="";#r=new $(this.ctn,()=>this.canFocus(),w.#g);#L=new lt;#_=document.createElement("span");static#v={"text-align":0,"text-align-last":0,height:0,width:0,"padding-left":0,"padding-right":0,"padding-top":0,"padding-bottom":0};#n=new j;constructor(){super(),this.ctn.addChild(this.#r),this.#L.init(this.#q),this.ctn.addChild(this.#n),this.#n.name="cntBtn",this.lay({style:`width: ${N.stageW}px; height: ${N.stageH}px; font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', '游ゴシック Medium', meiryo, sans-serif; color: white; font-size: 24px; line-height: 1.5; padding: 16px;`,in_style:"default",out_style:"default",back_clear:"true"})}destroy(){this.#f&&(this.ctn.removeChild(this.#f).destroy(),this.#f=void 0),w.#h.recPagebreak(),this.#r.destroy()}static destroy(){w.#o=!1,w.#s={},w.#k=t=>t}set name(t){this.name_=t,this.#r.name=t}get name(){return this.name_}cvsResize(){this.#r.cvsResize()}cvsResizeChildren(){for(const t of this.#n.children)t.cvsResize()}procSetX(t){this.#r.lay({x:t})}procSetY(t){this.#r.lay({y:t})}lay(t){if(super.lay(t),B.setXY(this.ctn,t,this.ctn),t[":id_tag"]=this.name_.slice(0,-7),lt.setting(t),this.#R(t),this.#r.lay(t),"r_align"in t&&(this.#E=t.r_align??""),this.#b=N.isSafari?this.#r.tategaki?(i,a)=>`text-align: start; height: ${a}em; padding-top: ${i}; padding-bottom: ${i};`:(i,a)=>`text-align: start; width: ${a}em; padding-left: ${i}; padding-right: ${i};`:this.#r.tategaki?i=>`text-align: justify; text-align-last: justify; padding-top: ${i}; padding-bottom: ${i};`:i=>`text-align: justify; text-align-last: justify; padding-left: ${i}; padding-right: ${i};`,N.isFirefox&&(this.#G=this.#Z),"r_style"in t)if(t.r_style){const i=document.createElement("span");i.style.cssText=t.r_style;const a=i.style.length,h=this.#_.style;for(let n=0;n<a;++n){const r=i.style[n];if(r in w.#v){K.myTrace(`${r}は指定できません`,"W");continue}const c=i.style[r];c&&(h[r]=c)}}else this.#_.style.cssText="";if("alpha"in t)for(const i of this.#n.children)i.alpha=this.ctn.alpha;this.#T(t),this.#I(t);const e=R.procID+`TxtLayer lay name:${this.name_}`,s=this.#B(t,i=>{i&&R.endProc(e)});return s&&R.beginProc(e),s}#T(t){const{in_style:e}=t;if(!e)return;const s=$.getChInStyle(e);if(!s)throw`存在しないin_style【${e}】です`;this.#$=e,this.#D=s.join}#$="";#D=!0;get width(){return this.#r.getWidth}get height(){return this.#r.getHeight}#I(t){const{out_style:e}=t;if(e){if(!$.getChOutStyle(e))throw`存在しないout_style【${e}】です`;this.#S=e}}#S="";#W=new b;#B(t,e){if("back_clear"in t)return E(t,"back_clear",!1)&&(this.#c=0,this.#d=0,this.#u=!1,this.#w=""),e(!1),!1;this.#d=v(t,"b_alpha",this.#d),this.#u=E(t,"b_alpha_isfixed",this.#u);const s=(this.#u?1:Number(w.#e.getVal("sys:TextLayer.Back.Alpha")))*this.#d;if(t.b_pic){if(this.#w!==t.b_pic)return this.#w=t.b_pic,this.#f&&(this.ctn.removeChild(this.#f),this.#f.destroy()),this.#W=new b(this.#w,this.ctn,i=>{this.#f=i,i.name="back(pic)",i.visible=s>0,i.alpha=s,this.#r.setMySize(i.width,i.height),this.ctn.setChildIndex(i,0),e(!0)}),this.#W.ret}else"b_color"in t&&(this.#c=mt(t,"b_color",0),this.#f&&(this.ctn.removeChild(this.#f),this.#f.destroy()),this.#w="",this.ctn.addChildAt((this.#f=new M).beginFill(this.#c,s).lineStyle(void 0).drawRect(0,0,this.#r.getWidth,this.#r.getHeight).endFill(),0),this.#f.name="back(color)");return this.#f&&(this.#f.visible=s>0,this.#f.alpha=s),e(!1),!1}chgBackAlpha(t){const e=this.#u?this.#d:t*this.#d;this.#f instanceof M&&(this.#f&&(this.ctn.removeChild(this.#f),this.#f.destroy()),this.ctn.addChildAt((this.#f=new M).beginFill(this.#c,e).lineStyle(void 0).drawRect(0,0,this.#r.getWidth,this.#r.getHeight).endFill(),0),this.#f.name="back(color)"),this.#f&&(this.#f.visible=e>0,this.#f.alpha=e)}#R(t){"noffs"in t&&(this.#m=t.noffs??"",this.#J=new RegExp(`[　${this.#m}]`)),"ffs"in t&&(this.#O??="",this.#C=this.#O===""?()=>"":e=>this.#J.test(e)?"":` font-feature-settings: ${this.#O};`)}#O="";#C=t=>"";#m="";#J=/[　]/;static chgDoRec(t){w.#k=t?e=>e:e=>`<span class='offrec'>${e}</span>`}static#k=t=>t;isCur=!1;#b=()=>"";#G=(t,e,s,i="")=>{if(!s)return` style='${i}'`;const a=t.length*2;if(a-e.length<0)return` style='text-align: ${s}; ${i}'`;let h="";switch(s){case"justify":h=this.#b("0",a);break;case"121":h=this.#b(`calc(${(a-e.length)/(e.length*2)}em)`,a);break;case"even":h=this.#b(`calc(${(a-e.length)/(e.length+1)}em)`,a);break;case"1ruby":h=this.#b("1em",a);break;default:h=`text-align: ${s};`}return` style='${h} ${i}'`};#E="";#Z(t,e,s,i=""){if(!s)return` style='${i}'`;const a=t.length*2;if(a-e.length<0)return` style='text-align: ${s}; ${i}'`;let h="";switch(s){case"left":h="ruby-align: start;";break;case"center":h="ruby-align: center;";break;case"right":h="ruby-align: start;";break;case"justify":h="ruby-align: space-between;";break;case"121":h="ruby-align: space-around;";break;case"even":const n=(a-e.length)/(e.length+1);h="ruby-align: space-between; "+(this.#r.tategaki?`padding-top: ${n}em; padding-bottom: ${n}em;`:`padding-left: ${n}em; padding-right: ${n}em;`);break;case"1ruby":h="ruby-align: space-between; "+(this.#r.tategaki?"padding-top: 1em; padding-bottom: 1em;":"padding-left: 1em; padding-right: 1em;");break;default:h=`text-align: ${s};`}return` style='${h} ${i}'`}tagCh(t){this.#L.putTxt(t)}#A=!1;get needGoTxt(){return this.#A}#q=(t,e)=>{w.#i.oCfg.debug.putCh&&console.log(`🖊 文字表示 text:\`${t}\`(${t.charCodeAt(0).toString(16)}) ruby:\`${e}\` name:\`${this.name_}\``);const s=e.split("｜");let i="";const[a,...h]=s,n=h.join("｜");switch(s.length){case 1:if(this.#A=!0,t===`
`){this.#P?(this.#P=!1,i="<ruby>&emsp;<rt>&emsp;</rt></ruby><br/>"):i="<br/>";break}this.#P&&(this.#P=!1,e===""&&(e="&emsp;")),i=this.#Y(t,e,this.#E);break;default:switch(a){case"start":case"left":case"center":case"right":case"justify":case"121":case"even":case"1ruby":this.#P=!1,this.#A=!0,i=this.#Y(t,n,a);break;case"gotxt":this.#X(),this.#A?(this.isCur&&w.#h.recText(this.#N.join("").replace(/^<ruby>&emsp;<rt>&emsp;<\/rt><\/ruby>(<br\/>)+/,"").replaceAll(/style='(anim\S+ [^;]+;\s*)+/g,"style='").replaceAll(/( style=''| data-(add|arg|cmd)='[^']+'|\n+|\t+)/g,"").replaceAll(/class='sn_ch[^']+/g,"class='sn_ch").replaceAll("display: none;","").replaceAll("class='offrec'","style='display: none;'")),this.#r.goTxt(this.#N,this.#j===0),this.#A=!1,this.#j=0):this.isCur&&this.#r.noticeCompTxt();return;case"add":{const r=JSON.parse(n),{style:c="",wait:f=null}=r,{cl:l,sty:u}=this.#H(!0,f);this.#N.push(`<span${l} style='${u} display: inline; ${c}'>`),delete r.style,this.#K(r)}return;case"add_close":this.#N.push("</span>"),this.#X();return;case"grp":this.#A=!0;{const r=JSON.parse(n);if(r.id??=this.#N.length,r.id==="break"){this.#r.dispBreak(r);return}this.#P=!1,r.delay=this.#j,r.r??="",r.style??="",r.r_style??="";const{cl:c,sty:f,lnk:l}=this.#H(!0,r.wait);i=`<span${c} style='${f} ${r.style}'><ruby><span data-cmd='grp' data-arg='${JSON.stringify(r)}'${l} style='${f} display: inline;'>&emsp;</span><rt${l}${this.#G("　",r.r,this.#E,this.#_.style.cssText+(this.#x.at(-1)?.o.r_style??"")+r.r_style)}>${r.r}</rt></ruby></span>`}break;case"tcy":this.#P=!1,this.#A=!0;{const{t:r,r:c="",wait:f=null,style:l="",r_style:u=""}=JSON.parse(n);w.#e.doRecLog()&&(this.#V+=t+(e?`《${e}》`:""),this.#M+=r);const p=N.isSafari?c.replaceAll(/[A-Za-z0-9]/g,g=>String.fromCharCode(g.charCodeAt(0)+65248)):c,{cl:o,sty:d,lnk:y}=this.#H(!0,f);i=`<span${o} style='${d}${this.#C(r)} ${l}'><ruby><span${y} style='${d} display: inline; text-combine-upright: all;'>${r}</span><rt${y}${this.#G(r,p,this.#E,this.#_.style.cssText+(this.#x.at(-1)?.o.r_style??"")+u)}>${p}</rt></ruby></span>`}break;case"del":$.delBreak();return;case"span":this.#A=!0,this.#Q(JSON.parse(n));return;case"link":this.#A=!0;{const r=JSON.parse(n);r[":link"]=" data-lnk='@'";const{cl:c,sty:f,curpos:l}=this.#H(!1,r.wait);this.#N.push(`<span${c} style='${f} display: inline; ${r.style??""}' ${l} data-arg='${n}'>`),delete r.style,this.#Q(r)}return;case"endlink":this.#A=!0,this.#N.push("</span>"),this.#X();return;default:this.#A=!0,i=this.#Y(t,e,this.#E)}break}this.#N.push(w.#k(i))};#Y(t,e,s){const i=t===" "?"&nbsp;":t==="　"?"&emsp;":t;w.#e.doRecLog()&&(this.#V+=i+(e?`《${e}》`:""),t!==" "&&(this.#M+=t));const{cl:a,sty:h,lnk:n}=this.#H(!0,null,t);return e?`<span${a} style='${h} ${this.#C(t)}'><ruby>${Array.from(t).map((r,c)=>`<span${a}${n} style='${c>0?this.#H(!0,null,t).sty:h} display: inline;'>${r===" "?"&nbsp;":r==="　"?"&emsp;":r}</span>`).join("")}<rt${n}${this.#G(t,e,s,this.#_.style.cssText+(this.#x.at(-1)?.o.r_style??""))}>${e}</rt></ruby></span>`:`<span${a} style='${h} ${this.#C(t)}'${n}>${i}</span>`}#H(t,e,s=`
`){const i=this.#D?e??this.#x.at(0)?.o.wait??(w.#o?w.#s[s.at(0)??""]??0:z.msecChWait):0;w.#p.isSkipping?this.#j=0:t&&this.#D&&(this.#j+=Number(i));const a=`data-add='{"ch_in_style":"${this.#$}", "ch_out_style":"${this.#S}"}'`;return{cl:` class='sn_ch sn_ch_yet sn_ch_in_${this.#$}'`,sty:`animation-delay: ${this.#j}ms;${this.#x.at(-1)?.o.style??""}`,lnk:(this.#x.at(0)?.o[":link"]??"")+" "+a,curpos:a}}#j=0;#P=!0;#N=[];#x=[];#K(t){this.#x.push({o:t,r_align:this.#E,ch_in_style:this.#$,ch_out_style:this.#S}),"r_align"in t&&(this.#E=t.r_align),this.#T(t),this.#I(t)}#X(){const t=this.#x.pop();t&&(this.#E=t.r_align,this.#T({in_style:t.ch_in_style}),this.#I({out_style:t.ch_out_style}))}#Q(t){const e=this.#x.at(-1);if(!e){this.#K(t);return}e.o={...e.o,...t},!t.style&&!t.r_style&&(e.o.style="",e.o.r_style=""),"r_align"in t&&(this.#E=t.r_align),this.#T(t),this.#I(t)}click=()=>!this.ctn.interactiveChildren||!this.ctn.visible?!1:this.#r.skipChIn();clearText(){this.ctn.addChild(this.#r=this.#r.reNew()),this.#j=0,this.#P=!0,this.#N=[],this.#V="",this.#M="",w.#h.recPagebreak()}#V="";#M="";get pageText(){return this.#V.replace("《&emsp;》","")}get pagePlainText(){return this.#M}get enabled(){return this.ctn.interactiveChildren}set enabled(t){this.ctn.interactiveChildren=t}addButton=t=>new Promise(e=>{t.key=`btn=[${this.#n.children.length}] `+this.name_,t[":id_tag"]=t.key.slice(0,-7),E(t,"hint_tate",this.#r.tategaki);const s=new V(t,w.#p,()=>e(),()=>this.canFocus());s.name=JSON.stringify(t).replaceAll('"',"'"),this.#n.addChild(s)});canFocus(){return(this.ctn.interactiveChildren??!1)&&this.ctn.visible&&w.#a(this)}clearLay(t){super.clearLay(t),this.clearText();for(const e of this.#n.removeChildren())e.destroy()}record=()=>({...super.record(),enabled:this.enabled,r_cssText:this.#_.style.cssText,r_align:this.#E,b_do:this.#f===void 0?void 0:this.#f instanceof O?"Sprite":"Graphics",b_pic:this.#w,b_color:this.#c,b_alpha:this.#d,b_alpha_isfixed:this.#u,ffs:this.#O,txs:this.#r.record(),strNoFFS:this.#m,btns:this.#n.children.map(t=>t.name)});playback(t,e){super.playback(t,e),this.enabled=t.enabled,this.#_.style.cssText=t.r_cssText,this.#E=t.r_align,this.cvsResize(),this.#R(t),this.#r.playback(t.txs),this.#d=t.b_alpha,this.#u=t.b_alpha_isfixed,e=[e,new Promise(s=>{const i=t.b_do?t.b_do==="Sprite"?{b_pic:t.b_pic}:{b_color:t.b_color}:{b_pic:""};i.b_alpha=t.b_alpha,i.b_alpha_isfixed=t.b_alpha_isfixed,this.#B(i,a=>{a&&s()})||s()}),t.btns.map(s=>new Promise(i=>{this.addButton(JSON.parse(s.replaceAll("'",'"'))),i()}))].flat()}get cssText(){return this.#r.cssText}set cssText(t){this.#r.cssText=t}snapshot(t,e){t.render(this.ctn,{clear:!1}),this.#r.snapshot(t,e)}snapshot_end(){this.#r.snapshot_end()}makeDesignCast(t){this.ctn.visible&&this.#r.makeDesignCast(t)}makeDesignCastChildren(t){if(this.ctn.visible)for(const e of this.#n.children)e.makeDesignCast(t)}showDesignCast(){this.#r.showDesignCast()}showDesignCastChildren(){for(const t of this.#n.children)t.showDesignCast()}dump(){return this.#q("","gotxt｜"),super.dump()+`, "enabled":"${this.enabled}", ${this.#r.dump()}, "b_pic":"${this.#w}", "b_color":"${this.#c}", "b_alpha":${this.#d}, "b_alpha_isfixed":"${this.#u}", "width":${this.#r.getWidth}, "height":${this.#r.getHeight}, "pixi_obj":[${this.ctn.children.map(t=>`{"class":"${t instanceof O?"Sprite":t instanceof M?"Graphics":t instanceof j?"Container":"?"}", "name":"${t.name}", "alpha":${t.alpha}, "x":${t.x}, "y":${t.y}, "visible":"${t.visible}"}`).join(",")}], "button":[${this.#n.children.map(t=>t.children[0]?.name??"{}").join(",")}]`}}class k{constructor(t,e,s){this.appPixi=e,this.val=s,t.add_frame=i=>this.#p(i),t.let_frame=i=>this.#d(i),t.set_frame=i=>this.#u(i),t.frame=i=>this.#w(i),t.tsy_frame=i=>this.#r(i)}static#i;static#e;static#a;static init(t,e,s){k.#i=t,k.#e=e,k.#a=s}#h;setEvtMng(t){this.#h=t}#t=Object.create(null);destroy(){for(const t of Object.values(this.#t))t.parentElement.removeChild(t);this.#t=Object.create(null)}hideAllFrame(){for(const[t,{style:e}]of Object.entries(this.#t))this.#l[t]=e.display!=="none",e.display="none"}#l=Object.create(null);restoreAllFrame(){for(const[t,e]of Object.entries(this.#l)){const s=this.#t[t];s&&(s.style.display=e?"inline":"none")}this.#l=Object.create(null)}#p(t){const{id:e,src:s,alpha:i=1,scale_x:a=1,scale_y:h=1,rotate:n=0}=t;if(!e)throw"idは必須です";if(!s)throw"srcは必須です";const r="const.sn.frm."+e;if(this.val.getVal(`tmp:${r}`))throw`frame【${e}】はすでにあります`;const c=E(t,"visible",!0),f=t.b_color?` background-color: ${t.b_color};`:"",l=this.#o(t);k.#a.cvs.insertAdjacentHTML("beforebegin",`<iframe id="${e}" style="opacity: ${i}; ${f} position: absolute; left:${k.#e.ofsLeft4elm+l.x*k.#e.cvsScale}px; top: ${k.#e.ofsTop4elm+l.y*k.#e.cvsScale}px; z-index: 1; border: 0px; overflow: hidden; display: ${c?"inline":"none"}; transform: scale(${a}, ${h}) rotate(${n}deg);" width="${l.width*k.#e.cvsScale}" height="${l.height*k.#e.cvsScale}"></iframe>`);const u=R.procID+`add_frame id:${e}`;R.beginProc(u);const p=k.#i.searchPath(s,G.HTML),o=new U().add({name:s,url:p,xhrType:L.XHR_RESPONSE_TYPE.TEXT});return k.#e.arg.crypto&&o.use(async(d,y)=>{try{d.data=await k.#e.dec(d.extension,d.data)}catch(g){k.#a.errScript(`[add_frame]Html ロード失敗です src:${d.name} ${g}`,!1)}y()}),o.load((d,y)=>{const g=document.getElementById(e);this.#t[e]=g,this.#g[e]=!1;const m=p.lastIndexOf("/")+1,T=p.slice(0,m),x=T.slice(0,m);g.srcdoc=String(y[s]?.data).replace("sn_repRes();","").replaceAll(/\s(?:src|href)=(["'])(\S+?)\1/g,(_,C,S)=>S.startsWith("../")?_.replace("../",x):_.replace("./","").replace(C,C+T)),g.srcdoc.includes("true/*WEBP*/;")&&(g.srcdoc=g.srcdoc.replaceAll(/data-src="(.+?\.)(?:jpe?g|png)/g,(_,C)=>`data-src="${C}webp`)),g.onload=()=>{R.endProc(u),this.val.setVal_Nochk("tmp",r,!0),this.val.setVal_Nochk("tmp",r+".alpha",i),this.val.setVal_Nochk("tmp",r+".x",l.x),this.val.setVal_Nochk("tmp",r+".y",l.y),this.val.setVal_Nochk("tmp",r+".scale_x",a),this.val.setVal_Nochk("tmp",r+".scale_y",h),this.val.setVal_Nochk("tmp",r+".rotate",n),this.val.setVal_Nochk("tmp",r+".width",l.width),this.val.setVal_Nochk("tmp",r+".height",l.height),this.val.setVal_Nochk("tmp",r+".visible",c);const _=g.contentWindow;this.#h.resvFlameEvent(_),_.sn_repRes?.(C=>k.#s(C.dataset.src??"",C))}}),!0}#g={};getFrmDisabled(t){return this.#g[t]}#o(t){const e={...t},s=k.#e.resolution;return new DOMRect(v(e,"x",0)*s,v(e,"y",0)*s,v(e,"width",N.stageW)*s,v(e,"height",N.stageH)*s)}static#s(t,e,s){const i=this.#c[t];if(i){e.src=i,s&&(e.onload=()=>s(e));return}const a=this.#y[t];if(a){a.push(e);return}this.#y[t]=[e];const[h="",n=""]=t.split("?"),r=k.#i.searchPath(h,G.SP_GSM),c=new U().add({name:t,url:r,xhrType:L.XHR_RESPONSE_TYPE.BUFFER});k.#e.arg.crypto&&r.endsWith(".bin")&&c.use(async(f,l)=>{try{const u=await k.#e.decAB(f.data);if(f.extension!=="bin"){l();return}f.data=u,u instanceof HTMLImageElement&&(f.type=L.TYPE.IMAGE)}catch(u){k.#a.errScript(`FrameMng loadPic ロード失敗です fn:${f.name} ${u}`,!1)}l()}),c.load((f,l)=>{for(const[u,{data:{src:p}}]of Object.entries(l)){const o=this.#c[u]=p+(p.startsWith("blob:")||p.startsWith("data:")?"":n?"?"+n:""),d=this.#y[u];if(d)for(const y of d)y.src=o,s&&(y.onload=()=>s(y));delete this.#y[u]}})}static#y={};static#c={};cvsResize(){for(const[t,e]of Object.entries(this.#t)){const s="const.sn.frm."+t,i=Number(this.val.getVal(s+".x")),a=Number(this.val.getVal(s+".y")),h=Number(this.val.getVal(s+".width")),n=Number(this.val.getVal(s+".height"));e.style.left=`${k.#e.ofsLeft4elm+i*k.#e.cvsScale}px`,e.style.top=`${k.#e.ofsTop4elm+a*k.#e.cvsScale}px`,e.width=String(h*k.#e.cvsScale),e.height=String(n*k.#e.cvsScale)}}#d(t){const{id:e,var_name:s}=t;if(!e)throw"idは必須です";const i=document.getElementById(e);if(!i)throw`id【${e}】はフレームではありません`;const a="const.sn.frm."+e;if(!this.val.getVal(`tmp:${a}`))throw`frame【${e}】が読み込まれていません`;if(!s)throw"var_nameは必須です";const h=i.contentWindow;if(!Object.hasOwn(h,s))throw`frame【${e}】に変数/関数【${s}】がありません。変数は var付きにして下さい`;const n=h[s];return this.val.setVal_Nochk("tmp",a+"."+s,E(t,"function",!1)?n():n),!1}#u(t){const{id:e,var_name:s,text:i}=t;if(!e)throw"idは必須です";const a=document.getElementById(e);if(!a)throw`id【${e}】はフレームではありません`;const h="const.sn.frm."+e;if(!this.val.getVal(`tmp:${h}`))throw`frame【${e}】が読み込まれていません`;if(!s)throw"var_nameは必須です";if(!i)throw"textは必須です";this.val.setVal_Nochk("tmp",h+"."+s,i);const n=a.contentWindow;return n[s]=i,!1}#f=1;#w(t){const{id:e}=t;if(!e)throw"idは必須です";const s=document.getElementById(e);if(!s)throw`id【${e}】はフレームではありません`;const i="const.sn.frm."+e;if(!this.val.getVal("tmp:"+i))throw`frame【${e}】が読み込まれていません`;const a=s.style;if(E(t,"float",!1)?a.zIndex=`${++this.#f}`:"index"in t?a.zIndex=`${v(t,"index",0)}`:t.dive&&(a.zIndex=`-${++this.#f}`),"alpha"in t){const n=a.opacity=String(t.alpha);this.val.setVal_Nochk("tmp",i+".alpha",n)}const h=this.#o(t);if(("x"in t||"y"in t)&&(a.left=`${k.#e.ofsLeft4elm+h.x*k.#e.cvsScale}px`,a.top=`${k.#e.ofsTop4elm+h.y*k.#e.cvsScale}px`,this.val.setVal_Nochk("tmp",i+".x",h.x),this.val.setVal_Nochk("tmp",i+".y",h.y)),"scale_x"in t||"scale_y"in t||"rotate"in t){const n=v(t,"scale_x",1),r=v(t,"scale_y",1),c=v(t,"rotate",0);a.transform=`scale(${n}, ${r}) rotate(${c}deg)`,this.val.setVal_Nochk("tmp",i+".scale_x",n),this.val.setVal_Nochk("tmp",i+".scale_y",r),this.val.setVal_Nochk("tmp",i+".rotate",c)}if("width"in t&&(s.width=String(h.width*k.#e.cvsScale),this.val.setVal_Nochk("tmp",i+".width",h.width)),"height"in t&&(s.height=String(h.height*k.#e.cvsScale),this.val.setVal_Nochk("tmp",i+".height",h.height)),"visible"in t){const n=E(t,"visible",!0);a.display=n?"inline":"none",this.val.setVal_Nochk("tmp",i+".visible",n)}if("b_color"in t&&(a.backgroundColor=t.b_color),"disabled"in t){const n=this.#g[e]=E(t,"disabled",!0),r=s.contentDocument.body;for(const c of[...Array.from(r.getElementsByTagName("input")),...Array.from(r.getElementsByTagName("select"))])c.disabled=n}return!1}#r(t){const{id:e,alpha:s,x:i,y:a,scale_x:h,scale_y:n,rotate:r,width:c,height:f}=t;if(!e)throw"idは必須です";const l=document.getElementById(e);if(!l)throw`id【${e}】はフレームではありません`;const u="const.sn.frm."+e;if(!this.val.getVal(`tmp:${u}`,0))throw`frame【${e}】が読み込まれていません`;const p={};s&&(p.a=l.style.opacity),(i||a||h||n||r)&&(p.x=Number(this.val.getVal(`tmp:${u}.x`)),p.y=Number(this.val.getVal(`tmp:${u}.y`)),p.sx=Number(this.val.getVal(`tmp:${u}.scale_x`)),p.sy=Number(this.val.getVal(`tmp:${u}.scale_y`)),p.r=Number(this.val.getVal(`tmp:${u}.rotate`))),c&&(p.w=this.val.getVal(`tmp:${u}.width`)),f&&(p.h=this.val.getVal(`tmp:${u}.height`));const o=F.cnvTweenArg(t,p);let d=()=>{};s&&(v(o,"alpha",0),d=()=>{l.style.opacity=p.a,this.val.setVal_Nochk("tmp","alpha",p.a)});let y=()=>{};const g=this.#o(o);(i||a||h||n||r)&&(g.x,g.y,v(o,"scale_x",1),v(o,"scale_y",1),v(o,"rotate",0),y=()=>{l.style.left=k.#e.ofsLeft4elm+p.x*k.#e.cvsScale+"px",l.style.top=k.#e.ofsTop4elm+p.y*k.#e.cvsScale+"px",l.style.transform=`scale(${p.sx}, ${p.sy}) rotate(${p.r}deg)`,this.val.setVal_Nochk("tmp",u+".x",p.x),this.val.setVal_Nochk("tmp",u+".y",p.y),this.val.setVal_Nochk("tmp",u+".scale_x",p.sx),this.val.setVal_Nochk("tmp",u+".scale_y",p.sy),this.val.setVal_Nochk("tmp",u+".rotate",p.r)});let m=()=>{};c&&(g.width,m=()=>{l.width=p.w*k.#e.cvsScale+"px",this.val.setVal_Nochk("tmp",u+".width",p.w)});let T=()=>{};return f&&(g.height,T=()=>{l.height=p.h*k.#e.cvsScale+"px",this.val.setVal_Nochk("tmp",u+".height",p.h)}),this.appPixi.stage.interactive=!1,F.tween(`frm
${e}`,t,p,F.cnvTweenArg(t,p),()=>{d(),y(),m(),T()},()=>this.appPixi.stage.interactive=!0,()=>{}),!1}}class z{constructor(t,e,s,i,a,h,n,r,c){this.cfg=t,this.hTag=e,this.appPixi=s,this.val=i,this.main=a,this.scrItr=h,this.sys=n,this.sndMng=r,this.prpPrs=c;const f=()=>{if(n.cvsResize(),this.cvsResizeDesign(),this.#o)for(const o of this.#T)this.#n[o].fore.cvsResizeChildren();else for(const o of this.#T)this.#n[o].fore.cvsResize();this.#h.cvsResize(),this.#c.cvsResize()};if(N.isMobile)this.#l.add(globalThis,"orientationchange",f,{passive:!0});else{let o;this.#l.add(globalThis,"resize",()=>{o||(o=setTimeout(()=>{o=void 0,f()},1e3/60*10))},{passive:!0})}n.cvsResize(),w.init(t,e,i,this,o=>this.#n[o.layname].fore===o,s),D.init(a,t,s,n,r,i),k.init(t,n,a),V.init(t),this.#h=new k(e,s,i),n.hFactoryCls.grp=()=>new D,n.hFactoryCls.txt=()=>new w,e.loadplugin=o=>this.#_(o),e.snapshot=o=>this.#f(o),this.#w=this.sys.isApp?this.#r:this.#L,e.add_lay=o=>this.#v(o),e.clear_lay=o=>this.#W(o),e.finish_trans=()=>F.finish_trans(),e.lay=o=>this.#I(o),e.trans=o=>this.#J(o),e.wt=o=>F.wt(o),e.quake=o=>this.#E(o),e.stop_quake=e.finish_trans,e.wq=o=>e.wt(o),e.pause_tsy=o=>F.pause_tsy(o),e.resume_tsy=o=>F.resume_tsy(o),e.stop_tsy=o=>F.stop_tsy(o),e.tsy=o=>this.#Z(o),e.wait_tsy=o=>F.wait_tsy(o),e.add_filter=o=>this.#A(o),e.clear_filter=o=>this.#Y(o),e.enable_filter=o=>this.#H(o),e.ch=o=>this.#N(o),e.clear_text=o=>this.#et(o),e.current=o=>this.#X(o),e.endlink=o=>this.#st(o),e.er=o=>this.#it(o),e.graph=o=>this.#at(o),e.link=o=>this.#nt(o),e.r=o=>this.#ht(o),e.rec_ch=o=>this.#tt(o),e.rec_r=o=>this.#rt(o),e.reset_rec=o=>this.#ot(o),e.ruby2=o=>this.#lt(o),e.span=o=>this.#ct(o),e.tcy=o=>this.#dt(o),e.add_face=o=>b.add_face(o),e.wv=o=>b.wv(o),e.dump_lay=o=>this.#ft(o),e.enable_event=o=>this.#pt(o),e.button=o=>this.#ut(o),t.existsBreakline&&(this.breakLine=o=>{delete o.visible,o.id="break",o.pic="breakline";const d=encodeURIComponent(JSON.stringify(o));this.#u("grp｜"+d)}),t.existsBreakpage&&(this.breakPage=o=>{delete o.visible,o.id="break",o.pic="breakpage";const d=encodeURIComponent(JSON.stringify(o));this.#u("grp｜"+d)}),this.#t=Pt(String(t.oCfg.init.bg_color));const l=new M;l.beginFill(this.#t).lineStyle(0,this.#t).drawRect(0,0,N.stageW,N.stageH).endFill(),this.#e.addChild(l.clone()),this.#a.addChild(l),this.#a.visible=!1,this.#e.name="page:A",this.#a.name="page:B",this.#i=s.stage,this.#i.addChild(this.#a),this.#i.addChild(this.#e),this.#i.addChild(this.#O),this.#i.addChild(this.#m),this.#i.name="stage";const u=(o,d)=>{this.#d(Number(d))};u("",i.getVal("sys:TextLayer.Back.Alpha",1)),i.defValTrg("sys:TextLayer.Back.Alpha",u);const p=(o,d)=>V.fontFamily=d;p("",i.getVal("tmp:sn.button.fontFamily",V.fontFamily)),i.defValTrg("tmp:sn.button.fontFamily",p),i.defTmp("const.sn.log.json",()=>JSON.stringify((this.#F.text=this.#F.text?.replaceAll("</span><span class='sn_ch'>","")??"")?[...this.#U,this.#F]:this.#U)),i.defTmp("const.sn.last_page_text",()=>this.currentTxtlayFore?.pageText??""),i.defTmp("const.sn.last_page_plain_text",()=>this.currentTxtlayFore?.pagePlainText??""),N.isDbg&&(ct.init(s,n,h,c,t,this.#n),this.cvsResizeDesign=()=>ct.cvsResizeDesign(),n.addHook((o,d)=>{this.#p[o]?.(o,d)&&delete this.#p[o]}))}#i;#e=new j;#a=new j;#h;#t;#l=new xt;cvsResizeDesign(){}#p={attach:t=>!1,continue:t=>!1,disconnect:t=>!1,_enterDesign:t=>{for(const e of this.#T){const s=this.#n[e].fore;s.makeDesignCastChildren(i=>i.make()),s.makeDesignCast(i=>i.make())}return this.#s(this.#$),!1},_replaceToken:(t,e)=>!1,_selectNode:(t,e)=>(this.#s(e.node),!1)};#g="";#o="";#s(t){[this.#g="",this.#o=""]=t.split("/");const e=this.#n[this.#g];e&&(this.#o?e.fore.showDesignCastChildren():e.fore.showDesignCast())}getFrmDisabled=t=>this.#h.getFrmDisabled(t);#y=void 0;cover(t,e=0){this.#y&&(this.#i.removeChild(this.#y),this.#y.destroy(),this.#y=void 0),t&&this.#i.addChild((this.#y=new M).beginFill(e).lineStyle(0,e).drawRect(0,0,N.stageW,N.stageH).endFill())}#c;setEvtMng(t){this.#c=t,this.#h.setEvtMng(t),b.setEvtMng(t),F.init(t,this.appPixi)}destroy(){for(const t of Object.values(this.#n))t.destroy();this.#l.clear(),D.destroy(),lt.destroy(),$.destroy(),w.destroy(),this.#h.destroy(),F.destroy(),z.#P=10}#d(t){for(const{fore:e,back:s}of Object.values(this.#n))e instanceof w&&(e.chgBackAlpha(t),s.chgBackAlpha(t))}#u=(t,e=this.currentTxtlayForeNeedErr,s=!0)=>e.tagCh("｜&emsp;《"+t+"》");goTxt=()=>{};get needGoTxt(){return this.currentTxtlayFore?.needGoTxt??!1}breakLine=t=>{};breakPage=t=>{};clearBreak(){this.currentTxtlayFore&&(this.clearBreak=()=>this.#u("del｜break"),this.clearBreak())}clickTxtLay(){return this.currentTxtlayFore?Object.values(this.#n).some(t=>t instanceof w&&t.click()):!1}#f(t){const e=Ft("-","_","","_"),s=t.fn?t.fn.startsWith(Rt)?t.fn:`${gt+t.fn+e}.png`:`${gt}snapshot${e}.png`,i=this.cfg.searchPath(s),a=v(t,"width",N.stageW),h=v(t,"height",N.stageH);return this.#w(t,i,a,h,`snapshot dt:${e}`)}#w=()=>!1;#r({layer:t},e,s,i,a){if(this.#h.hideAllFrame(),R.beginProc(a),!t)return this.sys.capturePage(e,s,i,()=>{this.#h.restoreAllFrame(),R.endProc(a)}),!0;const h=Object.values(this.#n).map(({fore:{ctn:n}})=>{const r=[n,n.visible];return n.visible=!1,r});for(const n of this.#k(t))this.#n[n].fore.ctn.visible=!0;return this.sys.capturePage(e,s,i,()=>{for(const[n,r]of h)n.visible=r;this.#h.restoreAllFrame(),R.endProc(a)}),!0}#L(t,e,s,i,a){R.beginProc(a);const h=mt(t,"b_color",this.#t),n=Ot({width:s,height:i,backgroundAlpha:h>16777216&&e.endsWith(".png")?0:1,antialias:E(t,"smoothing",!1),preserveDrawingBuffer:!0,backgroundColor:h&16777215,autoDensity:!0}),r=t.page!=="back"?"fore":"back",{layer:c}=t;return Promise.allSettled(this.#k(c).map(f=>new Promise(l=>this.#n[f][r].snapshot(n,l)))).then(async()=>{const f=q.create({width:n.width,height:n.height});n.render(this.#i,{renderTexture:f}),await this.sys.savePic(e,n.plugins.extract.base64(f)),f.destroy();for(const l of this.#k(c))this.#n[l][r].snapshot_end();n.destroy(!0),R.endProc(a)}),!0}#_(t){const{fn:e}=t;if(!e)throw"fnは必須です";if(!e.endsWith(".css"))throw"サポートされない拡張子です";const s=E(t,"join",!0),i=R.procID+`loadplugin fn:${e}`;return s&&R.beginProc(i),(async()=>{const a=await fetch(e);if(!a.ok)throw new Error("Network response was not ok.");st(await a.text()),s&&R.endProc(i)})(),s}#v(t){const{layer:e,class:s}=t;if(!e)throw"layerは必須です";if(e.includes(","))throw"layer名に「,」は使えません";if(e in this.#n)throw`layer【${e}】はすでにあります`;if(!s)throw"clsは必須です";const i={isWait:!1};switch(this.#n[e]=new X(e,s,this.#e,this.#a,t,this.sys,this.val,i),this.#T.push(e),s){case"txt":this.#$||(this.#M=()=>{},this.#x=this.#K,this.#X=this.#Q,this.hTag.current({layer:e}),this.goTxt=()=>{this.#c.isSkipping?z.#P=0:this.setNormalChWait();for(const{fore:a}of Object.values(this.#n))a instanceof w&&this.#u("gotxt｜",a,!1)}),this.val.setVal_Nochk("save","const.sn.layer."+(e??this.#$)+".enabled",!0);break;case"grp":if(this.#D)break;this.#D=e;break}return this.scrItr.recodeDesign(t),i.isWait}#n={};#T=[];#$="";#D="";#I(t){const e=this.#z(t),s=this.#n[e],i=s.back.ctn,a=s.fore.ctn;if(E(t,"float",!1))this.#a.setChildIndex(i,this.#a.children.length-1),this.#e.setChildIndex(a,this.#e.children.length-1),this.#S();else if(t.index)v(t,"index",0)&&(this.#a.setChildIndex(i,t.index),this.#e.setChildIndex(a,t.index),this.#S());else if(t.dive){const{dive:h}=t;let n=0;if(e===h)throw"[lay] 属性 layerとdiveが同じ【"+h+"】です";const r=this.#n[h];if(!r)throw"[lay] 属性 dive【"+h+"】が不正です。レイヤーがありません";const c=r.back,f=r.fore,l=this.#a.getChildIndex(c.ctn),u=this.#e.getChildIndex(f.ctn);n=l<u?l:u,n>this.#a.getChildIndex(i)&&--n,this.#e.setChildIndex(a,n),this.#a.setChildIndex(i,n),this.#S()}return t[":id_tag"]=s.fore.name.slice(0,-7),this.scrItr.recodeDesign(t),s.lay(t)}#S(){this.#T=this.#G()}#W(t){return this.#b(t,e=>{const s=this.#n[this.#z({layer:e})];if(t.page==="both"){s.fore.clearLay(t),s.back.clearLay(t);return}s.getPage(t).clearLay(t)}),!1}static#B=`
precision mediump float;

varying vec2 vTextureCoord;
uniform sampler2D uSampler;

uniform sampler2D rule;
uniform float vague;
uniform float tick;

uniform vec4 inputPixel;
uniform highp vec4 outputFrame;
vec2 getUV(vec2 coord) {
	return coord * inputPixel.xy / outputFrame.zw;
}

void main() {
	vec4 fg = texture2D(uSampler, vTextureCoord);
	vec4 ru = texture2D(rule, getUV(vTextureCoord));

	float v = ru.r - tick;
	gl_FragColor = abs(v) < vague
		? vec4(fg.rgb, 1) *fg.a *(0.5 +v /vague *0.5)
		: 0.0 <= v ? fg : vec4(0);
}`;#R=q.create({width:N.stageW,height:N.stageH});#O=new O(this.#R);#C=q.create({width:N.stageW,height:N.stageH});#m=new O(this.#C);#J(t){F.finish_trans(),this.#c.hideHint();const{layer:e}=t,s=new Set,i=this.#k(e).map(x=>(s.add(x),this.#n[x].fore)),a=async()=>{[this.#e,this.#a]=[this.#a,this.#e];const x=[];for(const[_,C]of Object.entries(this.#n)){if(s.has(_)){C.transPage(x);continue}const{fore:{ctn:S},back:{ctn:A}}=C,P=this.#e.getChildIndex(A);this.#e.removeChild(A),this.#a.removeChild(S),this.#e.addChildAt(S,P),this.#a.addChildAt(A,P)}await Promise.allSettled(x),this.#e.visible=!0,this.#a.visible=!1,this.#O.visible=!1,this.#m.visible=!1,R.notifyEndProc(Bt+et)};if(this.#m.filters=[],this.#m.alpha=1,v(t,"time",0)===0||this.#c.isSkipping)return a(),!1;let h=[];const n=[];for(const[x,_]of Object.entries(this.#n)){const C=s.has(x)?_.back:_.fore;C.ctn.visible&&h.push(C.ctn),n.push(C)}const{ticker:r,renderer:c}=this.appPixi;c.render(this.#a,{renderTexture:this.#R});let f=()=>{for(const x of h)c.render(x,{renderTexture:this.#R,clear:!1})};if(!n.some(x=>x.containMovement)){const x=f;f=()=>{f=()=>{},x()}}const l=()=>c.render(this.#e,{renderTexture:this.#C});l();let u=()=>{this.#e.visible=!0,l(),this.#e.visible=!1};if(!i.some(x=>x.containMovement)){const x=u;u=()=>{u=()=>{},x()}}const p=()=>{f(),this.#O.visible=!0,u(),this.#m.visible=!0},{glsl:o,rule:d}=t,y=async()=>{r.remove(p),await a()};if(!o&&!d)return F.tween(et,t,this.#m,{alpha:0},()=>{},y,()=>{}),r.add(p),!1;const g={rule:H.EMPTY,vague:v(t,"vague",.04),tick:0};this.#m.filters=[new Lt(void 0,o??z.#B,g)];const m=F.tween(et,t,g,{tick:1},()=>{},y,()=>{},!d);if(!d)return r.add(p),!1;const T=new b(d,void 0,x=>{g.rule=x.texture,x.destroy(),T.destroy(),m.start(),r.add(p)});return!1}#k(t=""){return t?t.split(","):this.#T}#b(t,e){const s=this.#k(t.layer);for(const i of s){const a=this.#n[i];if(!a)throw"存在しないlayer【"+i+"】です";e(i,a)}return s}#G(t=""){return this.#k(t).sort((e,s)=>{const i=this.#e.getChildIndex(this.#n[e].fore.ctn),a=this.#e.getChildIndex(this.#n[s].fore.ctn);return i<a?-1:i>a?1:0})}setAllStyle2TxtLay(t){for(const{fore:e}of Object.values(this.#n))e instanceof w&&e.lay({style:t})}#E(t){if(F.finish_trans(),v(t,"time",NaN)===0)return!1;const e=this.#k(t.layer).map(f=>this.#n[f].fore.ctn),{renderer:s,ticker:i}=this.appPixi;this.#C.resize(N.stageW,N.stageH);const a=()=>{this.#e.visible=!0;for(const f of e)s.render(f,{renderTexture:this.#C,clear:!1});this.#e.visible=!1};this.#m.visible=!0,this.#m.alpha=1;const h=W(v(t,"hmax",10)),n=W(v(t,"vmax",10)),r=h===0?()=>{}:()=>this.#m.x=Math.round(Math.random()*h*2)-h,c=n===0?()=>{}:()=>this.#m.y=Math.round(Math.random()*n*2)-n;return this.#m.filters=[],F.tween(et,t,this.#m,{x:0,y:0},()=>{r(),c()},()=>{i.remove(a),this.#e.visible=!0,this.#m.visible=!1,this.#m.x=0,this.#m.y=0},()=>{}),i.add(a),!1}#Z(t){const{layer:e,render:s,name:i}=t;if(!e)throw"layerは必須です";const a=this.#n[this.#z(t)],h=a.fore;let n=()=>{};s&&!this.#c.isSkipping&&(h.renderStart(),n=()=>h.renderEnd());const r=F.cnvTweenArg(t,h),c=E(t,"arrive",!1),f=E(t,"backlay",!1),l=a.back.ctn;return F.tween(i??e,t,h,F.cnvTweenArg(t,h),()=>{},n,()=>{if(c&&Object.assign(h,r),f)for(const u of Object.keys(F.hMemberCnt))l[u]=h[u]}),"filter"in t&&(h.ctn.filters=[B.bldFilters(t)],h.aFltHArg=[t]),!1}#A(t){return F.finish_trans(),this.#b(t,e=>{const s=this.#n[this.#z({layer:e})];if(t.page==="both"){this.#q(s.fore,t),this.#q(s.back,t);return}const i=s.getPage(t);this.#q(i,t)}),!1}#q(t,e){const s=t.ctn;s.filters??=[],s.filters=[...s.filters,B.bldFilters(e)],t.aFltHArg.push(e)}#Y(t){return this.#b(t,e=>{const s=this.#n[this.#z({layer:e})];if(t.page==="both"){const a=s.fore,h=s.back;a.ctn.filters=null,h.ctn.filters=null,a.aFltHArg=[],h.aFltHArg=[];return}const i=s.getPage(t);i.ctn.filters=null,i.aFltHArg=[]}),!1}#H(t){return this.#b(t,e=>{const s=this.#n[this.#z({layer:e})];if(t.page==="both"){this.#j(s.fore,t),this.#j(s.back,t);return}const i=s.getPage(t);this.#j(i,t)}),!1}#j(t,e){const s=t.ctn;if(!s.filters)throw"フィルターがありません";const i=W(v(e,"index",0)),a=s.filters.length;if(a<=i)throw`フィルターの個数（${a}）を越えています`;t.aFltHArg[i].enabled=s.filters[i].enabled=E(e,"enabled",!0)}static#P=10;static get msecChWait(){return z.#P}#N(t){const{text:e}=t;if(!e)throw"textは必須です";const s=this.#x(t);delete t.text,this.setNormalChWait(),this.#c.isSkipping?t.wait=0:"wait"in t&&v(t,"wait",NaN);const i=encodeURIComponent(JSON.stringify(t));this.#u("add｜"+i,s);const a=E(t,"record",!0),h=this.val.doRecLog();return a||this.val.setVal_Nochk("save","sn.doRecLog",a),s.tagCh(e.replaceAll("[r]",`
`)),this.val.setVal_Nochk("save","sn.doRecLog",h),this.#u("add_close｜",s),!1}#x=t=>{throw this.#M(),0};#K(t){const e=this.#z(t,this.#$),s=this.#n[e].getPage(t);if(!(s instanceof w))throw e+"はTxtLayerではありません";return s}setNormalChWait(){z.#P=this.scrItr.normalWait}#X=t=>{throw this.#M(),0};#Q(t){const{layer:e}=t;if(!e)throw"[current] layerは必須です";const s=this.#n[e];if(!s||!(s.getPage(t)instanceof w))throw`${e}はTxtLayerではありません`;this.#V=s,this.recPagebreak(),this.#$=e,this.val.setVal_Nochk("save","const.sn.mesLayer",e);for(const[i,{fore:a,back:h}]of Object.entries(this.#n))a instanceof w&&(a.isCur=h.isCur=i===e);return!1}get currentTxtlayForeNeedErr(){return this.#M(),this.currentTxtlayFore}get currentTxtlayFore(){return this.#V?this.#V.fore:null}#V;#M=()=>{throw"文字レイヤーがありません。文字表示や操作する前に、[add_lay layer=（レイヤ名） class=txt]で文字レイヤを追加して下さい"};#z(t,e=""){const s=t.layer??e;if(s.includes(","))throw"layer名に「,」は使えません";if(!(s in this.#n))throw"属性 layer【"+s+"】が不正です。レイヤーがありません";return t.layer=s}#F={text:""};#U=[];recText(t){this.#F={text:t},this.val.setVal_Nochk("save","const.sn.sLog",String(this.val.getVal("const.sn.log.json")))}recPagebreak(){this.#F.text&&(this.#F.text=this.#F.text.replaceAll("</span><span class='sn_ch'>",""),this.#U.push(this.#F)>this.cfg.oCfg.log.max_len&&(this.#U=this.#U.slice(-this.cfg.oCfg.log.max_len)),this.#F={text:""})}#et(t){const e=this.#x(t);return t.layer===this.#$&&t.page==="fore"&&this.recPagebreak(),e.clearText(),!1}#st(t){return this.#u("endlink｜",this.#x(t)),!1}#it(t){return E(t,"rec_page_break",!0)&&this.recPagebreak(),this.#V&&(this.#V.fore.clearLay(t),this.#V.back.clearLay(t)),!1}#at(t){if(!t.pic)throw"[graph] picは必須です";const e=encodeURIComponent(JSON.stringify(t));return this.#u("grp｜"+e,this.#x(t)),!1}#nt(t){if(!t.fn&&!t.label&&!t.url)throw"fn,label,url いずれかは必須です";t.fn??=this.scrItr.scriptFn,t.style??="background-color: rgba(255,0,0,0.5);",t.style_hover??="background-color: rgba(255,0,0,0.9);",t.style_clicked??=t.style;const e=encodeURIComponent(JSON.stringify(t));return this.#u("link｜"+e,this.#x(t)),!1}#ht(t){return t.text=`
`,this.#N(t)}#rt(t){return this.#tt({...t,text:"[r]"})}#tt(t){return this.#F={...t,text:this.#F.text},t.text?(t.record=!0,t.style??="",t.style+="display: none;",t.wait=0,this.#N(t)):!1}#ot(t){return this.#U=[],this.#F={text:t.text??""},this.val.setVal_Nochk("save","const.sn.sLog",t.text?`[{text:"${t.text}"}]`:"[]"),!1}#lt(t){const{t:e,r:s}=t;if(!e)throw"[ruby2] tは必須です";if(!s)throw"[ruby2] rは必須です";return t.text="｜"+encodeURIComponent(e)+"《"+encodeURIComponent(s)+"》",delete t.t,delete t.r,this.#N(t)}#ct(t){const e=encodeURIComponent(JSON.stringify(t));return this.#u("span｜"+e,this.#x(t)),!1}#dt(t){if(!t.t)throw"[tcy] tは必須です";const e=encodeURIComponent(JSON.stringify(t));return this.#u("tcy｜"+e,this.#x(t)),!1}#ft({layer:t}){console.group("🥟 [dump_lay]");for(const e of this.#k(t)){const{fore:s,back:i}=this.#n[e];try{console.info(`%c${s.name.slice(0,-7)} %o`,`color:#${N.isDarkMode?"49F":"05A"};`,JSON.parse(`{"back":{${i.dump()}}, "fore":{${s.dump()}}}`))}catch(a){console.error("dump_lay err:%o",a),console.error(`   back:${i.dump()}`),console.error(`   fore:${s.dump()}`)}}return console.groupEnd(),!1}#pt(t){const e=this.#z(t,this.#$),s=E(t,"enabled",!0);return this.#x(t).enabled=s,this.val.setVal_Nochk("save","const.sn.layer."+e+".enabled",s),!1}#ut(t){return X.argChk_page(t,"back"),t.fn??=this.scrItr.scriptFn,this.#x(t).addButton(t),this.scrItr.recodeDesign(t),!1}record(){const t={};for(const e of this.#T){const s=this.#n[e];t[e]={cls:s.cls,fore:s.fore.record(),back:s.back.record()}}return t}playback(t){this.#U=JSON.parse(String(this.val.getVal("save:const.sn.sLog"))),this.#F={text:""};const e=[],s=[];for(const[a,{fore:h,fore:{idx:n},back:r,cls:c}]of Object.entries(t)){s.push({ln:a,idx:n});const f=this.#n[a]??=new X(a,c,this.#e,this.#a,{},this.sys,this.val,{isWait:!1});f.fore.playback(h,e),f.back.playback(r,e)}const i=this.#e.children.length;return e.push(new Promise(a=>{for(const{ln:h,idx:n}of s.sort(({idx:r},{idx:c})=>r===c?0:r<c?-1:1)){const{fore:r,back:c}=this.#n[h];if(!r)continue;const f=i>n?n:i-1;this.#e.setChildIndex(r.ctn,f),this.#a.setChildIndex(c.ctn,f)}a()})),e}}const qt=Object.freeze(Object.defineProperty({__proto__:null,LayerMng:z},Symbol.toStringTag,{value:"Module"}));export{V as B,qt as L,w as T};
