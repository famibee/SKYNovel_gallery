import{l as B,b as v,u as W,a as E,q as St,o as ht,r as Nt,s as L,v as M,R as z,w as D,x as Et,j as st,S as X,C as T,D as Q,y as bt,z as P,B as rt,L as U,F as At,c as O,i as ut,f as Rt,H as xt,I as Ft,E as wt,P as Pt,J as gt,g as yt,K as Ot,M as Y,N as Lt}from"./web.js";import{i as F}from"./CmnTween.js";import{a as J,O as q,c as mt,x as Bt}from"./ReadState.js";import{o as lt}from"./RubySpliter.js";import"../web.js";class G{constructor(t,e,s,i,a,h,n,r){this.cls=e,this.hArg=a,this.sys=h,this.val=n,this.ret=r;const c=h.hFactoryCls[e];if(!c)throw`属性 class【${e}】が不正です`;const g=c(),l=c();g.layname=l.layname=t;const u=a[":id_tag"]=`layer:${t} cls:${e} page:`;g.ctn.name=g.name=u+"A",l.ctn.name=l.name=u+"B",s.addChild(g.ctn),i.addChild(l.ctn),E(a,"visible",!0),E(a,"visible",!0),r.isWait=g.lay(a)||l.lay(a),this.#i={fore:g,back:l};const f=`const.sn.lay.${t}`;n.setVal_Nochk("tmp",f,!0),n.defTmp(f+".fore.alpha",()=>this.#i.fore.alpha),n.defTmp(f+".back.alpha",()=>this.#i.back.alpha),n.defTmp(f+".fore.height",()=>this.#i.fore.height),n.defTmp(f+".back.height",()=>this.#i.back.height),n.defTmp(f+".fore.visible",()=>this.#i.fore.ctn.visible),n.defTmp(f+".back.visible",()=>this.#i.back.ctn.visible),n.defTmp(f+".fore.width",()=>this.#i.fore.width),n.defTmp(f+".back.width",()=>this.#i.back.width),n.defTmp(f+".fore.x",()=>this.#i.fore.x),n.defTmp(f+".back.x",()=>this.#i.back.x),n.defTmp(f+".fore.y",()=>this.#i.fore.y),n.defTmp(f+".back.y",()=>this.#i.back.y)}#i;destroy(){this.#i.fore.destroy(),this.#i.back.destroy()}lay=t=>this.getPage(t).lay(t);getPage=t=>G.argChk_page(t,"fore")!=="back"?this.#i.fore:this.#i.back;static argChk_page(t,e){const s=t.page??e;if(s==="fore"||s==="back")return t.page=s;throw Error("属性 page【"+s+"】が不正です")}get fore(){return this.#i.fore}get back(){return this.#i.back}transPage(t){[this.#i.back,this.#i.fore]=[this.#i.fore,this.#i.back],this.#i.back.copy(this.#i.fore,t)}}class ct{constructor(t,e=!1){this.bg_col=t,this.isLay=e}static init(t,e,s,i,a,h){}static cvsResizeDesign(){}destroy(){}gethArg(){return this.hArg}hArg={};sethArg(t){this.hArg=t}setOther(t){}adopt(t){}static enterMode(){}static allHide(){}set visible(t){}static leaveMode(){}cvsResize(){}make(){}static replaceToken(t){}}class Vt extends ct{constructor(t,e){super("#29e",!0)}setSp(t){}}class b{constructor(t="",e,s=()=>{},i=()=>{}){this.csvFn=t,this.ctn=e,this.fncFirstComp=s,this.fncAllComp=i,t&&(this.#g=e?a=>{e.addChild(a),this.#o.push(a)}:()=>{},this.ret=b.#s(t,a=>this.fncFirstComp(a),a=>this.fncAllComp(a),a=>this.#g(a)))}static#i;static#e;static#a;static#h;static init(t,e,s,i,a){b.#i=t,b.#e=e,b.#a=s,b.#h=i,s.arg.crypto&&(b.#f=b.#p,b.#r=b.#L);const h=()=>{const n=b.#c*b.#t;for(const r of Object.values(b.#_))r.volume=n};a.setNoticeChgVolume(n=>{b.#c=n,h()},n=>{b.#t=n,h()})}static#t=1;static#c=1;static#d;static setEvtMng(t){b.#d=t}ret=!1;#g;#o=[];destroy(){this.fncFirstComp=()=>{},this.fncAllComp=()=>{},this.#g=t=>t.destroy();for(const t of this.#o)b.stopVideo(t.name),t.parent?.removeChild(t),t.destroy();this.#o=[]}static destroy(){b.#y={},b.#l={},b.#_={}}static#s(t,e,s,i){if(!t)return!1;let a=!1;if(t.startsWith("data:")){const l=()=>{const u=P.from(t);i(u),e(u),s(a)};return t in rt?l():(a=!0,new U().add(t,t).load(l)),a}const h=[],n=new U,r=t.split(","),c=r.length;for(let l=0;l<c;++l){const u=r[l];if(!u)throw"face属性に空要素が含まれます";const{dx:f,dy:o,blendmode:d,fn:p}=b.#y[u]||{fn:u,dx:0,dy:0,blendmode:At.NORMAL},y=l===0?e:x=>{x.x=f,x.y=o,x.blendMode=d};if(h.push({fn:p,fnc:y}),p in b.#l||p in rt||p in U.shared.resources)break;a=!0;const m=b.#i.searchPath(p,X.SP_GSM),C=this.#a.arg.crypto?{xhrType:m.slice(-5)===".json"?O.XHR_RESPONSE_TYPE.TEXT:O.XHR_RESPONSE_TYPE.BUFFER}:{};n.add({...C,name:p,url:m})}const g=(l,u)=>{for(const{fn:f,fnc:o}of h){const d=b.#$(f,u);d.name=f,i(d),o(d)}s(a)};return a?n.use(async(l,u)=>{try{if(l.extension==="json"){const o=await this.#a.dec("json",l.data);b.#r(o,l,u);return}const f=await this.#a.decAB(l.data);b.#f(f,l,u)}catch(f){const o=`画像/動画ロード失敗です fn:${l.name} ${f}`;b.#d.isSkipping?console.warn(o):console.error("%c"+o,"color:#FF3300;")}}).load(g):queueMicrotask(()=>g(0,{})),a}static#y={};static#l={};static#f=(t,{type:e,name:s,data:i},a)=>{switch(e){case O.TYPE.VIDEO:const h=i;h.volume=b.#c,b.#_[s]=b.#v(h)}a()};static#u(t){const e=/([^\d]+)\d+\.(\w+)/.exec(t[0]??"");if(!e)return[];const s=e[1].length,i=-e[2].length-1;return t.sort((a,h)=>ut(a.slice(s,i))>ut(h.slice(s,i))?1:-1)}static async#p(t,e,s){e.data=t,e.extension!=="bin"&&s(),t instanceof HTMLImageElement?(e.texture=await D.fromLoader(t,e.url,e.name),e.type=O.TYPE.IMAGE):t instanceof HTMLVideoElement&&(t.volume=b.#c,b.#_[e.name]=b.#v(t),e.type=O.TYPE.VIDEO),s()}static#v(t){return b.#e.getVal("const.sn.needClick2Play")&&(Q.trace_beforeNew(`[lay系] ${Q.strPos()}未クリック状態で動画を自動再生します。音声はミュートされます`,"W"),t.muted=!0),t.setAttribute("playsinline",""),t}static#r=(t,{type:e,spritesheet:s,name:i,data:a},h)=>{switch(e){case O.TYPE.JSON:const n=s._frameKeys;b.#u(n),b.#l[i]={aTex:n.map(r=>D.from(r)),meta:a.meta}}h()};static#L(t,e,s){const{meta:i,frames:a}=e.data=JSON.parse(t);if(e.type=O.TYPE.JSON,!i?.image){s();return}const h=Rt(i.image),n=b.#i.searchPath(h,X.SP_GSM);new U().use((r,c)=>{this.#a.decAB(r.data).then(g=>{r.data=g,g instanceof HTMLImageElement&&(r.type=O.TYPE.IMAGE,URL.revokeObjectURL(g.src)),c()}).catch(g=>this.#h.errScript(`画像/動画ロード失敗です dec2res4Cripto fn:${r.name} ${g}`,!1))}).add({name:h,url:n,xhrType:O.XHR_RESPONSE_TYPE.BUFFER}).load((r,c)=>{for(const{data:g}of Object.values(r.resources)){const{baseTexture:l}=D.from(g),u=Object.values(a);b.#l[e.name]={aTex:u.map(({frame:{x:f,y:o,w:d,h:p}})=>new D(l,new z(f,o,d,p))),meta:i}}s()})}static#$(t,e){const s=b.#l[t];if(s){const h=new xt(s.aTex);return h.animationSpeed=s.meta.animationSpeed??1,h.play(),h}if(t in rt)return P.from(t);const i=b.#_[t];if(i)return P.from(i);const a=e[t];return a?new P(a.texture):new P}static#_={};static getHFn2VElm(t){return b.#_[t]}static wv(t){const{fn:e}=t;if(!e)throw"fnは必須です";const s=b.#_[e];if(!s||s.loop)return!1;if(b.#d.isSkipping||s.ended)return b.stopVideo(e),!1;const i=()=>b.#d.breakEvent("wv fn:"+e);s.addEventListener("ended",i,{once:!0,passive:!0});const a=E(t,"stop",!0);return b.#d.waitEvent("wv fn:"+e,t,()=>{s.removeEventListener("ended",i),a&&b.stopVideo(e),i()})}static stopVideo(t){const e=b.#_[t];e&&(delete b.#_[t],e.pause(),e.currentTime=e.duration)}static add_face(t){const{name:e}=t;if(!e)throw"nameは必須です";if(e in b.#y)throw"一つのname（"+e+"）に対して同じ画像を複数割り当てられません";const{fn:s=e}=t;return b.#y[e]={fn:s,dx:v(t,"dx",0),dy:v(t,"dy",0),blendmode:L.getBlendmodeNum(t.blendmode||"")},!1}}class I extends L{static#i=new wt;static#e;static init(t,e,s,i,a,h){I.#e=s,b.init(e,h,i,t,a)}static destroy(){I.#i.clear(),b.destroy()}#a=new Vt(this.ctn,this);constructor(){super(),T.isDbg&&(this.#h=t=>this.#a.setSp(t),this.cvsResize=()=>{super.cvsResize(),this.#a.cvsResize()})}#h=()=>{};#t="";#c="";#d="";lay=t=>{const e=this.#g(t,s=>{s&&J()});return e&&q(),e};#g(t,e){const{fn:s,face:i=""}=t;if(this.#a.sethArg(t),!s)return super.lay(t),this.ctn.children.length>0&&this.setPos(t),this.#c="",this.#t=this.#d=i,e(!1),!1;const a="fn"in t,h="face"in t;return this.clearLay({clear_filter:E(t,"clear_filter",!0)}),a&&(this.#c=s),h&&(this.#d=i),super.lay(t),t.dx=0,t.dy=0,this.#o.destroy(),this.#o=new b(this.#t=s+(i?","+i:""),this.ctn,n=>{("width"in t||"height"in t)&&(n.width=v(t,"width",0),n.height=v(t,"height",0)),this.#s=n.width,this.#y=n.height,L.setXY(n,t,this.ctn,!0),L.setBlendmode(this.ctn,t),this.#h(n)},n=>e(n)),this.#o.ret}#o=new b;#s=0;#y=0;get width(){return this.#s}get height(){return this.#y}renderStart(){this.#f=new P(this.#l),this.#f.visible=!1,this.ctn.addChildAt(this.#f,0),this.#f.position.set(-this.ctn.x,-this.ctn.y);let t=()=>{const e=this.ctn.alpha;this.ctn.alpha=1;for(const s of this.ctn.children)s.visible=!0;this.#f.visible=!1,I.#e.renderer.render(this.ctn,{renderTexture:this.#l}),this.ctn.alpha=e;for(const s of this.ctn.children)s.visible=!1};if(!this.containMovement){let e=t;t=()=>{t=()=>{},e()}}this.#u=()=>{t(),this.#f.visible=!0},I.#e.ticker.add(this.#u)}#l=Y.create({width:T.stageW,height:T.stageH});#f=new P;#u=()=>{};renderEnd(){I.#e.ticker.remove(this.#u),this.ctn.removeChild(this.#f);for(const t of this.ctn.children)t.visible=!0;this.#f.destroy(!0),this.#l=Y.create({width:T.stageW,height:T.stageH})}setPos(t){L.setXY(this.ctn.children[0]??this.ctn,t,this.ctn,!0)}get containMovement(){if(this.#t==="")return!1;const t=this.ctn.children;return this.#t.split(",").some((e,s)=>t[s]instanceof xt||b.getHFn2VElm(e))}clearLay(t){super.clearLay(t),this.#o.destroy(),this.#c="",this.#d="",this.#t=""}record=()=>({...super.record(),sBkFn:this.#c,sBkFace:this.#d});playback(t,e){if(super.playback(t,e),t.sBkFn===""&&t.sBkFace===""){this.#c="",this.#d="";return}e.push(new Promise(s=>this.#g({fn:t.sBkFn,face:t.sBkFace,left:t.x,top:t.y,alpha:t.alpha,blendmode:L.getNum2Blendmode(t.blendMode),rotation:t.rotation,scale_x:t.scale_x,scale_y:t.scale_y},i=>{this.ctn.position.set(t.x,t.y),s()})))}makeDesignCast(t){this.ctn.visible&&t(this.#a)}cvsResize(){super.cvsResize()}showDesignCast(){this.#a.visible=!0}dump=()=>super.dump()+`, "pic":"${this.#t}"`}const K="、。，．）］｝〉」』】〕”〟ぁぃぅぇぉっゃゅょゎァィゥェォッャュョヮヵヶ！？!?‼⁉・ーゝゞヽヾ々",it="［（｛〈「『【〔“〝",at="─‥…",ot=K,vt=new RegExp(`[${K}]`),jt=new RegExp(`[${it}]`),It=new RegExp(`[${at}]`),Mt=vt;class Dt{#i=K;#e=it;#a=at;#h=ot;get 行頭禁則(){return this.#i}get 行末禁則(){return this.#e}get 分割禁止(){return this.#a}get ぶら下げ(){return this.#h}#t=vt;#c=jt;#d=It;#g=Mt;break_fixed=!1;break_fixed_left=0;break_fixed_top=0;bura=!1;lay(t){t.kinsoku_sol&&(this.#i=t.kinsoku_sol,this.#t=new RegExp(`[${this.#i}]`)),t.kinsoku_eol&&(this.#e=t.kinsoku_eol,this.#o(),this.#c=new RegExp(`[${this.#e}]`)),t.kinsoku_dns&&(this.#a=t.kinsoku_dns,this.#s(),this.#d=new RegExp(`[${this.#a}]`)),t.kinsoku_bura&&(this.#h=t.kinsoku_bura,this.#o(),this.#s(),this.#g=new RegExp(`[${this.#h}]`)),"bura"in t&&(this.bura=E(t,"bura",!1)),this.break_fixed=E(t,"break_fixed",this.break_fixed),this.break_fixed_left=v(t,"break_fixed_left",this.break_fixed_left),this.break_fixed_top=v(t,"break_fixed_top",this.break_fixed_top)}#o(){const t=this.#e.length,e=this.#h.length;if(t<e)for(let s=0;s<t;++s){const i=this.#e[s];if(this.#h.includes(i))throw`禁則の競合があります。文字 ${i} がぶら下げ と 行末禁則 の両方に含まれます`}else for(let s=0;s<e;++s){const i=this.#h[s];if(this.#e.includes(i))throw`禁則の競合があります。文字 ${i} がぶら下げ と 行末禁則 の両方に含まれます`}}#s(){const t=this.#a.length,e=this.#h.length;if(t<e)for(let s=0;s<t;++s){const i=this.#a[s];if(this.#h.includes(i))throw`禁則の競合があります。文字 ${i} がぶら下げ と 分割禁止 の両方に含まれます`}else for(let s=0;s<e;++s){const i=this.#h[s];if(this.#a.includes(i))throw`禁則の競合があります。文字 ${i} がぶら下げ と 分割禁止 の両方に含まれます`}}reNew(t){t.#y(this.#i,this.#e,this.#a,this.#h),t.break_fixed=this.break_fixed,t.break_fixed_left=this.break_fixed_left,t.break_fixed_top=this.break_fixed_top,t.bura=this.bura}#y(t,e,s,i){this.#i!=t&&(this.#i=t,this.#t=new RegExp(`[${t}]`)),this.#e!=e&&(this.#e=e,this.#c=new RegExp(`[${e}]`)),this.#a!=s&&(this.#a=s,this.#d=new RegExp(`[${s}]`)),this.#h!=i&&(this.#h=i,this.#g=new RegExp(`[${i}]`))}record(){const t={break_fixed:this.break_fixed,break_fixed_left:this.break_fixed_left,break_fixed_top:this.break_fixed_top,bura:this.bura};return this.#i===K&&(t.行頭禁則=this.#i),this.#e===it&&(t.行末禁則=this.#e),this.#a===at&&(t.分割禁止=this.#a),this.#h===ot&&(t.ぶら下げ=this.#h),t}playback(t){t&&(this.#y(t.行頭禁則??K,t.行末禁則??it,t.分割禁止??at,t.ぶら下げ??ot),this.break_fixed=t.break_fixed,this.break_fixed_left=t.break_fixed_left,this.break_fixed_top=t.break_fixed_top,this.bura=t.bura)}hyph(t,e,s,i,a){let h,n=0,r=2,c=g=>(c=()=>!1,i===g?(i>0&&(t.innerHTML=a.replaceAll('class="sn_ch"','class="sn_ch sn_ch_in_default"')),!0):g<2);do{if(h=this.#f(t,e),n=h.length,c(n))break;let g=-1/0;for(;r<n;++r){const{elm:l,rect:u,ch:f}=h[r];if(l.tagName==="RT")continue;const o=s?u.y:u.x;if(g<=o||l.previousElementSibling?.tagName==="SPAN"&&l.previousElementSibling?.innerHTML.includes("<br>")||l.parentElement?.previousElementSibling?.tagName==="SPAN"&&l.parentElement?.previousElementSibling?.innerHTML.includes("<br>")){g=o,this.break_fixed||(this.break_fixed_left=u.x,this.break_fixed_top=u.y);continue}const d=this.#l(h,r),{elm:p,rect:y,ch:m}=h[d];if(!this.break_fixed){this.break_fixed_left=y.x,this.break_fixed_top=y.y;const R=globalThis.getComputedStyle(p),j=parseFloat(R.fontSize);s?this.break_fixed_top+=j:this.break_fixed_left+=j}g=-1/0;const C=r,{cont:x,ins:k}=this.bura?this.hyph_alg_bura(h,d,m,r):this.hyph_alg(h,d,m,r,f);if(r=k,x)continue;const S=h[r].elm,N=S.parentElement,A=document.createElement("br");if(N.classList.contains("sn_tx"))N.insertBefore(A,S);else{const R=N.parentElement;R.classList.contains("sn_ch")?R.parentElement.insertBefore(A,R):R.insertBefore(A,N)}r+=2,r<C&&(r=C),n=-1;break}}while(n<0);return[h,n]}#l(t,e){const s=e-1,{elm:i}=t[s];return i.tagName!=="RT"?s-(i.style.textCombineUpright==="all"?Array.from(i.textContent??"").length-1:0):s-Array.from(i.textContent??"").length}#f(t,e){const s=[];if(t.nodeType!==t.TEXT_NODE)return Array.from(t.childNodes).map(n=>this.#f(n,e)).flat();const i=t.ownerDocument.createRange();i.selectNodeContents(t);let a=0;const h=i.endOffset;for(;a<h;){i.setStart(t,a),i.setEnd(t,++a);const n=i.toString();s.push({ch:n,rect:e(i,n),elm:i.startContainer.parentElement})}return i.detach(),s}hyph_alg(t,e,s,i,a){if(!this.#c.test(s)){if(this.#t.test(a))for(;(i=this.#l(t,i))>=0&&this.#t.test(t[i].ch););else if(!(s===a&&this.#d.test(s)))return{cont:!0,ins:i+1}}for(i=e;(i=this.#l(t,i))>=0&&this.#c.test(t[i].ch););return{cont:!1,ins:i+1}}hyph_alg_bura(t,e,s,i){const a=this.#l(t,e),{ch:h}=t[a];if(this.#g.test(h)||this.#t.test(h)){let r=e;(this.#g.test(s)||this.#t.test(s))&&++r;const c=this.#l(t,r),{ch:g}=t[c],{ch:l}=t[r];if(g===l&&this.#d.test(l))return{cont:!1,ins:c};if(!this.#c.test(g))return{cont:!1,ins:r};r=c;do if(!this.#c.test(t[r].ch))break;while((r=this.#l(t,r))>=0);return{cont:!1,ins:r+1}}const n=this.#l(t,a);if(i>=3){const{ch:r}=t[n];if(this.#d.test(h)&&r===h)return{cont:!1,ins:n};if(this.#c.test(r)){let c=n;for(;(c=this.#l(t,c))>=0&&this.#c.test(t[c].ch););return{cont:!1,ins:c+1}}}return{cont:!1,ins:a}}}class _ extends B{constructor(t,e,s){super(),this.ctn=t,this.canFocus=e,this.sys=s,this.#t.classList.add("sn_tx"),this.#t.style.position="absolute",_.#e.view.parentElement.appendChild(this.#t),this.addChild(this.#c),this.addChild(this.#d),this.#d.name="grpDbgMasume",this.noticeCompTxt=s.isApp&&_.#i.oCfg.debug.dumpHtm?()=>{mt.noticeCompTxt();const i=this.#t.innerHTML;if(i==="")return;const{fn:a,ln:h}=_.#h.nowScrFnLn(),n=`dumpHtm ${t.name.slice(0,-7).replaceAll(":","=")}(fn=${a} line=${h})`;s.outputFile(s.path_downloads+n+".htm",`<!doctype html><html><head><meta charset=utf-8><title>${n}</title>
<h1>${n}</h1>${i.replaceAll(/ class="sn_ch"|animation-delay: \d+ms; ?| data-add="{&quot;ch_in_style&quot;:&quot;default&quot;, &quot;ch_out_style&quot;:&quot;default&quot;}"/g,"").replaceAll(' style=""',"").replaceAll(/(<\/?ruby>)/g,`
$1
`).replaceAll(/<(br|\/span)>/g,`<$1>
`)}`)}:()=>mt.noticeCompTxt()}static#i;static#e;static init(t,e){_.#i=t,_.#e=e}static#a;static#h;static setEvtMng(t,e){_.#a=t,_.#h=e}static destroy(){_.#S=Object.create(null),_.#B=Object.create(null),_.delBreak()}#t=document.createElement("span");#c=new B;#d=new M;static#g={"background-color":0,"border-bottom-width":0,"border-left-width":0,"border-right-width":0,"border-top-width":0,"margin-bottom":0,"margin-left":0,"margin-right":0,"margin-top":0};#o=new Dt;noticeCompTxt=()=>{};#s={fontsize:24,$width:0,$height:0,pad_left:0,pad_right:0,pad_top:0,pad_bottom:0};lay(t){const e=this.#t.style;if("style"in t)if(t.style){const s=document.createElement("span");s.style.cssText=t.style;const i=s.style.length;for(let a=0;a<i;++a){const h=s.style[a];if(h in _.#g){Q.myTrace(`${h}は指定できません`,"W");continue}e[h]=s.style[h]}!s.style.opacity&&"alpha"in t&&(e.opacity=String(this.ctn.alpha))}else this.#t.style.cssText="";else"alpha"in t&&(e.opacity=String(this.ctn.alpha));if("width"in t&&(e.width=(t.width??"0")+"px"),"height"in t&&(e.height=(t.height??"0")+"px"),"pl"in t&&(e.paddingLeft=(t.pl??"0")+"px"),"pr"in t&&(e.paddingRight=(t.pr??"0")+"px"),"pt"in t&&(e.paddingTop=(t.pt??"0")+"px"),"pb"in t&&(e.paddingBottom=(t.pb??"0")+"px"),this.#o.lay(t),this.#l(),this.#f=this.ctn.position.x,e.transformOrigin=`${this.ctn.pivot.x}px ${this.ctn.pivot.y}px`,this.cvsResize(),e.display=this.ctn.visible?"inline":"none",":redraw"in t&&this.#_>0){const s=[this.#t.innerHTML.replaceAll(/(animation-delay: )\d+ms/g,"$10ms"),`<span class='sn_ch' data-add='{"ch_in_style":"default"}'>&emsp;</span>`];this.#J(),this.goTxt(s,!0)}}#y=0;#l(){const t=this.#t.style,e=parseFloat(t.fontSize||"0");this.#s.fontsize=e,this.#s.pad_left=parseFloat(t.paddingLeft||"0"),this.#s.pad_right=parseFloat(t.paddingRight||"0"),this.#s.pad_top=parseFloat(t.paddingTop||"0"),this.#s.pad_bottom=parseFloat(t.paddingBottom||"0"),this.#s.$width=parseFloat(t.width||"0"),this.#s.$height=parseFloat(t.height||"0"),this.position.set(this.#s.pad_left,this.#s.pad_top),this.#u=t.writingMode==="vertical-rl",this.#p=0,this.#v=0;const s=t.lineHeight??"0";this.#y=this.#u?0:(s.endsWith("px")?parseFloat(s):e*parseFloat(s)-e)/2}cvsResize(){const t=this.#t.style,e=this.sys.cvsScale;t.left=`${this.sys.ofsLeft4elm+this.#f*e}px`,t.top=`${this.sys.ofsTop4elm+this.ctn.position.y*e}px`,t.transform=`rotate(${this.ctn.angle}deg) scale(${this.ctn.scale.x*e}, ${this.ctn.scale.y*e})`}#f=0;#u=!1;get tategaki(){return this.#u}#p=0;#v=0;get infTL(){return this.#s}get getWidth(){return this.#s.$width}get getHeight(){return this.#s.$height}setMySize(t,e){this.#s.$width=t,this.#s.$height=e,this.#t.style.width=this.#s.$width+"px",this.#t.style.height=this.#s.$height+"px"}#r(t,e=!0){const s={escape:d=>d.replaceAll(/([.*+?^${}()|\[\]\/\\])/g,"\\$1"),mimeType:d=>{const p=r(d).toLowerCase();return i()[p]||""},dataAsUrl:u,isDataUrl:c,resolveUrl:g,getAndEncode:l,asArray:d=>{const p=[],y=d.length;for(let m=0;m<y;++m)p.push(d[m]);return p}};function i(){const d="application/font-woff",p="image/jpeg";return{woff:d,woff2:d,ttf:"application/font-truetype",eot:"application/vnd.ms-fontobject",png:"image/png",jpg:p,jpeg:p,gif:"image/gif",tiff:"image/tiff",svg:"image/svg+xml"}}const a=f(),h=o();function n(d){return h.resolveAll().then(p=>{const y=document.createElement("style");return d.appendChild(y),y.appendChild(document.createTextNode(p)),d})}function r(d){return/\.([^\.\/]*?)$/g.exec(d)?.[1]??""}function c(d){return d.search(/^(data:)/)!==-1}function g(d,p){const y=document.implementation.createHTMLDocument(),m=y.createElement("base");y.head.appendChild(m);const C=y.createElement("a");return y.body.appendChild(C),m.href=p,C.href=d,C.href}function l(d){let p=3e4;return new Promise(function(y){const m=new XMLHttpRequest;m.onreadystatechange=C,m.ontimeout=x,m.responseType="blob",m.timeout=p,m.open("GET",d,!0),m.send();function C(){if(m.readyState!==4)return;if(m.status!==200){k("cannot fetch resource: "+d+", status: "+m.status);return}const S=new FileReader;S.onloadend=function(){const N=S.result.toString().split(/,/)[1];y(N)},S.readAsDataURL(m.response)}function x(){k("timeout of "+p+"ms occured while fetching resource: "+d)}function k(S){console.error(S),y("")}})}function u(d,p){return"data:"+p+";base64,"+d}function f(){const d=/url\(['"]?([^'"]+?)['"]?\)/g;return{inlineAll:C,shouldProcess:p};function p(x){return x.search(d)!==-1}function y(x){const k=[];let S;for(;S=d.exec(x);)k.push(S[1]);return k.filter(function(N){return!s.isDataUrl(N)})}function m(x,k,S,N){return Promise.resolve(k).then(R=>S?s.resolveUrl(R,S):R).then(N||s.getAndEncode).then(R=>s.dataAsUrl(R,s.mimeType(k))).then(R=>x.replace(A(k),"$1"+R+"$3"));function A(R){return new RegExp(`(url\\(['"]?)(`+s.escape(R)+`)(['"]?\\))`,"g")}}function C(x,k,S){if(N())return Promise.resolve(x);return Promise.resolve(x).then(y).then(A=>{let R=Promise.resolve(x);for(const j of A)R=R.then(nt=>m(nt,j,k,S));return R});function N(){return!p(x)}}}function o(){return{resolveAll:d,impl:{readAll:p}};function d(){return p().then(y=>Promise.allSettled(y.map(m=>m.resolve()))).then(y=>y.join(`
`))}function p(){return Promise.resolve(s.asArray(document.styleSheets)).then(m).then(y).then(x=>x.map(C));function y(x){return x.filter(k=>k.type===CSSRule.FONT_FACE_RULE).filter(k=>a.shouldProcess(k.style.getPropertyValue("src")))}function m(x){const k=[];for(const S of x)try{if(S.href)continue;s.asArray(S.cssRules||[]).forEach(k.push.bind(k))}catch(N){console.error("Error while reading CSS rules from "+S.href,String(N))}return k}function C(x){return{resolve:function(){const k=(x.parentStyleSheet||{}).href;return a.inlineAll(x.cssText,k)},src:function(){return x.style.getPropertyValue("src")}}}}}Promise.resolve(this.#t).then(d=>{const p=d.cloneNode(!0);return p.style.padding="0px",p.style.paddingRight=this.#p+"px",p.style.paddingTop=this.#v+"px",p.style.left="0px",p.style.top="0px",p.style.width=this.#s.$width-this.#s.pad_left-this.#s.pad_right+"px",p.style.height=this.#s.$height-this.#s.pad_top-this.#s.pad_bottom+"px",this.#t.hidden=e,p}).then(n).then(d=>{d.setAttribute("xmlns","http://www.w3.org/1999/xhtml");const p=new Image;return p.src=`data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" width="${this.#s.$width}px" height="${this.#s.$height}px"><foreignObject x="0" y="0" width="100%" height="100%">${new XMLSerializer().serializeToString(d).replaceAll("#","%23").replaceAll(`
`,"%0A")}</foreignObject></svg>`,new Promise(y=>p.onload=()=>y(p))}).then(d=>new Promise(p=>setTimeout(()=>p(d),100))).then(d=>{const p=document.createElement("canvas");p.width=this.#s.$width,p.height=this.#s.$height,p.getContext("2d").drawImage(d,0,0),t(D.from(p))}).catch(d=>Q.myTrace(`goTxt() = ${d}`))}#L=[];goTxt(t,e){const s=()=>this.#T(t,e);this.#L.push(s)===1&&s()}#$=[];#_=0;static#n="<span class='sn_ch sn_ch_last'>&emsp;</span>";#T(t,e){_.#F.visible=!1;let s=this.#$.length,i="";if(s===0){if(_.#i.oCfg.debug.masume&&(T.debugLog&&console.log(`🍌 masume ${this.name} v:${this.visible} l:${this.x} t:${this.y} a:${this.alpha} pl:${this.#s.pad_left} pr:${this.#s.pad_right} pt:${this.#s.pad_top} pb:${this.#s.pad_bottom} w:${this.#s.$width} h:${this.#s.$height}`),this.#d.clear().beginFill(3407616,.2).lineStyle(1,3407616,1).drawRect(-this.#s.pad_left,-this.#s.pad_top,this.#s.$width,this.#s.$height).endFill().beginFill(13311,.2).lineStyle(2,13311,1).drawRect(0,0,this.#s.$width-this.#s.pad_left-this.#s.pad_right,this.#s.$height-this.#s.pad_top-this.#s.pad_bottom).endFill()),this.#t.innerHTML=[...t].join("").replaceAll(/[\n\t]/g,"")+_.#n,!this.#o.break_fixed){const y=globalThis.getComputedStyle(this.#t),m=parseFloat(y.fontSize);this.#u?(this.#o.break_fixed_left=(this.#s.$width-this.#s.pad_left-this.#s.pad_right-m*1.5)*this.sys.cvsScale,this.#o.break_fixed_top=0):(this.#o.break_fixed_left=0,this.#o.break_fixed_top=m/2*this.sys.cvsScale)}}else i=this.#t.innerHTML,--s,this.#t.getElementsByClassName("sn_ch_last").item(0)?.remove(),this.#t.querySelectorAll(":scope > br").forEach(y=>y.remove()),this.#t.insertAdjacentHTML("beforeend",t.slice(this.#_).join("").replaceAll(/[\n\t]/g,"")+_.#n);this.#t.querySelectorAll(".sn_ch:has(> ruby)").forEach(y=>y.style.background=""),this.#_=t.length;const a=this.sys.cvsScale,h=this.#t.getBoundingClientRect(),n=h.left+this.#s.pad_left,r=h.top+this.#s.pad_top;let c;if(a===1)c=(y,m)=>{const C=y.getBoundingClientRect();return new z(C.left-n,C.top-r,C.width,C.height+("gjqy".includes(m)?this.#y:0))};else{const y=this.sys.ofsPadLeft_Dom2PIXI+h.left*(1-a),m=this.sys.ofsPadTop_Dom2PIXI+h.top*(1-a);c=(C,x)=>{const k=C.getBoundingClientRect();return new z((k.left-y)/a-n,(k.top-m)/a-r,k.width/a,(k.height+("gjqy".includes(x)?this.#y:0))/a)}}const[g,l]=this.#o.hyph(this.#t,c,this.#u,s,i);this.#$=g;const u=T.debugLog?({ch:y},{x:m,y:C,width:x,height:k})=>console.log(`🍌 masume ch:${y} x:${m} y:${C} w:${x} h:${k}`):()=>{},f=_.#i.oCfg.debug.masume?(y,m)=>{u(y,m),this.#d.beginFill(6737151,.5).lineStyle(2,16724736,1).drawRect(m.x,m.y,m.width,m.height).endFill()}:()=>{},o=F.ease(this.#C);for(let y=s;y<l;++y){const m=this.#$[y],C=m.rect,x=JSON.parse(m.elm.dataset.arg??'{"delay": 0}'),k=JSON.parse(m.elm.dataset.add??"{}"),S=_.#S[k.ch_in_style];if(f(m,C),m.elm.dataset.cmd==="grp"){const N=new B;this.#c.addChild(N),new b(x.pic,N,A=>{this.#M(N,x,k,C,o,S??{}),N.parent||N.removeChild(A)})}if(m.elm.dataset.lnk){const N=m.elm.parentElement.closest("[data-arg]"),A=JSON.parse(N.dataset.arg??"{}");A.key=`lnk=[${y}] `+this.name;const R=new P;this.#M(R,A,k,C,o,S??{});const j=A.style??"",nt=j+(A.style_hover??""),_t=j+(A.style_clicked??""),Z=A.r_style??"",kt=Z+(A.r_style_hover??""),$t=Z+(A.r_style_clicked??""),ft=Array.from(N.getElementsByTagName("rt"));for(const et of ft)et.dataset.st_r_bk=et.style.cssText;const Ct=N.style.cssText,tt=(et,Tt)=>{N.style.cssText=Ct+et;for(const pt of ft)pt.style.cssText=pt.dataset.st_r_bk+Tt};E(A,"enabled",!0)?_.#a.button(A,R,()=>tt(j,Z),()=>this.canFocus()?(tt(nt,kt),!0):!1,()=>tt(_t,$t)):tt(j+(A.style_disable??"color: gray;"),Z+(A.r_style_disable??"color: gray;")),this.#c.addChild(R)}}const d=Array.from(this.#t.getElementsByClassName("sn_ch_yet"));this.#k=()=>{this.#k=()=>!1;for(const m of d)m.className="sn_ch";_.#F.position.set(this.#o.break_fixed_left,this.#o.break_fixed_top),_.#F.visible=!0,this.noticeCompTxt();const y=this.#L.shift();return this.#L.length>0&&y(),!0};for(const y of d)y.className=y.className.replace("sn_ch_yet sn","go");s>0&&++s;let p;for(let y=l-2;y>=0;--y){const{elm:m}=this.#$[y];if(m.tagName==="SPAN"){p=m.parentElement?.tagName==="RUBY"?m.parentElement.parentElement??m:m;break}}if(!p||e||s===l){this.#k();return}p.addEventListener("animationend",()=>this.#k(),{once:!0})}#k=()=>!1;#M(t,e,s,i,a,h){t.alpha=0,e.x&&(i.x=e.x.startsWith("=")?i.x+parseInt(e.x.slice(1)):parseInt(e.x)),e.y&&(i.y=e.y.startsWith("=")?i.y+parseInt(e.y.slice(1)):parseInt(e.y)),e.width&&(i.width=parseInt(e.width)),e.height&&(i.height=parseInt(e.height)),e.wait&&(h.wait=parseInt(e.wait)),t.width=i.width,t.height=i.height,h.x?t.position.set(h.x.startsWith("=")?i.x+t.width*h.nx:h.nx,h.y.startsWith("=")?i.y+t.height*h.ny:h.ny):t.position.set(i.x,i.y);const n={sp:t,tw:new Bt(t).to({alpha:1,x:i.x,y:i.y,width:i.width,height:i.height,angle:0},h.wait??0).easing(a).delay((s.wait??0)+(e.delay??0)).onComplete(()=>{n.tw=void 0}).start()};this.#I.push(n)}#I=[];skipChIn(){let t=this.#k();for(const e of this.#I)e.tw&&(e.tw.stop().end(),t=!0);return this.#I=[],t}static#S=Object.create(null);static#z=/[{\s\.,*\{]/;static initChStyle(){_.#S=Object.create(null),_.#B=Object.create(null)}static getChInStyle(t){return _.#S[t]}static ch_in_style(t){const{name:e}=t;if(!e)throw"nameは必須です";if(_.#z.test(e))throw`name【${e}】に使えない文字が含まれます`;if(e in _.#S)throw`name【${e}】はすでにあります`;const s=String(t.x??"=0"),i=String(t.y??"=0");return _.#S[e]={wait:v(t,"wait",500),alpha:v(t,"alpha",0),x:s,y:i,nx:parseFloat(s.at(0)==="="?s.slice(1):s),ny:parseFloat(i.at(0)==="="?i.slice(1):i),scale_x:v(t,"scale_x",1),scale_y:v(t,"scale_y",1),rotate:v(t,"rotate",0),join:E(t,"join",!0),ease:t.ease??"ease-out"}}static#B=Object.create(null);static getChOutStyle(t){return _.#B[t]}static ch_out_style(t){const{name:e}=t;if(!e)throw"nameは必須です";if(_.#z.test(e))throw`name【${e}】に使えない文字が含まれます`;if(e in _.#B)throw`name【${e}】はすでにあります`;const s=String(t.x??"=0"),i=String(t.y??"=0");return _.#B[e]={wait:v(t,"wait",500),alpha:v(t,"alpha",0),x:s,y:i,nx:parseFloat(s.at(0)==="="?s.slice(1):s),ny:parseFloat(i.at(0)==="="?i.slice(1):i),scale_x:v(t,"scale_x",1),scale_y:v(t,"scale_y",1),rotate:v(t,"rotate",0),join:E(t,"join",!1),ease:t.ease??"ease-out"}}static#F=new B;static#P=new b;dispBreak(t){_.delBreak();const e=_.#F;e.visible=!1,this.addChild(e),_.#P.destroy(),_.#P=new b(t.pic,e,s=>{e.parent?(s.x=v(t,"x",0),s.y=v(t,"y",0),s.width=v(t,"width",this.#s.fontsize),s.height=v(t,"height",this.#s.fontsize)):e.removeChild(s)})}static delBreak(){const t=_.#F;t.parent?.removeChild(t),_.#P.destroy()}#C="Quadratic.Out";#m="Quadratic.Out";#J(){this.#d.clear(),this.#$=[],this.#_=0,this.#L=[],this.skipChIn();const t=this.#t.cloneNode(!0);t.textContent="";const e=this.#t;e.parentElement.insertBefore(t,e);let s=0;Array.from(e.getElementsByClassName("sn_ch")).forEach(a=>{const h=JSON.parse(a.dataset.add??a.children[0]?.getAttribute("data-add")??a.children[0]?.children[0]?.getAttribute("data-add")??"{}");if(!h.ch_out_style)return;const n=_.#B[h.ch_out_style];if(n){if(n.wait===0){a.style.display="none";return}s+=n.wait,n.join||(a.style.animationDelay="0ms"),a.classList.add(`go_ch_out_${h.ch_out_style}`)}});const i=()=>{e.parentElement.removeChild(e);for(const a of this.#c.removeChildren())a instanceof B&&_.#a.unButton(a),a.destroy()};s===0?(this.#t.textContent="",i()):e.lastElementChild?.addEventListener("animationend",i,{once:!0}),this.#t=t}reNew(){this.#J();const t=new _(this.ctn,()=>this.canFocus(),this.sys);return t.#s=this.#s,t.#t.style.cssText=this.#t.style.cssText,t.#f=this.#f,t.name=this.name,t.#l(),t.#b=this.#b,t.#C=this.#C,t.#m=this.#m,this.#o.reNew(t.#o),this.destroy(),t}#b=void 0;record(){return{infTL:this.#s,cssText:this.#t.style.cssText,left:this.#f,ch_filter:this.#b,fi_easing:this.#C,fo_easing:this.#m,hyph:this.#o.record()}}playback(t){this.#s=t.infTL,this.position.set(this.#s.pad_left,this.#s.pad_top),this.#t.style.cssText=t.cssText,this.#f=t.left,this.#l(),this.#b=t.ch_filter,this.#C=t.fi_easing,this.#m=t.fo_easing,this.#o.playback(t.hyph)}get cssText(){return this.#t.style.cssText}set cssText(t){this.#t.style.cssText=t}#x=void 0;snapshot(t,e){this.#r(s=>{this.#x=P.from(s),this.#u&&(this.#x.x+=T.stageW-(this.#f+this.#s.$width)),this.#x.y-=this.#v,this.#x.texture.frame=new z(0,0,Math.min(this.#x.width,this.#s.$width-this.#f),Math.min(this.#x.height,this.#s.$height)),this.#c.addChild(this.#x),t.render(this.#x,{clear:!1}),e()},!1)}snapshot_end(){this.#x&&(this.#c.removeChild(this.#x),this.#x=void 0)}makeDesignCast(t){}showDesignCast(){}dump(){const t=[],e=this.#t.style,s=e.length;for(let i=0;i<s;++i){const a=e[i];t.push(`"${a}":"${e[a].replaceAll(/(["\\])/g,"\\$1")}"`)}return`"txt":"${this.#t.textContent.replaceAll(/(["\\])/g,"\\$1")}", "style":{${t.join(",")}}`}destroy(){_.delBreak(),this.#t.parentElement.removeChild(this.#t),this.removeChild(this.#c),this.removeChild(this.#d),super.destroy()}}class V extends B{constructor(t,e,s,i){if(super(),this.hArg=t,this.evtMng=e,this.resolve=s,this.canFocus=i,this.#t={type:"pic",enabled:E(t,"enabled",!0),x:this.x=W(t.left??0),y:this.y=W(t.top??0),rotation:this.angle=v(t,"rotation",this.angle),pivot_x:this.pivot.x=v(t,"pivot_x",this.pivot.x),pivot_y:this.pivot.y=v(t,"pivot_y",this.pivot.y),scale_x:this.scale.x=v(t,"scale_x",this.scale.x),scale_y:this.scale.y=v(t,"scale_y",this.scale.y),alpha:1,text:"",b_pic:"",width:0,height:0},this.getBtnBounds=()=>(this.#a.x=this.#t.x,this.#a.y=this.#t.y,this.#a),this.#t.enabled&&e.button(t,this,()=>this.normal(),()=>this.#d(),()=>this.#g()),t.pic){this.#t.type="pic",this.#h=new b(t.pic,this,l=>{this.#o(l),this.#a.width=l.width*this.#t.scale_x,this.#a.height=l.height*this.#t.scale_y},l=>s);return}if(!t.text)throw"textまたはpic属性は必須です";const a=v(t,"height",30),h=new St({align:"center",dropShadow:!0,dropShadowAlpha:.7,dropShadowColor:"white",dropShadowBlur:7,dropShadowDistance:0,fill:this.#t.enabled?"black":"gray",fontFamily:V.fontFamily,fontSize:a,padding:5});if(t.style)try{const l=JSON.parse(t.style);for(const[u,f]of Object.entries(l))h[u]=f;this.#t={...this.#t,...l}}catch(l){throw l instanceof SyntaxError?new Error(ht(t,"style",l.message)):"fn:Button.ts style"}const n=new Nt(t.text??"",h);n.alpha=v(t,"alpha",n.alpha),n.width=v(t,"width",100),n.height=t.height=a,this.setText=l=>n.text=l,this.#t={...this.#t,type:"text",alpha:n.alpha,text:n.text,width:n.width,height:n.height};let r=!1;if(this.#t.width=this.width,this.#t.height=this.height,t.b_pic&&(this.#t.b_pic=t.b_pic,this.#h=new b(t.b_pic,this,l=>{this.#c(l,n),this.#t.width=this.width,this.#t.height=this.height,n.name=JSON.stringify(this.#t)},l=>{L.setBlendmode(this,t),l&&s()}),r=this.#h.ret),n.name=JSON.stringify(this.#t),this.addChild(n),this.#a.width=n.width,this.#a.height=n.height,t.b_pic||L.setBlendmode(this,t),V.#i(this,n),!this.#t.enabled){r||s();return}const c=h.clone();if(t.style_hover)try{const l=JSON.parse(t.style_hover);for(const[u,f]of Object.entries(l))c[u]=f}catch(l){throw l instanceof SyntaxError?new Error(ht(t,"style_hover",l.message)):"fn:Button.ts style_hover"}else c.fill="white";const g=c.clone();if(t.style_clicked)try{const l=JSON.parse(t.style_clicked);for(const[u,f]of Object.entries(l))g[u]=f}catch(l){throw l instanceof SyntaxError?new Error(ht(t,"style_clicked",l.message)):"fn:Button.ts style_clicked"}else g.dropShadow=!1;this.normal=()=>n.style=h,this.#d=()=>i()?(n.style=c,!0):!1,this.#g=()=>n.style=g,r||s()}static fontFamily="'Hiragino Sans', 'Hiragino Kaku Gothic ProN', '游ゴシック Medium', meiryo, sans-serif";static#i=(t,e)=>{};static#e=(t,e,s,i)=>{};static init(t){t.oCfg.debug.masume&&(V.#i=(e,s)=>e.addChild(new M().beginFill(8926088,.2).lineStyle(1,8926088,1).drawRect(s.x,s.y,s.width,s.height).endFill()),V.#e=(e,s,i,a)=>e.addChild(new M().beginFill(8926088,.2).lineStyle(1,8926088,1).drawRect(s.x,s.y,i,a).endFill()))}setText(t){}getBtnBounds=()=>this.#a;#a=new z;#h=new b;#t;destroy(){this.evtMng.unButton(this),this.#h.destroy(),super.destroy()}makeDesignCast(t){}showDesignCast(){}cvsResize(){}#c(t,e){this.setChildIndex(t,0),t.alpha=e.alpha,t.setTransform(e.x,e.y,1,1,e.rotation,0,0,(t.width-e.width)/2,(t.height-e.height)/2),t.name=e.name}normal=()=>{};#d=()=>!1;#g=()=>{};#o(t){this.#t.alpha=t.alpha=v(this.hArg,"alpha",t.alpha);const e=t.width/3,s=this.#t.enabled?e:t.width,i=t.height,a=t.texture.baseTexture,h=new D(a,new z(0,0,e,i)),n=new D(a,new z(e,0,e,i)),r=new D(a,new z(e*2,0,e,i)),c=()=>t.texture=h;this.#t.enabled&&c(),this.normal=c,this.#d=()=>this.canFocus()?(t.texture=r,!0):!1,this.#g=()=>t.texture=n,"width"in this.hArg?(this.#t.width=W(this.hArg.width),this.scale.x*=this.#t.width/s):this.#t.width=s,"height"in this.hArg?(this.#t.height=W(this.hArg.height),this.scale.y*=this.#t.height/i):this.#t.height=i,t.name=JSON.stringify(this.#t),V.#e(this,t,s,i)}}class w extends L{static#i;static#e;static#a;static#h;static init(t,e,s,i,a,h){w.#i=t,_.init(t,h),w.#e=s,w.#h=i,w.#a=a,s.setDoRecProc(w.chgDoRec),e.autowc=n=>w.#y(n),e.autowc({enabled:!1,text:"",time:0}),e.ch_in_style=n=>w.#t(n),e.ch_out_style=n=>w.#c(n),_.initChStyle(),Et(),st(t.matchPath(".+",X.FONT).flatMap(n=>Object.values(n).map(r=>`
@font-face {
	font-family: '${r}';
	src: url('${this.#i.searchPath(r,X.FONT)}');
}
`)).join("")+`
.sn_tx {
	pointer-events: none;
	user-select: none;
	-webkit-touch-callout: none;
	box-sizing: border-box;
}
.sn_ch {
	position: relative;
	display: inline-block;
}
`),w.#t({name:"default",wait:500,alpha:0,x:"=0.3",y:"=0",scale_x:1,scale_y:1,rotate:0,join:!0,ease:"ease-out"}),w.#c({name:"default",wait:0,alpha:0,x:"=0",y:"=0",scale_x:1,scale_y:1,rotate:0,join:!1,ease:"ease-out"})}static#t(t){const e=_.ch_in_style(t),s=e.x.startsWith("=")?`${e.nx*100}%`:`${e.nx}px`,i=e.y.startsWith("=")?`${e.ny*100}%`:`${e.ny}px`,{name:a}=t;return st(`
.sn_ch_in_${a} {
	position: relative;
	display: inline-block;
}
.go_ch_in_${a} {
	opacity: ${e.alpha};
	position: relative;
	display: inline-block;
	animation: sn_ch_in_${a} ${e.wait}ms ${e.ease} 0s both;
}
@keyframes sn_ch_in_${a} {
	from {transform: rotate(${e.rotate}deg) scale(${e.scale_x}, ${e.scale_y}) translate(${s}, ${i})}
	to {opacity: 1; transform: none;}
}
`),!1}static#c(t){const e=_.ch_out_style(t),s=e.x.startsWith("=")?`${e.nx*100}%`:`${e.nx}px`,i=e.y.startsWith("=")?`${e.ny*100}%`:`${e.ny}px`,{name:a}=t;return st(`
.go_ch_out_${a} {
	position: relative;
	display: inline-block;
	animation: go_ch_out_${a} ${e.wait}ms ${e.ease} 0s both;
}
@keyframes go_ch_out_${a} {
	to {
		opacity: ${e.alpha};
		transform: rotate(${e.rotate}deg) scale(${e.scale_x}, ${e.scale_y}) translate(${s}, ${i});
	}
`),!1}static#d;static#g;static setEvtMng(t,e,s){w.#d=t,w.#g=e,_.setEvtMng(t,s)}static#o=!1;static#s={};static#y(t){w.#o=E(t,"enabled",w.#o),w.#e.setVal_Nochk("save","const.sn.autowc.enabled",w.#o);const{text:e}=t;if("text"in t!="time"in t)throw"[autowc] textとtimeは同時指定必須です";if(w.#e.setVal_Nochk("save","const.sn.autowc.text",e),!e)return w.#e.setVal_Nochk("save","const.sn.autowc.time",""),!1;const s=e.length;if(w.#o&&s===0)throw'[autowc] enabled === false かつ text === "" は許されません';const i=String(t.time).split(",");if(i.length!==s)throw"[autowc] text文字数とtimeに記述された待ち時間（コンマ区切り）は同数にして下さい";w.#s={};for(let a=0;a<s;++a)w.#s[e[a]]=W(i[a]);return w.#e.setVal_Nochk("save","const.sn.autowc.time",t.time),!1}#l=0;#f=0;#u=!1;#p=void 0;#v="";#r=new _(this.ctn,()=>this.canFocus(),w.#g);#L=new lt;#$=document.createElement("span");static#_={"text-align":0,"text-align-last":0,height:0,width:0,"padding-left":0,"padding-right":0,"padding-top":0,"padding-bottom":0};#n=new B;constructor(){super(),this.ctn.addChild(this.#r),this.#L.init(this.#X),this.ctn.addChild(this.#n),this.#n.name="cntBtn",this.lay({style:`width: ${T.stageW}px; height: ${T.stageH}px; font-family: 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', '游ゴシック Medium', meiryo, sans-serif; color: white; font-size: 24px; line-height: 1.5; padding: 16px;`,in_style:"default",out_style:"default",back_clear:"true"})}destroy(){this.#p&&(this.ctn.removeChild(this.#p).destroy(),this.#p=void 0),w.#h.recPagebreak(),this.#r.destroy()}static destroy(){w.#o=!1,w.#s={},w.#b=t=>t}set name(t){this.name_=t,this.#r.name=t}get name(){return this.name_}cvsResize(){this.#r.cvsResize()}cvsResizeChildren(){for(const t of this.#n.children)t.cvsResize()}procSetX(t){this.#r.lay({x:t})}procSetY(t){this.#r.lay({y:t})}lay(t){if(super.lay(t),L.setXY(this.ctn,t,this.ctn),t[":id_tag"]=this.name_.slice(0,-7),lt.setting(t),this.#F(t),this.#r.lay(t),"r_align"in t&&(this.#E=t.r_align??""),this.#x=T.isSafari?this.#r.tategaki?(s,i)=>`text-align: start; height: ${i}em; padding-top: ${s}; padding-bottom: ${s};`:(s,i)=>`text-align: start; width: ${i}em; padding-left: ${s}; padding-right: ${s};`:this.#r.tategaki?s=>`text-align: justify; text-align-last: justify; padding-top: ${s}; padding-bottom: ${s};`:s=>`text-align: justify; text-align-last: justify; padding-left: ${s}; padding-right: ${s};`,T.isFirefox&&(this.#q=this.#Z),"r_style"in t)if(t.r_style){const s=document.createElement("span");s.style.cssText=t.r_style;const i=s.style.length,a=this.#$.style;for(let h=0;h<i;++h){const n=s.style[h];if(n in w.#_){Q.myTrace(`${n}は指定できません`,"W");continue}const r=s.style[n];r&&(a[n]=r)}}else this.#$.style.cssText="";if("alpha"in t)for(const s of this.#n.children)s.alpha=this.ctn.alpha;this.#T(t),this.#I(t);const e=this.#B(t,s=>{s&&J()});return e&&q(),e}#T(t){const{in_style:e}=t;if(!e)return;const s=_.getChInStyle(e);if(!s)throw`存在しないin_style【${e}】です`;this.#k=e,this.#M=s.join}#k="";#M=!0;get width(){return this.#r.getWidth}get height(){return this.#r.getHeight}#I(t){const{out_style:e}=t;if(e){if(!_.getChOutStyle(e))throw`存在しないout_style【${e}】です`;this.#S=e}}#S="";#z=new b;#B(t,e){if("back_clear"in t)return E(t,"back_clear",!1)&&(this.#l=0,this.#f=0,this.#u=!1,this.#v=""),e(!1),!1;this.#f=v(t,"b_alpha",this.#f),this.#u=E(t,"b_alpha_isfixed",this.#u);const s=(this.#u?1:Number(w.#e.getVal("sys:TextLayer.Back.Alpha")))*this.#f;if(t.b_pic){if(this.#v!==t.b_pic)return this.#v=t.b_pic,this.#p&&(this.ctn.removeChild(this.#p),this.#p.destroy()),this.#z=new b(this.#v,this.ctn,i=>{this.#p=i,i.name="back(pic)",i.visible=s>0,i.alpha=s,this.#r.setMySize(i.width,i.height),this.ctn.setChildIndex(i,0),e(!0)}),this.#z.ret}else"b_color"in t&&(this.#l=bt(t,"b_color",0),this.#p&&(this.ctn.removeChild(this.#p),this.#p.destroy()),this.#v="",this.ctn.addChildAt((this.#p=new M).beginFill(this.#l).lineStyle(void 0).drawRect(0,0,this.#r.getWidth,this.#r.getHeight).endFill(),0),this.#p.name="back(color)");return this.#p&&(this.#p.visible=s>0,this.#p.alpha=s),e(!1),!1}chgBackAlpha(t){const e=this.#u?this.#f:t*this.#f;this.#p instanceof M&&(this.#p&&(this.ctn.removeChild(this.#p),this.#p.destroy()),this.ctn.addChildAt((this.#p=new M).beginFill(this.#l).lineStyle(void 0).drawRect(0,0,this.#r.getWidth,this.#r.getHeight).endFill(),0),this.#p.name="back(color)"),this.#p&&(this.#p.visible=e>0,this.#p.alpha=e)}#F(t){"noffs"in t&&(this.#m=t.noffs??"",this.#J=new RegExp(`[　${this.#m}]`)),"ffs"in t&&(this.#P??="",this.#C=this.#P===""?()=>"":e=>this.#J.test(e)?"":` font-feature-settings: ${this.#P};`)}#P="";#C=t=>"";#m="";#J=/[　]/;static chgDoRec(t){w.#b=t?e=>e:e=>`<span class='offrec'>${e}</span>`}static#b=t=>t;isCur=!1;#x=()=>"";#q=(t,e,s,i="")=>{if(!s)return` style='${i}'`;const a=t.length*2;if(a-e.length<0)return` style='text-align: ${s}; ${i}'`;let h="";switch(s){case"justify":h=this.#x("0",a);break;case"121":h=this.#x(`calc(${(a-e.length)/(e.length*2)}em)`,a);break;case"even":h=this.#x(`calc(${(a-e.length)/(e.length+1)}em)`,a);break;case"1ruby":h=this.#x("1em",a);break;default:h=`text-align: ${s};`}return` style='${h} ${i}'`};#E="";#Z(t,e,s,i=""){if(!s)return` style='${i}'`;const a=t.length*2;if(a-e.length<0)return` style='text-align: ${s}; ${i}'`;let h="";switch(s){case"left":h="ruby-align: start;";break;case"center":h="ruby-align: center;";break;case"right":h="ruby-align: start;";break;case"justify":h="ruby-align: space-between;";break;case"121":h="ruby-align: space-around;";break;case"even":const n=(a-e.length)/(e.length+1);h="ruby-align: space-between; "+(this.#r.tategaki?`padding-top: ${n}em; padding-bottom: ${n}em;`:`padding-left: ${n}em; padding-right: ${n}em;`);break;case"1ruby":h="ruby-align: space-between; "+(this.#r.tategaki?"padding-top: 1em; padding-bottom: 1em;":"padding-left: 1em; padding-right: 1em;");break;default:h=`text-align: ${s};`}return` style='${h} ${i}'`}tagCh(t){this.#L.putTxt(t)}#O=!1;#X=(t,e)=>{w.#i.oCfg.debug.putCh&&console.log(`🖊 文字表示 text:\`${t}\`(${t.charCodeAt(0).toString(16)}) ruby:\`${e}\` name:\`${this.name_}\``);const s=e.split("｜");let i="";const[a,...h]=s,n=h.join("｜");switch(s.length){case 1:if(this.#O=!0,t===`
`){this.#A?(this.#A=!1,i="<ruby>&emsp;<rt>&emsp;</rt></ruby><br/>"):i="<br/>";break}this.#A&&(this.#A=!1,e===""&&(e="&emsp;")),i=this.#G(t,e,this.#E);break;default:switch(a){case"start":case"left":case"center":case"right":case"justify":case"121":case"even":case"1ruby":this.#A=!1,this.#O=!0,i=this.#G(t,n,a);break;case"gotxt":this.#Y(),this.#O?(this.isCur&&w.#h.recText(this.#N.join("").replace(/^<ruby>&emsp;<rt>&emsp;<\/rt><\/ruby>(<br\/>)+/,"").replaceAll(/style='(anim\S+ [^;]+;\s*)+/g,"style='").replaceAll(/( style=''| data-(add|arg|cmd)='[^']+'|\n+|\t+)/g,"").replaceAll(/class='sn_ch[^']+/g,"class='sn_ch").replaceAll("display: none;","").replaceAll("class='offrec'","style='display: none;'")),this.#r.goTxt(this.#N,this.#V===0),this.#O=!1,this.#V=0):this.isCur&&this.#r.noticeCompTxt();return;case"add":{const r=JSON.parse(n),{style:c="",wait:g=null}=r,{cl:l,sty:u}=this.#H(!0,g);this.#N.push(`<span${l} style='${u} display: inline; ${c}'>`),delete r.style,this.#K(r)}return;case"add_close":this.#N.push("</span>"),this.#Y();return;case"grp":this.#O=!0;{const r=JSON.parse(n);if(r.id??=this.#N.length,r.id==="break"){this.#r.dispBreak(r);return}this.#A=!1,r.delay=this.#V,r.r??="",r.style??="",r.r_style??="";const{cl:c,sty:g,lnk:l}=this.#H(!0,r.wait);i=`<span${c} style='${g} ${r.style}'><ruby><span data-cmd='grp' data-arg='${JSON.stringify(r)}'${l} style='${g} display: inline;'>&emsp;</span><rt${l}${this.#q("　",r.r,this.#E,this.#$.style.cssText+(this.#w.at(-1)?.o.r_style??"")+r.r_style)}>${r.r}</rt></ruby></span>`}break;case"tcy":this.#A=!1,this.#O=!0;{const{t:r,r:c="",wait:g=null,style:l="",r_style:u=""}=JSON.parse(n);w.#e.doRecLog()&&(this.#j+=t+(e?`《${e}》`:""),this.#D+=r);const f=T.isSafari?c.replaceAll(/[A-Za-z0-9]/g,y=>String.fromCharCode(y.charCodeAt(0)+65248)):c,{cl:o,sty:d,lnk:p}=this.#H(!0,g);i=`<span${o} style='${d}${this.#C(r)} ${l}'><ruby><span${p} style='${d} display: inline; text-combine-upright: all;'>${r}</span><rt${p}${this.#q(r,f,this.#E,this.#$.style.cssText+(this.#w.at(-1)?.o.r_style??"")+u)}>${f}</rt></ruby></span>`}break;case"del":_.delBreak();return;case"span":this.#O=!0,this.#Q(JSON.parse(n));return;case"link":this.#O=!0;{const r=JSON.parse(n);r[":link"]=" data-lnk='@'";const{cl:c,sty:g,curpos:l}=this.#H(!1,r.wait);this.#N.push(`<span${c} style='${g} display: inline; ${r.style??""}' ${l} data-arg='${n}'>`),delete r.style,this.#Q(r)}return;case"endlink":this.#O=!0,this.#N.push("</span>"),this.#Y();return;default:this.#O=!0,i=this.#G(t,e,this.#E)}break}this.#N.push(w.#b(i))};#G(t,e,s){const i=t===" "?"&nbsp;":t==="　"?"&emsp;":t;w.#e.doRecLog()&&(this.#j+=i+(e?`《${e}》`:""),t!==" "&&(this.#D+=t));const{cl:a,sty:h,lnk:n}=this.#H(!0,null,t);return e?`<span${a} style='${h} ${this.#C(t)}'><ruby>${Array.from(t).map((r,c)=>`<span${a}${n} style='${c>0?this.#H(!0,null,t).sty:h} display: inline;'>${r===" "?"&nbsp;":r==="　"?"&emsp;":r}</span>`).join("")}<rt${n}${this.#q(t,e,s,this.#$.style.cssText+(this.#w.at(-1)?.o.r_style??""))}>${e}</rt></ruby></span>`:`<span${a} style='${h} ${this.#C(t)}'${n}>${i}</span>`}#H(t,e,s=`
`){const i=this.#M?e??this.#w.at(0)?.o.wait??(w.#o?w.#s[s.at(0)??""]??0:H.msecChWait):0;w.#d.isSkipping?this.#V=0:t&&this.#M&&(this.#V+=Number(i));const a=`data-add='{"ch_in_style":"${this.#k}", "ch_out_style":"${this.#S}"}'`;return{cl:` class='sn_ch sn_ch_yet sn_ch_in_${this.#k}'`,sty:`animation-delay: ${this.#V}ms;${this.#w.at(-1)?.o.style??""}`,lnk:(this.#w.at(0)?.o[":link"]??"")+" "+a,curpos:a}}#V=0;#A=!0;#N=[];#w=[];#K(t){this.#w.push({o:t,r_align:this.#E,ch_in_style:this.#k,ch_out_style:this.#S}),"r_align"in t&&(this.#E=t.r_align),this.#T(t),this.#I(t)}#Y(){const t=this.#w.pop();t&&(this.#E=t.r_align,this.#T({in_style:t.ch_in_style}),this.#I({out_style:t.ch_out_style}))}#Q(t){const e=this.#w.at(-1);if(!e){this.#K(t);return}e.o={...e.o,...t},!t.style&&!t.r_style&&(e.o.style="",e.o.r_style=""),"r_align"in t&&(this.#E=t.r_align),this.#T(t),this.#I(t)}click=()=>!this.ctn.interactiveChildren||!this.ctn.visible?!1:this.#r.skipChIn();clearText(){this.ctn.addChild(this.#r=this.#r.reNew()),this.#V=0,this.#A=!0,this.#N=[],this.#j="",this.#D="",w.#h.recPagebreak()}#j="";#D="";get pageText(){return this.#j.replace("《&emsp;》","")}get pagePlainText(){return this.#D}get enabled(){return this.ctn.interactiveChildren}set enabled(t){this.ctn.interactiveChildren=t}addButton=t=>new Promise(e=>{t.key=`btn=[${this.#n.children.length}] `+this.name_,t[":id_tag"]=t.key.slice(0,-7),E(t,"hint_tate",this.#r.tategaki);const s=new V(t,w.#d,()=>e(),()=>this.canFocus());s.name=JSON.stringify(t).replaceAll('"',"'"),this.#n.addChild(s)});canFocus(){return(this.ctn.interactiveChildren??!1)&&this.ctn.visible&&w.#a(this)}clearLay(t){super.clearLay(t),this.clearText();for(const e of this.#n.removeChildren())e.destroy()}record=()=>({...super.record(),enabled:this.enabled,r_cssText:this.#$.style.cssText,r_align:this.#E,b_do:this.#p===void 0?void 0:this.#p instanceof P?"Sprite":"Graphics",b_pic:this.#v,b_color:this.#l,b_alpha:this.#f,b_alpha_isfixed:this.#u,ffs:this.#P,txs:this.#r.record(),strNoFFS:this.#m,btns:this.#n.children.map(t=>t.name)});playback(t,e){super.playback(t,e),this.enabled=t.enabled,this.#$.style.cssText=t.r_cssText,this.#E=t.r_align,this.cvsResize(),this.#F(t),this.#r.playback(t.txs),this.#f=t.b_alpha,this.#u=t.b_alpha_isfixed,e=[e,new Promise(s=>{const i=t.b_do?t.b_do==="Sprite"?{b_pic:t.b_pic}:{b_color:t.b_color}:{b_pic:""};i.b_alpha=t.b_alpha,i.b_alpha_isfixed=t.b_alpha_isfixed,this.#B(i,a=>{a&&s()})||s()}),t.btns.map(s=>new Promise(i=>{this.addButton(JSON.parse(s.replaceAll("'",'"'))),i()}))].flat()}get cssText(){return this.#r.cssText}set cssText(t){this.#r.cssText=t}snapshot(t,e){t.render(this.ctn,{clear:!1}),this.#r.snapshot(t,e)}snapshot_end(){this.#r.snapshot_end()}makeDesignCast(t){this.ctn.visible&&this.#r.makeDesignCast(t)}makeDesignCastChildren(t){if(this.ctn.visible)for(const e of this.#n.children)e.makeDesignCast(t)}showDesignCast(){this.#r.showDesignCast()}showDesignCastChildren(){for(const t of this.#n.children)t.showDesignCast()}dump(){return this.#X("","gotxt｜"),super.dump()+`, "enabled":"${this.enabled}", ${this.#r.dump()}, "b_pic":"${this.#v}", "b_color":"${this.#l}", "b_alpha":${this.#f}, "b_alpha_isfixed":"${this.#u}", "width":${this.#r.getWidth}, "height":${this.#r.getHeight}, "pixi_obj":[${this.ctn.children.map(t=>`{"class":"${t instanceof P?"Sprite":t instanceof M?"Graphics":t instanceof B?"Container":"?"}", "name":"${t.name}", "alpha":${t.alpha}, "x":${t.x}, "y":${t.y}, "visible":"${t.visible}"}`).join(",")}], "button":[${this.#n.children.map(t=>t.children[0]?.name??"{}").join(",")}]`}}class ${constructor(t,e,s){this.appPixi=e,this.val=s,t.add_frame=i=>this.#d(i),t.let_frame=i=>this.#f(i),t.set_frame=i=>this.#u(i),t.frame=i=>this.#v(i),t.tsy_frame=i=>this.#r(i)}static#i;static#e;static#a;static init(t,e,s){$.#i=t,$.#e=e,$.#a=s}#h;setEvtMng(t){this.#h=t}#t=Object.create(null);destroy(){for(const t of Object.values(this.#t))t.parentElement.removeChild(t);this.#t=Object.create(null)}hideAllFrame(){for(const[t,{style:e}]of Object.entries(this.#t))this.#c[t]=e.display!=="none",e.display="none"}#c=Object.create(null);restoreAllFrame(){for(const[t,e]of Object.entries(this.#c)){const s=this.#t[t];s&&(s.style.display=e?"inline":"none")}this.#c=Object.create(null)}#d(t){const{id:e,src:s,alpha:i=1,scale_x:a=1,scale_y:h=1,rotate:n=0}=t;if(!e)throw"idは必須です";if(!s)throw"srcは必須です";const r="const.sn.frm."+e;if(this.val.getVal(`tmp:${r}`))throw`frame【${e}】はすでにあります`;const c=E(t,"visible",!0),g=t.b_color?` background-color: ${t.b_color};`:"",l=this.#o(t);$.#a.cvs.insertAdjacentHTML("beforebegin",`<iframe id="${e}" style="opacity: ${i}; ${g} position: absolute; left:${$.#e.ofsLeft4elm+l.x*$.#e.cvsScale}px; top: ${$.#e.ofsTop4elm+l.y*$.#e.cvsScale}px; z-index: 1; border: 0px; overflow: hidden; display: ${c?"inline":"none"}; transform: scale(${a}, ${h}) rotate(${n}deg);" width="${l.width*$.#e.cvsScale}" height="${l.height*$.#e.cvsScale}"></iframe>`),q();const u=$.#i.searchPath(s,X.HTML),f=new U().add({name:s,url:u,xhrType:O.XHR_RESPONSE_TYPE.TEXT});return $.#e.arg.crypto&&f.use(async(o,d)=>{try{o.data=await $.#e.dec(o.extension,o.data)}catch(p){$.#a.errScript(`[add_frame]Html ロード失敗です src:${o.name} ${p}`,!1)}d()}),f.load((o,d)=>{const p=document.getElementById(e);this.#t[e]=p,this.#g[e]=!1;const y=u.lastIndexOf("/")+1,m=u.slice(0,y),C=m.slice(0,y);p.srcdoc=String(d[s]?.data).replace("sn_repRes();","").replaceAll(/\s(?:src|href)=(["'])(\S+?)\1/g,(x,k,S)=>S.startsWith("../")?x.replace("../",C):x.replace("./","").replace(k,k+m)),p.srcdoc.includes("true/*WEBP*/;")&&(p.srcdoc=p.srcdoc.replaceAll(/data-src="(.+?\.)(?:jpe?g|png)/g,(x,k)=>`data-src="${k}webp`)),p.onload=()=>{this.val.setVal_Nochk("tmp",r,!0),this.val.setVal_Nochk("tmp",r+".alpha",i),this.val.setVal_Nochk("tmp",r+".x",l.x),this.val.setVal_Nochk("tmp",r+".y",l.y),this.val.setVal_Nochk("tmp",r+".scale_x",a),this.val.setVal_Nochk("tmp",r+".scale_y",h),this.val.setVal_Nochk("tmp",r+".rotate",n),this.val.setVal_Nochk("tmp",r+".width",l.width),this.val.setVal_Nochk("tmp",r+".height",l.height),this.val.setVal_Nochk("tmp",r+".visible",c);const x=p.contentWindow;this.#h.resvFlameEvent(x),x.sn_repRes?.(k=>$.#s(k.dataset.src??"",k)),J()}}),!0}#g={};getFrmDisabled(t){return this.#g[t]}#o(t){const e={...t},s=$.#e.resolution;return new DOMRect(v(e,"x",0)*s,v(e,"y",0)*s,v(e,"width",T.stageW)*s,v(e,"height",T.stageH)*s)}static#s(t,e,s){const i=this.#l[t];if(i){e.src=i,s&&(e.onload=()=>s(e));return}const a=this.#y[t];if(a){a.push(e);return}this.#y[t]=[e];const[h="",n=""]=t.split("?"),r=$.#i.searchPath(h,X.SP_GSM),c=new U().add({name:t,url:r,xhrType:O.XHR_RESPONSE_TYPE.BUFFER});$.#e.arg.crypto&&r.endsWith(".bin")&&c.use(async(g,l)=>{try{const u=await $.#e.decAB(g.data);if(g.extension!=="bin"){l();return}g.data=u,u instanceof HTMLImageElement&&(g.type=O.TYPE.IMAGE)}catch(u){$.#a.errScript(`FrameMng loadPic ロード失敗です fn:${g.name} ${u}`,!1)}l()}),c.load((g,l)=>{for(const[u,{data:{src:f}}]of Object.entries(l)){const o=this.#l[u]=f+(f.startsWith("blob:")||f.startsWith("data:")?"":n?"?"+n:""),d=this.#y[u];if(d)for(const p of d)p.src=o,s&&(p.onload=()=>s(p));delete this.#y[u]}})}static#y={};static#l={};cvsResize(){for(const[t,e]of Object.entries(this.#t)){const s="const.sn.frm."+t,i=Number(this.val.getVal(s+".x")),a=Number(this.val.getVal(s+".y")),h=Number(this.val.getVal(s+".width")),n=Number(this.val.getVal(s+".height"));e.style.left=`${$.#e.ofsLeft4elm+i*$.#e.cvsScale}px`,e.style.top=`${$.#e.ofsTop4elm+a*$.#e.cvsScale}px`,e.width=String(h*$.#e.cvsScale),e.height=String(n*$.#e.cvsScale)}}#f(t){const{id:e,var_name:s}=t;if(!e)throw"idは必須です";const i=document.getElementById(e);if(!i)throw`id【${e}】はフレームではありません`;const a="const.sn.frm."+e;if(!this.val.getVal(`tmp:${a}`))throw`frame【${e}】が読み込まれていません`;if(!s)throw"var_nameは必須です";const h=i.contentWindow;if(!h.hasOwnProperty(s))throw`frame【${e}】に変数/関数【${s}】がありません。変数は var付きにして下さい`;const n=h[s];return this.val.setVal_Nochk("tmp",a+"."+s,E(t,"function",!1)?n():n),!1}#u(t){const{id:e,var_name:s,text:i}=t;if(!e)throw"idは必須です";const a=document.getElementById(e);if(!a)throw`id【${e}】はフレームではありません`;const h="const.sn.frm."+e;if(!this.val.getVal(`tmp:${h}`))throw`frame【${e}】が読み込まれていません`;if(!s)throw"var_nameは必須です";if(!i)throw"textは必須です";this.val.setVal_Nochk("tmp",h+"."+s,i);const n=a.contentWindow;return n[s]=i,!1}#p=1;#v(t){const{id:e}=t;if(!e)throw"idは必須です";const s=document.getElementById(e);if(!s)throw`id【${e}】はフレームではありません`;const i="const.sn.frm."+e;if(!this.val.getVal("tmp:"+i))throw`frame【${e}】が読み込まれていません`;const a=s.style;if(E(t,"float",!1)?a.zIndex=`${++this.#p}`:"index"in t?a.zIndex=`${v(t,"index",0)}`:t.dive&&(a.zIndex=`-${++this.#p}`),"alpha"in t){const n=a.opacity=String(t.alpha);this.val.setVal_Nochk("tmp",i+".alpha",n)}const h=this.#o(t);if(("x"in t||"y"in t)&&(a.left=`${$.#e.ofsLeft4elm+h.x*$.#e.cvsScale}px`,a.top=`${$.#e.ofsTop4elm+h.y*$.#e.cvsScale}px`,this.val.setVal_Nochk("tmp",i+".x",h.x),this.val.setVal_Nochk("tmp",i+".y",h.y)),"scale_x"in t||"scale_y"in t||"rotate"in t){const n=v(t,"scale_x",1),r=v(t,"scale_y",1),c=v(t,"rotate",0);a.transform=`scale(${n}, ${r}) rotate(${c}deg)`,this.val.setVal_Nochk("tmp",i+".scale_x",n),this.val.setVal_Nochk("tmp",i+".scale_y",r),this.val.setVal_Nochk("tmp",i+".rotate",c)}if("width"in t&&(s.width=String(h.width*$.#e.cvsScale),this.val.setVal_Nochk("tmp",i+".width",h.width)),"height"in t&&(s.height=String(h.height*$.#e.cvsScale),this.val.setVal_Nochk("tmp",i+".height",h.height)),"visible"in t){const n=E(t,"visible",!0);a.display=n?"inline":"none",this.val.setVal_Nochk("tmp",i+".visible",n)}if("b_color"in t&&(a.backgroundColor=t.b_color),"disabled"in t){const n=this.#g[e]=E(t,"disabled",!0),r=s.contentDocument.body;for(const c of[...Array.from(r.getElementsByTagName("input")),...Array.from(r.getElementsByTagName("select"))])c.disabled=n}return!1}#r(t){const{id:e,alpha:s,x:i,y:a,scale_x:h,scale_y:n,rotate:r,width:c,height:g}=t;if(!e)throw"idは必須です";const l=document.getElementById(e);if(!l)throw`id【${e}】はフレームではありません`;const u="const.sn.frm."+e;if(!this.val.getVal(`tmp:${u}`,0))throw`frame【${e}】が読み込まれていません`;const f={};s&&(f.a=l.style.opacity),(i||a||h||n||r)&&(f.x=Number(this.val.getVal(`tmp:${u}.x`)),f.y=Number(this.val.getVal(`tmp:${u}.y`)),f.sx=Number(this.val.getVal(`tmp:${u}.scale_x`)),f.sy=Number(this.val.getVal(`tmp:${u}.scale_y`)),f.r=Number(this.val.getVal(`tmp:${u}.rotate`))),c&&(f.w=this.val.getVal(`tmp:${u}.width`)),g&&(f.h=this.val.getVal(`tmp:${u}.height`));const o=F.cnvTweenArg(t,f);let d=()=>{};s&&(v(o,"alpha",0),d=()=>{l.style.opacity=f.a,this.val.setVal_Nochk("tmp","alpha",f.a)});let p=()=>{};const y=this.#o(o);(i||a||h||n||r)&&(y.x,y.y,v(o,"scale_x",1),v(o,"scale_y",1),v(o,"rotate",0),p=()=>{l.style.left=$.#e.ofsLeft4elm+f.x*$.#e.cvsScale+"px",l.style.top=$.#e.ofsTop4elm+f.y*$.#e.cvsScale+"px",l.style.transform=`scale(${f.sx}, ${f.sy}) rotate(${f.r}deg)`,this.val.setVal_Nochk("tmp",u+".x",f.x),this.val.setVal_Nochk("tmp",u+".y",f.y),this.val.setVal_Nochk("tmp",u+".scale_x",f.sx),this.val.setVal_Nochk("tmp",u+".scale_y",f.sy),this.val.setVal_Nochk("tmp",u+".rotate",f.r)});let m=()=>{};c&&(y.width,m=()=>{l.width=f.w*$.#e.cvsScale+"px",this.val.setVal_Nochk("tmp",u+".width",f.w)});let C=()=>{};return g&&(y.height,C=()=>{l.height=f.h*$.#e.cvsScale+"px",this.val.setVal_Nochk("tmp",u+".height",f.h)}),this.appPixi.stage.interactive=!1,F.tween(`frm
${e}`,t,f,F.cnvTweenArg(t,f),()=>{d(),p(),m(),C()},()=>this.appPixi.stage.interactive=!0,()=>{}),!1}}class H{constructor(t,e,s,i,a,h,n,r,c){this.cfg=t,this.hTag=e,this.appPixi=s,this.val=i,this.main=a,this.scrItr=h,this.sys=n,this.sndMng=r,this.prpPrs=c;const g=()=>{if(n.cvsResize(),this.cvsResizeDesign(),this.#o)for(const o of this.#T)this.#n[o].fore.cvsResizeChildren();else for(const o of this.#T)this.#n[o].fore.cvsResize();this.#h.cvsResize(),this.#l.cvsResize()};if(T.isMobile)this.#c.add(globalThis,"orientationchange",g,{passive:!0});else{let o;this.#c.add(globalThis,"resize",()=>{o||(o=setTimeout(()=>{o=void 0,g()},1e3/60*10))},{passive:!0})}n.cvsResize(),w.init(t,e,i,this,o=>this.#n[o.layname].fore===o,s),I.init(a,t,s,n,r,i),$.init(t,n,a),V.init(t),this.#h=new $(e,s,i),n.hFactoryCls.grp=()=>new I,n.hFactoryCls.txt=()=>new w,e.loadplugin=o=>this.#$(o),e.snapshot=o=>this.#p(o),this.#v=this.sys.isApp?this.#r:this.#L,e.add_lay=o=>this.#_(o),e.clear_lay=o=>this.#z(o),e.finish_trans=()=>F.finish_trans(),e.lay=o=>this.#I(o),e.trans=o=>this.#J(o),e.wt=o=>F.wt(o),e.quake=o=>this.#E(o),e.stop_quake=e.finish_trans,e.wq=o=>e.wt(o),e.pause_tsy=o=>F.pause_tsy(o),e.resume_tsy=o=>F.resume_tsy(o),e.stop_tsy=o=>F.stop_tsy(o),e.tsy=o=>this.#Z(o),e.wait_tsy=o=>F.wait_tsy(o),e.add_filter=o=>this.#O(o),e.clear_filter=o=>this.#G(o),e.enable_filter=o=>this.#H(o),e.ch=o=>this.#N(o),e.clear_text=o=>this.#et(o),e.current=o=>this.#Y(o),e.endlink=o=>this.#st(o),e.er=o=>this.#it(o),e.graph=o=>this.#at(o),e.link=o=>this.#nt(o),e.r=o=>this.#ht(o),e.rec_ch=o=>this.#tt(o),e.rec_r=o=>this.#rt(o),e.reset_rec=o=>this.#ot(o),e.ruby2=o=>this.#lt(o),e.span=o=>this.#ct(o),e.tcy=o=>this.#dt(o),e.add_face=o=>b.add_face(o),e.wv=o=>b.wv(o),e.dump_lay=o=>this.#ft(o),e.enable_event=o=>this.#pt(o),e.button=o=>this.#ut(o),t.existsBreakline&&(this.breakLine=o=>{delete o.visible,o.id="break",o.pic="breakline";const d=encodeURIComponent(JSON.stringify(o));this.#u("grp｜"+d)}),t.existsBreakpage&&(this.breakPage=o=>{delete o.visible,o.id="break",o.pic="breakpage";const d=encodeURIComponent(JSON.stringify(o));this.#u("grp｜"+d)}),this.#t=Ft(String(t.oCfg.init.bg_color));const l=new M;l.beginFill(this.#t,1).lineStyle(0,this.#t).drawRect(0,0,T.stageW,T.stageH).endFill(),this.#e.addChild(l.clone()),this.#a.addChild(l),this.#a.visible=!1,this.#e.name="page:A",this.#a.name="page:B",this.#i=s.stage,this.#i.addChild(this.#a),this.#i.addChild(this.#e),this.#i.addChild(this.#P),this.#i.addChild(this.#m),this.#i.name="stage";const u=(o,d)=>{this.#f(Number(d))};u("",i.getVal("sys:TextLayer.Back.Alpha",1)),i.defValTrg("sys:TextLayer.Back.Alpha",u);const f=(o,d)=>V.fontFamily=d;f("",i.getVal("tmp:sn.button.fontFamily",V.fontFamily)),i.defValTrg("tmp:sn.button.fontFamily",f),i.defTmp("const.sn.log.json",()=>JSON.stringify((this.#R.text=this.#R.text?.replaceAll("</span><span class='sn_ch'>","")??"")?[...this.#U,this.#R]:this.#U)),i.defTmp("const.sn.last_page_text",()=>this.currentTxtlayFore?.pageText??""),i.defTmp("const.sn.last_page_plain_text",()=>this.currentTxtlayFore?.pagePlainText??""),T.isDbg&&(ct.init(s,n,h,c,t,this.#n),this.cvsResizeDesign=()=>ct.cvsResizeDesign(),n.addHook((o,d)=>{this.#d[o]?.(o,d)&&delete this.#d[o]}))}#i;#e=new B;#a=new B;#h;#t;#c=new wt;cvsResizeDesign(){}#d={attach:t=>!1,continue:t=>!1,disconnect:t=>!1,_enterDesign:t=>{for(const e of this.#T){const s=this.#n[e].fore;s.makeDesignCastChildren(i=>i.make()),s.makeDesignCast(i=>i.make())}return this.#s(this.#k),!1},_replaceToken:(t,e)=>!1,_selectNode:(t,e)=>(this.#s(e.node),!1)};#g="";#o="";#s(t){[this.#g="",this.#o=""]=t.split("/");const e=this.#n[this.#g];e&&(this.#o?e.fore.showDesignCastChildren():e.fore.showDesignCast())}getFrmDisabled=t=>this.#h.getFrmDisabled(t);#y=void 0;cover(t,e=0){this.#y&&(this.#i.removeChild(this.#y),this.#y.destroy(),this.#y=void 0),t&&this.#i.addChild((this.#y=new M).beginFill(e).lineStyle(0,e).drawRect(0,0,T.stageW,T.stageH).endFill())}#l;setEvtMng(t){this.#l=t,this.#h.setEvtMng(t),b.setEvtMng(t),F.init(t,this.appPixi)}destroy(){for(const t of Object.values(this.#n))t.destroy();this.#c.clear(),I.destroy(),lt.destroy(),_.destroy(),w.destroy(),this.#h.destroy(),F.destroy(),H.#A=10}#f(t){for(const e of this.#b()){const s=this.#n[e];s.fore instanceof w&&(s.fore.chgBackAlpha(t),s.back.chgBackAlpha(t))}}#u=(t,e=this.currentTxtlayForeNeedErr,s=!0)=>e.tagCh("｜&emsp;《"+t+"》");goTxt=()=>{};breakLine=t=>{};breakPage=t=>{};clearBreak(){this.currentTxtlayFore&&(this.clearBreak=()=>this.#u("del｜break"),this.clearBreak())}clickTxtLay(){return this.currentTxtlayFore?this.#b().some(t=>{const e=this.#n[t].fore;return e instanceof w&&e.click()}):!1}#p(t){const e=t.fn?t.fn.startsWith(Pt)?t.fn:`${gt+t.fn+yt("-","_","","_")}.png`:`${gt}snapshot${yt("-","_","","_")}.png`,s=this.cfg.searchPath(e),i=v(t,"width",T.stageW),a=v(t,"height",T.stageH);return this.#v(t,s,i,a)}#v=()=>!1;#r(t,e,s,i){if(this.#h.hideAllFrame(),q(),!("layer"in t))return this.sys.capturePage(e,s,i,()=>{this.#h.restoreAllFrame(),J()}),!0;const a={};for(const h of this.#b()){const n=this.#n[h].fore.ctn;a[h]=n.visible,n.visible=!1}for(const h of this.#b(t.layer))this.#n[h].fore.ctn.visible=!0;return this.sys.capturePage(e,s,i,()=>{for(const[h,n]of Object.entries(a))this.#n[h].fore.ctn.visible=n;this.#h.restoreAllFrame(),J()}),!0}#L(t,e,s,i){q();const a=bt(t,"b_color",this.#t),h=Ot({width:s,height:i,backgroundAlpha:a>16777216&&e.endsWith(".png")?0:1,antialias:E(t,"smoothing",!1),preserveDrawingBuffer:!0,backgroundColor:a&16777215,autoDensity:!0}),n=t.page!=="back"?"fore":"back";return Promise.allSettled(this.#b(t.layer).map(r=>new Promise(c=>this.#n[r][n].snapshot(h,c)))).then(async()=>{const r=Y.create({width:h.width,height:h.height});h.render(this.#i,{renderTexture:r}),await this.sys.savePic(e,h.plugins.extract.base64(r)),r.destroy();for(const c of this.#b(t.layer))this.#n[c][n].snapshot_end();h.destroy(!0),J()}),!0}#$(t){const{fn:e}=t;if(!e)throw"fnは必須です";const s=E(t,"join",!0);if(s&&q(),e.endsWith(".css"))(async()=>{const i=await fetch(e);if(!i.ok)throw new Error("Network response was not ok.");st(await i.text()),s&&J()})();else throw"サポートされない拡張子です";return s}#_(t){const{layer:e,class:s}=t;if(!e)throw"layerは必須です";if(e.includes(","))throw"layer名に「,」は使えません";if(e in this.#n)throw`layer【${e}】はすでにあります`;if(!s)throw"clsは必須です";const i={isWait:!1};switch(this.#n[e]=new G(e,s,this.#e,this.#a,t,this.sys,this.val,i),this.#T.push(e),s){case"txt":this.#k||(this.#D=()=>{},this.#w=this.#K,this.#Y=this.#Q,this.hTag.current({layer:e}),this.goTxt=()=>{this.#l.isSkipping?H.#A=0:this.setNormalChWait();for(const a of this.#b()){const h=this.#n[a].fore;h instanceof w&&this.#u("gotxt｜",h,!1)}}),this.val.setVal_Nochk("save","const.sn.layer."+(e??this.#k)+".enabled",!0);break;case"grp":if(this.#M)break;this.#M=e;break}return this.scrItr.recodeDesign(t),i.isWait}#n={};#T=[];#k="";#M="";#I(t){const e=this.#W(t),s=this.#n[e],i=s.back.ctn,a=s.fore.ctn;if(E(t,"float",!1))this.#a.setChildIndex(i,this.#a.children.length-1),this.#e.setChildIndex(a,this.#e.children.length-1),this.#S();else if(t.index)v(t,"index",0)&&(this.#a.setChildIndex(i,t.index),this.#e.setChildIndex(a,t.index),this.#S());else if(t.dive){const{dive:h}=t;let n=0;if(e===h)throw"[lay] 属性 layerとdiveが同じ【"+h+"】です";const r=this.#n[h];if(!r)throw"[lay] 属性 dive【"+h+"】が不正です。レイヤーがありません";const c=r.back,g=r.fore,l=this.#a.getChildIndex(c.ctn),u=this.#e.getChildIndex(g.ctn);n=l<u?l:u,n>this.#a.getChildIndex(i)&&--n,this.#e.setChildIndex(a,n),this.#a.setChildIndex(i,n),this.#S()}return t[":id_tag"]=s.fore.name.slice(0,-7),this.scrItr.recodeDesign(t),s.lay(t)}#S(){this.#T=this.#q()}#z(t){return this.#x(t,e=>{const s=this.#n[this.#W({layer:e})];if(t.page==="both"){s.fore.clearLay(t),s.back.clearLay(t);return}s.getPage(t).clearLay(t)}),!1}static#B=`
precision mediump float;

varying vec2 vTextureCoord;
uniform sampler2D uSampler;

uniform sampler2D rule;
uniform float vague;
uniform float tick;

uniform vec4 inputPixel;
uniform highp vec4 outputFrame;
vec2 getUV(vec2 coord) {
	return coord * inputPixel.xy / outputFrame.zw;
}

void main() {
	vec4 fg = texture2D(uSampler, vTextureCoord);
	vec4 ru = texture2D(rule, getUV(vTextureCoord));

	float v = ru.r - tick;
	gl_FragColor = abs(v) < vague
		? vec4(fg.rgb, 1) *fg.a *(0.5 +v /vague *0.5)
		: 0.0 <= v ? fg : vec4(0);
}`;#F=Y.create({width:T.stageW,height:T.stageH});#P=new P(this.#F);#C=Y.create({width:T.stageW,height:T.stageH});#m=new P(this.#C);#J(t){F.finish_trans(),this.#l.hideHint();const{layer:e}=t,s=new Set,i=[];for(const x of this.#b(e))s.add(x),i.push(this.#n[x].fore);const a=async()=>{[this.#e,this.#a]=[this.#a,this.#e];const x=[];for(const[k,S]of Object.entries(this.#n)){if(s.has(k)){S.transPage(x);continue}const{fore:{ctn:N},back:{ctn:A}}=S,R=this.#e.getChildIndex(A);this.#e.removeChild(A),this.#a.removeChild(N),this.#e.addChildAt(N,R),this.#a.addChildAt(A,R)}await Promise.allSettled(x),this.#e.visible=!0,this.#a.visible=!1,this.#P.visible=!1,this.#m.visible=!1};if(this.#m.filters=[],this.#m.alpha=1,v(t,"time",0)===0||this.#l.isSkipping)return a(),!1;let h=[];const n=[];for(const x of this.#b()){const k=this.#n[x][s.has(x)?"back":"fore"];k.ctn.visible&&h.push(k.ctn),n.push(k)}const{ticker:r,renderer:c}=this.appPixi;c.render(this.#a,{renderTexture:this.#F});let g=()=>{for(const x of h)c.render(x,{renderTexture:this.#F,clear:!1})};if(!n.some(x=>x.containMovement)){const x=g;g=()=>{g=()=>{},x()}}const l=()=>c.render(this.#e,{renderTexture:this.#C});l();let u=()=>{this.#e.visible=!0,l(),this.#e.visible=!1};if(!i.some(x=>x.containMovement)){const x=u;u=()=>{u=()=>{},x()}}const f=()=>{g(),this.#P.visible=!0,u(),this.#m.visible=!0},{glsl:o,rule:d}=t,p=()=>{r.remove(f),a()};if(!o&&!d)return F.tween(F.TW_INT_TRANS,t,this.#m,{alpha:0},()=>{},p,()=>{}),r.add(f),!1;const y={rule:D.EMPTY,vague:v(t,"vague",.04),tick:0};this.#m.filters=[new Lt(void 0,o??H.#B,y)];const m=F.tween(F.TW_INT_TRANS,t,y,{tick:1},()=>{},p,()=>{},!d);if(!d)return r.add(f),!1;const C=new b(d,void 0,x=>{y.rule=x.texture,x.destroy(),C.destroy(),m.start(),r.add(f)});return!1}#b(t=""){return t?t.split(","):this.#T}#x(t,e){const s=this.#b(t.layer);for(const i of s){const a=this.#n[i];if(!a)throw"存在しないlayer【"+i+"】です";e(i,a)}return s}#q(t=""){return this.#b(t).sort((e,s)=>{const i=this.#e.getChildIndex(this.#n[e].fore.ctn),a=this.#e.getChildIndex(this.#n[s].fore.ctn);return i<a?-1:i>a?1:0})}setAllStyle2TxtLay(t){const e=this.#b();for(const s of e){const i=this.#n[s].fore;i instanceof w&&i.lay({style:t})}}#E(t){if(F.finish_trans(),v(t,"time",NaN)===0||this.#l.isSkipping)return!1;const{layer:e}=t,s=[];for(const c of this.#b(e))s.push(this.#n[c].fore.ctn);this.#C.resize(T.stageW,T.stageH);const i=()=>{this.#e.visible=!0;const{renderer:c}=this.appPixi;for(const g of s)c.render(g,{renderTexture:this.#C,clear:!1});this.#e.visible=!1};this.#m.visible=!0,this.#m.alpha=1;const a=W(v(t,"hmax",10)),h=W(v(t,"vmax",10)),n=a===0?()=>{}:()=>this.#m.x=Math.round(Math.random()*a*2)-a,r=h===0?()=>{}:()=>this.#m.y=Math.round(Math.random()*h*2)-h;return this.#m.filters=[],F.tween(F.TW_INT_TRANS,t,this.#m,{x:0,y:0},()=>{n(),r()},()=>{this.appPixi.ticker.remove(i),this.#e.visible=!0,this.#m.visible=!1,this.#m.x=0,this.#m.y=0},()=>{}),this.appPixi.ticker.add(i),!1}#Z(t){const{layer:e,render:s,name:i}=t;if(!e)throw"layerは必須です";const a=this.#n[this.#W(t)],h=a.fore;let n=()=>{};s&&!this.#l.isSkipping&&(h.renderStart(),n=()=>h.renderEnd());const r=F.cnvTweenArg(t,h),c=E(t,"arrive",!1),g=E(t,"backlay",!1),l=a.back.ctn;return F.tween(i??e,t,h,F.cnvTweenArg(t,h),()=>{},n,()=>{if(c&&Object.assign(h,r),g)for(const u of Object.keys(F.hMemberCnt))l[u]=h[u]}),"filter"in t&&(h.ctn.filters=[L.bldFilters(t)],h.aFltHArg=[t]),!1}#O(t){return F.finish_trans(),this.#x(t,e=>{const s=this.#n[this.#W({layer:e})];if(t.page==="both"){this.#X(s.fore,t),this.#X(s.back,t);return}const i=s.getPage(t);this.#X(i,t)}),!1}#X(t,e){const s=t.ctn;s.filters??=[],s.filters=[...s.filters,L.bldFilters(e)],t.aFltHArg.push(e)}#G(t){return this.#x(t,e=>{const s=this.#n[this.#W({layer:e})];if(t.page==="both"){const a=s.fore,h=s.back;a.ctn.filters=null,h.ctn.filters=null,a.aFltHArg=[],h.aFltHArg=[];return}const i=s.getPage(t);i.ctn.filters=null,i.aFltHArg=[]}),!1}#H(t){return this.#x(t,e=>{const s=this.#n[this.#W({layer:e})];if(t.page==="both"){this.#V(s.fore,t),this.#V(s.back,t);return}const i=s.getPage(t);this.#V(i,t)}),!1}#V(t,e){const s=t.ctn;if(!s.filters)throw"フィルターがありません";const i=W(v(e,"index",0)),a=s.filters.length;if(a<=i)throw`フィルターの個数（${a}）を越えています`;t.aFltHArg[i].enabled=s.filters[i].enabled=E(e,"enabled",!0)}static#A=10;static get msecChWait(){return H.#A}#N(t){const{text:e}=t;if(!e)throw"textは必須です";const s=this.#w(t);delete t.text,this.setNormalChWait(),this.#l.isSkipping?t.wait=0:"wait"in t&&v(t,"wait",NaN);const i=encodeURIComponent(JSON.stringify(t));this.#u("add｜"+i,s);const a=E(t,"record",!0),h=this.val.doRecLog();return a||this.val.setVal_Nochk("save","sn.doRecLog",a),s.tagCh(e.replaceAll("[r]",`
`)),this.val.setVal_Nochk("save","sn.doRecLog",h),this.#u("add_close｜",s),!1}#w=t=>{throw this.#D(),0};#K(t){const e=this.#W(t,this.#k),s=this.#n[e].getPage(t);if(!(s instanceof w))throw e+"はTxtLayerではありません";return s}setNormalChWait(){H.#A=this.scrItr.normalWait}#Y=t=>{throw this.#D(),0};#Q(t){const{layer:e}=t;if(!e)throw"[current] layerは必須です";const s=this.#n[e];if(!s||!(s.getPage(t)instanceof w))throw`${e}はTxtLayerではありません`;this.#j=s,this.recPagebreak(),this.#k=e,this.val.setVal_Nochk("save","const.sn.mesLayer",e);for(const i of this.#b()){const a=this.#n[i];a.fore instanceof w&&(a.fore.isCur=a.back.isCur=i===e)}return!1}get currentTxtlayForeNeedErr(){return this.#D(),this.currentTxtlayFore}get currentTxtlayFore(){return this.#j?this.#j.fore:null}#j;#D=()=>{throw"文字レイヤーがありません。文字表示や操作する前に、[add_lay layer=（レイヤ名） class=txt]で文字レイヤを追加して下さい"};#W(t,e=""){const s=t.layer??e;if(s.includes(","))throw"layer名に「,」は使えません";if(!(s in this.#n))throw"属性 layer【"+s+"】が不正です。レイヤーがありません";return t.layer=s}#R={text:""};#U=[];recText(t){this.#R={text:t},this.val.setVal_Nochk("save","const.sn.sLog",String(this.val.getVal("const.sn.log.json")))}recPagebreak(){this.#R.text&&(this.#R.text=this.#R.text.replaceAll("</span><span class='sn_ch'>",""),this.#U.push(this.#R)>this.cfg.oCfg.log.max_len&&(this.#U=this.#U.slice(-this.cfg.oCfg.log.max_len)),this.#R={text:""})}#et(t){const e=this.#w(t);return t.layer===this.#k&&t.page==="fore"&&this.recPagebreak(),e.clearText(),!1}#st(t){return this.#u("endlink｜",this.#w(t)),!1}#it(t){return E(t,"rec_page_break",!0)&&this.recPagebreak(),this.#j&&(this.#j.fore.clearLay(t),this.#j.back.clearLay(t)),!1}#at(t){if(!t.pic)throw"[graph] picは必須です";const e=encodeURIComponent(JSON.stringify(t));return this.#u("grp｜"+e,this.#w(t)),!1}#nt(t){if(!t.fn&&!t.label&&!t.url)throw"fn,label,url いずれかは必須です";t.fn??=this.scrItr.scriptFn,t.style??="background-color: rgba(255,0,0,0.5);",t.style_hover??="background-color: rgba(255,0,0,0.9);",t.style_clicked??=t.style;const e=encodeURIComponent(JSON.stringify(t));return this.#u("link｜"+e,this.#w(t)),!1}#ht(t){return t.text=`
`,this.#N(t)}#rt(t){return this.#tt({...t,text:"[r]"})}#tt(t){return this.#R={...t,text:this.#R.text},t.text?(t.record=!0,t.style??="",t.style+="display: none;",t.wait=0,this.#N(t)):!1}#ot(t){return this.#U=[],this.#R={text:t.text??""},this.val.setVal_Nochk("save","const.sn.sLog",t.text?`[{text:"${t.text}"}]`:"[]"),!1}#lt(t){const{t:e,r:s}=t;if(!e)throw"[ruby2] tは必須です";if(!s)throw"[ruby2] rは必須です";return t.text="｜"+encodeURIComponent(e)+"《"+encodeURIComponent(s)+"》",delete t.t,delete t.r,this.#N(t)}#ct(t){const e=encodeURIComponent(JSON.stringify(t));return this.#u("span｜"+e,this.#w(t)),!1}#dt(t){if(!t.t)throw"[tcy] tは必須です";const e=encodeURIComponent(JSON.stringify(t));return this.#u("tcy｜"+e,this.#w(t)),!1}#ft(t){console.group("🥟 [dump_lay]");for(const e of this.#b(t.layer)){const s=this.#n[e];try{console.info(`%c${s.fore.name.slice(0,-7)} %o`,`color:#${T.isDarkMode?"49F":"05A"};`,JSON.parse(`{"back":{${s.back.dump()}}, "fore":{${s.fore.dump()}}}`))}catch(i){console.error("dump_lay err:%o",i),console.error(`   back:${s.back.dump()}`),console.error(`   fore:${s.fore.dump()}`)}}return console.groupEnd(),!1}#pt(t){const e=this.#W(t,this.#k),s=E(t,"enabled",!0);return this.#w(t).enabled=s,this.val.setVal_Nochk("save","const.sn.layer."+e+".enabled",s),!1}#ut(t){return G.argChk_page(t,"back"),t.fn??=this.scrItr.scriptFn,this.#w(t).addButton(t),this.scrItr.recodeDesign(t),!1}record(){const t={};for(const e of this.#T){const s=this.#n[e];t[e]={cls:s.cls,fore:s.fore.record(),back:s.back.record()}}return t}playback(t){this.#U=JSON.parse(String(this.val.getVal("save:const.sn.sLog"))),this.#R={text:""};const e=[],s=[];for(const[a,{fore:h,fore:{idx:n},back:r,cls:c}]of Object.entries(t)){s.push({ln:a,idx:n});const g=this.#n[a]??=new G(a,c,this.#e,this.#a,{},this.sys,this.val,{isWait:!1});g.fore.playback(h,e),g.back.playback(r,e)}const i=this.#e.children.length;return e.push(new Promise(a=>{for(const{ln:h,idx:n}of s.sort(({idx:r},{idx:c})=>r===c?0:r<c?-1:1)){const{fore:r,back:c}=this.#n[h];if(!r)continue;const g=i>n?n:i-1;this.#e.setChildIndex(r.ctn,g),this.#a.setChildIndex(c.ctn,g)}a()})),e}}const qt=Object.freeze(Object.defineProperty({__proto__:null,LayerMng:H},Symbol.toStringTag,{value:"Module"}));export{V as B,qt as L,w as T};
