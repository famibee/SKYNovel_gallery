import{_ as we}from"../web.js";import{C as tt,c as xe,d as ke,e as ct,E as ie,S as Oe,a as Z,f as At,m as Ee}from"./web.js";import{T as _e,B as Jt}from"./LayerMng.js";import{n as N,r as _}from"./Reading.js";import"./SndBuf.js";import"./ScriptIterator.js";class De{#e=[];#t=-1;#r=new ie;destroy(){this.#e=[],this.#t=-1,this.#r.clear()}add(t,e,i){if(this.#e.findIndex(r=>r.btn===t)>=0)return;if(t instanceof ct){t.on("pointerdown",()=>{for(let r=this.#e.length-1;r>=0;--r)if(this.#e[r].btn===t){this.#t=r;return}this.#t=-1}),this.#e.push({btn:t,on:e,off:i});return}this.#r.add(t,"focus",()=>{for(let r=this.#e.length-1;r>=0;--r)if(this.#e[r].btn===t){this.#t=r;return}this.#t=-1});let o=r=>{},s=t.localName==="button"||t.localName==="a"?r=>!r.isTrusted&&r.key==="Enter":r=>r.key==="Enter";const a=t;switch(a.type??""){case"checkbox":o=()=>a.checked=!a.checked;break;case"":t.querySelectorAll("input[type]").length>0&&(o=r=>this.#a(t,r.key),s=()=>!1);break;case"range":o=r=>{r.isTrusted||(r.key==="ArrowUp"?a.stepUp():a.stepDown())};break;case"text":case"textarea":o=r=>{if(r.isTrusted)return;let c=(a.selectionStart??0)+(r.key==="ArrowUp"?-1:1);c<0&&(c=0),a.setSelectionRange(c,c)};break}this.#r.add(t,"keydown",r=>{if(!(r.key!=="ArrowUp"&&r.key!=="ArrowDown"&&r.key!=="Enter")){if(r.stopPropagation(),r.stopImmediatePropagation(),s(r)){t.dispatchEvent(new MouseEvent("click"));return}o(r)}},{passive:!0}),t.hasAttribute("tabindex")||(t.tabIndex=0),this.#e.push({btn:t,on:e,off:i})}remove(t){const e=this.#e.findIndex(i=>i.btn===t);e<0||(this.#e.splice(e,1),this.#e.length===0?this.#t=-1:e<=this.#t&&--this.#t)}#a(t,e){const i=t.querySelectorAll("input[type]"),o=i.length;for(let s=0;s<o;++s)if(i[s].checked){i[(s+o+(e==="ArrowUp"?-1:1))%o].checked=!0;break}}isFocus(t){return this.#t<0?!1:this.#e[this.#t].btn===t}prev(){this.#o();const t=this.#e.length;if(t!==0){--this.#t<0&&(this.#t=t-1);for(let e=t;e>=1;--e){const i=(this.#t+e)%t;if(this.#e[i].on()){this.#t=i,this.#s(i);return}}this.#t=-1}}next(){this.#o();const t=this.#e.length;if(t!==0){++this.#t>=t&&(this.#t=0);for(let e=0;e<t;++e){const i=(this.#t+e)%t;if(this.#e[i].on()){this.#t=i,this.#s(i);return}}this.#t=-1}}#s=tt.debugLog?t=>console.log(`👾 <FocusMng idx:${t} btn:%o`,this.#e[t].btn):()=>{};getFocus(){if(this.#t<0)return null;this.#o(),this.#t>=this.#e.length&&(this.#t=0);const t=this.#e[this.#t];return t.on()?t.btn:null}blur(){this.#o(),this.#t=-1,globalThis.focus()}#o(){for(let t=this.#e.length-1;t>=0;--t){const e=this.#e[t];!(e.btn instanceof ct)||e.btn.parent?e.off():this.#e.splice(t,1)}}}var L="top",H="bottom",R="right",S="left",Lt="auto",dt=[L,H,R,S],et="start",ut="end",Ae="clippingParents",oe="viewport",at="popper",Te="reference",Gt=dt.reduce(function(n,t){return n.concat([t+"-"+et,t+"-"+ut])},[]),re=[].concat(dt,[Lt]).reduce(function(n,t){return n.concat([t,t+"-"+et,t+"-"+ut])},[]),je="beforeRead",Le="read",Se="afterRead",Ce="beforeMain",Be="main",Me="afterMain",He="beforeWrite",Re="write",Pe="afterWrite",We=[je,Le,Se,Ce,Be,Me,He,Re,Pe];function V(n){return n?(n.nodeName||"").toLowerCase():null}function B(n){if(n==null)return window;if(n.toString()!=="[object Window]"){var t=n.ownerDocument;return t&&t.defaultView||window}return n}function z(n){var t=B(n).Element;return n instanceof t||n instanceof Element}function M(n){var t=B(n).HTMLElement;return n instanceof t||n instanceof HTMLElement}function St(n){if(typeof ShadowRoot>"u")return!1;var t=B(n).ShadowRoot;return n instanceof t||n instanceof ShadowRoot}function Ne(n){var t=n.state;Object.keys(t.elements).forEach(function(e){var i=t.styles[e]||{},o=t.attributes[e]||{},s=t.elements[e];!M(s)||!V(s)||(Object.assign(s.style,i),Object.keys(o).forEach(function(a){var r=o[a];r===!1?s.removeAttribute(a):s.setAttribute(a,r===!0?"":r)}))})}function $e(n){var t=n.state,e={popper:{position:t.options.strategy,left:"0",top:"0",margin:"0"},arrow:{position:"absolute"},reference:{}};return Object.assign(t.elements.popper.style,e.popper),t.styles=e,t.elements.arrow&&Object.assign(t.elements.arrow.style,e.arrow),function(){Object.keys(t.elements).forEach(function(i){var o=t.elements[i],s=t.attributes[i]||{},a=Object.keys(t.styles.hasOwnProperty(i)?t.styles[i]:e[i]),r=a.reduce(function(c,l){return c[l]="",c},{});!M(o)||!V(o)||(Object.assign(o.style,r),Object.keys(s).forEach(function(c){o.removeAttribute(c)}))})}}const Ve={name:"applyStyles",enabled:!0,phase:"write",fn:Ne,effect:$e,requires:["computeStyles"]};function $(n){return n.split("-")[0]}var X=Math.max,kt=Math.min,nt=Math.round;function Tt(){var n=navigator.userAgentData;return n!=null&&n.brands&&Array.isArray(n.brands)?n.brands.map(function(t){return t.brand+"/"+t.version}).join(" "):navigator.userAgent}function se(){return!/^((?!chrome|android).)*safari/i.test(Tt())}function it(n,t,e){t===void 0&&(t=!1),e===void 0&&(e=!1);var i=n.getBoundingClientRect(),o=1,s=1;t&&M(n)&&(o=n.offsetWidth>0&&nt(i.width)/n.offsetWidth||1,s=n.offsetHeight>0&&nt(i.height)/n.offsetHeight||1);var a=z(n)?B(n):window,r=a.visualViewport,c=!se()&&e,l=(i.left+(c&&r?r.offsetLeft:0))/o,u=(i.top+(c&&r?r.offsetTop:0))/s,p=i.width/o,m=i.height/s;return{width:p,height:m,top:u,right:l+p,bottom:u+m,left:l,x:l,y:u}}function Ct(n){var t=it(n),e=n.offsetWidth,i=n.offsetHeight;return Math.abs(t.width-e)<=1&&(e=t.width),Math.abs(t.height-i)<=1&&(i=t.height),{x:n.offsetLeft,y:n.offsetTop,width:e,height:i}}function ae(n,t){var e=t.getRootNode&&t.getRootNode();if(n.contains(t))return!0;if(e&&St(e)){var i=t;do{if(i&&n.isSameNode(i))return!0;i=i.parentNode||i.host}while(i)}return!1}function I(n){return B(n).getComputedStyle(n)}function Fe(n){return["table","td","th"].indexOf(V(n))>=0}function U(n){return((z(n)?n.ownerDocument:n.document)||window.document).documentElement}function Ot(n){return V(n)==="html"?n:n.assignedSlot||n.parentNode||(St(n)?n.host:null)||U(n)}function Yt(n){return!M(n)||I(n).position==="fixed"?null:n.offsetParent}function Ie(n){var t=/firefox/i.test(Tt()),e=/Trident/i.test(Tt());if(e&&M(n)){var i=I(n);if(i.position==="fixed")return null}var o=Ot(n);for(St(o)&&(o=o.host);M(o)&&["html","body"].indexOf(V(o))<0;){var s=I(o);if(s.transform!=="none"||s.perspective!=="none"||s.contain==="paint"||["transform","perspective"].indexOf(s.willChange)!==-1||t&&s.willChange==="filter"||t&&s.filter&&s.filter!=="none")return o;o=o.parentNode}return null}function ht(n){for(var t=B(n),e=Yt(n);e&&Fe(e)&&I(e).position==="static";)e=Yt(e);return e&&(V(e)==="html"||V(e)==="body"&&I(e).position==="static")?t:e||Ie(n)||t}function Bt(n){return["top","bottom"].indexOf(n)>=0?"x":"y"}function ft(n,t,e){return X(n,kt(t,e))}function Ue(n,t,e){var i=ft(n,t,e);return i>e?e:i}function ce(){return{top:0,right:0,bottom:0,left:0}}function fe(n){return Object.assign({},ce(),n)}function le(n,t){return t.reduce(function(e,i){return e[i]=n,e},{})}var qe=function(n,t){return n=typeof n=="function"?n(Object.assign({},t.rects,{placement:t.placement})):n,fe(typeof n!="number"?n:le(n,dt))};function Je(n){var t,e=n.state,i=n.name,o=n.options,s=e.elements.arrow,a=e.modifiersData.popperOffsets,r=$(e.placement),c=Bt(r),l=[S,R].indexOf(r)>=0,u=l?"height":"width";if(!(!s||!a)){var p=qe(o.padding,e),m=Ct(s),h=c==="y"?L:S,b=c==="y"?H:R,f=e.rects.reference[u]+e.rects.reference[c]-a[c]-e.rects.popper[u],d=a[c]-e.rects.reference[c],y=ht(s),O=y?c==="y"?y.clientHeight||0:y.clientWidth||0:0,v=f/2-d/2,g=p[h],w=O-m[u]-p[b],x=O/2-m[u]/2+v,E=ft(g,x,w),k=c;e.modifiersData[i]=(t={},t[k]=E,t.centerOffset=E-x,t)}}function Ge(n){var t=n.state,e=n.options,i=e.element,o=i===void 0?"[data-popper-arrow]":i;o!=null&&(typeof o=="string"&&(o=t.elements.popper.querySelector(o),!o)||ae(t.elements.popper,o)&&(t.elements.arrow=o))}const Ye={name:"arrow",enabled:!0,phase:"main",fn:Je,effect:Ge,requires:["popperOffsets"],requiresIfExists:["preventOverflow"]};function ot(n){return n.split("-")[1]}var Ke={top:"auto",right:"auto",bottom:"auto",left:"auto"};function Ze(n,t){var e=n.x,i=n.y,o=t.devicePixelRatio||1;return{x:nt(e*o)/o||0,y:nt(i*o)/o||0}}function Kt(n){var t,e=n.popper,i=n.popperRect,o=n.placement,s=n.variation,a=n.offsets,r=n.position,c=n.gpuAcceleration,l=n.adaptive,u=n.roundOffsets,p=n.isFixed,m=a.x,h=m===void 0?0:m,b=a.y,f=b===void 0?0:b,d=typeof u=="function"?u({x:h,y:f}):{x:h,y:f};h=d.x,f=d.y;var y=a.hasOwnProperty("x"),O=a.hasOwnProperty("y"),v=S,g=L,w=window;if(l){var x=ht(e),E="clientHeight",k="clientWidth";if(x===B(e)&&(x=U(e),I(x).position!=="static"&&r==="absolute"&&(E="scrollHeight",k="scrollWidth")),x=x,o===L||(o===S||o===R)&&s===ut){g=H;var D=p&&x===w&&w.visualViewport?w.visualViewport.height:x[E];f-=D-i.height,f*=c?1:-1}if(o===S||(o===L||o===H)&&s===ut){v=R;var A=p&&x===w&&w.visualViewport?w.visualViewport.width:x[k];h-=A-i.width,h*=c?1:-1}}var j=Object.assign({position:r},l&&Ke),P=u===!0?Ze({x:h,y:f},B(e)):{x:h,y:f};if(h=P.x,f=P.y,c){var T;return Object.assign({},j,(T={},T[g]=O?"0":"",T[v]=y?"0":"",T.transform=(w.devicePixelRatio||1)<=1?"translate("+h+"px, "+f+"px)":"translate3d("+h+"px, "+f+"px, 0)",T))}return Object.assign({},j,(t={},t[g]=O?f+"px":"",t[v]=y?h+"px":"",t.transform="",t))}function Xe(n){var t=n.state,e=n.options,i=e.gpuAcceleration,o=i===void 0?!0:i,s=e.adaptive,a=s===void 0?!0:s,r=e.roundOffsets,c=r===void 0?!0:r,l={placement:$(t.placement),variation:ot(t.placement),popper:t.elements.popper,popperRect:t.rects.popper,gpuAcceleration:o,isFixed:t.options.strategy==="fixed"};t.modifiersData.popperOffsets!=null&&(t.styles.popper=Object.assign({},t.styles.popper,Kt(Object.assign({},l,{offsets:t.modifiersData.popperOffsets,position:t.options.strategy,adaptive:a,roundOffsets:c})))),t.modifiersData.arrow!=null&&(t.styles.arrow=Object.assign({},t.styles.arrow,Kt(Object.assign({},l,{offsets:t.modifiersData.arrow,position:"absolute",adaptive:!1,roundOffsets:c})))),t.attributes.popper=Object.assign({},t.attributes.popper,{"data-popper-placement":t.placement})}const ze={name:"computeStyles",enabled:!0,phase:"beforeWrite",fn:Xe,data:{}};var wt={passive:!0};function Qe(n){var t=n.state,e=n.instance,i=n.options,o=i.scroll,s=o===void 0?!0:o,a=i.resize,r=a===void 0?!0:a,c=B(t.elements.popper),l=[].concat(t.scrollParents.reference,t.scrollParents.popper);return s&&l.forEach(function(u){u.addEventListener("scroll",e.update,wt)}),r&&c.addEventListener("resize",e.update,wt),function(){s&&l.forEach(function(u){u.removeEventListener("scroll",e.update,wt)}),r&&c.removeEventListener("resize",e.update,wt)}}const tn={name:"eventListeners",enabled:!0,phase:"write",fn:function(){},effect:Qe,data:{}};var en={left:"right",right:"left",bottom:"top",top:"bottom"};function xt(n){return n.replace(/left|right|bottom|top/g,function(t){return en[t]})}var nn={start:"end",end:"start"};function Zt(n){return n.replace(/start|end/g,function(t){return nn[t]})}function Mt(n){var t=B(n),e=t.pageXOffset,i=t.pageYOffset;return{scrollLeft:e,scrollTop:i}}function Ht(n){return it(U(n)).left+Mt(n).scrollLeft}function on(n,t){var e=B(n),i=U(n),o=e.visualViewport,s=i.clientWidth,a=i.clientHeight,r=0,c=0;if(o){s=o.width,a=o.height;var l=se();(l||!l&&t==="fixed")&&(r=o.offsetLeft,c=o.offsetTop)}return{width:s,height:a,x:r+Ht(n),y:c}}function rn(n){var t,e=U(n),i=Mt(n),o=(t=n.ownerDocument)==null?void 0:t.body,s=X(e.scrollWidth,e.clientWidth,o?o.scrollWidth:0,o?o.clientWidth:0),a=X(e.scrollHeight,e.clientHeight,o?o.scrollHeight:0,o?o.clientHeight:0),r=-i.scrollLeft+Ht(n),c=-i.scrollTop;return I(o||e).direction==="rtl"&&(r+=X(e.clientWidth,o?o.clientWidth:0)-s),{width:s,height:a,x:r,y:c}}function Rt(n){var t=I(n),e=t.overflow,i=t.overflowX,o=t.overflowY;return/auto|scroll|overlay|hidden/.test(e+o+i)}function ue(n){return["html","body","#document"].indexOf(V(n))>=0?n.ownerDocument.body:M(n)&&Rt(n)?n:ue(Ot(n))}function lt(n,t){var e;t===void 0&&(t=[]);var i=ue(n),o=i===((e=n.ownerDocument)==null?void 0:e.body),s=B(i),a=o?[s].concat(s.visualViewport||[],Rt(i)?i:[]):i,r=t.concat(a);return o?r:r.concat(lt(Ot(a)))}function jt(n){return Object.assign({},n,{left:n.x,top:n.y,right:n.x+n.width,bottom:n.y+n.height})}function sn(n,t){var e=it(n,!1,t==="fixed");return e.top=e.top+n.clientTop,e.left=e.left+n.clientLeft,e.bottom=e.top+n.clientHeight,e.right=e.left+n.clientWidth,e.width=n.clientWidth,e.height=n.clientHeight,e.x=e.left,e.y=e.top,e}function Xt(n,t,e){return t===oe?jt(on(n,e)):z(t)?sn(t,e):jt(rn(U(n)))}function an(n){var t=lt(Ot(n)),e=["absolute","fixed"].indexOf(I(n).position)>=0,i=e&&M(n)?ht(n):n;return z(i)?t.filter(function(o){return z(o)&&ae(o,i)&&V(o)!=="body"}):[]}function cn(n,t,e,i){var o=t==="clippingParents"?an(n):[].concat(t),s=[].concat(o,[e]),a=s[0],r=s.reduce(function(c,l){var u=Xt(n,l,i);return c.top=X(u.top,c.top),c.right=kt(u.right,c.right),c.bottom=kt(u.bottom,c.bottom),c.left=X(u.left,c.left),c},Xt(n,a,i));return r.width=r.right-r.left,r.height=r.bottom-r.top,r.x=r.left,r.y=r.top,r}function pe(n){var t=n.reference,e=n.element,i=n.placement,o=i?$(i):null,s=i?ot(i):null,a=t.x+t.width/2-e.width/2,r=t.y+t.height/2-e.height/2,c;switch(o){case L:c={x:a,y:t.y-e.height};break;case H:c={x:a,y:t.y+t.height};break;case R:c={x:t.x+t.width,y:r};break;case S:c={x:t.x-e.width,y:r};break;default:c={x:t.x,y:t.y}}var l=o?Bt(o):null;if(l!=null){var u=l==="y"?"height":"width";switch(s){case et:c[l]=c[l]-(t[u]/2-e[u]/2);break;case ut:c[l]=c[l]+(t[u]/2-e[u]/2);break}}return c}function pt(n,t){t===void 0&&(t={});var e=t,i=e.placement,o=i===void 0?n.placement:i,s=e.strategy,a=s===void 0?n.strategy:s,r=e.boundary,c=r===void 0?Ae:r,l=e.rootBoundary,u=l===void 0?oe:l,p=e.elementContext,m=p===void 0?at:p,h=e.altBoundary,b=h===void 0?!1:h,f=e.padding,d=f===void 0?0:f,y=fe(typeof d!="number"?d:le(d,dt)),O=m===at?Te:at,v=n.rects.popper,g=n.elements[b?O:m],w=cn(z(g)?g:g.contextElement||U(n.elements.popper),c,u,a),x=it(n.elements.reference),E=pe({reference:x,element:v,placement:o}),k=jt(Object.assign({},v,E)),D=m===at?k:x,A={top:w.top-D.top+y.top,bottom:D.bottom-w.bottom+y.bottom,left:w.left-D.left+y.left,right:D.right-w.right+y.right},j=n.modifiersData.offset;if(m===at&&j){var P=j[o];Object.keys(A).forEach(function(T){var q=[R,H].indexOf(T)>=0?1:-1,J=[L,H].indexOf(T)>=0?"y":"x";A[T]+=P[J]*q})}return A}function fn(n,t){t===void 0&&(t={});var e=t,i=e.placement,o=e.boundary,s=e.rootBoundary,a=e.padding,r=e.flipVariations,c=e.allowedAutoPlacements,l=c===void 0?re:c,u=ot(i),p=u?r?Gt:Gt.filter(function(b){return ot(b)===u}):dt,m=p.filter(function(b){return l.indexOf(b)>=0});m.length===0&&(m=p);var h=m.reduce(function(b,f){return b[f]=pt(n,{placement:f,boundary:o,rootBoundary:s,padding:a})[$(f)],b},{});return Object.keys(h).sort(function(b,f){return h[b]-h[f]})}function ln(n){if($(n)===Lt)return[];var t=xt(n);return[Zt(n),t,Zt(t)]}function un(n){var t=n.state,e=n.options,i=n.name;if(!t.modifiersData[i]._skip){for(var o=e.mainAxis,s=o===void 0?!0:o,a=e.altAxis,r=a===void 0?!0:a,c=e.fallbackPlacements,l=e.padding,u=e.boundary,p=e.rootBoundary,m=e.altBoundary,h=e.flipVariations,b=h===void 0?!0:h,f=e.allowedAutoPlacements,d=t.options.placement,y=$(d),O=y===d,v=c||(O||!b?[xt(d)]:ln(d)),g=[d].concat(v).reduce(function(Y,F){return Y.concat($(F)===Lt?fn(t,{placement:F,boundary:u,rootBoundary:p,padding:l,flipVariations:b,allowedAutoPlacements:f}):F)},[]),w=t.rects.reference,x=t.rects.popper,E=new Map,k=!0,D=g[0],A=0;A<g.length;A++){var j=g[A],P=$(j),T=ot(j)===et,q=[L,H].indexOf(P)>=0,J=q?"width":"height",C=pt(t,{placement:j,boundary:u,rootBoundary:p,altBoundary:m,padding:l}),W=q?T?R:S:T?H:L;w[J]>x[J]&&(W=xt(W));var mt=xt(W),G=[];if(s&&G.push(C[P]<=0),r&&G.push(C[W]<=0,C[mt]<=0),G.every(function(Y){return Y})){D=j,k=!1;break}E.set(j,G)}if(k)for(var gt=b?3:1,Et=function(Y){var F=g.find(function(yt){var st=E.get(yt);if(st)return st.slice(0,Y).every(function(Q){return Q})});if(F)return D=F,"break"},rt=gt;rt>0;rt--){var vt=Et(rt);if(vt==="break")break}t.placement!==D&&(t.modifiersData[i]._skip=!0,t.placement=D,t.reset=!0)}}const pn={name:"flip",enabled:!0,phase:"main",fn:un,requiresIfExists:["offset"],data:{_skip:!1}};function zt(n,t,e){return e===void 0&&(e={x:0,y:0}),{top:n.top-t.height-e.y,right:n.right-t.width+e.x,bottom:n.bottom-t.height+e.y,left:n.left-t.width-e.x}}function Qt(n){return[L,R,H,S].some(function(t){return n[t]>=0})}function dn(n){var t=n.state,e=n.name,i=t.rects.reference,o=t.rects.popper,s=t.modifiersData.preventOverflow,a=pt(t,{elementContext:"reference"}),r=pt(t,{altBoundary:!0}),c=zt(a,i),l=zt(r,o,s),u=Qt(c),p=Qt(l);t.modifiersData[e]={referenceClippingOffsets:c,popperEscapeOffsets:l,isReferenceHidden:u,hasPopperEscaped:p},t.attributes.popper=Object.assign({},t.attributes.popper,{"data-popper-reference-hidden":u,"data-popper-escaped":p})}const hn={name:"hide",enabled:!0,phase:"main",requiresIfExists:["preventOverflow"],fn:dn};function mn(n,t,e){var i=$(n),o=[S,L].indexOf(i)>=0?-1:1,s=typeof e=="function"?e(Object.assign({},t,{placement:n})):e,a=s[0],r=s[1];return a=a||0,r=(r||0)*o,[S,R].indexOf(i)>=0?{x:r,y:a}:{x:a,y:r}}function gn(n){var t=n.state,e=n.options,i=n.name,o=e.offset,s=o===void 0?[0,0]:o,a=re.reduce(function(u,p){return u[p]=mn(p,t.rects,s),u},{}),r=a[t.placement],c=r.x,l=r.y;t.modifiersData.popperOffsets!=null&&(t.modifiersData.popperOffsets.x+=c,t.modifiersData.popperOffsets.y+=l),t.modifiersData[i]=a}const vn={name:"offset",enabled:!0,phase:"main",requires:["popperOffsets"],fn:gn};function yn(n){var t=n.state,e=n.name;t.modifiersData[e]=pe({reference:t.rects.reference,element:t.rects.popper,placement:t.placement})}const bn={name:"popperOffsets",enabled:!0,phase:"read",fn:yn,data:{}};function wn(n){return n==="x"?"y":"x"}function xn(n){var t=n.state,e=n.options,i=n.name,o=e.mainAxis,s=o===void 0?!0:o,a=e.altAxis,r=a===void 0?!1:a,c=e.boundary,l=e.rootBoundary,u=e.altBoundary,p=e.padding,m=e.tether,h=m===void 0?!0:m,b=e.tetherOffset,f=b===void 0?0:b,d=pt(t,{boundary:c,rootBoundary:l,padding:p,altBoundary:u}),y=$(t.placement),O=ot(t.placement),v=!O,g=Bt(y),w=wn(g),x=t.modifiersData.popperOffsets,E=t.rects.reference,k=t.rects.popper,D=typeof f=="function"?f(Object.assign({},t.rects,{placement:t.placement})):f,A=typeof D=="number"?{mainAxis:D,altAxis:D}:Object.assign({mainAxis:0,altAxis:0},D),j=t.modifiersData.offset?t.modifiersData.offset[t.placement]:null,P={x:0,y:0};if(x){if(s){var T,q=g==="y"?L:S,J=g==="y"?H:R,C=g==="y"?"height":"width",W=x[g],mt=W+d[q],G=W-d[J],gt=h?-k[C]/2:0,Et=O===et?E[C]:k[C],rt=O===et?-k[C]:-E[C],vt=t.elements.arrow,Y=h&&vt?Ct(vt):{width:0,height:0},F=t.modifiersData["arrow#persistent"]?t.modifiersData["arrow#persistent"].padding:ce(),yt=F[q],st=F[J],Q=ft(0,E[C],Y[C]),de=v?E[C]/2-gt-Q-yt-A.mainAxis:Et-Q-yt-A.mainAxis,he=v?-E[C]/2+gt+Q+st+A.mainAxis:rt+Q+st+A.mainAxis,_t=t.elements.arrow&&ht(t.elements.arrow),me=_t?g==="y"?_t.clientTop||0:_t.clientLeft||0:0,Pt=(T=j?.[g])!=null?T:0,ge=W+de-Pt-me,ve=W+he-Pt,Wt=ft(h?kt(mt,ge):mt,W,h?X(G,ve):G);x[g]=Wt,P[g]=Wt-W}if(r){var Nt,ye=g==="x"?L:S,be=g==="x"?H:R,K=x[w],bt=w==="y"?"height":"width",$t=K+d[ye],Vt=K-d[be],Dt=[L,S].indexOf(y)!==-1,Ft=(Nt=j?.[w])!=null?Nt:0,It=Dt?$t:K-E[bt]-k[bt]-Ft+A.altAxis,Ut=Dt?K+E[bt]+k[bt]-Ft-A.altAxis:Vt,qt=h&&Dt?Ue(It,K,Ut):ft(h?It:$t,K,h?Ut:Vt);x[w]=qt,P[w]=qt-K}t.modifiersData[i]=P}}const kn={name:"preventOverflow",enabled:!0,phase:"main",fn:xn,requiresIfExists:["offset"]};function On(n){return{scrollLeft:n.scrollLeft,scrollTop:n.scrollTop}}function En(n){return n===B(n)||!M(n)?Mt(n):On(n)}function _n(n){var t=n.getBoundingClientRect(),e=nt(t.width)/n.offsetWidth||1,i=nt(t.height)/n.offsetHeight||1;return e!==1||i!==1}function Dn(n,t,e){e===void 0&&(e=!1);var i=M(t),o=M(t)&&_n(t),s=U(t),a=it(n,o,e),r={scrollLeft:0,scrollTop:0},c={x:0,y:0};return(i||!i&&!e)&&((V(t)!=="body"||Rt(s))&&(r=En(t)),M(t)?(c=it(t,!0),c.x+=t.clientLeft,c.y+=t.clientTop):s&&(c.x=Ht(s))),{x:a.left+r.scrollLeft-c.x,y:a.top+r.scrollTop-c.y,width:a.width,height:a.height}}function An(n){var t=new Map,e=new Set,i=[];n.forEach(function(s){t.set(s.name,s)});function o(s){e.add(s.name);var a=[].concat(s.requires||[],s.requiresIfExists||[]);a.forEach(function(r){if(!e.has(r)){var c=t.get(r);c&&o(c)}}),i.push(s)}return n.forEach(function(s){e.has(s.name)||o(s)}),i}function Tn(n){var t=An(n);return We.reduce(function(e,i){return e.concat(t.filter(function(o){return o.phase===i}))},[])}function jn(n){var t;return function(){return t||(t=new Promise(function(e){Promise.resolve().then(function(){t=void 0,e(n())})})),t}}function Ln(n){var t=n.reduce(function(e,i){var o=e[i.name];return e[i.name]=o?Object.assign({},o,i,{options:Object.assign({},o.options,i.options),data:Object.assign({},o.data,i.data)}):i,e},{});return Object.keys(t).map(function(e){return t[e]})}var te={placement:"bottom",modifiers:[],strategy:"absolute"};function ee(){for(var n=arguments.length,t=new Array(n),e=0;e<n;e++)t[e]=arguments[e];return!t.some(function(i){return!(i&&typeof i.getBoundingClientRect=="function")})}function Sn(n){n===void 0&&(n={});var t=n,e=t.defaultModifiers,i=e===void 0?[]:e,o=t.defaultOptions,s=o===void 0?te:o;return function(a,r,c){c===void 0&&(c=s);var l={placement:"bottom",orderedModifiers:[],options:Object.assign({},te,s),modifiersData:{},elements:{reference:a,popper:r},attributes:{},styles:{}},u=[],p=!1,m={state:l,setOptions:function(f){var d=typeof f=="function"?f(l.options):f;b(),l.options=Object.assign({},s,l.options,d),l.scrollParents={reference:z(a)?lt(a):a.contextElement?lt(a.contextElement):[],popper:lt(r)};var y=Tn(Ln([].concat(i,l.options.modifiers)));return l.orderedModifiers=y.filter(function(O){return O.enabled}),h(),m.update()},forceUpdate:function(){if(!p){var f=l.elements,d=f.reference,y=f.popper;if(ee(d,y)){l.rects={reference:Dn(d,ht(y),l.options.strategy==="fixed"),popper:Ct(y)},l.reset=!1,l.placement=l.options.placement,l.orderedModifiers.forEach(function(k){return l.modifiersData[k.name]=Object.assign({},k.data)});for(var O=0;O<l.orderedModifiers.length;O++){if(l.reset===!0){l.reset=!1,O=-1;continue}var v=l.orderedModifiers[O],g=v.fn,w=v.options,x=w===void 0?{}:w,E=v.name;typeof g=="function"&&(l=g({state:l,options:x,name:E,instance:m})||l)}}}},update:jn(function(){return new Promise(function(f){m.forceUpdate(),f(l)})}),destroy:function(){b(),p=!0}};if(!ee(a,r))return m;m.setOptions(c).then(function(f){!p&&c.onFirstUpdate&&c.onFirstUpdate(f)});function h(){l.orderedModifiers.forEach(function(f){var d=f.name,y=f.options,O=y===void 0?{}:y,v=f.effect;if(typeof v=="function"){var g=v({state:l,name:d,instance:m,options:O}),w=function(){};u.push(g||w)}})}function b(){u.forEach(function(f){return f()}),u=[]}return m}}var Cn=[tn,bn,ze,Ve,vn,pn,kn,Ye,hn],Bn=Sn({defaultModifiers:Cn});const ne="pointerup";class $n{constructor(t,e,i,o,s,a,r,c,l){if(this.cfg=t,this.hTag=e,this.appPixi=i,this.main=o,this.layMng=s,this.val=a,this.scrItr=c,this.sys=l,e.clear_event=f=>N.clear_event(f),e.event=f=>this.#v(f),e.set_cancel_skip=()=>!1,e.set_focus=f=>this.#y(f),r.setEvtMng(this),c.setOtherObj(this,s),_e.setEvtMng(this,l,c),s.setEvtMng(this),_.setFcs(this.#t),l.setFire((f,d)=>_.fire(f,d)),tt.isDbg){const f={pause:()=>{if(!_.isWait)return;const d={};c.recodeDesign(d),l.callHook("_enterDesign",d),l.send2Dbg("_enterDesign",d)}};f.attach=f.stopOnEntry=f.stopOnStep=f.stopOnStepIn=f.stopOnStepOut=f.stopOnBackstep=f.pause,l.addHook(d=>f[d]?.())}xe(`
.sn_hint {
	background-color: #3c3225;
	color: white;
	padding: 4px 8px;
	border-radius: 4px;
	font-size: 1.2em;
	z-index: 10000;
	pointer-events: none;
	user-select: none;
}

.sn_hint_ar,
.sn_hint_ar::before {
	position: absolute;
	width: 8px;
	height: 8px;
	background: inherit;
}
.sn_hint_ar {
	visibility: hidden;
}
.sn_hint_ar::before {
	visibility: visible;
	content: '';
	transform: rotate(45deg);
}

.sn_hint[data-popper-placement^='top']		> .sn_hint_ar {bottom: -4px;}
.sn_hint[data-popper-placement^='bottom']	> .sn_hint_ar {top: -4px;}
.sn_hint[data-popper-placement^='left']		> .sn_hint_ar {right: -4px;}
.sn_hint[data-popper-placement^='right']	> .sn_hint_ar {left: -4px;}
`),this.main.cvs.parentElement?.insertAdjacentHTML("beforeend",`
<div class="sn_hint" role="tooltip">
	<span>Dummy</span>
	<div class="sn_hint_ar" data-popper-arrow></div>
</div>`),this.#n=document.querySelector(".sn_hint"),this.#l=this.#n.querySelector("span"),this.#u=Bn(this.#d,this.#n),this.#n.hidden=!0,i.stage.interactive=!0;const u=new Map([[0,""],[1,"middle"],[2,"right"]]);this.#e.addC(i.stage,ne,f=>{if(f instanceof TouchEvent){_.fire("click",f);return}const d=this.#s(f)+`${u.get(f.button)??""}click`;_.fire(d,f)}),this.#e.add(window,"keydown",f=>this.#a(f));const p=()=>a.setVal_Nochk("tmp","const.sn.navigator.language",navigator.language);this.#e.add(window,"languagechange",f=>{p(),_.fire("sn:chgNavLang",f),ke()}),p();const m=f=>{tt.isDarkMode=f.matches,a.setVal_Nochk("tmp","const.sn.isDarkMode",tt.isDarkMode)},h=globalThis.matchMedia("(prefers-color-scheme: dark)");m(h),this.#e.add(h,"change",f=>{m(f),_.fire("sn:chgDarkMode",f)});let b=(f,d)=>{};"WheelEvent"in window&&(this.#e.add(o.cvs,"wheel",f=>this.#o(f),{passive:!0}),this.#r=f=>this.#e.add(f,"wheel",d=>this.#o(d),{passive:!0}),b=(f,d)=>f.add(o.cvs,"wheel",y=>{y.isComposing||y.deltaY<=0||(y.stopPropagation(),d())})),_.init(t,e,o,a,c,s,this,r,b),we(()=>import("./gamepad.js"),[],import.meta.url).then(f=>f.g).then(({GamepadListener:f})=>{const d=new f({analog:!1,deadZone:.3});tt.debugLog&&(d.on("gamepad:connected",v=>console.log(`👺<'gamepad:connected' index:${v.detail.index} id:${v.detail.gamepad.id}`)),d.on("gamepad:disconnected",v=>console.log(`👺<'gamepad:disconnected' index:${v.detail.index} id:${v.detail.gamepad?.id}`)));const y=["","ArrowUp","","ArrowLeft","","ArrowRight","","ArrowDown",""],O=[0,0];d.on("gamepad:axis",v=>{if(!document.hasFocus())return;O[v.detail.axis]=v.detail.value;const[g=0,w=0]=O,x=(w+1)*3+(g+1),E=y[x];if(!E)return;const k=this.#t.getFocus();(!k||k instanceof ct?globalThis:k).dispatchEvent(new KeyboardEvent("keydown",{key:E,bubbles:!0})),!(!k||k instanceof ct)&&k.getAttribute("type")==="range"&&k.dispatchEvent(new InputEvent("input",{bubbles:!0}))}),d.on("gamepad:button",v=>{if(document.hasFocus())if(v.detail.button%2===0){const g=this.#t.getFocus();(!g||g instanceof ct?globalThis:g).dispatchEvent(new KeyboardEvent("keydown",{key:"Enter",bubbles:!0}))}else _.fire("middleclick",v)}),d.start()}),this.#e.add(window,"keyup",f=>{f.isComposing||f.key in this.#i&&(this.#i[f.key]=0)}),a.defTmp("const.sn.key.alternate",()=>this.#i.Alt>0),a.defTmp("const.sn.key.command",()=>this.#i.Meta>0),a.defTmp("const.sn.key.control",()=>this.#i.Control>0),a.defTmp("const.sn.key.end",()=>this.#i.End>0),a.defTmp("const.sn.key.escape",()=>this.#i.Escape>0),a.defTmp("const.sn.key.back",()=>this.#i.GoBack>0)}#e=new ie;#t=new De;resvFlameEvent(t){this.#e.add(t,"keydown",e=>this.#a(e)),this.#e.add(t,"contextmenu",e=>{_.fire(this.#s(e)+"rightclick",e),e.preventDefault()}),this.#r(t)}#r=t=>{};#a(t){t.isComposing||(t.key in this.#i&&(this.#i[t.key]=t.repeat?2:1),_.fire(Oe.modKey(t)+t.key,t))}#s(t){return(t.altKey?"alt+":"")+(t.ctrlKey?"ctrl+":"")+(t.metaKey?"meta+":"")+(t.shiftKey?"shift+":"")}#o(t){if(this.#c){this.#f=!0;return}this.#c=!0,this.#p();const e=this.#s(t)+(t.deltaY>0?"downwheel":"upwheel");_.fire(e,t)}#c=!1;#f=!1;#p(){setTimeout(()=>{if(this.#f){this.#f=!1,this.#p();return}this.#c=!1},250)}destroy(){for(const t of Array.from(document.getElementsByClassName("sn_hint")))t.parentElement?.removeChild(t);N.destroy(),this.#t.destroy(),this.#e.clear()}fire(t,e){_.fire(t,e)}unButton(t){this.#t.remove(t)}button(t,e,i,o,s){!t.fn&&!t.label&&!t.url&&this.main.errScript("fnまたはlabelまたはurlは必須です"),t.fn??=this.scrItr.scriptFn,e.interactive=!0,e.cursor="pointer";const a=t.key?.toLowerCase()??" ",r=Z(t,"global",!1);N.setEvt2Fnc(r,a,()=>this.main.resumeByJumpOrCall(t)),e.on(ne,p=>{console.log("fn:EventMng.ts line:332 BTN"),_.fire(a,p)});const c=t.hint?()=>this.#g(t,e):()=>{},l=()=>{i(),this.#n.hidden=!0},u=()=>(c(),o());if(e.on("pointerover",u),e.on("pointerout",()=>{this.#t.isFocus(e)?u():l()}),e.on("pointerdown",()=>{this.#n.hidden=!0;const p=this.#t.getFocus();s(),p instanceof Jt&&p.normal()}),e.on("pointerup",tt.isMobile?l:()=>{this.#t.isFocus(e)?u():l()}),this.#t.add(e,u,l),t.clickse&&(t.clicksebuf??="SYS",this.cfg.searchPath(t.clickse,At.SOUND),e.on("pointerdown",()=>{this.hTag.playse({fn:t.clickse,buf:t.clicksebuf,join:!1})})),t.enterse&&(t.entersebuf??="SYS",this.cfg.searchPath(t.enterse,At.SOUND),e.on("pointerover",()=>{this.hTag.playse({fn:t.enterse,buf:t.entersebuf,join:!1})})),t.leavese&&(t.leavesebuf??="SYS",this.cfg.searchPath(t.leavese,At.SOUND),e.on("pointerout",()=>{this.hTag.playse({fn:t.leavese,buf:t.leavesebuf,join:!1})})),t.onenter){const p=a+t.onenter.toLowerCase(),m={fn:t.fn,label:t.onenter,call:!0,key:p};N.setEvt2Fnc(r,p,()=>this.main.resumeByJumpOrCall(m)),e.on("pointerover",h=>_.fire(p,h))}if(t.onleave){const p=a+t.onleave.toLowerCase(),m={fn:t.fn,label:t.onleave,call:!0,key:p};N.setEvt2Fnc(r,p,()=>this.main.resumeByJumpOrCall(m)),e.on("pointerout",h=>_.fire(p,h))}}#d={getBoundingClientRect:(t=0,e=0)=>DOMRect.fromRect({x:t,y:e,width:0,height:0})};#n;#l;#u;#h={placement:"bottom",modifiers:[{name:"flip",options:{fallbackPlacements:["top","bottom"]}}]};#g(t,e){const i=e instanceof Jt?e.getBtnBounds():e.getBounds();if(t[":タグ名"]!=="link"){const o=e.parent.parent;i.x+=o.x,i.y+=o.y}if(!t.hint){this.#n.hidden=!0;return}this.#n.style.cssText=`position:${this.#n.style.position}; transform:${this.#n.style.transform};`+(t.hint_style??""),this.#l.style.cssText="",this.#l.textContent=t.hint??"";try{const o=t.hint_opt?{...this.#h,...JSON.parse(t.hint_opt)}:this.#h;this.#u.setOptions(o)}catch(o){console.error(Ee(t,"hint_opt",`dispHint 引数 hint_opt エラー ${o instanceof SyntaxError?o.message:""}`))}this.#d.getBoundingClientRect=()=>DOMRect.fromRect({x:this.sys.ofsLeft4elm+i.x*this.sys.cvsScale,y:this.sys.ofsTop4elm+i.y*this.sys.cvsScale,width:i.width,height:i.height}),this.#u.update(),this.#n.hidden=!1}hideHint(){this.#n.hidden=!0}cvsResize(){this.hideHint()}#v(t){const e=t.key;if(!e)throw"keyは必須です";const i=e.toLowerCase(),o=Z(t,"call",!1),s=Z(t,"global",!1);if(Z(t,"del",!1)){if(t.fn||t.label||o||t.url)throw"fn/label/callとdelは同時指定できません";return N.clear_eventer(e,s,i),!1}if(!t.fn&&!t.label&&!t.url)throw"fn,label,url いずれかは必須です";if(t.fn??=this.scrItr.scriptFn,e.startsWith("dom=")){const a=N.getHtmlElmList(e);if(a.el.length===0){if(Z(t,"need_err",!0))throw`HTML内にセレクタ（${a.sel}）に対応する要素が見つかりません。存在しない場合を許容するなら、need_err=false と指定してください`;return!1}let r=["click","keydown"];switch(a.el[0].type??""){case"checkbox":r=["input"];break;case"range":r=["input"];break;case"text":case"textarea":r=["input","change"];break}const c=r.length;for(let l=0;l<c;++l){const u=r[l];a.el.forEach(p=>{this.#e.add(p,u,m=>{if(!_.isWait||this.layMng.getFrmDisabled(a.id)||u==="keydown"&&m.key!=="Enter")return;const h=p.dataset;for(const[b,f]of Object.entries(h))this.val.setVal_Nochk("tmp",`sn.event.domdata.${b}`,f);_.fire(e,m)}),l===0&&this.#t.add(p,()=>this.#m(p)?(p.focus(),!0):!1,()=>{})})}}return N.setEvt2Fnc(s,i,()=>this.main.resumeByJumpOrCall(t)),!1}#m(t){if(t.offsetParent===null)return!1;let e=t;do{if(getComputedStyle(e).display==="none"||e.dataset.focus==="false"||e?.disabled)return!1;e=e.parentElement}while(e!==null);return!0}#y(t){const{add:e,del:i,to:o}=t;if(e?.startsWith("dom=")){const s=N.getHtmlElmList(e);if(s.el.length===0&&Z(t,"need_err",!0))throw`HTML内にセレクタ（${s.sel}）に対応する要素が見つかりません。存在しない場合を許容するなら、need_err=false と指定してください`;return s.el.forEach(a=>this.#t.add(a,()=>this.#m(a)?(a.focus(),!0):!1,()=>{})),!1}if(i?.startsWith("dom=")){const s=N.getHtmlElmList(i);if(s.el.length===0&&Z(t,"need_err",!0))throw`HTML内にセレクタ（${s.sel}）に対応する要素が見つかりません。存在しない場合を許容するなら、need_err=false と指定してください`;return s.el.forEach(a=>this.#t.remove(a)),!1}if(!o)throw"[set_focus] add か to は必須です";switch(o){case"null":this.#t.blur();break;case"next":this.#t.next();break;case"prev":this.#t.prev();break}return!1}get isSkipping(){return _.isSkipping?!0:Object.keys(this.#i).some(t=>this.#i[t]===2)}#i={Alt:0,Meta:0,Control:0,ArrowDown:0,End:0,Enter:0,Escape:0," ":0,GoBack:0}}export{ne as EVNM_CLICK,$n as EventMng};
