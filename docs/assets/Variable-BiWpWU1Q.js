import{g as w,p as b,a as k,u as N,b as r,i as m}from"./web-D5cyPUip.js";import{PropParser as p}from"./PropParser-D62n9vdx.js";import{M as v,P as y}from"./ReadState-DHFxOgnr.js";import"../web.js";class _{hAreas=Object.create(null);clear(){this.hAreas={}}search(s){return Object.entries(this.hAreas).some(([t,e])=>s>=parseInt(t)&&s<=e)}record(s){if(!this.search(s)){for(const[t,e]of Object.entries(this.hAreas))if(e+1===s){String(s+1)in this.hAreas?(this.hAreas[t]=this.hAreas[s+1],delete this.hAreas[s+1]):this.hAreas[t]=s;return}if(String(s+1)in this.hAreas){this.hAreas[s]=this.hAreas[s+1],delete this.hAreas[s+1];return}this.hAreas[s]=s}}erase(s){if(this.search(s)){if(String(s)in this.hAreas){this.hAreas[s]>s&&(this.hAreas[s+1]=this.hAreas[s]),delete this.hAreas[s];return}for(const[t,e]of Object.entries(this.hAreas))if(!(s<parseInt(t)||e<s)){if(this.hAreas[t]===s){this.hAreas[t]=s-1;return}this.hAreas[s+1]=e,this.hAreas[t]=s-1;return}}}get count(){return Object.keys(this.hAreas).length}toString(){let s="";for(const t of Object.keys(this.hAreas).map(e=>parseInt(e)).sort((e,n)=>e-n))s+=t===this.hAreas[t]?","+t:","+t+"~"+this.hAreas[t];return s}}class u{constructor(s,t){if(this.cfg=s,t.let=i=>this.#o(i),t.let_abs=i=>this.#j(i),t.let_char_at=i=>this.#W(i),t.let_index_of=i=>this.#P(i),t.let_length=i=>this.#K(i),t.let_replace=i=>this.#L(i),t.let_round=i=>this.#F(i),t.let_search=i=>this.#M(i),t.let_substr=i=>this.#D(i),t.clearsysvar=()=>this.#c(),t.clearvar=()=>this.#b(),t.dump_val=()=>this.#R(),t.copybookmark=i=>this.#C(i),t.erasebookmark=i=>this.#O(i),this.#i["sn.userFnTail"]="",this.defTmp("const.sn.bookmark.json",()=>{const i=[];for(const o of Object.keys(this.#e.mark).sort()){const c={...this.#e.mark[o].json};c.place=o,i.push(c)}return JSON.stringify(i)}),this.#s["const.sn.isFirstBoot"]=!0,this.#s["const.sn.last_page_text"]="",this.#s["const.sn.last_page_plain_text"]="",this.#s["const.sn.displayState"]=!1,this.#s["const.Date.getTime"]=()=>new Date().getTime(),this.#s["const.Date.getDateStr"]=()=>w(),this.#s["const.sn.platform"]=JSON.stringify(b),this.#c(!0),this.#b(),this.#s["const.sn.config.window.width"]=s.oCfg.window.width,this.#s["const.sn.config.window.height"]=s.oCfg.window.height,this.#s["const.sn.config.book.title"]=s.oCfg.book.title,this.#s["const.sn.config.book.version"]=s.oCfg.book.version,this.#s["const.sn.Math.PI"]=Math.PI,this.#s["const.sn.isPaging"]=!1,typeof window>"u")return;const e=window,n=e.AudioContext??e.webkitAudioContext;this.#s["const.sn.needClick2Play"]=()=>new n().state==="suspended"}#t={sys:{},save:{},tmp:{},mp:{}};#i=this.#t.save;#s=this.#t.tmp;#a;#e={sys:{},mark:{},kidoku:{}};#n;#h={};#m;async setSys(s){this.#a=s,await s.initVal(this.#e,this.#s,t=>{this.updateData(t),sessionStorage.clear();const e=this.cfg.getNs();this.#_=this.cfg.oCfg.debug.variable?()=>{const i={};for(const[h,a]of Object.entries(this.#n))i["sys:"+h]=a instanceof Function?a():a;sessionStorage[e+"sys"]=JSON.stringify(i);const o={};for(const[h,a]of Object.entries(this.#i))o["save:"+h]=a instanceof Function?a():a;sessionStorage[e+"save"]=JSON.stringify(o);const c={};for(const[h,a]of Object.entries(this.#s))c[h]=a instanceof Function?a():a;sessionStorage[e+"tmp"]=JSON.stringify(c);const g={};for(const[h,a]of Object.entries(this.#t.mp))g[h]=a instanceof Function?a():a;sessionStorage[e+"mp"]=JSON.stringify(g);const f={};for(const[h,a]of Object.entries(this.#e.mark))f[h]=a instanceof Function?a():a;sessionStorage[e+"mark"]=JSON.stringify(f);const l={};for(const[h,a]of Object.entries(this.#e.kidoku))l[h]=a instanceof Function?a():a;sessionStorage[e+"kidoku"]=JSON.stringify(l),s.flush()}:()=>s.flush(),this.#m=(i,o)=>s.callHook(i,o),s.addHook((i,o)=>this.#V[i]?.(i,o));const n=this.getVal("sys:sn.tagCh.msecWait",-1);(this.#s["const.sn.isFirstBoot"]||n===-1)&&this.#c(!0),this.#l=this.getVal("sys:sn.tagCh.doWait"),this.#f=this.getVal("sys:sn.tagCh.doWait_Kidoku"),this.#u=this.getVal("sys:sn.tagCh.msecWait"),this.#k=this.getVal("sys:sn.tagCh.msecWait_Kidoku"),this.#p()})}#p(){v(this.getVal("sys:const.sn.aPageLog")??"[]",this.getVal("save:const.sn.styPaging")??y)}#V={auth:(s,t)=>this.#y(t.hBreakpoint.aData),var:(s,t)=>this.#a.send2Dbg(t.ri,{v:this.#t[t.scope]??{}}),set_var:(s,t)=>{try{this.#N(t.nm,t.val),this.#a.send2Dbg(t.ri,{})}catch{}},set_data_break:(s,t)=>{this.#y(t.a),this.#a.send2Dbg(t.ri,{})},disconnect:s=>u.#r={}};#y(s){u.#r={};for(const t of s)u.#r[t.dataId]=1}updateData(s){this.#e=s,this.#n=this.#t.sys=this.#e.sys,this.#h={};for(const[t,e]of Object.entries(this.#e.kidoku)){const n=new _;n.hAreas={...e},this.#h[t]=n}}#_=()=>{};flush(){this.#_()}setDoRecProc(s){this.#w=s}#w=s=>{};defTmp(s,t){this.#s[s]=t}cloneMp(){return{...this.#t.mp}}setMp(s){this.#t.mp=s}setMark(s,t){this.#e.mark[s]=t,this.flush()}getMark=s=>{const t=this.#e.mark[s];if(!t)throw`place【${s}】は存在しません`;return t};cloneSave(){return{...this.#t.save}}mark2save(s){this.#i=this.#t.save={...s.hSave},this.#g=this.#i["sn.doRecLog"]??!1}touchAreaKidoku(s){return this.#h[s]??=new _}getAreaKidoku=s=>{const t=this.#h[s];if(!t)throw`hAreaKidoku${s}】は存在しません`;return t};saveKidoku(){for(const[s,{hAreas:t}]of Object.entries(this.#h))this.#e.kidoku[s]={...t};this.flush()}#C(s){if(!("from"in s))throw"fromは必須です";if(!("to"in s))throw"toは必須です";const t=Number(s.from),e=Number(s.to);if(t===e)return!1;const n=this.#e.mark[t];if(!n)throw`from:${t} のセーブデータは存在しません`;return this.setMark(e,{...n}),this.#a.copyBMFolder(t,e),!1}#O(s){const{place:t}=s;if(!t)throw"placeは必須です";return delete this.#e.mark[t],this.flush(),this.#a.eraseBMFolder(t),!1}#o(s){if(!s.name)throw"nameは必須です";let t=!0;if(s.cast)switch(s.cast){case"num":r(s,"text",NaN);break;case"int":s.text=String(m(r(s,"text",NaN)));break;case"uint":s.text=String(N(r(s,"text",NaN)));break;case"bool":k(s,"text",!1);break;case"str":t=!1;break;default:throw"cast【"+s.cast+"】は未定義です"}return this.#N(s.name,s.text,t),!1}#j(s){const t=r(s,"text",0);return s.text=String(t<0?-t:t),this.#o(s),!1}#W(s){return s.text=(s.text??"").charAt(r(s,"pos",0)),this.#o(s),!1}#P(s){const{val:t}=s;if(!t)throw"valは必須です";const e=r(s,"start",0);return s.text=String((s.text??"").indexOf(t,e)),this.#o(s),!1}#K(s){return s.text=String((s.text??"").length),this.#o(s),!1}#L(s){if(!s.reg)throw"regは必須です";const{flags:t}=s,e=t?new RegExp(s.reg,t):new RegExp(s.reg);return s.text=String(s.text??"").replace(e,String(s.val)),this.#o(s),!1}#F(s){const t=r(s,"text",0);return s.text=String(Math.round(t)),this.#o(s),!1}#M(s){if(!s.reg)throw"regは必須です";const{flags:t}=s,e=t?new RegExp(s.reg,t):new RegExp(s.reg);return s.text=String((s.text??"").search(e)),this.#o(s),!1}#D(s){const t=r(s,"pos",0);return s.text=s.len!=="all"?(s.text??"").slice(t,t+m(r(s,"len",1))):(s.text??"").slice(t),this.#o(s),!1}#c(s=!1){const t=this.#n=this.#t.sys=this.#e.sys={};typeof process<"u"||(this.setVal_Nochk("sys","const.sn.window.x",0),this.setVal_Nochk("sys","const.sn.window.y",0)),this.setVal_Nochk("sys","sn.tagCh.doWait",!0),this.setVal_Nochk("sys","sn.tagCh.doWait_Kidoku",!0),this.setVal_Nochk("sys","sn.tagCh.msecWait",this.cfg.oCfg.init.tagch_msecwait),this.setVal_Nochk("sys","sn.tagCh.msecWait_Kidoku",this.cfg.oCfg.init.tagch_msecwait),this.setVal_Nochk("sys","sn.tagCh.canskip",!0),this.setVal_Nochk("sys","sn.skip.mode","s"),this.setVal_Nochk("sys","sn.auto.msecPageWait",r(t,"sn.auto.msecPageWait",this.cfg.oCfg.init.auto_msecpagewait??3500)),this.setVal_Nochk("sys","sn.auto.msecPageWait_Kidoku",r(t,"sn.auto.msecPageWait",this.cfg.oCfg.init.auto_msecpagewait??3500)),this.setVal_Nochk("sys","sn.auto.msecLineWait",500),this.setVal_Nochk("sys","sn.auto.msecLineWait_Kidoku",500),this.setVal_Nochk("sys","sn.sound.BGM.vol_mul_talking",1),this.setVal_Nochk("sys","const.sn.sound.BGM.volume",1),this.setVal_Nochk("sys","const.sn.sound.SE.volume",1),this.setVal_Nochk("sys","const.sn.sound.SYS.volume",1);for(const[e,n]of Object.entries(this.#e.kidoku))n.hAreas={},this.#h[e]?.clear();return this.setVal_Nochk("sys","TextLayer.Back.Alpha",.5),this.#t.mark=this.#e.mark={},this.setVal_Nochk("sys","const.sn.save.place",1),this.setVal_Nochk("sys","const.sn.aPageLog","[]"),s||this.#p(),this.flush(),!1}#b(){const s=this.#i["const.sn.mesLayer"]??"",t=this.#i["sn.doRecLog"]??!1,e=this.#i["const.sn.sLog"]??"[]",n=this.#i["const.sn.styPaging"]??y;return this.#i=this.#t.save={},this.setVal_Nochk("save","const.sn.mesLayer",s),this.setVal_Nochk("save","sn.doRecLog",t),this.setVal_Nochk("save","const.sn.sLog",e),this.setVal_Nochk("save","const.sn.styPaging",n),!1}#N=(s,t,e=!0)=>{if(!s)throw"[変数に値セット] nameは必須です";if(t==null)throw"[変数に値セット] textは必須です（空文字はOK）";const n=p.getValName(s);if(!n)throw"[変数参照] name("+s+")が変数名として異常です";const i=this.#t[n.scope];if(!i)throw"[変数に値セット] scopeが異常【"+n.scope+"】です";const o=n.name;if(o.startsWith("const.")&&o in i)throw"[変数に値セット] 変数【"+o+"】は書き換え不可です";this.setVal_Nochk(n.scope,o,t,e)};setVal_Nochk(s,t,e,n=!1){const i=this.#t[s];n&&(e=this.#v(e));const o=s+":"+t;if(o in u.#r){const c=i[t],g=e;c!=g&&this.#m("data_break",{dataId:o,old_v:c,new_v:g})}i[t]=e,this.#S[o]?.(t,e)}static#r={};getVal=(s,t)=>{if(!s)throw"[変数参照] nameは必須です";const e=p.getValName(s);if(!e)throw"[変数参照] name("+s+")が変数名として異常です";const n=this.#t[e.scope];if(!n)throw"[変数参照] scopeが異常【"+e.scope+"】です";const i=e.name;let o=n[i];if(!(i in n)){o=t;let c="";const g=i.split("."),f=g.length;for(let l=0;l<f;++l,c+="."){if(c+=g[l],!(c in n))continue;let h=JSON.parse(n[c]);if(Object.prototype.toString.call(h)!=="[object Object]"){if(l+1===f){o=h;break}continue}let a=l;for(;++a<f;){const d=g[a];if(!(d in h)){o=t;break}if(h=h[d],Object.prototype.toString.call(h)!=="[object Object]"||a+1===f){o=h;break}}o instanceof Object&&(o=JSON.stringify(o));break}}return o instanceof Function&&(o=o()),e.at==="@str"?o:this.#v(o)};#v(s){const t=s;if(t==="true")return!0;if(t==="false")return!1;if(t==="null")return null;if(t!=="undefined")return this.#J.test(t)?parseFloat(t):s}#J=/^-?[\d\.]+$/;#R=()=>{const s={tmp:{},sys:{},save:{},mp:{}};for(let t in s){const e=this.#t[t],n=s[t];for(let[i,o]of Object.entries(e))n[i]=Object.prototype.toString.call(o)==="[object Function]"?o():o}return console.info("🥟 [dump_val]",s),!1};#g=!1;doRecLog(){return this.#g}#l=!1;get tagCh_doWait(){return this.#l}#f=!1;get tagCh_doWait_Kidoku(){return this.#f}#u=0;get tagCh_msecWait(){return this.#u}#k=0;get tagCh_msecWait_Kidoku(){return this.#k}#S={"sys:sn.tagCh.doWait":s=>{this.#l=this.#d(s)},"sys:sn.tagCh.doWait_Kidoku":s=>{this.#f=this.#d(s)},"sys:sn.tagCh.msecWait":s=>{this.#u=this.#B(s)},"sys:sn.tagCh.msecWait_Kidoku":s=>{this.#k=this.#I(s)},"sys:sn.tagCh.canskip":s=>this.#d(s),"sys:sn.auto.msecPageWait":s=>this.#A(s),"sys:sn.auto.msecPageWait_Kidoku":s=>this.#A(s),"sys:sn.auto.msecLineWait":s=>this.#x(s),"sys:sn.auto.msecLineWait_Kidoku":s=>this.#x(s),"save:sn.doRecLog":s=>{this.#w(this.#g=this.#T(s))},"save:sn.userFnTail":(s,t)=>{if(t.includes("@"))throw"この変数では文字「@」は禁止です";this.cfg.userFnTail=t},"tmp:flash.desktop.NativeApplication.nativeApplication.systemIdleMode":()=>{}};defValTrg(s,t){this.#S[s]=t}#d=s=>k(this.#n,s,!0);#B=s=>r(this.#n,s,10);#I=s=>r(this.#n,s,this.cfg.oCfg.init.tagch_msecwait===void 0?10:this.cfg.oCfg.init.tagch_msecwait);#A=s=>r(this.#n,s,this.cfg.oCfg.init.auto_msecpagewait===void 0?3500:this.cfg.oCfg.init.auto_msecpagewait);#x=s=>r(this.#n,s,500);#T(s){return k(this.#i,s,!0)}}export{u as Variable};
